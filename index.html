<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æŸ¥å¸³ç³»çµ± - å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š (å¤šå–®ä½é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
        .card-base { transition: transform 0.2s, box-shadow 0.2s; }
        .card-base:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .preset-tag { cursor: pointer; transition: background-color 0.2s; }
        .preset-tag:hover { background-color: #4f46e5; }
        
        /* åœ–è¡¨æ¨£å¼ */
        .checkout-chart svg { filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); }
        .checkout-chart circle { transition: all 0.2s ease; }
        .checkout-chart circle:hover { filter: brightness(1.2); transform: scale(1.2); }
        .checkout-chart path { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- ç™»å…¥/ä½¿ç”¨è€…å€å¡Š -->
    <div id="user-bar" class="max-w-7xl mx-auto flex justify-end mb-4 hidden">
        <div class="flex items-center gap-3">
            <span id="user-greeting" class="text-gray-300">æ­¡è¿ï¼Œ<strong id="user-name">ä½¿ç”¨è€…</strong></span>
            <button id="admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded hidden">ç®¡ç†</button>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">ç™»å‡º</button>
        </div>
    </div>

    <!-- ç™»å…¥ modal (é è¨­é¡¯ç¤ºï¼Œå¦‚æœæœªç™»å…¥) -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">è«‹å…ˆç™»å…¥</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-1">å¸³è™Ÿ</label>
                    <input id="username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¼¸å…¥å¸³è™Ÿ">
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-1">å¯†ç¢¼</label>
                    <input id="password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¼¸å…¥å¯†ç¢¼">
                </div>
                <div class="flex items-center justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ç™»å…¥</button>
                </div>
                <div id="login-feedback" class="text-sm text-red-400 mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- å±¤ç´š 1: å–®ä½ç¾¤çµ„é¸æ“‡é é¢ -->
    <div id="group-selection-page" class="max-w-4xl mx-auto hidden">
        <h1 class="text-4xl font-bold text-white text-center mb-8">å¨ƒå¨ƒæ©ŸæŸ¥å¸³ç³»çµ±</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">å»ºç«‹æ–°å–®ä½ç¾¤çµ„</h2>
            <form id="create-group-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-group-name" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å–®ä½åç¨± (ä¾‹å¦‚ï¼šAå–®ä½)" required>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">å»ºç«‹ç¾¤çµ„</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">é¸æ“‡æ‚¨çš„å–®ä½ç¾¤çµ„</h2>
            <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">æ­£åœ¨è®€å–ç¾¤çµ„åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…è¨­å®šé é¢ -->
    <div id="admin-page" class="max-w-6xl mx-auto hidden">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-4xl font-bold text-white">ç³»çµ±ç®¡ç†</h1>
            <button id="back-to-main-btn" class="text-blue-400 hover:text-blue-300 transition flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                <span>è¿”å›ä¸»ç³»çµ±</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ç®¡ç†å“¡å¸³å¯†è¨­å®š -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">ç®¡ç†å“¡å¸³å¯†è¨­å®š</h2>
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm text-gray-300 mb-1">ç›®å‰å¯†ç¢¼</label>
                        <input id="current-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-username" class="block text-sm text-gray-300 mb-1">æ–°å¸³è™Ÿ</label>
                        <input id="new-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm text-gray-300 mb-1">æ–°å¯†ç¢¼</label>
                        <input id="new-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm text-gray-300 mb-1">ç¢ºèªå¯†ç¢¼</label>
                        <input id="confirm-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">æ›´æ–°ç®¡ç†å“¡å¸³å¯†</button>
                </form>
                <div id="admin-password-feedback" class="text-sm mt-2 hidden"></div>
            </div>

            <!-- è¨ªå®¢å¸³è™Ÿç®¡ç† -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">è¨ªå®¢å¸³è™Ÿç®¡ç†</h2>
                <form id="guest-account-form" class="space-y-4 mb-6">
                    <div>
                        <label for="guest-username" class="block text-sm text-gray-300 mb-1">è¨ªå®¢å¸³è™Ÿ</label>
                        <input id="guest-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="guest-password" class="block text-sm text-gray-300 mb-1">è¨ªå®¢å¯†ç¢¼</label>
                        <input id="guest-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">å¯è¨ªå•çš„ç¾¤çµ„</label>
                        <div id="group-permissions" class="space-y-2 max-h-32 overflow-y-auto bg-gray-700 p-3 rounded-lg">
                            <p class="text-gray-400 text-sm">è¼‰å…¥ç¾¤çµ„åˆ—è¡¨ä¸­...</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">é é¢è¨ªå•æ¬Šé™</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-gray-700 p-4 rounded-lg">
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">å ±è¡¨åŠŸèƒ½</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="details" class="page-permission-checkbox rounded text-blue-600">
                                    <span>æ©Ÿå°æ˜ç´°</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="summary" class="page-permission-checkbox rounded text-blue-600">
                                    <span>ç‡Ÿé‹ç¸½è¦½</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="analysis" class="page-permission-checkbox rounded text-blue-600">
                                    <span>ç¶“ç‡Ÿåˆ†æ</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="charts" class="page-permission-checkbox rounded text-blue-600">
                                    <span>åœ–è¡¨çµ±è¨ˆ</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="statistics" class="page-permission-checkbox rounded text-blue-600">
                                    <span>æ•¸æ“šçµ±è¨ˆ</span>
                                </label>
                            </div>
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-green-300">æ“ä½œåŠŸèƒ½</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="accounting" class="page-permission-checkbox rounded text-green-600">
                                    <span>æ¯æ—¥è¨˜å¸³</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="machines" class="page-permission-checkbox rounded text-green-600">
                                    <span>æ©Ÿå°ç®¡ç†</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="checkout" class="page-permission-checkbox rounded text-green-600">
                                    <span>çµå¸³ä½œæ¥­</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="download" class="page-permission-checkbox rounded text-purple-600">
                                    <span>ä¸‹è¼‰å ±å‘Š</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="edit" class="page-permission-checkbox rounded text-orange-600">
                                    <span>ç·¨è¼¯/åˆªé™¤</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" id="select-all-permissions" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">å…¨é¸</button>
                            <button type="button" id="select-readonly-permissions" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">åƒ…æª¢è¦–</button>
                            <button type="button" id="clear-all-permissions" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">æ¸…é™¤</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢è¨ªå®¢</button>
                        <button type="button" id="cancel-guest-edit" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">å–æ¶ˆ</button>
                    </div>
                </form>
                <div id="guest-account-feedback" class="text-sm mt-2 hidden"></div>
            </div>
        </div>

        <!-- è¨ªå®¢å¸³è™Ÿåˆ—è¡¨ -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">ç¾æœ‰è¨ªå®¢å¸³è™Ÿ</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-4">å¸³è™Ÿ</th>
                            <th class="p-4">ç‹€æ…‹</th>
                            <th class="p-4">å¯è¨ªå•ç¾¤çµ„</th>
                            <th class="p-4">é é¢æ¬Šé™</th>
                            <th class="p-4">å»ºç«‹æ™‚é–“</th>
                            <th class="p-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="guest-accounts-table" class="divide-y divide-gray-700">
                        <tr><td colspan="6" class="text-center p-8 text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç³»çµ±å·¥å…· -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">ç³»çµ±å·¥å…·</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="export-config-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">åŒ¯å‡ºè¨­å®š</button>
                <button id="import-config-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition">åŒ¯å…¥è¨­å®š</button>
                <button id="reset-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">é‡ç½®ç³»çµ±</button>
            </div>
            <input type="file" id="config-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <!-- å±¤ç´š 2: é–€å¸‚é¸æ“‡é é¢ (é è¨­éš±è—) -->
    <div id="store-selection-page" class="max-w-4xl mx-auto hidden">
         <button id="back-to-groups-btn" class="text-blue-400 hover:text-blue-300 transition mb-4 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <span>è¿”å›ç¾¤çµ„åˆ—è¡¨</span>
        </button>
        <h1 id="store-page-title" class="text-4xl font-bold text-white text-center mb-8">é–€å¸‚ç®¡ç†</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">å»ºç«‹æ–°é–€å¸‚</h2>
            <form id="create-store-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="new-store-name" class="block text-sm font-medium text-gray-300 mb-1">é–€å¸‚åç¨±</label>
                    <input type="text" id="new-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šå°ä¸­é€¢ç”²åº—" required>
                </div>
                 <div>
                    <label for="new-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">ç‡Ÿæ¥­èµ·å§‹æ—¥</label>
                    <input type="date" id="new-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <button type="submit" class="sm:col-span-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shrink-0">å»ºç«‹é–€å¸‚</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
             <h2 class="text-2xl font-bold text-white mb-4">é¸æ“‡è¦ç®¡ç†çš„é–€å¸‚</h2>
            <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-3">ä¸‹è¼‰æ‰€é¸é–€å¸‚å ±è¡¨</h3>
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                    <select id="report-period-selector" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                        <option value="all">ç¸½å’Œ</option>
                        <option value="daily">å–®æ—¥</option>
                        <option value="weekly">é€±å ±</option>
                        <option value="monthly">æœˆå ±</option>
                        <option value="quarterly">å­£å ±</option>
                        <option value="yearly">å¹´å ±</option>
                    </select>
                    <input type="date" id="report-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto hidden" title="é¸æ“‡å ±è¡¨åŸºæº–æ—¥">
                    <button id="download-all-stores-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 w-full sm:w-auto justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                        </svg>
                        <span>ä¸‹è¼‰å ±è¡¨</span>
                    </button>
                </div>
            </div>
             <div class="flex justify-end gap-4 mb-4">
                 <button id="select-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">å…¨é¸</button>
                 <button id="deselect-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">å–æ¶ˆå…¨é¸</button>
             </div>
            <div id="store-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">æ­£åœ¨è®€å–é–€å¸‚åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- å±¤ç´š 3: å ±è¡¨ä¸»é é¢ (é è¨­éš±è—) -->
    <div id="report-page" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button id="back-to-stores-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span>è¿”å›é–€å¸‚åˆ—è¡¨</span>
                    </button>
                    <h1 id="report-title-main" class="text-3xl sm:text-4xl font-bold text-white mb-2">å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š</h1>
                    <p class="text-lg text-gray-400" id="report-period">çµ±è¨ˆæœŸé–“ï¼š</p>
                </div>
                <div id="header-download-buttons" class="flex items-center gap-2">
                    <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>ä¸‹è¼‰å®Œæ•´å ±å‘Š (CSV)</span>
                    </button>
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        <span>åˆ—å°å ±å‘Š (PDF)</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£é‡‘é¡</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 å…ƒ</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½å‡ºè²¨æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">å¹³å‡å‡ºè²¨æˆæœ¬</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 å…ƒ/æ¬¡</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">æ¯æ—¥è¨˜å¸³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="machines">æ©Ÿå°ç®¡ç†</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">åœ–è¡¨åˆ†æ</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">çµ±è¨ˆå½™æ•´</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">æ©Ÿå°ç‡Ÿæ¥­æ˜ç´°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">å„æ©Ÿå°ç‡Ÿé‹æ¦‚æ³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">åˆ†æèˆ‡å»ºè­°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="checkout">çµå¸³ä½œæ¥­</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                     <h3 class="text-xl font-bold text-white mb-4">æ–°å¢æ¯æ—¥ç´€éŒ„</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ä½ç½®</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©æŠ•å¹£æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©å‡ºè²¨æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢ç´€éŒ„</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-4">è¨˜å¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ</th>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">ç•¶æ—¥æŠ•å¹£æ•¸</th>
                                    <th class="p-4 text-right">ç•¶æ—¥å‡ºè²¨æ•¸</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="machines" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">å»ºç«‹æ–°æ©Ÿå°</h3>
                    <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-6">
                        <div>
                            <label for="new-machine-id" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ç·¨è™Ÿ</label>
                            <input type="text" id="new-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šA01" required>
                        </div>
                        <div>
                            <label for="new-machine-location" class="block text-sm font-medium text-gray-300 mb-1">ä½ç½®/å…§å®¹ç‰©</label>
                            <input type="text" id="new-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šé–€å£/å¤§å¨ƒå¨ƒ" required>
                            <div id="location-presets" class="flex flex-wrap gap-2 mt-2">
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸Šå±¤ / å·¦å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸Šå±¤ / å³å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸‹å±¤ / å·¦å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸‹å±¤ / å³å´</span>
                            </div>
                        </div>
                         <div>
                            <label for="new-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹æŠ•å¹£æ•¸ (æ¸¬è©¦ç”¨)</label>
                            <input type="number" id="new-machine-initial-plays" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹å‡ºè²¨æ•¸ (æ¸¬è©¦ç”¨)</label>
                            <input type="number" id="new-machine-initial-payouts" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <button type="submit" class="md:col-span-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹æ©Ÿå°</button>
                    </form>
                    
                    <div class="flex justify-between items-center mb-4 mt-4">
                         <h3 class="text-xl font-bold text-white">ç¾æœ‰æ©Ÿå°åˆ—è¡¨</h3>
                         <button id="recalculate-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.082.541a5.002 5.002 0 00-8.736-1.613L8 8H4V4l2.293 2.293A6.996 6.996 0 0111 3.055a6.996 6.996 0 015.688 3.568l1.082-.54A8.996 8.996 0 0012.22 2.022 8.996 8.996 0 004 5.101V3a1 1 0 01-1-1H2a1 1 0 01-1-1V1a1 1 0 011-1h2zm12 16a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.899-2.186l1.082-.541a5.002 5.002 0 008.736 1.613L12 12h4v4l-2.293-2.293A6.996 6.996 0 019 16.945a6.996 6.996 0 01-5.688-3.568l-1.082.54A8.996 8.996 0 007.78 17.978 8.996 8.996 0 0016 14.899V17a1 1 0 011 1h1a1 1 0 011 1v1a1 1 0 01-1 1h-2z" clip-rule="evenodd" />
                            </svg>
                            <span>é‡æ–°è¨ˆç®—æ‰€æœ‰æ•¸æ“š</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">èµ·å§‹æŠ•å¹£</th>
                                    <th class="p-4 text-right">èµ·å§‹å‡ºè²¨</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="machine-list-table-body" class="divide-y divide-gray-700">
                                <!-- æ©Ÿå°åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">å–®æ—¥å„æ©Ÿå°è¡¨ç¾</h3>
                        <div class="flex items-center gap-4 mb-4">
                            <label for="trend-chart-date-picker" class="text-gray-300 shrink-0">é¸æ“‡æ—¥æœŸï¼š</label>
                            <input type="date" id="trend-chart-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 w-full sm:w-auto">
                        </div>
                        <div id="trend-chart-content" class="w-full"></div>
                    </div>
                </div>
                <div id="statistics" class="tab-content hidden">
                     <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">æ¯æ—¥</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æ¯é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æ¯æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æ¯å­£</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">æœŸé–“</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                    <th class="p-4 text-right">ç¸½å‡ºè²¨æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾æ©Ÿå°ç·¨è™Ÿæœå°‹...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable sorted" data-sort="id">æ©Ÿå°ç·¨è™Ÿ <span class="sort-indicator">â–²</span></th>
                                    <th class="p-4 table-header-sortable" data-sort="location">ä½ç½® <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePlays">ç‡Ÿæ¥­æŠ•å¹£æ¬¡æ•¸ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">ç‡Ÿæ¥­æŠ•å¹£é‡‘é¡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePayouts">ç‡Ÿæ¥­å‡ºè²¨æ•¸é‡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">å¹³å‡å‡ºè²¨æˆæœ¬ <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="summary-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">ç¸½è¨ˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æœ¬é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æœ¬æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æœ¬å­£</button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                        <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                        <th class="p-4 text-right">ç¸½å‡ºè²¨æ•¸é‡</th>
                                        <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°æŠ•å¹£é‡‘é¡ä½”æ¯”</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>ğŸ“ˆ PSDï¼ˆæ¯æ—¥å¹³å‡éŠ·å”®è¡¨ç¾ï¼‰</h3>
                     <div class="flex flex-wrap justify-center items-center mb-4 bg-gray-900/50 p-2 rounded-lg gap-2">
                        <div id="psd-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">ç¸½è¨ˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æœ¬é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æœ¬æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æœ¬å­£</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="custom">è‡ªè¨‚å€é–“</button>
                        </div>
                         <div id="psd-custom-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="psd-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <span class="text-gray-400">è‡³</span>
                            <input type="date" id="psd-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <button id="psd-calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">è¨ˆç®—</button>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>è¨ˆç®—ä¸­...</strong></p>
                    </div>
                    <h3 class="mt-8">ğŸ”¬ åˆ†æèˆ‡è§€å¯Ÿ</h3>
                    <div id="analysis-observation" class="space-y-6"></div>
                    <h3 class="mt-8">ğŸ’¡ çµè«–å»ºè­°</h3>
                    <div id="analysis-suggestion" class="space-y-4"></div>
                </div>
                 <div id="checkout" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">æœ¬æœŸç‡Ÿæ”¶çµå¸³</h3>
                    <div class="bg-gray-900/50 p-6 rounded-lg mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-400">ä¸Šæ¬¡çµå¸³æ—¥æœŸï¼š<span id="last-checkout-date" class="font-semibold">ç„¡</span></p>
                            <p class="text-lg text-white mt-1">æœ¬æœŸå¾…çµå¸³é‡‘é¡ï¼š<span id="pending-checkout-amount" class="text-2xl font-bold text-green-400">0 å…ƒ</span></p>
                        </div>
                        <div class="flex gap-2">
                           <button id="download-checkout-csv-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">ä¸‹è¼‰çµå¸³å ±è¡¨ (CSV)</button>
                           <button id="perform-checkout-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">åŸ·è¡Œçµå¸³</button>
                        </div>
                    </div>
                    
                    <!-- çµå¸³è¶¨å‹¢åœ–è¡¨ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                çµå¸³é‡‘é¡è¶¨å‹¢
                            </h4>
                            <div id="checkout-amount-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                            </div>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                ç´¯ç©ç‡Ÿæ”¶è¶¨å‹¢
                            </h4>
                            <div id="checkout-cumulative-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çµå¸³çµ±è¨ˆæ‘˜è¦ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-blue-400 text-sm">ç¸½çµå¸³æ¬¡æ•¸</p>
                            <p id="total-checkouts" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-green-400 text-sm">å¹³å‡çµå¸³é‡‘é¡</p>
                            <p id="avg-checkout-amount" class="text-2xl font-bold text-white">0 å…ƒ</p>
                        </div>
                        <div class="bg-purple-900/30 p-4 rounded-lg text-center">
                            <p class="text-purple-400 text-sm">æœ€é«˜å–®æ¬¡çµå¸³</p>
                            <p id="max-checkout-amount" class="text-2xl font-bold text-white">0 å…ƒ</p>
                        </div>
                        <div class="bg-orange-900/30 p-4 rounded-lg text-center">
                            <p class="text-orange-400 text-sm">çµå¸³é »ç‡</p>
                            <p id="checkout-frequency" class="text-2xl font-bold text-white">0 å¤©/æ¬¡</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-4 mt-8">çµå¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">çµå¸³æ—¥æœŸ</th>
                                    <th class="p-4 text-right">ç•¶æœŸç‡Ÿæ”¶</th>
                                    <th class="p-4 text-right">çµå¸³æ™‚ç´¯ç©ç¸½ç‡Ÿæ”¶</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="checkout-history-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">å ±è¡¨å»ºç«‹æ—¥æœŸï¼š</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="modal-message" class="text-gray-300 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Edit Store Modal -->
    <div id="edit-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">ç·¨è¼¯é–€å¸‚è³‡è¨Š</h3>
            <form id="edit-store-form">
                <input type="hidden" id="edit-store-id">
                 <div class="mb-4">
                    <label for="edit-store-name" class="block text-sm font-medium text-gray-300 mb-1">é–€å¸‚åç¨±</label>
                    <input type="text" id="edit-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6">
                    <label for="edit-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">ç‡Ÿæ¥­èµ·å§‹æ—¥</label>
                    <input type="date" id="edit-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="edit-history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">ä¿®æ”¹è¨˜å¸³ç´€éŒ„</h3>
            <form id="edit-history-form">
                <input type="hidden" id="edit-history-doc-id">
                <input type="hidden" id="edit-history-machine-id">
                <input type="hidden" id="edit-history-location">
                <input type="hidden" id="edit-history-old-plays">
                <input type="hidden" id="edit-history-old-payouts">
                <div class="mb-4">
                    <label for="edit-history-plays" class="block text-sm font-medium text-gray-300 mb-1">ç•¶æ—¥æŠ•å¹£æ•¸</label>
                    <input type="number" id="edit-history-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="mb-6">
                    <label for="edit-history-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç•¶æ—¥å‡ºè²¨æ•¸</label>
                    <input type="number" id="edit-history-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-history-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Machine Modal -->
    <div id="edit-machine-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">ä¿®æ”¹æ©Ÿå°è³‡è¨Š</h3>
            <form id="edit-machine-form">
                <input type="hidden" id="edit-machine-doc-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="edit-machine-id" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ç·¨è™Ÿ</label>
                        <input type="text" id="edit-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-machine-location" class="block text-sm font-medium text-gray-300 mb-1">ä½ç½®/å…§å®¹ç‰©</label>
                        <input type="text" id="edit-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                    </div>
                     <div class="mb-4">
                        <label for="edit-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹æŠ•å¹£æ•¸</label>
                        <input type="number" id="edit-machine-initial-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                    </div>
                     <div class="mb-4">
                        <label for="edit-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹å‡ºè²¨æ•¸</label>
                        <input type="number" id="edit-machine-initial-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="edit-machine-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PDF Loader Overlay -->
    <div id="pdf-loader-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center hidden z-50">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="pdf-loader-text-overlay" class="text-white text-lg mt-4">æ­£åœ¨ç”Ÿæˆ PDF...</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! è«‹å°‡é€™è£¡çš„è¨­å®šæ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé‡‘é‘° !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // åˆå§‹åŒ–ç®¡ç†å“¡é…ç½®ç³»çµ±
        if (window.initAdminConfig) {
            window.initAdminConfig(db);
        }
        // --- END: Firebase Initialization ---

        // --- GLOBAL STATE ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '' };
        let currentSort = { key: 'id', direction: 'asc' };
        let selectedGroupId = null;
        let selectedGroupName = '';
        let selectedStoreId = null; 
        let selectedStoreName = ''; 
        let confirmCallback = null;
        

        // --- PAGE & ELEMENT SELECTORS ---
        const groupSelectionPage = document.getElementById('group-selection-page');
        const storeSelectionPage = document.getElementById('store-selection-page');
        const reportPage = document.getElementById('report-page');
        const adminPage = document.getElementById('admin-page');
        
        const groupListContainer = document.getElementById('group-list');
        const createGroupForm = document.getElementById('create-group-form');
        const backToGroupsBtn = document.getElementById('back-to-groups-btn');
        const adminBtn = document.getElementById('admin-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');

        const storeListContainer = document.getElementById('store-list');
        const createStoreForm = document.getElementById('create-store-form');
        const backToStoresBtn = document.getElementById('back-to-stores-btn');
        const reportPeriodSelector = document.getElementById('report-period-selector');
        const reportDatePicker = document.getElementById('report-date-picker');
        const downloadAllStoresBtn = document.getElementById('download-all-stores-report-btn');
        const allTabs = document.querySelectorAll('.tab-btn');
        const allTabContents = document.querySelectorAll('.tab-content');
        const searchInput = document.getElementById('searchInput');
        const sortableHeaders = document.querySelectorAll('.table-header-sortable');
        const statsControls = document.getElementById('stats-controls');
        const summaryControls = document.getElementById('summary-controls');
        const psdControls = document.getElementById('psd-controls');
        const psdCustomRange = document.getElementById('psd-custom-range');
        const psdStartDate = document.getElementById('psd-start-date');
        const psdEndDate = document.getElementById('psd-end-date');
        const psdCalculateBtn = document.getElementById('psd-calculate-btn');
        const addMachineForm = document.getElementById('add-machine-form');
        const machineListTableBody = document.getElementById('machine-list-table-body');
        const historyTableBody = document.getElementById('history-table-body');
        const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
        const locationPresets = document.getElementById('location-presets');
        const selectAllStoresBtn = document.getElementById('select-all-stores-btn');
        const deselectAllStoresBtn = document.getElementById('deselect-all-stores-btn');
        const recalculateAllBtn = document.getElementById('recalculate-all-btn');

        // ç®¡ç†è€…ç•Œé¢å…ƒç´ 
        const adminPasswordForm = document.getElementById('admin-password-form');
        const guestAccountForm = document.getElementById('guest-account-form');
        const guestAccountsTable = document.getElementById('guest-accounts-table');
        const groupPermissions = document.getElementById('group-permissions');
        const cancelGuestEditBtn = document.getElementById('cancel-guest-edit');
        const exportConfigBtn = document.getElementById('export-config-btn');
        const importConfigBtn = document.getElementById('import-config-btn');
        const resetConfigBtn = document.getElementById('reset-config-btn');
        const configFileInput = document.getElementById('config-file-input');

        
        // Modal selectors
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const editStoreModal = document.getElementById('edit-store-modal');
        const editStoreForm = document.getElementById('edit-store-form');
        const editStoreCancelBtn = document.getElementById('edit-store-cancel-btn');
        
        const editHistoryModal = document.getElementById('edit-history-modal');
        const editHistoryForm = document.getElementById('edit-history-form');
        const editHistoryCancelBtn = document.getElementById('edit-history-cancel-btn');
        
        const editMachineModal = document.getElementById('edit-machine-modal');
        const editMachineForm = document.getElementById('edit-machine-form');
        const editMachineCancelBtn = document.getElementById('edit-machine-cancel-btn');

        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
        const pdfLoaderText = document.getElementById('pdf-loader-text-overlay');
        
        const checkoutHistoryBody = document.getElementById('checkout-history-body');
        const performCheckoutBtn = document.getElementById('perform-checkout-btn');
        const downloadCheckoutCsvBtn = document.getElementById('download-checkout-csv-btn');
        const headerDownloadButtons = document.getElementById('header-download-buttons');


        // --- MODAL FUNCTIONS ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- NAVIGATION & PAGE CONTROL ---
        
        function showGroupSelectionPage() {
            selectedGroupId = null;
            selectedGroupName = '';
            selectedStoreId = null;
            selectedStoreName = '';
            
            groupSelectionPage.classList.remove('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            
            loadGroups();
        }
        
        // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸç¯„åœä¾›ç™»å…¥ç³»çµ±ä½¿ç”¨
        window.showGroupSelectionPage = showGroupSelectionPage;

        // --- ç®¡ç†è€…ç•Œé¢å‡½æ•¸ ---
        function showAdminPage() {
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            
            loadAdminInterface();
        }

        function hideAdminPage() {
            adminPage.classList.add('hidden');
            showGroupSelectionPage();
        }

        function loadAdminInterface() {
            // è¼‰å…¥ç•¶å‰ç®¡ç†å“¡è³‡è¨Š
            const currentAdmin = window.adminConfig.config.adminCredentials;
            document.getElementById('new-username').value = currentAdmin.username;
            
            // è¼‰å…¥ç¾¤çµ„æ¬Šé™é¸é …
            loadGroupPermissions();
            
            // è¼‰å…¥è¨ªå®¢å¸³è™Ÿåˆ—è¡¨
            loadGuestAccountsTable();
            
            // é‡ç½®è¡¨å–®
            adminPasswordForm.reset();
            guestAccountForm.reset();
            document.getElementById('new-username').value = currentAdmin.username;
        }

        async function loadGroupPermissions() {
            try {
                const groupsSnapshot = await db.collection('groups').get();
                const groups = groupsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                groupPermissions.innerHTML = '';
                if (groups.length === 0) {
                    groupPermissions.innerHTML = '<p class="text-gray-400 text-sm">ç›®å‰æ²’æœ‰å¯ç”¨çš„ç¾¤çµ„</p>';
                } else {
                    groups.forEach(group => {
                        const checkbox = document.createElement('label');
                        checkbox.className = 'flex items-center space-x-2 text-white cursor-pointer';
                        checkbox.innerHTML = `
                            <input type="checkbox" value="${group.id}" class="group-permission-checkbox rounded">
                            <span>${group.name}</span>
                        `;
                        groupPermissions.appendChild(checkbox);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ç¾¤çµ„æ¬Šé™å¤±æ•—:', error);
                groupPermissions.innerHTML = '<p class="text-red-400 text-sm">è¼‰å…¥ç¾¤çµ„å¤±æ•—</p>';
            }
        }

        function loadGuestAccountsTable() {
            const guests = window.adminConfig.getGuestAccounts();
            guestAccountsTable.innerHTML = '';
            
            if (guests.length === 0) {
                guestAccountsTable.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-400">å°šç„¡è¨ªå®¢å¸³è™Ÿ</td></tr>';
            } else {
                guests.forEach(guest => {
                    const allowedGroupsText = guest.allowedGroups.length > 0 ? 
                        `${guest.allowedGroups.length} å€‹ç¾¤çµ„` : 'ç„¡æ¬Šé™';
                    
                    // é é¢æ¬Šé™é¡¯ç¤º
                    const pagePermissions = guest.pagePermissions || [];
                    const pagePermissionNames = {
                        'details': 'æ©Ÿå°æ˜ç´°', 'summary': 'ç‡Ÿé‹ç¸½è¦½', 'analysis': 'ç¶“ç‡Ÿåˆ†æ',
                        'charts': 'åœ–è¡¨çµ±è¨ˆ', 'statistics': 'æ•¸æ“šçµ±è¨ˆ', 'accounting': 'æ¯æ—¥è¨˜å¸³',
                        'machines': 'æ©Ÿå°ç®¡ç†', 'checkout': 'çµå¸³ä½œæ¥­', 'download': 'ä¸‹è¼‰å ±å‘Š', 'edit': 'ç·¨è¼¯åˆªé™¤'
                    };
                    const pagePermissionsText = pagePermissions.length > 0 ? 
                        pagePermissions.map(p => pagePermissionNames[p] || p).slice(0, 3).join(', ') + 
                        (pagePermissions.length > 3 ? `ç­‰${pagePermissions.length}é …` : '') : 'ç„¡æ¬Šé™';
                    
                    const statusText = guest.enabled ? 'å•Ÿç”¨' : 'åœç”¨';
                    const statusClass = guest.enabled ? 'text-green-400' : 'text-red-400';
                    const createdDate = new Date(guest.createdAt).toLocaleDateString();
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700/50 transition';
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${guest.username}</td>
                        <td class="p-4 ${statusClass}">${statusText}</td>
                        <td class="p-4 text-gray-300">${allowedGroupsText}</td>
                        <td class="p-4 text-gray-300 text-sm" title="${pagePermissions.map(p => pagePermissionNames[p] || p).join(', ')}">${pagePermissionsText}</td>
                        <td class="p-4 text-gray-300">${createdDate}</td>
                        <td class="p-4 text-center">
                            <button class="edit-guest-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-guest-id="${guest.id}">ç·¨è¼¯</button>
                            <button class="delete-guest-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" data-guest-id="${guest.id}">åˆªé™¤</button>
                        </td>
                    `;
                    guestAccountsTable.appendChild(row);
                });
            }
        }

        function showAdminFeedback(elementId, message, isError = false) {
            const feedbackEl = document.getElementById(elementId);
            feedbackEl.textContent = message;
            feedbackEl.className = `text-sm mt-2 ${isError ? 'text-red-400' : 'text-green-400'}`;
            feedbackEl.classList.remove('hidden');
            setTimeout(() => {
                feedbackEl.classList.add('hidden');
            }, 5000);
        }

        function showStoreSelectionPage(groupId, groupName) {
            selectedGroupId = groupId;
            selectedGroupName = groupName;
            
            document.getElementById('store-page-title').textContent = `${groupName} - é–€å¸‚ç®¡ç†`;
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
            reportPage.classList.add('hidden');
            document.getElementById('new-store-start-date').valueAsDate = new Date();

            // æ ¹æ“šç”¨æˆ¶é¡å‹éš±è—/é¡¯ç¤ºæ–°å¢é–€å¸‚è¡¨å–®
            const userType = localStorage.getItem('userType');
            const createStoreForm = document.getElementById('create-store-form').parentElement;
            if (createStoreForm) {
                if (userType === 'admin') {
                    createStoreForm.style.display = 'block';
                } else {
                    createStoreForm.style.display = 'none';
                }
            }

            loadStores();
        }

        function showReportPage(storeId, storeName, startDate) {
            selectedStoreId = storeId;
            selectedStoreName = storeName;
            appData.startDate = startDate;
            
            document.getElementById('report-title-main').textContent = `${selectedStoreName} - ç‡Ÿæ¥­å ±å‘Š`;
            document.getElementById('report-period').textContent = `çµ±è¨ˆæœŸé–“ï¼š${startDate} ï½ ç¾åœ¨`;
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            // æª¢æŸ¥ç”¨æˆ¶é é¢æ¬Šé™ä¸¦éš±è—/é¡¯ç¤ºç›¸æ‡‰çš„æ¨™ç±¤é 
            applyPagePermissions();
            
            appData.machines = [];
            appData.history = [];
            
            // é¸æ“‡ç¬¬ä¸€å€‹å¯è¦‹çš„æ¨™ç±¤é 
            const firstVisibleTab = document.querySelector('.tab-btn:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.click();
            } else {
                document.querySelector('.tab-btn[data-tab="details"]').click(); // é»˜èªå›é€€
            }
            
            updateUI(); 
            loadStoreData();
        }

        // æ‡‰ç”¨é é¢æ¬Šé™
        function applyPagePermissions() {
            const userType = localStorage.getItem('userType');
            console.log('æ‡‰ç”¨é é¢æ¬Šé™ï¼Œç”¨æˆ¶é¡å‹:', userType);
            
            if (userType === 'admin') {
                // ç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™
                console.log('ç®¡ç†å“¡ç”¨æˆ¶ï¼Œé¡¯ç¤ºæ‰€æœ‰åŠŸèƒ½');
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.style.display = 'block';
                });
                document.getElementById('header-download-buttons').style.display = 'flex';
                return;
            }
            
            // è¨ªå®¢ç”¨æˆ¶ï¼Œæª¢æŸ¥é é¢æ¬Šé™
            const currentUser = localStorage.getItem('currentUser');
            const userPagePermissions = JSON.parse(localStorage.getItem('userPagePermissions') || '[]');
            console.log('è¨ªå®¢ç”¨æˆ¶é é¢æ¬Šé™:', userPagePermissions);
            
            // æ¨™ç±¤é æ¬Šé™æ˜ å°„
            const tabPermissionMap = {
                'details': 'details',
                'summary': 'summary', 
                'analysis': 'analysis',
                'charts': 'charts',
                'statistics': 'statistics',
                'accounting': 'accounting',
                'machines': 'machines',
                'checkout': 'checkout'
            };
            
            // éš±è—/é¡¯ç¤ºæ¨™ç±¤é 
            document.querySelectorAll('.tab-btn').forEach(tab => {
                const tabName = tab.dataset.tab;
                const requiredPermission = tabPermissionMap[tabName];
                
                if (requiredPermission && userPagePermissions.includes(requiredPermission)) {
                    tab.style.display = 'block';
                    console.log(`é¡¯ç¤ºæ¨™ç±¤é : ${tabName}`);
                } else {
                    tab.style.display = 'none';
                    console.log(`éš±è—æ¨™ç±¤é : ${tabName}`);
                }
            });
            
            // ä¸‹è¼‰æŒ‰éˆ•æ¬Šé™
            if (userPagePermissions.includes('download')) {
                document.getElementById('header-download-buttons').style.display = 'flex';
                console.log('é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•');
            } else {
                document.getElementById('header-download-buttons').style.display = 'none';
                console.log('éš±è—ä¸‹è¼‰æŒ‰éˆ•');
            }
            
            // ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•æ¬Šé™
            const hasEditPermission = userPagePermissions.includes('edit');
            console.log('ç·¨è¼¯æ¬Šé™:', hasEditPermission);
            
            if (!hasEditPermission) {
                // éš±è—æ‰€æœ‰ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
                setTimeout(() => {
                    const style = document.createElement('style');
                    style.id = 'guest-permissions-style';
                    style.textContent = `
                        .edit-machine-btn, .delete-machine-btn, 
                        .edit-history-btn, .delete-history-btn,
                        .edit-store-btn, .delete-store-btn,
                        .rename-group-btn, .delete-group-btn {
                            display: none !important;
                        }
                    `;
                    // ç§»é™¤ä¹‹å‰çš„æ¨£å¼å†æ·»åŠ æ–°çš„
                    const existingStyle = document.getElementById('guest-permissions-style');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    document.head.appendChild(style);
                    console.log('å·²éš±è—ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•');
                }, 100);
            }
        }

        // --- DATA PROCESSING & CALCULATION ---
        
        function processMachineData(machine) {
            const effectivePlays = machine.plays - (machine.initialPlays || 0);
            const effectivePayouts = machine.payouts - (machine.initialPayouts || 0);
            const revenue = effectivePlays * COIN_VALUE;
            const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
            return { ...machine, effectivePlays, effectivePayouts, revenue, cost };
        }


        // --- DATA FUNCTIONS (Multi-group Version) ---
        
        async function loadGroups() {
            try {
                const groupSnapshot = await db.collection('groups').orderBy('createdAt', 'desc').get();
                let groups = groupSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // å¦‚æœæ˜¯è¨ªå®¢ç”¨æˆ¶ï¼Œéæ¿¾åªé¡¯ç¤ºæœ‰æ¬Šé™çš„ç¾¤çµ„
                const userType = localStorage.getItem('userType');
                if (userType === 'guest') {
                    const allowedGroups = JSON.parse(localStorage.getItem('allowedGroups') || '[]');
                    groups = groups.filter(group => allowedGroups.includes(group.id));
                }
                
                renderGroups(groups);
            } catch (error) {
                console.error("è®€å–å–®ä½ç¾¤çµ„å¤±æ•—:", error);
                groupListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">ç„¡æ³•è®€å–ç¾¤çµ„åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚</p>';
            }
        }
        
        async function handleCreateGroup(e) {
            e.preventDefault();
            const newGroupNameInput = document.getElementById('new-group-name');
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) return alert('ç¾¤çµ„åç¨±ä¸å¯ç©ºç™½ï¼');
            
            try {
                await db.collection('groups').add({
                    name: groupName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newGroupNameInput.value = '';
                loadGroups();
            } catch (error) {
                console.error("å»ºç«‹ç¾¤çµ„å¤±æ•—:", error);
                alert('å»ºç«‹ç¾¤çµ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleRenameGroup(groupId, currentName) {
            const newName = prompt('è«‹è¼¸å…¥æ–°çš„å–®ä½ç¾¤çµ„åç¨±ï¼š', currentName);
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                try {
                    await db.collection('groups').doc(groupId).update({ name: newName.trim() });
                    loadGroups();
                } catch(error) {
                    console.error('æ›´æ–°ç¾¤çµ„åç¨±å¤±æ•—:', error);
                    alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }
        }

        async function handleDeleteGroup(groupId, groupName) {
            const message = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${groupName}ã€å–®ä½ç¾¤çµ„å—ï¼Ÿ\n\nè­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒæ°¸ä¹…åˆªé™¤è©²ç¾¤çµ„åº•ä¸‹çš„ã€æ‰€æœ‰é–€å¸‚ã€‘åŠå…¶æ‰€æœ‰æ©Ÿå°èˆ‡è¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
            showConfirmationModal(message, async () => {
                console.log(`é–‹å§‹åˆªé™¤å–®ä½ç¾¤çµ„: ${groupId}`);
                try {
                    const groupRef = db.collection('groups').doc(groupId);
                    
                    const storesSnapshot = await groupRef.collection('stores').get();
                    for (const storeDoc of storesSnapshot.docs) {
                        const storeRef = storeDoc.ref;
                        
                        const machinesSnapshot = await storeRef.collection('machines').get();
                        if (!machinesSnapshot.empty) {
                            const machineBatch = db.batch();
                            machinesSnapshot.docs.forEach(doc => machineBatch.delete(doc.ref));
                            await machineBatch.commit();
                        }

                        const historySnapshot = await storeRef.collection('history').get();
                         if (!historySnapshot.empty) {
                            const historyBatch = db.batch();
                            historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                            await historyBatch.commit();
                        }

                        await storeRef.delete();
                    }

                    await groupRef.delete();

                    console.log(`å–®ä½ç¾¤çµ„ ${groupId} å·²æˆåŠŸåˆªé™¤ã€‚`);
                    hideConfirmationModal();
                    loadGroups();

                } catch(error) {
                    console.error('åˆªé™¤å–®ä½ç¾¤çµ„å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }


        async function loadStores() {
            if(!selectedGroupId) return;
            try {
                const storeSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').orderBy('createdAt', 'desc').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStores(stores);
            } catch (error) {
                console.error("è®€å–é–€å¸‚åˆ—è¡¨å¤±æ•—:", error);
                storeListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">ç„¡æ³•è®€å–é–€å¸‚åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚</p>';
            }
        }
        
        async function loadStoreData() {
            if (!selectedGroupId || !selectedStoreId) return;
            console.log(`æ­£åœ¨è®€å–ç¾¤çµ„[${selectedGroupId}] -> é–€å¸‚ [${selectedStoreId}] çš„è³‡æ–™...`);
            const machinesCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines');
            const historyCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').orderBy('date', 'desc');
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                const history = historySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                appData.machines = machines;
                appData.history = history;
                
                console.log("è³‡æ–™è®€å–æˆåŠŸ!", appData);
                updateUI();

            } catch (error) {
                console.error(`è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                showFeedback("ç„¡æ³•å¾é›²ç«¯è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
            }
        }

        async function handleCreateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('æœªé¸æ“‡å–®ä½ç¾¤çµ„');

            const newStoreNameInput = document.getElementById('new-store-name');
            const newStoreStartDateInput = document.getElementById('new-store-start-date');
            const storeName = newStoreNameInput.value.trim();
            const startDate = newStoreStartDateInput.value;

            if (!storeName || !startDate) return alert('é–€å¸‚åç¨±èˆ‡èµ·å§‹æ—¥ä¸å¯ç©ºç™½ï¼');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: storeName,
                    startDate: startDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                createStoreForm.reset();
                newStoreStartDateInput.valueAsDate = new Date();
                loadStores(); 
            } catch (error) {
                console.error("å»ºç«‹é–€å¸‚å¤±æ•—:", error);
                alert('å»ºç«‹é–€å¸‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }
        
        async function handleUpdateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return;

            const storeId = document.getElementById('edit-store-id').value;
            const newName = document.getElementById('edit-store-name').value.trim();
            const newStartDate = document.getElementById('edit-store-start-date').value;

            if (!newName || !newStartDate) return alert('é–€å¸‚åç¨±èˆ‡èµ·å§‹æ—¥ä¸å¯ç©ºç™½ï¼');

            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).update({
                    name: newName,
                    startDate: newStartDate
                });
                editStoreModal.classList.add('hidden');
                loadStores();
            } catch(error) {
                console.error('æ›´æ–°é–€å¸‚è³‡è¨Šå¤±æ•—:', error);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        
        async function handleDeleteStore(storeId, storeName) {
            if(!selectedGroupId) return;
            const message = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${storeName}ã€å—ï¼Ÿ\n\nè­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒæ°¸ä¹…åˆªé™¤è©²é–€å¸‚åŠå…¶åº•ä¸‹çš„æ‰€æœ‰æ©Ÿå°èˆ‡è¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
            showConfirmationModal(message, async () => {
                try {
                    const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                    
                    const machinesSnapshot = await storeRef.collection('machines').get();
                    if(!machinesSnapshot.empty){
                        const batch1 = db.batch();
                        machinesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                        await batch1.commit();
                    }

                    const historySnapshot = await storeRef.collection('history').get();
                     if(!historySnapshot.empty){
                        const batch2 = db.batch();
                        historySnapshot.docs.forEach(doc => batch2.delete(doc.ref));
                        await batch2.commit();
                    }

                    await storeRef.delete();
                    hideConfirmationModal();
                    loadStores();

                } catch(error) {
                    console.error('åˆªé™¤é–€å¸‚å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        async function handleAddMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return alert('æ²’æœ‰é¸æ“‡æœ‰æ•ˆçš„é–€å¸‚ã€‚');

            const idInput = document.getElementById('new-machine-id');
            const locationInput = document.getElementById('new-machine-location');
            const initialPlaysInput = document.getElementById('new-machine-initial-plays');
            const initialPayoutsInput = document.getElementById('new-machine-initial-payouts');

            const machineId = idInput.value.trim();
            const machineLocation = locationInput.value.trim();
            const initialPlays = parseInt(initialPlaysInput.value, 10) || 0;
            const initialPayouts = parseInt(initialPayoutsInput.value, 10) || 0;


            if (!machineId || !machineLocation) return alert('æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®ä¸èƒ½ç‚ºç©ºï¼');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').add({
                    id: machineId,
                    location: machineLocation,
                    plays: initialPlays, // ç¸½è¡¨æ•¸å¾èµ·å§‹å€¼é–‹å§‹
                    payouts: initialPayouts, // ç¸½è¡¨æ•¸å¾èµ·å§‹å€¼é–‹å§‹
                    initialPlays: initialPlays,
                    initialPayouts: initialPayouts,
                });
                addMachineForm.reset();
                loadStoreData(); 
            } catch(error) {
                console.error("æ–°å¢æ©Ÿå°å¤±æ•—ï¼š", error);
                alert('æ–°å¢æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleDeleteMachine(docId) {
            if(!selectedStoreId || !selectedGroupId || !docId) return;
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å°æ©Ÿå™¨å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', async () => {
                try {
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).delete();
                    hideConfirmationModal();
                    loadStoreData();
                } catch (error) {
                    console.error("åˆªé™¤æ©Ÿå°å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }
        
        async function handleUpdateMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-machine-doc-id').value;
            const newId = document.getElementById('edit-machine-id').value.trim();
            const newLocation = document.getElementById('edit-machine-location').value.trim();
            const newInitialPlays = parseInt(document.getElementById('edit-machine-initial-plays').value, 10) || 0;
            const newInitialPayouts = parseInt(document.getElementById('edit-machine-initial-payouts').value, 10) || 0;

            if (!newId || !newLocation) return alert('æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®ä¸èƒ½ç‚ºç©ºï¼');

            // Find the original machine data to calculate the difference
            const originalMachine = appData.machines.find(m => m.docId === docId);
            if (!originalMachine) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹æ©Ÿå°è³‡æ–™ï¼');
                return;
            }

            const oldInitialPlays = originalMachine.initialPlays || 0;
            const oldInitialPayouts = originalMachine.initialPayouts || 0;

            // Calculate the difference introduced by changing the initial values
            const playsDiff = newInitialPlays - oldInitialPlays;
            const payoutsDiff = newInitialPayouts - oldInitialPayouts;

            // Adjust the current total plays and payouts
            const newTotalPlays = originalMachine.plays + playsDiff;
            const newTotalPayouts = originalMachine.payouts + payoutsDiff;
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).update({
                    id: newId,
                    location: newLocation,
                    initialPlays: newInitialPlays,
                    initialPayouts: newInitialPayouts,
                    plays: newTotalPlays,
                    payouts: newTotalPayouts
                });
                editMachineModal.classList.add('hidden');
                loadStoreData();
            } catch (error) {
                console.error("æ›´æ–°æ©Ÿå°è³‡è¨Šå¤±æ•—ï¼š", error);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }


        async function handleUpdateHistory(e) {
            e.preventDefault();
            if(!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-history-doc-id').value;
            const machineId = document.getElementById('edit-history-machine-id').value;
            const location = document.getElementById('edit-history-location').value;
            const oldPlays = parseInt(document.getElementById('edit-history-old-plays').value, 10);
            const oldPayouts = parseInt(document.getElementById('edit-history-old-payouts').value, 10);
            const newPlays = parseInt(document.getElementById('edit-history-plays').value, 10);
            const newPayouts = parseInt(document.getElementById('edit-history-payouts').value, 10);
            
            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°ä¾†æ›´æ–°æ•¸æ“šã€‚');
                return;
            }

            const playsDiff = newPlays - oldPlays;
            const payoutsDiff = newPayouts - oldPayouts;

            const newTotalPlays = machineToUpdate.plays + playsDiff;
            const newTotalPayouts = machineToUpdate.payouts + payoutsDiff;
            
            try {
                // Batch update
                const batch = db.batch();
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                batch.update(machineRef, {
                    plays: newTotalPlays,
                    payouts: newTotalPayouts
                });

                const historyRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(docId);
                batch.update(historyRef, {
                    newPlays: newPlays,
                    newPayouts: newPayouts
                });

                await batch.commit();

                editHistoryModal.classList.add('hidden');
                showFeedback("è¨˜å¸³ç´€éŒ„å·²æ›´æ–°ï¼", false);
                loadStoreData();
            } catch(error) {
                console.error("æ›´æ–°è¨˜å¸³ç´€éŒ„å¤±æ•—ï¼š", error);
                alert('æ›´æ–°ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }


        async function handleDeleteHistory(historyDocId, machineId, location, dailyPlays, dailyPayouts) {
            if(!selectedStoreId || !selectedGroupId || !historyDocId || !machineId) return;

            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°ä¾†å›æ»¾æ•¸æ“šã€‚');
                return;
            }
            
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³ç´€éŒ„å—ï¼Ÿç³»çµ±å°‡è‡ªå‹•å›æ»¾æ©Ÿå°æ•¸æ“šã€‚', async () => {
                const revertedPlays = machineToUpdate.plays - dailyPlays;
                const revertedPayouts = machineToUpdate.payouts - dailyPayouts;

                if(revertedPlays < (machineToUpdate.initialPlays || 0) || revertedPayouts < (machineToUpdate.initialPayouts || 0) ) {
                    alert('éŒ¯èª¤ï¼šåˆªé™¤æ­¤ç´€éŒ„æœƒå°è‡´æ©Ÿå°ç´¯ç©æ•¸è®Šç‚ºè² æ•¸æˆ–å°æ–¼èµ·å§‹å€¼ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
                    hideConfirmationModal();
                    return;
                }

                try {
                    const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                    await machineRef.update({
                        plays: revertedPlays,
                        payouts: revertedPayouts
                    });
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(historyDocId).delete();
                    
                    hideConfirmationModal();
                    showFeedback("è¨˜å¸³ç´€éŒ„å·²åˆªé™¤ä¸¦æˆåŠŸå›æ»¾æ•¸æ“šï¼", false);
                    loadStoreData();

                } catch (error) {
                    console.error("åˆªé™¤è¨˜å¸³ç´€éŒ„å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }
        
        function getAggregatedSummaryData(period = 'all') {
            let dataToAggregate;

            if (period === 'all') {
                dataToAggregate = appData.machines.map(m => {
                    const effectivePlays = m.plays - (m.initialPlays || 0);
                    const effectivePayouts = m.payouts - (m.initialPayouts || 0);
                    return { id: m.id, plays: effectivePlays, payouts: effectivePayouts };
                });
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                const filteredHistory = appData.history.filter(h => new Date(h.date) >= startDate);

                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: h.newPlays,
                    payouts: h.newPayouts
                }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { id: s.id, revenue, payouts: s.payouts, cost };
            });
        }
        
        async function handlePerformCheckout() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');

            try {
                const checkoutSnapshot = await checkoutCollection.limit(1).get();
                let lastCheckoutRevenue = 0;
                let lastCheckoutDate = appData.startDate;

                if (!checkoutSnapshot.empty) {
                    const lastCheckout = checkoutSnapshot.docs[0].data();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    lastCheckoutDate = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                }

                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;

                if (pendingAmount <= 0) {
                    alert("ç›®å‰æ²’æœ‰å¾…çµå¸³é‡‘é¡ã€‚");
                    return;
                }
                
                showConfirmationModal(`æ‚¨ç¢ºå®šè¦çµç®—æœ¬æœŸç‡Ÿæ”¶ ${pendingAmount.toLocaleString()} å…ƒå—ï¼Ÿ`, async () => {
                     try {
                        const newCheckoutData = {
                            checkoutDate: firebase.firestore.FieldValue.serverTimestamp(),
                            checkoutAmount: pendingAmount,
                            cumulativeRevenueAtCheckout: currentTotalRevenue
                        };
                        const newCheckoutRef = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').add(newCheckoutData);
                        
                        hideConfirmationModal();
                        showFeedback("çµå¸³æˆåŠŸï¼æ‚¨å¯ä»¥åœ¨çµå¸³æ­·å²ä¸­ä¸‹è¼‰å ±è¡¨ã€‚", false);
                        renderCheckoutTab(); // Refresh the tab

                    } catch (error) {
                        hideConfirmationModal();
                        console.error("çµå¸³å¤±æ•—:", error);
                        showFeedback("çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
                    }
                });
            } catch (error) {
                console.error("è™•ç†çµå¸³æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showFeedback("è™•ç†çµå¸³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
            }
        }


        // --- UI RENDERING FUNCTIONS ---
        function renderGroups(groups) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            groupListContainer.innerHTML = '';
            if (groups.length === 0) {
                const noGroupsMessage = isAdmin ? 
                    'å°šæœªå»ºç«‹ä»»ä½•å–®ä½ç¾¤çµ„ã€‚' : 
                    'æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•ä»»ä½•ç¾¤çµ„ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚';
                groupListContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center py-8">${noGroupsMessage}</p>`;
                return;
            }
            groups.forEach(group => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 pt-3">
                        <button class="rename-group-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">æ”¹å</button>
                        <button class="delete-group-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">åˆªé™¤</button>
                    </div>
                ` : '';
                
                const groupCard = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="card-base group-card-main cursor-pointer p-4 mb-3" data-group-id="${group.id}" data-group-name="${group.name}">
                            <h3 class="text-xl font-bold text-white truncate text-center">${group.name}</h3>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                groupListContainer.innerHTML += groupCard;
            });
            
            // éš±è—æ–°å¢ç¾¤çµ„è¡¨å–®ï¼ˆå¦‚æœæ˜¯è¨ªå®¢ï¼‰
            const createGroupForm = document.getElementById('create-group-form').parentElement;
            if (createGroupForm) {
                if (isAdmin) {
                    createGroupForm.style.display = 'block';
                } else {
                    createGroupForm.style.display = 'none';
                }
            }
        }
        
        function renderStores(stores) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            storeListContainer.innerHTML = ''; 
            if (stores.length === 0) {
                storeListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">æ­¤ç¾¤çµ„å°šæœªå»ºç«‹ä»»ä½•é–€å¸‚ã€‚</p>';
                return;
            }
            stores.forEach(store => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 px-4 py-3">
                        <button class="edit-store-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">ç·¨è¼¯</button>
                        <button class="delete-store-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">åˆªé™¤</button>
                    </div>
                ` : '';
                
                const storeCard = `
                     <div class="bg-gray-700 rounded-lg">
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="card-base store-card-main cursor-pointer flex-grow" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                                    <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                                </div>
                                <input type="checkbox" class="store-checkbox h-6 w-6 bg-gray-800 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600 shrink-0 ml-3 cursor-pointer" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}" checked>
                            </div>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                storeListContainer.innerHTML += storeCard;
            });
        }
        
        function updateUI() {
            if (!appData || !appData.machines) return;
            const processedMachines = appData.machines.map(processMachineData);
            renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            renderSummaryTab();
            renderAnalysisTab();
            renderAccountingTab();
            renderMachineManagementTab(); 
            renderChartsTab();
            renderStatisticsTab();
            updateFooterAndHeader();
        }

        function renderMachineManagementTab() {
            machineListTableBody.innerHTML = '';
            if (!appData.machines || appData.machines.length === 0) {
                machineListTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">æ­¤é–€å¸‚å°šç„¡æ©Ÿå°ï¼Œè«‹å…ˆå»ºç«‹ä¸€å°ã€‚</td></tr>`;
                return;
            }
            appData.machines.forEach(machine => {
                const row = `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-4 font-medium text-white">${machine.id}</td>
                        <td class="p-4">${machine.location}</td>
                        <td class="p-4 text-right">${machine.initialPlays || 0}</td>
                        <td class="p-4 text-right">${machine.initialPayouts || 0}</td>
                        <td class="p-4 text-right">
                            <button class="edit-machine-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2" 
                                data-doc-id="${machine.docId}" 
                                data-id="${machine.id}"
                                data-location="${machine.location}"
                                data-initial-plays="${machine.initialPlays || 0}"
                                data-initial-payouts="${machine.initialPayouts || 0}">
                                ä¿®æ”¹
                           </button>
                            <button class="delete-machine-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" data-doc-id="${machine.docId}">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                machineListTableBody.innerHTML += row;
            });
        }
        
        function renderMainStats(data) {
            const totalPlays = data.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = data.reduce((sum, m) => sum + m.effectivePayouts, 0);
            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;
            document.getElementById('total-plays').textContent = `${totalPlays.toLocaleString()} æ¬¡`;
            document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('total-payouts').textContent = `${totalPayouts.toLocaleString()} æ¬¡`;
            document.getElementById('avg-cost').textContent = `${avgCost.toFixed(2)} å…ƒ/æ¬¡`;
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            
            filteredData.sort((a, b) => {
                // Primary comparison based on the selected column
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                let primaryCompare = 0;
                if(typeof valA === 'number' && typeof valB === 'number') {
                    primaryCompare = valA - valB;
                } else {
                    primaryCompare = String(valA).localeCompare(String(valB), undefined, { numeric: true });
                }

                if (primaryCompare !== 0) {
                    return currentSort.direction === 'asc' ? primaryCompare : -primaryCompare;
                }

                // Secondary Sorting Logic
                if (currentSort.key !== 'id') {
                    const idCompare = a.id.localeCompare(b.id, undefined, { numeric: true });
                    if (idCompare !== 0) return idCompare;
                }

                // Tertiary Sorting Logic (or secondary if sorting by ID)
                return a.location.localeCompare(b.location, undefined, { numeric: true });
            });

            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.effectivePlays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.effectivePayouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            const cumulativePlaysInput = document.getElementById('cumulative-plays');
            const cumulativePayoutsInput = document.getElementById('cumulative-payouts');
            
            machineSelector.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
            if(appData.machines.length === 0) {
                machineSelector.innerHTML = '<option value="" disabled selected>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°</option>';
            } else {
                appData.machines.sort((a, b) => a.id.localeCompare(b.id)).forEach(m => {
                    machineSelector.innerHTML += `<option value="${m.docId}">${m.id} - ${m.location}</option>`;
                });
            }
            document.getElementById('entry-date').valueAsDate = new Date();
            cumulativePlaysInput.value = '';
            cumulativePayoutsInput.value = '';
            
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">å°šç„¡è¨˜å¸³ç´€éŒ„</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr class="hover:bg-gray-700/50">
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || 'æœªçŸ¥'}</td>
                        <td class="p-4">${h.location || 'æœªçŸ¥'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                        <td class="p-4 text-right">
                           <button class="edit-history-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2"
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                ä¿®æ”¹
                           </button>
                           <button class="delete-history-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" 
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                åˆªé™¤
                           </button>
                        </td>
                    </tr>`;
                });
            }
        }
        
        function renderSummaryTab() {
            const activeButton = document.querySelector('#summary-controls .active');
            const period = activeButton ? activeButton.dataset.period : 'all';
            const summaryData = getAggregatedSummaryData(period);

            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            if (summaryData.length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">æ­¤æœŸé–“ç„¡è³‡æ–™å¯ä¾›é¡¯ç¤º</td></tr>`;
            } else {
                summaryData.sort((a,b) => b.revenue - a.revenue).forEach((s, index) => {
                    const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                    summaryTableBody.innerHTML += `<tr class="${rowClass}">
                        <td class="p-4 font-medium text-white">${s.id}</td>
                        <td class="p-4 text-right">${s.revenue.toLocaleString()} å…ƒ</td>
                        <td class="p-4 text-right">${s.payouts.toLocaleString()} æ¬¡</td>
                        <td class="p-4 text-right">${s.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                    </tr>`;
                });
            }

            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red', 'indigo', 'pink'];
            
            if (summaryData.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-gray-500">ç„¡ä½”æ¯”è³‡æ–™</p>';
            } else {
                summaryData.forEach((s, index) => {
                    const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];
                    chartContainer.innerHTML += `<div class="w-full">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-${color}-300">${s.id}</span>
                            <span class="text-sm font-medium text-${color}-300">${s.revenue.toLocaleString()} å…ƒ (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                });
            }
        }

        function renderAnalysisTab(customRange = null) {
            const psdControls = document.getElementById('psd-controls');
            const activeButton = psdControls.querySelector('.active');
            let period = activeButton ? activeButton.dataset.period : 'all';
            let periodRevenue = 0;
            let diffDays = 1;
            let analysisTitle = activeButton ? activeButton.textContent : "è‡ªè¨‚å€é–“";

            // Handle custom range
            if(customRange){
                period = 'custom';
                analysisTitle = `${customRange.start} ~ ${customRange.end}`;
            }

            // Calculate revenue and days based on period
            if (period === 'all') {
                periodRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const startDate = new Date(appData.startDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            } else {
                let periodStartDate, periodEndDate;
                if (period === 'custom') {
                    periodStartDate = new Date(customRange.start + 'T00:00:00');
                    periodEndDate = new Date(customRange.end + 'T00:00:00');
                } else {
                     const now = new Date();
                    switch (period) {
                        case 'weekly':
                            const day = now.getDay();
                            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                            periodStartDate = new Date(new Date().setDate(diff));
                            periodEndDate = new Date();
                            break;
                        case 'monthly':
                            periodStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            periodEndDate = new Date();
                            break;
                        case 'quarterly':
                            const quarter = Math.floor(now.getMonth() / 3);
                            periodStartDate = new Date(now.getFullYear(), quarter * 3, 1);
                            periodEndDate = new Date();
                            break;
                    }
                }
                periodStartDate.setHours(0,0,0,0);
                periodEndDate.setHours(23,59,59,999);

                const filteredHistory = appData.history.filter(h => {
                    const recordDate = new Date(h.date);
                    return recordDate >= periodStartDate && recordDate <= periodEndDate;
                });
                periodRevenue = filteredHistory.reduce((sum, h) => sum + (h.newPlays * COIN_VALUE), 0);
                const diffTime = Math.abs(periodEndDate - periodStartDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            }
            
            const psd = periodRevenue > 0 && diffDays > 0 ? periodRevenue / diffDays : 0;
            document.getElementById('psd-display').innerHTML = `
                <div class="text-sm text-gray-400">${analysisTitle} æ¯æ—¥å¹³å‡ç‡Ÿæ”¶</div>
                <div class="text-2xl font-bold text-white mt-1">${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} å…ƒ / å¤©</div>
                <div class="text-xs text-gray-500 mt-1">(${periodRevenue.toLocaleString()} å…ƒ Ã· ${diffDays} å¤©)</div>`;

            
            // --- Detailed Analysis ---
            const observationEl = document.getElementById('analysis-observation');
            const suggestionEl = document.getElementById('analysis-suggestion');
            const processedMachines = appData.machines.map(processMachineData);

            if (processedMachines.length === 0) {
                 observationEl.innerHTML = '<p>å°šç„¡æ©Ÿå°æ•¸æ“šå¯é€²è¡Œåˆ†æã€‚</p>';
                 suggestionEl.innerHTML = '<p>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°ï¼Œä¸¦åœ¨ã€Œæ¯æ—¥è¨˜å¸³ã€æ–°å¢ç´€éŒ„ã€‚</p>';
                 return;
            }

            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

            let observationHTML = '';
            let suggestionHTML = '';

            // Top 3 Revenue
            observationHTML += '<div><h4 class="text-lg font-semibold text-green-400 mb-2">ğŸ¥‡ ç‡Ÿæ”¶ TOP 3 æ©Ÿå° (é‡‘é›æ¯)</h4><ul class="list-disc pl-5 space-y-1">';
            sortedByRevenue.slice(0, 3).forEach(m => {
                observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: ç¸½ç‡Ÿæ”¶ ${m.revenue.toLocaleString()} å…ƒ</li>`;
            });
            observationHTML += '</ul></div>';
            suggestionHTML += '<div><p class="text-green-300/80">å°æ–¼é«˜ç‡Ÿæ”¶æ©Ÿå°ï¼Œå»ºè­°ç¶­æŒç›®å‰ç†±åº¦ï¼Œå¯è€ƒæ…®é©æ™‚è£œå……é¡ä¼¼çå“ï¼Œä»¥éå›ºç‡Ÿæ”¶è¡¨ç¾ã€‚</p></div>';


            // Bottom 3 Revenue
            if (sortedByRevenue.length > 3) {
                 observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-yellow-400 mb-2">ğŸ¥‰ ç‡Ÿæ”¶ BOTTOM 3 æ©Ÿå° (å¾…è§€å¯Ÿ)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByRevenue.slice(-3).reverse().forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: ç¸½ç‡Ÿæ”¶ ${m.revenue.toLocaleString()} å…ƒ</li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-yellow-300/80">å°æ–¼ç‡Ÿæ”¶æœ«æ®µç­ï¼Œå»ºè­°è§€å¯Ÿæ©Ÿå°ä½ç½®æ˜¯å¦ç†æƒ³ï¼Œæˆ–è€ƒæ…®æ›´æ›çå“é¡å‹ã€èª¿æ•´çˆªåŠ›è¨­å®šä»¥æå‡æŠ•å¹£æ„é¡˜ã€‚</p></div>';
            }

            // Top 3 Highest Cost
             if (sortedByCost.length > 0) {
                observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-red-400 mb-2">ğŸš¨ å‡ºè²¨æˆæœ¬æœ€é«˜ TOP 3 æ©Ÿå° (è­¦ç¤ºå€)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByCost.slice(0, 3).forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: å¹³å‡æˆæœ¬ <strong class="text-red-400">${m.cost.toFixed(2)} å…ƒ/æ¬¡</strong></li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-red-300/80">æˆæœ¬éé«˜çš„æ©Ÿå°éœ€é‡é»é—œæ³¨ï¼å»ºè­°ç«‹å³æª¢è¨çˆªåŠ›è¨­å®šèˆ‡çå“åƒ¹å€¼æ˜¯å¦åŒ¹é…ï¼Œé¿å…åˆ©æ½¤è¢«ä¾µè•ã€‚</p></div>';

            }

            observationEl.innerHTML = observationHTML;
            suggestionEl.innerHTML = suggestionHTML;
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        key = new Date(d.setDate(diff)).toISOString().split('T')[0];
                        break;
                    case 'monthly': key = curr.date.substring(0, 7); break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        break;
                    default: key = curr.date; // daily
                }
                if (!acc[key]) {
                    acc[key] = { period: key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            const data = getAggregatedData(period);
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            if(data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">å°šç„¡æ­·å²ç´€éŒ„å¯ä¾›å½™æ•´</td></tr>`;
                return;
            }
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.period}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                </tr>`;
            });
        }
        
        function renderChartsTab() {
            const revenueChartEl = document.getElementById('revenue-chart');
            const costChartEl = document.getElementById('cost-chart');

            revenueChartEl.innerHTML = '';
            costChartEl.innerHTML = '';

            const processedMachines = appData.machines.map(processMachineData);

            if (processedMachines.length === 0) {
                revenueChartEl.innerHTML = '<p class="text-center text-gray-500">å°šç„¡è³‡æ–™å¯ç¹ªè£½åœ–è¡¨</p>';
                costChartEl.innerHTML = '<p class="text-center text-gray-500">å°šç„¡è³‡æ–™å¯ç¹ªè£½åœ–è¡¨</p>';
            } else {
                const maxRevenue = Math.max(...processedMachines.map(m => m.revenue), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.revenue / maxRevenue * 100);
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${machine.revenue.toLocaleString()} å…ƒ
                                </div>
                            </div>
                        </div>
                    `;
                    revenueChartEl.innerHTML += chartItem;
                });

                const maxCost = Math.max(...processedMachines.map(m => m.cost), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.cost / maxCost * 100);
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${machine.cost.toFixed(2)} å…ƒ/æ¬¡
                                </div>
                            </div>
                        </div>
                    `;
                    costChartEl.innerHTML += chartItem;
                });
            }
            
            const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
            if (appData.history.length > 0) {
                const latestDate = appData.history.reduce((max, h) => h.date > max ? h.date : max, appData.history[0].date);
                trendChartDatePicker.value = latestDate;
            } else {
                trendChartDatePicker.valueAsDate = new Date();
            }
            
            renderTrendChartByDate(); 
        }

        function renderTrendChartByDate() {
            const trendChartContentEl = document.getElementById('trend-chart-content');
            const selectedDate = trendChartDatePicker.value;

            trendChartContentEl.innerHTML = '';

            if (!selectedDate) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">è«‹é¸æ“‡ä¸€å€‹æ—¥æœŸä¾†æŸ¥çœ‹æ•¸æ“š</p>';
                return;
            }

            const dailyRecords = appData.history.filter(h => h.date === selectedDate);

            if (dailyRecords.length === 0) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">è©²æ—¥æœŸæ²’æœ‰è¨˜å¸³ç´€éŒ„</p>';
                return;
            }
            
            const aggregatedData = dailyRecords.reduce((acc, record) => {
                const key = `${record.machineId}|${record.location}`;
                if (!acc[key]) {
                    acc[key] = {
                        machineId: record.machineId,
                        location: record.location,
                        newPlays: 0,
                        newPayouts: 0
                    };
                }
                acc[key].newPlays += record.newPlays;
                acc[key].newPayouts += record.newPayouts;
                return acc;
            }, {});
            const aggregatedRecords = Object.values(aggregatedData);

            const recordsWithCalc = aggregatedRecords.map(r => {
                const revenue = r.newPlays * COIN_VALUE;
                const cost = r.newPayouts > 0 ? revenue / r.newPayouts : 0;
                return {...r, revenue, cost };
            });

            const maxRevenue = Math.max(...recordsWithCalc.map(r => r.revenue), 1);
            const maxCost = Math.max(...recordsWithCalc.map(r => r.cost), 1);
            
            let totalDayRevenue = 0;
            let totalDayPayouts = 0;
            
            recordsWithCalc.forEach(record => {
                totalDayRevenue += record.revenue;
                totalDayPayouts += record.newPayouts;
            });

            const revenueCharts = [...recordsWithCalc].sort((a,b) => b.revenue - a.revenue).map(record => {
                const barWidth = (record.revenue / maxRevenue) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.revenue.toLocaleString()} å…ƒ
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const costCharts = [...recordsWithCalc].sort((a,b) => b.cost - a.cost).map(record => {
                const barWidth = (record.cost / maxCost) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.cost.toFixed(2)} å…ƒ/æ¬¡
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalDayCost = totalDayPayouts > 0 ? totalDayRevenue / totalDayPayouts : 0;

            trendChartContentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-h-80 overflow-y-auto pr-2">
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">ç•¶æ—¥ç‡Ÿæ”¶</h4>
                           <p class="text-sm text-blue-300">ç¸½è¨ˆï¼š${totalDayRevenue.toLocaleString()} å…ƒ</p>
                        </div>
                        <div class="space-y-4">${revenueCharts}</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">ç•¶æ—¥å‡ºè²¨æˆæœ¬</h4>
                           <p class="text-sm text-yellow-300">å¹³å‡ï¼š${totalDayCost.toFixed(2)} å…ƒ/æ¬¡</p>
                        </div>
                        <div class="space-y-4">${costCharts}</div>
                    </div>
                </div>
            `;
        }
        
        async function renderCheckoutTab() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
            const lastCheckoutDateEl = document.getElementById('last-checkout-date');
            const pendingAmountEl = document.getElementById('pending-checkout-amount');

            checkoutHistoryBody.innerHTML = '';

            try {
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                let lastCheckoutRevenue = 0;
                if (checkouts.length > 0) {
                    const lastCheckout = checkouts[0];
                    lastCheckoutDateEl.textContent = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;

                    checkouts.forEach((checkout, index) => {
                         const prevCheckoutDate = index < checkouts.length - 1 ? new Date(checkouts[index + 1].checkoutDate.toDate()).toLocaleString() : appData.startDate;
                        const row = `
                            <tr class="hover:bg-gray-700/50">
                                <td class="p-4">${new Date(checkout.checkoutDate.toDate()).toLocaleString()}</td>
                                <td class="p-4 text-right">${checkout.checkoutAmount.toLocaleString()} å…ƒ</td>
                                <td class="p-4 text-right">${checkout.cumulativeRevenueAtCheckout.toLocaleString()} å…ƒ</td>
                                <td class="p-4 text-right">
                                    <button class="download-checkout-pdf-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded"
                                        data-checkout-id="${checkout.id}"
                                        data-checkout-date="${new Date(checkout.checkoutDate.toDate()).toLocaleString()}"
                                        data-prev-checkout-date="${prevCheckoutDate}"
                                        data-amount="${checkout.checkoutAmount}"
                                        data-cumulative="${checkout.cumulativeRevenueAtCheckout}">
                                        ä¸‹è¼‰å ±å‘Š
                                    </button>
                                </td>
                            </tr>
                        `;
                        checkoutHistoryBody.innerHTML += row;
                    });
                    
                    // æ¸²æŸ“åœ–è¡¨å’Œçµ±è¨ˆæ•¸æ“š
                    renderCheckoutCharts(checkouts);
                    renderCheckoutStats(checkouts);
                } else {
                    lastCheckoutDateEl.textContent = 'ç„¡ (ä»¥ç‡Ÿæ¥­èµ·å§‹æ—¥ç‚ºæº–)';
                    checkoutHistoryBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">å°šç„¡çµå¸³ç´€éŒ„</td></tr>`;
                    
                    // æ¸…ç©ºåœ–è¡¨å’Œçµ±è¨ˆ
                    clearCheckoutCharts();
                    clearCheckoutStats();
                }
                
                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;
                pendingAmountEl.textContent = `${pendingAmount.toLocaleString()} å…ƒ`;

            } catch (error) {
                console.error("è®€å–çµå¸³æ­·å²å¤±æ•—:", error);
                checkoutHistoryBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-400">ç„¡æ³•è®€å–çµå¸³æ­·å²</td></tr>`;
                clearCheckoutCharts();
                clearCheckoutStats();
            }
        }

        // æ¸²æŸ“çµå¸³åœ–è¡¨
        function renderCheckoutCharts(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutCharts();
                return;
            }

            // æŒ‰æ™‚é–“æ’åº (èˆŠåˆ°æ–°)
            const sortedCheckouts = [...checkouts].reverse();
            
            // çµå¸³é‡‘é¡è¶¨å‹¢åœ– - ä½¿ç”¨ç·šåœ– + å€åŸŸå¡«å……
            renderLineChart('checkout-amount-chart', sortedCheckouts, 'checkoutAmount', 'blue', 'çµå¸³é‡‘é¡');
            
            // ç´¯ç©ç‡Ÿæ”¶è¶¨å‹¢åœ– - ä½¿ç”¨ç·šåœ– + å€åŸŸå¡«å……
            renderLineChart('checkout-cumulative-chart', sortedCheckouts, 'cumulativeRevenueAtCheckout', 'green', 'ç´¯ç©ç‡Ÿæ”¶');
        }

        // æ¸²æŸ“ç·šåœ–
        function renderLineChart(elementId, data, valueKey, color, label) {
            const chartEl = document.getElementById(elementId);
            const values = data.map(d => d[valueKey]);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const valueRange = maxValue - minValue || 1;
            
            const chartWidth = 400;
            const chartHeight = 200;
            const padding = 40;
            
            chartEl.innerHTML = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4">
                    <svg width="100%" height="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" class="overflow-visible">
                        <!-- ç¶²æ ¼ç·š -->
                        ${Array.from({length: 5}, (_, i) => {
                            const y = padding + (i * (chartHeight - 2 * padding)) / 4;
                            return `<line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" stroke="#374151" stroke-width="1" opacity="0.3"/>`;
                        }).join('')}
                        
                        <!-- å€åŸŸå¡«å…… -->
                        <defs>
                            <linearGradient id="gradient-${color}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.3"/>
                                <stop offset="100%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.05"/>
                            </linearGradient>
                        </defs>
                        
                        <path d="M${padding},${chartHeight - padding} ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `L${x},${y}`;
                        }).join(' ')} L${chartWidth - padding},${chartHeight - padding} Z" 
                              fill="url(#gradient-${color})" stroke="none"/>
                        
                        <!-- ç·šæ¢ -->
                        <path d="M${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `${index === 0 ? 'M' : 'L'}${x},${y}`;
                        }).join(' ')}" 
                              fill="none" 
                              stroke="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                              stroke-width="3" 
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                        
                        <!-- æ•¸æ“šé» -->
                        ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                            const value = item[valueKey].toLocaleString();
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        fill="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                                        stroke="#1f2937" 
                                        stroke-width="2" 
                                        class="cursor-pointer transition-all hover:r-6"
                                        data-tooltip="${date}: ${value} å…ƒ">
                                    <title>${date}: ${value} å…ƒ</title>
                                </circle>
                            `;
                        }).join('')}
                        
                        <!-- Yè»¸æ¨™ç±¤ -->
                        ${Array.from({length: 5}, (_, i) => {
                            const value = minValue + (i * valueRange) / 4;
                            const y = chartHeight - padding - (i * (chartHeight - 2 * padding)) / 4;
                            return `<text x="${padding - 10}" y="${y + 4}" fill="#9ca3af" text-anchor="end" font-size="10">${Math.round(value).toLocaleString()}</text>`;
                        }).join('')}
                    </svg>
                    
                    <!-- æ•¸æ“šé»æ¨™ç±¤ -->
                    <div class="absolute bottom-2 left-0 right-0 flex justify-between px-10 text-xs text-gray-400">
                        ${data.map((item, index) => {
                            if (data.length <= 5 || index % Math.ceil(data.length / 5) === 0 || index === data.length - 1) {
                                const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                                return `<span class="transform -rotate-45 origin-bottom-left">${date}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <!-- åœ–ä¾‹ -->
                    <div class="absolute top-2 right-2 flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-gradient-to-br ${color === 'blue' ? 'from-blue-400 to-blue-600' : 'from-green-400 to-green-600'}"></div>
                        <span class="text-xs text-gray-300">${label}</span>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“çµå¸³çµ±è¨ˆ
        function renderCheckoutStats(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutStats();
                return;
            }

            const totalCheckouts = checkouts.length;
            const totalAmount = checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0);
            const avgAmount = totalAmount / totalCheckouts;
            const maxAmount = Math.max(...checkouts.map(c => c.checkoutAmount));
            
            // è¨ˆç®—çµå¸³é »ç‡ (å¹³å‡å¤©æ•¸)
            let frequency = 0;
            if (checkouts.length > 1) {
                const firstDate = new Date(checkouts[checkouts.length - 1].checkoutDate.toDate());
                const lastDate = new Date(checkouts[0].checkoutDate.toDate());
                const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                frequency = Math.round(daysDiff / (checkouts.length - 1));
            }

            document.getElementById('total-checkouts').textContent = totalCheckouts.toLocaleString();
            document.getElementById('avg-checkout-amount').textContent = `${Math.round(avgAmount).toLocaleString()} å…ƒ`;
            document.getElementById('max-checkout-amount').textContent = `${maxAmount.toLocaleString()} å…ƒ`;
            document.getElementById('checkout-frequency').textContent = frequency > 0 ? `${frequency} å¤©/æ¬¡` : 'ç„¡';
        }

        // æ¸…ç©ºåœ–è¡¨
        function clearCheckoutCharts() {
            const emptyChartHtml = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-gray-500 text-sm">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                        <p class="text-gray-600 text-xs mt-1">å®Œæˆé¦–æ¬¡çµå¸³å¾Œå°‡é¡¯ç¤ºè¶¨å‹¢åœ–</p>
                    </div>
                </div>
            `;
            document.getElementById('checkout-amount-chart').innerHTML = emptyChartHtml;
            document.getElementById('checkout-cumulative-chart').innerHTML = emptyChartHtml;
        }

        // æ¸…ç©ºçµ±è¨ˆ
        function clearCheckoutStats() {
            document.getElementById('total-checkouts').textContent = '0';
            document.getElementById('avg-checkout-amount').textContent = '0 å…ƒ';
            document.getElementById('max-checkout-amount').textContent = '0 å…ƒ';
            document.getElementById('checkout-frequency').textContent = '0 å¤©/æ¬¡';
        }


        function updateFooterAndHeader() {
            // æ›´æ–°é é¦–è³‡è¨Š
            const headerEl = document.querySelector('#accounting-header');
            if (headerEl && currentGroupName && currentStoreName) {
                headerEl.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4">
                        ${currentGroupName} - ${currentStoreName} å¸³å‹™ç´€éŒ„
                    </h2>
                `;
            }

            // æ›´æ–°è¡¨æ ¼è¡¨å°¾çµ±è¨ˆ
            const tableFooter = document.querySelector('#accounting-table tfoot');
            if (tableFooter && accountingData && accountingData.length > 0) {
                const totalRevenue = accountingData.reduce((sum, item) => sum + (item.revenue || 0), 0);
                const totalPayouts = accountingData.reduce((sum, item) => sum + (item.payouts || 0), 0);
                const avgCost = accountingData.length > 0 ? 
                    accountingData.reduce((sum, item) => sum + (item.cost || 0), 0) / accountingData.length : 0;

                tableFooter.innerHTML = `
                    <tr class="bg-gray-700/50 font-bold">
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ç¸½è¨ˆ</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">${totalRevenue.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">${totalPayouts.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-blue-400 uppercase tracking-wider">${avgCost.toFixed(2)}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                    </tr>
                `;
            }
        }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        function getPeriodDateRange(period, dateStr) {
            const today = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            switch (period) {
                case 'daily':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'weekly':
                    const day = today.getDay();
                    const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                    startDate = new Date(new Date(today).setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'yearly':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            return {
                startDate: toYYYYMMDD(startDate),
                endDate: toYYYYMMDD(endDate)
            };
        }

        async function getStoreSummaryForPeriod(storeId, period, date) {
            if (period === 'all') {
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('machines').get();
                const machines = machinesSnapshot.docs.map(doc => doc.data());
                return machines.map(m => {
                    const processed = processMachineData(m);
                    return { id: m.id, location: m.location, revenue: processed.revenue, payouts: processed.effectivePayouts, cost: processed.cost };
                });
            }

            const { startDate, endDate } = getPeriodDateRange(period, date);
            
            const historySnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('history').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const filteredHistory = historySnapshot.docs.map(doc => doc.data());

            if (filteredHistory.length === 0) return [];

            const summary = filteredHistory.reduce((acc, curr) => {
                const key = `${curr.machineId}|${curr.location}`;
                if (!acc[key]) {
                     acc[key] = { id: curr.machineId, location: curr.location, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});
            
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        async function handleDownloadAllStoresReport() {
            if(!selectedGroupId) return alert('No group selected.');
            const btn = document.getElementById('download-all-stores-report-btn');
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¦ä¸‹è¼‰çš„é–€å¸‚ã€‚");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>è™•ç†ä¸­...</span>`;
            btn.disabled = true;

            const period = reportPeriodSelector.value;
            const date = reportDatePicker.value;
            const periodText = reportPeriodSelector.options[reportPeriodSelector.selectedIndex].text;

            if (period !== 'all' && !date) {
                alert('è«‹é¸æ“‡ä¸€å€‹åŸºæº–æ—¥æœŸï¼');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const storesToDownload = Array.from(selectedStoreCheckboxes).map(cb => ({
                    id: cb.dataset.storeId,
                    name: cb.dataset.storeName,
                    startDate: cb.dataset.startDate
                }));

                const csvRows = [];
                let grandTotalRevenue = 0;
                let grandTotalPayouts = 0;
                let grandTotalDays = 0;
                let psdCalculated = false;
                
                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    if (summaryData.length > 0) {
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        grandTotalRevenue += storeTotalRevenue;
                        grandTotalPayouts += storeTotalPayouts;
                    }
                }

                const grandTotalAvgCost = grandTotalPayouts > 0 ? grandTotalRevenue / grandTotalPayouts : 0;

                csvRows.push(`æ‰€é¸é–€å¸‚ç‡Ÿé‹ç¸½è¨ˆ - ${periodText}${period !== 'all' ? ' (' + date + ')' : ''}`);
                csvRows.push(`å ±è¡¨ç”¢ç”Ÿæ—¥æœŸ: ${new Date().toLocaleString()}`);
                csvRows.push("");
                csvRows.push("--- å…¨é¸é–€å¸‚ç¸½è¨ˆ ---");
                csvRows.push(["é …ç›®", "ç¸½è¨ˆ"].join(','));
                csvRows.push(["ç¸½ç‡Ÿæ”¶", grandTotalRevenue].join(','));
                csvRows.push(["ç¸½å‡ºè²¨æ•¸", grandTotalPayouts].join(','));
                csvRows.push(["ç¸½å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)", grandTotalAvgCost.toFixed(2)].join(','));
                
                let grandPsd = 0;
                if (period === 'all') {
                    // Cannot accurately calculate combined PSD for 'all' without a common start date.
                } else {
                    const { startDate, endDate } = getPeriodDateRange(period, date);
                    const d1 = new Date(startDate);
                    const d2 = new Date(endDate);
                    const diffTime = Math.abs(d2 - d1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    grandPsd = grandTotalRevenue / diffDays;
                    csvRows.push([`æœŸé–“PSD (æ¯æ—¥å¹³å‡ç‡Ÿæ”¶)`, `"${grandPsd.toFixed(2)} å…ƒ/å¤©"`].join(","));
                }


                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    
                    csvRows.push("");
                    csvRows.push(`--- ${store.name} ---`);
                    const summaryTableHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "æœŸé–“ç‡Ÿæ”¶", "æœŸé–“å‡ºè²¨æ•¸", "æœŸé–“å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                    csvRows.push(summaryTableHeaders.join(","));

                    if (summaryData.length > 0) {
                        summaryData.forEach(item => {
                            csvRows.push([
                                item.id,
                                `"${item.location}"`,
                                item.revenue,
                                item.payouts,
                                item.cost.toFixed(2)
                            ].join(","));
                        });
                        
                        // Add Store Total and PSD
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        const storeAvgCost = storeTotalPayouts > 0 ? storeTotalRevenue / storeTotalPayouts : 0;
                        
                        csvRows.push(""); // blank line
                        csvRows.push([`é–€å¸‚ç¸½è¨ˆ`, "", storeTotalRevenue, storeTotalPayouts, storeAvgCost.toFixed(2)].join(","));

                        let psd = 0;
                        if (period === 'all') {
                             if (store.startDate) {
                                const storeStartDate = new Date(store.startDate);
                                const today = new Date();
                                const diffTime = Math.abs(today - storeStartDate);
                                const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
                                const machineDocs = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(store.id).collection('machines').get();
                                const machines = machineDocs.docs.map(doc => doc.data());
                                const totalCumulativeRevenue = machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                                psd = totalCumulativeRevenue / diffDays;
                            }
                        } else {
                            const { startDate, endDate } = getPeriodDateRange(period, date);
                            const d1 = new Date(startDate);
                            const d2 = new Date(endDate);
                            const diffTime = Math.abs(d2 - d1);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            psd = storeTotalRevenue / diffDays;
                        }
                         csvRows.push([`é–€å¸‚PSD (æ¯æ—¥å¹³å‡ç‡Ÿæ”¶)`, "", `"${psd.toFixed(2)} å…ƒ/å¤©"`].join(","));


                    } else {
                        csvRows.push("æ­¤æœŸé–“å°šç„¡æ•¸æ“š");
                    }
                }
                
                let csvContent = "\uFEFF";
                csvContent += csvRows.join("\n");

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `${selectedGroupName}-ç‡Ÿé‹å ±è¡¨-${periodText}-${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("ä¸‹è¼‰å…¨é–€å¸‚å ±è¡¨å¤±æ•—:", error);
                alert("ä¸‹è¼‰å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // --- EVENT LISTENERS ---
        
        // ç®¡ç†è€…ç•Œé¢äº‹ä»¶
        adminBtn.addEventListener('click', showAdminPage);
        backToMainBtn.addEventListener('click', hideAdminPage);

        // é é¢æ¬Šé™å¿«æ·æŒ‰éˆ•äº‹ä»¶
        document.getElementById('select-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('select-readonly-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            // åªå‹¾é¸æª¢è¦–ç›¸é—œæ¬Šé™
            const readonlyPermissions = ['details', 'summary', 'analysis', 'charts', 'statistics'];
            readonlyPermissions.forEach(permission => {
                const checkbox = document.querySelector(`.page-permission-checkbox[value="${permission}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        document.getElementById('clear-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
        });

        // ç®¡ç†å“¡å¯†ç¢¼æ›´æ–°
        adminPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newUsername = document.getElementById('new-username').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAdminFeedback('admin-password-feedback', 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', true);
                return;
            }

            try {
                await window.adminConfig.updateAdminCredentials(newUsername, newPassword, currentPassword);
                showAdminFeedback('admin-password-feedback', 'ç®¡ç†å“¡å¸³å¯†æ›´æ–°æˆåŠŸ');
                adminPasswordForm.reset();
                document.getElementById('new-username').value = newUsername;
            } catch (error) {
                showAdminFeedback('admin-password-feedback', error.message, true);
            }
        });

        // è¨ªå®¢å¸³è™Ÿç®¡ç†
        guestAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('guest-username').value;
            const password = document.getElementById('guest-password').value;
            const selectedGroups = Array.from(document.querySelectorAll('.group-permission-checkbox:checked'))
                .map(cb => cb.value);
            const selectedPagePermissions = Array.from(document.querySelectorAll('.page-permission-checkbox:checked'))
                .map(cb => cb.value);

            const isEditing = guestAccountForm.dataset.editingId;

            try {
                if (isEditing) {
                    await window.adminConfig.updateGuestAccount(isEditing, {
                        username,
                        password,
                        allowedGroups: selectedGroups,
                        pagePermissions: selectedPagePermissions
                    });
                    showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿæ›´æ–°æˆåŠŸ');
                    cancelGuestEdit();
                } else {
                    await window.adminConfig.addGuestAccount(username, password, selectedGroups, selectedPagePermissions);
                    showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿæ–°å¢æˆåŠŸ');
                }
                
                guestAccountForm.reset();
                document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
                loadGuestAccountsTable();
            } catch (error) {
                showAdminFeedback('guest-account-feedback', error.message, true);
            }
        });

        // å–æ¶ˆç·¨è¼¯
        cancelGuestEditBtn.addEventListener('click', cancelGuestEdit);

        function cancelGuestEdit() {
            delete guestAccountForm.dataset.editingId;
            guestAccountForm.reset();
            document.querySelectorAll('.group-permission-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            cancelGuestEditBtn.classList.add('hidden');
            guestAccountForm.querySelector('button[type="submit"]').textContent = 'æ–°å¢è¨ªå®¢';
        }

        // è¨ªå®¢å¸³è™Ÿè¡¨æ ¼äº‹ä»¶
        guestAccountsTable.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-guest-btn');
            const deleteBtn = e.target.closest('.delete-guest-btn');

            if (editBtn) {
                const guestId = editBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest) {
                    // å¡«å…¥ç·¨è¼¯è¡¨å–®
                    document.getElementById('guest-username').value = guest.username;
                    document.getElementById('guest-password').value = guest.password;
                    
                    // è¨­å®šç¾¤çµ„æ¬Šé™
                    document.querySelectorAll('.group-permission-checkbox').forEach(cb => {
                        cb.checked = guest.allowedGroups.includes(cb.value);
                    });
                    
                    // è¨­å®šé é¢æ¬Šé™
                    document.querySelectorAll('.page-permission-checkbox').forEach(cb => {
                        cb.checked = (guest.pagePermissions || []).includes(cb.value);
                    });
                    
                    // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
                    guestAccountForm.dataset.editingId = guestId;
                    cancelGuestEditBtn.classList.remove('hidden');
                    guestAccountForm.querySelector('button[type="submit"]').textContent = 'æ›´æ–°è¨ªå®¢';
                }
            } else if (deleteBtn) {
                const guestId = deleteBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest && confirm(`ç¢ºå®šè¦åˆªé™¤è¨ªå®¢å¸³è™Ÿã€Œ${guest.username}ã€å—ï¼Ÿ`)) {
                    try {
                        await window.adminConfig.deleteGuestAccount(guestId);
                        loadGuestAccountsTable();
                        showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿå·²åˆªé™¤');
                    } catch (error) {
                        showAdminFeedback('guest-account-feedback', error.message, true);
                    }
                }
            }
        });

        // ç³»çµ±å·¥å…·äº‹ä»¶
        exportConfigBtn.addEventListener('click', () => {
            const config = window.adminConfig.exportConfig();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        importConfigBtn.addEventListener('click', () => {
            configFileInput.click();
        });

        configFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await window.adminConfig.importConfig(e.target.result);
                        alert('è¨­å®šåŒ¯å…¥æˆåŠŸ');
                        loadAdminInterface();
                    } catch (error) {
                        alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        resetConfigBtn.addEventListener('click', async () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šå—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰è¨ªå®¢å¸³è™Ÿä¸¦æ¢å¾©é è¨­ç®¡ç†å“¡å¯†ç¢¼ã€‚')) {
                await window.adminConfig.resetToDefault();
                alert('ç³»çµ±å·²é‡ç½®ç‚ºé è¨­è¨­å®š');
                loadAdminInterface();
            }
        });

        groupListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.group-card-main');
            const renameBtn = e.target.closest('.rename-group-btn');
            const deleteBtn = e.target.closest('.delete-group-btn');

            if (mainCard) {
                const groupId = mainCard.dataset.groupId;
                const groupName = mainCard.dataset.groupName;
                showStoreSelectionPage(groupId, groupName);
            } else if (renameBtn) {
                const groupId = renameBtn.dataset.groupId;
                const groupName = renameBtn.dataset.groupName;
                handleRenameGroup(groupId, groupName);
            } else if (deleteBtn) {
                const groupId = deleteBtn.dataset.groupId;
                const groupName = deleteBtn.dataset.groupName;
                handleDeleteGroup(groupId, groupName);
            }
        });

        storeListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.store-card-main');
            const editBtn = e.target.closest('.edit-store-btn');
            const deleteBtn = e.target.closest('.delete-store-btn');

            if (mainCard) {
                const storeId = mainCard.dataset.storeId;
                const storeName = mainCard.dataset.storeName;
                const startDate = mainCard.dataset.startDate;
                showReportPage(storeId, storeName, startDate);
            } else if (editBtn) {
                document.getElementById('edit-store-id').value = editBtn.dataset.storeId;
                document.getElementById('edit-store-name').value = editBtn.dataset.storeName;
                document.getElementById('edit-store-start-date').value = editBtn.dataset.startDate;
                editStoreModal.classList.remove('hidden');
            } else if (deleteBtn) {
                const storeId = deleteBtn.dataset.storeId;
                const storeName = deleteBtn.dataset.storeName;
                handleDeleteStore(storeId, storeName);
            }
        });
        
        selectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = true);
        });

        deselectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = false);
        });

        createGroupForm.addEventListener('submit', handleCreateGroup);
        createStoreForm.addEventListener('submit', handleCreateStore);
        editStoreForm.addEventListener('submit', handleUpdateStore);
        editStoreCancelBtn.addEventListener('click', () => editStoreModal.classList.add('hidden'));

        addMachineForm.addEventListener('submit', handleAddMachine);
        downloadAllStoresBtn.addEventListener('click', handleDownloadAllStoresReport);
        trendChartDatePicker.addEventListener('change', renderTrendChartByDate);

        locationPresets.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-tag')) {
                document.getElementById('new-machine-location').value = e.target.textContent;
            }
        });

        reportPeriodSelector.addEventListener('change', () => {
            if (reportPeriodSelector.value === 'all') {
                reportDatePicker.classList.add('hidden');
            } else {
                reportDatePicker.classList.remove('hidden');
                if (!reportDatePicker.value) {
                    reportDatePicker.valueAsDate = new Date();
                }
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
        });
        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        
        machineListTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-machine-btn')) {
                handleDeleteMachine(e.target.dataset.docId);
            } else if (e.target.classList.contains('edit-machine-btn')) {
                const btn = e.target;
                document.getElementById('edit-machine-doc-id').value = btn.dataset.docId;
                document.getElementById('edit-machine-id').value = btn.dataset.id;
                document.getElementById('edit-machine-location').value = btn.dataset.location;
                document.getElementById('edit-machine-initial-plays').value = btn.dataset.initialPlays;
                document.getElementById('edit-machine-initial-payouts').value = btn.dataset.initialPayouts;
                editMachineModal.classList.remove('hidden');
            }
        });
        editMachineForm.addEventListener('submit', handleUpdateMachine);
        editMachineCancelBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));

        historyTableBody.addEventListener('click', (e) => {
            const button = e.target;
            if (button.classList.contains('delete-history-btn')) {
                handleDeleteHistory(button.dataset.docId, button.dataset.machineId, button.dataset.location, parseInt(button.dataset.plays, 10), parseInt(button.dataset.payouts, 10));
            } else if (button.classList.contains('edit-history-btn')) {
                document.getElementById('edit-history-doc-id').value = button.dataset.docId;
                document.getElementById('edit-history-machine-id').value = button.dataset.machineId;
                document.getElementById('edit-history-location').value = button.dataset.location;
                document.getElementById('edit-history-old-plays').value = button.dataset.plays;
                document.getElementById('edit-history-old-payouts').value = button.dataset.payouts;
                document.getElementById('edit-history-plays').value = button.dataset.plays;
                document.getElementById('edit-history-payouts').value = button.dataset.payouts;
                editHistoryModal.classList.remove('hidden');
            }
        });
        editHistoryForm.addEventListener('submit', handleUpdateHistory);
        editHistoryCancelBtn.addEventListener('click', () => editHistoryModal.classList.add('hidden'));
        
        backToGroupsBtn.addEventListener('click', showGroupSelectionPage);
        backToStoresBtn.addEventListener('click', () => showStoreSelectionPage(selectedGroupId, selectedGroupName));

        allTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                const activeContent = document.getElementById(tab.dataset.tab);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                if (tab.dataset.tab === 'charts') { renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
                if (tab.dataset.tab === 'summary') { renderSummaryTab(); }
                if (tab.dataset.tab === 'analysis') { renderAnalysisTab(); }
                 if (tab.dataset.tab === 'checkout') { 
                    headerDownloadButtons.classList.add('hidden');
                    renderCheckoutTab(); 
                } else {
                    headerDownloadButtons.classList.remove('hidden');
                }
            });
        });

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        summaryControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                summaryControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderSummaryTab();
            }
        });
        
        psdControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const customRange = document.getElementById('psd-custom-range');
                if(e.target.dataset.period === 'custom'){
                    customRange.classList.remove('hidden');
                    customRange.classList.add('flex');
                } else {
                    customRange.classList.add('hidden');
                    customRange.classList.remove('flex');
                    e.target.classList.add('active');
                    renderAnalysisTab();
                }
            }
        });

        psdCalculateBtn.addEventListener('click', () => {
            const start = psdStartDate.value;
            const end = psdEndDate.value;
            if (start && end && start <= end) {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                renderAnalysisTab({start, end});
            } else {
                alert('è«‹é¸æ“‡æœ‰æ•ˆçš„èµ·è¨–æ—¥æœŸï¼');
            }
        });


        document.getElementById('machine-selector').addEventListener('change', (e) => {
            const selectedDocId = e.target.value;
            if(!selectedDocId) return;

            const selectedMachine = appData.machines.find(m => m.docId === selectedDocId);
            if (selectedMachine) {
                document.getElementById('cumulative-plays').value = selectedMachine.plays;
                document.getElementById('cumulative-payouts').value = selectedMachine.payouts;
                document.getElementById('cumulative-plays').focus();
            }
        });
        
        document.getElementById('daily-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedStoreId) {
                return showFeedback('éŒ¯èª¤ï¼šæœªé¸æ“‡ä»»ä½•é–€å¸‚ã€‚', true);
            }
            
            const date = document.getElementById('entry-date').value;
            const selectedOption = document.getElementById('machine-selector').selectedOptions[0];
            const machineDocId = selectedOption.value;

            if (!machineDocId) {
                 return showFeedback('éŒ¯èª¤ï¼šè«‹é¸æ“‡ä¸€å°æ©Ÿå°ã€‚', true);
            }

            const selectedMachine = appData.machines.find(m => m.docId === machineDocId);

            const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
            const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

            if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                return showFeedback('éŒ¯èª¤ï¼šè«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚', true);
            }

            if (!selectedMachine) { return showFeedback('éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥æ‰€é¸æ©Ÿå°ã€‚', true); }
            if (cumulativePlaysInput < selectedMachine.plays || cumulativePayoutsInput < selectedMachine.payouts) {
                return showFeedback('éŒ¯èª¤ï¼šè¼¸å…¥çš„ç´¯ç©æ•¸å€¼å°æ–¼ä¸Šæ¬¡ç´€éŒ„ï¼Œè«‹ç¢ºèªæŠ„è¡¨æ•¸å€¼æ˜¯å¦æ­£ç¢ºã€‚', true);
            }
             if (cumulativePlaysInput < (selectedMachine.initialPlays || 0) || cumulativePayoutsInput < (selectedMachine.initialPayouts || 0)) {
                return showFeedback(`éŒ¯èª¤ï¼šæŠ„è¡¨æ•¸å€¼ä¸å¯å°æ–¼æ­¤æ©Ÿå°çš„èµ·å§‹å€¼ (æŠ•å¹£: ${selectedMachine.initialPlays || 0}, å‡ºè²¨: ${selectedMachine.initialPayouts || 0})ã€‚`, true);
            }


            const dailyPlays = cumulativePlaysInput - selectedMachine.plays;
            const dailyPayouts = cumulativePayoutsInput - selectedMachine.payouts;
            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('æ•¸æ“šæœªè®Šæ›´ï¼Œç„¡éœ€æ–°å¢ç´€éŒ„ã€‚');
            }

            try {
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });
                
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').add({
                    date: date,
                    machineId: selectedMachine.id,
                    location: selectedMachine.location,
                    newPlays: dailyPlays,
                    newPayouts: dailyPayouts
                });
                
                await loadStoreData(); 
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const successMessage = `ç´€éŒ„å·²åŒæ­¥è‡³ [${selectedStoreName}]ï¼æœ¬æ—¥ ${selectedMachine.id} æ–°å¢ï¼š<strong class="text-white">${dailyPlays}</strong> æŠ•å¹£ã€<strong class="text-white">${dailyPayouts}</strong> å‡ºè²¨ã€‚`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("å¯«å…¥ Firestore æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                showFeedback("ç„¡æ³•å°‡ç´€éŒ„åŒæ­¥è‡³é›²ç«¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
            }
        });
        
        searchInput.addEventListener('input', () => updateUI());
        sortableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    if(h !== header) h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? 'â–²' : 'â–¼';
                updateUI();
            });
        });
        
        recalculateAllBtn.addEventListener('click', async () => {
            if (!selectedStoreId) return;

            pdfLoaderText.textContent = 'æ­£åœ¨é‡æ–°æ•´ç†èˆ‡è¨ˆç®—æ‰€æœ‰æ•¸æ“š...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                await loadStoreData(); // This function already re-fetches and calls updateUI()
                showFeedback("æ‰€æœ‰æ•¸æ“šå·²æˆåŠŸé‡æ–°è¨ˆç®—ä¸¦æ›´æ–°ï¼", false);
            } catch (error) {
                console.error("é‡æ–°è¨ˆç®—å¤±æ•—:", error);
                showFeedback("æ•¸æ“šæ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        downloadPdfBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active');
            if (!activeTab) return;

            const tabId = activeTab.dataset.tab;
            const tabName = activeTab.textContent;

            if (tabId === 'accounting' || tabId === 'machines' || tabId === 'checkout') {
                alert('æ­¤é é¢ä¸æ”¯æ´ PDF åŒ¯å‡ºã€‚è«‹é¸æ“‡ä¸€å€‹å ±è¡¨é ç±¤ã€‚');
                return;
            }

            pdfLoaderText.textContent = `æ­£åœ¨ç”Ÿæˆã€Œ${tabName}ã€å ±è¡¨...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById(tabId);
                const originalScrollTop = content.scrollTop;
                content.scrollTop = 0; // Ensure we capture from the top

                const canvas = await html2canvas(content, {
                    backgroundColor: '#1f2937',
                    scale: 2,
                    useCORS: true,
                    windowHeight: content.scrollHeight
                });
                content.scrollTop = originalScrollTop; // Restore scroll

                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const margin = 10;

                const imgProps = doc.getImageProperties(imgData);
                const imgWidth = pdfWidth - margin * 2;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 30);

                while (heightLeft > 0) {
                    doc.addPage();
                    position -= (pdfHeight - 30);
                    doc.addImage(imgData, 'PNG', margin, position + 20, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 30);
                }

                for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                    doc.setPage(i);
                    doc.setFontSize(14);
                    doc.setTextColor(150);
                    doc.text(selectedStoreName, margin, 15);
                    doc.setFontSize(10);
                    doc.text(`å ±è¡¨ç”Ÿæˆæ—¥æœŸ: ${new Date().toLocaleDateString()}`, pdfWidth - margin, 15, { align: 'right' });
                    doc.setFontSize(8);
                    doc.text(`ç¬¬ ${i} é  / å…± ${doc.internal.getNumberOfPages()} é `, pdfWidth / 2, pdfHeight - margin, { align: 'center' });
                }
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                doc.save(`${selectedStoreName}-${tabName}-å ±å‘Š-${dateString}.pdf`);

            } catch (error) {
                console.error("PDF ç”Ÿæˆå¤±æ•—:", error);
                alert("ç”Ÿæˆ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            if (!selectedStoreId) {
                showFeedback("è«‹å…ˆé¸æ“‡é–€å¸‚å†ä¸‹è¼‰å ±å‘Šã€‚", true);
                return;
            }

            try {
                const processedMachines = appData.machines.map(processMachineData);
                const summaryData = getAggregatedSummaryData('all');

                if (processedMachines.length === 0 && appData.history.length === 0) {
                    showFeedback("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›ä¸‹è¼‰ã€‚è«‹å…ˆæ–°å¢æ©Ÿå°ä¸¦è¨˜éŒ„æ•¸æ“šã€‚", true);
                    return;
                }
                
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                const btn = document.getElementById('download-report-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>ç”¢ç”Ÿä¸­...</span>
                `;
                btn.disabled = true;
                
                // å»¶é²åŸ·è¡Œä»¥å…è¨±UIæ›´æ–°
                setTimeout(() => {
                    try {
                        const csvRows = [];
                        let csvContent = "\uFEFF";

                        csvRows.push(`å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š - ${selectedStoreName}`);
                        csvRows.push(`å ±å‘Šç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`);
                        csvRows.push(`çµ±è¨ˆæœŸé–“ï¼š${appData.startDate} ï½ ç¾åœ¨`);
                        
                        // Section 1: æ©Ÿå°ç‡Ÿæ¥­æ˜ç´° (ç¸½è¦½)
                        csvRows.push("");
                        csvRows.push("æ©Ÿå°ç‡Ÿæ¥­æ˜ç´° (ç¸½è¦½)");
                        const detailsHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç‡Ÿæ¥­æŠ•å¹£æ¬¡æ•¸", "ç‡Ÿæ¥­æŠ•å¹£é‡‘é¡", "ç‡Ÿæ¥­å‡ºè²¨æ•¸é‡", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                        csvRows.push(detailsHeaders.join(","));
                        processedMachines.forEach(item => {
                            csvRows.push([item.id, `"${item.location}"`, item.effectivePlays, item.revenue, item.effectivePayouts, item.cost.toFixed(2)].join(","));
                        });

                        // Section 2: å„æ©Ÿå°ç‡Ÿé‹ç‹€æ³ - ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨
                        if (summaryData.length > 0) {
                            csvRows.push("");
                            csvRows.push("å„æ©Ÿå°ç‡Ÿé‹ç‹€æ³ - ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨");
                            const summaryTableHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ç¸½æŠ•å¹£é‡‘é¡", "ç¸½å‡ºè²¨æ•¸é‡", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                            csvRows.push(summaryTableHeaders.join(","));
                            summaryData.forEach(item => {
                                csvRows.push([
                                    item.id,
                                    item.revenue,
                                    item.payouts,
                                    item.cost.toFixed(2)
                                ].join(","));
                            });
                        }
                        

                        // Section 3: æ¯æ—¥è¨˜å¸³æ˜ç´°
                        if (appData.history.length > 0) {
                            csvRows.push("");
                            csvRows.push("æ¯æ—¥è¨˜å¸³æ˜ç´°");
                            const historyHeaders = ["æ—¥æœŸ", "æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç•¶æ—¥æŠ•å¹£æ•¸", "ç•¶æ—¥å‡ºè²¨æ•¸"];
                            csvRows.push(historyHeaders.join(","));
                            const sortedHistory = [...appData.history].sort((a, b) => b.date.localeCompare(a.date));
                            sortedHistory.forEach(item => {
                                csvRows.push([item.date, item.machineId, `"${item.location}"`, item.newPlays, item.newPayouts].join(","));
                            });
                        }

                        // Section 4: åœ–è¡¨åˆ†æåŸå§‹æ•¸æ“š
                        if (processedMachines.length > 0) {
                            csvRows.push("");
                            csvRows.push("åœ–è¡¨åˆ†æåŸå§‹æ•¸æ“š");
                            csvRows.push("å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ");
                            csvRows.push(["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç¸½ç‡Ÿæ”¶(å…ƒ)"].join(","));
                            [...processedMachines].sort((a, b) => b.revenue - a.revenue).forEach(item => {
                                csvRows.push([item.id, `"${item.location}"`, item.revenue].join(","));
                            });
                            csvRows.push("");
                            csvRows.push("å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬");
                            csvRows.push(["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"].join(","));
                            [...processedMachines].sort((a, b) => b.cost - a.cost).forEach(item => {
                                csvRows.push([item.id, `"${item.location}"`, item.cost.toFixed(2)].join(","));
                            });
                        }

                        csvContent += csvRows.join("\n");
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.setAttribute("href", url);
                        const today = new Date();
                        const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                        link.setAttribute("download", `${selectedStoreName}-å…¨æ–¹ä½å ±å‘Š-${dateString}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        showFeedback("å ±å‘Šä¸‹è¼‰æˆåŠŸï¼", false);
                        
                    } catch (error) {
                        console.error('ä¸‹è¼‰å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        showFeedback("ä¸‹è¼‰å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
                    } finally {
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }, 100);
                
            } catch (error) {
                console.error('æº–å‚™ä¸‹è¼‰å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showFeedback("æº–å‚™ä¸‹è¼‰å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦ã€‚", true);
            }
        });

        performCheckoutBtn.addEventListener('click', handlePerformCheckout);

        // ä¸‹è¼‰çµå¸³å ±è¡¨ CSV
        downloadCheckoutCsvBtn.addEventListener('click', async () => {
            if (!selectedGroupId || !selectedStoreId) {
                alert('è«‹å…ˆé¸æ“‡é–€å¸‚');
                return;
            }

            try {
                const btn = downloadCheckoutCsvBtn;
                const originalText = btn.textContent;
                btn.textContent = 'ç”¢ç”Ÿä¸­...';
                btn.disabled = true;

                // ç²å–çµå¸³æ­·å²
                const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                // ç”Ÿæˆ CSV å…§å®¹
                const csvRows = [];
                csvRows.push('\uFEFF'); // UTF-8 BOM
                csvRows.push(`çµå¸³å ±è¡¨ - ${selectedStoreName}`);
                csvRows.push(`å ±è¡¨ç”¢ç”Ÿæ—¥æœŸ: ${new Date().toLocaleString()}`);
                csvRows.push('');
                
                if (checkouts.length === 0) {
                    csvRows.push('å°šç„¡çµå¸³ç´€éŒ„');
                } else {
                    // è¡¨é ­
                    csvRows.push(['çµå¸³æ—¥æœŸ', 'çµå¸³é‡‘é¡', 'ç´¯ç©ç‡Ÿæ”¶', 'æœŸé–“å¤©æ•¸', 'å¹³å‡æ¯æ—¥ç‡Ÿæ”¶'].join(','));
                    
                    // è³‡æ–™è¡Œ
                    checkouts.forEach((checkout, index) => {
                        const checkoutDate = new Date(checkout.checkoutDate.toDate());
                        const prevCheckoutDate = index < checkouts.length - 1 ? 
                            new Date(checkouts[index + 1].checkoutDate.toDate()) : 
                            new Date(appData.startDate);
                        
                        const daysDiff = Math.ceil((checkoutDate - prevCheckoutDate) / (1000 * 60 * 60 * 24));
                        const avgDailyRevenue = daysDiff > 0 ? checkout.checkoutAmount / daysDiff : 0;
                        
                        csvRows.push([
                            checkoutDate.toLocaleString(),
                            checkout.checkoutAmount,
                            checkout.cumulativeRevenueAtCheckout,
                            daysDiff,
                            avgDailyRevenue.toFixed(2)
                        ].join(','));
                    });

                    // çµ±è¨ˆæ‘˜è¦
                    csvRows.push('');
                    csvRows.push('--- çµ±è¨ˆæ‘˜è¦ ---');
                    const totalCheckouts = checkouts.length;
                    const totalRevenue = checkouts.length > 0 ? checkouts[0].cumulativeRevenueAtCheckout : 0;
                    const avgCheckoutAmount = checkouts.length > 0 ? 
                        checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0) / checkouts.length : 0;
                    
                    csvRows.push(`ç¸½çµå¸³æ¬¡æ•¸,${totalCheckouts}`);
                    csvRows.push(`ç´¯ç©ç¸½ç‡Ÿæ”¶,${totalRevenue} å…ƒ`);
                    csvRows.push(`å¹³å‡çµå¸³é‡‘é¡,${avgCheckoutAmount.toFixed(2)} å…ƒ`);
                }

                // ä¸‹è¼‰ CSV
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute('download', `${selectedStoreName}-çµå¸³å ±è¡¨-${dateString}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('ä¸‹è¼‰çµå¸³å ±è¡¨å¤±æ•—:', error);
                alert('ä¸‹è¼‰å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                
                downloadCheckoutCsvBtn.textContent = 'ä¸‹è¼‰çµå¸³å ±è¡¨ (CSV)';
                downloadCheckoutCsvBtn.disabled = false;
            }
        });

        // --- INITIAL LOAD ---
        // ä¸å†ç›´æ¥è¼‰å…¥ç¾¤çµ„é é¢ï¼Œç”±ç™»å…¥é‚è¼¯æ§åˆ¶
        // showGroupSelectionPage(); 
        
        // é€šçŸ¥ç™»å…¥ç³»çµ±ä¸»æ‡‰ç”¨ç¨‹å¼å·²è¼‰å…¥å®Œæˆ
        window.dispatchEvent(new CustomEvent('appLoaded'));
    });
    </script>
    <script src="admin-config.js"></script>
    <script src="login.js"></script>
</body>
</html>

