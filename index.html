<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式查帳系統 - 娃娃機營業報告 (雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">娃娃機營業報告 (雲端版)</h1>
                    <p class="text-lg text-gray-400" id="report-period">統計期間：2025/10/10 ～ 現在</p>
                </div>
                <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>下載報表 (CSV)</span>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">總投幣次數</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">總投幣金額</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 元</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">總出貨次數</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">平均出貨成本</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 元/次</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">每日記帳</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">圖表分析</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">統計彙整</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">機台營業明細</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">各機台營運概況</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">分析與建議</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                    <h3 class="text-xl font-bold text-white mb-4">新增每日紀錄</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">日期</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">機台位置</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                    </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">累積投幣數 (抄表)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">累積出貨數 (抄表)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">新增紀錄</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-4">記帳歷史紀錄</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">日期</th>
                                    <th class="p-4">機台編號</th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4 text-right">當日投幣數</th>
                                    <th class="p-4 text-right">當日出貨數</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台總營收比較</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台平均出貨成本</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">每日投幣與出貨趨勢</h3>
                        <div id="trend-chart" class="h-80 w-full"></div>
                    </div>
                </div>
                <div id="statistics" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">每日</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">每週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">每月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">每季</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">期間</th>
                                    <th class="p-4 text-right">總投幣次數</th>
                                    <th class="p-4 text-right">總投幣金額</th>
                                    <th class="p-4 text-right">總出貨次數</th>
                                    <th class="p-4 text-right">平均出貨成本</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="依機台編號搜尋...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable" data-sort="id">機台編號 <span class="sort-indicator"></span></th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="plays">累積投幣次數 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">累積投幣金額 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="payouts">累積出貨數量 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">平均出貨成本 <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">營運概況總表</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">機台編號</th>
                                        <th class="p-4 text-right">總投幣金額</th>
                                        <th class="p-4 text-right">總出貨數量</th>
                                        <th class="p-4 text-right">平均出貨成本</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">各機台投幣金額佔比</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>📈 PSD（每日平均銷售表現）</h3>
                    <p>PSD 公式為：總投幣金額 ÷ 統計天數。此數值可作為每日營運基準，用於後續比較週報、月報趨勢。</p>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>計算中...</strong></p>
                    </div>
                    <h3 class="mt-8">🔬 分析與觀察</h3>
                    <ul id="analysis-observation" class="list-disc pl-5 space-y-2"></ul>
                    <h3 class="mt-8">💡 結論建議</h3>
                    <ul id="analysis-suggestion" class="list-disc pl-5 space-y-2"></ul>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">報表建立日期：</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! 請將這裡的設定換成您自己的 Firebase 專案金鑰 !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };

        // Initialize Firebase App and Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase 初始化成功！");
        // --- END: Firebase Initialization ---

        // --- GLOBAL VARIABLES ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '2025-10-10' };
        let currentSort = { key: 'id', direction: 'asc' };

        // --- DATA FUNCTIONS (Firestore Version) ---
        async function loadDataFromFirestore() {
            console.log("正在從 Firestore 讀取資料...");
            const machinesCollection = db.collection('machines');
            const historyCollection = db.collection('history').orderBy('date', 'desc'); // 讓歷史紀錄預設最新
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                const history = historySnapshot.docs.map(doc => doc.data());

                appData.machines = machines;
                appData.history = history;
                
                console.log("資料讀取成功!", appData);
                updateUI(); // 讀取成功後，更新整個頁面

            } catch (error) {
                console.error("從 Firestore 讀取資料時發生錯誤: ", error);
                showFeedback("無法從雲端讀取資料，請檢查網路連線。", true);
            }
        }

        function getSummaryData() {
            const summary = {};
            if (!appData.machines) return [];
            appData.machines.forEach(m => {
                if (!summary[m.id]) {
                    summary[m.id] = { id: m.id, plays: 0, payouts: 0 };
                }
                summary[m.id].plays += m.plays;
                summary[m.id].payouts += m.payouts;
            });
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        // --- UI RENDERING FUNCTIONS ---
        function updateUI() {
            if (!appData || !appData.machines) return;
            const processedMachines = appData.machines.map(m => {
                const revenue = m.plays * COIN_VALUE;
                const cost = m.payouts > 0 ? revenue / m.payouts : 0;
                return { ...m, revenue, cost };
            });
            renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            renderSummaryTab();
            renderAnalysisTab(processedMachines);
            renderAccountingTab();
            renderChartsTab();
            renderStatisticsTab();
            updateFooterAndHeader();
        }
        
        function renderMainStats(data) {
            const totalPlays = data.reduce((sum, m) => sum + m.plays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = data.reduce((sum, m) => sum + m.payouts, 0);
            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;
            document.getElementById('total-plays').textContent = `${totalPlays.toLocaleString()} 次`;
            document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString()} 元`;
            document.getElementById('total-payouts').textContent = `${totalPayouts.toLocaleString()} 次`;
            document.getElementById('avg-cost').textContent = `${avgCost.toFixed(2)} 元/次`;
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            filteredData.sort((a, b) => {
                let valA = a[currentSort.key]; let valB = b[currentSort.key];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">找不到符合條件的資料</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} 元/次</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            machineSelector.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            appData.machines.forEach((m, index) => {
                machineSelector.innerHTML += `<option value="${index}">${m.id} - ${m.location}</option>`;
            });
            document.getElementById('entry-date').valueAsDate = new Date();
            
            const historyTableBody = document.getElementById('history-table-body');
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">尚無記帳紀錄</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr>
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || '未知'}</td>
                        <td class="p-4">${h.location || '未知'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                    </tr>`;
                });
            }
        }
        
        function renderSummaryTab() {
            const summaryData = getSummaryData();
            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';
            summaryData.forEach((s, index) => {
                const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                summaryTableBody.innerHTML += `<tr class="${rowClass}">
                    <td class="p-4 font-medium text-white">${s.id}</td>
                    <td class="p-4 text-right">${s.revenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${s.payouts.toLocaleString()} 次</td>
                    <td class="p-4 text-right">${s.cost.toFixed(2)} 元/次</td>
                </tr>`;
            });
            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red'];
            summaryData.forEach((s, index) => {
                const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                const color = colors[index % colors.length];
                chartContainer.innerHTML += `<div class="w-full">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-${color}-300">${s.id}</span>
                        <span class="text-sm font-medium text-${color}-300">${s.revenue.toLocaleString()} 元 (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>`;
            });
        }

        function renderAnalysisTab(processedMachines) {
            const startDate = new Date(appData.startDate);
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            const totalRevenue = processedMachines.reduce((sum, m) => sum + m.revenue, 0);
            const psd = totalRevenue / diffDays;
            document.getElementById('psd-display').innerHTML = `<strong>${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} 元 / 天</strong> 
                <span class="text-sm text-gray-400">(${totalRevenue.toLocaleString()} 元 ÷ ${diffDays} 天)</span>`;
            
            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].sort((a,b) => b.cost - a.cost);
            const bestPerformer = sortedByRevenue[0] || {id: 'N/A', location: ''};
            const highestCost = sortedByCost[0] || {id: 'N/A', location: ''};
            document.getElementById('analysis-observation').innerHTML = `
                <li><strong>收益冠軍：</strong><span class="font-semibold text-white">${bestPerformer.id} (${bestPerformer.location})</span> 累積營收最高。</li>
                <li><strong>成本最高：</strong><span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> 平均出貨成本最高，建議觀察。</li>
            `;
            document.getElementById('analysis-suggestion').innerHTML = `
                <li>針對 <span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> 檢討難度與獎品設定，以優化成本。</li>
                <li>每週持續追蹤 <span class="font-semibold text-white">PSD 指標變化</span>，可有效掌握營運成長趨勢。</li>
            `;
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        key = new Date(d.setDate(diff)).toISOString().split('T')[0];
                        break;
                    case 'monthly': key = curr.date.substring(0, 7); break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        break;
                    default: key = curr.date; // daily
                }
                if (!acc[key]) {
                    acc[key] = { period: key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            const data = getAggregatedData(period);
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            if(data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">尚無歷史紀錄可供彙整</td></tr>`;
                return;
            }
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.period}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} 元/次</td>
                </tr>`;
            });
        }
        
        function renderChartsTab() { /* ... Chart rendering logic ... */ }
        function updateFooterAndHeader() { /* ... Footer rendering logic ... */ }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        // --- EVENT LISTENERS ---
        allTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.style.display = content.id === tab.dataset.tab ? 'block' : 'none';
                });
                if (tab.dataset.tab === 'charts') { renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
            });
        });
        document.querySelector('.tab-btn[data-tab="accounting"]').click();

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        document.getElementById('daily-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('entry-date').value;
            const machineIndex = parseInt(document.getElementById('machine-selector').value);
            const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
            const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

            if (isNaN(machineIndex) || isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                return showFeedback('錯誤：請填寫所有欄位。', true);
            }

            const selectedMachine = appData.machines[machineIndex];
            const machineDocId = selectedMachine.docId;

            if (cumulativePlaysInput < selectedMachine.plays || cumulativePayoutsInput < selectedMachine.payouts) {
                return showFeedback('錯誤：輸入的累積數值小於上次紀錄，請確認抄表數值是否正確。', true);
            }

            const dailyPlays = cumulativePlaysInput - selectedMachine.plays;
            const dailyPayouts = cumulativePayoutsInput - selectedMachine.payouts;

            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('數據未變更，無需新增紀錄。');
            }

            try {
                const machineRef = db.collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });

                await db.collection('history').add({
                    date: date,
                    machineId: selectedMachine.id,
                    location: selectedMachine.location,
                    newPlays: dailyPlays,
                    newPayouts: dailyPayouts
                });

                await loadDataFromFirestore(); // Reload data after successful write
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const successMessage = `紀錄已雲端同步！本日 ${selectedMachine.id} (${selectedMachine.location}) 新增：<strong class="text-white">${dailyPlays}</strong> 投幣、<strong class="text-white">${dailyPayouts}</strong> 出貨。`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("寫入 Firestore 時發生錯誤: ", error);
                showFeedback("無法將紀錄同步至雲端，請稍後再試。", true);
            }
        });

        searchInput.addEventListener('input', () => updateUI());
        sortableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? '▲' : '▼';
                updateUI();
            });
        });
        document.getElementById('download-report-btn').addEventListener('click', () => { /* Download logic */ });

        // --- INITIAL LOAD ---
        loadDataFromFirestore();
    });
    </script>
</body>
</html>