<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æŸ¥å¸³ç³»çµ± - å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light gray text */
        }
        .tab-btn.active {
            border-bottom: 2px solid #3b82f6;
            color: white;
            background-color: #1f2937;
        }
        .tab-btn {
            border-bottom: 2px solid transparent;
        }
        .stats-period-btn {
            transition: all 0.2s;
        }
        .stats-period-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .table-header-sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .table-header-sortable:hover {
            background-color: #374151;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 8px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .table-header-sortable.sorted .sort-indicator {
            opacity: 1;
        }
        input, select {
            color-scheme: dark;
        }
        .chart-container {
            background-color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
        }
        .chart-bar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š</h1>
                    <p class="text-lg text-gray-400" id="report-period">çµ±è¨ˆæœŸé–“ï¼š2025/10/10 ï½ ç¾åœ¨</p>
                </div>
                <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>ä¸‹è¼‰å ±è¡¨ (CSV)</span>
                </button>
            </div>
        </header>

        <!-- Main Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£é‡‘é¡</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 å…ƒ</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½å‡ºè²¨æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">å¹³å‡å‡ºè²¨æˆæœ¬</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 å…ƒ/æ¬¡</p>
                </div>
            </div>
        </div>

        <!-- Tabs Container -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <!-- Tab Buttons -->
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">æ¯æ—¥è¨˜å¸³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">åœ–è¡¨åˆ†æ</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">çµ±è¨ˆå½™æ•´</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">æ©Ÿå°ç‡Ÿæ¥­æ˜ç´°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">å„æ©Ÿå°ç‡Ÿé‹æ¦‚æ³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">åˆ†æèˆ‡å»ºè­°</button>
            </div>

            <!-- Tab Content -->
            <div>
                <!-- Tab: Daily Accounting -->
                <div id="accounting" class="tab-content">
                    <h3 class="text-xl font-bold text-white mb-4">æ–°å¢æ¯æ—¥ç´€éŒ„</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ä½ç½®</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                    <!-- JS will populate this -->
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©æŠ•å¹£æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©å‡ºè²¨æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢ç´€éŒ„</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-4">è¨˜å¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ</th>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">ç•¶æ—¥æŠ•å¹£æ•¸</th>
                                    <th class="p-4 text-right">ç•¶æ—¥å‡ºè²¨æ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Chart Analysis -->
                <div id="charts" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">æ¯æ—¥æŠ•å¹£èˆ‡å‡ºè²¨è¶¨å‹¢</h3>
                        <div id="trend-chart" class="h-80 w-full"></div>
                    </div>
                </div>

                <!-- Tab: Statistics -->
                <div id="statistics" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">æ¯æ—¥</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æ¯é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æ¯æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æ¯å­£</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">æœŸé–“</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                    <th class="p-4 text-right">ç¸½å‡ºè²¨æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Detailed Breakdown -->
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾æ©Ÿå°ç·¨è™Ÿæœå°‹...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable" data-sort="id">æ©Ÿå°ç·¨è™Ÿ <span class="sort-indicator"></span></th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="plays">ç´¯ç©æŠ•å¹£æ¬¡æ•¸ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">ç´¯ç©æŠ•å¹£é‡‘é¡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="payouts">ç´¯ç©å‡ºè²¨æ•¸é‡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">å¹³å‡å‡ºè²¨æˆæœ¬ <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Machine Summary -->
                <div id="summary" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                        <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                        <th class="p-4 text-right">ç¸½å‡ºè²¨æ•¸é‡</th>
                                        <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°æŠ•å¹£é‡‘é¡ä½”æ¯”</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Analysis & Suggestions -->
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>ğŸ“ˆ PSDï¼ˆæ¯æ—¥å¹³å‡éŠ·å”®è¡¨ç¾ï¼‰</h3>
                    <p>PSD å…¬å¼ç‚ºï¼šç¸½æŠ•å¹£é‡‘é¡ Ã· çµ±è¨ˆå¤©æ•¸ã€‚æ­¤æ•¸å€¼å¯ä½œç‚ºæ¯æ—¥ç‡Ÿé‹åŸºæº–ï¼Œç”¨æ–¼å¾ŒçºŒæ¯”è¼ƒé€±å ±ã€æœˆå ±è¶¨å‹¢ã€‚</p>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>è¨ˆç®—ä¸­...</strong></p>
                    </div>

                    <h3 class="mt-8">ğŸ”¬ åˆ†æèˆ‡è§€å¯Ÿ</h3>
                    <ul id="analysis-observation" class="list-disc pl-5 space-y-2"></ul>

                    <h3 class="mt-8">ğŸ’¡ çµè«–å»ºè­°</h3>
                    <ul id="analysis-suggestion" class="list-disc pl-5 space-y-2"></ul>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">å ±è¡¨å»ºç«‹æ—¥æœŸï¼š</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATA INITIALIZATION ---
    const COIN_VALUE = 10;
    const APP_DATA_KEY = 'clawMachineReportData';
    let appData;
    let currentSort = { key: 'id', direction: 'asc' };

    function getInitialData() {
        const initialMachines = [
            { id: 'A013', location: 'ä¸Š / å·¦', plays: 128, payouts: 21 },
            { id: 'A013', location: 'ä¸Š / å³', plays: 170, payouts: 15 },
            { id: 'A011', location: 'ä¸‹ / å·¦', plays: 158, payouts: 18 },
            { id: 'A011', location: 'ä¸‹ / å³', plays: 129, payouts: 21 },
            { id: 'A012', location: 'ä¸Š / å·¦', plays: 199, payouts: 15 },
            { id: 'A012', location: 'ä¸Š / å³', plays: 109, payouts: 14 },
            { id: 'A011', location: 'ä¸Š / å·¦', plays: 96, payouts: 11 },
            { id: 'A011', location: 'ä¸Š / å³', plays: 122, payouts: 14 },
            { id: 'A012', location: 'ä¸‹ / å·¦', plays: 144, payouts: 6 },
            { id: 'A012', location: 'ä¸‹ / å³', plays: 174, payouts: 14 },
            { id: 'A013', location: 'ä¸‹ / å·¦', plays: 159, payouts: 19 },
            { id: 'A013', location: 'ä¸‹ / å³', plays: 132, payouts: 19 }
        ];

        // è‡ªå‹•ç”Ÿæˆèˆ‡åˆå§‹ç¸½æ•¸å°æ‡‰çš„æ­·å²ç´€éŒ„
        const generatedHistory = [];
        const days = 5;
        const startDate = new Date('2025-10-10');

        initialMachines.forEach((machine, index) => {
            const dailyPlays = Math.floor(machine.plays / days);
            const dailyPayouts = Math.floor(machine.payouts / days);
            const remainderPlays = machine.plays % days;
            const remainderPayouts = machine.payouts % days;
            
            for (let i = 0; i < days; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                const newPlays = dailyPlays + (i === days - 1 ? remainderPlays : 0);
                const newPayouts = dailyPayouts + (i === days - 1 ? remainderPayouts : 0);
                
                if (newPlays > 0 || newPayouts > 0) {
                    generatedHistory.push({
                        date: dateStr,
                        machineIndex: index,
                        newPlays: newPlays,
                        newPayouts: newPayouts
                    });
                }
            }
        });

        return {
            startDate: '2025-10-10',
            machines: initialMachines,
            history: generatedHistory
        };
    }
    
    function loadData() {
        const savedData = localStorage.getItem(APP_DATA_KEY);
        appData = savedData ? JSON.parse(savedData) : getInitialData();
    }

    function saveData() {
        localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
    }

    // --- HELPER & DATA FUNCTIONS ---
    function getSummaryData() {
        const summary = {};
        appData.machines.forEach(m => {
            if (!summary[m.id]) {
                summary[m.id] = { id: m.id, plays: 0, payouts: 0 };
            }
            summary[m.id].plays += m.plays;
            summary[m.id].payouts += m.payouts;
        });

        return Object.values(summary).map(s => {
            const revenue = s.plays * COIN_VALUE;
            const cost = s.payouts > 0 ? revenue / s.payouts : 0;
            return { ...s, revenue, cost };
        });
    }

    function downloadCSV() {
        const summaryData = getSummaryData();
        const detailedData = appData.machines.map(m => {
            const revenue = m.plays * COIN_VALUE;
            const cost = m.payouts > 0 ? revenue / m.payouts : 0;
            return { ...m, revenue, cost };
        });

        // ä½¿ç”¨ BOM ä¾†ç¢ºä¿ Excel èƒ½æ­£ç¢ºè®€å– UTF-8 ç·¨ç¢¼çš„ä¸­æ–‡
        let csvContent = '\uFEFF';

        csvContent += 'å„æ©Ÿå°ç‡Ÿé‹æ¦‚æ³\r\n';
        csvContent += 'æ©Ÿå°ç·¨è™Ÿ,ç¸½æŠ•å¹£é‡‘é¡ (å…ƒ),ç¸½å‡ºè²¨æ•¸é‡,å¹³å‡å‡ºè²¨æˆæœ¬ (å…ƒ/æ¬¡)\r\n';
        summaryData.forEach(item => {
            const row = [
                item.id,
                item.revenue,
                item.payouts,
                item.cost.toFixed(2)
            ].join(',');
            csvContent += row + '\r\n';
        });

        csvContent += '\r\n\r\n';

        csvContent += 'æ©Ÿå°ç‡Ÿæ¥­æ˜ç´°\r\n';
        csvContent += 'æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,ç´¯ç©æŠ•å¹£æ¬¡æ•¸,ç´¯ç©æŠ•å¹£é‡‘é¡ (å…ƒ),ç´¯ç©å‡ºè²¨æ•¸é‡,å¹³å‡å‡ºè²¨æˆæœ¬ (å…ƒ/æ¬¡)\r\n';
        detailedData.forEach(item => {
            // å°‡åŒ…å«ç©ºæ ¼çš„ä½ç½®è³‡è¨Šç”¨å¼•è™ŸåŒ…èµ·ä¾†
            const row = [
                item.id,
                `"${item.location.trim()}"`,
                item.plays,
                item.revenue,
                item.payouts,
                item.cost.toFixed(2)
            ].join(',');
            csvContent += row + '\r\n';
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    // --- DOM ELEMENTS ---
    const allTabs = document.querySelectorAll('.tab-btn');
    const allTabContents = document.querySelectorAll('.tab-content');
    const searchInput = document.getElementById('searchInput');
    const sortableHeaders = document.querySelectorAll('.table-header-sortable');
    const statsControls = document.getElementById('stats-controls');

    // --- UI RENDERING FUNCTIONS ---
    function updateUI() {
        const processedMachines = appData.machines.map(m => {
            const revenue = m.plays * COIN_VALUE;
            const cost = m.payouts > 0 ? revenue / m.payouts : 0;
            return { ...m, revenue, cost };
        });

        renderMainStats(processedMachines);
        renderDetailsTable(processedMachines);
        renderSummaryTab();
        renderAnalysisTab(processedMachines);
        renderAccountingTab();
        renderChartsTab();
        renderStatisticsTab();
        updateFooterAndHeader();
    }
    
    function renderMainStats(data) {
        const totalPlays = data.reduce((sum, m) => sum + m.plays, 0);
        const totalRevenue = totalPlays * COIN_VALUE;
        const totalPayouts = data.reduce((sum, m) => sum + m.payouts, 0);
        const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

        document.getElementById('total-plays').textContent = `${totalPlays.toLocaleString()} æ¬¡`;
        document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString()} å…ƒ`;
        document.getElementById('total-payouts').textContent = `${totalPayouts.toLocaleString()} æ¬¡`;
        document.getElementById('avg-cost').textContent = `${avgCost.toFixed(2)} å…ƒ/æ¬¡`;
    }

    function renderDetailsTable(data) {
        const tableBody = document.getElementById('details-table-body');
        const searchTerm = searchInput.value.toLowerCase();
        let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
        filteredData.sort((a, b) => {
            let valA = a[currentSort.key]; let valB = b[currentSort.key];
            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        tableBody.innerHTML = '';
        if (filteredData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
            return;
        }
        filteredData.forEach(item => {
            const row = `<tr class="hover:bg-gray-700/50 transition">
                <td class="p-4 font-medium text-white">${item.id}</td>
                <td class="p-4">${item.location}</td>
                <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    function renderSummaryTab() {
        const summaryData = getSummaryData();
        const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);

        const summaryTableBody = document.getElementById('summary-table-body');
        summaryTableBody.innerHTML = '';
        summaryData.forEach((s, index) => {
            const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
            summaryTableBody.innerHTML += `<tr class="${rowClass}">
                <td class="p-4 font-medium text-white">${s.id}</td>
                <td class="p-4 text-right">${s.revenue.toLocaleString()} å…ƒ</td>
                <td class="p-4 text-right">${s.payouts.toLocaleString()} æ¬¡</td>
                <td class="p-4 text-right">${s.cost.toFixed(2)} å…ƒ/æ¬¡</td>
            </tr>`;
        });
        
        const chartContainer = document.getElementById('summary-chart-container');
        chartContainer.innerHTML = '';
        const colors = ['blue', 'green', 'purple', 'yellow', 'red'];
        summaryData.forEach((s, index) => {
            const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
            const color = colors[index % colors.length];
            chartContainer.innerHTML += `<div class="w-full">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-${color}-300">${s.id}</span>
                    <span class="text-sm font-medium text-${color}-300">${s.revenue.toLocaleString()} å…ƒ (${percentage}%)</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                    <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                </div>
            </div>`;
        });
    }

    function renderAnalysisTab(processedMachines) {
        const startDate = new Date(appData.startDate);
        const today = new Date();
        const diffTime = Math.abs(today - startDate);
        const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        const totalRevenue = processedMachines.reduce((sum, m) => sum + m.revenue, 0);
        const psd = totalRevenue / diffDays;
        document.getElementById('psd-display').innerHTML = `<strong>${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} å…ƒ / å¤©</strong> 
            <span class="text-sm text-gray-400">(${totalRevenue.toLocaleString()} å…ƒ Ã· ${diffDays} å¤©)</span>`;
        
        const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
        const sortedByCost = [...processedMachines].sort((a,b) => b.cost - a.cost);
        const bestPerformer = sortedByRevenue[0] || {id: 'N/A', location: ''};
        const highestCost = sortedByCost[0] || {id: 'N/A', location: ''};

        document.getElementById('analysis-observation').innerHTML = `
            <li><strong>æ”¶ç›Šå† è»ï¼š</strong><span class="font-semibold text-white">${bestPerformer.id} (${bestPerformer.location})</span> ç´¯ç©ç‡Ÿæ”¶æœ€é«˜ã€‚</li>
            <li><strong>æˆæœ¬æœ€é«˜ï¼š</strong><span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> å¹³å‡å‡ºè²¨æˆæœ¬æœ€é«˜ï¼Œå»ºè­°è§€å¯Ÿã€‚</li>
        `;
        document.getElementById('analysis-suggestion').innerHTML = `
            <li>é‡å° <span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> æª¢è¨é›£åº¦èˆ‡çå“è¨­å®šï¼Œä»¥å„ªåŒ–æˆæœ¬ã€‚</li>
            <li>æ¯é€±æŒçºŒè¿½è¹¤ <span class="font-semibold text-white">PSD æŒ‡æ¨™è®ŠåŒ–</span>ï¼Œå¯æœ‰æ•ˆæŒæ¡ç‡Ÿé‹æˆé•·è¶¨å‹¢ã€‚</li>
        `;
    }

    function renderAccountingTab() {
        const machineSelector = document.getElementById('machine-selector');
        machineSelector.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
        appData.machines.forEach((m, index) => {
            machineSelector.innerHTML += `<option value="${index}">${m.id} - ${m.location}</option>`;
        });
        document.getElementById('entry-date').valueAsDate = new Date();
        
        const historyTableBody = document.getElementById('history-table-body');
        historyTableBody.innerHTML = '';
        if (appData.history.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">å°šç„¡è¨˜å¸³ç´€éŒ„</td></tr>`;
        } else {
            [...appData.history].reverse().forEach(h => {
                const machine = appData.machines[h.machineIndex] || {id: 'æœªçŸ¥', location: 'æœªçŸ¥'};
                historyTableBody.innerHTML += `<tr>
                    <td class="p-4">${h.date}</td>
                    <td class="p-4 font-medium text-white">${machine.id}</td>
                    <td class="p-4">${machine.location}</td>
                    <td class="p-4 text-right">${h.newPlays}</td>
                    <td class="p-4 text-right">${h.newPayouts}</td>
                </tr>`;
            });
        }
    }
    
    function renderChartsTab() {
        const summaryData = getSummaryData();
        const colors = ['#3b82f6', '#22c55e', '#a855f7', '#eab308', '#ef4444'];

        const revenueChart = document.getElementById('revenue-chart');
        revenueChart.innerHTML = '';
        const maxRevenue = Math.max(...summaryData.map(s => s.revenue), 0);
        summaryData.forEach((s, i) => {
            const percentage = maxRevenue > 0 ? (s.revenue / maxRevenue * 100) : 0;
            revenueChart.innerHTML += `
                <div class="flex items-center">
                    <span class="w-16 font-bold text-sm">${s.id}</span>
                    <div class="flex-1 bg-gray-700 rounded-full h-6">
                        <div class="chart-bar h-6 rounded-full text-white text-sm flex items-center justify-end pr-2" style="width: ${percentage}%; background-color: ${colors[i % colors.length]};">
                            ${s.revenue.toLocaleString()} å…ƒ
                        </div>
                    </div>
                </div>
            `;
        });

        const costChart = document.getElementById('cost-chart');
        costChart.innerHTML = '';
        const maxCost = Math.max(...summaryData.map(s => s.cost), 0);
        summaryData.forEach((s, i) => {
            const percentage = maxCost > 0 ? (s.cost / maxCost * 100) : 0;
            costChart.innerHTML += `
                <div class="flex items-center">
                    <span class="w-16 font-bold text-sm">${s.id}</span>
                    <div class="flex-1 bg-gray-700 rounded-full h-6">
                        <div class="chart-bar h-6 rounded-full text-white text-sm flex items-center justify-end pr-2" style="width: ${percentage}%; background-color: ${colors[i % colors.length]};">
                             ${s.cost.toFixed(2)} å…ƒ/æ¬¡
                        </div>
                    </div>
                </div>
            `;
        });
        renderTrendChart();
    }
    
    function renderTrendChart() {
        const trendChart = document.getElementById('trend-chart');
        trendChart.innerHTML = '';
        const dailyData = getAggregatedData('daily');
        const sortedDailyData = dailyData.sort((a, b) => new Date(a.period) - new Date(b.period));
        
        if(sortedDailyData.length < 2) {
            trendChart.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">æ­·å²ç´€éŒ„ä¸è¶³ (éœ€è‡³å°‘2å¤©) ä»¥ç¹ªè£½è¶¨å‹¢åœ–</div>`;
            return;
        }

        const W = trendChart.clientWidth;
        const H = trendChart.clientHeight;
        const pad = 40;
        const maxPlays = Math.max(...sortedDailyData.map(d => d.plays));
        const maxPayouts = Math.max(...sortedDailyData.map(d => d.payouts));
        const maxY = Math.max(maxPlays, maxPayouts, 10);

        const pointsToPath = (points) => {
            if (points.length === 0) return '';
            let path = `M ${points[0][0]} ${points[0][1]}`;
            for (let i = 1; i < points.length; i++) { path += ` L ${points[i][0]} ${points[i][1]}`; }
            return path;
        };

        const playsPoints = sortedDailyData.map((d, i) => {
            const x = pad + i * (W - pad * 2) / (sortedDailyData.length - 1);
            const y = H - pad - (d.plays / maxY) * (H - pad * 2);
            return [x, y];
        });
        const payoutsPoints = sortedDailyData.map((d, i) => {
            const x = pad + i * (W - pad * 2) / (sortedDailyData.length - 1);
            const y = H - pad - (d.payouts / maxY) * (H - pad * 2);
            return [x, y];
        });
        
        let svg = `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">`;
        svg += `<line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="#4b5563" />`;
        svg += `<line x1="${pad}" y1="${pad}" x2="${pad}" y2="${H-pad}" stroke="#4b5563" />`;
        for(let i = 0; i <= 5; i++) {
            const y = pad + i * (H - pad*2)/5;
            const value = Math.round(maxY * (1 - i/5));
            svg += `<line x1="${pad}" y1="${y}" x2="${W-pad}" y2="${y}" stroke="#374151" stroke-dasharray="2"/>`;
            svg += `<text x="${pad-5}" y="${y+5}" fill="#9ca3af" font-size="12" text-anchor="end">${value}</text>`;
        }
        sortedDailyData.forEach((d, i) => {
            const x = pad + i * (W - pad * 2) / (sortedDailyData.length - 1);
            const dateLabel = new Date(d.period).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit'});
            svg += `<text x="${x}" y="${H-pad+20}" fill="#9ca3af" font-size="12" text-anchor="middle">${dateLabel}</text>`;
        });
        svg += `<path d="${pointsToPath(playsPoints)}" fill="none" stroke="#3b82f6" stroke-width="2" />`;
        svg += `<path d="${pointsToPath(payoutsPoints)}" fill="none" stroke="#a855f7" stroke-width="2" />`;
        playsPoints.forEach(([x,y]) => svg += `<circle cx="${x}" cy="${y}" r="3" fill="#3b82f6" />`);
        payoutsPoints.forEach(([x,y]) => svg += `<circle cx="${x}" cy="${y}" r="3" fill="#a855f7" />`);
        svg += `<rect x="${W-pad-180}" y="10" width="80" height="20" fill="#3b82f6" rx="5" /><text x="${W-pad-135}" y="25" fill="white" font-size="12" text-anchor="middle">æŠ•å¹£æ•¸</text>`;
        svg += `<rect x="${W-pad-90}" y="10" width="80" height="20" fill="#a855f7" rx="5" /><text x="${W-pad-45}" y="25" fill="white" font-size="12" text-anchor="middle">å‡ºè²¨æ•¸</text>`;
        svg += `</svg>`;
        trendChart.innerHTML = svg;
    }

    function getWeekStartDate(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        return new Date(d.setDate(diff)).toISOString().split('T')[0];
    }
    
    function getQuarter(date) {
        const d = new Date(date);
        const month = d.getMonth();
        const year = d.getFullYear();
        return `${year}-Q${Math.floor(month / 3) + 1}`;
    }

    function getAggregatedData(period) {
        const groups = appData.history.reduce((acc, curr) => {
            let key;
            switch(period) {
                case 'weekly': key = getWeekStartDate(curr.date); break;
                case 'monthly': key = curr.date.substring(0, 7); break;
                case 'quarterly': key = getQuarter(curr.date); break;
                default: key = curr.date; // daily
            }
            if (!acc[key]) {
                acc[key] = { period: key, plays: 0, payouts: 0 };
            }
            acc[key].plays += curr.newPlays;
            acc[key].payouts += curr.newPayouts;
            return acc;
        }, {});

        return Object.values(groups).map(g => {
            const revenue = g.plays * COIN_VALUE;
            const cost = g.payouts > 0 ? revenue / g.payouts : 0;
            return { ...g, revenue, cost };
        });
    }

    function renderStatisticsTab() {
        const activeButton = statsControls.querySelector('.active');
        const period = activeButton ? activeButton.dataset.period : 'daily';
        
        const data = getAggregatedData(period);
        const tableBody = document.getElementById('stats-table-body');
        tableBody.innerHTML = '';

        if(data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">å°šç„¡æ­·å²ç´€éŒ„å¯ä¾›å½™æ•´</td></tr>`;
            return;
        }

        // Sort descending by period
        data.sort((a,b) => (a.period > b.period) ? -1 : 1);

        data.forEach(item => {
            tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                <td class="p-4 font-medium text-white">${item.period}</td>
                <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
            </tr>`;
        });
    }

    function updateFooterAndHeader() {
        const todayStr = new Date().toLocaleDateString('sv');
        document.getElementById('report-date').textContent = `å ±è¡¨æ›´æ–°æ—¥æœŸï¼š${todayStr}`;
        document.getElementById('report-period').textContent = `çµ±è¨ˆæœŸé–“ï¼š${appData.startDate} ï½ ${todayStr}`;
    }
    
    function showFeedback(message, isError = false) {
        const feedbackEl = document.getElementById('form-feedback');
        feedbackEl.innerHTML = message;
        feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
        setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
    }

    // --- EVENT LISTENERS ---
    allTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            allTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            allTabContents.forEach(content => {
                content.style.display = content.id === tab.dataset.tab ? 'block' : 'none';
            });
            if (tab.dataset.tab === 'charts') { renderTrendChart(); }
            if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
        });
    });
    document.querySelector('.tab-btn[data-tab="accounting"]').click();

    statsControls.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            renderStatisticsTab();
        }
    });

    document.getElementById('daily-entry-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const date = document.getElementById('entry-date').value;
        const machineIndex = parseInt(document.getElementById('machine-selector').value);
        const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
        const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

        if (isNaN(machineIndex) || isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
            showFeedback('éŒ¯èª¤ï¼šè«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚', true); return;
        }

        const currentMachineData = appData.machines[machineIndex];
        if (cumulativePlaysInput < currentMachineData.plays || cumulativePayoutsInput < currentMachineData.payouts) {
            showFeedback('éŒ¯èª¤ï¼šè¼¸å…¥çš„ç´¯ç©æ•¸å€¼å°æ–¼ä¸Šæ¬¡ç´€éŒ„ï¼Œè«‹ç¢ºèªæŠ„è¡¨æ•¸å€¼æ˜¯å¦æ­£ç¢ºã€‚', true); return;
        }

        const dailyPlays = cumulativePlaysInput - currentMachineData.plays;
        const dailyPayouts = cumulativePayoutsInput - currentMachineData.payouts;

        appData.machines[machineIndex].plays = cumulativePlaysInput;
        appData.machines[machineIndex].payouts = cumulativePayoutsInput;

        if (dailyPlays > 0 || dailyPayouts > 0) {
             appData.history.push({ date, machineIndex, newPlays: dailyPlays, newPayouts: dailyPayouts });
        }

        saveData();
        updateUI();
        e.target.reset();
        document.getElementById('entry-date').valueAsDate = new Date();
        
        const successMessage = `ç´€éŒ„å·²æ–°å¢ï¼æœ¬æ—¥ ${currentMachineData.id} (${currentMachineData.location}) æ–°å¢ï¼š<strong class="text-white">${dailyPlays}</strong> æŠ•å¹£ã€<strong class="text-white">${dailyPayouts}</strong> å‡ºè²¨ã€‚`;
        showFeedback(successMessage);
    });

    searchInput.addEventListener('input', () => updateUI());
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            let direction = 'asc';
            if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                direction = 'desc';
            }
            currentSort = { key: sortKey, direction };

            sortableHeaders.forEach(h => {
                h.classList.remove('sorted');
                h.querySelector('.sort-indicator').textContent = '';
            });
            header.classList.add('sorted');
            header.querySelector('.sort-indicator').textContent = direction === 'asc' ? 'â–²' : 'â–¼';
            updateUI();
        });
    });
    
    document.getElementById('download-report-btn').addEventListener('click', downloadCSV);

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            if (document.getElementById('charts').style.display === 'block') {
                 renderTrendChart();
            }
        }, 250);
    });

    // --- INITIAL LOAD ---
    loadData();
    updateUI();
});
</script>

</body>
</html>

