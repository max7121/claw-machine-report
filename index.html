<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式查帳系統 - 娃娃機營業報告 (多單位雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
        .card-base { transition: transform 0.2s, box-shadow 0.2s; }
        .card-base:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .preset-tag { cursor: pointer; transition: background-color 0.2s; }
        .preset-tag:hover { background-color: #4f46e5; }
        
        /* 圖表樣式 */
        .checkout-chart svg { filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); }
        .checkout-chart circle { transition: all 0.2s ease; }
        .checkout-chart circle:hover { filter: brightness(1.2); transform: scale(1.2); }
        .checkout-chart path { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- 登入/使用者區塊 -->
    <div id="user-bar" class="max-w-7xl mx-auto flex justify-end mb-4 hidden">
        <div class="flex items-center gap-3">
            <span id="user-greeting" class="text-gray-300">歡迎，<strong id="user-name">使用者</strong></span>
            <button id="admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded hidden">管理</button>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">登出</button>
        </div>
    </div>

    <!-- 登入 modal (預設顯示，如果未登入) -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">請先登入</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-1">帳號</label>
                    <input id="username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="輸入帳號">
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-1">密碼</label>
                    <input id="password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="輸入密碼">
                </div>
                <div class="flex items-center justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">登入</button>
                </div>
                <div id="login-feedback" class="text-sm text-red-400 mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- 層級 1: 單位群組選擇頁面 -->
    <div id="group-selection-page" class="max-w-4xl mx-auto hidden">
        <h1 class="text-4xl font-bold text-white text-center mb-8">娃娃機查帳系統</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">建立新單位群組</h2>
            <form id="create-group-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-group-name" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入單位名稱 (例如：A單位)" required>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">建立群組</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">選擇您的單位群組</h2>
            <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">正在讀取群組列表...</p>
            </div>
        </div>
    </div>

    <!-- 管理者設定頁面 -->
    <div id="admin-page" class="max-w-6xl mx-auto hidden">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-4xl font-bold text-white">系統管理</h1>
            <button id="back-to-main-btn" class="text-blue-400 hover:text-blue-300 transition flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                <span>返回主系統</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 管理員帳密設定 -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">管理員帳密設定</h2>
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm text-gray-300 mb-1">目前密碼</label>
                        <input id="current-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-username" class="block text-sm text-gray-300 mb-1">新帳號</label>
                        <input id="new-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm text-gray-300 mb-1">新密碼</label>
                        <input id="new-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm text-gray-300 mb-1">確認密碼</label>
                        <input id="confirm-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">更新管理員帳密</button>
                </form>
                <div id="admin-password-feedback" class="text-sm mt-2 hidden"></div>
            </div>

            <!-- 訪客帳號管理 -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">訪客帳號管理</h2>
                <form id="guest-account-form" class="space-y-4 mb-6">
                    <div>
                        <label for="guest-username" class="block text-sm text-gray-300 mb-1">訪客帳號</label>
                        <input id="guest-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="guest-password" class="block text-sm text-gray-300 mb-1">訪客密碼</label>
                        <input id="guest-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">可訪問的群組</label>
                        <div id="group-permissions" class="space-y-2 max-h-32 overflow-y-auto bg-gray-700 p-3 rounded-lg">
                            <p class="text-gray-400 text-sm">載入群組列表中...</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">頁面訪問權限</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-gray-700 p-4 rounded-lg">
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">報表功能</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="details" class="page-permission-checkbox rounded text-blue-600">
                                    <span>機台明細</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="summary" class="page-permission-checkbox rounded text-blue-600">
                                    <span>營運總覽</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="analysis" class="page-permission-checkbox rounded text-blue-600">
                                    <span>經營分析</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="charts" class="page-permission-checkbox rounded text-blue-600">
                                    <span>圖表統計</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="statistics" class="page-permission-checkbox rounded text-blue-600">
                                    <span>數據統計</span>
                                </label>
                            </div>
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-green-300">操作功能</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="accounting" class="page-permission-checkbox rounded text-green-600">
                                    <span>每日記帳</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="machines" class="page-permission-checkbox rounded text-green-600">
                                    <span>機台管理</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="profit" class="page-permission-checkbox rounded text-yellow-600">
                                    <span>盈利計算</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="checkout" class="page-permission-checkbox rounded text-green-600">
                                    <span>結帳作業</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="download" class="page-permission-checkbox rounded text-purple-600">
                                    <span>下載報告</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="edit" class="page-permission-checkbox rounded text-orange-600">
                                    <span>編輯/刪除</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" id="select-all-permissions" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">全選</button>
                            <button type="button" id="select-readonly-permissions" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">僅檢視</button>
                            <button type="button" id="clear-all-permissions" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">清除</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">新增訪客</button>
                        <button type="button" id="cancel-guest-edit" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">取消</button>
                    </div>
                </form>
                <div id="guest-account-feedback" class="text-sm mt-2 hidden"></div>
            </div>
        </div>

        <!-- 訪客帳號列表 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">現有訪客帳號</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-4">帳號</th>
                            <th class="p-4">狀態</th>
                            <th class="p-4">可訪問群組</th>
                            <th class="p-4">頁面權限</th>
                            <th class="p-4">建立時間</th>
                            <th class="p-4 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="guest-accounts-table" class="divide-y divide-gray-700">
                        <tr><td colspan="6" class="text-center p-8 text-gray-400">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 系統工具 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">系統工具</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="export-config-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">匯出設定</button>
                <button id="import-config-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition">匯入設定</button>
                <button id="reset-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">重置系統</button>
            </div>
            <input type="file" id="config-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <!-- 層級 2: 門市選擇頁面 (預設隱藏) -->
    <div id="store-selection-page" class="max-w-4xl mx-auto hidden">
         <button id="back-to-groups-btn" class="text-blue-400 hover:text-blue-300 transition mb-4 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <span>返回群組列表</span>
        </button>
        <h1 id="store-page-title" class="text-4xl font-bold text-white text-center mb-8">門市管理</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">建立新門市</h2>
            <form id="create-store-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="new-store-name" class="block text-sm font-medium text-gray-300 mb-1">門市名稱</label>
                    <input type="text" id="new-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：台中逢甲店" required>
                </div>
                 <div>
                    <label for="new-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">營業起始日</label>
                    <input type="date" id="new-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <button type="submit" class="sm:col-span-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shrink-0">建立門市</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
             <h2 class="text-2xl font-bold text-white mb-4">選擇要管理的門市</h2>
            <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-3">下載所選門市報表</h3>
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                    <select id="report-period-selector" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                        <option value="all">總和</option>
                        <option value="daily">單日</option>
                        <option value="weekly">週報</option>
                        <option value="monthly">月報</option>
                        <option value="quarterly">季報</option>
                        <option value="yearly">年報</option>
                    </select>
                    <input type="date" id="report-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto hidden" title="選擇報表基準日">
                    <button id="download-all-stores-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 w-full sm:w-auto justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                        </svg>
                        <span>自定義門市報表</span>
                    </button>
                </div>
            </div>
             <div class="flex justify-end gap-4 mb-4">
                 <button id="select-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">全選</button>
                 <button id="deselect-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">取消全選</button>
             </div>
            <div id="store-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">正在讀取門市列表...</p>
            </div>
        </div>
    </div>

    <!-- 層級 3: 報表主頁面 (預設隱藏) -->
    <div id="report-page" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button id="back-to-stores-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span>返回門市列表</span>
                    </button>
                    <h1 id="report-title-main" class="text-3xl sm:text-4xl font-bold text-white mb-2">娃娃機營業報告</h1>
                    <p class="text-lg text-gray-400" id="report-period">統計期間：</p>
                </div>
                <div id="header-download-buttons" class="flex items-center gap-2">
                    <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>自定義報表下載</span>
                    </button>
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        <span>快速列印 (PDF)</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 當期統計說明 -->
        <div class="mb-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
            <p class="text-blue-300 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                以下數據為當期未結帳統計（總數據扣除最後結帳資料後的數值）
            </p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期投幣次數</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期投幣金額</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 元</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期出貨次數</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期平均成本</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 元/次</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">每日記帳</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="machines">機台管理</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">圖表分析</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">統計彙整</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">機台營業明細</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">各機台營運概況</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">分析與建議</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="profit">盈利計算</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="checkout">結帳作業</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                     <h3 class="text-xl font-bold text-white mb-4">新增每日紀錄</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">日期</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">機台位置</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">累積投幣數 (抄表)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">累積出貨數 (抄表)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">新增紀錄</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                        
                        <!-- 輪詢帶入按鈕 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                            <button id="import-from-poll-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>📥 從輪詢帶入</span>
                            </button>
                            <button id="batch-add-all-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>✅ 批量新增所有機台</span>
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">📊 HTTP 輪詢自動記帳</h3>
                    <p class="text-sm text-gray-400 mb-4">從 HTTP 端點自動輪詢收集的每日記帳數據（devid=1 左天車、devid=2 右天車）</p>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">日期</th>
                                    <th class="p-4">天車</th>
                                    <th class="p-4 text-right">投幣數</th>
                                    <th class="p-4 text-right">出獎數</th>
                                    <th class="p-4 text-center">更新次數</th>
                                    <th class="p-4 text-center">最後更新</th>
                                    <th class="p-4 text-center">建立時間</th>
                                </tr>
                            </thead>
                            <tbody id="auto-record-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">記帳歷史紀錄</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">日期</th>
                                    <th class="p-4">機台編號</th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4 text-right">當日投幣數</th>
                                    <th class="p-4 text-right">當日出貨數</th>
                                    <th class="p-4 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="machines" class="tab-content hidden">
                    <!-- HTTP 即時同步區塊 -->
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">HTTP 即時同步</h3>

                        <!-- HTTP 輪詢控制 -->
                        <div class="mt-4 flex flex-col lg:flex-row items-start lg:items-center justify-between bg-gray-800/50 p-3 rounded-lg gap-4">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 flex-1">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="auto-poll-enabled" class="rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-300">啟用自動輪詢所有機台</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-300">間隔：</label>
                                    <select id="poll-interval" class="bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                        <option value="500">0.5秒</option>
                                        <option value="1000">1秒</option>
                                        <option value="2000">2秒</option>
                                        <option value="3000">3秒</option>
                                        <option value="5000">5秒</option>
                                        <option value="10000" selected>10秒</option>
                                        <option value="30000">30秒</option>
                                        <option value="60000">1分鐘</option>
                                        <option value="300000">5分鐘</option>
                                    </select>
                                </div>
                            </div>
                            <button id="poll-all-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                📊 立即輪詢所有機台
                            </button>
                        </div>
                        <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                            <div class="flex items-center space-x-2">
                                <div id="mqtt-status-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span id="mqtt-status-text" class="text-sm text-gray-400">未連接</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>最後更新：</span>
                                <span id="last-mqtt-update">無</span>
                            </div>
                        </div>

                    </div>

                    <!-- HTTP 讀取資料功能 -->
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">📖 讀取機台資料 (HTTP GET)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="read-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">機台 MAC 位址</label>
                                <input type="text" id="read-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="083A8DE1ED14" value="083A8DE1ED14">
                                <p class="text-xs text-gray-500 mt-1">機台 WiFi 小卡的 MAC 位址</p>
                            </div>
                            <div>
                                <label for="read-device-id" class="block text-sm font-medium text-gray-300 mb-1">天車 ID</label>
                                <select id="read-device-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                    <option value="1">左天車 (ID: 1)</option>
                                    <option value="2">右天車 (ID: 2)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="send-read-command" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    📤 測試查詢
                                </button>
                            </div>
                        </div>

                        <!-- HTTP 連線測試按鈕 -->
                        <div class="mb-4">
                            <button id="mqtt-test-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                🔗 測試 HTTP 連線
                            </button>
                        </div>

                        <!-- 命令記錄 -->
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-300 mb-2">📋 命令記錄</h4>
                            <div id="mqtt-command-log" class="space-y-2 max-h-40 overflow-y-auto">
                                <p class="text-xs text-gray-500">HTTP 命令記錄將在此顯示...</p>
                            </div>
                        </div>

                    </div>



                    <h3 class="text-xl font-bold text-white mb-4">建立新機台</h3>
                    <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-6">
                        <div>
                            <label for="new-machine-id" class="block text-sm font-medium text-gray-300 mb-1">機台編號</label>
                            <input type="text" id="new-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：A01" required>
                        </div>
                        <div>
                            <label for="new-machine-location" class="block text-sm font-medium text-gray-300 mb-1">位置/內容物</label>
                            <input type="text" id="new-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：門口/大娃娃" required>
                            <div id="location-presets" class="flex flex-wrap gap-2 mt-2">
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">上層 / 左側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">上層 / 右側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">下層 / 左側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">下層 / 右側</span>
                            </div>
                        </div>
                         <div>
                            <label for="new-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">起始投幣數 (測試用)</label>
                            <input type="number" id="new-machine-initial-plays" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">起始出貨數 (測試用)</label>
                            <input type="number" id="new-machine-initial-payouts" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">機台 MAC 位址 (MQTT)</label>
                            <input type="text" id="new-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：083A8DE1E8FB">
                        </div>
                        <div>
                            <label for="new-machine-devid" class="block text-sm font-medium text-gray-300 mb-1">設備 ID (MQTT)</label>
                            <input type="number" id="new-machine-devid" min="1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：2">
                        </div>
                        <button type="submit" class="md:col-span-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">建立機台</button>
                    </form>
                    
                    <div class="flex justify-between items-center mb-4 mt-4">
                         <h3 class="text-xl font-bold text-white">現有機台列表</h3>
                         <button id="recalculate-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.082.541a5.002 5.002 0 00-8.736-1.613L8 8H4V4l2.293 2.293A6.996 6.996 0 0111 3.055a6.996 6.996 0 015.688 3.568l1.082-.54A8.996 8.996 0 0012.22 2.022 8.996 8.996 0 004 5.101V3a1 1 0 01-1-1H2a1 1 0 01-1-1V1a1 1 0 011-1h2zm12 16a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.899-2.186l1.082-.541a5.002 5.002 0 008.736 1.613L12 12h4v4l-2.293-2.293A6.996 6.996 0 019 16.945a6.996 6.996 0 01-5.688-3.568l-1.082.54A8.996 8.996 0 007.78 17.978 8.996 8.996 0 0016 14.899V17a1 1 0 011 1h1a1 1 0 011 1v1a1 1 0 01-1 1h-2z" clip-rule="evenodd" />
                            </svg>
                            <span>重新計算所有數據</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">機台編號</th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4">MAC 位址</th>
                                    <th class="p-4">設備ID</th>
                                    <th class="p-4 text-right">起始投幣</th>
                                    <th class="p-4 text-right">起始出貨</th>
                                    <th class="p-4 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="machine-list-table-body" class="divide-y divide-gray-700">
                                <!-- 機台列表將動態插入 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 機台詳細資料面板 -->
                    <div id="machine-detail-panel" class="hidden mt-6 bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">機台詳細資料</h3>
                            <button id="close-detail-panel" class="text-gray-400 hover:text-white text-2xl">×</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 電壓資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-blue-400 mb-3">電壓資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">強電壓:</span>
                                        <span id="detail-strong-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中電壓:</span>
                                        <span id="detail-medium-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">弱電壓:</span>
                                        <span id="detail-weak-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中壓距離頂點高度:</span>
                                        <span id="detail-height-to-top" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">保夾強電壓:</span>
                                        <span id="detail-clamp-voltage" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 營運資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-green-400 mb-3">營運資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中獎率銀行:</span>
                                        <span id="detail-win-rate-bank" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">投幣遊戲次數:</span>
                                        <span id="detail-coin-game-count" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">禮品出獎次數:</span>
                                        <span id="detail-prize-count" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 累加金額資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-yellow-400 mb-3">累加金額</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第1筆:</span>
                                        <span id="detail-amount-1" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第2筆:</span>
                                        <span id="detail-amount-2" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第3筆:</span>
                                        <span id="detail-amount-3" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 基本資料 -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2 lg:col-span-1">
                                <h4 class="text-lg font-semibold text-purple-400 mb-3">基本資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">機台編號:</span>
                                        <span id="detail-machine-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">MAC位址:</span>
                                        <span id="detail-mac-address" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">設備ID:</span>
                                        <span id="detail-device-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">最後更新:</span>
                                        <span id="detail-last-update" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 原始資料 -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2">
                                <h4 class="text-lg font-semibold text-red-400 mb-3">原始 Hex 資料</h4>
                                <div class="bg-gray-900 rounded p-3 font-mono text-xs text-green-400 break-all">
                                    <span id="detail-raw-hex">無資料</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                    <!-- 圖表統計範圍選擇 -->
                    <div class="flex justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">圖表統計範圍：</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="chart-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    📊 當期紀錄
                                </button>
                                <button type="button" class="chart-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    📈 全部歷史
                                </button>
                            </div>
                        </div>
                    </div>
                    
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台總營收比較</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台平均出貨成本</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">單日各機台表現</h3>
                        <div class="flex items-center gap-4 mb-4">
                            <label for="trend-chart-date-picker" class="text-gray-300 shrink-0">選擇日期：</label>
                            <input type="date" id="trend-chart-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 w-full sm:w-auto">
                        </div>
                        <div id="trend-chart-content" class="w-full"></div>
                    </div>
                </div>
                <div id="statistics" class="tab-content hidden">
                    <!-- 統計範圍選擇 -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg gap-4">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">統計範圍：</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="stats-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    📊 當期紀錄
                                </button>
                                <button type="button" class="stats-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    📈 全部歷史
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="refresh-all-stats-btn" class="py-2 px-4 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                🔄 重新統計全部
                            </button>
                        </div>
                    </div>
                    
                     <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">每日</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">每週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">每月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">每季</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">期間</th>
                                    <th class="p-4 text-right">總投幣次數</th>
                                    <th class="p-4 text-right">總投幣金額</th>
                                    <th class="p-4 text-right">總出貨次數</th>
                                    <th class="p-4 text-right">平均出貨成本</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="依機台編號搜尋...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable sorted" data-sort="id">機台編號 <span class="sort-indicator">▲</span></th>
                                    <th class="p-4 table-header-sortable" data-sort="location">位置 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePlays">營業投幣次數 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">營業投幣金額 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePayouts">營業出貨數量 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">平均出貨成本 <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="summary-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">總計</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">本週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">本月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">本季</button>
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-r-md border border-blue-600 hover:bg-blue-700 hover:text-white" data-period="current">當期</button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">營運概況總表</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">機台編號</th>
                                        <th class="p-4 text-right">總投幣金額</th>
                                        <th class="p-4 text-right">總出貨數量</th>
                                        <th class="p-4 text-right">平均出貨成本</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">各機台投幣金額佔比</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>📈 PSD（每日平均銷售表現）</h3>
                     <div class="flex flex-wrap justify-center items-center mb-4 bg-gray-900/50 p-2 rounded-lg gap-2">
                        <div id="psd-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">總計</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">本週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">本月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">本季</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="custom">自訂區間</button>
                        </div>
                         <div id="psd-custom-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="psd-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <span class="text-gray-400">至</span>
                            <input type="date" id="psd-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <button id="psd-calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">計算</button>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>計算中...</strong></p>
                    </div>
                    <h3 class="mt-8">🔬 分析與觀察</h3>
                    <div id="analysis-observation" class="space-y-6"></div>
                    <h3 class="mt-8">💡 結論建議</h3>
                    <div id="analysis-suggestion" class="space-y-4"></div>
                </div>
                
                <!-- 盈利計算頁面 -->
                <div id="profit" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-6">💰 盈利計算器</h3>
                    
                    <!-- 基本資訊卡片 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-blue-100 mb-2">📊 營業資訊</h4>
                            <div class="text-2xl font-bold text-white" id="profit-revenue">0 元</div>
                            <div class="text-sm text-blue-100 mt-1">總營業額</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-green-100 mb-2">🎁 出貨統計</h4>
                            <div class="text-2xl font-bold text-white" id="profit-payouts">0 次</div>
                            <div class="text-sm text-green-100 mt-1">總出貨次數</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-purple-100 mb-2">💵 淨利潤</h4>
                            <div class="text-2xl font-bold text-white" id="profit-net">0 元</div>
                            <div class="text-sm text-purple-100 mt-1">扣除成本後</div>
                        </div>
                    </div>
                    
                    <!-- 成本設定區域 -->
                    <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                        <h4 class="text-lg font-semibold text-white mb-4">🔧 成本設定與計算範圍</h4>
                        
                        <!-- 計算範圍選擇 -->
                        <div class="mb-6 p-4 bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-300 mb-3">📊 計算範圍選擇</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="total" checked 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">📈 總累積計算</span>
                                        <p class="text-gray-400 text-sm">計算從營業開始至今的總盈利</p>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="pending" 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">💰 本期待結帳計算</span>
                                        <p class="text-gray-400 text-sm">僅計算本期待結帳金額的盈利</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🎁 每次出貨禮品成本 (元)</label>
                                <input type="number" id="gift-cost" value="50" min="0" step="1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🏠 店租比例 (%)</label>
                                <input type="number" id="rent-percentage" value="30" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🏛️ 稅金比例 (%)</label>
                                <input type="number" id="tax-percentage" value="5" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="calculate-profit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                🧮 重新計算
                            </button>
                            <button id="save-cost-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition ml-2">
                                💾 儲存設定
                            </button>
                        </div>
                    </div>
                    
                    <!-- 詳細計算結果 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 成本分析 -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">💸 成本明細</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🎁 禮品成本</span>
                                    <span class="text-white font-semibold" id="total-gift-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🏠 店租費用</span>
                                    <span class="text-white font-semibold" id="total-rent-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🏛️ 稅金費用</span>
                                    <span class="text-white font-semibold" id="total-tax-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-red-500">
                                    <span class="text-red-300 font-semibold">💰 總成本</span>
                                    <span class="text-red-300 font-bold text-lg" id="total-cost">0 元</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 盈利分析 -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">📈 盈利分析</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">📊 總營業額</span>
                                    <span class="text-green-400 font-semibold" id="profit-total-revenue">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">💸 總成本</span>
                                    <span class="text-red-400 font-semibold" id="profit-total-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-green-500">
                                    <span class="text-green-300 font-semibold">💵 淨利潤</span>
                                    <span class="text-green-300 font-bold text-xl" id="net-profit">0 元</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-300">📊 利潤率</span>
                                        <span class="font-semibold" id="profit-margin">0%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-300">💰 每次出貨淨利</span>
                                        <span class="font-semibold" id="profit-per-payout">0 元</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div id="checkout" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">本期營收結帳</h3>
                    <div class="bg-gray-900/50 p-6 rounded-lg mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-400">上次結帳日期：<span id="last-checkout-date" class="font-semibold">無</span></p>
                            <p class="text-lg text-white mt-1">本期待結帳金額：<span id="pending-checkout-amount" class="text-2xl font-bold text-green-400">0 元</span></p>
                        </div>
                        <div class="flex gap-2">
                           <button id="download-checkout-csv-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">下載結帳報表 (CSV)</button>
                           <button id="perform-checkout-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">執行結帳</button>
                        </div>
                    </div>
                    
                    <!-- 結帳趨勢圖表 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                結帳金額趨勢
                            </h4>
                            <div id="checkout-amount-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">暫無數據可顯示圖表</p>
                            </div>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                累積營收趨勢
                            </h4>
                            <div id="checkout-cumulative-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">暫無數據可顯示圖表</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 結帳統計摘要 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-blue-400 text-sm">總結帳次數</p>
                            <p id="total-checkouts" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-green-400 text-sm">平均結帳金額</p>
                            <p id="avg-checkout-amount" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                        <div class="bg-purple-900/30 p-4 rounded-lg text-center">
                            <p class="text-purple-400 text-sm">最高單次結帳</p>
                            <p id="max-checkout-amount" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                        <div class="bg-orange-900/30 p-4 rounded-lg text-center">
                            <p class="text-orange-400 text-sm">累計盈利</p>
                            <p id="total-profit-summary" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-4 mt-8">結帳歷史紀錄</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-3 text-xs">結帳日期</th>
                                    <th class="p-3 text-right text-xs">當期營收</th>
                                    <th class="p-3 text-right text-xs">當期出貨</th>
                                    <th class="p-3 text-right text-xs">當期盈利</th>
                                    <th class="p-3 text-right text-xs">累積總營收</th>
                                    <th class="p-3 text-right text-xs">盈利計算</th>
                                    <th class="p-3 text-right text-xs">操作</th>
                                </tr>
                            </thead>
                            <tbody id="checkout-history-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">報表建立日期：</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">確認操作</h3>
            <p id="modal-message" class="text-gray-300 mb-6">您確定要執行此操作嗎？</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <!-- Edit Store Modal -->
    <div id="edit-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">編輯門市資訊</h3>
            <form id="edit-store-form">
                <input type="hidden" id="edit-store-id">
                 <div class="mb-4">
                    <label for="edit-store-name" class="block text-sm font-medium text-gray-300 mb-1">門市名稱</label>
                    <input type="text" id="edit-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6">
                    <label for="edit-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">營業起始日</label>
                    <input type="date" id="edit-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="edit-history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">修改記帳紀錄</h3>
            <form id="edit-history-form">
                <input type="hidden" id="edit-history-doc-id">
                <input type="hidden" id="edit-history-machine-id">
                <input type="hidden" id="edit-history-location">
                <input type="hidden" id="edit-history-old-plays">
                <input type="hidden" id="edit-history-old-payouts">
                <div class="mb-4">
                    <label for="edit-history-plays" class="block text-sm font-medium text-gray-300 mb-1">當日投幣數</label>
                    <input type="number" id="edit-history-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="mb-6">
                    <label for="edit-history-payouts" class="block text-sm font-medium text-gray-300 mb-1">當日出貨數</label>
                    <input type="number" id="edit-history-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-history-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Machine Modal -->
    <div id="edit-machine-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">修改機台資訊</h3>
            <form id="edit-machine-form">
                <input type="hidden" id="edit-machine-doc-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="edit-machine-id" class="block text-sm font-medium text-gray-300 mb-1">機台編號</label>
                        <input type="text" id="edit-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-machine-location" class="block text-sm font-medium text-gray-300 mb-1">位置/內容物</label>
                        <input type="text" id="edit-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                    </div>
                     <div class="mb-4">
                        <label for="edit-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">起始投幣數</label>
                        <input type="number" id="edit-machine-initial-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                    </div>
                     <div class="mb-4">
                        <label for="edit-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">起始出貨數</label>
                        <input type="number" id="edit-machine-initial-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="edit-machine-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Report Download Modal -->
    <div id="custom-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">自定義報表內容</h3>
            
            <!-- 報表類型選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇報表類型</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📊 營業摘要統計</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-details" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📋 機台詳細資料</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-operation-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📊 營運概況總表</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-history" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📝 記帳歷史紀錄</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-analysis" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📈 營運分析數據</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-checkout" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">💰 結帳紀錄</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-profit" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🧮 盈利計算</span>
                    </label>
                </div>
            </div>
            
            <!-- 報表格式選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇檔案格式</h4>
                <div class="flex gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="csv" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">📄 CSV 格式</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="pdf" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">📑 PDF 格式</span>
                    </label>
                </div>
            </div>
            
            <!-- 快速選擇按鈕 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">快速選擇</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">全選</button>
                    <button type="button" id="select-basic-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">基本報表</button>
                    <button type="button" id="select-detailed-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">詳細報表</button>
                    <button type="button" id="clear-all-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">清空</button>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button type="button" id="custom-report-download" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>下載報表</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Store Report Modal -->
    <div id="custom-store-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">自定義門市報表內容</h3>
            
            <!-- 門市選擇提示 -->
            <div class="mb-4 p-3 bg-blue-900/50 rounded-lg">
                <p class="text-blue-300 text-sm">請先在門市列表中勾選要包含在報表中的門市</p>
            </div>
            
            <!-- 報表內容選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇報表內容</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📊 門市營業摘要</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">🎰 各門市機台明細</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-performance" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📈 門市績效比較</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-top-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🏆 各門市優績機台</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-period-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📅 期間營運統計</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-profit" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🧮 盈利計算分析</span>
                    </label>
                </div>
            </div>
            
            <!-- 報表期間選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">報表期間</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="all" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">全部期間</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="monthly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">月報</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="quarterly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">季報</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="yearly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">年報</span>
                    </label>
                </div>
                <div class="mt-2">
                    <input type="date" id="store-report-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full" title="報表基準日期">
                </div>
            </div>
            
            <!-- 快速選擇按鈕 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">快速選擇</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-store-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">全選</button>
                    <button type="button" id="select-basic-store-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">基本報表</button>
                    <button type="button" id="select-detailed-store-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">詳細報表</button>
                    <button type="button" id="clear-all-store-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">清空</button>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-store-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button type="button" id="custom-store-report-download" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>下載門市報表</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 盈利詳情查看模態視窗 -->
    <div id="profit-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">🧮 結帳期間盈利詳情</h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 營業數據 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">📊 營業數據</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">結帳日期</span>
                            <span class="text-white font-semibold" id="detail-checkout-date">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">當期營收</span>
                            <span class="text-green-400 font-semibold" id="detail-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">當期出貨</span>
                            <span class="text-blue-400 font-semibold" id="detail-payouts">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 成本設定 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">🔧 成本設定</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">禮品成本</span>
                            <span class="text-white font-semibold" id="detail-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">店租比例</span>
                            <span class="text-white font-semibold" id="detail-rent-percentage">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">稅金比例</span>
                            <span class="text-white font-semibold" id="detail-tax-percentage">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 成本明細 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">💸 成本明細</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">禮品成本</span>
                            <span class="text-red-400 font-semibold" id="detail-total-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">店租費用</span>
                            <span class="text-red-400 font-semibold" id="detail-total-rent-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">稅金費用</span>
                            <span class="text-red-400 font-semibold" id="detail-total-tax-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-red-300 font-semibold">總成本</span>
                            <span class="text-red-300 font-bold" id="detail-total-cost">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 盈利分析 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">📈 盈利分析</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">營收</span>
                            <span class="text-green-400 font-semibold" id="detail-profit-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">成本</span>
                            <span class="text-red-400 font-semibold" id="detail-profit-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-white font-semibold">淨利潤</span>
                            <span class="font-bold text-lg" id="detail-net-profit">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">利潤率</span>
                            <span class="font-semibold" id="detail-profit-margin">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="close-profit-detail" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Loader Overlay -->
    <div id="pdf-loader-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center hidden z-50">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="pdf-loader-text-overlay" class="text-white text-lg mt-4">正在生成 PDF...</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="admin-config.js"></script>
    <script src="login.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! 請將這裡的設定換成您自己的 Firebase 專案金鑰 !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // 初始化管理員配置系統
        if (window.initAdminConfig) {
            window.initAdminConfig(db);
        }
        // --- END: Firebase Initialization ---

        // 偵測 HTTPS 並顯示警告
        if (window.location.protocol === 'https:') {
            const httpsWarning = document.getElementById('https-warning');
            if (httpsWarning) {
                httpsWarning.classList.remove('hidden');
                console.warn('⚠️ 頁面使用 HTTPS，WebSocket 連線將自動從 ws:// 轉換為 wss://');
            }
        }
        
        // 頁面載入完成後顯示 HTTP 配置資訊
        console.log('🌐 HTTP GET 配置已載入');
        console.log('📡 伺服器位址:', 'http://update.feiloli.com.tw:5539');
        console.log('🔗 API 端點:', '/textselectdata/{mac}');
        console.log('📋 範例 URL:', 'http://update.feiloli.com.tw:5539/textselectdata/083A8DE1ED14');

        // --- HTTP GET 輪詢配置 ---
        let httpPollingEnabled = true;
        let httpPollingTimer = null;
        let httpPollingInterval = 5000; // 預設 5 秒輪詢一次
        let httpLastRequestTime = 0;
        let httpRequestCount = 0;
        let httpErrorCount = 0;
        let httpLastResponse = null;
        let corsQuietMode = true; // ✅ 啟用 CORS 靜默模式 - 錯誤只記錄到控制台，不顯示警告框
        
        // 測試模式設定（用於 CORS 問題調試）
        const isTestMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // HTTP GET 伺服器配置
        const httpConfig = {
            // 根據是否為測試模式切換服務器
            baseUrl: isTestMode 
                ? 'http://localhost:8080'  // 本地代理伺服器
                : 'http://update.feiloli.com.tw:5539',  // 正式伺服器
            endpoint: '/textselectdata/{mac}', // {mac} 將被實際 MAC 地址替換
            currentMac: '083A8DE1ED14', // 預設 MAC 地址
            params: {},   // 不需要查詢參數（MAC 在路徑中）
            headers: {},  // 不需要額外標頭
            timeout: 10000 // 請求超時時間（毫秒）
        };
        
        // 顯示當前模式
        console.log(isTestMode ? '🧪 測試模式：使用本地服務器' : '🌐 正式模式：使用遠端服務器');
        console.log(corsQuietMode ? '🔇 CORS 靜默模式已啟用 - 錯誤只在控制台顯示' : '🔔 CORS 詳細模式已啟用 - 將顯示警告框');
        console.log('📡 目前使用的 baseUrl:', httpConfig.baseUrl);

        // --- MQTT 相關變數和功能（已棄用，保留供參考） ---
        let mqttClient = null;
        let mqttConnected = false;
        let mqttReconnectTimer = null;
        let mqttHeartbeatTimer = null;
        let mqttReconnectAttempts = 0;
        let mqttAutoReconnect = false; // 改為 false，停用自動重連
        const mqttMaxReconnectAttempts = 10;
        
        // 將 MQTT 變數設為全域，供調試使用
        window.mqttClient = null;
        window.mqttConnected = false;
        const mqttReconnectInterval = 5000; // 5秒（一般伺服器）
        const mqttReconnectIntervalOriginal = 30000; // 30秒（原伺服器，較長間隔）
        const mqttHeartbeatInterval = 30000; // 30秒
        
        // MQTT 伺服器設定
        const mqttServerConfigs = {
            hivemq: {
                url: 'ws://broker.hivemq.com:8000/mqtt',
                topic: 'coffeelens/resp'
            }
        };
        
        // 快速設定 MQTT 伺服器
        function setMqttServer(serverKey) {
            const config = mqttServerConfigs[serverKey];
            if (!config) return;
            
            // 如果已連線，先中斷
            if (mqttConnected && mqttClient) {
                mqttClient.end();
                mqttConnected = false;
            }
            
            // 更新輸入框
            document.getElementById('mqtt-broker-url').value = config.url;
            document.getElementById('mqtt-topic').value = config.topic;
            
            console.log(`已設定 MQTT 伺服器: ${config.url}`);
        }
        
        // 讓函數在全域範圍可用
        window.setMqttServer = setMqttServer;
        
        // ========================================
        // HTTP GET 輪詢功能
        // ========================================
        
        // 建構完整的 HTTP GET URL
        function buildHttpUrl(mac = null) {
            if (!httpConfig.baseUrl || !httpConfig.endpoint) {
                console.error('❌ HTTP 配置不完整：缺少 baseUrl 或 endpoint');
                return null;
            }
            
            // 使用提供的 MAC 或預設的 MAC
            const macAddress = mac || httpConfig.currentMac;
            
            // 替換路徑中的 {mac} 參數
            let endpointPath = httpConfig.endpoint.replace('{mac}', macAddress);
            
            // 建構完整 URL
            const fullUrl = httpConfig.baseUrl + endpointPath;
            
            // 如果有查詢參數，添加到 URL
            if (httpConfig.params && Object.keys(httpConfig.params).length > 0) {
                const url = new URL(fullUrl);
                Object.keys(httpConfig.params).forEach(key => {
                    url.searchParams.append(key, httpConfig.params[key]);
                });
                return url.toString();
            }
            
            return fullUrl;
        }
        
        // 發送 HTTP GET 請求
        async function sendHttpRequest(mac = null) {
            const url = buildHttpUrl(mac);
            if (!url) {
                updateHttpStatus(false, '配置錯誤');
                return null;
            }
            
            httpLastRequestTime = Date.now();
            httpRequestCount++;
            
            // 更新請求計數顯示
            const countElement = document.getElementById('http-request-count');
            if (countElement) {
                countElement.textContent = httpRequestCount;
            }
            
            console.log(`📤 [${httpRequestCount}] 發送 HTTP GET 請求: ${url}`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), httpConfig.timeout);
                
                let response;
                
                // 第一次嘗試：正常 CORS 請求
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: httpConfig.headers || {},
                        signal: controller.signal,
                        mode: 'cors'
                    });
                } catch (corsError) {
                    clearTimeout(timeoutId);
                    
                    // 嘗試使用 CORS 代理服務
                    console.warn('❌ 直接請求失敗，嘗試 CORS 代理服務...');
                    
                    // 改進的代理配置 - 使用更可靠的格式
                    const proxyConfigs = [
                        { 
                            name: 'AllOrigins (GET)', 
                            buildUrl: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&pretty=true`,
                            parseResponse: async (response) => {
                                const data = await response.json();
                                return data.contents;
                            }
                        },
                        { 
                            name: 'CORS-Anywhere', 
                            buildUrl: (targetUrl) => `https://cors-anywhere.herokuapp.com/${targetUrl}`,
                            parseResponse: async (response) => response.text()
                        },
                        { 
                            name: 'HTTP-Proxy', 
                            buildUrl: (targetUrl) => {
                                // 移除 http:// 前綴，以適應某些代理
                                const cleanUrl = targetUrl.replace(/^https?:\/\//, '');
                                return `https://httpbin.org/get?url=${encodeURIComponent(targetUrl)}`;
                            },
                            parseResponse: async (response) => {
                                const data = await response.json();
                                return data.args.url || JSON.stringify(data);
                            }
                        }
                    ];
                    
                    let proxySuccess = false;
                    
                    for (const proxyConfig of proxyConfigs) {
                        try {
                            const proxyUrl = proxyConfig.buildUrl(url);
                            console.log(`🔄 嘗試代理 (${proxyConfig.name}): ${proxyUrl.substring(0, 80)}...`);
                            
                            const proxyResponse = await fetch(proxyUrl, {
                                signal: controller.signal,
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json, text/plain, */*'
                                }
                            });
                            
                            if (proxyResponse.ok) {
                                let parsedData;
                                
                                try {
                                    parsedData = await proxyConfig.parseResponse(proxyResponse);
                                } catch (parseErr) {
                                    console.warn(`⚠️ 代理回應解析失敗:`, parseErr);
                                    parsedData = await proxyResponse.text();
                                }
                                
                                // 嘗試解析為 JSON
                                if (typeof parsedData === 'string') {
                                    try {
                                        parsedData = JSON.parse(parsedData);
                                    } catch (jsonErr) {
                                        // 不是 JSON，維持文字格式
                                    }
                                }
                                
                                httpLastResponse = parsedData;
                                console.log(`✅ 代理請求成功 (${proxyConfig.name}):`, parsedData);
                                updateHttpStatus(true, `✅ 已透過 ${proxyConfig.name} 代理取得資料 (${new Date().toLocaleTimeString()})`);
                                
                                // 代理成功時進行資料處理
                                handleHttpResponse(parsedData);
                                httpErrorCount = 0;
                                
                                proxySuccess = true;
                                return parsedData;
                            } else {
                                console.warn(`⚠️ 代理 ${proxyConfig.name} 返回 HTTP ${proxyResponse.status}`);
                            }
                        } catch (proxyError) {
                            console.warn(`❌ 代理 ${proxyConfig.name} 失敗:`, proxyError.message);
                            continue;
                        }
                    }
                    
                    if (!proxySuccess) {
                        // 所有代理都失敗
                        console.error('❌ CORS 錯誤:', corsError.message);
                        console.error('📝 所有代理服務均失敗，可選方案：');
                        console.log('   1️⃣ 檢查網路連線是否正常');
                        console.log('   2️⃣ 檢查目標伺服器 ' + url + ' 是否在線');
                        console.log('   3️⃣ 在新分頁中直接訪問此 URL 測試');
                        console.log('   4️⃣ 聯繫後端管理員啟用 CORS 支持');
                        
                        updateHttpStatus(false, '❌ 網路連線或伺服器異常 - 請檢查');
                        
                        httpErrorCount++;
                        const errorCountElement = document.getElementById('http-error-count');
                        if (errorCountElement) {
                            errorCountElement.textContent = httpErrorCount;
                        }
                        
                        // 記錄到命令日誌
                        addCommandLog('error', `HTTP 請求失敗: ${corsError.message}`, {
                            url: url,
                            error: corsError.message
                        });
                        
                        return null;
                    }
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 嘗試解析回應
                let data;
                const contentType = response.headers.get('content-type');
                
                try {
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }
                } catch (parseError) {
                    console.warn('⚠️ 無法解析回應:', parseError);
                    data = await response.text();
                }
                
                httpLastResponse = data;
                httpErrorCount = 0; // 重置錯誤計數
                
                console.log('📥 收到回應:', data);
                console.log('📊 資料類型:', typeof data);
                console.log('📏 資料長度:', typeof data === 'string' ? data.length : JSON.stringify(data).length);
                
                updateHttpStatus(true, '請求成功');
                
                // 處理回應資料
                handleHttpResponse(data);
                
                return data;
                
            } catch (error) {
                httpErrorCount++;
                
                // 更新錯誤計數顯示
                const errorCountElement = document.getElementById('http-error-count');
                if (errorCountElement) {
                    errorCountElement.textContent = httpErrorCount;
                }
                
                console.error(`❌ HTTP 請求失敗 (${httpErrorCount}):`, error.message);
                console.error('錯誤詳情:', error);
                
                if (error.name === 'AbortError') {
                    updateHttpStatus(false, '請求超時');
                } else if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    updateHttpStatus(false, 'CORS 錯誤');
                } else {
                    updateHttpStatus(false, `錯誤: ${error.message}`);
                }
                
                return null;
            }
        }
        
        // 處理 HTTP 回應資料
        // 每日記錄管理函數 - 重構版本（使用機台編號+位置+日期作為 key）
        function updateDailyRecord(machineId, location, plays, payouts, date = null) {
            console.log(`📝 檢查並更新每日記錄 - 機台: ${machineId}/${location}, plays: ${plays}, payouts: ${payouts}`);
            
            // 初始化存儲
            if (!window.dailyRecords) {
                window.dailyRecords = {};
            }
            
            // 使用提供的日期或取得今天的日期
            const recordDate = date || new Date().toISOString().split('T')[0];
            const recordKey = `${machineId}_${location}_${recordDate}`;
            
            // 獲取該機台今天的記錄
            let todayRecord = window.dailyRecords[recordKey];
            
            if (!todayRecord) {
                // 新建今天的記錄
                todayRecord = {
                    machineId: machineId,
                    location: location,
                    date: recordDate,
                    plays: plays,
                    payouts: payouts,
                    createdAt: new Date().toLocaleString('zh-TW'),
                    updatedAt: new Date().toLocaleString('zh-TW'),
                    updateCount: 1,
                    history: [{
                        timestamp: new Date().toLocaleTimeString('zh-TW'),
                        plays: plays,
                        payouts: payouts
                    }]
                };
                window.dailyRecords[recordKey] = todayRecord;
                console.log(`✅ 新建今日記錄 - 機台: ${machineId}/${location}, 日期: ${recordDate}, plays: ${plays}, payouts: ${payouts}`);
                
                return { status: 'created', record: todayRecord };
            }
            
            // 與今天的記錄比對
            const isChanged = (todayRecord.plays !== plays) || (todayRecord.payouts !== payouts);
            
            if (isChanged) {
                // 數據有變化，更新記錄
                console.log(`🔄 數據有變化 - 舊: plays=${todayRecord.plays}, payouts=${todayRecord.payouts}, 新: plays=${plays}, payouts=${payouts}`);
                
                // 保存到歷史記錄
                todayRecord.history.push({
                    timestamp: new Date().toLocaleTimeString('zh-TW'),
                    plays: plays,
                    payouts: payouts
                });
                
                // 更新主記錄
                todayRecord.plays = plays;
                todayRecord.payouts = payouts;
                todayRecord.updatedAt = new Date().toLocaleString('zh-TW');
                todayRecord.updateCount = (todayRecord.updateCount || 0) + 1;
                
                window.dailyRecords[recordKey] = todayRecord;
                console.log(`✅ 已更新今日記錄 - 機台: ${machineId}/${location}, plays: ${plays}, payouts: ${payouts}, 更新次數: ${todayRecord.updateCount}`);
                
                return { status: 'updated', record: todayRecord };
            } else {
                // 數據相同，不更新
                console.log(`ℹ️ 數據未變化 - 機台: ${machineId}/${location}, plays: ${plays}, payouts: ${payouts} (維持不變)`);
                return { status: 'unchanged', record: todayRecord };
            }
        }
        
        // 構建動態機台配置映射表 {MAC_devid} -> {machineId, location}
        function buildMachineConfigMap() {
            if (window.machineConfigMap) {
                return window.machineConfigMap;
            }
            
            window.machineConfigMap = {};
            
            if (!appData || !appData.machines) {
                console.warn('⚠️ appData.machines 未初始化');
                return window.machineConfigMap;
            }
            
            // 遍歷所有機台配置
            appData.machines.forEach(machine => {
                // 每個機台可能有 MAC 和 devid 信息
                if (machine.mac && machine.devidData) {
                    // 如果機台有多個 devid（如 devid=1 和 devid=2）
                    Object.keys(machine.devidData).forEach(devid => {
                        const mapKey = `${machine.mac}_${devid}`;
                        window.machineConfigMap[mapKey] = {
                            machineId: machine.id,
                            location: machine.location,
                            mac: machine.mac,
                            devid: parseInt(devid)
                        };
                        console.log(`📌 映射: ${mapKey} -> ${machine.id}/${machine.location}`);
                    });
                } else if (machine.mac && machine.devid) {
                    // 簡單情況：單個 devid
                    const mapKey = `${machine.mac}_${machine.devid}`;
                    window.machineConfigMap[mapKey] = {
                        machineId: machine.id,
                        location: machine.location,
                        mac: machine.mac,
                        devid: parseInt(machine.devid)
                    };
                    console.log(`📌 映射: ${mapKey} -> ${machine.id}/${machine.location}`);
                }
            });
            
            console.log(`✅ 已構建機台配置映射表，共 ${Object.keys(window.machineConfigMap).length} 條映射`);
            return window.machineConfigMap;
        }
        
        // 刷新自動記帳表格
        function refreshAutoRecordTable() {
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.warn('⚠️ 找不到自動記帳表格');
                return;
            }
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 檢查是否有記錄
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">暫無記錄</td></tr>';
                return;
            }
            
            // 按日期排序記錄
            const sortedRecords = Object.values(window.dailyRecords)
                .sort((a, b) => {
                    // 先按日期降序（新的在前）
                    const dateCompare = new Date(b.date) - new Date(a.date);
                    if (dateCompare !== 0) return dateCompare;
                    // 相同日期按機台編號和位置排序
                    if (a.machineId !== b.machineId) {
                        return a.machineId.localeCompare(b.machineId);
                    }
                    return a.location.localeCompare(b.location);
                });
            
            // 填充表格
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                const statusIcon = record.updateCount > 1 ? '🔄' : '✨';
                const machineLabel = `${record.machineId} / ${record.location}`;
                
                row.innerHTML = `
                    <td class="p-4">${record.date}</td>
                    <td class="p-4 font-semibold text-blue-400">${machineLabel}</td>
                    <td class="p-4 text-right font-semibold text-blue-300">${record.plays.toLocaleString()}</td>
                    <td class="p-4 text-right font-semibold text-green-300">${record.payouts.toLocaleString()}</td>
                    <td class="p-4 text-center">${statusIcon} ${record.updateCount}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.updatedAt}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.createdAt}</td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log(`✅ 已刷新自動記帳表格，共 ${sortedRecords.length} 筆記錄`);
        }
        
        // 建立 devid 與機台的映射關係
        function buildDevidMachineMap() {
            if (!window.devidMachineMap) {
                window.devidMachineMap = {
                    1: { label: '左天車', machineId: 'A001', location: '上1' },
                    2: { label: '右天車', machineId: 'A001', location: '上2' }
                };
            }
            return window.devidMachineMap;
        }
        
        // 從輪詢帶入數據到表單
        function importFromPoll() {
            console.log('📥 從輪詢帶入數據...');
            
            // 檢查是否有輪詢數據
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('❌ 暫無輪詢數據，請先進行輪詢');
                return;
            }
            
            // 建構動態機台映射
            buildMachineConfigMap();
            
            const today = new Date().toISOString().split('T')[0];
            
            // 優先取最新的記錄（從 appData.machines 中尋找）
            let selectedRecord = null;
            let selectedMachine = null;
            
            if (appData && appData.machines) {
                for (let machine of appData.machines) {
                    const recordKey = `${machine.id}_${machine.location}_${today}`;
                    if (window.dailyRecords[recordKey]) {
                        selectedRecord = window.dailyRecords[recordKey];
                        selectedMachine = machine;
                        console.log(`✅ 找到記錄: ${recordKey}`, selectedRecord);
                        break;
                    }
                }
            }
            
            if (!selectedRecord || !selectedMachine) {
                alert('❌ 找不到今天的輪詢記錄');
                return;
            }
            
            // 填入表單
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            
            // 填入日期
            if (entryDate) {
                entryDate.value = selectedRecord.date;
            }
            
            // 填入投幣數和出獎數
            if (cumulativePlays) {
                cumulativePlays.value = selectedRecord.plays;
            }
            if (cumulativePayouts) {
                cumulativePayouts.value = selectedRecord.payouts;
            }
            
            // 選擇機台（使用 docId）
            if (machineSelector && selectedMachine) {
                machineSelector.value = selectedMachine.docId;
                console.log(`✅ 已選擇機台: ${selectedMachine.id}/${selectedMachine.location} (docId: ${selectedMachine.docId})`);
            }
            
            console.log(`✅ 已帶入數據: ${selectedRecord.machineId}/${selectedRecord.location}, plays=${selectedRecord.plays}, payouts=${selectedRecord.payouts}`);
        }
        
        // 批量新增所有機台記錄
        function batchAddAllMachines() {
            console.log('✅ 批量新增所有機台記錄...');
            
            // 檢查是否有輪詢數據
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('❌ 暫無輪詢數據，請先進行輪詢');
                return;
            }
            
            // 檢查 appData 和 machines
            if (!appData || !appData.machines || appData.machines.length === 0) {
                alert('❌ 沒有可用的機台列表');
                return;
            }
            
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            const dailyEntryForm = document.getElementById('daily-entry-form');
            
            if (!dailyEntryForm) {
                alert('❌ 找不到表單');
                return;
            }
            
            // 建構動態機台映射
            buildMachineConfigMap();
            
            const today = new Date().toISOString().split('T')[0];
            let addedCount = 0;
            let failedCount = 0;
            
            // 遍歷所有機台並查找對應的記錄
            for (let machine of appData.machines) {
                const recordKey = `${machine.id}_${machine.location}_${today}`;
                const record = window.dailyRecords[recordKey];
                
                if (record) {
                    console.log(`✅ 找到 ${machine.id}/${machine.location} 的記錄`);
                    
                    // 驗證選擇器中是否存在此機台
                    const options = Array.from(machineSelector.options);
                    const hasOption = options.some(opt => opt.value === machine.docId);
                    
                    if (!hasOption) {
                        console.warn(`⚠️ 機台選擇器中找不到 docId=${machine.docId}，跳過`);
                        failedCount++;
                        continue;
                    }
                    
                    // 選擇機台（使用 docId）
                    machineSelector.value = machine.docId;
                    
                    // 觸發 change 事件以自動填入投幣數和出獎數
                    machineSelector.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    console.log(`✅ 已設置選擇器: docId=${machine.docId}, value=${machineSelector.value}`);
                    
                    // 驗證選擇是否成功
                    if (machineSelector.value !== machine.docId) {
                        console.error(`❌ 設置選擇器失敗: 期望=${machine.docId}, 實際=${machineSelector.value}`);
                        failedCount++;
                        continue;
                    }
                    
                    // 設置日期（如果之前沒有自動填入）
                    if (!entryDate.value) {
                        entryDate.value = record.date;
                    }
                    
                    // 檢查是否需要覆蓋投幣數和出獎數（在某些情況下）
                    // 或保持 change 事件帶入的值
                    if (cumulativePlays.value === '' || parseInt(cumulativePlays.value) === 0) {
                        cumulativePlays.value = record.plays;
                    }
                    if (cumulativePayouts.value === '' || parseInt(cumulativePayouts.value) === 0) {
                        cumulativePayouts.value = record.payouts;
                    }
                    
                    console.log(`📋 表單已填入:`, {
                        date: entryDate.value,
                        machineDocId: machineSelector.value,
                        plays: cumulativePlays.value,
                        payouts: cumulativePayouts.value
                    });
                    
                    // 觸發表單提交
                    dailyEntryForm.dispatchEvent(new Event('submit'));
                    addedCount++;
                    
                    console.log(`✅ 已新增 ${machine.id}/${machine.location} 的記錄`);
                }
            }
            
            if (addedCount === 0) {
                alert(`❌ 找不到輪詢數據 (失敗: ${failedCount})`);
            } else {
                const message = failedCount > 0 
                    ? `✅ 已成功新增 ${addedCount} 筆機台記錄 (失敗: ${failedCount})`
                    : `✅ 已成功新增 ${addedCount} 筆機台記錄`;
                alert(message);
                
                // 批量新增完成後，清除 HTTP 輪詢自動記帳表格
                console.log('🗑️ 清除 HTTP 輪詢自動記帳表格...');
                window.dailyRecords = {};
                if (typeof refreshAutoRecordTable === 'function') {
                    refreshAutoRecordTable();
                }
            }
        }
        
        function handleHttpResponse(data, mac = null, devid = null) {
            console.log('🔄 處理 HTTP 回應資料:', data, 'MAC:', mac, 'DevID:', devid);
            
            // 更新最後回應顯示
            const lastResponseElement = document.getElementById('http-last-response');
            if (lastResponseElement) {
                if (typeof data === 'string') {
                    lastResponseElement.textContent = data.substring(0, 50) + (data.length > 50 ? '...' : '');
                } else {
                    lastResponseElement.textContent = JSON.stringify(data).substring(0, 50) + '...';
                }
            }
            
            // 添加到命令記錄
            addCommandLog('success', `收到回應資料：${JSON.stringify(data).substring(0, 100)}...`, {
                timestamp: new Date().toLocaleTimeString(),
                dataPreview: data
            });
            
            // 初始化 devid 對應的存儲
            if (!window.machineDataByDevid) {
                window.machineDataByDevid = {};
            }
            
            // 如果是陣列，優先按指定的 devid 解析，否則解析所有 devid
            if (Array.isArray(data)) {
                console.log('📊 檢測到陣列數據，處理多 devid... (指定DevID:', devid, ')');
                
                if (devid !== null && devid !== undefined) {
                    // ✅ 優先按指定的 devid 解析
                    console.log(`⭐ 優先解析指定的 devid: ${devid}`);
                    const parsedData = parseHttpData(data, devid);
                    
                    if (parsedData && parsedData.plays !== null) {
                        window.machineDataByDevid[devid] = parsedData;
                        console.log(`✅ devid ${devid} 數據已儲存:`, parsedData);
                        
                        // 📝 使用新的 updateDailyRecord 簽名
                        // 从 MAC + devid 获取 machineId 和 location
                        buildMachineConfigMap(); // 确保映射已构建
                        const mapKey = `${mac}_${devid}`;
                        const machineConfig = window.machineConfigMap[mapKey];
                        
                        if (machineConfig) {
                            const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                            console.log(`📋 每日記錄更新結果 (${recordResult.status}):`, recordResult.record);
                        } else {
                            console.warn(`⚠️ 找不到機台配置: ${mapKey}，跳過記錄更新`);
                        }
                        
                        // 🔄 刷新自動記帳表格
                        refreshAutoRecordTable();
                        
                        updateMachineDataDisplay(parsedData, devid);
                    }
                } else {
                    // 如果沒指定 devid，則提取所有唯一的 devid
                    const devidSet = new Set();
                    data.forEach(record => {
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.devid) {
                                    devidSet.add(parseInt(parsed.devid));
                                }
                            } catch (e) {}
                        }
                    });
                    
                    console.log('🔍 找到的 devid:', Array.from(devidSet));
                    
                    // 為每個 devid 解析最新數據
                    devidSet.forEach(targetDevid => {
                        const parsedData = parseHttpData(data, targetDevid);
                        
                        if (parsedData && parsedData.plays !== null) {
                            window.machineDataByDevid[targetDevid] = parsedData;
                            console.log(`✅ devid ${targetDevid} 數據已儲存:`, parsedData);
                            
                            // 📝 使用新的 updateDailyRecord 簽名
                            // 从 MAC + devid 获取 machineId 和 location
                            buildMachineConfigMap(); // 确保映射已构建
                            const mapKey = `${mac}_${targetDevid}`;
                            const machineConfig = window.machineConfigMap[mapKey];
                            
                            if (machineConfig) {
                                const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                                console.log(`📋 每日記錄更新結果 (${recordResult.status}):`, recordResult.record);
                            } else {
                                console.warn(`⚠️ 找不到機台配置: ${mapKey}，跳過記錄更新`);
                            }
                            
                            // 🔄 刷新自動記帳表格
                            refreshAutoRecordTable();
                            
                            // 顯示該 devid 的數據
                            updateMachineDataDisplay(parsedData, targetDevid);
                        }
                    });
                }
                
                // 儲存到全域變數供後續使用
                window.lastParsedMachineData = window.machineDataByDevid;
            } else {
                // 單個數據處理
                const parsedData = parseHttpData(data, devid);
                
                // 如果成功解析，記錄提取的數據
                if (parsedData) {
                    console.log('✅ 數據解析成功:', parsedData);
                    
                    // 按 devid 儲存
                    if (parsedData.devid || devid) {
                        const saveDevid = parsedData.devid || devid;
                        if (!window.machineDataByDevid) {
                            window.machineDataByDevid = {};
                        }
                        window.machineDataByDevid[saveDevid] = parsedData;
                        console.log(`💾 devid ${saveDevid} 數據已保存`);
                    }
                    
                    // 更新 UI 中顯示的機台數據
                    updateMachineDataDisplay(parsedData, devid);
                    
                    // 儲存到全域變數供後續使用
                    window.lastParsedMachineData = parsedData;
                } else {
                    console.warn('⚠️ 無法解析數據');
                }
            }
        }
        
        // 解析 HTTP 回應數據 - 支持多種格式和多個 devid
        function parseHttpData(data, targetDevid = null) {
            try {
                console.log('📥 開始解析數據，類型:', typeof data, targetDevid ? `，目標 devid: ${targetDevid}` : '');
                
                // 情況 1: 如果是陣列，尋找對應 devid 的 re_readdata 命令
                if (Array.isArray(data)) {
                    console.log('🔍 檢測到陣列結構，共 ' + data.length + ' 條記錄');
                    
                    // 先列出所有 re_readdata 記錄以便調試
                    const reReadRecords = [];
                    for (let i = 0; i < data.length; i++) {
                        const record = data[i];
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.cmd === 're_readdata' && parsed.parm) {
                                    reReadRecords.push({
                                        index: i,
                                        date: record.date,
                                        devid: parsed.devid,
                                        timestamp: new Date(record.date).getTime(),
                                        record: record,
                                        parsed: parsed
                                    });
                                }
                            } catch (e) {}
                        }
                    }
                    
                    if (reReadRecords.length > 0) {
                        console.log('📋 發現所有 re_readdata 記錄:');
                        reReadRecords.forEach(r => console.log(`   [${r.index}] ${r.date} (devid=${r.devid})`));
                    }
                    
                    // ✅ 關鍵修正：按時間戳排序，找最新的符合條件的記錄
                    // 如果指定了 devid，則先過濾該 devid，再按時間排序
                    let targetRecords = reReadRecords;
                    if (targetDevid !== null) {
                        targetRecords = reReadRecords.filter(r => parseInt(r.devid) == parseInt(targetDevid));
                        console.log(`🔎 過濾 devid=${targetDevid} 的記錄，找到 ${targetRecords.length} 條`);
                    }
                    
                    if (targetRecords.length > 0) {
                        // 按時間戳倒序排列（最新的在前）
                        targetRecords.sort((a, b) => b.timestamp - a.timestamp);
                        const newestRecord = targetRecords[0];
                        
                        console.log(`✅ 選擇最新記錄: [${newestRecord.index}] ${newestRecord.date} (devid=${newestRecord.devid})`);
                        console.log(`   時間戳: ${newestRecord.timestamp}, 比較其他記錄:`);
                        targetRecords.slice(1, 3).forEach(r => console.log(`   - [${r.index}] ${r.date}`));
                        
                        return parseReReadData(newestRecord.parsed);
                    }
                    
                    // 如果指定了 devid 但沒找到，記錄
                    if (targetDevid !== null) {
                        console.warn(`⚠️ 未找到 devid ${targetDevid} 的 re_readdata 命令`);
                    } else {
                        console.warn('⚠️ 未找到有效的 re_readdata 命令');
                    }
                    
                    return {
                        plays: null,
                        payouts: null,
                        timestamp: new Date().toLocaleTimeString('zh-TW'),
                        format: 'array_no_data',
                        hasData: false,
                        devid: targetDevid
                    };
                }
                
                let jsonData = data;
                
                // 情況 2: 如果是字符串，嘗試解析為 JSON
                if (typeof data === 'string') {
                    // 嘗試 JSON 解析
                    try {
                        jsonData = JSON.parse(data);
                        // 如果解析後是陣列，遞歸處理
                        if (Array.isArray(jsonData)) {
                            return parseHttpData(jsonData, targetDevid);
                        }
                    } catch (e) {
                        // 如果不是有效的 JSON，嘗試提取數據
                        console.log('📄 接收到文本數據，嘗試提取結構化信息...');
                        return parseTextData(data);
                    }
                }
                
                // 情況 3: 如果是對象
                if (typeof jsonData === 'object' && jsonData !== null) {
                    // 首先檢查是否是 re_readdata 命令
                    if (jsonData.cmd === 're_readdata' && jsonData.parm) {
                        console.log('🔍 檢測到 re_readdata 命令，解析 parm 字段...');
                        return parseReReadData(jsonData);
                    }
                    // 否則使用通用 JSON 解析
                    return extractMachineData(jsonData);
                }
                
                return null;
            } catch (error) {
                console.error('❌ 數據解析失敗:', error);
                return null;
            }
        }
        
        // 解析 re_readdata 命令的 parm 十六進位字段
        function parseReReadData(jsonData) {
            console.log('⚙️ 解析 re_readdata 協議數據...');
            
            const result = {
                raw: jsonData,
                plays: null,        // 累積投幣數
                payouts: null,      // 累積出獎次數
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 're_readdata',
                hasData: false
            };
            
            try {
                const parm = jsonData.parm;
                if (!parm || typeof parm !== 'string') {
                    console.warn('⚠️ parm 字段無效');
                    return result;
                }
                
                console.log('📝 parm 十六進位字符串: ' + parm);
                console.log('📊 parm 字符串長度: ' + parm.length + ' 字符 (' + (parm.length / 2) + ' 字節)');
                
                // 保存到全局變數便於查詢
                if (!window.parmByDevid) window.parmByDevid = {};
                window.parmByDevid[jsonData.devid] = parm;
                console.log(`💾 已保存到 window.parmByDevid[${jsonData.devid}]`);
                
                // 將十六進位字符串轉換為字節陣列
                const bytes = [];
                for (let i = 0; i < parm.length; i += 2) {
                    const hex = parm.substring(i, i + 2);
                    bytes.push(parseInt(hex, 16));
                }
                
                console.log('🔍 前 40 個字節值(十進位): ' + bytes.slice(0, 40).join(', '));
                
                // ✅ 主要位置: 嘗試多個已知位置
                // ✅ 主要位置: 投幣數和出貨次數位置
                // 根據實際 parm 數據分析：
                // 字節: ... 11, 0, 1, 40, 0, 0, 135, 0, 9, 0, 210, 0, 94, 1, ...
                // 位置: ... 26 27 28 29 30 31 32  33 34 35 36   37 38  39 ...
                //
                // Byte[32] = 135, Byte[33] = 0   → plays = 135 + (0 << 8) = 135 ✅
                // Byte[34] = 9,   Byte[35] = 0   → payouts = 9 + (0 << 8) = 9 ✅
                
                console.log(`🔍 devid=${parseInt(jsonData.devid) || 1}, 嘗試多個位置...`);
                
                // 📍 正確位置 (32-35)
                if (bytes.length >= 36) {
                    const plays = bytes[32] + (bytes[33] << 8);
                    const payouts = bytes[34] + (bytes[35] << 8);
                    const isValid = isValidPair(plays, payouts);
                    
                    console.log(`📍 試 位置32-35 (正確位置): bytes[32]=${bytes[32]?.toString(16).padStart(2,'0')}, bytes[33]=${bytes[33]?.toString(16).padStart(2,'0')}, bytes[34]=${bytes[34]?.toString(16).padStart(2,'0')}, bytes[35]=${bytes[35]?.toString(16).padStart(2,'0')} → plays=${plays}, payouts=${payouts}, 有效=${isValid}`);
                    
                    if (isValid) {
                        result.plays = plays;
                        result.payouts = payouts;
                        result.hasData = true;
                        console.log(`✅ 位置32-35 成功提取: plays=${plays}, payouts=${payouts}`);
                        return result;
                    } else {
                        console.log(`⚠️ 位置32-35 數據無效，嘗試備用位置...`);
                    }
                }
                
                // 🔄 備用位置: 嘗試其他已知位置
                const knownPositions = [
                    {name: '位置36-39', start: 36},
                    {name: '位置42-45', start: 42},
                    {name: '位置52-55', start: 52}
                ];
                
                for (const pos of knownPositions) {
                    if (bytes.length >= pos.start + 4) {
                        const plays = bytes[pos.start] + (bytes[pos.start+1] << 8);
                        const payouts = bytes[pos.start+2] + (bytes[pos.start+3] << 8);
                        const isValid = isValidPair(plays, payouts);
                        
                        console.log(`📍 試 ${pos.name}: bytes[${pos.start}]=${bytes[pos.start]?.toString(16).padStart(2,'0')}, bytes[${pos.start+1}]=${bytes[pos.start+1]?.toString(16).padStart(2,'0')}, bytes[${pos.start+2}]=${bytes[pos.start+2]?.toString(16).padStart(2,'0')}, bytes[${pos.start+3}]=${bytes[pos.start+3]?.toString(16).padStart(2,'0')} → plays=${plays}, payouts=${payouts}, 有效=${isValid}`);
                        
                        if (isValid) {
                            result.plays = plays;
                            result.payouts = payouts;
                            result.hasData = true;
                            console.log(`✅ ${pos.name} 成功提取: plays=${plays}, payouts=${payouts}`);
                            return result;
                        }
                    }
                }
                
                // 備用位置: 多個固定位置 (4字節)
                const positions = [
                    {name: '位置A (2-6, 6-10)', plays: [2, 6], payouts: [6, 10]},
                    {name: '位置B (4-8, 8-12)', plays: [4, 8], payouts: [8, 12]},
                    {name: '位置C (8-12, 12-16)', plays: [8, 12], payouts: [12, 16]},
                    {name: '位置D (10-14, 14-18)', plays: [10, 14], payouts: [14, 18]},
                    {name: '位置E (16-20, 20-24)', plays: [16, 20], payouts: [20, 24]},
                    {name: '位置F (18-22, 22-26)', plays: [18, 22], payouts: [22, 26]},
                    {name: '位置G (24-28, 28-32)', plays: [24, 28], payouts: [28, 32]},
                ];
                
                console.log('🔎 嘗試備用 4字節位置...');
                for (const pos of positions) {
                    if (bytes.length >= pos.payouts[1]) {
                        const p1 = bytes[pos.plays[0]] | (bytes[pos.plays[0]+1] << 8) | (bytes[pos.plays[0]+2] << 16) | (bytes[pos.plays[0]+3] << 24);
                        const p2 = bytes[pos.payouts[0]] | (bytes[pos.payouts[0]+1] << 8) | (bytes[pos.payouts[0]+2] << 16) | (bytes[pos.payouts[0]+3] << 24);
                        
                        console.log(`  試 ${pos.name}: plays=${p1}, payouts=${p2}`);
                        
                        if (isValidPair(p1, p2)) {
                            result.plays = p1;
                            result.payouts = p2;
                            result.hasData = true;
                            console.log(`✅ ${pos.name} 成功: plays=${p1}, payouts=${p2}`);
                            return result;
                        }
                    }
                }
                
                // 備用方法: 動態掃描 - 嘗試所有可能的 4 字節對
                console.log('🔎 開始動態掃描所有 4字節 位置...');
                for (let i = 0; i < bytes.length - 15; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8) | (bytes[i+2] << 16) | (bytes[i+3] << 24);
                    const val2 = bytes[i+4] | (bytes[i+5] << 8) | (bytes[i+6] << 16) | (bytes[i+7] << 24);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`✅ 動態掃描成功 (位置 ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                // 備用方法: 嘗試 2 字節組合 (動態)
                console.log('🔎 嘗試 2字節組合 (動態掃描)...');
                for (let i = 0; i < bytes.length - 3; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8);
                    const val2 = bytes[i+2] | (bytes[i+3] << 8);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`✅ 2字節成功 (位置 ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                console.warn('⚠️ 嘗試了所有方法，無法從 parm 中提取有效數據');
                console.log('💡 parm 樣本: ' + parm);
                result.hasData = false;
                
            } catch (error) {
                console.error('❌ re_readdata 解析錯誤:', error);
                result.hasData = false;
            }
            
            return result;
        }
        
        // 驗證投幣和出獎數據是否有效
        function isValidPair(plays, payouts) {
            // 投幣數應該大於 0，小於 100 萬
            // 出獎數應該大於等於 0，小於等於投幣數，小於 100 萬
            const playsValid = plays > 0 && plays < 1000000;
            const payoutsValid = payouts >= 0 && payouts <= plays && payouts < 1000000;
            
            return playsValid && payoutsValid;
        }
        
        // 從文本格式解析數據
        function parseTextData(textData) {
            console.log('🔍 分析文本數據結構...');
            
            const result = {
                raw: textData,
                plays: null,        // 累積投幣數
                payouts: null,      // 累積出貨次數
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'text'
            };
            
            // 嘗試多種常見的分隔符格式
            // 格式 1: "plays:123,payouts:456" 或類似
            const colonFormat = textData.match(/plays[:\s]+(\d+).*?payouts[:\s]+(\d+)/i);
            if (colonFormat) {
                result.plays = parseInt(colonFormat[1]);
                result.payouts = parseInt(colonFormat[2]);
                console.log('✅ 格式識別: 冒號分隔符');
                return result;
            }
            
            // 格式 2: "123,456" (假設第一個數字是投幣，第二個是出貨)
            const commaFormat = textData.match(/^(\d+)[,\s]+(\d+)$/);
            if (commaFormat) {
                result.plays = parseInt(commaFormat[1]);
                result.payouts = parseInt(commaFormat[2]);
                console.log('✅ 格式識別: 逗號分隔符');
                return result;
            }
            
            // 格式 3: 換行分隔 "123\n456"
            const lineFormat = textData.match(/(\d+)\s+(\d+)/);
            if (lineFormat) {
                result.plays = parseInt(lineFormat[1]);
                result.payouts = parseInt(lineFormat[2]);
                console.log('✅ 格式識別: 空白分隔符');
                return result;
            }
            
            // 格式 4: 只提取所有數字
            const numbers = textData.match(/\d+/g);
            if (numbers && numbers.length >= 2) {
                result.plays = parseInt(numbers[0]);
                result.payouts = parseInt(numbers[1]);
                console.log('✅ 格式識別: 自動提取數字');
                return result;
            }
            
            return null;
        }
        
        // 從 JSON 對象提取機台數據
        function extractMachineData(jsonData) {
            console.log('📦 分析 JSON 結構...');
            
            const result = {
                raw: jsonData,
                plays: null,
                payouts: null,
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'json'
            };
            
            // 常見的欄位名稱列表
            const playsKeywords = ['plays', 'play', 'coins', 'coin', '投幣', '投币', 'investment', 'cumulative_plays', 'total_plays', 'count'];
            const payoutsKeywords = ['payouts', 'payout', 'dispense', 'dispenses', '出貨', '出货', 'distribution', 'cumulative_payouts', 'total_payouts', 'times'];
            
            // 尋找投幣數
            for (const key of playsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.plays = parseInt(jsonData[key]);
                    console.log(`✅ 找到投幣欄位: "${key}" = ${result.plays}`);
                    break;
                }
            }
            
            // 如果沒找到，嘗試查找嵌套欄位
            if (result.plays === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of playsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.plays = parseInt(jsonData[key][subKey]);
                                console.log(`✅ 找到嵌套投幣欄位: "${key}.${subKey}" = ${result.plays}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // 尋找出貨次數
            for (const key of payoutsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.payouts = parseInt(jsonData[key]);
                    console.log(`✅ 找到出貨欄位: "${key}" = ${result.payouts}`);
                    break;
                }
            }
            
            // 如果沒找到，嘗試查找嵌套欄位
            if (result.payouts === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of payoutsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.payouts = parseInt(jsonData[key][subKey]);
                                console.log(`✅ 找到嵌套出貨欄位: "${key}.${subKey}" = ${result.payouts}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // 如果還是沒找到，嘗試按位置猜測（第一個和第二個數字值）
            if (result.plays === null || result.payouts === null) {
                let numberCount = 0;
                for (const key in jsonData) {
                    const value = jsonData[key];
                    if (typeof value === 'number' && !isNaN(value)) {
                        numberCount++;
                        if (numberCount === 1 && result.plays === null) {
                            result.plays = value;
                            console.log(`⚠️ 按位置推測投幣欄位: "${key}" = ${result.plays}`);
                        } else if (numberCount === 2 && result.payouts === null) {
                            result.payouts = value;
                            console.log(`⚠️ 按位置推測出貨欄位: "${key}" = ${result.payouts}`);
                        }
                    }
                }
            }
            
            return result;
        }
        
        // 更新 UI 顯示機台數據 - 支持多 devid
        function updateMachineDataDisplay(machineData, devid = null) {
            console.log('🖼️ 更新 UI 顯示:', machineData, 'devid:', devid);
            
            if (!machineData) {
                console.warn('⚠️ 無效的數據對象');
                return;
            }
            
            // 查找命令記錄容器的父容器
            const commandLogParent = document.getElementById('mqtt-command-log')?.parentElement;
            if (!commandLogParent) {
                console.warn('⚠️ 找不到命令記錄容器');
                return;
            }
            
            // 根據 devid 生成唯一的容器 ID
            const containerId = devid ? `machine-data-display-devid-${devid}` : 'machine-data-display';
            const displayLabel = devid ? `天車 ${devid === 1 ? '左' : devid === 2 ? '右' : devid}` : '機台';
            
            // 查找或創建顯示容器
            let displayContainer = document.getElementById(containerId);
            
            if (!displayContainer) {
                // 創建新的顯示容器
                displayContainer = document.createElement('div');
                displayContainer.id = containerId;
                displayContainer.className = 'mt-4 p-4 bg-gray-800/50 rounded-lg border-l-4 border-blue-500';
                
                // 插入到命令記錄容器的下方
                commandLogParent.appendChild(displayContainer);
                console.log(`✅ 已創建 ${displayLabel} 數據顯示容器`);
            }
            
            // 構建 HTML 內容
            let html = `<h4 class="text-sm font-medium text-yellow-300 mb-3">📊 ${displayLabel}數據解析結果</h4>`;
            
            // 檢查是否有有效的數據
            const hasValidData = machineData.plays !== null || machineData.payouts !== null;
            const isReReadData = machineData.format === 're_readdata';
            
            // 如果是 re_readdata 但沒有提取到數據
            if (isReReadData && !hasValidData && machineData.hasData === false) {
                html += `
                    <div class="bg-yellow-900/40 p-4 rounded-lg border border-yellow-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-yellow-300">⚠️ 無資訊更新</div>
                            <div class="text-xs text-yellow-200 mt-2">無法從伺服器回應中解析有效的投幣或出獎數據</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>命令: ${machineData.raw.cmd || 'N/A'}</div>
                                <div>MAC: ${machineData.raw.mac || 'N/A'}</div>
                                <div>格式: ${machineData.format} | 時間: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!hasValidData) {
                // 如果是其他格式且沒有有效的數據
                html += `
                    <div class="bg-orange-900/40 p-4 rounded-lg border border-orange-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-orange-300">⚠️ 無法識別數據</div>
                            <div class="text-xs text-orange-200 mt-2">無法從伺服器回應中提取投幣或出獎信息</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>格式: ${machineData.format} | 時間: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // 有效的數據顯示
                html += '<div class="grid grid-cols-2 gap-4 mb-3">';
                
                // 顯示投幣數
                if (machineData.plays !== null) {
                    html += `
                        <div class="bg-blue-900/50 p-4 rounded-lg border border-blue-500/50">
                            <div class="text-xs text-blue-300 font-semibold mb-1">✅ 投幣遊戲次數</div>
                            <div class="text-3xl font-bold text-blue-300">${machineData.plays.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">投幣遊戲次數</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                // 顯示出貨次數
                if (machineData.payouts !== null) {
                    html += `
                        <div class="bg-green-900/50 p-4 rounded-lg border border-green-500/50">
                            <div class="text-xs text-green-300 font-semibold mb-1">✅ 禮品出獎次數</div>
                            <div class="text-3xl font-bold text-green-300">${machineData.payouts.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">禮品出獎次數</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            // 顯示數據格式和時間戳
            const statusColor = isReReadData && !hasValidData ? 'text-yellow-400' : 'text-cyan-400';
            html += `<div class="text-xs text-gray-400 bg-gray-900/50 p-2 rounded">
                <div>格式: <span class="${statusColor} font-semibold">${machineData.format}</span> | 時間: <span class="text-cyan-400 font-semibold">${machineData.timestamp}</span></div>
            </div>`;
            
            displayContainer.innerHTML = html;
            
            if (hasValidData) {
                console.log('✅ UI 已成功更新 - 投幣數: ' + machineData.plays + ', 出獎數: ' + machineData.payouts);
            } else {
                console.log('⚠️ 無法提取有效的數據');
            }
        }
        
        // 開始 HTTP 輪詢
        function startHttpPolling() {
            if (httpPollingTimer) {
                console.log('⚠️ HTTP 輪詢已在運行中');
                return;
            }
            
            httpPollingEnabled = true;
            console.log(`🚀 開始 HTTP 輪詢（間隔: ${httpPollingInterval}ms）`);
            updateHttpStatus(true, '輪詢中...');
            
            // 立即發送第一次請求
            sendHttpRequest();
            
            // 設定定時輪詢
            httpPollingTimer = setInterval(() => {
                if (httpPollingEnabled) {
                    sendHttpRequest();
                }
            }, httpPollingInterval);
        }
        
        // 停止 HTTP 輪詢
        function stopHttpPolling() {
            if (httpPollingTimer) {
                clearInterval(httpPollingTimer);
                httpPollingTimer = null;
            }
            
            httpPollingEnabled = false;
            console.log('⏹️ HTTP 輪詢已停止');
            updateHttpStatus(false, '已停止');
        }
        
        // 更新 HTTP 連線狀態顯示
        function updateHttpStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator'); // 暫時使用 MQTT 的元素
            const statusText = document.getElementById('mqtt-status-text');
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                }
                if (statusText) {
                    statusText.textContent = `✅ HTTP 連線中 - ${message} - ${timeStr}`;
                }
            } else {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                }
                if (statusText) {
                    statusText.textContent = `❌ HTTP 未連線 - ${message} - ${timeStr}`;
                }
            }
            
            console.log(`📊 HTTP 狀態: ${connected ? '連線中' : '未連線'} - ${message}`);
        }
        
        // 測試 HTTP 連線
        async function testHttpConnection() {
            console.log('🧪 測試 HTTP 連線...');
            console.log('📍 目標 URL:', buildHttpUrl());
            console.log('🌐 當前域名:', window.location.origin);
            
            const result = await sendHttpRequest();
            
            if (result) {
                console.log('✅ HTTP 連線測試成功');
                alert('✅ HTTP 連線測試成功！\n\n數據已成功返回');
            } else {
                console.log('❌ HTTP 連線測試失敗');
                alert('❌ HTTP 連線測試失敗\n\n建議：\n1. 檢查目標伺服器是否在線\n2. 查看瀏覽器控制台 (F12) 的 Console 選項卡\n3. 確認網路連接是否正常');
            }
        }
        
        // 診斷 HTTP 連線問題
        async function diagnoseHttpConnection() {
            console.clear();
            console.log('🔍 ===== HTTP 連線診斷開始 =====');
            console.log('⏰ 診斷時間:', new Date().toLocaleString('zh-TW'));
            console.log('');
            
            console.log('📋 === 環境信息 ===');
            console.log('🌐 當前頁面 URL:', window.location.href);
            console.log('📍 當前域名:', window.location.hostname);
            console.log('🔗 當前協議:', window.location.protocol);
            console.log('');
            
            console.log('🎯 === 目標伺服器信息 ===');
            const targetUrl = buildHttpUrl();
            console.log('🔗 目標 URL:', targetUrl);
            console.log('📡 伺服器位址:', httpConfig.baseUrl);
            console.log('🔌 API 端點:', httpConfig.endpoint);
            console.log('');
            
            console.log('🧪 === 連線測試 ===');
            console.log('📤 嘗試直接請求...');
            
            try {
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });
                console.log('✅ 直接請求成功！');
                console.log('📊 HTTP 狀態碼:', response.status);
                console.log('📋 Content-Type:', response.headers.get('content-type'));
                const data = await response.text();
                console.log('📥 收到資料長度:', data.length, '字元');
                console.log('📄 資料預覽:', data.substring(0, 200));
            } catch (directError) {
                console.warn('❌ 直接請求失敗:', directError.message);
                console.log('🔄 嘗試代理服務...');
                
                // 嘗試最簡單的代理
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    console.log('🚀 代理 URL:', proxyUrl.substring(0, 100) + '...');
                    
                    const proxyResponse = await fetch(proxyUrl, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        console.log('✅ 代理請求成功！');
                        console.log('📝 代理回應:', proxyData.contents.substring(0, 200));
                    } else {
                        console.error('❌ 代理返回 HTTP', proxyResponse.status);
                    }
                } catch (proxyError) {
                    console.error('❌ 代理請求也失敗:', proxyError.message);
                    console.error('💥 根本原因：', proxyError.name);
                    
                    if (proxyError.message.includes('ERR_NAME_NOT_RESOLVED')) {
                        console.error('🔴 DNS 解析失敗 - 可能的原因：');
                        console.error('  • 網路連線中斷');
                        console.error('  • 域名伺服器無響應');
                        console.error('  • 防火牆或代理阻止');
                    }
                }
            }
            
            console.log('');
            console.log('🔍 ===== 診斷結束 =====');
        }
        
        // 把診斷函數暴露到全域
        window.diagnoseHttpConnection = diagnoseHttpConnection;
        
        // 讓 HTTP 函數在全域範圍可用
        window.startHttpPolling = startHttpPolling;
        window.stopHttpPolling = stopHttpPolling;
        window.testHttpConnection = testHttpConnection;
        window.sendHttpRequest = sendHttpRequest;
        
        // ========================================
        // MQTT 配置（已棄用）
        // ========================================
        const mqttConfig = {
            keepalive: 60,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30000,
            will: {
                topic: 'client/disconnect',
                payload: 'Client Disconnected',
                qos: 0,
                retain: false
            }
        };
        
        // MQTT 連線狀態管理
        function updateMqttStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator');
            const statusText = document.getElementById('mqtt-status-text');
            const connectBtn = document.getElementById('mqtt-connect-btn');
            const testBtn = document.getElementById('mqtt-test-btn');
            const diagnoseBtn = document.getElementById('mqtt-diagnose-btn');
            const businessTestBtn = document.getElementById('mqtt-business-test-btn');
            const readBtn = document.getElementById('send-read-command');
            
            // 更新最後更新時間
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                statusText.textContent = '✅ 已連接 - ' + timeStr;
                connectBtn.innerHTML = '<span>中斷連接</span>';
                connectBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // 啟用測試按鈕、診斷按鈕、營業測試按鈕和讀取按鈕
                if (testBtn) {
                    testBtn.disabled = false;
                    testBtn.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = false;
                    diagnoseBtn.className = 'flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = false;
                    businessTestBtn.className = 'flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = false;
                    readBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition';
                }
                
                // 重置重連次數
                mqttReconnectAttempts = 0;
                
                // 啟動心跳檢測
                startMqttHeartbeat();
                
            } else {
                // 根據狀態設置不同的指示器和訊息
                if (message && (message.includes('連線中') || message.includes('建立'))) {
                    indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-spin';
                    statusText.textContent = '🔄 ' + message;
                } else if (message && message.includes('超時')) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = '⏰ ' + message;
                } else if (message && (message.includes('錯誤') || message.includes('失敗'))) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = '❌ ' + message;
                } else {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = message || '❌ 未連接';
                }
                
                connectBtn.innerHTML = '<span>連接 MQTT</span>';
                connectBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // 禁用測試按鈕、診斷按鈕、營業測試按鈕和讀取按鈕
                if (testBtn) {
                    testBtn.disabled = true;
                    testBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = true;
                    diagnoseBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = true;
                    businessTestBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = true;
                    readBtn.className = 'w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed';
                }
                
                // 停止心跳檢測
                stopMqttHeartbeat();
            }
            
            mqttConnected = connected;
            window.mqttConnected = connected; // 同步到全域變數
            
            // 控制台日誌
            console.log('MQTT 狀態更新: ' + (connected ? '已連接' : '未連接') + (message ? ' - ' + message : '') + ' (' + timeStr + ')');
        }
        
        // 添加命令日誌
        function addCommandLog(type, message, data = null) {
            const logContainer = document.getElementById('mqtt-command-log');
            if (!logContainer) return;
            
            // 如果是第一條訊息，清除預設文字
            if (logContainer.querySelector('.text-gray-500')) {
                logContainer.innerHTML = '';
            }
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs p-2 rounded-lg ' + 
                (type === 'send' ? 'bg-blue-900/30 border border-blue-500/30' : 
                 type === 'receive' ? 'bg-green-900/30 border border-green-500/30' :
                 'bg-red-900/30 border border-red-500/30');
            
            let icon = type === 'send' ? '📤' : type === 'receive' ? '📥' : '❌';
            let content = `<div class="flex items-start space-x-2">
                <span>${icon}</span>
                <div class="flex-1">
                    <p class="font-medium">[${timestamp}] ${message}</p>`;
            
            if (data) {
                content += `<pre class="mt-1 text-xs bg-gray-900/50 p-1 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            content += `</div></div>`;
            logEntry.innerHTML = content;
            
            // 添加到日誌容器
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // 限制日誌數量
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // 啟動 MQTT 心跳檢測
        function startMqttHeartbeat() {
            stopMqttHeartbeat(); // 先停止現有的心跳
            
            mqttHeartbeatTimer = setInterval(function() {
                if (mqttClient && mqttConnected) {
                    try {
                        // 發送 ping 測試連線狀態
                        const pingTopic = 'system/ping';
                        const pingMessage = {
                            timestamp: new Date().toISOString(),
                            clientId: 'webapp_' + Date.now()
                        };
                        
                        mqttClient.publish(pingTopic, JSON.stringify(pingMessage), { qos: 0 }, function(err) {
                            if (err) {
                                console.warn('MQTT 心跳失敗:', err);
                                // 心跳失敗，可能需要重連
                                if (mqttAutoReconnect) {
                                    reconnectMqtt();
                                }
                            } else {
                                console.log('✓ MQTT 心跳正常');
                            }
                        });
                    } catch (error) {
                        console.error('MQTT 心跳檢測錯誤:', error);
                        if (mqttAutoReconnect) {
                            reconnectMqtt();
                        }
                    }
                }
            }, mqttHeartbeatInterval);
        }
        
        // 停止 MQTT 心跳檢測
        function stopMqttHeartbeat() {
            if (mqttHeartbeatTimer) {
                clearInterval(mqttHeartbeatTimer);
                mqttHeartbeatTimer = null;
            }
        }
        
        // MQTT 自動重連
        function reconnectMqtt() {
            if (!mqttAutoReconnect || mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                console.log('停止 MQTT 重連 - 超過最大重試次數');
                updateMqttStatus(false, '重連失敗 - 超過最大重試次數');
                return;
            }
            
            mqttReconnectAttempts++;
            console.log('MQTT 重連嘗試 ' + mqttReconnectAttempts + '/' + mqttMaxReconnectAttempts);
            
            updateMqttStatus(false, '重連中... (第 ' + mqttReconnectAttempts + ' 次)');
            
            // 清理現有連線
            if (mqttClient) {
                try {
                    mqttClient.end(true); // 強制關閉
                } catch (error) {
                    console.warn('關閉 MQTT 客戶端時發生錯誤:', error);
                }
                mqttClient = null;
            }
            
            // 根據伺服器類型決定重試間隔
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            let reconnectDelay = mqttReconnectInterval; // 預設 5 秒
            
            if (brokerUrl.includes('update.feiloli.com.tw')) {
                // 原伺服器使用更長的重試間隔
                reconnectDelay = mqttReconnectIntervalOriginal; // 30 秒
                console.log('⏰ 原伺服器重連間隔：30 秒');
                updateMqttStatus(false, '等待 30 秒後重試原伺服器... (第 ' + mqttReconnectAttempts + ' 次)');
                addCommandLog('error', `⏰ 原伺服器無法連線，將在 30 秒後重試（第 ${mqttReconnectAttempts} 次）`);
            } else {
                console.log('⏰ 重連間隔：5 秒');
            }
            
            // 延遲後重新連線
            mqttReconnectTimer = setTimeout(function() {
                connectMqtt();
            }, reconnectDelay);
        }
        
        // 停止 MQTT 重連
        function stopMqttReconnect() {
            if (mqttReconnectTimer) {
                clearTimeout(mqttReconnectTimer);
                mqttReconnectTimer = null;
            }
        }
        
        // 主要 MQTT 連線函數
        function connectMqtt() {
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            const topic = document.getElementById('mqtt-topic').value;
            
            if (!brokerUrl) {
                alert('請輸入 MQTT Broker 位址');
                return;
            }
            
            try {
                updateMqttStatus(false, '建立連線中...');
                console.log('開始連線到:', brokerUrl);
                
                // 自動偵測並修正協議（HTTPS 頁面需要使用 wss://）
                let finalBrokerUrl = brokerUrl;
                if (window.location.protocol === 'https:' && brokerUrl.startsWith('ws://')) {
                    finalBrokerUrl = brokerUrl.replace('ws://', 'wss://');
                    console.log('⚠️ 偵測到 HTTPS 頁面，自動將 ws:// 轉換為 wss://');
                    console.log('原始 URL:', brokerUrl);
                    console.log('修正後 URL:', finalBrokerUrl);
                    addCommandLog('error', '⚠️ HTTPS 安全限制：自動將 ws:// 轉為 wss://');
                }
                
                // 根據不同的伺服器調整配置
                let customConfig = {...mqttConfig};
                
                // HiveMQ 需要特殊配置
                if (finalBrokerUrl.includes('broker.hivemq.com')) {
                    customConfig = {
                        keepalive: 60,
                        clean: true,
                        reconnectPeriod: 5000,
                        connectTimeout: 10000,
                        clientId: 'mqtt_client_' + Math.random().toString(16).substr(2, 8)
                    };
                    console.log('使用 HiveMQ 配置');
                } else if (finalBrokerUrl.includes('test.mosquitto.org')) {
                    customConfig.connectTimeout = 8000;
                    console.log('使用 Mosquitto 配置');
                } else if (finalBrokerUrl.includes('broker.emqx.io')) {
                    customConfig.connectTimeout = 8000;
                    console.log('使用 EMQX 配置');
                }
                
                // 創建 MQTT 客戶端
                console.log('最終連線 URL:', finalBrokerUrl);
                mqttClient = mqtt.connect(finalBrokerUrl, customConfig);
                window.mqttClient = mqttClient; // 同步到全域變數
                console.log('MQTT 客戶端已創建並設為全域');
                
                // 設置連線超時
                const connectTimeout = setTimeout(function() {
                    if (!mqttConnected) {
                        const isOriginalServer = finalBrokerUrl.includes('update.feiloli.com.tw');
                        
                        console.error('❌ MQTT 連線超時 (30秒)');
                        
                        if (isOriginalServer) {
                            updateMqttStatus(false, '原伺服器連線超時 - 伺服器可能離線或網路不通');
                            addCommandLog('error', '❌ 原伺服器 (update.feiloli.com.tw:5438) 連線超時，將在 30 秒後重試');
                        } else {
                            updateMqttStatus(false, '連線超時 - 請檢查伺服器地址或網路連線');
                            addCommandLog('error', '連線超時：無法在 30 秒內建立連線');
                        }
                        
                        if (mqttClient) {
                            try {
                                mqttClient.end(true);
                            } catch (e) {
                                console.warn('結束客戶端時發生錯誤:', e);
                            }
                        }
                        
                        // 如果是原伺服器且未自動重連，詢問是否切換
                        if (isOriginalServer && !mqttAutoReconnect) {
                            if (confirm('原伺服器目前無法連線！\n\n是否要切換到 HiveMQ 公開測試伺服器？\n\n（系統將自動每 30 秒重試原伺服器）')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        } else if (!isOriginalServer) {
                            // 非原伺服器超時，詢問切換到 HiveMQ
                            if (confirm('連線超時！\n\n是否要切換到 HiveMQ 公開伺服器？')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        }
                    }
                }, 30000);
                
                // 連線成功事件
                mqttClient.on('connect', function() {
                    clearTimeout(connectTimeout);
                    console.log('✅ MQTT 連線成功！');
                    
                    // 確保全域變數同步
                    window.mqttClient = mqttClient;
                    window.mqttConnected = true;
                    console.log('✅ 全域 MQTT 變數已同步');
                    
                    updateMqttStatus(true, '連線成功');
                    addCommandLog('receive', '✅ MQTT 連線建立成功');
                    
                    // 訂閱主題
                    mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('訂閱主題失敗:', err);
                            addCommandLog('error', '訂閱主題失敗: ' + topic);
                        } else {
                            console.log('✅ 訂閱主題成功:', topic);
                            addCommandLog('receive', '✅ 已訂閱主題: ' + topic);
                        }
                    });
                    
                    // 額外訂閱一些可能的回應主題進行測試
                    const additionalTopics = ['coffeelens/+', 'machine/+', 'device/+', 'test/echo'];
                    additionalTopics.forEach(additionalTopic => {
                        mqttClient.subscribe(additionalTopic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn('訂閱額外主題失敗:', additionalTopic, err);
                            } else {
                                console.log('✅ 訂閱額外主題成功:', additionalTopic);
                            }
                        });
                    });
                });
                
                // 訊息接收事件
                mqttClient.on('message', function(topic, message) {
                    console.log('🔥 收到任何 MQTT 訊息:', { topic, message: message.toString() });
                    try {
                        handleMqttMessage(topic, message.toString());
                    } catch (error) {
                        console.error('處理 MQTT 訊息時發生錯誤:', error);
                        addCommandLog('error', '訊息處理錯誤: ' + error.message);
                    }
                });
                
                // 錯誤事件
                mqttClient.on('error', function(error) {
                    clearTimeout(connectTimeout);
                    console.error('❌ MQTT 錯誤:', error);
                    
                    const brokerUrl = document.getElementById('mqtt-broker-url').value;
                    const isOriginalServer = brokerUrl.includes('update.feiloli.com.tw');
                    
                    let errorMsg = error.message || '未知錯誤';
                    if (errorMsg.includes('connack timeout')) {
                        errorMsg = '連線超時 - 伺服器未回應';
                        if (isOriginalServer) {
                            errorMsg += ' (原伺服器目前無法連線，將在 30 秒後重試)';
                        }
                    } else if (errorMsg.includes('Connection refused')) {
                        errorMsg = '連線被拒 - 請檢查伺服器地址';
                    } else if (errorMsg.includes('getaddrinfo ENOTFOUND')) {
                        errorMsg = '找不到伺服器 - 請檢查網址是否正確';
                    }
                    
                    updateMqttStatus(false, '連線錯誤: ' + errorMsg);
                    addCommandLog('error', '❌ MQTT 錯誤: ' + errorMsg);
                    
                    // 如果是原伺服器，建議切換
                    if (isOriginalServer && mqttReconnectAttempts >= 3) {
                        addCommandLog('error', '💡 建議：原伺服器連線失敗多次，可點擊「⭐ HiveMQ 公開」切換到測試伺服器');
                    }
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        const retryDelay = isOriginalServer ? 3000 : 2000;
                        setTimeout(function() {
                            reconnectMqtt();
                        }, retryDelay);
                    } else if (mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                        addCommandLog('error', `❌ 已達最大重試次數 (${mqttMaxReconnectAttempts} 次)，請手動重新連線或切換伺服器`);
                    }
                });
                
                // 連線關閉事件
                mqttClient.on('close', function() {
                    clearTimeout(connectTimeout);
                    console.log('🔌 MQTT 連線已關閉');
                    updateMqttStatus(false, '連線已關閉');
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        setTimeout(function() {
                            reconnectMqtt();
                        }, 1000);
                    }
                });
                
                // 離線事件
                mqttClient.on('offline', function() {
                    console.warn('⚠️ MQTT 客戶端離線');
                    updateMqttStatus(false, '客戶端離線');
                });
                
                // 重連事件
                mqttClient.on('reconnect', function() {
                    console.log('🔄 MQTT 正在重連...');
                    updateMqttStatus(false, '正在重連...');
                });
                
            } catch (error) {
                console.error('❌ MQTT 連線初始化失敗:', error);
                updateMqttStatus(false, '初始化失敗: ' + error.message);
            }
        }
        
        // 斷開 MQTT 連線
        function disconnectMqtt() {
            console.log('執行 MQTT 斷開連接');
            mqttAutoReconnect = false; // 停止自動重連
            stopMqttReconnect(); // 停止重連定時器
            stopMqttHeartbeat(); // 停止心跳檢測
            
            if (mqttClient) {
                try {
                    mqttClient.end();
                    mqttClient = null;
                } catch (error) {
                    console.error('斷開 MQTT 連線時發生錯誤:', error);
                }
            }
            
            // 清理全域變數
            window.mqttClient = null;
            window.mqttConnected = false;
            console.log('✅ 全域 MQTT 變數已清理');
            
            updateMqttStatus(false, '已斷開連線');
            mqttReconnectAttempts = 0;
        }
        
        // 解析娃娃機 MQTT 資料
        function parseMachineData(hexData) {
            // 解析娃娃機回傳的 hex 資料
            try {
                if (!hexData || hexData.length < 2) { // 至少需要 1 byte (2 hex chars)
                    console.warn('資料長度不足:', hexData?.length);
                    return null;
                }
                
                console.log('收到機台資料，長度:', hexData.length, '內容:', hexData);
                
                // 處理簡短的狀態回應（如 "1"）
                if (hexData.length < 20) {
                    return {
                        rawHex: hexData,
                        statusCode: parseInt(hexData, 16),
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: true,
                        message: `收到狀態碼: ${hexData}`
                    };
                }
                
                // 將 hex 字串轉換為 bytes
                const bytes = [];
                for (let i = 0; i < hexData.length; i += 2) {
                    bytes.push(parseInt(hexData.substr(i, 2), 16));
                }
                
                // 根據您提供的協議解析所有資料
                const data = {
                    // 基本帳務資料
                    coinCount: 0,
                    payoutCount: 0,
                    
                    // 詳細電壓資料 (Byte33-38)
                    voltageData: {
                        strongVoltage: bytes[33] || 0,        // B1.強電壓
                        mediumVoltage: bytes[34] || 0,        // B2.中電壓  
                        weakVoltage: bytes[35] || 0,          // B3.弱電壓
                        heightToTop: bytes[36] || 0,          // B4.中壓距離頂點高度
                        clampVoltage: bytes[37] || 0          // B5.保夾強電壓
                    },
                    
                    // 營運資料 (Byte39-48)
                    operationData: {
                        winRateBank: (bytes[40] << 8) | bytes[39],          // C1.中獎率銀行
                        coinGameCount: (bytes[42] << 8) | bytes[41],        // C2.投幣遊戲次數
                        prizeCount: (bytes[44] << 8) | bytes[43],           // C3.禮品出獎次數
                        accumulatedAmount1: (bytes[46] << 8) | bytes[45],   // C4.累加金額查詢第1筆
                        accumulatedAmount2: (bytes[48] << 8) | bytes[47],   // C4.累加金額查詢第2筆
                        accumulatedAmount3: (bytes[50] << 8) | bytes[49]    // C4.累加金額查詢第3筆
                    },
                    
                    // 原始 bytes 陣列供除錯使用
                    rawBytes: bytes,
                    rawHex: hexData,
                    parseTime: new Date().toLocaleString()
                };
                
                // 解析基本投幣和出貨數據 (假設在前面的 bytes)
                if (bytes.length >= 10) {
                    data.coinCount = bytes[2] | (bytes[3] << 8) | (bytes[4] << 16) | (bytes[5] << 24);
                    data.payoutCount = bytes[6] | (bytes[7] << 8) | (bytes[8] << 16) | (bytes[9] << 24);
                }
                
                console.log('完整解析機台資料:', data);
                return data;
                
            } catch (error) {
                console.error('解析機台資料失敗:', error);
                return null;
            }
        }
        
        // 處理 MQTT 訊息
        function handleMqttMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                document.getElementById('last-mqtt-update').textContent = new Date().toLocaleString();
                
                // 檢查是否為機台狀態回應（包含 machine_name, machine_ip 等）
                if (data.machine_name && data.machine_ip) {
                    console.log('🎯 收到機台狀態回應:', data);
                    addCommandLog('receive', `收到機台狀態 - ${data.machine_name} (${data.machine_ip})`, data);
                    
                    // 顯示機台狀態資訊
                    showStatusMessage(`機台 ${data.machine_name} 回應: CPU ${data.cpu_usage}%, 記憶體 ${data.memory_usage}%, 儲存 ${data.storage_usage}%`, 'success');
                    
                    // 嘗試根據 IP 或名稱找到對應的機台
                    const matchedMachine = appData.machines.find(m => 
                        m.ip === data.machine_ip || 
                        m.name === data.machine_name ||
                        m.id === data.machine_name
                    );
                    
                    if (matchedMachine) {
                        console.log('✅ 找到對應機台:', matchedMachine);
                        // 更新機台狀態資訊
                        matchedMachine.lastResponse = new Date().toISOString();
                        matchedMachine.status = {
                            cpu_usage: data.cpu_usage,
                            memory_usage: data.memory_usage,
                            storage_usage: data.storage_usage,
                            machine_ip: data.machine_ip
                        };
                    } else {
                        console.log('⚠️ 無法匹配機台，建議添加機台記錄');
                        addCommandLog('receive', '⚠️ 機台回應但未在系統中找到對應記錄');
                    }
                    
                    return; // 直接返回，不需要進一步處理
                }
                
                // 記錄收到的訊息到命令日誌
                if (data.cmd === 're_readdata') {
                    addCommandLog('receive', `收到讀取回應 - MAC: ${data.mac}, 設備ID: ${data.devid}, 任務ID: ${data.taskid}`, data);
                    
                    // 顯示資料長度
                    if (data.parm) {
                        const byteLength = data.parm.length / 2;
                        console.log(`✅ 收到 ${byteLength} 位元組資料`);
                    }
                } else {
                    addCommandLog('receive', `收到訊息 - 命令: ${data.cmd || '未知'}`, data);
                }
                
                // 處理機台回應資料
                if ((data.cmd === 're_readdata' || data.cmd === 're_stat') && data.parm) {
                    console.log(`收到 ${data.cmd} 回應，MAC: ${data.mac}, 資料: ${data.parm}`);
                    
                    const machineData = parseMachineData(data.parm);
                    console.log('解析後的機台資料:', machineData);
                    
                    if (machineData) {
                        // 根據 MAC 位址找到對應的機台
                        const machineInfo = findMachineByMac(data.mac);
                        console.log('尋找機台結果:', machineInfo);
                        
                        if (machineInfo) {
                            console.log('找到對應機台:', machineInfo.id);
                            
                            // 如果只是狀態回應，顯示簡化信息，但仍然顯示詳細面板
                            if (machineData.isStatusOnly) {
                                console.log('這是狀態回應，顯示狀態和詳細面板');
                                showStatusMessage(`機台 ${machineInfo.id} 狀態: ${machineData.message}`, 'info');
                                // 即使是狀態回應也顯示詳細面板
                                showMachineDetailPanel(machineInfo, machineData);
                            } else {
                                console.log('這是完整資料回應，更新機台資料');
                                updateMachineFromMqtt(machineInfo, machineData);
                            }
                        } else {
                            console.warn('找不到 MAC 對應的機台:', data.mac);
                            console.log('目前機台列表:', appData.machines.map(m => ({ id: m.id, mac: m.mac })));
                            showStatusMessage(`收到未知機台 ${data.mac} 的回應`, 'info');
                        }
                    } else {
                        console.warn('無法解析機台資料:', data.parm);
                    }
                }
                
                console.log('收到 MQTT 訊息:', { topic, data });
            } catch (error) {
                console.error('處理 MQTT 訊息失敗:', error);
                addCommandLog('error', '訊息處理失敗: ' + error.message);
            }
        }
        
        // 根據 MAC 位址找機台
        function findMachineByMac(mac) {
            return appData.machines.find(machine => machine.mac === mac);
        }
        
        // 從 MQTT 資料更新機台資訊
        function updateMachineFromMqtt(machine, mqttData) {
            console.log('=== 開始更新機台資料 ===');
            console.log('機台資訊:', machine);
            console.log('MQTT 資料:', mqttData);
            
            // 計算新增的投幣和出貨數
            const newCoins = Math.max(0, mqttData.coinCount - (machine.mqttLastCoinCount || 0));
            const newPayouts = Math.max(0, mqttData.payoutCount - (machine.mqttLastPayoutCount || 0));
            
            // 儲存完整的 MQTT 資料到機台物件
            machine.mqttDetailData = mqttData;
            
            console.log('準備顯示機台詳細資料面板...');
            // 顯示詳細資料面板
            showMachineDetailPanel(machine, mqttData);
            
            if (newCoins > 0 || newPayouts > 0) {
                // 自動新增記帳記錄
                const today = new Date().toISOString().split('T')[0];
                addMqttRecord(machine.id, today, newCoins * COIN_VALUE, newPayouts);
                
                // 更新機台的 MQTT 計數器
                machine.mqttLastCoinCount = mqttData.coinCount;
                machine.mqttLastPayoutCount = mqttData.payoutCount;
                
                // 儲存到 Firebase
                saveMachineData();
                
                console.log(`機台 ${machine.id} MQTT 自動更新: +${newCoins}幣 +${newPayouts}貨`);
            }
        }
        
        // 自動新增 MQTT 記錄
        function addMqttRecord(machineId, date, revenue, payouts) {
            const existingRecord = appData.history.find(r => 
                r.machineId === machineId && r.date === date
            );
            
            if (existingRecord) {
                // 更新現有記錄
                existingRecord.totalRevenue += revenue;
                existingRecord.totalPayouts += payouts;
            } else {
                // 新增記錄
                appData.history.push({
                    id: Date.now().toString(),
                    machineId,
                    date,
                    totalRevenue: revenue,
                    totalPayouts: payouts,
                    autoAdded: true // 標記為自動新增
                });
            }
            
            saveHistoryData();
            refreshCurrentView();
        }

        // --- END: MQTT 功能 ---

        // --- GLOBAL STATE ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '' };
        let currentSort = { key: 'id', direction: 'asc' };
        let selectedGroupId = null;
        let selectedGroupName = '';
        let selectedStoreId = null; 
        let selectedStoreName = ''; 
        let confirmCallback = null;
        

        // --- PAGE & ELEMENT SELECTORS ---
        const groupSelectionPage = document.getElementById('group-selection-page');
        const storeSelectionPage = document.getElementById('store-selection-page');
        const reportPage = document.getElementById('report-page');
        const adminPage = document.getElementById('admin-page');
        
        const groupListContainer = document.getElementById('group-list');
        const createGroupForm = document.getElementById('create-group-form');
        const backToGroupsBtn = document.getElementById('back-to-groups-btn');
        const adminBtn = document.getElementById('admin-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');

        const storeListContainer = document.getElementById('store-list');
        const createStoreForm = document.getElementById('create-store-form');
        const backToStoresBtn = document.getElementById('back-to-stores-btn');
        const reportPeriodSelector = document.getElementById('report-period-selector');
        const reportDatePicker = document.getElementById('report-date-picker');
        const downloadAllStoresBtn = document.getElementById('download-all-stores-report-btn');
        const allTabs = document.querySelectorAll('.tab-btn');
        const allTabContents = document.querySelectorAll('.tab-content');
        const searchInput = document.getElementById('searchInput');
        const sortableHeaders = document.querySelectorAll('.table-header-sortable');
        const statsControls = document.getElementById('stats-controls');
        const summaryControls = document.getElementById('summary-controls');
        const psdControls = document.getElementById('psd-controls');
        const psdCustomRange = document.getElementById('psd-custom-range');
        const psdStartDate = document.getElementById('psd-start-date');
        const psdEndDate = document.getElementById('psd-end-date');
        const psdCalculateBtn = document.getElementById('psd-calculate-btn');
        const addMachineForm = document.getElementById('add-machine-form');
        const machineListTableBody = document.getElementById('machine-list-table-body');
        const historyTableBody = document.getElementById('history-table-body');
        const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
        const locationPresets = document.getElementById('location-presets');
        const selectAllStoresBtn = document.getElementById('select-all-stores-btn');
        const deselectAllStoresBtn = document.getElementById('deselect-all-stores-btn');
        const recalculateAllBtn = document.getElementById('recalculate-all-btn');

        // 管理者界面元素
        const adminPasswordForm = document.getElementById('admin-password-form');
        const guestAccountForm = document.getElementById('guest-account-form');
        const guestAccountsTable = document.getElementById('guest-accounts-table');
        const groupPermissions = document.getElementById('group-permissions');
        const cancelGuestEditBtn = document.getElementById('cancel-guest-edit');
        const exportConfigBtn = document.getElementById('export-config-btn');
        const importConfigBtn = document.getElementById('import-config-btn');
        const resetConfigBtn = document.getElementById('reset-config-btn');
        const configFileInput = document.getElementById('config-file-input');

        
        // Modal selectors
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const editStoreModal = document.getElementById('edit-store-modal');
        const editStoreForm = document.getElementById('edit-store-form');
        const editStoreCancelBtn = document.getElementById('edit-store-cancel-btn');
        
        const editHistoryModal = document.getElementById('edit-history-modal');
        const editHistoryForm = document.getElementById('edit-history-form');
        const editHistoryCancelBtn = document.getElementById('edit-history-cancel-btn');
        
        const editMachineModal = document.getElementById('edit-machine-modal');
        const editMachineForm = document.getElementById('edit-machine-form');
        const editMachineCancelBtn = document.getElementById('edit-machine-cancel-btn');

        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
        const pdfLoaderText = document.getElementById('pdf-loader-text-overlay');
        
        const checkoutHistoryBody = document.getElementById('checkout-history-body');
        const performCheckoutBtn = document.getElementById('perform-checkout-btn');
        const downloadCheckoutCsvBtn = document.getElementById('download-checkout-csv-btn');
        const headerDownloadButtons = document.getElementById('header-download-buttons');

        // 自定義報表模態視窗元素
        const customReportModal = document.getElementById('custom-report-modal');
        const customReportDownloadBtn = document.getElementById('custom-report-download');
        const customReportCancelBtn = document.getElementById('custom-report-cancel');
        const selectAllReportsBtn = document.getElementById('select-all-reports');
        const selectBasicReportsBtn = document.getElementById('select-basic-reports');
        const selectDetailedReportsBtn = document.getElementById('select-detailed-reports');
        const clearAllReportsBtn = document.getElementById('clear-all-reports');

        // 自定義門市報表模態視窗元素
        const customStoreReportModal = document.getElementById('custom-store-report-modal');
        const customStoreReportDownloadBtn = document.getElementById('custom-store-report-download');
        const customStoreReportCancelBtn = document.getElementById('custom-store-report-cancel');
        const selectAllStoreReportsBtn = document.getElementById('select-all-store-reports');
        const selectBasicStoreReportsBtn = document.getElementById('select-basic-store-reports');
        const selectDetailedStoreReportsBtn = document.getElementById('select-detailed-store-reports');
        const clearAllStoreReportsBtn = document.getElementById('clear-all-store-reports');


        // --- MODAL FUNCTIONS ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- CUSTOM REPORT FUNCTIONS ---
        function showCustomReportModal() {
            customReportModal.classList.remove('hidden');
        }

        function hideCustomReportModal() {
            customReportModal.classList.add('hidden');
        }

        function setReportCheckboxes(summary, details, operationSummary, history, analysis, checkout, profit) {
            document.getElementById('include-summary').checked = summary;
            document.getElementById('include-details').checked = details;
            document.getElementById('include-operation-summary').checked = operationSummary;
            document.getElementById('include-history').checked = history;
            document.getElementById('include-analysis').checked = analysis;
            document.getElementById('include-checkout').checked = checkout;
            document.getElementById('include-profit').checked = profit;
        }

        async function generateCustomReport() {
            const includeSummary = document.getElementById('include-summary').checked;
            const includeDetails = document.getElementById('include-details').checked;
            const includeOperationSummary = document.getElementById('include-operation-summary').checked;
            const includeHistory = document.getElementById('include-history').checked;
            const includeAnalysis = document.getElementById('include-analysis').checked;
            const includeCheckout = document.getElementById('include-checkout').checked;
            const includeProfit = document.getElementById('include-profit').checked;
            const format = document.querySelector('input[name="report-format"]:checked').value;

            if (!includeSummary && !includeDetails && !includeOperationSummary && !includeHistory && !includeAnalysis && !includeCheckout && !includeProfit) {
                alert('請至少選擇一項報表內容！');
                return;
            }

            pdfLoaderText.textContent = `正在生成自定義報表 (${format.toUpperCase()})...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const storeName = selectedStoreName || '未知門市';

                if (format === 'csv') {
                    // CSV 格式報表
                    if (includeSummary) {
                        reportData.push('=== 營業摘要統計 ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                        reportData.push('統計項目,數值');
                        reportData.push(`門市名稱,${storeName}`);
                        reportData.push(`統計期間,${appData.startDate} ~ ${new Date().toISOString().split('T')[0]}`);
                        reportData.push(`總投幣次數,${totalPlays}`);
                        reportData.push(`總營業額,${totalRevenue}`);
                        reportData.push(`總出貨次數,${totalPayouts}`);
                        reportData.push(`平均出貨成本,${avgCost.toFixed(2)}`);
                        reportData.push('');
                    }

                    if (includeDetails) {
                        reportData.push('=== 機台詳細資料 ===');
                        reportData.push('機台編號,位置,投幣次數,營業額,出貨次數,平均成本,初始投幣,初始出貨');
                        const processedMachines = appData.machines.map(processMachineData);
                        processedMachines.forEach(machine => {
                            reportData.push(`${machine.id},${machine.location},${machine.effectivePlays},${machine.revenue},${machine.effectivePayouts},${machine.cost.toFixed(2)},${machine.initialPlays || 0},${machine.initialPayouts || 0}`);
                        });
                        reportData.push('');
                    }

                    if (includeOperationSummary) {
                        reportData.push('=== 營運概況總表 ===');
                        reportData.push('機台編號,總投幣金額,總出貨數量,平均出貨成本');
                        const summaryData = getAggregatedSummaryData('all');
                        summaryData.forEach(item => {
                            reportData.push(`${item.id},${item.revenue},${item.payouts},${item.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeHistory) {
                        reportData.push('=== 記帳歷史紀錄 ===');
                        reportData.push('日期,機台編號,位置,投幣次數,出貨次數,當日營收');
                        appData.history.forEach(record => {
                            const dailyRevenue = record.dailyPlays * COIN_VALUE;
                            reportData.push(`${record.date},${record.machineId},${record.location},${record.dailyPlays},${record.dailyPayouts},${dailyRevenue}`);
                        });
                        reportData.push('');
                    }

                    if (includeAnalysis) {
                        reportData.push('=== 營運分析數據 ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
                        const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

                        reportData.push('營收排行榜');
                        reportData.push('排名,機台編號,位置,營收');
                        sortedByRevenue.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.revenue}`);
                        });
                        reportData.push('');

                        reportData.push('出貨成本排行榜');
                        reportData.push('排名,機台編號,位置,平均成本');
                        sortedByCost.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeCheckout && selectedGroupId && selectedStoreId) {
                        reportData.push('=== 結帳紀錄 ===');
                        const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                        const checkoutSnapshot = await checkoutCollection.get();
                        const checkouts = checkoutSnapshot.docs.map(doc => doc.data());

                        reportData.push('結帳日期,結帳金額,累積營收,備註');
                        checkouts.forEach(checkout => {
                            reportData.push(`${checkout.checkoutDate},${checkout.checkoutAmount},${checkout.cumulativeRevenueAtCheckout || 0},${checkout.notes || ''}`);
                        });
                        reportData.push('');
                    }

                    if (includeProfit) {
                        reportData.push('=== 盈利計算分析 ===');
                        
                        // 載入成本設定
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // 計算營業數據
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // 計算各項成本
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = totalRevenue * (rentPercentage / 100);
                        const totalTaxCost = totalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        
                        // 計算盈利指標
                        const netProfit = totalRevenue - totalCost;
                        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                        const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                        
                        // 成本設定部分
                        reportData.push('成本設定');
                        reportData.push('項目,數值');
                        reportData.push(`每次出貨禮品成本,${giftCost} 元`);
                        reportData.push(`店租比例,${rentPercentage}%`);
                        reportData.push(`稅金比例,${taxPercentage}%`);
                        reportData.push('');
                        
                        // 營業數據部分
                        reportData.push('營業數據');
                        reportData.push('項目,數值');
                        reportData.push(`總營業額,${totalRevenue} 元`);
                        reportData.push(`總出貨次數,${totalPayouts} 次`);
                        reportData.push('');
                        
                        // 成本明細部分
                        reportData.push('成本明細');
                        reportData.push('項目,金額');
                        reportData.push(`禮品成本,${totalGiftCost} 元`);
                        reportData.push(`店租費用,${totalRentCost} 元`);
                        reportData.push(`稅金費用,${totalTaxCost} 元`);
                        reportData.push(`總成本,${totalCost} 元`);
                        reportData.push('');
                        
                        // 盈利分析部分
                        reportData.push('盈利分析');
                        reportData.push('項目,數值');
                        reportData.push(`淨利潤,${netProfit} 元`);
                        reportData.push(`利潤率,${profitMargin.toFixed(2)}%`);
                        reportData.push(`每次出貨淨利,${profitPerPayout.toFixed(2)} 元`);
                        reportData.push('');
                    }

                    // 下載 CSV
                    const csvContent = reportData.join('\n');
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${storeName}_自定義報表_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(link.href);

                } else if (format === 'pdf') {
                    // PDF 格式報表 (簡化版本)
                    alert('PDF 格式報表功能開發中，請先使用 CSV 格式。');
                }

                hideCustomReportModal();
                showFeedback('自定義報表下載成功！', false);

            } catch (error) {
                console.error('生成自定義報表時發生錯誤:', error);
                showFeedback('報表生成失敗，請稍後再試。', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

        // --- CUSTOM STORE REPORT FUNCTIONS ---
        function showCustomStoreReportModal() {
            customStoreReportModal.classList.remove('hidden');
        }

        function hideCustomStoreReportModal() {
            customStoreReportModal.classList.add('hidden');
        }

        function setStoreReportCheckboxes(summary, machines, performance, topMachines, periodSummary, profit) {
            document.getElementById('store-include-summary').checked = summary;
            document.getElementById('store-include-machines').checked = machines;
            document.getElementById('store-include-performance').checked = performance;
            document.getElementById('store-include-top-machines').checked = topMachines;
            document.getElementById('store-include-period-summary').checked = periodSummary;
            document.getElementById('store-include-profit').checked = profit;
        }

        async function generateCustomStoreReport() {
            const includeSummary = document.getElementById('store-include-summary').checked;
            const includeMachines = document.getElementById('store-include-machines').checked;
            const includePerformance = document.getElementById('store-include-performance').checked;
            const includeTopMachines = document.getElementById('store-include-top-machines').checked;
            const includePeriodSummary = document.getElementById('store-include-period-summary').checked;
            const includeProfit = document.getElementById('store-include-profit').checked;
            const period = document.querySelector('input[name="store-report-period"]:checked').value;
            const date = document.getElementById('store-report-date').value;

            // 檢查必要的全域變數
            if (!selectedGroupId) {
                alert('錯誤：未選擇群組，請重新選擇群組！');
                console.error('selectedGroupId 未設定:', selectedGroupId);
                return;
            }

            console.log('自定義門市報表參數:', {
                includeSummary, includeMachines, includePerformance, includeTopMachines, includePeriodSummary,
                period, date, COIN_VALUE, selectedGroupId, selectedGroupName
            });

            if (!includeSummary && !includeMachines && !includePerformance && !includeTopMachines && !includePeriodSummary && !includeProfit) {
                alert('請至少選擇一項報表內容！');
                return;
            }

            // 檢查選中的門市
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert('請先在門市列表中勾選要包含的門市！');
                return;
            }
            
            console.log('選中的門市數量:', selectedStoreCheckboxes.length);
            console.log('選中的門市資訊:', Array.from(selectedStoreCheckboxes).map(cb => ({
                value: cb.value,
                storeName: cb.dataset.storeName
            })));

            pdfLoaderText.textContent = '正在生成自定義門市報表...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const periodText = document.querySelector(`input[name="store-report-period"]:checked`).parentElement.textContent.trim();

                // 用來收集所有門市的總營業額
                let allStoresRevenue = 0;
                let storeRevenueData = [];

                reportData.push('=== 自定義門市報表 ===');
                reportData.push(`報表產生時間：${timestamp}`);
                reportData.push(`報表期間：${periodText}${date ? ` (${date})` : ''}`);
                reportData.push(`包含門市數："${selectedStoreCheckboxes.length}"`);
                
                // 先計算總營業額 (會在後面迴圈中填入)
                reportData.push('');

                // 為每個選中的門市生成報表
                for (const checkbox of selectedStoreCheckboxes) {
                    const storeId = checkbox.value;
                    const storeName = checkbox.dataset.storeName;
                    
                    console.log(`處理門市: ID=${storeId}, Name=${storeName}`);

                    reportData.push(`=== ${storeName} ===`);

                    try {
                        // 獲取門市資料  
                        console.log(`正在獲取門市資料 - GroupId: ${selectedGroupId}, StoreId: ${storeId}, StoreName: ${storeName}`);
                        
                        // 使用完整的 Firebase 路徑和錯誤處理
                        const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                        const machinesRef = storeRef.collection('machines');
                        
                        // 先檢查門市是否存在
                        const storeDoc = await storeRef.get();
                        if (!storeDoc.exists) {
                            console.error(`門市不存在: ${storeId}`);
                            throw new Error(`門市 ${storeName} 不存在於資料庫中`);
                        }
                        
                        // 獲取機台資料
                        const machinesSnapshot = await machinesRef.get();
                        console.log(`機台資料查詢結果 - 文檔數量: ${machinesSnapshot.docs.length}, 是否為空: ${machinesSnapshot.empty}`);
                        
                        if (machinesSnapshot.empty) {
                            console.log(`門市 ${storeName} 沒有機台資料`);
                        }
                        
                        const machines = machinesSnapshot.docs.map(doc => {
                            const data = doc.data();
                            console.log(`機台原始資料 (${doc.id}):`, data);
                            
                            // 確保所有必要字段存在且為數字
                            const machine = {
                                docId: doc.id,
                                id: data.id || doc.id,
                                location: data.location || '未知位置',
                                plays: Number(data.plays) || 0,
                                payouts: Number(data.payouts) || 0,
                                initialPlays: Number(data.initialPlays) || 0,
                                initialPayouts: Number(data.initialPayouts) || 0
                            };
                            
                            console.log(`機台轉換後資料 (${doc.id}):`, machine);
                            return machine;
                        });
                        
                        console.log(`門市 ${storeName} 最終機台資料:`, machines);
                        console.log(`機台數量: ${machines.length}`);
                        
                        if (includeSummary) {
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                return { ...m, effectivePlays, effectivePayouts, revenue, cost };
                            });

                            console.log(`門市 ${storeName} 處理後機台資料:`, processedMachines);

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                            // 累加到總營業額
                            allStoresRevenue += totalRevenue;
                            storeRevenueData.push({name: storeName, revenue: totalRevenue});

                            reportData.push('營業摘要');
                            reportData.push('項目,數值');
                            reportData.push(`機台數量,"${machines.length}"`);
                            reportData.push(`總投幣次數,"${totalPlays}"`);
                            reportData.push(`總營業額,"${totalRevenue}"`);
                            reportData.push(`總出貨次數,"${totalPayouts}"`);
                            reportData.push(`平均出貨成本,"${avgCost.toFixed(2)}"`);
                            reportData.push('');
                        }

                        if (includeMachines && machines.length > 0) {
                            reportData.push('機台明細');
                            reportData.push('機台編號,位置,投幣次數,營業額,出貨次數,平均成本');
                            machines.forEach(machine => {
                                const effectivePlays = Math.max(0, (machine.plays || 0) - (machine.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (machine.payouts || 0) - (machine.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                reportData.push(`"${machine.id || '未知'}","${machine.location || '未知'}","${effectivePlays}","${revenue}","${effectivePayouts}","${cost.toFixed(2)}"`);
                            });
                            reportData.push('');
                        }

                        if (includeTopMachines && machines.length > 0) {
                            reportData.push('優績機台 TOP 3');
                            reportData.push('排名,機台編號,位置,營業額');
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, revenue };
                            }).filter(m => m.revenue > 0); // 過濾掉營收為0的機台
                            
                            if (processedMachines.length > 0) {
                                processedMachines.sort((a, b) => b.revenue - a.revenue).slice(0, 3).forEach((machine, index) => {
                                    reportData.push(`"${index + 1}","${machine.id || '未知'}","${machine.location || '未知'}","${machine.revenue}"`);
                                });
                            } else {
                                reportData.push('"1","無","無","0"');
                            }
                            reportData.push('');
                        }

                        if (includeProfit && machines.length > 0) {
                            // 載入該門市的成本設定
                            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${storeId}`) || '{}');
                            const giftCost = settings.giftCost || 50;
                            const rentPercentage = settings.rentPercentage || 30;
                            const taxPercentage = settings.taxPercentage || 5;
                            
                            // 計算營業數據
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, effectivePlays, effectivePayouts, revenue };
                            });

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            
                            // 計算各項成本
                            const totalGiftCost = totalPayouts * giftCost;
                            const totalRentCost = totalRevenue * (rentPercentage / 100);
                            const totalTaxCost = totalRevenue * (taxPercentage / 100);
                            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                            
                            // 計算盈利指標
                            const netProfit = totalRevenue - totalCost;
                            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                            const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                            
                            reportData.push('盈利計算分析');
                            reportData.push('項目,數值');
                            reportData.push(`"成本設定 - 禮品成本","${giftCost} 元/次"`);
                            reportData.push(`"成本設定 - 店租比例","${rentPercentage}%"`);
                            reportData.push(`"成本設定 - 稅金比例","${taxPercentage}%"`);
                            reportData.push(`"營業數據 - 總營業額","${totalRevenue} 元"`);
                            reportData.push(`"營業數據 - 總出貨次數","${totalPayouts} 次"`);
                            reportData.push(`"成本明細 - 禮品成本","${totalGiftCost} 元"`);
                            reportData.push(`"成本明細 - 店租費用","${totalRentCost} 元"`);
                            reportData.push(`"成本明細 - 稅金費用","${totalTaxCost} 元"`);
                            reportData.push(`"成本明細 - 總成本","${totalCost} 元"`);
                            reportData.push(`"盈利分析 - 淨利潤","${netProfit} 元"`);
                            reportData.push(`"盈利分析 - 利潤率","${profitMargin.toFixed(2)}%"`);
                            reportData.push(`"盈利分析 - 每次出貨淨利","${profitPerPayout.toFixed(2)} 元"`);
                            reportData.push('');
                        }

                    } catch (error) {
                        console.error(`獲取門市 ${storeName} 資料失敗:`, error);
                        console.error('詳細錯誤資訊:', {
                            selectedGroupId,
                            storeId,
                            storeName,
                            error: error.message,
                            stack: error.stack
                        });
                        reportData.push(`資料獲取失敗: ${error.message}`);
                        reportData.push('');
                    }
                }

                // 在第5行插入總營業額資訊
                reportData.splice(4, 0, `所有門市總營業額："${allStoresRevenue}"`);

                // 總營業額統計
                reportData.push('=== 總營業額統計 ===');
                reportData.push('項目,金額');
                storeRevenueData.forEach(store => {
                    reportData.push(`"${store.name}","${store.revenue}"`);
                });
                reportData.push(`"所有門市總營業額","${allStoresRevenue}"`);
                reportData.push('');

                // 門市績效比較
                if (includePerformance && selectedStoreCheckboxes.length > 1) {
                    reportData.push('=== 門市績效比較 ===');
                    reportData.push('門市名稱,機台數量,總營業額,平均每台營收');
                    storeRevenueData.forEach(store => {
                        reportData.push(`"${store.name}","--","${store.revenue}","--"`);
                    });
                    reportData.push('');
                }

                // 下載 CSV
                const csvContent = reportData.join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `自定義門市報表_${selectedGroupName}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);

                hideCustomStoreReportModal();
                showFeedback('自定義門市報表下載成功！', false);

            } catch (error) {
                console.error('生成門市報表時發生錯誤:', error);
                showFeedback('報表生成失敗，請稍後再試。', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

        // --- NAVIGATION & PAGE CONTROL ---
        
        function showGroupSelectionPage() {
            selectedGroupId = null;
            selectedGroupName = '';
            selectedStoreId = null;
            selectedStoreName = '';
            
            groupSelectionPage.classList.remove('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            
            loadGroups();
        }
        
        // 暴露函數到全域範圍供登入系統使用
        window.showGroupSelectionPage = showGroupSelectionPage;

        // --- 管理者界面函數 ---
        function showAdminPage() {
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            
            loadAdminInterface();
        }

        function hideAdminPage() {
            adminPage.classList.add('hidden');
            showGroupSelectionPage();
        }

        function loadAdminInterface() {
            // 載入當前管理員資訊
            const currentAdmin = window.adminConfig.config.adminCredentials;
            document.getElementById('new-username').value = currentAdmin.username;
            
            // 載入群組權限選項
            loadGroupPermissions();
            
            // 載入訪客帳號列表
            loadGuestAccountsTable();
            
            // 重置表單
            adminPasswordForm.reset();
            guestAccountForm.reset();
            document.getElementById('new-username').value = currentAdmin.username;
        }

        async function loadGroupPermissions() {
            try {
                const groupsSnapshot = await db.collection('groups').get();
                const groups = groupsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                groupPermissions.innerHTML = '';
                if (groups.length === 0) {
                    groupPermissions.innerHTML = '<p class="text-gray-400 text-sm">目前沒有可用的群組</p>';
                } else {
                    groups.forEach(group => {
                        const checkbox = document.createElement('label');
                        checkbox.className = 'flex items-center space-x-2 text-white cursor-pointer';
                        checkbox.innerHTML = `
                            <input type="checkbox" value="${group.id}" class="group-permission-checkbox rounded">
                            <span>${group.name}</span>
                        `;
                        groupPermissions.appendChild(checkbox);
                    });
                }
            } catch (error) {
                console.error('載入群組權限失敗:', error);
                groupPermissions.innerHTML = '<p class="text-red-400 text-sm">載入群組失敗</p>';
            }
        }

        function loadGuestAccountsTable() {
            const guests = window.adminConfig.getGuestAccounts();
            guestAccountsTable.innerHTML = '';
            
            if (guests.length === 0) {
                guestAccountsTable.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-400">尚無訪客帳號</td></tr>';
            } else {
                guests.forEach(guest => {
                    const allowedGroupsText = guest.allowedGroups.length > 0 ? 
                        `${guest.allowedGroups.length} 個群組` : '無權限';
                    
                    // 頁面權限顯示
                    const pagePermissions = guest.pagePermissions || [];
                    const pagePermissionNames = {
                        'details': '機台明細', 'summary': '營運總覽', 'analysis': '經營分析',
                        'charts': '圖表統計', 'statistics': '數據統計', 'accounting': '每日記帳',
                        'machines': '機台管理', 'profit': '盈利計算', 'checkout': '結帳作業', 'download': '下載報告', 'edit': '編輯刪除'
                    };
                    const pagePermissionsText = pagePermissions.length > 0 ? 
                        pagePermissions.map(p => pagePermissionNames[p] || p).slice(0, 3).join(', ') + 
                        (pagePermissions.length > 3 ? `等${pagePermissions.length}項` : '') : '無權限';
                    
                    const statusText = guest.enabled ? '啟用' : '停用';
                    const statusClass = guest.enabled ? 'text-green-400' : 'text-red-400';
                    const createdDate = new Date(guest.createdAt).toLocaleDateString();
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700/50 transition';
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${guest.username}</td>
                        <td class="p-4 ${statusClass}">${statusText}</td>
                        <td class="p-4 text-gray-300">${allowedGroupsText}</td>
                        <td class="p-4 text-gray-300 text-sm" title="${pagePermissions.map(p => pagePermissionNames[p] || p).join(', ')}">${pagePermissionsText}</td>
                        <td class="p-4 text-gray-300">${createdDate}</td>
                        <td class="p-4 text-center">
                            <button class="edit-guest-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-guest-id="${guest.id}">編輯</button>
                            <button class="delete-guest-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" data-guest-id="${guest.id}">刪除</button>
                        </td>
                    `;
                    guestAccountsTable.appendChild(row);
                });
            }
        }

        function showAdminFeedback(elementId, message, isError = false) {
            const feedbackEl = document.getElementById(elementId);
            feedbackEl.textContent = message;
            feedbackEl.className = `text-sm mt-2 ${isError ? 'text-red-400' : 'text-green-400'}`;
            feedbackEl.classList.remove('hidden');
            setTimeout(() => {
                feedbackEl.classList.add('hidden');
            }, 5000);
        }

        function showStoreSelectionPage(groupId, groupName) {
            selectedGroupId = groupId;
            selectedGroupName = groupName;
            
            document.getElementById('store-page-title').textContent = `${groupName} - 門市管理`;
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
            reportPage.classList.add('hidden');
            document.getElementById('new-store-start-date').valueAsDate = new Date();

            // 根據用戶類型隱藏/顯示新增門市表單
            const userType = localStorage.getItem('userType');
            const createStoreForm = document.getElementById('create-store-form').parentElement;
            if (createStoreForm) {
                if (userType === 'admin') {
                    createStoreForm.style.display = 'block';
                } else {
                    createStoreForm.style.display = 'none';
                }
            }

            loadStores();
        }

        async function showReportPage(storeId, storeName, startDate) {
            selectedStoreId = storeId;
            selectedStoreName = storeName;
            appData.startDate = startDate;
            
            // 切換到新門市時，清除 HTTP 輪詢自動記帳表格
            console.log('🗑️ 切換門市，清除 HTTP 輪詢自動記帳表格...');
            window.dailyRecords = {};
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
            
            document.getElementById('report-title-main').textContent = `${selectedStoreName} - 營業報告`;
            document.getElementById('report-period').textContent = `統計期間：${startDate} ～ 現在`;
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            // 檢查用戶頁面權限並隱藏/顯示相應的標籤頁
            applyPagePermissions();
            
            appData.machines = [];
            appData.history = [];
            
            // 選擇第一個可見的標籤頁
            const firstVisibleTab = document.querySelector('.tab-btn:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.click();
            } else {
                document.querySelector('.tab-btn[data-tab="details"]').click(); // 默認回退
            }
            
            await updateUI(); 
            loadStoreData();
        }

        // 應用頁面權限
        function applyPagePermissions() {
            const userType = localStorage.getItem('userType');
            console.log('應用頁面權限，用戶類型:', userType);
            
            if (userType === 'admin') {
                // 管理員擁有所有權限
                console.log('管理員用戶，顯示所有功能');
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.style.display = 'block';
                });
                document.getElementById('header-download-buttons').style.display = 'flex';
                return;
            }
            
            // 訪客用戶，檢查頁面權限
            const currentUser = localStorage.getItem('currentUser');
            const userPagePermissions = JSON.parse(localStorage.getItem('userPagePermissions') || '[]');
            console.log('訪客用戶頁面權限:', userPagePermissions);
            
            // 標籤頁權限映射
            const tabPermissionMap = {
                'details': 'details',
                'summary': 'summary', 
                'analysis': 'analysis',
                'charts': 'charts',
                'statistics': 'statistics',
                'accounting': 'accounting',
                'machines': 'machines',
                'profit': 'profit',
                'checkout': 'checkout'
            };
            
            // 隱藏/顯示標籤頁
            document.querySelectorAll('.tab-btn').forEach(tab => {
                const tabName = tab.dataset.tab;
                const requiredPermission = tabPermissionMap[tabName];
                
                if (requiredPermission && userPagePermissions.includes(requiredPermission)) {
                    tab.style.display = 'block';
                    console.log(`顯示標籤頁: ${tabName}`);
                } else {
                    tab.style.display = 'none';
                    console.log(`隱藏標籤頁: ${tabName}`);
                }
            });
            
            // 下載按鈕權限
            if (userPagePermissions.includes('download')) {
                document.getElementById('header-download-buttons').style.display = 'flex';
                console.log('顯示下載按鈕');
            } else {
                document.getElementById('header-download-buttons').style.display = 'none';
                console.log('隱藏下載按鈕');
            }
            
            // 編輯/刪除按鈕權限
            const hasEditPermission = userPagePermissions.includes('edit');
            console.log('編輯權限:', hasEditPermission);
            
            if (!hasEditPermission) {
                // 隱藏所有編輯和刪除按鈕
                setTimeout(() => {
                    const style = document.createElement('style');
                    style.id = 'guest-permissions-style';
                    style.textContent = `
                        .edit-machine-btn, .delete-machine-btn, 
                        .edit-history-btn, .delete-history-btn,
                        .edit-store-btn, .delete-store-btn,
                        .rename-group-btn, .delete-group-btn {
                            display: none !important;
                        }
                    `;
                    // 移除之前的樣式再添加新的
                    const existingStyle = document.getElementById('guest-permissions-style');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    document.head.appendChild(style);
                    console.log('已隱藏編輯/刪除按鈕');
                }, 100);
            }
        }

        // --- DATA PROCESSING & CALCULATION ---
        
        function processMachineData(machine) {
            const effectivePlays = machine.plays - (machine.initialPlays || 0);
            const effectivePayouts = machine.payouts - (machine.initialPayouts || 0);
            const revenue = effectivePlays * COIN_VALUE;
            const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
            return { ...machine, effectivePlays, effectivePayouts, revenue, cost };
        }


        // --- DATA FUNCTIONS (Multi-group Version) ---
        
        async function loadGroups() {
            try {
                const groupSnapshot = await db.collection('groups').orderBy('createdAt', 'desc').get();
                let groups = groupSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 如果是訪客用戶，過濾只顯示有權限的群組
                const userType = localStorage.getItem('userType');
                if (userType === 'guest') {
                    const allowedGroups = JSON.parse(localStorage.getItem('allowedGroups') || '[]');
                    groups = groups.filter(group => allowedGroups.includes(group.id));
                }
                
                renderGroups(groups);
            } catch (error) {
                console.error("讀取單位群組失敗:", error);
                groupListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">無法讀取群組列表，請檢查網路連線或 Firebase 設定。</p>';
            }
        }
        
        async function handleCreateGroup(e) {
            e.preventDefault();
            const newGroupNameInput = document.getElementById('new-group-name');
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) return alert('群組名稱不可空白！');
            
            try {
                await db.collection('groups').add({
                    name: groupName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newGroupNameInput.value = '';
                loadGroups();
            } catch (error) {
                console.error("建立群組失敗:", error);
                alert('建立群組失敗，請稍後再試。');
            }
        }

        async function handleRenameGroup(groupId, currentName) {
            const newName = prompt('請輸入新的單位群組名稱：', currentName);
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                try {
                    await db.collection('groups').doc(groupId).update({ name: newName.trim() });
                    loadGroups();
                } catch(error) {
                    console.error('更新群組名稱失敗:', error);
                    alert('更新失敗，請稍後再試。');
                }
            }
        }

        async function handleDeleteGroup(groupId, groupName) {
            const message = `您確定要刪除「${groupName}」單位群組嗎？\n\n警告：此操作將會永久刪除該群組底下的【所有門市】及其所有機台與記帳紀錄，且無法復原。`;
            showConfirmationModal(message, async () => {
                console.log(`開始刪除單位群組: ${groupId}`);
                try {
                    const groupRef = db.collection('groups').doc(groupId);
                    
                    const storesSnapshot = await groupRef.collection('stores').get();
                    for (const storeDoc of storesSnapshot.docs) {
                        const storeRef = storeDoc.ref;
                        
                        const machinesSnapshot = await storeRef.collection('machines').get();
                        if (!machinesSnapshot.empty) {
                            const machineBatch = db.batch();
                            machinesSnapshot.docs.forEach(doc => machineBatch.delete(doc.ref));
                            await machineBatch.commit();
                        }

                        const historySnapshot = await storeRef.collection('history').get();
                         if (!historySnapshot.empty) {
                            const historyBatch = db.batch();
                            historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                            await historyBatch.commit();
                        }

                        await storeRef.delete();
                    }

                    await groupRef.delete();

                    console.log(`單位群組 ${groupId} 已成功刪除。`);
                    hideConfirmationModal();
                    loadGroups();

                } catch(error) {
                    console.error('刪除單位群組失敗:', error);
                    alert('刪除失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }


        async function loadStores() {
            if(!selectedGroupId) return;
            try {
                const storeSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').orderBy('createdAt', 'desc').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStores(stores);
            } catch (error) {
                console.error("讀取門市列表失敗:", error);
                storeListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">無法讀取門市列表，請檢查網路連線或 Firebase 設定。</p>';
            }
        }
        
        async function loadStoreData() {
            if (!selectedGroupId || !selectedStoreId) return;
            console.log(`正在讀取群組[${selectedGroupId}] -> 門市 [${selectedStoreId}] 的資料...`);
            const machinesCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines');
            const historyCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').orderBy('date', 'desc');
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                const history = historySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                appData.machines = machines;
                appData.history = history;
                
                console.log("資料讀取成功!", appData);
                await updateUI();

            } catch (error) {
                console.error(`讀取資料時發生錯誤:`, error);
                showFeedback("無法從雲端讀取資料，請檢查網路連線。", true);
            }
        }

        async function handleCreateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('未選擇單位群組');

            const newStoreNameInput = document.getElementById('new-store-name');
            const newStoreStartDateInput = document.getElementById('new-store-start-date');
            const storeName = newStoreNameInput.value.trim();
            const startDate = newStoreStartDateInput.value;

            if (!storeName || !startDate) return alert('門市名稱與起始日不可空白！');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: storeName,
                    startDate: startDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                createStoreForm.reset();
                newStoreStartDateInput.valueAsDate = new Date();
                loadStores(); 
            } catch (error) {
                console.error("建立門市失敗:", error);
                alert('建立門市失敗，請稍後再試。');
            }
        }
        
        async function handleUpdateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return;

            const storeId = document.getElementById('edit-store-id').value;
            const newName = document.getElementById('edit-store-name').value.trim();
            const newStartDate = document.getElementById('edit-store-start-date').value;

            if (!newName || !newStartDate) return alert('門市名稱與起始日不可空白！');

            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).update({
                    name: newName,
                    startDate: newStartDate
                });
                editStoreModal.classList.add('hidden');
                loadStores();
            } catch(error) {
                console.error('更新門市資訊失敗:', error);
                alert('更新失敗，請稍後再試。');
            }
        }

        
        async function handleDeleteStore(storeId, storeName) {
            if(!selectedGroupId) return;
            const message = `您確定要刪除「${storeName}」嗎？\n\n警告：此操作將會永久刪除該門市及其底下的所有機台與記帳紀錄，且無法復原。`;
            showConfirmationModal(message, async () => {
                try {
                    const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                    
                    const machinesSnapshot = await storeRef.collection('machines').get();
                    if(!machinesSnapshot.empty){
                        const batch1 = db.batch();
                        machinesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                        await batch1.commit();
                    }

                    const historySnapshot = await storeRef.collection('history').get();
                     if(!historySnapshot.empty){
                        const batch2 = db.batch();
                        historySnapshot.docs.forEach(doc => batch2.delete(doc.ref));
                        await batch2.commit();
                    }

                    await storeRef.delete();
                    hideConfirmationModal();
                    loadStores();

                } catch(error) {
                    console.error('刪除門市失敗:', error);
                    alert('刪除失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }

        async function handleAddMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return alert('沒有選擇有效的門市。');

            const idInput = document.getElementById('new-machine-id');
            const locationInput = document.getElementById('new-machine-location');
            const initialPlaysInput = document.getElementById('new-machine-initial-plays');
            const initialPayoutsInput = document.getElementById('new-machine-initial-payouts');
            const macInput = document.getElementById('new-machine-mac');
            const devidInput = document.getElementById('new-machine-devid');

            const machineId = idInput.value.trim();
            const machineLocation = locationInput.value.trim();
            const initialPlays = parseInt(initialPlaysInput.value, 10) || 0;
            const initialPayouts = parseInt(initialPayoutsInput.value, 10) || 0;
            const macAddress = macInput.value.trim();
            const deviceId = parseInt(devidInput.value, 10) || null;


            if (!machineId || !machineLocation) return alert('機台編號和位置不能為空！');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').add({
                    id: machineId,
                    location: machineLocation,
                    plays: initialPlays, // 總表數從起始值開始
                    payouts: initialPayouts, // 總表數從起始值開始
                    initialPlays: initialPlays,
                    initialPayouts: initialPayouts,
                    // MQTT 相關欄位
                    mac: macAddress,
                    devid: deviceId,
                    mqttLastCoinCount: 0,
                    mqttLastPayoutCount: 0,
                });
                addMachineForm.reset();
                loadStoreData(); 
            } catch(error) {
                console.error("新增機台失敗：", error);
                alert('新增機台失敗，請稍後再試。');
            }
        }

        async function handleDeleteMachine(docId) {
            if(!selectedStoreId || !selectedGroupId || !docId) return;
            showConfirmationModal('您確定要刪除這台機器嗎？此操作無法復原。', async () => {
                try {
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).delete();
                    hideConfirmationModal();
                    loadStoreData();
                } catch (error) {
                    console.error("刪除機台失敗：", error);
                    alert('刪除機台失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }
        
        async function handleUpdateMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-machine-doc-id').value;
            const newId = document.getElementById('edit-machine-id').value.trim();
            const newLocation = document.getElementById('edit-machine-location').value.trim();
            const newInitialPlays = parseInt(document.getElementById('edit-machine-initial-plays').value, 10) || 0;
            const newInitialPayouts = parseInt(document.getElementById('edit-machine-initial-payouts').value, 10) || 0;

            if (!newId || !newLocation) return alert('機台編號和位置不能為空！');

            // Find the original machine data to calculate the difference
            const originalMachine = appData.machines.find(m => m.docId === docId);
            if (!originalMachine) {
                alert('錯誤：找不到原始機台資料！');
                return;
            }

            // 正確邏輯：只更新起始值，不改變總累積數值
            // 營收計算：有效營收 = 總累積 - 新起始值
            // 這樣修改起始值時，營收會正確地重新計算
            
            try {
                // 顯示處理中狀態
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '更新中...';
                submitBtn.disabled = true;

                // 更新機台資料 - 只更新起始值，總數保持不變
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).update({
                    id: newId,
                    location: newLocation,
                    initialPlays: newInitialPlays,
                    initialPayouts: newInitialPayouts
                    // plays 和 payouts 保持原值，不更新
                });

                // 關閉編輯視窗
                editMachineModal.classList.add('hidden');
                
                // 重新載入並重新計算所有資料
                await loadStoreData();
                
                // 強制更新所有UI元件以反映新的計算結果
                setTimeout(async () => {
                    await updateUI();
                    
                    // 確保所有頁面的數據都被更新
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const tabName = activeTab.dataset.tab;
                        switch(tabName) {
                            case 'summary':
                                await renderSummaryTab();
                                break;
                            case 'analysis':
                                renderAnalysisTab();
                                break;
                            case 'statistics':
                                renderStatisticsTab();
                                break;
                            case 'charts':
                                await renderChartsTab();
                                break;
                            case 'checkout':
                                renderCheckoutTab();
                                break;
                        }
                    }
                    
                    console.log('機台資料更新完成，所有統計數據已重新計算');
                }, 200);

                showFeedback('✅ 機台起始值更新成功！<br>📊 營收計算基準已調整：營收 = 歷史累積 - 新起始值', false);

                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error("更新機台資訊失敗：", error);
                showFeedback('更新機台資訊失敗，請稍後再試。', true);
                
                // 恢復按鈕狀態
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
            }
        }


        async function handleUpdateHistory(e) {
            e.preventDefault();
            if(!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-history-doc-id').value;
            const machineId = document.getElementById('edit-history-machine-id').value;
            const location = document.getElementById('edit-history-location').value;
            const oldPlays = parseInt(document.getElementById('edit-history-old-plays').value, 10);
            const oldPayouts = parseInt(document.getElementById('edit-history-old-payouts').value, 10);
            const newPlays = parseInt(document.getElementById('edit-history-plays').value, 10);
            const newPayouts = parseInt(document.getElementById('edit-history-payouts').value, 10);
            
            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('錯誤：找不到對應的機台來更新數據。');
                return;
            }

            const playsDiff = newPlays - oldPlays;
            const payoutsDiff = newPayouts - oldPayouts;

            const newTotalPlays = machineToUpdate.plays + playsDiff;
            const newTotalPayouts = machineToUpdate.payouts + payoutsDiff;
            
            try {
                // Batch update
                const batch = db.batch();
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                batch.update(machineRef, {
                    plays: newTotalPlays,
                    payouts: newTotalPayouts
                });

                const historyRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(docId);
                batch.update(historyRef, {
                    newPlays: newPlays,
                    newPayouts: newPayouts
                });

                await batch.commit();

                editHistoryModal.classList.add('hidden');
                showFeedback("記帳紀錄已更新！", false);
                loadStoreData();
            } catch(error) {
                console.error("更新記帳紀錄失敗：", error);
                alert('更新紀錄失敗，請稍後再試。');
            }
        }


        async function handleDeleteHistory(historyDocId, machineId, location, dailyPlays, dailyPayouts) {
            if(!selectedStoreId || !selectedGroupId || !historyDocId || !machineId) return;

            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('錯誤：找不到對應的機台來回滾數據。');
                return;
            }
            
            showConfirmationModal('您確定要刪除這筆記帳紀錄嗎？系統將自動回滾機台數據。', async () => {
                const revertedPlays = machineToUpdate.plays - dailyPlays;
                const revertedPayouts = machineToUpdate.payouts - dailyPayouts;

                if(revertedPlays < (machineToUpdate.initialPlays || 0) || revertedPayouts < (machineToUpdate.initialPayouts || 0) ) {
                    alert('錯誤：刪除此紀錄會導致機台累積數變為負數或小於起始值，操作已取消。');
                    hideConfirmationModal();
                    return;
                }

                try {
                    const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                    await machineRef.update({
                        plays: revertedPlays,
                        payouts: revertedPayouts
                    });
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(historyDocId).delete();
                    
                    hideConfirmationModal();
                    showFeedback("記帳紀錄已刪除並成功回滾數據！", false);
                    loadStoreData();

                } catch (error) {
                    console.error("刪除記帳紀錄失敗：", error);
                    alert('刪除紀錄失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }
        
        function getAggregatedSummaryData(period = 'all') {
            let dataToAggregate;

            if (period === 'all') {
                dataToAggregate = appData.machines.map(m => {
                    const effectivePlays = m.plays - (m.initialPlays || 0);
                    const effectivePayouts = m.payouts - (m.initialPayouts || 0);
                    return { id: m.id, plays: effectivePlays, payouts: effectivePayouts };
                });
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                const filteredHistory = appData.history.filter(h => new Date(h.date) >= startDate);

                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: h.newPlays,
                    payouts: h.newPayouts
                }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { id: s.id, revenue, payouts: s.payouts, cost };
            });
        }
        
        // 基於篩選後的歷史記錄獲取營業明細資料
        function getAggregatedSummaryDataFromHistory(period = 'all', filteredHistory) {
            let dataToAggregate;

            if (period === 'all') {
                // 使用篩選後的歷史記錄
                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: h.newPlays || 0,
                    payouts: h.newPayouts || 0
                }));
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                // 在已篩選的歷史記錄中再次按期間篩選
                dataToAggregate = filteredHistory
                    .filter(h => new Date(h.date) >= startDate)
                    .map(h => ({
                        id: h.machineId,
                        plays: h.newPlays || 0,
                        payouts: h.newPayouts || 0
                    }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { id: s.id, revenue, payouts: s.payouts, cost };
            });
        }
        
        async function handlePerformCheckout() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');

            try {
                const checkoutSnapshot = await checkoutCollection.limit(1).get();
                let lastCheckoutRevenue = 0;
                let lastCheckoutDate = appData.startDate;

                if (!checkoutSnapshot.empty) {
                    const lastCheckout = checkoutSnapshot.docs[0].data();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    lastCheckoutDate = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                }

                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;

                if (pendingAmount <= 0) {
                    alert("目前沒有待結帳金額。");
                    return;
                }
                
                showConfirmationModal(`您確定要結算本期營收 ${pendingAmount.toLocaleString()} 元嗎？`, async () => {
                     try {
                        // 計算出貨數量和盈利數據
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // 載入成本設定
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // 計算各項成本（基於總營收）
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = currentTotalRevenue * (rentPercentage / 100);
                        const totalTaxCost = currentTotalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        const netProfit = currentTotalRevenue - totalCost;
                        
                        // 計算本期盈利（僅針對本期待結帳金額）
                        let lastCheckoutPayouts = 0;
                        if (!checkoutSnapshot.empty) {
                            const lastCheckout = checkoutSnapshot.docs[0].data();
                            lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                        }
                        const pendingPayouts = totalPayouts - lastCheckoutPayouts;
                        const pendingGiftCost = pendingPayouts * giftCost;
                        const pendingRentCost = pendingAmount * (rentPercentage / 100);
                        const pendingTaxCost = pendingAmount * (taxPercentage / 100);
                        const pendingTotalCost = pendingGiftCost + pendingRentCost + pendingTaxCost;
                        const pendingNetProfit = pendingAmount - pendingTotalCost;
                        
                        const newCheckoutData = {
                            checkoutDate: firebase.firestore.FieldValue.serverTimestamp(),
                            checkoutAmount: pendingAmount,
                            cumulativeRevenueAtCheckout: currentTotalRevenue,
                            // 新增出貨數量記錄
                            checkoutPayouts: pendingPayouts,
                            cumulativePayoutsAtCheckout: totalPayouts,
                            // 新增總盈利計算
                            totalProfit: {
                                giftCost: totalGiftCost,
                                rentCost: totalRentCost,
                                taxCost: totalTaxCost,
                                totalCost: totalCost,
                                netProfit: netProfit,
                                costSettings: { giftCost, rentPercentage, taxPercentage }
                            },
                            // 新增本期盈利計算
                            periodProfit: {
                                giftCost: pendingGiftCost,
                                rentCost: pendingRentCost,
                                taxCost: pendingTaxCost,
                                totalCost: pendingTotalCost,
                                netProfit: pendingNetProfit,
                                payouts: pendingPayouts
                            }
                        };
                        const newCheckoutRef = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').add(newCheckoutData);
                        
                        hideConfirmationModal();
                        showFeedback("結帳成功！正在重新統計所有資料...", false);
                        
                        console.log('🎯 結帳完成，開始重新統計所有資料...');
                        
                        // 等待一小段時間確保資料庫寫入完成
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // 重新整理所有統計資料
                        const refreshSuccess = await refreshAllStatistics();
                        
                        if (refreshSuccess) {
                            // 顯示完成訊息
                            showFeedback("🎉 結帳完成！所有統計資料已更新。", false);
                        } else {
                            showFeedback("結帳完成，但統計更新時發生問題，請手動重新整理。", true);
                        }

                    } catch (error) {
                        hideConfirmationModal();
                        console.error("結帳失敗:", error);
                        showFeedback("結帳失敗，請稍後再試。", true);
                    }
                });
            } catch (error) {
                console.error("處理結帳時發生錯誤:", error);
                showFeedback("處理結帳時發生錯誤，請稍後再試。", true);
            }
        }

        // 統計資料重新整理函數
        async function refreshAllStatistics() {
            console.log('🔄 開始重新整理所有統計資料...');
            
            try {
                // 重新載入最新資料 (loadStoreData 會自動調用 updateUI)
                console.log('📥 重新載入門市資料...');
                await loadStoreData();
                
                // 等待資料載入完成
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 確保資料已更新
                if (!appData || !appData.machines) {
                    console.warn('⚠️ 資料載入失敗，無法重新計算統計');
                    return false;
                }
                
                console.log('📊 資料載入完成，機台數量:', appData.machines.length);
                console.log('📈 歷史記錄數量:', appData.history?.length || 0);
                
                // 手動觸發各個頁面的重新渲染
                console.log('🔄 重新渲染所有統計頁面...');
                
                // 重新處理機台資料
                const processedMachines = appData.machines.map(processMachineData);
                
                // 強制重新渲染所有統計頁面
                await renderSummaryTab();
                renderAnalysisTab();
                renderStatisticsTab();
                await renderChartsTab();
                renderProfitTab();
                renderCheckoutTab();
                
                // 如果當前正在顯示某個統計頁面，強制重新整理該頁面
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.dataset.tab;
                    console.log('🎯 當前活動頁籤:', tabName);
                    
                    // 根據當前頁籤執行對應的渲染函數
                    switch(tabName) {
                        case 'summary':
                            setTimeout(async () => await renderSummaryTab(), 200);
                            break;
                        case 'analysis':
                            setTimeout(() => renderAnalysisTab(), 200);
                            break;
                        case 'statistics':
                            setTimeout(() => renderStatisticsTab(), 200);
                            break;
                        case 'charts':
                            setTimeout(async () => await renderChartsTab(), 200);
                            break;
                        case 'profit':
                            setTimeout(() => renderProfitTab(), 200);
                            break;
                        case 'checkout':
                            setTimeout(() => renderCheckoutTab(), 200);
                            break;
                    }
                }
                
                console.log('✅ 所有統計資料重新整理完成');
                return true;
            } catch (error) {
                console.error('❌ 重新整理統計資料時發生錯誤:', error);
                return false;
            }
        }

        // 設定統計範圍的全局變數
        let currentStatsRange = 'current'; // 預設為當期統計
        let currentChartsRange = 'current';
        let currentSummaryRange = 'current';

        // 根據統計範圍篩選資料
        function filterDataByRange(data, range) {
            if (range === 'all') {
                return data; // 返回全部資料
            }
            
            // 當期資料篩選 - 根據最後結帳日期
            const lastCheckoutDate = getLastCheckoutDate();
            if (!lastCheckoutDate) {
                return data; // 如果沒有結帳記錄，返回全部資料
            }
            
            // 篩選結帳日期之後的資料
            return data.filter(record => {
                if (!record.date) return true;
                const recordDate = new Date(record.date);
                return recordDate > lastCheckoutDate;
            });
        }

        // 取得最後結帳日期
        function getLastCheckoutDate() {
            try {
                // 這裡應該從 Firebase 取得最後結帳日期
                // 暫時返回 null，表示使用全部資料
                return null;
            } catch (error) {
                console.error('取得最後結帳日期時發生錯誤:', error);
                return null;
            }
        }

        // 取得最後結帳的累計資料
        async function getLastCheckoutData() {
            if (!selectedGroupId || !selectedStoreId) {
                return { revenue: 0, payouts: 0, plays: 0 };
            }

            try {
                const checkoutCollection = db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('checkouts')
                    .orderBy('checkoutDate', 'desc');

                const checkoutSnapshot = await checkoutCollection.limit(1).get();

                if (checkoutSnapshot.empty) {
                    // 沒有結帳記錄，返回 0
                    return { revenue: 0, payouts: 0, plays: 0 };
                }

                const lastCheckout = checkoutSnapshot.docs[0].data();
                const lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                const lastCheckoutPlays = lastCheckoutRevenue / COIN_VALUE; // 從營收反推投幣次數

                console.log('📊 最後結帳累計資料:', {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                });

                return {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                };
            } catch (error) {
                console.error('取得最後結帳資料時發生錯誤:', error);
                return { revenue: 0, payouts: 0, plays: 0 };
            }
        }

        // Debug 函數 - 測試重新統計功能
        window.testRefreshStatistics = function() {
            console.log('🧪 測試重新統計功能...');
            console.log('當前資料狀態:');
            console.log('- 機台數量:', appData?.machines?.length || 0);
            console.log('- 歷史記錄數量:', appData?.history?.length || 0);
            console.log('- 選定群組ID:', selectedGroupId);
            console.log('- 選定門市ID:', selectedStoreId);
            
            // 手動觸發重新統計
            refreshAllStatistics().then(success => {
                console.log('重新統計結果:', success ? '成功' : '失敗');
            });
        };

        // Debug 函數 - 檢查當前統計設定
        window.checkStatisticsSettings = function() {
            console.log('📊 當前統計設定:');
            console.log('- 統計頁面範圍:', currentStatsRange);
            console.log('- 圖表頁面範圍:', currentChartsRange);  
            console.log('- 營業明細範圍:', currentSummaryRange);
            
            const activeTab = document.querySelector('.tab-btn.active');
            console.log('- 當前活動頁籤:', activeTab?.dataset?.tab || '無');
        };


        // --- UI RENDERING FUNCTIONS ---
        function renderGroups(groups) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            groupListContainer.innerHTML = '';
            if (groups.length === 0) {
                const noGroupsMessage = isAdmin ? 
                    '尚未建立任何單位群組。' : 
                    '您沒有權限訪問任何群組，請聯繫管理員。';
                groupListContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center py-8">${noGroupsMessage}</p>`;
                return;
            }
            groups.forEach(group => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 pt-3">
                        <button class="rename-group-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">改名</button>
                        <button class="delete-group-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">刪除</button>
                    </div>
                ` : '';
                
                const groupCard = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="card-base group-card-main cursor-pointer p-4 mb-3" data-group-id="${group.id}" data-group-name="${group.name}">
                            <h3 class="text-xl font-bold text-white truncate text-center">${group.name}</h3>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                groupListContainer.innerHTML += groupCard;
            });
            
            // 隱藏新增群組表單（如果是訪客）
            const createGroupForm = document.getElementById('create-group-form').parentElement;
            if (createGroupForm) {
                if (isAdmin) {
                    createGroupForm.style.display = 'block';
                } else {
                    createGroupForm.style.display = 'none';
                }
            }
        }
        
        function renderStores(stores) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            storeListContainer.innerHTML = ''; 
            if (stores.length === 0) {
                storeListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">此群組尚未建立任何門市。</p>';
                return;
            }
            stores.forEach(store => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 px-4 py-3">
                        <button class="edit-store-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">編輯</button>
                        <button class="delete-store-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">刪除</button>
                    </div>
                ` : '';
                
                const storeCard = `
                     <div class="bg-gray-700 rounded-lg">
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="card-base store-card-main cursor-pointer flex-grow" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                                    <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                                </div>
                                <input type="checkbox" class="store-checkbox h-6 w-6 bg-gray-800 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600 shrink-0 ml-3 cursor-pointer" value="${store.id}" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}" checked>
                            </div>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                storeListContainer.innerHTML += storeCard;
            });
        }
        
        async function updateUI() {
            if (!appData || !appData.machines) return;
            const processedMachines = appData.machines.map(processMachineData);
            await renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            await renderSummaryTab();
            renderAnalysisTab();
            renderAccountingTab();
            renderMachineManagementTab(); 
            await renderChartsTab();
            renderStatisticsTab();
            renderProfitTab();
            updateFooterAndHeader();
        }

        function renderMachineManagementTab() {
            machineListTableBody.innerHTML = '';
            if (!appData.machines || appData.machines.length === 0) {
                machineListTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">此門市尚無機台，請先建立一台。</td></tr>`;
                return;
            }
            appData.machines.forEach(machine => {
                console.log('渲染機台:', machine); // 調試用
                const row = `
                    <tr class="hover:bg-gray-700/50" data-machine-id="${machine.docId}">
                        <td class="p-4 font-medium text-white">${machine.id}</td>
                        <td class="p-4">${machine.location}</td>
                        <td class="p-4">
                            <input type="text" 
                                class="mac-address-input bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 w-full font-mono text-sm" 
                                value="${machine.mac || ''}" 
                                placeholder="083A8DE1ED14"
                                data-doc-id="${machine.docId}">
                        </td>
                        <td class="p-4 text-right">
                            <input type="number" 
                                class="device-id-input bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 w-16 text-center" 
                                value="${machine.devid || 1}" 
                                min="1" max="9"
                                data-doc-id="${machine.docId}">
                        </td>
                        <td class="p-4 text-right">${machine.initialPlays || 0}</td>
                        <td class="p-4 text-right">${machine.initialPayouts || 0}</td>
                        <td class="p-4 text-right">
                            <button class="poll-machine-btn bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded mr-1" 
                                data-doc-id="${machine.docId}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                title="讀取機台資料">
                                📊
                            </button>
                            <button class="edit-machine-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2" 
                                data-doc-id="${machine.docId}" 
                                data-id="${machine.id}"
                                data-location="${machine.location}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                data-initial-plays="${machine.initialPlays || 0}"
                                data-initial-payouts="${machine.initialPayouts || 0}">
                                修改
                           </button>
                            <button class="delete-machine-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" data-doc-id="${machine.docId}">刪除</button>
                        </td>
                    </tr>
                `;
                machineListTableBody.innerHTML += row;
            });
        }
        
        async function renderMainStats(data) {
            console.log('📊 開始計算總統計資料...');
            
            // 計算當前總數據
            const currentTotalPlays = data.reduce((sum, m) => sum + m.effectivePlays, 0);
            const currentTotalRevenue = currentTotalPlays * COIN_VALUE;
            const currentTotalPayouts = data.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 取得最後結帳的累計資料
            const lastCheckoutData = await getLastCheckoutData();
            
            // 計算當期未結帳的數據（總數據 - 最後結帳累計數據）
            const pendingPlays = Math.max(0, currentTotalPlays - lastCheckoutData.plays);
            const pendingRevenue = Math.max(0, currentTotalRevenue - lastCheckoutData.revenue);
            const pendingPayouts = Math.max(0, currentTotalPayouts - lastCheckoutData.payouts);
            const pendingAvgCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
            
            console.log('📈 統計資料計算結果:', {
                current: { plays: currentTotalPlays, revenue: currentTotalRevenue, payouts: currentTotalPayouts },
                lastCheckout: lastCheckoutData,
                pending: { plays: pendingPlays, revenue: pendingRevenue, payouts: pendingPayouts, avgCost: pendingAvgCost }
            });
            
            // 更新顯示（顯示當期未結帳數據）
            document.getElementById('total-plays').textContent = `${pendingPlays.toLocaleString()} 次`;
            document.getElementById('total-revenue').textContent = `${pendingRevenue.toLocaleString()} 元`;
            document.getElementById('total-payouts').textContent = `${pendingPayouts.toLocaleString()} 次`;
            document.getElementById('avg-cost').textContent = `${pendingAvgCost.toFixed(2)} 元/次`;
            
            // 儲存當期數據到全域變數供其他函數使用
            window.currentPendingStats = {
                plays: pendingPlays,
                revenue: pendingRevenue,
                payouts: pendingPayouts,
                avgCost: pendingAvgCost
            };
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            
            filteredData.sort((a, b) => {
                // Primary comparison based on the selected column
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                let primaryCompare = 0;
                if(typeof valA === 'number' && typeof valB === 'number') {
                    primaryCompare = valA - valB;
                } else {
                    primaryCompare = String(valA).localeCompare(String(valB), undefined, { numeric: true });
                }

                if (primaryCompare !== 0) {
                    return currentSort.direction === 'asc' ? primaryCompare : -primaryCompare;
                }

                // Secondary Sorting Logic
                if (currentSort.key !== 'id') {
                    const idCompare = a.id.localeCompare(b.id, undefined, { numeric: true });
                    if (idCompare !== 0) return idCompare;
                }

                // Tertiary Sorting Logic (or secondary if sorting by ID)
                return a.location.localeCompare(b.location, undefined, { numeric: true });
            });

            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">找不到符合條件的資料</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.effectivePlays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.effectivePayouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} 元/次</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            const cumulativePlaysInput = document.getElementById('cumulative-plays');
            const cumulativePayoutsInput = document.getElementById('cumulative-payouts');
            
            machineSelector.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            if(appData.machines.length === 0) {
                machineSelector.innerHTML = '<option value="" disabled selected>請先至「機台管理」建立機台</option>';
            } else {
                appData.machines.sort((a, b) => a.id.localeCompare(b.id)).forEach(m => {
                    machineSelector.innerHTML += `<option value="${m.docId}">${m.id} - ${m.location}</option>`;
                });
            }
            document.getElementById('entry-date').valueAsDate = new Date();
            cumulativePlaysInput.value = '';
            cumulativePayoutsInput.value = '';
            
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">尚無記帳紀錄</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr class="hover:bg-gray-700/50">
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || '未知'}</td>
                        <td class="p-4">${h.location || '未知'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                        <td class="p-4 text-right">
                           <button class="edit-history-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2"
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                修改
                           </button>
                           <button class="delete-history-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" 
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                刪除
                           </button>
                        </td>
                    </tr>`;
                });
            }
        }
        
        async function renderSummaryTab() {
            const activeButton = document.querySelector('#summary-controls .active');
            const period = activeButton ? activeButton.dataset.period : 'all';
            
            let summaryData;
            let rangeText;
            
            // 如果選擇當期，使用與主統計相同的邏輯
            if (period === 'current') {
                // 取得最後結帳的累計資料
                const lastCheckoutData = await getLastCheckoutData();
                
                // 計算當期未結帳的營業明細
                const processedMachines = appData.machines.map(processMachineData);
                
                // 計算當前所有機台的總數據
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                summaryData = processedMachines.map(machine => {
                    // 計算此機台在總數據中的占比
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // 基於占比計算此機台在最後結帳時的數據
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // 計算當期未結帳數據
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    return {
                        id: machine.id,
                        revenue: pendingRevenue,
                        payouts: pendingPayouts,
                        cost: pendingCost
                    };
                });
                
                rangeText = '當期未結帳';
            } else {
                // 其他期間使用原有邏輯
                summaryData = getAggregatedSummaryData(period);
                rangeText = period === 'all' ? '全部歷史' : 
                           period === 'weekly' ? '本週' :
                           period === 'monthly' ? '本月' :
                           period === 'quarterly' ? '本季' : '總計';
            }

            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            if (summaryData.length === 0) {
                const noDataMessage = `${rangeText}此期間無資料可供顯示`;
                summaryTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
            } else {
                summaryData.sort((a,b) => b.revenue - a.revenue).forEach((s, index) => {
                    const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                    summaryTableBody.innerHTML += `<tr class="${rowClass}">
                        <td class="p-4 font-medium text-white">${s.id}</td>
                        <td class="p-4 text-right">${s.revenue.toLocaleString()} 元</td>
                        <td class="p-4 text-right">${s.payouts.toLocaleString()} 次</td>
                        <td class="p-4 text-right">${s.cost.toFixed(2)} 元/次</td>
                    </tr>`;
                });
            }

            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red', 'indigo', 'pink'];
            
            if (summaryData.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-gray-500">無佔比資料</p>';
            } else {
                summaryData.forEach((s, index) => {
                    const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];
                    chartContainer.innerHTML += `<div class="w-full">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-${color}-300">${s.id}</span>
                            <span class="text-sm font-medium text-${color}-300">${s.revenue.toLocaleString()} 元 (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                });
            }
            
            console.log(`🏪 營業明細已更新 - 範圍: ${rangeText}, 資料筆數: ${summaryData.length}`);
        }

        function renderAnalysisTab(customRange = null) {
            const psdControls = document.getElementById('psd-controls');
            const activeButton = psdControls.querySelector('.active');
            let period = activeButton ? activeButton.dataset.period : 'all';
            let periodRevenue = 0;
            let diffDays = 1;
            let analysisTitle = activeButton ? activeButton.textContent : "自訂區間";

            // Handle custom range
            if(customRange){
                period = 'custom';
                analysisTitle = `${customRange.start} ~ ${customRange.end}`;
            }

            // Calculate revenue and days based on period
            if (period === 'all') {
                periodRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const startDate = new Date(appData.startDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            } else {
                let periodStartDate, periodEndDate;
                if (period === 'custom') {
                    periodStartDate = new Date(customRange.start + 'T00:00:00');
                    periodEndDate = new Date(customRange.end + 'T00:00:00');
                } else {
                     const now = new Date();
                    switch (period) {
                        case 'weekly':
                            const day = now.getDay();
                            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                            periodStartDate = new Date(new Date().setDate(diff));
                            periodEndDate = new Date();
                            break;
                        case 'monthly':
                            periodStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            periodEndDate = new Date();
                            break;
                        case 'quarterly':
                            const quarter = Math.floor(now.getMonth() / 3);
                            periodStartDate = new Date(now.getFullYear(), quarter * 3, 1);
                            periodEndDate = new Date();
                            break;
                    }
                }
                periodStartDate.setHours(0,0,0,0);
                periodEndDate.setHours(23,59,59,999);

                const filteredHistory = appData.history.filter(h => {
                    const recordDate = new Date(h.date);
                    return recordDate >= periodStartDate && recordDate <= periodEndDate;
                });
                periodRevenue = filteredHistory.reduce((sum, h) => sum + (h.newPlays * COIN_VALUE), 0);
                const diffTime = Math.abs(periodEndDate - periodStartDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            }
            
            const psd = periodRevenue > 0 && diffDays > 0 ? periodRevenue / diffDays : 0;
            document.getElementById('psd-display').innerHTML = `
                <div class="text-sm text-gray-400">${analysisTitle} 每日平均營收</div>
                <div class="text-2xl font-bold text-white mt-1">${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} 元 / 天</div>
                <div class="text-xs text-gray-500 mt-1">(${periodRevenue.toLocaleString()} 元 ÷ ${diffDays} 天)</div>`;

            
            // --- Detailed Analysis ---
            const observationEl = document.getElementById('analysis-observation');
            const suggestionEl = document.getElementById('analysis-suggestion');
            const processedMachines = appData.machines.map(processMachineData);

            if (processedMachines.length === 0) {
                 observationEl.innerHTML = '<p>尚無機台數據可進行分析。</p>';
                 suggestionEl.innerHTML = '<p>請先至「機台管理」建立機台，並在「每日記帳」新增紀錄。</p>';
                 return;
            }

            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

            let observationHTML = '';
            let suggestionHTML = '';

            // Top 3 Revenue
            observationHTML += '<div><h4 class="text-lg font-semibold text-green-400 mb-2">🥇 營收 TOP 3 機台 (金雞母)</h4><ul class="list-disc pl-5 space-y-1">';
            sortedByRevenue.slice(0, 3).forEach(m => {
                observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 總營收 ${m.revenue.toLocaleString()} 元</li>`;
            });
            observationHTML += '</ul></div>';
            suggestionHTML += '<div><p class="text-green-300/80">對於高營收機台，建議維持目前熱度，可考慮適時補充類似獎品，以鞏固營收表現。</p></div>';


            // Bottom 3 Revenue
            if (sortedByRevenue.length > 3) {
                 observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-yellow-400 mb-2">🥉 營收 BOTTOM 3 機台 (待觀察)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByRevenue.slice(-3).reverse().forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 總營收 ${m.revenue.toLocaleString()} 元</li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-yellow-300/80">對於營收末段班，建議觀察機台位置是否理想，或考慮更換獎品類型、調整爪力設定以提升投幣意願。</p></div>';
            }

            // Top 3 Highest Cost
             if (sortedByCost.length > 0) {
                observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-red-400 mb-2">🚨 出貨成本最高 TOP 3 機台 (警示區)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByCost.slice(0, 3).forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 平均成本 <strong class="text-red-400">${m.cost.toFixed(2)} 元/次</strong></li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-red-300/80">成本過高的機台需重點關注！建議立即檢討爪力設定與獎品價值是否匹配，避免利潤被侵蝕。</p></div>';

            }

            observationEl.innerHTML = observationHTML;
            suggestionEl.innerHTML = suggestionHTML;
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        key = new Date(d.setDate(diff)).toISOString().split('T')[0];
                        break;
                    case 'monthly': key = curr.date.substring(0, 7); break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        break;
                    default: key = curr.date; // daily
                }
                if (!acc[key]) {
                    acc[key] = { period: key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            
            // 根據選定的統計範圍獲取資料
            let data = getAggregatedData(period);
            
            // 根據統計範圍篩選資料
            if (currentStatsRange === 'current') {
                // 當期資料：僅顯示最後結帳後的資料
                data = filterDataByRange(data, 'current');
            }
            // 如果是 'all'，則使用全部資料
            
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            
            // 更新頁面標題顯示當前統計範圍
            const rangeText = currentStatsRange === 'current' ? '當期紀錄' : '全部歷史';
            const titleElement = document.querySelector('#statistics .text-xl');
            
            if(data.length === 0) {
                const noDataMessage = currentStatsRange === 'current' ? 
                    `尚無${rangeText}可供彙整` : 
                    '尚無歷史紀錄可供彙整';
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
                return;
            }
            
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.period}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} 元/次</td>
                </tr>`;
            });
            
            console.log(`📊 統計頁面已更新 - 範圍: ${rangeText}, 資料筆數: ${data.length}`);
        }
        
        async function renderChartsTab() {
            const revenueChartEl = document.getElementById('revenue-chart');
            const costChartEl = document.getElementById('cost-chart');

            revenueChartEl.innerHTML = '';
            costChartEl.innerHTML = '';

            // 根據選定的圖表範圍處理機台資料
            let processedMachines = appData.machines.map(processMachineData);
            
            // 如果選擇當期統計，使用與主統計相同的邏輯計算當期未結帳數據
            if (currentChartsRange === 'current') {
                // 取得最後結帳的累計資料
                const lastCheckoutData = await getLastCheckoutData();
                
                // 計算當前所有機台的總數據
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                // 為每個機台計算當期未結帳數據
                processedMachines = processedMachines.map(machine => {
                    // 計算此機台在總數據中的占比
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // 基於占比計算此機台在最後結帳時的數據
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // 計算當期未結帳數據
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    return {
                        ...machine,
                        totalPlays: pendingPlays,
                        totalPayouts: pendingPayouts,
                        revenue: pendingRevenue,
                        cost: pendingCost
                    };
                });
            }
            
            const rangeText = currentChartsRange === 'current' ? '當期' : '全部歷史';

            if (processedMachines.length === 0 || processedMachines.every(m => m.revenue === 0)) {
                const noDataMessage = `尚無${rangeText}資料可繪製圖表`;
                revenueChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
                costChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
            } else {
                const maxRevenue = Math.max(...processedMachines.map(m => m.revenue), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.revenue / maxRevenue * 100);
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${machine.revenue.toLocaleString()} 元
                                </div>
                            </div>
                        </div>
                    `;
                    revenueChartEl.innerHTML += chartItem;
                });

                const maxCost = Math.max(...processedMachines.map(m => m.cost), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.cost / maxCost * 100);
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${machine.cost.toFixed(2)} 元/次
                                </div>
                            </div>
                        </div>
                    `;
                    costChartEl.innerHTML += chartItem;
                });
            }
            
            const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
            if (appData.history.length > 0) {
                const latestDate = appData.history.reduce((max, h) => h.date > max ? h.date : max, appData.history[0].date);
                trendChartDatePicker.value = latestDate;
            } else {
                trendChartDatePicker.valueAsDate = new Date();
            }
            
            renderTrendChartByDate();
            
            console.log(`📈 圖表頁面已更新 - 範圍: ${rangeText}, 機台數: ${processedMachines.length}`);
        }

        function renderTrendChartByDate() {
            const trendChartContentEl = document.getElementById('trend-chart-content');
            const selectedDate = trendChartDatePicker.value;

            trendChartContentEl.innerHTML = '';

            if (!selectedDate) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">請選擇一個日期來查看數據</p>';
                return;
            }

            const dailyRecords = appData.history.filter(h => h.date === selectedDate);

            if (dailyRecords.length === 0) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">該日期沒有記帳紀錄</p>';
                return;
            }
            
            const aggregatedData = dailyRecords.reduce((acc, record) => {
                const key = `${record.machineId}|${record.location}`;
                if (!acc[key]) {
                    acc[key] = {
                        machineId: record.machineId,
                        location: record.location,
                        newPlays: 0,
                        newPayouts: 0
                    };
                }
                acc[key].newPlays += record.newPlays;
                acc[key].newPayouts += record.newPayouts;
                return acc;
            }, {});
            const aggregatedRecords = Object.values(aggregatedData);

            const recordsWithCalc = aggregatedRecords.map(r => {
                const revenue = r.newPlays * COIN_VALUE;
                const cost = r.newPayouts > 0 ? revenue / r.newPayouts : 0;
                return {...r, revenue, cost };
            });

            const maxRevenue = Math.max(...recordsWithCalc.map(r => r.revenue), 1);
            const maxCost = Math.max(...recordsWithCalc.map(r => r.cost), 1);
            
            let totalDayRevenue = 0;
            let totalDayPayouts = 0;
            
            recordsWithCalc.forEach(record => {
                totalDayRevenue += record.revenue;
                totalDayPayouts += record.newPayouts;
            });

            const revenueCharts = [...recordsWithCalc].sort((a,b) => b.revenue - a.revenue).map(record => {
                const barWidth = (record.revenue / maxRevenue) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.revenue.toLocaleString()} 元
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const costCharts = [...recordsWithCalc].sort((a,b) => b.cost - a.cost).map(record => {
                const barWidth = (record.cost / maxCost) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.cost.toFixed(2)} 元/次
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalDayCost = totalDayPayouts > 0 ? totalDayRevenue / totalDayPayouts : 0;

            trendChartContentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-h-80 overflow-y-auto pr-2">
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">當日營收</h4>
                           <p class="text-sm text-blue-300">總計：${totalDayRevenue.toLocaleString()} 元</p>
                        </div>
                        <div class="space-y-4">${revenueCharts}</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">當日出貨成本</h4>
                           <p class="text-sm text-yellow-300">平均：${totalDayCost.toFixed(2)} 元/次</p>
                        </div>
                        <div class="space-y-4">${costCharts}</div>
                    </div>
                </div>
            `;
        }
        
        // 盈利計算功能
        function renderProfitTab() {
            if (!appData || !appData.machines) return;
            
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 更新基本資訊
            document.getElementById('profit-revenue').textContent = `${totalRevenue.toLocaleString()} 元`;
            document.getElementById('profit-payouts').textContent = `${totalPayouts.toLocaleString()} 次`;
            
            // 載入儲存的成本設定
            loadCostSettings();
            
            // 計算盈利
            calculateProfit();
        }
        
        function loadCostSettings() {
            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
            document.getElementById('gift-cost').value = settings.giftCost || 50;
            document.getElementById('rent-percentage').value = settings.rentPercentage || 30;
            document.getElementById('tax-percentage').value = settings.taxPercentage || 5;
        }
        
        function saveCostSettings() {
            const settings = {
                giftCost: parseFloat(document.getElementById('gift-cost').value) || 50,
                rentPercentage: parseFloat(document.getElementById('rent-percentage').value) || 30,
                taxPercentage: parseFloat(document.getElementById('tax-percentage').value) || 5
            };
            localStorage.setItem(`costSettings_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(settings));
            showFeedback('成本設定已儲存！', false);
        }
        
        function calculateProfit() {
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 獲取成本設定
            const giftCost = parseFloat(document.getElementById('gift-cost').value) || 50;
            const rentPercentage = parseFloat(document.getElementById('rent-percentage').value) || 30;
            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 5;
            
            // 獲取計算範圍
            const calculationScope = document.querySelector('input[name="profit-calculation-scope"]:checked').value;
            
            let calculationRevenue, calculationPayouts, scopeTitle;
            
            if (calculationScope === 'pending') {
                // 計算待結帳期間的數據
                const lastCheckoutData = JSON.parse(localStorage.getItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`) || '{}');
                const lastCheckoutRevenue = lastCheckoutData.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckoutData.cumulativePayoutsAtCheckout || 0;
                
                calculationRevenue = totalRevenue - lastCheckoutRevenue;
                calculationPayouts = totalPayouts - lastCheckoutPayouts;
                scopeTitle = '本期待結帳';
            } else {
                // 總累積計算
                calculationRevenue = totalRevenue;
                calculationPayouts = totalPayouts;
                scopeTitle = '總累積';
            }
            
            // 計算各項成本
            const totalGiftCost = calculationPayouts * giftCost;
            const totalRentCost = calculationRevenue * (rentPercentage / 100);
            const totalTaxCost = calculationRevenue * (taxPercentage / 100);
            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
            
            // 計算淨利潤
            const netProfit = calculationRevenue - totalCost;
            const profitMargin = calculationRevenue > 0 ? (netProfit / calculationRevenue) * 100 : 0;
            const profitPerPayout = calculationPayouts > 0 ? netProfit / calculationPayouts : 0;
            
            // 更新UI - 顯示計算範圍
            document.getElementById('profit-revenue').textContent = `${calculationRevenue.toLocaleString()} 元`;
            document.getElementById('profit-payouts').textContent = `${calculationPayouts.toLocaleString()} 次`;
            
            // 更新成本明細標題以顯示計算範圍
            const costDetailTitle = document.querySelector('.bg-gray-700\\/50 h4');
            if (costDetailTitle && costDetailTitle.textContent.includes('成本明細')) {
                costDetailTitle.textContent = `💸 成本明細 (${scopeTitle})`;
            }
            
            document.getElementById('total-gift-cost').textContent = `${totalGiftCost.toLocaleString()} 元`;
            document.getElementById('total-rent-cost').textContent = `${totalRentCost.toLocaleString()} 元`;
            document.getElementById('total-tax-cost').textContent = `${totalTaxCost.toLocaleString()} 元`;
            document.getElementById('total-cost').textContent = `${totalCost.toLocaleString()} 元`;
            
            document.getElementById('profit-total-revenue').textContent = `${calculationRevenue.toLocaleString()} 元`;
            document.getElementById('profit-total-cost').textContent = `${totalCost.toLocaleString()} 元`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString()} 元`;
            document.getElementById('profit-net').textContent = `${netProfit.toLocaleString()} 元`;
            
            // 設定顏色
            const profitColor = netProfit >= 0 ? 'text-green-300' : 'text-red-300';
            document.getElementById('net-profit').className = `${profitColor} font-bold text-xl`;
            document.getElementById('profit-net').parentElement.className = netProfit >= 0 ? 
                'bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl' : 
                'bg-gradient-to-br from-red-600 to-red-700 p-6 rounded-xl';
            
            document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('profit-margin').className = profitMargin >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
            
            document.getElementById('profit-per-payout').textContent = `${profitPerPayout.toFixed(2)} 元`;
            document.getElementById('profit-per-payout').className = profitPerPayout >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
        }

        async function renderCheckoutTab() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
            const lastCheckoutDateEl = document.getElementById('last-checkout-date');
            const pendingAmountEl = document.getElementById('pending-checkout-amount');

            checkoutHistoryBody.innerHTML = '';

            try {
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                let lastCheckoutRevenue = 0;
                if (checkouts.length > 0) {
                    const lastCheckout = checkouts[0];
                    lastCheckoutDateEl.textContent = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    
                    // 保存最後結帳資訊到 localStorage 供盈利計算使用
                    const lastCheckoutData = {
                        cumulativeRevenueAtCheckout: lastCheckout.cumulativeRevenueAtCheckout,
                        cumulativePayoutsAtCheckout: lastCheckout.cumulativePayoutsAtCheckout || 0,
                        checkoutDate: lastCheckout.checkoutDate
                    };
                    localStorage.setItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(lastCheckoutData));

                    checkouts.forEach((checkout, index) => {
                         const prevCheckoutDate = index < checkouts.length - 1 ? new Date(checkouts[index + 1].checkoutDate.toDate()).toLocaleString() : appData.startDate;
                         
                         // 取得當期出貨數量
                         const currentPayouts = checkout.checkoutPayouts || 0;
                         
                         // 取得當期盈利信息
                         const periodProfit = checkout.periodProfit || {};
                         const periodNetProfit = periodProfit.netProfit || 0;
                         const profitColor = periodNetProfit >= 0 ? 'text-green-400' : 'text-red-400';
                         
                         // 檢查是否有盈利計算數據
                         const hasProfitData = checkout.periodProfit || checkout.totalProfit;
                         
                        const row = `
                            <tr class="hover:bg-gray-700/50">
                                <td class="p-3 text-sm">${new Date(checkout.checkoutDate.toDate()).toLocaleString()}</td>
                                <td class="p-3 text-right text-sm font-semibold">${checkout.checkoutAmount.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm">${currentPayouts.toLocaleString()} 次</td>
                                <td class="p-3 text-right text-sm font-semibold ${profitColor}">${periodNetProfit.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm text-gray-400">${checkout.cumulativeRevenueAtCheckout.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm">
                                    ${hasProfitData ? 
                                        `<button class="view-profit-detail-btn bg-purple-600 hover:bg-purple-700 text-white text-xs py-1 px-2 rounded mr-1"
                                            data-checkout-data='${JSON.stringify(checkout)}'>詳情</button>` : 
                                        '<span class="text-gray-500 text-xs">無數據</span>'
                                    }
                                </td>
                                <td class="p-3 text-right">
                                    <button class="download-checkout-pdf-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded"
                                        data-checkout-id="${checkout.id}"
                                        data-checkout-date="${new Date(checkout.checkoutDate.toDate()).toLocaleString()}"
                                        data-prev-checkout-date="${prevCheckoutDate}"
                                        data-amount="${checkout.checkoutAmount}"
                                        data-cumulative="${checkout.cumulativeRevenueAtCheckout}">
                                        報告
                                    </button>
                                </td>
                            </tr>
                        `;
                        checkoutHistoryBody.innerHTML += row;
                    });
                    
                    // 渲染圖表和統計數據
                    renderCheckoutCharts(checkouts);
                    renderCheckoutStats(checkouts);
                } else {
                    lastCheckoutDateEl.textContent = '無 (以營業起始日為準)';
                    checkoutHistoryBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">尚無結帳紀錄</td></tr>`;
                    
                    // 清空圖表和統計
                    clearCheckoutCharts();
                    clearCheckoutStats();
                }
                
                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;
                pendingAmountEl.textContent = `${pendingAmount.toLocaleString()} 元`;

            } catch (error) {
                console.error("讀取結帳歷史失敗:", error);
                checkoutHistoryBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-400">無法讀取結帳歷史</td></tr>`;
                clearCheckoutCharts();
                clearCheckoutStats();
            }
        }

        // 渲染結帳圖表
        function renderCheckoutCharts(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutCharts();
                return;
            }

            // 按時間排序 (舊到新)
            const sortedCheckouts = [...checkouts].reverse();
            
            // 結帳金額趨勢圖 - 使用線圖 + 區域填充
            renderLineChart('checkout-amount-chart', sortedCheckouts, 'checkoutAmount', 'blue', '結帳金額');
            
            // 累積營收趨勢圖 - 使用線圖 + 區域填充
            renderLineChart('checkout-cumulative-chart', sortedCheckouts, 'cumulativeRevenueAtCheckout', 'green', '累積營收');
        }

        // 渲染線圖
        function renderLineChart(elementId, data, valueKey, color, label) {
            const chartEl = document.getElementById(elementId);
            const values = data.map(d => d[valueKey]);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const valueRange = maxValue - minValue || 1;
            
            const chartWidth = 400;
            const chartHeight = 200;
            const padding = 40;
            
            chartEl.innerHTML = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4">
                    <svg width="100%" height="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" class="overflow-visible">
                        <!-- 網格線 -->
                        ${Array.from({length: 5}, (_, i) => {
                            const y = padding + (i * (chartHeight - 2 * padding)) / 4;
                            return `<line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" stroke="#374151" stroke-width="1" opacity="0.3"/>`;
                        }).join('')}
                        
                        <!-- 區域填充 -->
                        <defs>
                            <linearGradient id="gradient-${color}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.3"/>
                                <stop offset="100%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.05"/>
                            </linearGradient>
                        </defs>
                        
                        <path d="M${padding},${chartHeight - padding} ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `L${x},${y}`;
                        }).join(' ')} L${chartWidth - padding},${chartHeight - padding} Z" 
                              fill="url(#gradient-${color})" stroke="none"/>
                        
                        <!-- 線條 -->
                        <path d="M${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `${index === 0 ? 'M' : 'L'}${x},${y}`;
                        }).join(' ')}" 
                              fill="none" 
                              stroke="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                              stroke-width="3" 
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                        
                        <!-- 數據點 -->
                        ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                            const value = item[valueKey].toLocaleString();
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        fill="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                                        stroke="#1f2937" 
                                        stroke-width="2" 
                                        class="cursor-pointer transition-all hover:r-6"
                                        data-tooltip="${date}: ${value} 元">
                                    <title>${date}: ${value} 元</title>
                                </circle>
                            `;
                        }).join('')}
                        
                        <!-- Y軸標籤 -->
                        ${Array.from({length: 5}, (_, i) => {
                            const value = minValue + (i * valueRange) / 4;
                            const y = chartHeight - padding - (i * (chartHeight - 2 * padding)) / 4;
                            return `<text x="${padding - 10}" y="${y + 4}" fill="#9ca3af" text-anchor="end" font-size="10">${Math.round(value).toLocaleString()}</text>`;
                        }).join('')}
                    </svg>
                    
                    <!-- 數據點標籤 -->
                    <div class="absolute bottom-2 left-0 right-0 flex justify-between px-10 text-xs text-gray-400">
                        ${data.map((item, index) => {
                            if (data.length <= 5 || index % Math.ceil(data.length / 5) === 0 || index === data.length - 1) {
                                const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                                return `<span class="transform -rotate-45 origin-bottom-left">${date}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <!-- 圖例 -->
                    <div class="absolute top-2 right-2 flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-gradient-to-br ${color === 'blue' ? 'from-blue-400 to-blue-600' : 'from-green-400 to-green-600'}"></div>
                        <span class="text-xs text-gray-300">${label}</span>
                    </div>
                </div>
            `;
        }

        // 渲染結帳統計
        function renderCheckoutStats(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutStats();
                return;
            }

            const totalCheckouts = checkouts.length;
            const totalAmount = checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0);
            const avgAmount = totalAmount / totalCheckouts;
            const maxAmount = Math.max(...checkouts.map(c => c.checkoutAmount));
            
            // 計算累計盈利 - 使用當期盈利記錄加總
            const totalProfit = checkouts.reduce((sum, checkout) => {
                const periodProfit = checkout.periodProfit || {};
                return sum + (periodProfit.netProfit || 0);
            }, 0);

            document.getElementById('total-checkouts').textContent = totalCheckouts.toLocaleString();
            document.getElementById('avg-checkout-amount').textContent = `${Math.round(avgAmount).toLocaleString()} 元`;
            document.getElementById('max-checkout-amount').textContent = `${maxAmount.toLocaleString()} 元`;
            
            // 更新累計盈利顯示
            const profitColor = totalProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const totalProfitElement = document.getElementById('total-profit-summary');
            totalProfitElement.textContent = `${totalProfit.toLocaleString()} 元`;
            totalProfitElement.className = `text-2xl font-bold ${profitColor}`;
        }

        // 清空圖表
        function clearCheckoutCharts() {
            const emptyChartHtml = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-gray-500 text-sm">暫無數據可顯示圖表</p>
                        <p class="text-gray-600 text-xs mt-1">完成首次結帳後將顯示趨勢圖</p>
                    </div>
                </div>
            `;
            document.getElementById('checkout-amount-chart').innerHTML = emptyChartHtml;
            document.getElementById('checkout-cumulative-chart').innerHTML = emptyChartHtml;
        }

        // 清空統計
        function clearCheckoutStats() {
            document.getElementById('total-checkouts').textContent = '0';
            document.getElementById('avg-checkout-amount').textContent = '0 元';
            document.getElementById('max-checkout-amount').textContent = '0 元';
            document.getElementById('total-profit-summary').textContent = '0 元';
            document.getElementById('total-profit-summary').className = 'text-2xl font-bold text-white';
        }


        function updateFooterAndHeader() {
            // 更新頁首資訊
            const headerEl = document.querySelector('#accounting-header');
            if (headerEl && currentGroupName && currentStoreName) {
                headerEl.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4">
                        ${currentGroupName} - ${currentStoreName} 帳務紀錄
                    </h2>
                `;
            }

            // 更新表格表尾統計
            const tableFooter = document.querySelector('#accounting-table tfoot');
            if (tableFooter && accountingData && accountingData.length > 0) {
                const totalRevenue = accountingData.reduce((sum, item) => sum + (item.revenue || 0), 0);
                const totalPayouts = accountingData.reduce((sum, item) => sum + (item.payouts || 0), 0);
                const avgCost = accountingData.length > 0 ? 
                    accountingData.reduce((sum, item) => sum + (item.cost || 0), 0) / accountingData.length : 0;

                tableFooter.innerHTML = `
                    <tr class="bg-gray-700/50 font-bold">
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">總計</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">${totalRevenue.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">${totalPayouts.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-blue-400 uppercase tracking-wider">${avgCost.toFixed(2)}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                    </tr>
                `;
            }
        }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        function getPeriodDateRange(period, dateStr) {
            const today = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            switch (period) {
                case 'daily':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'weekly':
                    const day = today.getDay();
                    const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                    startDate = new Date(new Date(today).setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'yearly':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            return {
                startDate: toYYYYMMDD(startDate),
                endDate: toYYYYMMDD(endDate)
            };
        }

        async function getStoreSummaryForPeriod(storeId, period, date) {
            if (period === 'all') {
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('machines').get();
                const machines = machinesSnapshot.docs.map(doc => doc.data());
                return machines.map(m => {
                    const processed = processMachineData(m);
                    return { id: m.id, location: m.location, revenue: processed.revenue, payouts: processed.effectivePayouts, cost: processed.cost };
                });
            }

            const { startDate, endDate } = getPeriodDateRange(period, date);
            
            const historySnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('history').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const filteredHistory = historySnapshot.docs.map(doc => doc.data());

            if (filteredHistory.length === 0) return [];

            const summary = filteredHistory.reduce((acc, curr) => {
                const key = `${curr.machineId}|${curr.location}`;
                if (!acc[key]) {
                     acc[key] = { id: curr.machineId, location: curr.location, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});
            
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        async function handleDownloadAllStoresReport() {
            if(!selectedGroupId) return alert('No group selected.');
            const btn = document.getElementById('download-all-stores-report-btn');
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert("請至少勾選一個要下載的門市。");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>處理中...</span>`;
            btn.disabled = true;

            const period = reportPeriodSelector.value;
            const date = reportDatePicker.value;
            const periodText = reportPeriodSelector.options[reportPeriodSelector.selectedIndex].text;

            if (period !== 'all' && !date) {
                alert('請選擇一個基準日期！');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const storesToDownload = Array.from(selectedStoreCheckboxes).map(cb => ({
                    id: cb.dataset.storeId,
                    name: cb.dataset.storeName,
                    startDate: cb.dataset.startDate
                }));

                const csvRows = [];
                let grandTotalRevenue = 0;
                let grandTotalPayouts = 0;
                let grandTotalDays = 0;
                let psdCalculated = false;
                
                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    if (summaryData.length > 0) {
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        grandTotalRevenue += storeTotalRevenue;
                        grandTotalPayouts += storeTotalPayouts;
                    }
                }

                const grandTotalAvgCost = grandTotalPayouts > 0 ? grandTotalRevenue / grandTotalPayouts : 0;

                csvRows.push(`所選門市營運總計 - ${periodText}${period !== 'all' ? ' (' + date + ')' : ''}`);
                csvRows.push(`報表產生日期: ${new Date().toLocaleString()}`);
                csvRows.push("");
                csvRows.push("--- 全選門市總計 ---");
                csvRows.push(["項目", "總計"].join(','));
                csvRows.push(["總營收", grandTotalRevenue].join(','));
                csvRows.push(["總出貨數", grandTotalPayouts].join(','));
                csvRows.push(["總平均出貨成本(元/次)", grandTotalAvgCost.toFixed(2)].join(','));
                
                let grandPsd = 0;
                if (period === 'all') {
                    // Cannot accurately calculate combined PSD for 'all' without a common start date.
                } else {
                    const { startDate, endDate } = getPeriodDateRange(period, date);
                    const d1 = new Date(startDate);
                    const d2 = new Date(endDate);
                    const diffTime = Math.abs(d2 - d1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    grandPsd = grandTotalRevenue / diffDays;
                    csvRows.push([`期間PSD (每日平均營收)`, `"${grandPsd.toFixed(2)} 元/天"`].join(","));
                }


                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    
                    csvRows.push("");
                    csvRows.push(`--- ${store.name} ---`);
                    const summaryTableHeaders = ["機台編號", "位置", "期間營收", "期間出貨數", "期間出貨成本(元/次)"];
                    csvRows.push(summaryTableHeaders.join(","));

                    if (summaryData.length > 0) {
                        summaryData.forEach(item => {
                            csvRows.push([
                                item.id,
                                `"${item.location}"`,
                                item.revenue,
                                item.payouts,
                                item.cost.toFixed(2)
                            ].join(","));
                        });
                        
                        // Add Store Total and PSD
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        const storeAvgCost = storeTotalPayouts > 0 ? storeTotalRevenue / storeTotalPayouts : 0;
                        
                        csvRows.push(""); // blank line
                        csvRows.push([`門市總計`, "", storeTotalRevenue, storeTotalPayouts, storeAvgCost.toFixed(2)].join(","));

                        let psd = 0;
                        if (period === 'all') {
                             if (store.startDate) {
                                const storeStartDate = new Date(store.startDate);
                                const today = new Date();
                                const diffTime = Math.abs(today - storeStartDate);
                                const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
                                const machineDocs = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(store.id).collection('machines').get();
                                const machines = machineDocs.docs.map(doc => doc.data());
                                const totalCumulativeRevenue = machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                                psd = totalCumulativeRevenue / diffDays;
                            }
                        } else {
                            const { startDate, endDate } = getPeriodDateRange(period, date);
                            const d1 = new Date(startDate);
                            const d2 = new Date(endDate);
                            const diffTime = Math.abs(d2 - d1);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            psd = storeTotalRevenue / diffDays;
                        }
                         csvRows.push([`門市PSD (每日平均營收)`, "", `"${psd.toFixed(2)} 元/天"`].join(","));


                    } else {
                        csvRows.push("此期間尚無數據");
                    }
                }
                
                let csvContent = "\uFEFF";
                csvContent += csvRows.join("\n");

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `${selectedGroupName}-營運報表-${periodText}-${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("下載全門市報表失敗:", error);
                alert("下載報表時發生錯誤，請稍後再試。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // --- EVENT LISTENERS ---
        
        // 管理者界面事件
        adminBtn.addEventListener('click', showAdminPage);
        backToMainBtn.addEventListener('click', hideAdminPage);

        // 頁面權限快捷按鈕事件
        document.getElementById('select-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('select-readonly-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            // 只勾選檢視相關權限
            const readonlyPermissions = ['details', 'summary', 'analysis', 'charts', 'statistics'];
            readonlyPermissions.forEach(permission => {
                const checkbox = document.querySelector(`.page-permission-checkbox[value="${permission}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        document.getElementById('clear-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
        });

        // 管理員密碼更新
        adminPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newUsername = document.getElementById('new-username').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAdminFeedback('admin-password-feedback', '新密碼與確認密碼不符', true);
                return;
            }

            try {
                await window.adminConfig.updateAdminCredentials(newUsername, newPassword, currentPassword);
                showAdminFeedback('admin-password-feedback', '管理員帳密更新成功');
                adminPasswordForm.reset();
                document.getElementById('new-username').value = newUsername;
            } catch (error) {
                showAdminFeedback('admin-password-feedback', error.message, true);
            }
        });

        // 訪客帳號管理
        guestAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('guest-username').value;
            const password = document.getElementById('guest-password').value;
            const selectedGroups = Array.from(document.querySelectorAll('.group-permission-checkbox:checked'))
                .map(cb => cb.value);
            const selectedPagePermissions = Array.from(document.querySelectorAll('.page-permission-checkbox:checked'))
                .map(cb => cb.value);

            const isEditing = guestAccountForm.dataset.editingId;

            try {
                if (isEditing) {
                    await window.adminConfig.updateGuestAccount(isEditing, {
                        username,
                        password,
                        allowedGroups: selectedGroups,
                        pagePermissions: selectedPagePermissions
                    });
                    showAdminFeedback('guest-account-feedback', '訪客帳號更新成功');
                    cancelGuestEdit();
                } else {
                    await window.adminConfig.addGuestAccount(username, password, selectedGroups, selectedPagePermissions);
                    showAdminFeedback('guest-account-feedback', '訪客帳號新增成功');
                }
                
                guestAccountForm.reset();
                document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
                loadGuestAccountsTable();
            } catch (error) {
                showAdminFeedback('guest-account-feedback', error.message, true);
            }
        });

        // 取消編輯
        cancelGuestEditBtn.addEventListener('click', cancelGuestEdit);

        function cancelGuestEdit() {
            delete guestAccountForm.dataset.editingId;
            guestAccountForm.reset();
            document.querySelectorAll('.group-permission-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            cancelGuestEditBtn.classList.add('hidden');
            guestAccountForm.querySelector('button[type="submit"]').textContent = '新增訪客';
        }

        // 訪客帳號表格事件
        guestAccountsTable.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-guest-btn');
            const deleteBtn = e.target.closest('.delete-guest-btn');

            if (editBtn) {
                const guestId = editBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest) {
                    // 填入編輯表單
                    document.getElementById('guest-username').value = guest.username;
                    document.getElementById('guest-password').value = guest.password;
                    
                    // 設定群組權限
                    document.querySelectorAll('.group-permission-checkbox').forEach(cb => {
                        cb.checked = guest.allowedGroups.includes(cb.value);
                    });
                    
                    // 設定頁面權限
                    document.querySelectorAll('.page-permission-checkbox').forEach(cb => {
                        cb.checked = (guest.pagePermissions || []).includes(cb.value);
                    });
                    
                    // 切換到編輯模式
                    guestAccountForm.dataset.editingId = guestId;
                    cancelGuestEditBtn.classList.remove('hidden');
                    guestAccountForm.querySelector('button[type="submit"]').textContent = '更新訪客';
                }
            } else if (deleteBtn) {
                const guestId = deleteBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest && confirm(`確定要刪除訪客帳號「${guest.username}」嗎？`)) {
                    try {
                        await window.adminConfig.deleteGuestAccount(guestId);
                        loadGuestAccountsTable();
                        showAdminFeedback('guest-account-feedback', '訪客帳號已刪除');
                    } catch (error) {
                        showAdminFeedback('guest-account-feedback', error.message, true);
                    }
                }
            }
        });

        // 系統工具事件
        exportConfigBtn.addEventListener('click', () => {
            const config = window.adminConfig.exportConfig();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        importConfigBtn.addEventListener('click', () => {
            configFileInput.click();
        });

        configFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await window.adminConfig.importConfig(e.target.result);
                        alert('設定匯入成功');
                        loadAdminInterface();
                    } catch (error) {
                        alert('匯入失敗：' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        resetConfigBtn.addEventListener('click', async () => {
            if (confirm('確定要重置所有設定嗎？這將刪除所有訪客帳號並恢復預設管理員密碼。')) {
                await window.adminConfig.resetToDefault();
                alert('系統已重置為預設設定');
                loadAdminInterface();
            }
        });

        groupListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.group-card-main');
            const renameBtn = e.target.closest('.rename-group-btn');
            const deleteBtn = e.target.closest('.delete-group-btn');

            if (mainCard) {
                const groupId = mainCard.dataset.groupId;
                const groupName = mainCard.dataset.groupName;
                showStoreSelectionPage(groupId, groupName);
            } else if (renameBtn) {
                const groupId = renameBtn.dataset.groupId;
                const groupName = renameBtn.dataset.groupName;
                handleRenameGroup(groupId, groupName);
            } else if (deleteBtn) {
                const groupId = deleteBtn.dataset.groupId;
                const groupName = deleteBtn.dataset.groupName;
                handleDeleteGroup(groupId, groupName);
            }
        });

        storeListContainer.addEventListener('click', async (e) => {
            const mainCard = e.target.closest('.store-card-main');
            const editBtn = e.target.closest('.edit-store-btn');
            const deleteBtn = e.target.closest('.delete-store-btn');

            if (mainCard) {
                const storeId = mainCard.dataset.storeId;
                const storeName = mainCard.dataset.storeName;
                const startDate = mainCard.dataset.startDate;
                await showReportPage(storeId, storeName, startDate);
            } else if (editBtn) {
                document.getElementById('edit-store-id').value = editBtn.dataset.storeId;
                document.getElementById('edit-store-name').value = editBtn.dataset.storeName;
                document.getElementById('edit-store-start-date').value = editBtn.dataset.startDate;
                editStoreModal.classList.remove('hidden');
            } else if (deleteBtn) {
                const storeId = deleteBtn.dataset.storeId;
                const storeName = deleteBtn.dataset.storeName;
                handleDeleteStore(storeId, storeName);
            }
        });
        
        selectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = true);
        });

        deselectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = false);
        });

        createGroupForm.addEventListener('submit', handleCreateGroup);
        createStoreForm.addEventListener('submit', handleCreateStore);
        editStoreForm.addEventListener('submit', handleUpdateStore);
        editStoreCancelBtn.addEventListener('click', () => editStoreModal.classList.add('hidden'));

        addMachineForm.addEventListener('submit', handleAddMachine);
        downloadAllStoresBtn.addEventListener('click', () => {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert('請先勾選要包含在報表中的門市');
                return;
            }
            
            showCustomStoreReportModal();
        });
        trendChartDatePicker.addEventListener('change', renderTrendChartByDate);

        locationPresets.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-tag')) {
                document.getElementById('new-machine-location').value = e.target.textContent;
            }
        });

        reportPeriodSelector.addEventListener('change', () => {
            if (reportPeriodSelector.value === 'all') {
                reportDatePicker.classList.add('hidden');
            } else {
                reportDatePicker.classList.remove('hidden');
                if (!reportDatePicker.value) {
                    reportDatePicker.valueAsDate = new Date();
                }
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
        });
        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        
        machineListTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-machine-btn')) {
                handleDeleteMachine(e.target.dataset.docId);
            } else if (e.target.classList.contains('edit-machine-btn')) {
                const btn = e.target;
                document.getElementById('edit-machine-doc-id').value = btn.dataset.docId;
                document.getElementById('edit-machine-id').value = btn.dataset.id;
                document.getElementById('edit-machine-location').value = btn.dataset.location;
                document.getElementById('edit-machine-mac').value = btn.dataset.mac || '';
                document.getElementById('edit-machine-devid').value = btn.dataset.devid || '';
                document.getElementById('edit-machine-initial-plays').value = btn.dataset.initialPlays;
                document.getElementById('edit-machine-initial-payouts').value = btn.dataset.initialPayouts;
                editMachineModal.classList.remove('hidden');
            } else if (e.target.classList.contains('poll-machine-btn')) {
                const btn = e.target;
                const mac = btn.dataset.mac;
                const devid = btn.dataset.devid;
                
                if (!mac) {
                    alert('請先設定機台 MAC 位址');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = '📊';
                btn.classList.add('opacity-50');
                
                try {
                    await pollSingleMachine(mac, devid || 1);
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            }
        });
        editMachineForm.addEventListener('submit', handleUpdateMachine);
        editMachineCancelBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));

        historyTableBody.addEventListener('click', (e) => {
            const button = e.target;
            if (button.classList.contains('delete-history-btn')) {
                handleDeleteHistory(button.dataset.docId, button.dataset.machineId, button.dataset.location, parseInt(button.dataset.plays, 10), parseInt(button.dataset.payouts, 10));
            } else if (button.classList.contains('edit-history-btn')) {
                document.getElementById('edit-history-doc-id').value = button.dataset.docId;
                document.getElementById('edit-history-machine-id').value = button.dataset.machineId;
                document.getElementById('edit-history-location').value = button.dataset.location;
                document.getElementById('edit-history-old-plays').value = button.dataset.plays;
                document.getElementById('edit-history-old-payouts').value = button.dataset.payouts;
                document.getElementById('edit-history-plays').value = button.dataset.plays;
                document.getElementById('edit-history-payouts').value = button.dataset.payouts;
                editHistoryModal.classList.remove('hidden');
            }
        });
        editHistoryForm.addEventListener('submit', handleUpdateHistory);
        editHistoryCancelBtn.addEventListener('click', () => editHistoryModal.classList.add('hidden'));
        
        backToGroupsBtn.addEventListener('click', showGroupSelectionPage);
        backToStoresBtn.addEventListener('click', () => showStoreSelectionPage(selectedGroupId, selectedGroupName));

        allTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                const activeContent = document.getElementById(tab.dataset.tab);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                if (tab.dataset.tab === 'charts') { await renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
                if (tab.dataset.tab === 'summary') { await renderSummaryTab(); }
                if (tab.dataset.tab === 'analysis') { renderAnalysisTab(); }
                 if (tab.dataset.tab === 'checkout') { 
                    headerDownloadButtons.classList.add('hidden');
                    renderCheckoutTab(); 
                } else {
                    headerDownloadButtons.classList.remove('hidden');
                }
            });
        });

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        summaryControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                summaryControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderSummaryTab();
            }
        });
        
        psdControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const customRange = document.getElementById('psd-custom-range');
                if(e.target.dataset.period === 'custom'){
                    customRange.classList.remove('hidden');
                    customRange.classList.add('flex');
                } else {
                    customRange.classList.add('hidden');
                    customRange.classList.remove('flex');
                    e.target.classList.add('active');
                    renderAnalysisTab();
                }
            }
        });

        psdCalculateBtn.addEventListener('click', () => {
            const start = psdStartDate.value;
            const end = psdEndDate.value;
            if (start && end && start <= end) {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                renderAnalysisTab({start, end});
            } else {
                alert('請選擇有效的起訖日期！');
            }
        });

        // --- HTTP 連接狀態管理 (已停用 MQTT) ---
        // MQTT 按鈕事件已停用，改用 HTTP 方式
        // const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        // if (mqttConnectBtn) {
        //     mqttConnectBtn.addEventListener('click', function() { /* MQTT 已停用 */ });
        // }
        
        // HTTP 測試連線按鈕
        const mqttTestBtn = document.getElementById('mqtt-test-btn');
        if (mqttTestBtn) {
            mqttTestBtn.addEventListener('click', async function() {
                // 測試 HTTP 連線
                await testHttpConnection();
            });
        }

        // 立即輪詢所有機台按鈕
        const pollAllBtn = document.getElementById('poll-all-btn');
        if (pollAllBtn) {
            pollAllBtn.addEventListener('click', async function() {
                console.log('立即輪詢按鈕被點擊');
                await pollAllMachines();
            });
        }

        // 從輪詢帶入按鈕
        const importFromPollBtn = document.getElementById('import-from-poll-btn');
        if (importFromPollBtn) {
            importFromPollBtn.addEventListener('click', function() {
                console.log('📥 從輪詢帶入按鈕被點擊');
                importFromPoll();
            });
        }

        // 批量新增所有機台按鈕
        const batchAddAllBtn = document.getElementById('batch-add-all-btn');
        if (batchAddAllBtn) {
            batchAddAllBtn.addEventListener('click', function() {
                console.log('✅ 批量新增按鈕被點擊');
                batchAddAllMachines();
            });
        }

        // 發送讀取命令按鈕（使用 HTTP）
        const sendReadCmd = document.getElementById('send-read-command');
        if (sendReadCmd) {
            sendReadCmd.addEventListener('click', async function() {
                try {
                    // 獲取用戶輸入的 MAC 地址
                    const mac = document.getElementById('read-machine-mac').value.trim();
                    const devid = document.getElementById('read-device-id').value || 1;
                    
                    // 驗證 MAC 地址
                    if (!mac) {
                        alert('❌ 請輸入機台 MAC 位址');
                        return;
                    }
                    
                    // 按鈕載入狀態
                    this.disabled = true;
                    this.innerHTML = '🔄 發送中...';
                    
                    // 記錄到命令日誌
                    addCommandLog('send', `發送 HTTP GET 請求 - MAC: ${mac}`);
                    
                    // 發送 HTTP 請求
                    const result = await sendHttpRequest(mac);
                    
                    if (result) {
                        addCommandLog('receive', `HTTP 請求成功 - MAC: ${mac}`, result);
                    }
                    
                    // 恢復按鈕狀態
                    this.disabled = false;
                    this.innerHTML = '📤 測試查詢';
                    
                } catch (error) {
                    console.error('❌ HTTP 請求執行錯誤:', error);
                    alert('❌ HTTP 請求執行錯誤: ' + error.message);
                    addCommandLog('error', '執行錯誤: ' + error.message);
                    
                    // 恢復按鈕狀態
                    this.disabled = false;
                    this.innerHTML = '📤 測試查詢';
                }
            });
        }

        // 機台選擇器變更事件
        const machineSelector = document.getElementById('machine-selector');
        if (machineSelector) {
            machineSelector.addEventListener('change', (e) => {
                const selectedDocId = e.target.value;
                if(!selectedDocId) return;

                const selectedMachine = appData.machines.find(m => m.docId === selectedDocId);
                if (selectedMachine) {
                    document.getElementById('cumulative-plays').value = selectedMachine.plays;
                    document.getElementById('cumulative-payouts').value = selectedMachine.payouts;
                    document.getElementById('cumulative-plays').focus();
                }
            });
        }
        
        // 日常紀錄表單提交
        const dailyEntryForm = document.getElementById('daily-entry-form');
        if (dailyEntryForm) {
            dailyEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedStoreId) {
                    return showFeedback('錯誤：未選擇任何門市。', true);
                }
                
                const date = document.getElementById('entry-date').value;
                const machineSelector = document.getElementById('machine-selector');
                const machineDocId = machineSelector.value;

                if (!machineDocId) {
                     console.error('❌ 機台選擇器未選擇', {
                        selectorValue: machineSelector.value,
                        selectedOptions: machineSelector.selectedOptions.length,
                        options: machineSelector.options.length
                     });
                     return showFeedback('錯誤：請選擇一台機台。', true);
                }

                const selectedMachine = appData.machines.find(m => m.docId === machineDocId);

                const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
                const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

                if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                    return showFeedback('錯誤：請填寫所有欄位。', true);
                }

                if (!selectedMachine) { return showFeedback('錯誤：無法識別所選機台。', true); }
                if (cumulativePlaysInput < selectedMachine.plays || cumulativePayoutsInput < selectedMachine.payouts) {
                    return showFeedback('錯誤：輸入的累積數值小於上次紀錄，請確認抄表數值是否正確。', true);
                }
                if (cumulativePlaysInput < (selectedMachine.initialPlays || 0) || cumulativePayoutsInput < (selectedMachine.initialPayouts || 0)) {
                    return showFeedback(`錯誤：抄表數值不可小於此機台的起始值 (投幣: ${selectedMachine.initialPlays || 0}, 出貨: ${selectedMachine.initialPayouts || 0})。`, true);
                }


            const dailyPlays = cumulativePlaysInput - selectedMachine.plays;
            const dailyPayouts = cumulativePayoutsInput - selectedMachine.payouts;
            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('數據未變更，無需新增紀錄。');
            }

            try {
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });
                
                // 檢查是否已存在相同日期和機台的歷史記錄
                console.log(`🔍 查詢條件: date=${date}, machineId=${selectedMachine.id}, location=${selectedMachine.location}`);
                
                const historyQuery = db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(selectedStoreId)
                    .collection('history');
                
                let existingRecords = null;
                let updateMode = false;
                
                try {
                    // 嘗試複合查詢
                    existingRecords = await historyQuery
                        .where('date', '==', date)
                        .where('machineId', '==', selectedMachine.id)
                        .where('location', '==', selectedMachine.location)
                        .get();
                    
                    console.log(`📋 複合查詢結果: ${existingRecords.docs.length} 筆記錄`);
                    
                } catch (queryError) {
                    // 如果複合查詢失敗（可能缺少索引），使用單個查詢逐一檢查
                    console.warn(`⚠️ 複合查詢失敗，使用備用方案: ${queryError.message}`);
                    const allRecords = await historyQuery.get();
                    const filtered = allRecords.docs.filter(doc => {
                        const data = doc.data();
                        return data.date === date && 
                               data.machineId === selectedMachine.id && 
                               data.location === selectedMachine.location;
                    });
                    existingRecords = { docs: filtered };
                    console.log(`📋 備用查詢結果: ${filtered.length} 筆記錄`);
                }
                
                if (existingRecords.docs.length > 0) {
                    // 更新現有記錄
                    updateMode = true;
                    const docId = existingRecords.docs[0].id;
                    console.log(`🔄 找到現有記錄，準備更新: ${docId}`);
                    
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history').doc(docId)
                        .update({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`✅ 已更新記錄: ${docId}`);
                } else {
                    // 新增新記錄
                    console.log(`📝 未找到現有記錄，準備新增`);
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history')
                        .add({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`✅ 已新增記錄`);
                }
                
                await loadStoreData(); 
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const actionType = updateMode ? '更新' : '新增';
                const successMessage = `紀錄已${actionType}並同步至 [${selectedStoreName}]！本日 ${selectedMachine.id} 新增：<strong class="text-white">${dailyPlays}</strong> 投幣、<strong class="text-white">${dailyPayouts}</strong> 出貨。`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("寫入 Firestore 時發生錯誤: ", error);
                showFeedback("無法將紀錄同步至雲端，請稍後再試。", true);
            }
            });
        }
        
        // 搜尋輸入框事件
        const searchInputElem = document.getElementById('search-input') || searchInput;
        if (searchInputElem) {
            searchInputElem.addEventListener('input', async () => await updateUI());
        }
        sortableHeaders.forEach(header => {
            header.addEventListener('click', async () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    if(h !== header) h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? '▲' : '▼';
                await updateUI();
            });
        });
        
        recalculateAllBtn.addEventListener('click', async () => {
            if (!selectedStoreId) return;

            pdfLoaderText.textContent = '正在重新整理與計算所有數據...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                await loadStoreData(); // This function already re-fetches and calls updateUI()
                showFeedback("所有數據已成功重新計算並更新！", false);
            } catch (error) {
                console.error("重新計算失敗:", error);
                showFeedback("數據更新失敗，請檢查網路連線。", true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        downloadPdfBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active');
            if (!activeTab) return;

            const tabId = activeTab.dataset.tab;
            const tabName = activeTab.textContent;

            if (tabId === 'accounting' || tabId === 'machines' || tabId === 'checkout') {
                alert('此頁面不支援 PDF 匯出。請選擇一個報表頁籤。');
                return;
            }

            pdfLoaderText.textContent = `正在生成「${tabName}」報表...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById(tabId);
                const originalScrollTop = content.scrollTop;
                content.scrollTop = 0; // Ensure we capture from the top

                const canvas = await html2canvas(content, {
                    backgroundColor: '#1f2937',
                    scale: 2,
                    useCORS: true,
                    windowHeight: content.scrollHeight
                });
                content.scrollTop = originalScrollTop; // Restore scroll

                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const margin = 10;

                const imgProps = doc.getImageProperties(imgData);
                const imgWidth = pdfWidth - margin * 2;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 30);

                while (heightLeft > 0) {
                    doc.addPage();
                    position -= (pdfHeight - 30);
                    doc.addImage(imgData, 'PNG', margin, position + 20, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 30);
                }

                for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                    doc.setPage(i);
                    doc.setFontSize(14);
                    doc.setTextColor(150);
                    doc.text(selectedStoreName, margin, 15);
                    doc.setFontSize(10);
                    doc.text(`報表生成日期: ${new Date().toLocaleDateString()}`, pdfWidth - margin, 15, { align: 'right' });
                    doc.setFontSize(8);
                    doc.text(`第 ${i} 頁 / 共 ${doc.internal.getNumberOfPages()} 頁`, pdfWidth / 2, pdfHeight - margin, { align: 'center' });
                }
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                doc.save(`${selectedStoreName}-${tabName}-報告-${dateString}.pdf`);

            } catch (error) {
                console.error("PDF 生成失敗:", error);
                alert("生成 PDF 時發生錯誤，請稍後再試。");
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            if (!selectedStoreId) {
                showFeedback("請先選擇門市再下載報告。", true);
                return;
            }

            const processedMachines = appData.machines.map(processMachineData);
            if (processedMachines.length === 0 && appData.history.length === 0) {
                showFeedback("目前沒有資料可供下載。請先新增機台並記錄數據。", true);
                return;
            }

            showCustomReportModal();
        });

        // 自定義報表模態視窗事件監聽器
        customReportCancelBtn.addEventListener('click', hideCustomReportModal);
        
        customReportDownloadBtn.addEventListener('click', generateCustomReport);

        // 快速選擇按鈕事件
        selectAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        selectBasicReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, false, false, false, false);
        });

        selectDetailedReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        clearAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(false, false, false, false, false, false, false);
        });

        // 模態視窗點擊外部關閉
        customReportModal.addEventListener('click', (e) => {
            if (e.target === customReportModal) {
                hideCustomReportModal();
            }
        });

        // 自定義門市報表模態視窗事件監聽器
        customStoreReportCancelBtn.addEventListener('click', hideCustomStoreReportModal);
        
        customStoreReportDownloadBtn.addEventListener('click', generateCustomStoreReport);

        // 門市報表快速選擇按鈕事件
        selectAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        selectBasicStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, false, false, false, false);
        });

        selectDetailedStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        clearAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(false, false, false, false, false, false);
        });

        // 門市報表模態視窗點擊外部關閉
        customStoreReportModal.addEventListener('click', (e) => {
            if (e.target === customStoreReportModal) {
                hideCustomStoreReportModal();
            }
        });

        performCheckoutBtn.addEventListener('click', handlePerformCheckout);

        // 統計範圍控制按鈕事件監聽器
        document.addEventListener('click', async function(e) {
            // 統計頁面範圍按鈕
            if (e.target.classList.contains('stats-range-btn')) {
                document.querySelectorAll('.stats-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentStatsRange = e.target.dataset.range;
                renderStatisticsTab(); // 重新整理統計頁面
            }
            
            // 圖表頁面範圍按鈕
            if (e.target.classList.contains('chart-range-btn')) {
                document.querySelectorAll('.chart-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentChartsRange = e.target.dataset.range;
                await renderChartsTab(); // 重新整理圖表頁面
            }
            
            // 營業明細頁面範圍按鈕
            if (e.target.classList.contains('summary-range-btn')) {
                document.querySelectorAll('.summary-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentSummaryRange = e.target.dataset.range;
                renderSummaryTab(); // 重新整理營業明細頁面
            }
        });

        // 重新整理按鈕事件監聽器
        const refreshAllStatsBtn = document.getElementById('refresh-all-stats-btn');

        if (refreshAllStatsBtn) {
            refreshAllStatsBtn.addEventListener('click', async function() {
                console.log('🔄 手動觸發重新統計所有資料...');
                this.innerHTML = '🔄 統計中...';
                this.disabled = true;
                
                const success = await refreshAllStatistics();
                
                this.innerHTML = '🔄 重新統計全部';
                this.disabled = false;
                
                if (success) {
                    showFeedback('✅ 所有統計資料已重新整理完成！', false);
                } else {
                    showFeedback('❌ 重新統計時發生錯誤，請稍後再試', true);
                }
            });
        }

        // 盈利計算相關事件監聽器
        const calculateProfitBtn = document.getElementById('calculate-profit-btn');
        const saveCostSettingsBtn = document.getElementById('save-cost-settings-btn');
        const giftCostInput = document.getElementById('gift-cost');
        const rentPercentageInput = document.getElementById('rent-percentage');
        const taxPercentageInput = document.getElementById('tax-percentage');

        if (calculateProfitBtn) {
            calculateProfitBtn.addEventListener('click', calculateProfit);
        }

        if (saveCostSettingsBtn) {
            saveCostSettingsBtn.addEventListener('click', saveCostSettings);
        }

        // 即時計算功能
        [giftCostInput, rentPercentageInput, taxPercentageInput].forEach(input => {
            if (input) {
                input.addEventListener('input', () => {
                    // 延遲計算以避免過於頻繁的更新
                    clearTimeout(window.profitCalculateTimeout);
                    window.profitCalculateTimeout = setTimeout(calculateProfit, 500);
                });
            }
        });

        // 計算範圍變更事件
        document.querySelectorAll('input[name="profit-calculation-scope"]').forEach(radio => {
            radio.addEventListener('change', calculateProfit);
        });

        // 盈利詳情查看事件
        const profitDetailModal = document.getElementById('profit-detail-modal');
        const closeProfitDetailBtn = document.getElementById('close-profit-detail');

        if (closeProfitDetailBtn) {
            closeProfitDetailBtn.addEventListener('click', () => {
                profitDetailModal.classList.add('hidden');
            });
        }

        // 結帳歷史表格中的盈利詳情按鈕事件
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-profit-detail-btn')) {
                const checkoutData = JSON.parse(e.target.dataset.checkoutData);
                showProfitDetail(checkoutData);
            }
        });

        function showProfitDetail(checkout) {
            const periodProfit = checkout.periodProfit || {};
            const totalProfit = checkout.totalProfit || {};
            
            // 營業數據
            document.getElementById('detail-checkout-date').textContent = 
                new Date(checkout.checkoutDate.toDate()).toLocaleString();
            document.getElementById('detail-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} 元`;
            document.getElementById('detail-payouts').textContent = 
                `${(checkout.checkoutPayouts || 0).toLocaleString()} 次`;
            
            // 成本設定
            const costSettings = totalProfit.costSettings || {};
            document.getElementById('detail-gift-cost').textContent = 
                `${costSettings.giftCost || 0} 元/次`;
            document.getElementById('detail-rent-percentage').textContent = 
                `${costSettings.rentPercentage || 0}%`;
            document.getElementById('detail-tax-percentage').textContent = 
                `${costSettings.taxPercentage || 0}%`;
            
            // 成本明細 (使用當期數據)
            document.getElementById('detail-total-gift-cost').textContent = 
                `${(periodProfit.giftCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-rent-cost').textContent = 
                `${(periodProfit.rentCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-tax-cost').textContent = 
                `${(periodProfit.taxCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} 元`;
            
            // 盈利分析
            document.getElementById('detail-profit-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} 元`;
            document.getElementById('detail-profit-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} 元`;
                
            const netProfit = periodProfit.netProfit || 0;
            const profitColor = netProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const profitMargin = checkout.checkoutAmount > 0 ? 
                (netProfit / checkout.checkoutAmount) * 100 : 0;
                
            document.getElementById('detail-net-profit').textContent = 
                `${netProfit.toLocaleString()} 元`;
            document.getElementById('detail-net-profit').className = 
                `font-bold text-lg ${profitColor}`;
            document.getElementById('detail-profit-margin').textContent = 
                `${profitMargin.toFixed(2)}%`;
            document.getElementById('detail-profit-margin').className = 
                `font-semibold ${profitColor}`;
            
            profitDetailModal.classList.remove('hidden');
        }

        // 下載結帳報表 CSV
        downloadCheckoutCsvBtn.addEventListener('click', async () => {
            if (!selectedGroupId || !selectedStoreId) {
                alert('請先選擇門市');
                return;
            }

            try {
                const btn = downloadCheckoutCsvBtn;
                const originalText = btn.textContent;
                btn.textContent = '產生中...';
                btn.disabled = true;

                // 獲取結帳歷史
                const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                // 生成 CSV 內容
                const csvRows = [];
                csvRows.push('\uFEFF'); // UTF-8 BOM
                csvRows.push(`結帳報表 - ${selectedStoreName}`);
                csvRows.push(`報表產生日期: ${new Date().toLocaleString()}`);
                csvRows.push('');
                
                if (checkouts.length === 0) {
                    csvRows.push('尚無結帳紀錄');
                } else {
                    // 表頭
                    csvRows.push(['結帳日期', '結帳金額', '累積營收', '期間天數', '平均每日營收'].join(','));
                    
                    // 資料行
                    checkouts.forEach((checkout, index) => {
                        const checkoutDate = new Date(checkout.checkoutDate.toDate());
                        const prevCheckoutDate = index < checkouts.length - 1 ? 
                            new Date(checkouts[index + 1].checkoutDate.toDate()) : 
                            new Date(appData.startDate);
                        
                        const daysDiff = Math.ceil((checkoutDate - prevCheckoutDate) / (1000 * 60 * 60 * 24));
                        const avgDailyRevenue = daysDiff > 0 ? checkout.checkoutAmount / daysDiff : 0;
                        
                        csvRows.push([
                            checkoutDate.toLocaleString(),
                            checkout.checkoutAmount,
                            checkout.cumulativeRevenueAtCheckout,
                            daysDiff,
                            avgDailyRevenue.toFixed(2)
                        ].join(','));
                    });

                    // 統計摘要
                    csvRows.push('');
                    csvRows.push('--- 統計摘要 ---');
                    const totalCheckouts = checkouts.length;
                    const totalRevenue = checkouts.length > 0 ? checkouts[0].cumulativeRevenueAtCheckout : 0;
                    const avgCheckoutAmount = checkouts.length > 0 ? 
                        checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0) / checkouts.length : 0;
                    
                    csvRows.push(`總結帳次數,${totalCheckouts}`);
                    csvRows.push(`累積總營收,${totalRevenue} 元`);
                    csvRows.push(`平均結帳金額,${avgCheckoutAmount.toFixed(2)} 元`);
                }

                // 下載 CSV
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute('download', `${selectedStoreName}-結帳報表-${dateString}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('下載結帳報表失敗:', error);
                alert('下載報表時發生錯誤，請稍後再試。');
                
                downloadCheckoutCsvBtn.textContent = '下載結帳報表 (CSV)';
                downloadCheckoutCsvBtn.disabled = false;
            }
        });

        // === 機台詳細資料顯示功能 ===
        
        // 顯示機台詳細資料面板
        function showMachineDetailPanel(machine, mqttData) {
            console.log('=== 顯示機台詳細資料面板 ===');
            console.log('機台:', machine);
            console.log('MQTT 資料:', mqttData);
            
            const panel = document.getElementById('machine-detail-panel');
            console.log('面板元素:', panel);
            
            if (!panel) {
                console.error('找不到機台詳細資料面板元素！');
                alert('系統錯誤：找不到詳細資料面板');
                return;
            }
            
            // 更新基本資料
            document.getElementById('detail-machine-id').textContent = machine.id;
            document.getElementById('detail-mac-address').textContent = machine.mac || '--';
            document.getElementById('detail-device-id').textContent = machine.devid || '--';
            document.getElementById('detail-last-update').textContent = mqttData.parseTime;
            
            // 檢查是否為狀態回應
            if (mqttData.isStatusOnly) {
                // 清空詳細資料，只顯示狀態
                ['detail-strong-voltage', 'detail-medium-voltage', 'detail-weak-voltage', 
                 'detail-height-to-top', 'detail-clamp-voltage', 'detail-win-rate-bank',
                 'detail-coin-game-count', 'detail-prize-count', 'detail-amount-1',
                 'detail-amount-2', 'detail-amount-3'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '--';
                });
                
                // 顯示狀態信息
                document.getElementById('detail-raw-hex').textContent = `狀態回應: ${mqttData.rawHex} (狀態碼: ${mqttData.statusCode})`;
            } else {
                // 更新電壓資料
                const voltage = mqttData.voltageData || {};
                document.getElementById('detail-strong-voltage').textContent = voltage.strongVoltage || '--';
                document.getElementById('detail-medium-voltage').textContent = voltage.mediumVoltage || '--';
                document.getElementById('detail-weak-voltage').textContent = voltage.weakVoltage || '--';
                document.getElementById('detail-height-to-top').textContent = voltage.heightToTop || '--';
                document.getElementById('detail-clamp-voltage').textContent = voltage.clampVoltage || '--';
                
                // 更新營運資料
                const operation = mqttData.operationData || {};
                document.getElementById('detail-win-rate-bank').textContent = operation.winRateBank || '--';
                document.getElementById('detail-coin-game-count').textContent = operation.coinGameCount || '--';
                document.getElementById('detail-prize-count').textContent = operation.prizeCount || '--';
                
                // 更新累加金額
                document.getElementById('detail-amount-1').textContent = operation.accumulatedAmount1 || '--';
                document.getElementById('detail-amount-2').textContent = operation.accumulatedAmount2 || '--';
                document.getElementById('detail-amount-3').textContent = operation.accumulatedAmount3 || '--';
                
                // 更新原始資料
                document.getElementById('detail-raw-hex').textContent = mqttData.rawHex || '--';
            }
            
            console.log('準備顯示面板...');
            
            // 確保在機台管理頁籤下顯示
            const machinesTab = document.querySelector('[data-tab="machines"]');
            if (machinesTab && !document.getElementById('machines').classList.contains('hidden')) {
                console.log('當前在機台管理頁籤');
            } else {
                console.log('切換到機台管理頁籤');
                // 切換到機台管理頁籤
                if (machinesTab) {
                    machinesTab.click();
                }
            }
            
            // 顯示面板
            panel.classList.remove('hidden');
            console.log('面板 hidden 類已移除');
            
            // 滾動到面板位置
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('滾動到面板位置');
            
            // 添加高亮效果
            panel.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => {
                panel.classList.remove('ring-2', 'ring-blue-500');
            }, 2000);
            
            console.log('✅ 機台詳細資料面板顯示完成');
        }
        
        // 關閉詳細資料面板 (安全初始化)
        function initializeDetailPanel() {
            const closeBtn = document.getElementById('close-detail-panel');
            if (closeBtn && !closeBtn._initialized) {
                closeBtn._initialized = true;
                closeBtn.addEventListener('click', () => {
                    document.getElementById('machine-detail-panel').classList.add('hidden');
                });
            }
        }
        
        // === MQTT 輪詢功能 ===
        let pollInterval = null;
        
        // 初始化 MQTT 輪詢功能 (確保元素已載入)
        function initializeMqttPolling() {
            try {
                const machineListTableBody = document.getElementById('machine-list-table-body');
                if (!machineListTableBody) {
                    console.warn('machineListTableBody not found, retrying...');
                    setTimeout(initializeMqttPolling, 100);
                    return;
                }

                // MAC 位址輸入框即時更新 (使用事件委派避免重複監聽)
                if (!machineListTableBody._mqttInputHandler) {
                    machineListTableBody._mqttInputHandler = true;
                    machineListTableBody.addEventListener('input', async (e) => {
                        if (e.target.classList.contains('mac-address-input') || e.target.classList.contains('device-id-input')) {
                            const docId = e.target.dataset.docId;
                            if (!selectedGroupId || !selectedStoreId || !docId) return;
                            
                            const updateData = {};
                            
                            if (e.target.classList.contains('mac-address-input')) {
                                updateData.mac = e.target.value.trim();
                            } else if (e.target.classList.contains('device-id-input')) {
                                updateData.devid = parseInt(e.target.value, 10) || null;
                            }
                            
                            try {
                                await db.collection('groups').doc(selectedGroupId)
                                    .collection('stores').doc(selectedStoreId)
                                    .collection('machines').doc(docId).update(updateData);
                                
                                // 更新本地資料
                                if (appData && appData.machines) {
                                    const machine = appData.machines.find(m => m.docId === docId);
                                    if (machine) {
                                        Object.assign(machine, updateData);
                                    }
                                }
                            } catch (error) {
                                console.error('更新機台資料失敗:', error);
                            }
                        }
                    });
                }

                console.log('MQTT 輪詢功能初始化完成');
            } catch (error) {
                console.error('初始化 MQTT 輪詢功能失敗:', error);
            }
        }

        // 初始化 MQTT 控制面板事件監聽器
        function initializeMqttControls() {
            try {
                // 自動輪詢控制 (使用正確的 ID)
                const autoPollCheckbox = document.getElementById('auto-poll-enabled');
                if (autoPollCheckbox && !autoPollCheckbox._initialized) {
                    autoPollCheckbox._initialized = true;
                    autoPollCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            startAutoPolling();
                        } else {
                            stopAutoPolling();
                        }
                    });
                }

                // 手動觸發輪詢 (使用正確的 ID)
                const pollTriggerBtn = document.getElementById('poll-all-btn');
                if (pollTriggerBtn && !pollTriggerBtn._initialized) {
                    pollTriggerBtn._initialized = true;
                    pollTriggerBtn.addEventListener('click', () => {
                        pollAllMachines();
                    });
                }

                // 輪詢間隔更改 (使用正確的 ID)
                const intervalSelect = document.getElementById('poll-interval');
                if (intervalSelect && !intervalSelect._initialized) {
                    intervalSelect._initialized = true;
                    intervalSelect.addEventListener('change', (e) => {
                        const autoPoll = document.getElementById('auto-poll-enabled');
                        if (autoPoll && autoPoll.checked) {
                            stopAutoPolling();
                            startAutoPolling();
                        }
                    });
                }
                
                console.log('MQTT 控制面板初始化完成');
            } catch (error) {
                console.warn('初始化 MQTT 控制面板時發生錯誤:', error);
            }
        }

        // 單台機台輪詢 (HTTP 版本)
        async function pollSingleMachine(mac, devid) {
            console.log('=== 單台 HTTP 輪詢 ===');
            
            if (!mac) {
                console.error('MAC 地址無效');
                return;
            }
            
            try {
                console.log(`準備發送 HTTP GET 請求到機台 - MAC: ${mac}, DevID: ${devid}`);
                const result = await sendHttpRequest(mac);
                
                if (result) {
                    console.log(`✅ HTTP 請求成功 - MAC: ${mac}, DevID: ${devid}`);
                    // 傳遞 devid 給 handleHttpResponse
                    handleHttpResponse(result, mac, devid);
                    addCommandLog('receive', `HTTP 回應成功 - MAC: ${mac}, DevID: ${devid}`, result);
                } else {
                    console.warn(`HTTP 請求失敗 - MAC: ${mac}`);
                    addCommandLog('error', `HTTP 請求失敗 - MAC: ${mac}`);
                }
                
            } catch (error) {
                console.error('HTTP 輪詢失敗:', error);
                addCommandLog('error', `HTTP 輪詢失敗: ${error.message}`);
            }
        }

        // 輪詢所有機台 (HTTP 版本)
        async function pollAllMachines() {
            console.log('=== 開始 HTTP 輪詢所有機台 ===');

            if (!appData.machines || appData.machines.length === 0) {
                alert('沒有機台可以輪詢');
                return;
            }

            const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
            if (machinesWithMac.length === 0) {
                alert('沒有設定 MAC 位址的機台');
                return;
            }
            
            console.log('=== 輪詢機台清單 ===');
            machinesWithMac.forEach((machine, index) => {
                console.log(`${index + 1}. 機台ID: ${machine.id}, MAC: ${machine.mac}, DevID: ${machine.devid || 1}`);
            });
            console.log('========================');

            showStatusMessage(`開始輪詢 ${machinesWithMac.length} 台機台...`, 'info');

            for (const machine of machinesWithMac) {
                try {
                    await pollSingleMachine(machine.mac, machine.devid || 1);
                    // 每台機台間隔 500ms 避免同時發送過多請求
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`輪詢機台 ${machine.mac} 失敗:`, error);
                }
            }

            showStatusMessage(`輪詢完成，已查詢 ${machinesWithMac.length} 台機台`, 'success');
            console.log(`✅ 輪詢所有機台完成 - 共查詢 ${machinesWithMac.length} 台機台`);
        }

        // 開始自動輪詢 (HTTP 版本)
        function startAutoPolling() {
            const intervalSelect = document.getElementById('poll-interval');
            const interval = intervalSelect ? parseInt(intervalSelect.value) : 30000;
            
            stopAutoPolling(); // 確保沒有重複的輪詢
            
            console.log(`啟動自動 HTTP 輪詢，間隔: ${interval/1000} 秒`);
            
            pollInterval = setInterval(() => {
                console.log(`執行自動輪詢 (HTTP)`);
                pollAllMachines();
            }, interval);
            
            showStatusMessage(`已啟動自動輪詢，間隔 ${interval/1000} 秒`, 'success');
        }

        // 停止自動輪詢
        function stopAutoPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                showStatusMessage('已停止自動輪詢', 'info');
            }
        }

        // 狀態訊息顯示
        function showStatusMessage(message, type = 'info') {
            console.log(`狀態訊息: ${message} (${type})`); // 調試用
            
            // 尋找或創建狀態訊息容器
            let statusContainer = document.getElementById('mqtt-status-messages');
            if (!statusContainer) {
                statusContainer = document.createElement('div');
                statusContainer.id = 'mqtt-status-messages';
                statusContainer.className = 'fixed top-4 right-4 z-50 max-w-sm';
                document.body.appendChild(statusContainer);
            }

            const messageDiv = document.createElement('div');
            const bgColors = {
                info: 'bg-blue-600',
                success: 'bg-green-600', 
                error: 'bg-red-600'
            };

            messageDiv.className = `${bgColors[type]} text-white px-4 py-2 rounded-lg mb-2 shadow-lg transform transition-all duration-300`;
            messageDiv.textContent = message;

            statusContainer.appendChild(messageDiv);

            // 自動移除訊息
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // --- INITIAL LOAD ---
        // 延遲初始化 MQTT 功能，確保不影響主要載入流程
        setTimeout(() => {
            try {
                console.log('開始初始化 MQTT 功能...');
                initializeMqttPolling();
                initializeMqttControls();
                initializeDetailPanel();
                console.log('MQTT 功能初始化完成');
                
                // 添加全域測試函數供調試使用
                window.testMqttPolling = function() {
                    console.log('=== 測試 MQTT 輪詢功能 ===');
                    console.log('MQTT 客戶端:', mqttClient);
                    console.log('MQTT 連接狀態:', mqttConnected);
                    console.log('appData:', appData);
                    
                    if (appData && appData.machines) {
                        console.log('當前機台列表:', appData.machines);
                        const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                        console.log('有 MAC 位址的機台:', machinesWithMac);
                        if (machinesWithMac.length > 0) {
                            pollAllMachines();
                        } else {
                            console.log('沒有設定 MAC 位址的機台');
                        }
                    } else {
                        console.log('appData 或機台列表不存在');
                    }
                };
                
                // 添加 MQTT 狀態檢查函數
                window.checkMqttStatus = function() {
                    console.log('=== MQTT 狀態檢查 ===');
                    console.log('mqttClient 存在:', !!mqttClient);
                    console.log('mqttConnected 狀態:', mqttConnected);
                    
                    // 檢查 MQTT 狀態指示器
                    const statusIndicator = document.getElementById('mqtt-status-indicator');
                    const statusText = document.getElementById('mqtt-status-text');
                    if (statusIndicator) {
                        console.log('狀態指示器 class:', statusIndicator.className);
                    }
                    if (statusText) {
                        console.log('狀態文字:', statusText.textContent);
                    }
                    
                    return { client: !!mqttClient, connected: mqttConnected };
                };
                
                // 添加快速測試輪詢功能（使用圖片中的 MAC 位址）
                window.testQuickPoll = function() {
                    console.log('=== 快速輪詢測試 ===');
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    
                    // 檢查本地和全域 MQTT 客戶端
                    const localClient = mqttClient;
                    const globalClient = window.mqttClient;
                    const activeClient = localClient || globalClient;
                    
                    console.log('本地客戶端:', !!localClient);
                    console.log('全域客戶端:', !!globalClient);
                    console.log('使用客戶端:', !!activeClient);
                    
                    if (activeClient) {
                        console.log('嘗試輪詢測試機台...');
                        console.log('使用正確的命令格式：包含 cmd, mac, floor, devid, taskid');
                        pollSingleMachine(testMac, testDevId);
                    } else {
                        console.log('無 MQTT 客戶端可用');
                        alert('請先連接 MQTT 再進行測試');
                    }
                };
                
                // 添加 MQTT 狀態檢查功能
                window.checkMqttStatus = function() {
                    console.log('=== MQTT 狀態檢查 ===');
                    console.log('本地 mqttClient:', !!mqttClient);
                    console.log('本地 mqttConnected:', mqttConnected);
                    console.log('全域 window.mqttClient:', !!window.mqttClient);
                    console.log('全域 window.mqttConnected:', window.mqttConnected);
                    
                    if (mqttClient) {
                        console.log('mqttClient.connected:', mqttClient.connected);
                        console.log('mqttClient.disconnected:', mqttClient.disconnected);
                        console.log('mqttClient.reconnecting:', mqttClient.reconnecting);
                    }
                    
                    const statusElement = document.getElementById('mqtt-status-text');
                    if (statusElement) {
                        console.log('UI 狀態文字:', statusElement.textContent);
                    }
                };
                
                // 強制同步 MQTT 狀態
                window.syncMqttStatus = function() {
                    console.log('=== 強制同步 MQTT 狀態 ===');
                    
                    // 如果本地 mqttClient 存在但全域沒有，同步到全域
                    if (mqttClient && !window.mqttClient) {
                        console.log('同步本地客戶端到全域');
                        window.mqttClient = mqttClient;
                    }
                    
                    // 如果全域 mqttClient 存在但本地沒有，從全域取得
                    if (!mqttClient && window.mqttClient) {
                        console.log('從全域取得客戶端到本地');
                        mqttClient = window.mqttClient;
                    }
                    
                    // 同步連接狀態
                    if (mqttClient && mqttClient.connected) {
                        console.log('偵測到客戶端已連接，同步狀態');
                        mqttConnected = true;
                        window.mqttConnected = true;
                        updateMqttStatus(true, '狀態已同步');
                    }
                    
                    console.log('同步完成 - 本地客戶端:', !!mqttClient, '全域客戶端:', !!window.mqttClient);
                    return {
                        localClient: !!mqttClient,
                        globalClient: !!window.mqttClient,
                        localConnected: mqttConnected,
                        globalConnected: window.mqttConnected
                    };
                };

                // 簡易診斷和修復功能
                window.fixMqttPolling = function() {
                    console.log('=== MQTT 輪詢修復程序 ===');
                    
                    // 1. 檢查 UI 狀態
                    const statusText = document.getElementById('mqtt-status-text');
                    const connectBtn = document.getElementById('mqtt-connect-btn');
                    console.log('UI 狀態:', statusText?.textContent);
                    console.log('按鈕文字:', connectBtn?.textContent);
                    
                    // 2. 檢查變數狀態
                    console.log('變數狀態 - 本地客戶端:', !!mqttClient, '全域客戶端:', !!window.mqttClient);
                    console.log('連接狀態 - 本地:', mqttConnected, '全域:', window.mqttConnected);
                    
                    // 3. 如果 UI 顯示已連接但變數未同步，強制同步
                    if (statusText?.textContent.includes('已連接') || statusText?.textContent.includes('連線成功')) {
                        console.log('UI 顯示已連接，但變數可能未同步，執行修復...');
                        
                        // 如果沒有客戶端但 UI 說已連接，可能需要重新連接
                        if (!mqttClient && !window.mqttClient) {
                            console.log('未找到客戶端，建議重新連接');
                            alert('檢測到連接異常，請點擊「重新連線」按鈕');
                            return false;
                        }
                        
                        // 同步狀態
                        window.syncMqttStatus();
                    }
                    
                    // 4. 測試輪詢
                    console.log('嘗試測試輪詢...');
                    if (window.testQuickPoll) {
                        window.testQuickPoll();
                        return true;
                    } else {
                        console.error('testQuickPoll 函數不存在');
                        return false;
                    }
                };

                // 測試詳細面板顯示功能
                window.testDetailPanel = function() {
                    console.log('=== 測試詳細面板顯示 ===');
                    
                    // 創建模擬資料
                    const mockMachine = {
                        id: 'TEST-001',
                        mac: '083A8DE1ED14',
                        devid: 1
                    };
                    
                    const mockMqttData = {
                        voltageData: {
                            strongVoltage: 12,
                            mediumVoltage: 8,
                            weakVoltage: 5,
                            heightToTop: 10,
                            clampVoltage: 15
                        },
                        operationData: {
                            winRateBank: 100,
                            coinGameCount: 50,
                            prizeCount: 10,
                            accumulatedAmount1: 500,
                            accumulatedAmount2: 300,
                            accumulatedAmount3: 200
                        },
                        rawHex: '1234567890ABCDEF',
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: false
                    };
                    
                    console.log('使用模擬資料測試面板顯示...');
                    showMachineDetailPanel(mockMachine, mockMqttData);
                };

                // 檢查頁籤和面板狀態
                window.checkTabAndPanel = function() {
                    console.log('=== 檢查頁籤和面板狀態 ===');
                    
                    const currentTab = document.querySelector('.tab-btn.active');
                    const machinesTabContent = document.getElementById('machines');
                    const detailPanel = document.getElementById('machine-detail-panel');
                    
                    console.log('當前活動頁籤:', currentTab?.textContent);
                    console.log('機台管理頁籤是否顯示:', !machinesTabContent?.classList.contains('hidden'));
                    console.log('詳細面板是否顯示:', !detailPanel?.classList.contains('hidden'));
                    console.log('詳細面板元素存在:', !!detailPanel);
                    
                    if (detailPanel) {
                        console.log('詳細面板類別:', detailPanel.className);
                    }
                    
                    return {
                        currentTab: currentTab?.textContent,
                        machinesTabVisible: !machinesTabContent?.classList.contains('hidden'),
                        detailPanelVisible: !detailPanel?.classList.contains('hidden'),
                        detailPanelExists: !!detailPanel
                    };
                };

                // 驗證 MQTT 命令格式
                window.validateMqttCommand = function() {
                    console.log('=== MQTT 命令格式驗證 ===');
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const expectedCommand = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    console.log('正確的命令格式應該是:');
                    console.log(JSON.stringify(expectedCommand, null, 2));
                    console.log('');
                    console.log('命令說明:');
                    console.log('- cmd: 命令類型 (readdata)');
                    console.log('- mac: 機台WiFi小卡MAC');
                    console.log('- floor: 固定為 "1"');
                    console.log('- devid: 天車板 (左天車ID:1，右天車ID:2)');
                    console.log('- taskid: 命令編號 (時間戳格式)');
                    
                    return expectedCommand;
                };

                // 直接測試命令發送（不依賴其他函數）
                window.testDirectMqttSend = function() {
                    console.log('=== 直接測試 MQTT 命令發送 ===');
                    
                    const activeClient = mqttClient || window.mqttClient;
                    if (!activeClient) {
                        console.error('沒有可用的 MQTT 客戶端');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const topic = 'coffeelens/req';
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const commandObject = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    const message = JSON.stringify(commandObject);
                    
                    console.log('🔥🔥🔥 直接發送測試 🔥🔥🔥');
                    console.log('主題:', topic);
                    console.log('命令物件:', commandObject);
                    console.log('JSON 字串:', message);
                    console.log('🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥');
                    
                    activeClient.publish(topic, message, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('發送失敗:', err);
                        } else {
                            console.log('✅ 直接測試命令發送成功！');
                        }
                    });
                    
                    return true;
                };
                
                // 發送簡單的 ping 測試
                window.testMachinePing = function() {
                    console.log('=== 測試機台 Ping ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    // 發送簡單的 ping 命令
                    const pingCommand = {
                        cmd: 'ping',
                        timestamp: new Date().toISOString()
                    };
                    
                    const topics = ['coffeelens/req', 'machine/ping', 'system/ping'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            console.log(`發送 ping 到: ${topic}`);
                            client.publish(topic, JSON.stringify(pingCommand), { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`Ping ${topic} 失敗:`, err);
                                } else {
                                    console.log(`✅ Ping ${topic} 發送成功`);
                                }
                            });
                        }, index * 1000);
                    });
                };

                // 測試獲取營業資料的不同命令
                window.testBusinessDataCommands = function() {
                    console.log('=== 測試營業資料命令 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    const machineId = '65db7656fb39'; // 從回應中獲得的機台 ID
                    const timestamp = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    // 嘗試不同的營業資料命令格式
                    const commands = [
                        // 原始格式
                        {
                            cmd: 'readdata',
                            mac: '083A8DE1ED14',
                            floor: '1',
                            devid: '1',
                            taskid: timestamp + '001'
                        },
                        // 使用機台名稱
                        {
                            cmd: 'getdata',
                            machine_id: machineId,
                            request_type: 'business_data',
                            taskid: timestamp + '002'
                        },
                        // 簡化命令
                        {
                            cmd: 'data',
                            target: machineId,
                            taskid: timestamp + '003'
                        },
                        // 狀態查詢
                        {
                            cmd: 'status',
                            machine: machineId,
                            type: 'sales',
                            taskid: timestamp + '004'
                        },
                        // 銷售資料
                        {
                            cmd: 'sales_data',
                            device_id: machineId,
                            taskid: timestamp + '005'
                        }
                    ];
                    
                    const topics = ['coffeelens/req', 'machine/command', 'device/request'];
                    
                    commands.forEach((command, cmdIndex) => {
                        topics.forEach((topic, topicIndex) => {
                            const delay = (cmdIndex * topics.length + topicIndex) * 2000;
                            setTimeout(() => {
                                const message = JSON.stringify(command);
                                console.log(`測試命令 ${cmdIndex + 1}.${topicIndex + 1}: ${topic}`);
                                console.log('命令:', command);
                                
                                client.publish(topic, message, { qos: 0 }, function(err) {
                                    if (err) {
                                        console.error(`命令 ${cmdIndex + 1}.${topicIndex + 1} 發送失敗:`, err);
                                    } else {
                                        console.log(`✅ 命令 ${cmdIndex + 1}.${topicIndex + 1} 發送成功`);
                                        addCommandLog('send', `測試營業資料命令 - ${command.cmd}`, command);
                                    }
                                });
                            }, delay);
                        });
                    });
                };

                // 檢查當前頁面時間戳，確保是最新版本
                window.checkPageVersion = function() {
                    console.log('=== 頁面版本檢查 ===');
                    console.log('當前時間:', new Date().toLocaleString());
                    console.log('pollSingleMachine 函數存在:', typeof pollSingleMachine === 'function');
                    console.log('testDirectMqttSend 函數存在:', typeof window.testDirectMqttSend === 'function');
                    
                    // 檢查函數內容是否包含新的格式
                    const funcString = pollSingleMachine.toString();
                    const hasCorrectFormat = funcString.includes('cmd: \'readdata\'') && 
                                           funcString.includes('floor: \'1\'') && 
                                           funcString.includes('taskid: taskid');
                    
                    console.log('pollSingleMachine 包含正確格式:', hasCorrectFormat);
                    
                    if (!hasCorrectFormat) {
                        console.error('⚠️ 函數還是舊版本，請重新載入頁面！');
                        alert('請按 Ctrl+F5 強制重新載入頁面');
                    } else {
                        console.log('✅ 函數已更新為新版本');
                    }
                };

                // 檢查機台列表和 MAC 位址
                window.checkMachineList = function() {
                    console.log('=== 檢查機台列表 ===');
                    
                    if (!appData || !appData.machines) {
                        console.error('沒有機台資料');
                        return;
                    }
                    
                    console.log('總機台數量:', appData.machines.length);
                    
                    const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                    console.log('有 MAC 位址的機台:', machinesWithMac.length);
                    
                    console.log('機台清單:');
                    appData.machines.forEach((machine, index) => {
                        console.log(`${index + 1}. ID: ${machine.id}`);
                        console.log(`   MAC: ${machine.mac || '未設定'}`);
                        console.log(`   DevID: ${machine.devid || '1'}`);
                        console.log(`   有MAC: ${!!(machine.mac && machine.mac.trim())}`);
                        console.log('---');
                    });
                    
                    // 檢查測試用的 MAC 是否在列表中
                    const testMac = '083A8DE1ED14';
                    const foundMachine = appData.machines.find(m => m.mac === testMac);
                    
                    console.log(`測試 MAC (${testMac}) 是否在機台列表中:`, !!foundMachine);
                    if (foundMachine) {
                        console.log('找到的機台:', foundMachine);
                    } else {
                        console.warn('測試 MAC 不在機台列表中，需要先添加機台');
                    }
                    
                    return {
                        totalMachines: appData.machines.length,
                        machinesWithMac: machinesWithMac.length,
                        testMacExists: !!foundMachine
                    };
                };

                // 手動添加測試機台
                window.addTestMachine = function() {
                    const testMac = '083A8DE1ED14';
                    const existingMachine = appData.machines.find(m => m.mac === testMac);
                    
                    if (existingMachine) {
                        console.log('測試機台已存在:', existingMachine);
                        return existingMachine;
                    }
                    
                    const newMachine = {
                        id: 'TEST-001',
                        mac: testMac,
                        devid: 1,
                        storeName: '測試店舖',
                        addedBy: 'manual',
                        addedAt: new Date().toISOString()
                    };
                    
                    appData.machines.push(newMachine);
                    console.log('已添加測試機台:', newMachine);
                    
                    // 更新 UI
                    if (typeof renderMachineManagementTab === 'function') {
                        renderMachineManagementTab();
                    }
                    
                    return newMachine;
                };

                // 測試機台回應主題
                window.testMachineTopics = function() {
                    console.log('=== 測試機台回應主題 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    // 測試常見的機台回應主題
                    const testTopics = [
                        'machine/response',
                        'machine/data',
                        'machine/status',
                        'device/response',
                        'device/data',
                        'coffeelens/machine',
                        'coffeelens/data',
                        'system/response',
                        'response',
                        'data'
                    ];
                    
                    console.log('嘗試訂閱測試主題...');
                    testTopics.forEach(topic => {
                        client.subscribe(topic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn(`訂閱 ${topic} 失敗:`, err);
                            } else {
                                console.log(`✅ 成功訂閱: ${topic}`);
                            }
                        });
                    });
                    
                    // 等待一段時間後發送讀取命令
                    setTimeout(() => {
                        console.log('發送測試讀取命令...');
                        testDirectMqttSend();
                    }, 2000);
                };

                // 測試 MQTT 連接和訂閱狀態
                window.testMqttConnection = function() {
                    console.log('=== MQTT 連接狀態測試 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    console.log('MQTT 客戶端存在:', !!client);
                    console.log('連接狀態:', client.connected);
                    console.log('重新連接中:', client.reconnecting);
                    console.log('斷開中:', client.disconnecting);
                    
                    // 檢查訂閱的主題
                    const subscribedTopics = Object.keys(client.options.subscriptions || {});
                    console.log('已訂閱的主題:', subscribedTopics);
                    
                    // 檢查 UI 設定的主題
                    const topicInput = document.getElementById('mqtt-topic');
                    console.log('UI 設定的訂閱主題:', topicInput?.value);
                    
                    // 發送一個測試訊息到自己
                    const testTopic = 'test/echo';
                    const testMessage = JSON.stringify({ test: true, timestamp: new Date().toISOString() });
                    
                    console.log('發送測試回聲訊息...');
                    client.publish(testTopic, testMessage, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('測試訊息發送失敗:', err);
                        } else {
                            console.log('測試訊息發送成功');
                        }
                    });
                    
                    return {
                        connected: client.connected,
                        reconnecting: client.reconnecting,
                        subscribedTopics: subscribedTopics,
                        uiTopic: topicInput?.value
                    };
                };

                // 手動訂閱測試主題
                window.subscribeTestTopic = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    const testTopic = 'test/echo';
                    console.log('訂閱測試主題:', testTopic);
                    
                    client.subscribe(testTopic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('訂閱測試主題失敗:', err);
                        } else {
                            console.log('✅ 訂閱測試主題成功');
                        }
                    });
                };

                // 測試不同的機台命令格式
                window.testDifferentFormats = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const topics = ['coffeelens/req', 'machine/request', 'device/command'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            const message = JSON.stringify({
                                cmd: 'readdata',
                                mac: testMac,
                                floor: '1',
                                devid: '1',
                                taskid: new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17)
                            });
                            
                            console.log(`測試主題 ${index + 1}: ${topic}`);
                            console.log(`訊息: ${message}`);
                            
                            client.publish(topic, message, { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`主題 ${topic} 發送失敗:`, err);
                                } else {
                                    console.log(`✅ 主題 ${topic} 發送成功`);
                                }
                            });
                        }, index * 2000); // 每 2 秒發送一個
                    });
                };
                
            } catch (error) {
                console.error('初始化 MQTT 功能時發生錯誤:', error);
            }
        }, 2000); // 增加到 2 秒確保頁面完全載入
        
        // 初始化自動記帳表格
        setTimeout(() => {
            console.log('📊 初始化自動記帳表格...');
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
        }, 500);
        
        // 不再直接載入群組頁面，由登入邏輯控制
        // showGroupSelectionPage(); 
        
        // 通知登入系統主應用程式已載入完成
        window.dispatchEvent(new CustomEvent('appLoaded'));
    });
    </script>
</body>
</html>

