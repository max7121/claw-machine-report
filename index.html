<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æŸ¥å¸³ç³»çµ± - å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š (å¤šé–€å¸‚é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
        .store-card { transition: transform 0.2s, box-shadow 0.2s; }
        .store-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- é–€å¸‚é¸æ“‡é é¢ -->
    <div id="store-selection-page" class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-white text-center mb-8">å¨ƒå¨ƒæ©ŸæŸ¥å¸³ç³»çµ±</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">å»ºç«‹æ–°é–€å¸‚</h2>
            <form id="create-store-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-store-name" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥é–€å¸‚åç¨± (ä¾‹å¦‚ï¼šå°ä¸­é€¢ç”²åº—)" required>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">å»ºç«‹é–€å¸‚</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-bold text-white">é¸æ“‡è¦ç®¡ç†çš„é–€å¸‚</h2>
                <button id="download-all-stores-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                    </svg>
                    <span>ä¸‹è¼‰å…¨é–€å¸‚ç¸½å ±è¡¨</span>
                </button>
            </div>
            <div id="store-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- é–€å¸‚å¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                <p class="text-gray-400 col-span-full text-center py-8">æ­£åœ¨è®€å–é–€å¸‚åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- å ±è¡¨ä¸»é é¢ (é è¨­éš±è—) -->
    <div id="report-page" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button id="back-to-stores-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span>è¿”å›é–€å¸‚åˆ—è¡¨</span>
                    </button>
                    <h1 id="report-title-main" class="text-3xl sm:text-4xl font-bold text-white mb-2">å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š</h1>
                    <p class="text-lg text-gray-400" id="report-period">çµ±è¨ˆæœŸé–“ï¼š2025/10/10 ï½ ç¾åœ¨</p>
                </div>
                <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 self-end sm:self-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>ä¸‹è¼‰å ±è¡¨ (CSV)</span>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½æŠ•å¹£é‡‘é¡</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 å…ƒ</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç¸½å‡ºè²¨æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">å¹³å‡å‡ºè²¨æˆæœ¬</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 å…ƒ/æ¬¡</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">æ¯æ—¥è¨˜å¸³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="machines">æ©Ÿå°ç®¡ç†</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">åœ–è¡¨åˆ†æ</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">çµ±è¨ˆå½™æ•´</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">æ©Ÿå°ç‡Ÿæ¥­æ˜ç´°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">å„æ©Ÿå°ç‡Ÿé‹æ¦‚æ³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">åˆ†æèˆ‡å»ºè­°</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                     <h3 class="text-xl font-bold text-white mb-4">æ–°å¢æ¯æ—¥ç´€éŒ„</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ä½ç½®</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©æŠ•å¹£æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©å‡ºè²¨æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢ç´€éŒ„</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-4">è¨˜å¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ</th>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">ç•¶æ—¥æŠ•å¹£æ•¸</th>
                                    <th class="p-4 text-right">ç•¶æ—¥å‡ºè²¨æ•¸</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="machines" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">å»ºç«‹æ–°æ©Ÿå°</h3>
                    <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-6">
                        <div>
                            <label for="new-machine-id" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ç·¨è™Ÿ</label>
                            <input type="text" id="new-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šA01" required>
                        </div>
                        <div>
                            <label for="new-machine-location" class="block text-sm font-medium text-gray-300 mb-1">ä½ç½®/å…§å®¹ç‰©</label>
                            <input type="text" id="new-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šé–€å£/å¤§å¨ƒå¨ƒ" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹æ©Ÿå°</button>
                    </form>
                    
                    <h3 class="text-xl font-bold text-white mb-4 mt-4">ç¾æœ‰æ©Ÿå°åˆ—è¡¨</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="machine-list-table-body" class="divide-y divide-gray-700">
                                <!-- æ©Ÿå°åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">æ¯æ—¥æŠ•å¹£èˆ‡å‡ºè²¨è¶¨å‹¢</h3>
                        <div id="trend-chart" class="h-80 w-full"></div>
                    </div>
                </div>
                <div id="statistics" class="tab-content hidden">
                     <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">æ¯æ—¥</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æ¯é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æ¯æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æ¯å­£</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">æœŸé–“</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                    <th class="p-4 text-right">ç¸½å‡ºè²¨æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾æ©Ÿå°ç·¨è™Ÿæœå°‹...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable" data-sort="id">æ©Ÿå°ç·¨è™Ÿ <span class="sort-indicator"></span></th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="plays">ç´¯ç©æŠ•å¹£æ¬¡æ•¸ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">ç´¯ç©æŠ•å¹£é‡‘é¡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="payouts">ç´¯ç©å‡ºè²¨æ•¸é‡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">å¹³å‡å‡ºè²¨æˆæœ¬ <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="summary-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">ç¸½è¨ˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æœ¬é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æœ¬æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æœ¬å­£</button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                        <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                        <th class="p-4 text-right">ç¸½å‡ºè²¨æ•¸é‡</th>
                                        <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°æŠ•å¹£é‡‘é¡ä½”æ¯”</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>ğŸ“ˆ PSDï¼ˆæ¯æ—¥å¹³å‡éŠ·å”®è¡¨ç¾ï¼‰</h3>
                    <p>PSD å…¬å¼ç‚ºï¼šç¸½æŠ•å¹£é‡‘é¡ Ã· çµ±è¨ˆå¤©æ•¸ã€‚æ­¤æ•¸å€¼å¯ä½œç‚ºæ¯æ—¥ç‡Ÿé‹åŸºæº–ï¼Œç”¨æ–¼å¾ŒçºŒæ¯”è¼ƒé€±å ±ã€æœˆå ±è¶¨å‹¢ã€‚</p>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>è¨ˆç®—ä¸­...</strong></p>
                    </div>
                    <h3 class="mt-8">ğŸ”¬ åˆ†æèˆ‡è§€å¯Ÿ</h3>
                    <ul id="analysis-observation" class="list-disc pl-5 space-y-2"></ul>
                    <h3 class="mt-8">ğŸ’¡ çµè«–å»ºè­°</h3>
                    <ul id="analysis-suggestion" class="list-disc pl-5 space-y-2"></ul>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">å ±è¡¨å»ºç«‹æ—¥æœŸï¼š</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="modal-message" class="text-gray-300 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div id="prompt-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="prompt-title" class="text-xl font-bold text-white mb-4">æ›´æ”¹åç¨±</h3>
            <input type="text" id="prompt-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 mb-6">
            <div class="flex justify-end gap-4">
                <button id="prompt-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button id="prompt-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ç¢ºèª</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! è«‹å°‡é€™è£¡çš„è¨­å®šæ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé‡‘é‘° !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- END: Firebase Initialization ---

        // --- GLOBAL STATE ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '2025-10-10' };
        let currentSort = { key: 'id', direction: 'asc' };
        let selectedStoreId = null; 
        let selectedStoreName = ''; 
        let confirmCallback = null;
        let promptCallback = null;

        // --- PAGE & ELEMENT SELECTORS ---
        const storeSelectionPage = document.getElementById('store-selection-page');
        const reportPage = document.getElementById('report-page');
        const storeListContainer = document.getElementById('store-list');
        const createStoreForm = document.getElementById('create-store-form');
        const backToStoresBtn = document.getElementById('back-to-stores-btn');
        const downloadAllStoresBtn = document.getElementById('download-all-stores-report-btn');
        const allTabs = document.querySelectorAll('.tab-btn');
        const allTabContents = document.querySelectorAll('.tab-content');
        const searchInput = document.getElementById('searchInput');
        const sortableHeaders = document.querySelectorAll('.table-header-sortable');
        const statsControls = document.getElementById('stats-controls');
        const summaryControls = document.getElementById('summary-controls');
        const addMachineForm = document.getElementById('add-machine-form');
        const machineListTableBody = document.getElementById('machine-list-table-body');
        const historyTableBody = document.getElementById('history-table-body');
        
        // Modal selectors
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const promptModal = document.getElementById('prompt-modal');
        const promptTitle = document.getElementById('prompt-title');
        const promptInput = document.getElementById('prompt-input');
        const promptConfirmBtn = document.getElementById('prompt-confirm-btn');
        const promptCancelBtn = document.getElementById('prompt-cancel-btn');

        // --- MODAL FUNCTIONS ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        function showPromptModal(title, currentValue, onConfirm) {
            promptTitle.textContent = title;
            promptInput.value = currentValue;
            promptCallback = onConfirm;
            promptModal.classList.remove('hidden');
            promptInput.focus();
        }

        function hidePromptModal() {
            promptModal.classList.add('hidden');
            promptCallback = null;
        }


        // --- NAVIGATION & PAGE CONTROL ---
        
        function showReportPage(storeId, storeName) {
            selectedStoreId = storeId;
            selectedStoreName = storeName;
            
            document.getElementById('report-title-main').textContent = `${selectedStoreName} - ç‡Ÿæ¥­å ±å‘Š`;
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            appData = { machines: [], history: [], startDate: '2025-10-10' };
            document.querySelector('.tab-btn[data-tab="accounting"]').click();
            updateUI(); 
            
            loadStoreData(storeId);
        }

        function showStoreSelectionPage() {
            selectedStoreId = null;
            selectedStoreName = '';
            
            reportPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
            loadStores(); 
        }

        // --- DATA FUNCTIONS (Multi-store Version) ---

        async function loadStores() {
            try {
                const storeSnapshot = await db.collection('stores').orderBy('createdAt', 'desc').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStores(stores);
            } catch (error) {
                console.error("è®€å–é–€å¸‚åˆ—è¡¨å¤±æ•—:", error);
                storeListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">ç„¡æ³•è®€å–é–€å¸‚åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚</p>';
            }
        }
        
        async function loadStoreData(storeId) {
            if (!storeId) return;
            console.log(`æ­£åœ¨å¾ Firestore è®€å–é–€å¸‚ [${storeId}] çš„è³‡æ–™...`);
            const machinesCollection = db.collection('stores').doc(storeId).collection('machines');
            const historyCollection = db.collection('stores').doc(storeId).collection('history').orderBy('date', 'desc');
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                const history = historySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                appData.machines = machines;
                appData.history = history;
                
                console.log("è³‡æ–™è®€å–æˆåŠŸ!", appData);
                updateUI();

            } catch (error) {
                console.error(`å¾ Firestore è®€å–é–€å¸‚ [${storeId}] è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                showFeedback("ç„¡æ³•å¾é›²ç«¯è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
            }
        }

        async function handleCreateStore(e) {
            e.preventDefault();
            const newStoreNameInput = document.getElementById('new-store-name');
            const storeName = newStoreNameInput.value.trim();
            if (!storeName) {
                alert('é–€å¸‚åç¨±ä¸å¯ç©ºç™½ï¼');
                return;
            }
            try {
                await db.collection('stores').add({
                    name: storeName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newStoreNameInput.value = '';
                loadStores(); 
            } catch (error) {
                console.error("å»ºç«‹é–€å¸‚å¤±æ•—:", error);
                alert('å»ºç«‹é–€å¸‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleRenameStore(storeId, currentName) {
            showPromptModal('æ›´æ”¹é–€å¸‚åç¨±', currentName, async (newName) => {
                if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                    try {
                        await db.collection('stores').doc(storeId).update({ name: newName.trim() });
                        hidePromptModal();
                        loadStores();
                    } catch(error) {
                        console.error('æ›´æ–°é–€å¸‚åç¨±å¤±æ•—:', error);
                        alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    }
                } else {
                    hidePromptModal();
                }
            });
        }
        
        async function handleDeleteStore(storeId, storeName) {
            const message = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${storeName}ã€å—ï¼Ÿ\n\nè­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒæ°¸ä¹…åˆªé™¤è©²é–€å¸‚åŠå…¶åº•ä¸‹çš„æ‰€æœ‰æ©Ÿå°èˆ‡è¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
            showConfirmationModal(message, async () => {
                console.log(`é–‹å§‹åˆªé™¤é–€å¸‚: ${storeId}`);
                try {
                    const storeRef = db.collection('stores').doc(storeId);
                    
                    // æ‰¹æ¬¡åˆªé™¤ machines å­é›†åˆ
                    const machinesSnapshot = await storeRef.collection('machines').get();
                    const batch1 = db.batch();
                    machinesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                    await batch1.commit();

                    // æ‰¹æ¬¡åˆªé™¤ history å­é›†åˆ
                    const historySnapshot = await storeRef.collection('history').get();
                    const batch2 = db.batch();
                    historySnapshot.docs.forEach(doc => batch2.delete(doc.ref));
                    await batch2.commit();

                    // åˆªé™¤ä¸»æ–‡ä»¶
                    await storeRef.delete();

                    console.log(`é–€å¸‚ ${storeId} å·²æˆåŠŸåˆªé™¤ã€‚`);
                    hideConfirmationModal();
                    loadStores();

                } catch(error) {
                    console.error('åˆªé™¤é–€å¸‚å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        async function handleAddMachine(e) {
            e.preventDefault();
            if (!selectedStoreId) return alert('æ²’æœ‰é¸æ“‡æœ‰æ•ˆçš„é–€å¸‚ã€‚');

            const idInput = document.getElementById('new-machine-id');
            const locationInput = document.getElementById('new-machine-location');
            const machineId = idInput.value.trim();
            const machineLocation = locationInput.value.trim();

            if (!machineId || !machineLocation) {
                return alert('æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®ä¸èƒ½ç‚ºç©ºï¼');
            }

            try {
                await db.collection('stores').doc(selectedStoreId).collection('machines').add({
                    id: machineId,
                    location: machineLocation,
                    plays: 0,
                    payouts: 0
                });
                idInput.value = '';
                locationInput.value = '';
                loadStoreData(selectedStoreId); // é‡æ–°è¼‰å…¥è³‡æ–™
            } catch(error) {
                console.error("æ–°å¢æ©Ÿå°å¤±æ•—ï¼š", error);
                alert('æ–°å¢æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleDeleteMachine(docId) {
            if(!selectedStoreId || !docId) return;
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å°æ©Ÿå™¨å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', async () => {
                try {
                    await db.collection('stores').doc(selectedStoreId).collection('machines').doc(docId).delete();
                    hideConfirmationModal();
                    loadStoreData(selectedStoreId);
                } catch (error) {
                    console.error("åˆªé™¤æ©Ÿå°å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        async function handleDeleteHistory(historyDocId, machineId, dailyPlays, dailyPayouts) {
            if(!selectedStoreId || !historyDocId || !machineId) return;

            const machineToUpdate = appData.machines.find(m => m.id === machineId);
            if (!machineToUpdate) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°ä¾†å›æ»¾æ•¸æ“šã€‚');
                return;
            }
            
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³ç´€éŒ„å—ï¼Ÿç³»çµ±å°‡è‡ªå‹•å›æ»¾æ©Ÿå°æ•¸æ“šã€‚', async () => {
                const revertedPlays = machineToUpdate.plays - dailyPlays;
                const revertedPayouts = machineToUpdate.payouts - dailyPayouts;

                if(revertedPlays < 0 || revertedPayouts < 0) {
                    alert('éŒ¯èª¤ï¼šåˆªé™¤æ­¤ç´€éŒ„æœƒå°è‡´æ©Ÿå°ç´¯ç©æ•¸è®Šç‚ºè² æ•¸ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
                    hideConfirmationModal();
                    return;
                }

                try {
                    const machineRef = db.collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                    await machineRef.update({
                        plays: revertedPlays,
                        payouts: revertedPayouts
                    });
                    await db.collection('stores').doc(selectedStoreId).collection('history').doc(historyDocId).delete();
                    
                    hideConfirmationModal();
                    showFeedback("è¨˜å¸³ç´€éŒ„å·²åˆªé™¤ä¸¦æˆåŠŸå›æ»¾æ•¸æ“šï¼", false);
                    loadStoreData(selectedStoreId);

                } catch (error) {
                    console.error("åˆªé™¤è¨˜å¸³ç´€éŒ„å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        function calculateSummaryData(machines) {
            if (!machines) return [];
            const summary = {};
            machines.forEach(m => {
                if (!summary[m.id]) {
                    summary[m.id] = { id: m.id, location: m.location, plays: 0, payouts: 0 };
                }
                summary[m.id].plays += m.plays;
                summary[m.id].payouts += m.payouts;
            });
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }
        
        function getAggregatedSummaryData(period = 'all') {
            if (period === 'all') {
                return calculateSummaryData(appData.machines); 
            }

            const now = new Date();
            let startDate;

            switch(period) {
                case 'weekly':
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    startDate = new Date(now.setDate(diff));
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
            }

            const filteredHistory = appData.history.filter(h => {
                const recordDate = new Date(h.date);
                return recordDate >= startDate;
            });

            const summary = filteredHistory.reduce((acc, curr) => {
                if (!acc[curr.machineId]) {
                    const machineInfo = appData.machines.find(m => m.id === curr.machineId);
                    acc[curr.machineId] = { id: curr.machineId, location: machineInfo ? machineInfo.location : 'N/A', plays: 0, payouts: 0 };
                }
                acc[curr.machineId].plays += curr.newPlays;
                acc[curr.machineId].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        // --- UI RENDERING FUNCTIONS ---
        
        function renderStores(stores) {
            storeListContainer.innerHTML = ''; 
            if (stores.length === 0) {
                storeListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">å°šæœªå»ºç«‹ä»»ä½•é–€å¸‚ï¼Œè«‹ç”±ä¸Šæ–¹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹é–€å¸‚ã€‚</p>';
                return;
            }
            stores.forEach(store => {
                const storeCard = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="store-card-main cursor-pointer mb-3" data-store-id="${store.id}" data-store-name="${store.name}">
                            <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                        </div>
                        <div class="flex justify-end gap-2 border-t border-gray-600 pt-3">
                            <button class="rename-store-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">æ”¹å</button>
                            <button class="delete-store-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                storeListContainer.innerHTML += storeCard;
            });
        }
        
        function updateUI() {
            if (!appData || !appData.machines) return;
            const processedMachines = appData.machines.map(m => {
                const revenue = m.plays * COIN_VALUE;
                const cost = m.payouts > 0 ? revenue / m.payouts : 0;
                return { ...m, revenue, cost };
            });
            renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            renderSummaryTab();
            renderAnalysisTab(processedMachines);
            renderAccountingTab();
            renderMachineManagementTab(); 
            renderChartsTab();
            renderStatisticsTab();
            updateFooterAndHeader();
        }

        function renderMachineManagementTab() {
            machineListTableBody.innerHTML = '';
            if (!appData.machines || appData.machines.length === 0) {
                machineListTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-400">æ­¤é–€å¸‚å°šç„¡æ©Ÿå°ï¼Œè«‹å…ˆå»ºç«‹ä¸€å°ã€‚</td></tr>`;
                return;
            }
            appData.machines.forEach(machine => {
                const row = `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-4 font-medium text-white">${machine.id}</td>
                        <td class="p-4">${machine.location}</td>
                        <td class="p-4 text-right">
                            <button class="delete-machine-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" data-doc-id="${machine.docId}">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                machineListTableBody.innerHTML += row;
            });
        }
        
        function renderMainStats(data) {
            const totalPlays = data.reduce((sum, m) => sum + m.plays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = data.reduce((sum, m) => sum + m.payouts, 0);
            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;
            document.getElementById('total-plays').textContent = `${totalPlays.toLocaleString()} æ¬¡`;
            document.getElementById('total-revenue').textContent = `${totalRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('total-payouts').textContent = `${totalPayouts.toLocaleString()} æ¬¡`;
            document.getElementById('avg-cost').textContent = `${avgCost.toFixed(2)} å…ƒ/æ¬¡`;
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            filteredData.sort((a, b) => {
                let valA = a[currentSort.key]; let valB = b[currentSort.key];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            machineSelector.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
            if(appData.machines.length === 0) {
                machineSelector.innerHTML = '<option value="" disabled selected>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°</option>';
            } else {
                appData.machines.forEach((m, index) => {
                    machineSelector.innerHTML += `<option value="${index}">${m.id} - ${m.location}</option>`;
                });
            }
            document.getElementById('entry-date').valueAsDate = new Date();
            
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">å°šç„¡è¨˜å¸³ç´€éŒ„</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr class="hover:bg-gray-700/50">
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || 'æœªçŸ¥'}</td>
                        <td class="p-4">${h.location || 'æœªçŸ¥'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                        <td class="p-4 text-right">
                           <button class="delete-history-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" 
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                åˆªé™¤
                           </button>
                        </td>
                    </tr>`;
                });
            }
        }
        
        function renderSummaryTab() {
            const activeButton = document.querySelector('#summary-controls .active');
            const period = activeButton ? activeButton.dataset.period : 'all';
            const summaryData = getAggregatedSummaryData(period);

            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            if (summaryData.length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">æ­¤æœŸé–“ç„¡è³‡æ–™å¯ä¾›é¡¯ç¤º</td></tr>`;
            } else {
                summaryData.sort((a,b) => b.revenue - a.revenue).forEach((s, index) => {
                    const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                    summaryTableBody.innerHTML += `<tr class="${rowClass}">
                        <td class="p-4 font-medium text-white">${s.id}</td>
                        <td class="p-4 text-right">${s.revenue.toLocaleString()} å…ƒ</td>
                        <td class="p-4 text-right">${s.payouts.toLocaleString()} æ¬¡</td>
                        <td class="p-4 text-right">${s.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                    </tr>`;
                });
            }

            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red', 'indigo', 'pink'];
            
            if (summaryData.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-gray-500">ç„¡ä½”æ¯”è³‡æ–™</p>';
            } else {
                summaryData.forEach((s, index) => {
                    const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];
                    chartContainer.innerHTML += `<div class="w-full">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-${color}-300">${s.id}</span>
                            <span class="text-sm font-medium text-${color}-300">${s.revenue.toLocaleString()} å…ƒ (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                });
            }
        }

        function renderAnalysisTab(processedMachines) {
            const startDate = new Date(appData.startDate);
            const today = new Date();
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            const totalRevenue = processedMachines.reduce((sum, m) => sum + m.revenue, 0);
            const psd = totalRevenue > 0 && diffDays > 0 ? totalRevenue / diffDays : 0;
            document.getElementById('psd-display').innerHTML = `<strong>${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} å…ƒ / å¤©</strong> 
                <span class="text-sm text-gray-400">(${totalRevenue.toLocaleString()} å…ƒ Ã· ${diffDays} å¤©)</span>`;
            
            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].sort((a,b) => b.cost - a.cost);
            const bestPerformer = sortedByRevenue[0];
            const highestCost = sortedByCost[0];
            
            if (processedMachines.length > 0) {
                 document.getElementById('analysis-observation').innerHTML = `
                    <li><strong>æ”¶ç›Šå† è»ï¼š</strong><span class="font-semibold text-white">${bestPerformer.id} (${bestPerformer.location})</span> ç´¯ç©ç‡Ÿæ”¶æœ€é«˜ã€‚</li>
                    <li><strong>æˆæœ¬æœ€é«˜ï¼š</strong><span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> å¹³å‡å‡ºè²¨æˆæœ¬æœ€é«˜ï¼Œå»ºè­°è§€å¯Ÿã€‚</li>
                `;
                document.getElementById('analysis-suggestion').innerHTML = `
                    <li>é‡å° <span class="font-semibold text-white">${highestCost.id} (${highestCost.location})</span> æª¢è¨é›£åº¦èˆ‡çå“è¨­å®šï¼Œä»¥å„ªåŒ–æˆæœ¬ã€‚</li>
                    <li>æ¯é€±æŒçºŒè¿½è¹¤ <span class="font-semibold text-white">PSD æŒ‡æ¨™è®ŠåŒ–</span>ï¼Œå¯æœ‰æ•ˆæŒæ¡ç‡Ÿé‹æˆé•·è¶¨å‹¢ã€‚</li>
                `;
            } else {
                 document.getElementById('analysis-observation').innerHTML = '<li>å°šç„¡æ©Ÿå°æ•¸æ“šå¯é€²è¡Œåˆ†æã€‚</li>';
                 document.getElementById('analysis-suggestion').innerHTML = '<li>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°ï¼Œä¸¦åœ¨ã€Œæ¯æ—¥è¨˜å¸³ã€æ–°å¢ç´€éŒ„ã€‚</li>';
            }
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        key = new Date(d.setDate(diff)).toISOString().split('T')[0];
                        break;
                    case 'monthly': key = curr.date.substring(0, 7); break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        break;
                    default: key = curr.date; // daily
                }
                if (!acc[key]) {
                    acc[key] = { period: key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            const data = getAggregatedData(period);
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            if(data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">å°šç„¡æ­·å²ç´€éŒ„å¯ä¾›å½™æ•´</td></tr>`;
                return;
            }
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.period}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.revenue.toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${item.cost.toFixed(2)} å…ƒ/æ¬¡</td>
                </tr>`;
            });
        }
        
        function renderChartsTab() {
            const revenueChartEl = document.getElementById('revenue-chart');
            const costChartEl = document.getElementById('cost-chart');
            const trendChartEl = document.getElementById('trend-chart');

            revenueChartEl.innerHTML = '';
            costChartEl.innerHTML = '';
            trendChartEl.innerHTML = '<p class="text-center text-gray-500">æ­¤åœ–è¡¨åŠŸèƒ½å¾…é–‹ç™¼ã€‚</p>';

            const processedMachines = appData.machines.map(m => {
                const revenue = m.plays * COIN_VALUE;
                const cost = m.payouts > 0 ? revenue / m.payouts : 0;
                return { ...m, revenue, cost };
            });

            if (processedMachines.length === 0) {
                revenueChartEl.innerHTML = '<p class="text-center text-gray-500">å°šç„¡è³‡æ–™å¯ç¹ªè£½åœ–è¡¨</p>';
                costChartEl.innerHTML = '<p class="text-center text-gray-500">å°šç„¡è³‡æ–™å¯ç¹ªè£½åœ–è¡¨</p>';
                return;
            }

            const maxRevenue = Math.max(...processedMachines.map(m => m.revenue));
            processedMachines.forEach(machine => {
                const barWidth = maxRevenue > 0 ? (machine.revenue / maxRevenue * 100) : 0;
                const chartItem = `
                    <div class="flex items-center space-x-4">
                        <div class="w-28 text-sm font-medium text-gray-300 truncate">${machine.id} - ${machine.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                               ${machine.revenue.toLocaleString()} å…ƒ
                            </div>
                        </div>
                    </div>
                `;
                revenueChartEl.innerHTML += chartItem;
            });

            const maxCost = Math.max(...processedMachines.map(m => m.cost));
             processedMachines.forEach(machine => {
                const barWidth = maxCost > 0 ? (machine.cost / maxCost * 100) : 0;
                const chartItem = `
                    <div class="flex items-center space-x-4">
                        <div class="w-28 text-sm font-medium text-gray-300 truncate">${machine.id} - ${machine.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                             <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                               ${machine.cost.toFixed(2)} å…ƒ/æ¬¡
                            </div>
                        </div>
                    </div>
                `;
                costChartEl.innerHTML += chartItem;
            });
        }
        function updateFooterAndHeader() { /* ... Footer rendering logic ... */ }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        async function handleDownloadAllStoresReport() {
            const btn = document.getElementById('download-all-stores-report-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>è™•ç†ä¸­...</span>`;
            btn.disabled = true;

            try {
                const storeSnapshot = await db.collection('stores').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (stores.length === 0) {
                    alert("æ²’æœ‰ä»»ä½•é–€å¸‚å¯ä¾›ä¸‹è¼‰å ±è¡¨ã€‚");
                    return;
                }

                const csvRows = [];
                csvRows.push(`å…¨é–€å¸‚ç‡Ÿé‹æ¦‚æ³ç¸½å ±è¡¨`);
                csvRows.push(`å ±è¡¨ç”¢ç”Ÿæ—¥æœŸ: ${new Date().toLocaleString()}`);

                for (const store of stores) {
                    const machinesSnapshot = await db.collection('stores').doc(store.id).collection('machines').get();
                    const machines = machinesSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    
                    const summaryData = calculateSummaryData(machines);

                    csvRows.push("");
                    csvRows.push(`--- ${store.name} ---`);
                    const summaryTableHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ç¸½æŠ•å¹£é‡‘é¡", "ç¸½å‡ºè²¨æ•¸é‡", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                    csvRows.push(summaryTableHeaders.join(","));

                    if (summaryData.length > 0) {
                        summaryData.forEach(item => {
                            csvRows.push([
                                item.id,
                                item.revenue,
                                item.payouts,
                                item.cost.toFixed(2)
                            ].join(","));
                        });
                    } else {
                        csvRows.push("æ­¤é–€å¸‚å°šç„¡æ©Ÿå°æ•¸æ“š");
                    }
                }
                
                let csvContent = "\uFEFF";
                csvContent += csvRows.join("\n");

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `å…¨é–€å¸‚ç‡Ÿé‹æ¦‚æ³ç¸½å ±è¡¨-${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("ä¸‹è¼‰å…¨é–€å¸‚å ±è¡¨å¤±æ•—:", error);
                alert("ä¸‹è¼‰å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- EVENT LISTENERS ---

        storeListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.store-card-main');
            const renameBtn = e.target.closest('.rename-store-btn');
            const deleteBtn = e.target.closest('.delete-store-btn');

            if (mainCard) {
                const storeId = mainCard.dataset.storeId;
                const storeName = mainCard.dataset.storeName;
                showReportPage(storeId, storeName);
            } else if (renameBtn) {
                const storeId = renameBtn.dataset.storeId;
                const storeName = renameBtn.dataset.storeName;
                handleRenameStore(storeId, storeName);
            } else if (deleteBtn) {
                const storeId = deleteBtn.dataset.storeId;
                const storeName = deleteBtn.dataset.storeName;
                handleDeleteStore(storeId, storeName);
            }
        });
        
        createStoreForm.addEventListener('submit', handleCreateStore);
        addMachineForm.addEventListener('submit', handleAddMachine);
        downloadAllStoresBtn.addEventListener('click', handleDownloadAllStoresReport);
        
        modalConfirmBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
        });
        modalCancelBtn.addEventListener('click', hideConfirmationModal);

        promptConfirmBtn.addEventListener('click', () => {
            if(promptCallback) promptCallback(promptInput.value);
        });
        promptCancelBtn.addEventListener('click', hidePromptModal);

        machineListTableBody.addEventListener('click', (e) => {
            if(e.target.classList.contains('delete-machine-btn')) {
                const docId = e.target.dataset.docId;
                handleDeleteMachine(docId);
            }
        });

        historyTableBody.addEventListener('click', (e) => {
            if(e.target.classList.contains('delete-history-btn')) {
                const button = e.target;
                const docId = button.dataset.docId;
                const machineId = button.dataset.machineId;
                const plays = parseInt(button.dataset.plays, 10);
                const payouts = parseInt(button.dataset.payouts, 10);
                handleDeleteHistory(docId, machineId, plays, payouts);
            }
        });

        backToStoresBtn.addEventListener('click', showStoreSelectionPage);

        allTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.style.display = content.id === tab.dataset.tab ? 'block' : 'none';
                });
                if (tab.dataset.tab === 'charts') { renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
                if (tab.dataset.tab === 'summary') { renderSummaryTab(); }
            });
        });

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        summaryControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                summaryControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderSummaryTab();
            }
        });
        
        document.getElementById('daily-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedStoreId) {
                return showFeedback('éŒ¯èª¤ï¼šæœªé¸æ“‡ä»»ä½•é–€å¸‚ã€‚', true);
            }
            
            const date = document.getElementById('entry-date').value;
            const machineIndex = parseInt(document.getElementById('machine-selector').value);
            const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
            const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

            if (isNaN(machineIndex) || isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                return showFeedback('éŒ¯èª¤ï¼šè«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚', true);
            }

            const selectedMachine = appData.machines[machineIndex];
            if (!selectedMachine) { return showFeedback('éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥æ‰€é¸æ©Ÿå°ã€‚', true); }
            if (cumulativePlaysInput < selectedMachine.plays || cumulativePayoutsInput < selectedMachine.payouts) {
                return showFeedback('éŒ¯èª¤ï¼šè¼¸å…¥çš„ç´¯ç©æ•¸å€¼å°æ–¼ä¸Šæ¬¡ç´€éŒ„ï¼Œè«‹ç¢ºèªæŠ„è¡¨æ•¸å€¼æ˜¯å¦æ­£ç¢ºã€‚', true);
            }

            const dailyPlays = cumulativePlaysInput - selectedMachine.plays;
            const dailyPayouts = cumulativePayoutsInput - selectedMachine.payouts;
            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('æ•¸æ“šæœªè®Šæ›´ï¼Œç„¡éœ€æ–°å¢ç´€éŒ„ã€‚');
            }

            try {
                const machineDocId = selectedMachine.docId;
                const machineRef = db.collection('stores').doc(selectedStoreId).collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });
                
                await db.collection('stores').doc(selectedStoreId).collection('history').add({
                    date: date,
                    machineId: selectedMachine.id,
                    location: selectedMachine.location,
                    newPlays: dailyPlays,
                    newPayouts: dailyPayouts
                });
                
                await loadStoreData(selectedStoreId); 
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const successMessage = `ç´€éŒ„å·²åŒæ­¥è‡³ [${selectedStoreName}]ï¼æœ¬æ—¥ ${selectedMachine.id} æ–°å¢ï¼š<strong class="text-white">${dailyPlays}</strong> æŠ•å¹£ã€<strong class="text-white">${dailyPayouts}</strong> å‡ºè²¨ã€‚`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("å¯«å…¥ Firestore æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                showFeedback("ç„¡æ³•å°‡ç´€éŒ„åŒæ­¥è‡³é›²ç«¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
            }
        });
        
        searchInput.addEventListener('input', () => updateUI());
        sortableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? 'â–²' : 'â–¼';
                updateUI();
            });
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            if (!selectedStoreId) return;

            const processedMachines = appData.machines.map(m => {
                const revenue = m.plays * COIN_VALUE;
                const cost = m.payouts > 0 ? revenue / m.payouts : 0;
                return { ...m, revenue, cost };
            });
            
            const summaryData = calculateSummaryData(appData.machines);

            if (processedMachines.length === 0 && appData.history.length === 0) {
                showFeedback("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›ä¸‹è¼‰ã€‚", true);
                return;
            }
            
            const csvRows = [];
            let csvContent = "\uFEFF";

            csvRows.push(`å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š - ${selectedStoreName}`);
            
            // Section 1: æ©Ÿå°ç‡Ÿæ¥­æ˜ç´° (ç¸½è¦½)
            csvRows.push("");
            csvRows.push("æ©Ÿå°ç‡Ÿæ¥­æ˜ç´° (ç¸½è¦½)");
            const detailsHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç´¯ç©æŠ•å¹£æ¬¡æ•¸", "ç´¯ç©æŠ•å¹£é‡‘é¡", "ç´¯ç©å‡ºè²¨æ•¸é‡", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
            csvRows.push(detailsHeaders.join(","));
            processedMachines.forEach(item => {
                csvRows.push([item.id, `"${item.location}"`, item.plays, item.revenue, item.payouts, item.cost.toFixed(2)].join(","));
            });

            // Section 2: å„æ©Ÿå°ç‡Ÿé‹ç‹€æ³ - ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨
            if (summaryData.length > 0) {
                csvRows.push("");
                csvRows.push("å„æ©Ÿå°ç‡Ÿé‹ç‹€æ³ - ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨");
                const summaryTableHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ç¸½æŠ•å¹£é‡‘é¡", "ç¸½å‡ºè²¨æ•¸é‡", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                csvRows.push(summaryTableHeaders.join(","));
                summaryData.forEach(item => {
                    csvRows.push([
                        item.id,
                        item.revenue,
                        item.payouts,
                        item.cost.toFixed(2)
                    ].join(","));
                });
            }
            

            // Section 3: æ¯æ—¥è¨˜å¸³æ˜ç´°
            if (appData.history.length > 0) {
                csvRows.push("");
                csvRows.push("æ¯æ—¥è¨˜å¸³æ˜ç´°");
                const historyHeaders = ["æ—¥æœŸ", "æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç•¶æ—¥æŠ•å¹£æ•¸", "ç•¶æ—¥å‡ºè²¨æ•¸"];
                csvRows.push(historyHeaders.join(","));
                const sortedHistory = [...appData.history].sort((a, b) => b.date.localeCompare(a.date));
                sortedHistory.forEach(item => {
                    csvRows.push([item.date, item.machineId, `"${item.location}"`, item.newPlays, item.newPayouts].join(","));
                });
            }

            // Section 4: åœ–è¡¨åˆ†æåŸå§‹æ•¸æ“š
            if (processedMachines.length > 0) {
                csvRows.push("");
                csvRows.push("åœ–è¡¨åˆ†æåŸå§‹æ•¸æ“š");
                csvRows.push("å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ");
                csvRows.push(["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "ç¸½ç‡Ÿæ”¶(å…ƒ)"].join(","));
                [...processedMachines].sort((a, b) => b.revenue - a.revenue).forEach(item => {
                    csvRows.push([item.id, `"${item.location}"`, item.revenue].join(","));
                });
                csvRows.push("");
                csvRows.push("å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬");
                csvRows.push(["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"].join(","));
                [...processedMachines].sort((a, b) => b.cost - a.cost).forEach(item => {
                    csvRows.push([item.id, `"${item.location}"`, item.cost.toFixed(2)].join(","));
                });
            }

            csvContent += csvRows.join("\n");
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const today = new Date();
            const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            link.setAttribute("download", `${selectedStoreName}-å…¨æ–¹ä½å ±å‘Š-${dateString}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- INITIAL LOAD ---
        loadStores(); 
    });
    </script>
</body>
</html>

