<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æŸ¥å¸³ç³»çµ± - å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š (å¤šå–®ä½é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
        .card-base { transition: transform 0.2s, box-shadow 0.2s; }
        .card-base:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .preset-tag { cursor: pointer; transition: background-color 0.2s; }
        .preset-tag:hover { background-color: #4f46e5; }
        
        /* åœ–è¡¨æ¨£å¼ */
        .checkout-chart svg { filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); }
        .checkout-chart circle { transition: all 0.2s ease; }
        .checkout-chart circle:hover { filter: brightness(1.2); transform: scale(1.2); }
        .checkout-chart path { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)); }
        
        /* ç·¨è¼¯æ¨¡æ…‹æ¡†æ¨£å¼ */
        #edit-machine-modal { 
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease-out;
        }
        #edit-machine-modal.hidden {
            animation: modalFadeOut 0.3s ease-in;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .edit-modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- ç™»å…¥/ä½¿ç”¨è€…å€å¡Š -->
    <div id="user-bar" class="max-w-7xl mx-auto flex justify-end mb-4 hidden">
        <div class="flex items-center gap-3">
            <span id="user-greeting" class="text-gray-300">æ­¡è¿ï¼Œ<strong id="user-name">ä½¿ç”¨è€…</strong></span>
            <button id="admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded hidden">ç®¡ç†</button>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">ç™»å‡º</button>
        </div>
    </div>

    <!-- ç™»å…¥ modal (é è¨­é¡¯ç¤ºï¼Œå¦‚æœæœªç™»å…¥) -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">è«‹å…ˆç™»å…¥</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-1">å¸³è™Ÿ</label>
                    <input id="username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¼¸å…¥å¸³è™Ÿ">
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-1">å¯†ç¢¼</label>
                    <input id="password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¼¸å…¥å¯†ç¢¼">
                </div>
                <div class="flex items-center justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ç™»å…¥</button>
                </div>
                <div id="login-feedback" class="text-sm text-red-400 mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- å±¤ç´š 1: å–®ä½ç¾¤çµ„é¸æ“‡é é¢ -->
    <div id="group-selection-page" class="max-w-4xl mx-auto hidden">
        <h1 class="text-4xl font-bold text-white text-center mb-8">å¨ƒå¨ƒæ©ŸæŸ¥å¸³ç³»çµ±</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">å»ºç«‹æ–°å–®ä½ç¾¤çµ„</h2>
            <form id="create-group-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-group-name" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å–®ä½åç¨± (ä¾‹å¦‚ï¼šAå–®ä½)" required>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">å»ºç«‹ç¾¤çµ„</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">é¸æ“‡æ‚¨çš„å–®ä½ç¾¤çµ„</h2>
            <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">æ­£åœ¨è®€å–ç¾¤çµ„åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…è¨­å®šé é¢ -->
    <div id="admin-page" class="max-w-6xl mx-auto hidden">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-4xl font-bold text-white">ç³»çµ±ç®¡ç†</h1>
            <button id="back-to-main-btn" class="text-blue-400 hover:text-blue-300 transition flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                <span>è¿”å›ä¸»ç³»çµ±</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ç®¡ç†å“¡å¸³å¯†è¨­å®š -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">ç®¡ç†å“¡å¸³å¯†è¨­å®š</h2>
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm text-gray-300 mb-1">ç›®å‰å¯†ç¢¼</label>
                        <input id="current-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-username" class="block text-sm text-gray-300 mb-1">æ–°å¸³è™Ÿ</label>
                        <input id="new-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm text-gray-300 mb-1">æ–°å¯†ç¢¼</label>
                        <input id="new-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm text-gray-300 mb-1">ç¢ºèªå¯†ç¢¼</label>
                        <input id="confirm-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">æ›´æ–°ç®¡ç†å“¡å¸³å¯†</button>
                </form>
                <div id="admin-password-feedback" class="text-sm mt-2 hidden"></div>
            </div>

            <!-- è¨ªå®¢å¸³è™Ÿç®¡ç† -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">è¨ªå®¢å¸³è™Ÿç®¡ç†</h2>
                <form id="guest-account-form" class="space-y-4 mb-6">
                    <div>
                        <label for="guest-username" class="block text-sm text-gray-300 mb-1">è¨ªå®¢å¸³è™Ÿ</label>
                        <input id="guest-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="guest-password" class="block text-sm text-gray-300 mb-1">è¨ªå®¢å¯†ç¢¼</label>
                        <input id="guest-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">å¯è¨ªå•çš„ç¾¤çµ„</label>
                        <div id="group-permissions" class="space-y-2 max-h-32 overflow-y-auto bg-gray-700 p-3 rounded-lg">
                            <p class="text-gray-400 text-sm">è¼‰å…¥ç¾¤çµ„åˆ—è¡¨ä¸­...</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">é é¢è¨ªå•æ¬Šé™</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-gray-700 p-4 rounded-lg">
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">å ±è¡¨åŠŸèƒ½</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="details" class="page-permission-checkbox rounded text-blue-600">
                                    <span>æ©Ÿå°æ˜ç´°</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="summary" class="page-permission-checkbox rounded text-blue-600">
                                    <span>ç‡Ÿé‹ç¸½è¦½</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="analysis" class="page-permission-checkbox rounded text-blue-600">
                                    <span>ç¶“ç‡Ÿåˆ†æ</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="charts" class="page-permission-checkbox rounded text-blue-600">
                                    <span>åœ–è¡¨çµ±è¨ˆ</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="statistics" class="page-permission-checkbox rounded text-blue-600">
                                    <span>æ•¸æ“šçµ±è¨ˆ</span>
                                </label>
                            </div>
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-green-300">æ“ä½œåŠŸèƒ½</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="accounting" class="page-permission-checkbox rounded text-green-600">
                                    <span>æ¯æ—¥è¨˜å¸³</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="machines" class="page-permission-checkbox rounded text-green-600">
                                    <span>æ©Ÿå°ç®¡ç†</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="profit" class="page-permission-checkbox rounded text-yellow-600">
                                    <span>ç›ˆåˆ©è¨ˆç®—</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="checkout" class="page-permission-checkbox rounded text-green-600">
                                    <span>çµå¸³ä½œæ¥­</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="download" class="page-permission-checkbox rounded text-purple-600">
                                    <span>ä¸‹è¼‰å ±å‘Š</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="edit" class="page-permission-checkbox rounded text-orange-600">
                                    <span>ç·¨è¼¯/åˆªé™¤</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" id="select-all-permissions" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">å…¨é¸</button>
                            <button type="button" id="select-readonly-permissions" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">åƒ…æª¢è¦–</button>
                            <button type="button" id="clear-all-permissions" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">æ¸…é™¤</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢è¨ªå®¢</button>
                        <button type="button" id="cancel-guest-edit" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">å–æ¶ˆ</button>
                    </div>
                </form>
                <div id="guest-account-feedback" class="text-sm mt-2 hidden"></div>
            </div>
        </div>

        <!-- è¨ªå®¢å¸³è™Ÿåˆ—è¡¨ -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">ç¾æœ‰è¨ªå®¢å¸³è™Ÿ</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-4">å¸³è™Ÿ</th>
                            <th class="p-4">ç‹€æ…‹</th>
                            <th class="p-4">å¯è¨ªå•ç¾¤çµ„</th>
                            <th class="p-4">é é¢æ¬Šé™</th>
                            <th class="p-4">å»ºç«‹æ™‚é–“</th>
                            <th class="p-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="guest-accounts-table" class="divide-y divide-gray-700">
                        <tr><td colspan="6" class="text-center p-8 text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç³»çµ±å·¥å…· -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">ç³»çµ±å·¥å…·</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="export-config-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">åŒ¯å‡ºè¨­å®š</button>
                <button id="import-config-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition">åŒ¯å…¥è¨­å®š</button>
                <button id="reset-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">é‡ç½®ç³»çµ±</button>
            </div>
            <input type="file" id="config-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <!-- å±¤ç´š 2: é–€å¸‚é¸æ“‡é é¢ (é è¨­éš±è—) -->
    <div id="store-selection-page" class="max-w-4xl mx-auto hidden">
         <button id="back-to-groups-btn" class="text-blue-400 hover:text-blue-300 transition mb-4 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <span>è¿”å›ç¾¤çµ„åˆ—è¡¨</span>
        </button>
        <h1 id="store-page-title" class="text-4xl font-bold text-white text-center mb-8">é–€å¸‚ç®¡ç†</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">å»ºç«‹æ–°é–€å¸‚</h2>
            <form id="create-store-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="new-store-name" class="block text-sm font-medium text-gray-300 mb-1">é–€å¸‚åç¨±</label>
                    <input type="text" id="new-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šå°ä¸­é€¢ç”²åº—" required>
                </div>
                 <div>
                    <label for="new-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">ç‡Ÿæ¥­èµ·å§‹æ—¥</label>
                    <input type="date" id="new-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <button type="submit" class="sm:col-span-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shrink-0">å»ºç«‹é–€å¸‚</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
             <h2 class="text-2xl font-bold text-white mb-4">é¸æ“‡è¦ç®¡ç†çš„é–€å¸‚</h2>
            <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-3">ä¸‹è¼‰æ‰€é¸é–€å¸‚å ±è¡¨</h3>
                <div class="flex flex-col gap-4 w-full">
                    <!-- ç¬¬ä¸€æ’ï¼šCSVå ±è¡¨æŒ‰éˆ• -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                        <!-- éš±è—å¤–éƒ¨é¸æ“‡å™¨ï¼Œæ”¹ç”±å½ˆçª—å…§é¸æ“‡ -->
                        <select id="report-period-selector" class="hidden bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                            <option value="all">ç¸½å’Œ</option>
                            <option value="daily">å–®æ—¥</option>
                            <option value="weekly">é€±å ±</option>
                            <option value="monthly">æœˆå ±</option>
                            <option value="quarterly">å­£å ±</option>
                            <option value="yearly">å¹´å ±</option>
                        </select>
                        <input type="date" id="report-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto hidden" title="é¸æ“‡å ±è¡¨åŸºæº–æ—¥">
                        <button id="download-all-stores-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 w-full sm:w-auto justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                            </svg>
                            <span>è‡ªå®šç¾©é–€å¸‚å ±è¡¨</span>
                        </button>
                    </div>
                    
                    <!-- ç¬¬äºŒæ’ï¼šç¶²é é è¦½å ±è¡¨å€å¡Š -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full border-t border-gray-700 pt-4">
                        <select id="preview-period-selector" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                            <option value="all">å…¨éƒ¨æœŸé–“</option>
                            <option value="daily">å–®æ—¥</option>
                            <option value="weekly">é€±å ±</option>
                            <option value="monthly">æœˆå ±</option>
                            <option value="quarterly">å­£å ±</option>
                            <option value="yearly">å¹´å ±</option>
                        </select>
                        <input type="date" id="preview-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="é¸æ“‡å ±è¡¨åŸºæº–æ—¥">
                        <button id="open-store-report-view-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto justify-center">
                            ç¶²é é è¦½å ±è¡¨
                        </button>
                    </div>
                    
                    <!-- ç¬¬ä¸‰æ’ï¼šæ¯å‘¨ç‡Ÿæ¥­é¡è¶¨å‹¢åˆ†æ -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full border-t border-gray-700 pt-4 mt-4">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label class="text-gray-300 text-sm whitespace-nowrap">èµ·å§‹æ—¥æœŸ</label>
                            <input type="date" id="weekly-trend-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="é¸æ“‡èµ·å§‹æ—¥æœŸ">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label class="text-gray-300 text-sm whitespace-nowrap">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="weekly-trend-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="é¸æ“‡çµæŸæ—¥æœŸ">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <button id="open-weekly-trend-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                                </svg>
                                å–®ä¸€é–€å¸‚è¶¨å‹¢
                            </button>
                            <button id="open-multi-weekly-trend-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                                </svg>
                                å¤šé–€å¸‚å‘¨å ±æ¯”è¼ƒ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
             <div class="flex justify-end gap-4 mb-4">
                 <button id="poll-all-stores-btn" class="text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                     </svg>
                     ç«‹å³è¼ªè©¢æ‰€æœ‰é–€å¸‚
                 </button>
                 <button id="select-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">å…¨é¸</button>
                 <button id="deselect-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">å–æ¶ˆå…¨é¸</button>
             </div>
            <div id="store-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">æ­£åœ¨è®€å–é–€å¸‚åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <!-- å±¤ç´š 3: å ±è¡¨ä¸»é é¢ (é è¨­éš±è—) -->
    <div id="report-page" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button id="back-to-stores-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span>è¿”å›é–€å¸‚åˆ—è¡¨</span>
                    </button>
                    <h1 id="report-title-main" class="text-3xl sm:text-4xl font-bold text-white mb-2">å¨ƒå¨ƒæ©Ÿç‡Ÿæ¥­å ±å‘Š</h1>
                    <p class="text-lg text-gray-400" id="report-period">çµ±è¨ˆæœŸé–“ï¼š</p>
                </div>
                <div id="header-download-buttons" class="flex items-center gap-2">
                    <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>è‡ªå®šç¾©å ±è¡¨ä¸‹è¼‰</span>
                    </button>
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        <span>å¿«é€Ÿåˆ—å° (PDF)</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- ç•¶æœŸçµ±è¨ˆèªªæ˜ -->
        <div class="mb-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
            <p class="text-blue-300 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ä»¥ä¸‹æ•¸æ“šç‚ºç•¶æœŸæœªçµå¸³çµ±è¨ˆï¼ˆç¸½æ•¸æ“šæ‰£é™¤æœ€å¾Œçµå¸³è³‡æ–™å¾Œçš„æ•¸å€¼ï¼‰
            </p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç•¶æœŸæŠ•å¹£æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç•¶æœŸæŠ•å¹£é‡‘é¡</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 å…ƒ</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç•¶æœŸå‡ºè²¨æ¬¡æ•¸</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 æ¬¡</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">ç•¶æœŸå¹³å‡æˆæœ¬</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 å…ƒ/æ¬¡</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">æ¯æ—¥è¨˜å¸³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="machines">æ©Ÿå°ç®¡ç†</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">åœ–è¡¨åˆ†æ</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">çµ±è¨ˆå½™æ•´</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">æ©Ÿå°ç‡Ÿæ¥­æ˜ç´°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">å„æ©Ÿå°ç‡Ÿé‹æ¦‚æ³</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">åˆ†æèˆ‡å»ºè­°</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="profit">ç›ˆåˆ©è¨ˆç®—</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="checkout">çµå¸³ä½œæ¥­</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                     <h3 class="text-xl font-bold text-white mb-4">æ–°å¢æ¯æ—¥ç´€éŒ„</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ä½ç½®</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©æŠ•å¹£æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç´¯ç©å‡ºè²¨æ•¸ (æŠ„è¡¨)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="è¡¨ä¸Šé¡¯ç¤ºçš„ç¸½æ¬¡æ•¸" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">æ–°å¢ç´€éŒ„</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                        
                        <!-- è¼ªè©¢å¸¶å…¥æŒ‰éˆ• -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                            <button id="import-from-poll-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>ğŸ“¥ å¾è¼ªè©¢å¸¶å…¥</span>
                            </button>
                            <button id="batch-add-all-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>ğŸš€ æ‰¹é‡æ–°å¢æ‰€æœ‰æ©Ÿå° (ç„¡é™åˆ¶)</span>
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">ğŸ“Š HTTP è¼ªè©¢è‡ªå‹•è¨˜å¸³</h3>
                    <p class="text-sm text-gray-400 mb-4">å¾ HTTP ç«¯é»è‡ªå‹•è¼ªè©¢æ”¶é›†çš„æ¯æ—¥è¨˜å¸³æ•¸æ“šï¼ˆdevid=1 å·¦å¤©è»Šã€devid=2 å³å¤©è»Šï¼‰</p>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ</th>
                                    <th class="p-4">å¤©è»Š</th>
                                    <th class="p-4 text-right">æŠ•å¹£æ•¸</th>
                                    <th class="p-4 text-right">å‡ºçæ•¸</th>
                                    <th class="p-4 text-center">æ›´æ–°æ¬¡æ•¸</th>
                                    <th class="p-4 text-center">æœ€å¾Œæ›´æ–°</th>
                                    <th class="p-4 text-center">å»ºç«‹æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="auto-record-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">è¨˜å¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ</th>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4 text-right">ç•¶æ—¥æŠ•å¹£æ•¸</th>
                                    <th class="p-4 text-right">ç•¶æ—¥å‡ºè²¨æ•¸</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="machines" class="tab-content hidden">
                    <!-- HTTP å³æ™‚åŒæ­¥å€å¡Š -->
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">HTTP å³æ™‚åŒæ­¥</h3>

                        <!-- HTTP è¼ªè©¢æ§åˆ¶ -->
                        <div class="mt-4 flex flex-col lg:flex-row items-start lg:items-center justify-between bg-gray-800/50 p-3 rounded-lg gap-4">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 flex-1">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="auto-poll-enabled" class="rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-300">å•Ÿç”¨è‡ªå‹•è¼ªè©¢æ‰€æœ‰æ©Ÿå°</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="auto-poll-on-load" class="rounded bg-gray-700 border-gray-600 text-green-600 focus:ring-green-500">
                                    <span class="text-sm text-gray-300">ğŸš€ é€²å…¥é–€å¸‚å¾Œè‡ªå‹•è¼ªè©¢å…©æ¬¡ï¼ˆé–“éš”1ç§’ï¼‰</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-300">é–“éš”ï¼š</label>
                                    <select id="poll-interval" class="bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                        <option value="500">0.5ç§’</option>
                                        <option value="1000">1ç§’</option>
                                        <option value="2000">2ç§’</option>
                                        <option value="3000">3ç§’</option>
                                        <option value="5000">5ç§’</option>
                                        <option value="10000" selected>10ç§’</option>
                                        <option value="30000">30ç§’</option>
                                        <option value="60000">1åˆ†é˜</option>
                                        <option value="300000">5åˆ†é˜</option>
                                    </select>
                                </div>
                            </div>
                            <!-- å›ºå®šä½¿ç”¨ HTTP æ¨¡å¼ï¼ˆå·²éš±è—é¸æ“‡å™¨ï¼‰ -->
                            <input type="hidden" id="http-transport-mode" value="direct-http">
                            <input type="hidden" id="http-poll-mode" value="batch">
                            <button id="poll-all-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                ğŸ“Š ç«‹å³è¼ªè©¢æ‰€æœ‰æ©Ÿå°
                            </button>
                            <button id="poll-test-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                ğŸ§ª æ¸¬è©¦è¼ªè©¢ (å‰4çµ„)
                            </button>
                            <button id="quick-read-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                âš¡ å¿«é€Ÿè®€å– (è·³éæŸ¥è©¢)
                            </button>
                            <button id="debug-mapping-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                ğŸ” èª¿è©¦æ˜ å°„è¡¨
                            </button>
                        </div>
                        

                        
                        <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                            <div class="flex items-center space-x-2">
                                <div id="mqtt-status-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span id="mqtt-status-text" class="text-sm text-gray-400">æœªé€£æ¥</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>æœ€å¾Œæ›´æ–°ï¼š</span>
                                <span id="last-mqtt-update">ç„¡</span>
                            </div>
                        </div>

                    </div>

                    <!-- ğŸ”§ é–‹ç™¼è€…æ¨¡å¼å®¹å™¨ -->
                    <div class="bg-gray-800/50 rounded-lg p-4 border-l-4 border-purple-500 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <h4 class="text-lg font-medium text-purple-300">ğŸ”§ é–‹ç™¼è€…å·¥å…·</h4>
                                <span class="text-xs bg-purple-600 text-purple-100 px-2 py-0.5 rounded">å·¥ç¨‹å°ˆç”¨</span>
                            </div>
                            <button id="toggle-dev-mode" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-colors">
                                é¡¯ç¤ºèª¿è©¦å·¥å…·
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">æ­¤å€åŸŸåŒ…å«æ©Ÿå°èª¿è©¦ã€æ‰¹æ¬¡è™•ç†è¨­å®šå’Œç³»çµ±è¨ºæ–·å·¥å…·ï¼Œä¾›æŠ€è¡“äººå“¡ä½¿ç”¨</p>
                        
                        <!-- é–‹ç™¼è€…å·¥å…·å€åŸŸ (é è¨­éš±è—) -->
                        <div id="developer-tools" class="hidden mt-4 space-y-4">
                            <!-- HTTP è®€å–è³‡æ–™åŠŸèƒ½ -->
                            <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                                <h3 class="text-red-400 font-bold text-lg mb-4">ğŸ“– æ“·å–æ©Ÿå°è³‡æ–™ (HTTP GET)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="read-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå° MAC ä½å€</label>
                                <input type="text" id="read-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="083A8DE1ED14" value="083A8DE1ED14">
                                <p class="text-xs text-gray-500 mt-1">æ©Ÿå° WiFi å°å¡çš„ MAC ä½å€</p>
                            </div>
                            <div>
                                <label for="read-device-id" class="block text-sm font-medium text-gray-300 mb-1">å¤©è»Š ID</label>
                                <select id="read-device-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                    <option value="1">å·¦å¤©è»Š (ID: 1)</option>
                                    <option value="2">å³å¤©è»Š (ID: 2)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="send-read-command" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    ğŸ“¤ æ¸¬è©¦æŸ¥è©¢
                                </button>
                            </div>
                        </div>

                        <!-- HTTP é€£ç·šæ¸¬è©¦æŒ‰éˆ• -->
                        <div class="mb-4">
                            <button id="mqtt-test-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                ğŸ”— æ¸¬è©¦ HTTP é€£ç·š
                            </button>
                        </div>

                                <!-- å‘½ä»¤è¨˜éŒ„ -->
                                <div class="bg-gray-900/50 p-3 rounded-lg">
                                    <h4 class="text-sm font-medium text-yellow-400 mb-2">ğŸ“‹ å‘½ä»¤è¨˜éŒ„</h4>
                                    <div id="mqtt-command-log" class="space-y-2 max-h-32 overflow-y-auto text-xs">
                                        <p class="text-gray-500">HTTP å‘½ä»¤è¨˜éŒ„å°‡åœ¨æ­¤é¡¯ç¤º...</p>
                                    </div>
                                </div>
                                
                                <!-- æ‰¹æ¬¡è™•ç†è¨­å®š -->
                                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                                    <h5 class="text-blue-400 font-medium mb-3">âš™ï¸ æ‰¹æ¬¡è™•ç†è¨­å®š</h5>
                                    <div class="flex flex-wrap items-center gap-4">
                                        <div class="flex items-center space-x-2">
                                            <label for="batch-size-input" class="text-sm text-gray-300">æ‰¹æ¬¡å¤§å°:</label>
                                            <input type="number" id="batch-size-input" min="1" max="1000" value="50" 
                                                   class="w-20 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                            <button id="set-batch-size-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded">
                                                è¨­å®š
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button id="unlimited-mode-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                                ğŸš€ ç„¡é™åˆ¶æ¨¡å¼
                                            </button>
                                            <button id="check-batch-status-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded">
                                                ğŸ“Š æª¢æŸ¥ç‹€æ…‹
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <span id="batch-status-display" class="text-xs text-gray-400">
                                            ç›®å‰æ‰¹æ¬¡å¤§å°: 50 | æ¨¡å¼: æ¨™æº–
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- æ©Ÿå°è³‡æ–™é¡¯ç¤ºå€åŸŸ -->
                                <div class="space-y-3" id="machine-data-displays">
                                    <!-- å‹•æ…‹ç”Ÿæˆçš„æ©Ÿå°è³‡æ–™é¡¯ç¤ºæœƒå‡ºç¾åœ¨é€™è£¡ -->
                                </div>
                            </div>
                        </div>
                    </div>



                    <h3 class="text-xl font-bold text-white mb-4">å»ºç«‹æ–°æ©Ÿå°</h3>
                    <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-6">
                        <div>
                            <label for="new-machine-id" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå°ç·¨è™Ÿ</label>
                            <input type="text" id="new-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šA01" required>
                        </div>
                        <div>
                            <label for="new-machine-location" class="block text-sm font-medium text-gray-300 mb-1">ä½ç½®/å…§å®¹ç‰©</label>
                            <input type="text" id="new-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼šé–€å£/å¤§å¨ƒå¨ƒ" required>
                            <div id="location-presets" class="flex flex-wrap gap-2 mt-2">
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸Šå±¤ / å·¦å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸Šå±¤ / å³å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸‹å±¤ / å·¦å´</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">ä¸‹å±¤ / å³å´</span>
                            </div>
                        </div>
                         <div>
                            <label for="new-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹æŠ•å¹£æ•¸ (æ¸¬è©¦ç”¨)</label>
                            <input type="number" id="new-machine-initial-plays" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">èµ·å§‹å‡ºè²¨æ•¸ (æ¸¬è©¦ç”¨)</label>
                            <input type="number" id="new-machine-initial-payouts" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">æ©Ÿå° MAC ä½å€ (MQTT)</label>
                            <input type="text" id="new-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼š083A8DE1E8FB">
                        </div>
                        <div>
                            <label for="new-machine-devid" class="block text-sm font-medium text-gray-300 mb-1">è¨­å‚™ ID (MQTT)</label>
                            <input type="number" id="new-machine-devid" min="1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="ä¾‹å¦‚ï¼š2">
                        </div>
                        <button type="submit" class="md:col-span-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹æ©Ÿå°</button>
                    </form>
                    
                    <!-- æ©Ÿå°æ ¡æ­£åŠŸèƒ½èªªæ˜ -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-900 to-purple-900 rounded-lg border border-blue-600">
                        <h4 class="text-lg font-semibold text-white mb-2">ğŸ”§ æ©Ÿå°æ•¸å€¼æ ¡æ­£åŠŸèƒ½</h4>
                        <div class="text-sm text-gray-300 space-y-1">
                            <p>â€¢ <strong>åŠŸèƒ½èªªæ˜</strong>ï¼šä¿®æ­£é›»å­å…§è¡¨èˆ‡æ©Ÿæ¢°ç¢¼è¡¨çš„å‡ºå» å‰æ•¸å€¼å·®ç•°</p>
                            <p>â€¢ <strong>æŠ•å¹£æ ¡æ­£</strong>ï¼šè¼ªè©¢å¾—åˆ°çš„æŠ•å¹£æ•¸ + æ ¡æ­£å€¼ = å¯¦éš›å¡«è¡¨æ•¸å€¼</p>
                            <p>â€¢ <strong>å‡ºè²¨æ ¡æ­£</strong>ï¼šè¼ªè©¢å¾—åˆ°çš„å‡ºè²¨æ•¸ + æ ¡æ­£å€¼ = å¯¦éš›å¡«è¡¨æ•¸å€¼</p>
                            <p>â€¢ <strong>ä½¿ç”¨æ–¹å¼</strong>ï¼šåœ¨ä¸‹æ–¹è¡¨æ ¼çš„æ ¡æ­£æ¬„ä½ç›´æ¥è¼¸å…¥æ­£æ•¸ï¼ˆåŠ å€¼ï¼‰æˆ–è² æ•¸ï¼ˆæ¸›å€¼ï¼‰ï¼Œç³»çµ±æœƒè‡ªå‹•ä¿å­˜ä¸¦æ‡‰ç”¨æ–¼æ‰€æœ‰è¼ªè©¢è³‡æ–™</p>
                            <p>â€¢ <strong>é¡¯ç¤ºæ¨™è¨˜</strong>ï¼šè¼ªè©¢è¡¨æ ¼ä¸­æœ‰ ğŸ“Š åœ–ç¤ºè¡¨ç¤ºè©²æ•¸å€¼å·²æ‡‰ç”¨æ ¡æ­£</p>
                            <p>â€¢ <strong>ğŸš€ æ–°åŠŸèƒ½</strong>ï¼šå‹¾é¸ã€Œé€²å…¥é–€å¸‚å¾Œè‡ªå‹•è¼ªè©¢å…©æ¬¡ã€å¯åœ¨æ¯æ¬¡é–‹å•Ÿé–€å¸‚é é¢æ™‚ç«‹å³åŸ·è¡Œç¬¬ä¸€æ¬¡ç›´æ¥è®€å–ï¼ˆä¸ç™¼é€è¨Šæ¯ï¼‰ï¼Œå®Œæˆå¾Œç­‰å¾…1ç§’å†åŸ·è¡Œç¬¬äºŒæ¬¡ç›´æ¥è®€å–</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4 mt-4">
                         <h3 class="text-xl font-bold text-white">ç¾æœ‰æ©Ÿå°åˆ—è¡¨</h3>
                         <button id="recalculate-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.082.541a5.002 5.002 0 00-8.736-1.613L8 8H4V4l2.293 2.293A6.996 6.996 0 0111 3.055a6.996 6.996 0 015.688 3.568l1.082-.54A8.996 8.996 0 0012.22 2.022 8.996 8.996 0 004 5.101V3a1 1 0 01-1-1H2a1 1 0 01-1-1V1a1 1 0 011-1h2zm12 16a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.899-2.186l1.082-.541a5.002 5.002 0 008.736 1.613L12 12h4v4l-2.293-2.293A6.996 6.996 0 019 16.945a6.996 6.996 0 01-5.688-3.568l-1.082.54A8.996 8.996 0 007.78 17.978 8.996 8.996 0 0016 14.899V17a1 1 0 011 1h1a1 1 0 011 1v1a1 1 0 01-1 1h-2z" clip-rule="evenodd" />
                            </svg>
                            <span>é‡æ–°è¨ˆç®—æ‰€æœ‰æ•¸æ“š</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                    <th class="p-4">ä½ç½®</th>
                                    <th class="p-4">MAC ä½å€</th>
                                    <th class="p-4">è¨­å‚™ID</th>
                                    <th class="p-4 text-right">èµ·å§‹æŠ•å¹£</th>
                                    <th class="p-4 text-right">èµ·å§‹å‡ºè²¨</th>
                                    <th class="p-4 text-center" style="background-color: #2d3748;">æŠ•å¹£æ ¡æ­£</th>
                                    <th class="p-4 text-center" style="background-color: #2d3748;">å‡ºè²¨æ ¡æ­£</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="machine-list-table-body" class="divide-y divide-gray-700">
                                <!-- æ©Ÿå°åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- æ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿ -->
                    <div id="machine-detail-panel" class="hidden mt-6 bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">æ©Ÿå°è©³ç´°è³‡æ–™</h3>
                            <button id="close-detail-panel" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- é›»å£“è³‡æ–™ -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-blue-400 mb-3">é›»å£“è³‡æ–™</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">å¼·é›»å£“:</span>
                                        <span id="detail-strong-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ä¸­é›»å£“:</span>
                                        <span id="detail-medium-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">å¼±é›»å£“:</span>
                                        <span id="detail-weak-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ä¸­å£“è·é›¢é ‚é»é«˜åº¦:</span>
                                        <span id="detail-height-to-top" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ä¿å¤¾å¼·é›»å£“:</span>
                                        <span id="detail-clamp-voltage" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç‡Ÿé‹è³‡æ–™ -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-green-400 mb-3">ç‡Ÿé‹è³‡æ–™</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ä¸­çç‡éŠ€è¡Œ:</span>
                                        <span id="detail-win-rate-bank" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">æŠ•å¹£éŠæˆ²æ¬¡æ•¸:</span>
                                        <span id="detail-coin-game-count" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ç¦®å“å‡ºçæ¬¡æ•¸:</span>
                                        <span id="detail-prize-count" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç´¯åŠ é‡‘é¡è³‡æ–™ -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-yellow-400 mb-3">ç´¯åŠ é‡‘é¡</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ç¬¬1ç­†:</span>
                                        <span id="detail-amount-1" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ç¬¬2ç­†:</span>
                                        <span id="detail-amount-2" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">ç¬¬3ç­†:</span>
                                        <span id="detail-amount-3" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åŸºæœ¬è³‡æ–™ -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2 lg:col-span-1">
                                <h4 class="text-lg font-semibold text-purple-400 mb-3">åŸºæœ¬è³‡æ–™</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">æ©Ÿå°ç·¨è™Ÿ:</span>
                                        <span id="detail-machine-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">MACä½å€:</span>
                                        <span id="detail-mac-address" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">è¨­å‚™ID:</span>
                                        <span id="detail-device-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">æœ€å¾Œæ›´æ–°:</span>
                                        <span id="detail-last-update" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åŸå§‹è³‡æ–™ -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2">
                                <h4 class="text-lg font-semibold text-red-400 mb-3">åŸå§‹ Hex è³‡æ–™</h4>
                                <div class="bg-gray-900 rounded p-3 font-mono text-xs text-green-400 break-all">
                                    <span id="detail-raw-hex">ç„¡è³‡æ–™</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                    <!-- åœ–è¡¨çµ±è¨ˆç¯„åœé¸æ“‡ -->
                    <div class="flex justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">åœ–è¡¨çµ±è¨ˆç¯„åœï¼š</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="chart-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    ğŸ“Š ç•¶æœŸç´€éŒ„
                                </button>
                                <button type="button" class="chart-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    ğŸ“ˆ å…¨éƒ¨æ­·å²
                                </button>
                            </div>
                        </div>
                    </div>
                    
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°ç¸½ç‡Ÿæ”¶æ¯”è¼ƒ</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°å¹³å‡å‡ºè²¨æˆæœ¬</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">å–®æ—¥å„æ©Ÿå°è¡¨ç¾</h3>
                        <div class="flex items-center gap-4 mb-4">
                            <label for="trend-chart-date-picker" class="text-gray-300 shrink-0">é¸æ“‡æ—¥æœŸï¼š</label>
                            <input type="date" id="trend-chart-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 w-full sm:w-auto">
                        </div>
                        <div id="trend-chart-content" class="w-full"></div>
                    </div>
                </div>
                <div id="statistics" class="tab-content hidden">
                    <!-- çµ±è¨ˆç¯„åœé¸æ“‡ (å·²éš±è—) -->
                    <div class="hidden flex-col sm:flex-row justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg gap-4">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">çµ±è¨ˆç¯„åœï¼š</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="stats-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    ğŸ“Š ç•¶æœŸç´€éŒ„
                                </button>
                                <button type="button" class="stats-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    ğŸ“ˆ å…¨éƒ¨æ­·å²
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="refresh-all-stats-btn" class="py-2 px-4 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                ğŸ”„ é‡æ–°çµ±è¨ˆå…¨éƒ¨
                            </button>
                        </div>
                    </div>
                    
                     <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">æ¯æ—¥</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æ¯é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æ¯æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æ¯å­£</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">æœŸé–“</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                    <th class="p-4 text-right">ç¸½å‡ºè²¨æ¬¡æ•¸</th>
                                    <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾æ©Ÿå°ç·¨è™Ÿæœå°‹...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable sorted" data-sort="id">æ©Ÿå°ç·¨è™Ÿ <span class="sort-indicator">â–²</span></th>
                                    <th class="p-4 table-header-sortable" data-sort="location">ä½ç½® <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePlays">ç‡Ÿæ¥­æŠ•å¹£æ¬¡æ•¸ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">ç‡Ÿæ¥­æŠ•å¹£é‡‘é¡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePayouts">ç‡Ÿæ¥­å‡ºè²¨æ•¸é‡ <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">å¹³å‡å‡ºè²¨æˆæœ¬ <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="summary-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">ç¸½è¨ˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æœ¬é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æœ¬æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æœ¬å­£</button>
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-r-md border border-blue-600 hover:bg-blue-700 hover:text-white" data-period="current">ç•¶æœŸ</button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">æ©Ÿå°ç·¨è™Ÿ</th>
                                        <th class="p-4 text-right">ç¸½æŠ•å¹£é‡‘é¡</th>
                                        <th class="p-4 text-right">ç¸½å‡ºè²¨æ•¸é‡</th>
                                        <th class="p-4 text-right">å¹³å‡å‡ºè²¨æˆæœ¬</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">å„æ©Ÿå°æŠ•å¹£é‡‘é¡ä½”æ¯”</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>ğŸ“ˆ PSDï¼ˆæ¯æ—¥å¹³å‡éŠ·å”®è¡¨ç¾ï¼‰</h3>
                     <div class="flex flex-wrap justify-center items-center mb-4 bg-gray-900/50 p-2 rounded-lg gap-2">
                        <div id="psd-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">ç¸½è¨ˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">æœ¬é€±</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">æœ¬æœˆ</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">æœ¬å­£</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="custom">è‡ªè¨‚å€é–“</button>
                        </div>
                         <div id="psd-custom-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="psd-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <span class="text-gray-400">è‡³</span>
                            <input type="date" id="psd-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <button id="psd-calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">è¨ˆç®—</button>
                            <button id="psd-weekly-trend-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                                </svg>
                                å‘¨å ±æ¯”è¼ƒ
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>è¨ˆç®—ä¸­...</strong></p>
                    </div>
                    <h3 class="mt-8">ğŸ”¬ åˆ†æèˆ‡è§€å¯Ÿ</h3>
                    <div id="analysis-observation" class="space-y-6"></div>
                    <h3 class="mt-8">ğŸ’¡ çµè«–å»ºè­°</h3>
                    <div id="analysis-suggestion" class="space-y-4"></div>
                </div>
                
                <!-- ç›ˆåˆ©è¨ˆç®—é é¢ -->
                <div id="profit" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-6">ğŸ’° ç›ˆåˆ©è¨ˆç®—å™¨</h3>
                    
                    <!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-blue-100 mb-2">ğŸ“Š ç‡Ÿæ¥­è³‡è¨Š</h4>
                            <div class="text-2xl font-bold text-white" id="profit-revenue">0 å…ƒ</div>
                            <div class="text-sm text-blue-100 mt-1">ç¸½ç‡Ÿæ¥­é¡</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-green-100 mb-2">ğŸ å‡ºè²¨çµ±è¨ˆ</h4>
                            <div class="text-2xl font-bold text-white" id="profit-payouts">0 æ¬¡</div>
                            <div class="text-sm text-green-100 mt-1">ç¸½å‡ºè²¨æ¬¡æ•¸</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-purple-100 mb-2">ğŸ’µ æ·¨åˆ©æ½¤</h4>
                            <div class="text-2xl font-bold text-white" id="profit-net">0 å…ƒ</div>
                            <div class="text-sm text-purple-100 mt-1">æ‰£é™¤æˆæœ¬å¾Œ</div>
                        </div>
                    </div>
                    
                    <!-- æˆæœ¬è¨­å®šå€åŸŸ -->
                    <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                        <h4 class="text-lg font-semibold text-white mb-4">ğŸ”§ æˆæœ¬è¨­å®šèˆ‡è¨ˆç®—ç¯„åœ</h4>
                        
                        <!-- è¨ˆç®—ç¯„åœé¸æ“‡ -->
                        <div class="mb-6 p-4 bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-300 mb-3">ğŸ“Š è¨ˆç®—ç¯„åœé¸æ“‡</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="total" checked 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">ğŸ“ˆ ç¸½ç´¯ç©è¨ˆç®—</span>
                                        <p class="text-gray-400 text-sm">è¨ˆç®—å¾ç‡Ÿæ¥­é–‹å§‹è‡³ä»Šçš„ç¸½ç›ˆåˆ©</p>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="pending" 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">ğŸ’° æœ¬æœŸå¾…çµå¸³è¨ˆç®—</span>
                                        <p class="text-gray-400 text-sm">åƒ…è¨ˆç®—æœ¬æœŸå¾…çµå¸³é‡‘é¡çš„ç›ˆåˆ©</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ æ¯æ¬¡å‡ºè²¨ç¦®å“æˆæœ¬ (å…ƒ)</label>
                                <input type="number" id="gift-cost" value="50" min="0" step="1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ  åº—ç§Ÿæ¯”ä¾‹ (%)</label>
                                <input type="number" id="rent-percentage" value="30" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ›ï¸ ç¨…é‡‘æ¯”ä¾‹ (%)</label>
                                <input type="number" id="tax-percentage" value="5" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="calculate-profit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                ğŸ§® é‡æ–°è¨ˆç®—
                            </button>
                            <button id="save-cost-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition ml-2">
                                ğŸ’¾ å„²å­˜è¨­å®š
                            </button>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°è¨ˆç®—çµæœ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- æˆæœ¬åˆ†æ -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">ğŸ’¸ æˆæœ¬æ˜ç´°</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">ğŸ ç¦®å“æˆæœ¬</span>
                                    <span class="text-white font-semibold" id="total-gift-cost">0 å…ƒ</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">ğŸ  åº—ç§Ÿè²»ç”¨</span>
                                    <span class="text-white font-semibold" id="total-rent-cost">0 å…ƒ</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">ğŸ›ï¸ ç¨…é‡‘è²»ç”¨</span>
                                    <span class="text-white font-semibold" id="total-tax-cost">0 å…ƒ</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-red-500">
                                    <span class="text-red-300 font-semibold">ğŸ’° ç¸½æˆæœ¬</span>
                                    <span class="text-red-300 font-bold text-lg" id="total-cost">0 å…ƒ</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç›ˆåˆ©åˆ†æ -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">ğŸ“ˆ ç›ˆåˆ©åˆ†æ</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">ğŸ“Š ç¸½ç‡Ÿæ¥­é¡</span>
                                    <span class="text-green-400 font-semibold" id="profit-total-revenue">0 å…ƒ</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">ğŸ’¸ ç¸½æˆæœ¬</span>
                                    <span class="text-red-400 font-semibold" id="profit-total-cost">0 å…ƒ</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-green-500">
                                    <span class="text-green-300 font-semibold">ğŸ’µ æ·¨åˆ©æ½¤</span>
                                    <span class="text-green-300 font-bold text-xl" id="net-profit">0 å…ƒ</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-300">ğŸ“Š åˆ©æ½¤ç‡</span>
                                        <span class="font-semibold" id="profit-margin">0%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-300">ğŸ’° æ¯æ¬¡å‡ºè²¨æ·¨åˆ©</span>
                                        <span class="font-semibold" id="profit-per-payout">0 å…ƒ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div id="checkout" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">æœ¬æœŸç‡Ÿæ”¶çµå¸³</h3>
                    <div class="bg-gray-900/50 p-6 rounded-lg mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-400">ä¸Šæ¬¡çµå¸³æ—¥æœŸï¼š<span id="last-checkout-date" class="font-semibold">ç„¡</span></p>
                            <p class="text-lg text-white mt-1">æœ¬æœŸå¾…çµå¸³é‡‘é¡ï¼š<span id="pending-checkout-amount" class="text-2xl font-bold text-green-400">0 å…ƒ</span></p>
                        </div>
                        <div class="flex gap-2">
                           <button id="download-checkout-csv-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">ä¸‹è¼‰çµå¸³å ±è¡¨ (CSV)</button>
                           <button id="perform-checkout-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">åŸ·è¡Œçµå¸³</button>
                        </div>
                    </div>
                    
                    <!-- çµå¸³è¶¨å‹¢åœ–è¡¨ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                çµå¸³é‡‘é¡è¶¨å‹¢
                            </h4>
                            <div id="checkout-amount-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                            </div>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                ç´¯ç©ç‡Ÿæ”¶è¶¨å‹¢
                            </h4>
                            <div id="checkout-cumulative-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çµå¸³çµ±è¨ˆæ‘˜è¦ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-blue-400 text-sm">ç¸½çµå¸³æ¬¡æ•¸</p>
                            <p id="total-checkouts" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-green-400 text-sm">å¹³å‡çµå¸³é‡‘é¡</p>
                            <p id="avg-checkout-amount" class="text-2xl font-bold text-white">0 å…ƒ</p>
                        </div>
                        <div class="bg-purple-900/30 p-4 rounded-lg text-center">
                            <p class="text-purple-400 text-sm">æœ€é«˜å–®æ¬¡çµå¸³</p>
                            <p id="max-checkout-amount" class="text-2xl font-bold text-white">0 å…ƒ</p>
                        </div>
                        <div class="bg-orange-900/30 p-4 rounded-lg text-center">
                            <p class="text-orange-400 text-sm">ç´¯è¨ˆç›ˆåˆ©</p>
                            <p id="total-profit-summary" class="text-2xl font-bold text-white">0 å…ƒ</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-4 mt-8">çµå¸³æ­·å²ç´€éŒ„</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-3 text-xs">çµå¸³æ—¥æœŸ</th>
                                    <th class="p-3 text-right text-xs">ç•¶æœŸç‡Ÿæ”¶</th>
                                    <th class="p-3 text-right text-xs">ç•¶æœŸå‡ºè²¨</th>
                                    <th class="p-3 text-right text-xs">ç•¶æœŸç›ˆåˆ©</th>
                                    <th class="p-3 text-right text-xs">ç´¯ç©ç¸½ç‡Ÿæ”¶</th>
                                    <th class="p-3 text-right text-xs">ç›ˆåˆ©è¨ˆç®—</th>
                                    <th class="p-3 text-right text-xs">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="checkout-history-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">å ±è¡¨å»ºç«‹æ—¥æœŸï¼š</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="modal-message" class="text-gray-300 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Edit Store Modal -->
    <div id="edit-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">ç·¨è¼¯é–€å¸‚è³‡è¨Š</h3>
            <form id="edit-store-form">
                <input type="hidden" id="edit-store-id">
                 <div class="mb-4">
                    <label for="edit-store-name" class="block text-sm font-medium text-gray-300 mb-1">é–€å¸‚åç¨±</label>
                    <input type="text" id="edit-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6">
                    <label for="edit-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">ç‡Ÿæ¥­èµ·å§‹æ—¥</label>
                    <input type="date" id="edit-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clone Store Modal -->
    <div id="clone-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">è¤‡è£½é–€å¸‚</h3>
            <form id="clone-store-form">
                <input type="hidden" id="clone-source-store-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¾†æºé–€å¸‚</label>
                    <div class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        <span id="clone-source-store-name" class="font-semibold"></span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="clone-store-name" class="block text-sm font-medium text-gray-300 mb-1">æ–°é–€å¸‚åç¨±</label>
                    <input type="text" id="clone-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required placeholder="è«‹è¼¸å…¥æ–°é–€å¸‚åç¨±">
                </div>
                <div class="mb-6">
                    <label for="clone-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">ç‡Ÿæ¥­èµ·å§‹æ—¥</label>
                    <input type="date" id="clone-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6 p-4 bg-blue-900/30 border border-blue-500/50 rounded-lg">
                    <h4 class="text-sm font-semibold text-blue-300 mb-2">è¤‡è£½èªªæ˜</h4>
                    <ul class="text-sm text-blue-200 space-y-1">
                        <li>â€¢ è¤‡è£½æ©Ÿå°é…ç½®å’Œä½ç½®è¨­å®š</li>
                        <li>â€¢ è¤‡è£½æ©Ÿå°çš„ MAC åœ°å€å’Œè¨­å‚™ ID</li>
                        <li>â€¢ <strong class="text-yellow-300">æ¸…é™¤æ‰€æœ‰å¸³å‹™è¨˜éŒ„å’Œæ­·å²è³‡æ–™</strong></li>
                        <li>â€¢ æ©Ÿå°æ•¸æ“šé‡ç½®ç‚º 0ï¼ˆé©åˆæ–°é–€å¸‚ï¼‰</li>
                    </ul>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="clone-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">é–‹å§‹è¤‡è£½</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="edit-history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">ä¿®æ”¹è¨˜å¸³ç´€éŒ„</h3>
            <form id="edit-history-form">
                <input type="hidden" id="edit-history-doc-id">
                <input type="hidden" id="edit-history-machine-id">
                <input type="hidden" id="edit-history-location">
                <input type="hidden" id="edit-history-old-plays">
                <input type="hidden" id="edit-history-old-payouts">
                <div class="mb-4">
                    <label for="edit-history-date" class="block text-sm font-medium text-gray-300 mb-1">ç´€éŒ„æ—¥æœŸ</label>
                    <input type="date" id="edit-history-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-4">
                    <label for="edit-history-plays" class="block text-sm font-medium text-gray-300 mb-1">ç•¶æ—¥æŠ•å¹£æ•¸</label>
                    <input type="number" id="edit-history-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="mb-6">
                    <label for="edit-history-payouts" class="block text-sm font-medium text-gray-300 mb-1">ç•¶æ—¥å‡ºè²¨æ•¸</label>
                    <input type="number" id="edit-history-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-history-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Machine Modal - Enhanced -->
    <div id="edit-machine-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto edit-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">ä¿®æ”¹æ©Ÿå°è³‡è¨Š</h3>
                <button id="edit-machine-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            
            <form id="edit-machine-form">
                <input type="hidden" id="edit-machine-doc-id">
                
                <!-- åŸºæœ¬è³‡è¨Š -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">ğŸ“‹ åŸºæœ¬è³‡è¨Š</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="edit-machine-id" class="block text-sm font-medium text-gray-300 mb-2">æ©Ÿå°ç·¨è™Ÿ</label>
                            <input type="text" id="edit-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-machine-location" class="block text-sm font-medium text-gray-300 mb-2">ä½ç½®/å…§å®¹ç‰©</label>
                            <input type="text" id="edit-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-machine-mac" class="block text-sm font-medium text-gray-300 mb-2">MAC ä½å€</label>
                            <input type="text" id="edit-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 font-mono focus:ring-2 focus:ring-blue-500" placeholder="083A8DE1ED14">
                        </div>
                        <div>
                            <label for="edit-machine-devid" class="block text-sm font-medium text-gray-300 mb-2">è¨­å‚™ID</label>
                            <input type="number" id="edit-machine-devid" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" min="1" max="9" value="1">
                        </div>
                        <div>
                            <label for="edit-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-2">èµ·å§‹æŠ•å¹£æ•¸</label>
                            <input type="number" id="edit-machine-initial-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                        <div>
                            <label for="edit-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-2">èµ·å§‹å‡ºè²¨æ•¸</label>
                            <input type="number" id="edit-machine-initial-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                    </div>
                </div>
                
                <!-- æ ¡æ­£å€¼è¨­å®šå€å¡Š -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-green-400 mb-4">ğŸ”§ æ•¸å€¼æ ¡æ­£è¨­å®š</h4>
                    <p class="text-sm text-gray-400 mb-4">ç”¨æ–¼ä¿®æ­£é›»å­å…§è¡¨èˆ‡æ©Ÿæ¢°ç¢¼è¡¨çš„å·®ç•°ï¼Œæ­£æ•¸ç‚ºåŠ å€¼ï¼Œè² æ•¸ç‚ºæ¸›å€¼</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="edit-machine-plays-calibration" class="block text-sm font-medium text-gray-300 mb-2">æŠ•å¹£æ ¡æ­£å€¼</label>
                            <input type="number" id="edit-machine-plays-calibration" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-green-500" placeholder="0">
                            <small class="text-gray-500 block mt-1">ä¾‹ï¼šé›»å­è¡¨100ï¼Œå¯¦éš›è¡¨98ï¼Œè¼¸å…¥-2</small>
                        </div>
                        <div>
                            <label for="edit-machine-payouts-calibration" class="block text-sm font-medium text-gray-300 mb-2">å‡ºè²¨æ ¡æ­£å€¼</label>
                            <input type="number" id="edit-machine-payouts-calibration" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-green-500" placeholder="0">
                            <small class="text-gray-500 block mt-1">ä¾‹ï¼šé›»å­è¡¨50ï¼Œå¯¦éš›è¡¨52ï¼Œè¼¸å…¥+2</small>
                        </div>
                    </div>
                </div>

                <!-- ç•¶å‰æ•¸æ“šé¡¯ç¤º -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">ğŸ“Š ç•¶å‰æ•¸æ“š</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400" id="edit-current-plays">--</div>
                            <div class="text-sm text-gray-400">ç•¶å‰æŠ•å¹£æ•¸</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400" id="edit-current-payouts">--</div>
                            <div class="text-sm text-gray-400">ç•¶å‰å‡ºè²¨æ•¸</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="edit-current-cost">--</div>
                            <div class="text-sm text-gray-400">å¹³å‡æˆæœ¬</div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-machine-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">ç¢ºèªä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Report Download Modal -->
    <div id="custom-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">è‡ªå®šç¾©å ±è¡¨å…§å®¹</h3>
            
            <!-- å ±è¡¨é¡å‹é¸æ“‡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">é¸æ“‡å ±è¡¨é¡å‹</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ“Š ç‡Ÿæ¥­æ‘˜è¦çµ±è¨ˆ</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-details" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ“‹ æ©Ÿå°è©³ç´°è³‡æ–™</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-operation-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“Š ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-history" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“ è¨˜å¸³æ­·å²ç´€éŒ„</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-analysis" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“ˆ ç‡Ÿé‹åˆ†ææ•¸æ“š</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-checkout" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ’° çµå¸³ç´€éŒ„</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-profit" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ§® ç›ˆåˆ©è¨ˆç®—</span>
                    </label>
                </div>
            </div>
            
            <!-- å ±è¡¨æ ¼å¼é¸æ“‡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">é¸æ“‡æª”æ¡ˆæ ¼å¼</h4>
                <div class="flex gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="csv" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ“„ CSV æ ¼å¼</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="pdf" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“‘ PDF æ ¼å¼</span>
                    </label>
                </div>
            </div>
            
            <!-- å¿«é€Ÿé¸æ“‡æŒ‰éˆ• -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">å¿«é€Ÿé¸æ“‡</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">å…¨é¸</button>
                    <button type="button" id="select-basic-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">åŸºæœ¬å ±è¡¨</button>
                    <button type="button" id="select-detailed-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">è©³ç´°å ±è¡¨</button>
                    <button type="button" id="clear-all-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">æ¸…ç©º</button>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button type="button" id="custom-report-download" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>ä¸‹è¼‰å ±è¡¨</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Store Report Modal -->
    <div id="custom-store-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">è‡ªå®šç¾©é–€å¸‚å ±è¡¨å…§å®¹</h3>
            
            <!-- é–€å¸‚é¸æ“‡æç¤º -->
            <div class="mb-4 p-3 bg-blue-900/50 rounded-lg">
                <p class="text-blue-300 text-sm">è«‹å…ˆåœ¨é–€å¸‚åˆ—è¡¨ä¸­å‹¾é¸è¦åŒ…å«åœ¨å ±è¡¨ä¸­çš„é–€å¸‚</p>
            </div>
            
            <!-- å ±è¡¨å…§å®¹é¸æ“‡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">é¸æ“‡å ±è¡¨å…§å®¹</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ“Š é–€å¸‚ç‡Ÿæ¥­æ‘˜è¦</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ° å„é–€å¸‚æ©Ÿå°æ˜ç´°</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-performance" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“ˆ é–€å¸‚ç¸¾æ•ˆæ¯”è¼ƒ</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-top-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ† å„é–€å¸‚å„ªç¸¾æ©Ÿå°</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-period-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“… æœŸé–“ç‡Ÿé‹çµ±è¨ˆ</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-profit" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ§® ç›ˆåˆ©è¨ˆç®—åˆ†æ</span>
                    </label>
                </div>
            </div>
            
            <!-- å ±è¡¨æœŸé–“é¸æ“‡ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">å ±è¡¨æœŸé–“</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="all" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">å…¨éƒ¨æœŸé–“</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="daily" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">å–®æ—¥</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="weekly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">é€±å ±</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="monthly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">æœˆå ±</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="quarterly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">å­£å ±</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="yearly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">å¹´å ±</span>
                    </label>
                </div>
                <div class="mt-2">
                    <input type="date" id="store-report-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full" title="å ±è¡¨åŸºæº–æ—¥æœŸ">
                </div>
            </div>
            
            <!-- é–€å¸‚æ’åºæ–¹å¼ -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">é–€å¸‚æ’åºæ–¹å¼</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="revenue-desc" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">ğŸ“Š ç‡Ÿæ¥­é¡é«˜åˆ°ä½</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="revenue-asc" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ“‰ ç‡Ÿæ¥­é¡ä½åˆ°é«˜</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="name" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">ğŸ”¤ ä¾é–€å¸‚åç¨±</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="custom" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">âœ‹ è‡ªè¨‚é †åº (å‹¾é¸é–€å¸‚å¾Œå¯æ‹–æ›³)</span>
                    </label>
                </div>
            </div>
            
            <!-- å¿«é€Ÿé¸æ“‡æŒ‰éˆ• -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">å¿«é€Ÿé¸æ“‡</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-store-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">å…¨é¸</button>
                    <button type="button" id="select-basic-store-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">åŸºæœ¬å ±è¡¨</button>
                    <button type="button" id="select-detailed-store-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">è©³ç´°å ±è¡¨</button>
                    <button type="button" id="clear-all-store-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">æ¸…ç©º</button>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-store-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
                <button type="button" id="custom-store-report-download" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>ä¸‹è¼‰é–€å¸‚å ±è¡¨</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç›ˆåˆ©è©³æƒ…æŸ¥çœ‹æ¨¡æ…‹è¦–çª— -->
    <div id="profit-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">ğŸ§® çµå¸³æœŸé–“ç›ˆåˆ©è©³æƒ…</h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ç‡Ÿæ¥­æ•¸æ“š -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ“Š ç‡Ÿæ¥­æ•¸æ“š</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">çµå¸³æ—¥æœŸ</span>
                            <span class="text-white font-semibold" id="detail-checkout-date">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç•¶æœŸç‡Ÿæ”¶</span>
                            <span class="text-green-400 font-semibold" id="detail-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç•¶æœŸå‡ºè²¨</span>
                            <span class="text-blue-400 font-semibold" id="detail-payouts">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- æˆæœ¬è¨­å®š -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ”§ æˆæœ¬è¨­å®š</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç¦®å“æˆæœ¬</span>
                            <span class="text-white font-semibold" id="detail-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">åº—ç§Ÿæ¯”ä¾‹</span>
                            <span class="text-white font-semibold" id="detail-rent-percentage">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç¨…é‡‘æ¯”ä¾‹</span>
                            <span class="text-white font-semibold" id="detail-tax-percentage">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- æˆæœ¬æ˜ç´° -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ’¸ æˆæœ¬æ˜ç´°</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç¦®å“æˆæœ¬</span>
                            <span class="text-red-400 font-semibold" id="detail-total-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">åº—ç§Ÿè²»ç”¨</span>
                            <span class="text-red-400 font-semibold" id="detail-total-rent-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç¨…é‡‘è²»ç”¨</span>
                            <span class="text-red-400 font-semibold" id="detail-total-tax-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-red-300 font-semibold">ç¸½æˆæœ¬</span>
                            <span class="text-red-300 font-bold" id="detail-total-cost">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- ç›ˆåˆ©åˆ†æ -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ“ˆ ç›ˆåˆ©åˆ†æ</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">ç‡Ÿæ”¶</span>
                            <span class="text-green-400 font-semibold" id="detail-profit-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">æˆæœ¬</span>
                            <span class="text-red-400 font-semibold" id="detail-profit-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-white font-semibold">æ·¨åˆ©æ½¤</span>
                            <span class="font-bold text-lg" id="detail-net-profit">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">åˆ©æ½¤ç‡</span>
                            <span class="font-semibold" id="detail-profit-margin">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="close-profit-detail" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Loader Overlay -->
    <div id="pdf-loader-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center hidden z-50">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="pdf-loader-text-overlay" class="text-white text-lg mt-4">æ­£åœ¨ç”Ÿæˆ PDF...</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="admin-config.js"></script>
    <script src="login.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! è«‹å°‡é€™è£¡çš„è¨­å®šæ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé‡‘é‘° !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // åˆå§‹åŒ–ç®¡ç†å“¡é…ç½®ç³»çµ±
        if (window.initAdminConfig) {
            window.initAdminConfig(db);
        }
        // --- END: Firebase Initialization ---

        // åµæ¸¬ HTTPS ä¸¦é¡¯ç¤ºè­¦å‘Š
        if (window.location.protocol === 'https:') {
            const httpsWarning = document.getElementById('https-warning');
            if (httpsWarning) {
                httpsWarning.classList.remove('hidden');
                console.warn('âš ï¸ é é¢ä½¿ç”¨ HTTPSï¼ŒWebSocket é€£ç·šå°‡è‡ªå‹•å¾ ws:// è½‰æ›ç‚º wss://');
            }
            
            // å¢å¼·çš„ HTTPS ç’°å¢ƒæª¢æ¸¬
            const isGitHubPages = window.location.hostname.includes('github.io');
            console.log('ğŸ”’ HTTPS ç’°å¢ƒæª¢æ¸¬çµæœ:');
            console.log(`   éƒ¨ç½²å¹³å°: ${isGitHubPages ? 'GitHub Pages' : 'å…¶ä»– HTTPS æœå‹™'}`);
            console.log(`   ç›®æ¨™ä¼ºæœå™¨: http://update.feiloli.com.tw:5539`);
            console.log(`   è‡ªå‹•ä½¿ç”¨ CORS ä»£ç†è®€å–æ•¸æ“š`);
            console.log(`   è®€å–æŒ‡ä»¤åŠŸèƒ½å—é™ (åƒ…é™ HTTP ç’°å¢ƒ)`);
            
            // é¡¯ç¤ºåœ¨ UI ä¸Šçš„æç¤ºï¼ˆå¯é¸ï¼‰
            setTimeout(() => {
                const pollAllBtn = document.getElementById('poll-all-btn');
                if (pollAllBtn) {
                    const badge = document.createElement('span');
                    badge.className = 'absolute top-0 right-0 bg-yellow-500 text-xs px-2 py-0.5 rounded-full';
                    badge.textContent = 'HTTPS æ¨¡å¼';
                    badge.title = 'åœ¨ HTTPS ç’°å¢ƒä¸‹ï¼Œéƒ¨åˆ† HTTP æŒ‡ä»¤åŠŸèƒ½å¯èƒ½å—é™';
                    pollAllBtn.parentElement.style.position = 'relative';
                    pollAllBtn.parentElement.appendChild(badge);
                }
            }, 500);
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œé¡¯ç¤º HTTP é…ç½®è³‡è¨Š
        console.log('ğŸŒ HTTP GET é…ç½®å·²è¼‰å…¥');
        console.log('ğŸ“¡ ä¼ºæœå™¨ä½å€:', 'http://update.feiloli.com.tw:5539');
        console.log('ğŸ”— API ç«¯é»:', '/textselectdata/{mac}');
        console.log('ğŸ“‹ ç¯„ä¾‹ URL:', 'http://update.feiloli.com.tw:5539/textselectdata/083A8DE1ED14');

        // ğŸš€ åˆå§‹åŒ–è‡ªå‹•è¼ªè©¢äº‹ä»¶ç›£è½å™¨
        setTimeout(() => {
            const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
            if (autoPollOnLoadCheckbox && !autoPollOnLoadCheckbox._initialized) {
                console.log('ğŸ”§ å¼·åˆ¶åˆå§‹åŒ–è‡ªå‹•è¼ªè©¢äº‹ä»¶ç›£è½å™¨');
                autoPollOnLoadCheckbox._initialized = true;
                
                autoPollOnLoadCheckbox.addEventListener('change', (e) => {
                    console.log(`ğŸš€ è‡ªå‹•è¼ªè©¢è¨­å®šè®Šæ›´: ${e.target.checked}`);
                    if (selectedGroupId && selectedStoreId) {
                        setAutoPollOnLoadSetting(e.target.checked);
                        
                        if (e.target.checked) {
                            console.log('âœ… å·²å•Ÿç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
                            // é¡¯ç¤ºæç¤º
                            const notification = document.createElement('div');
                            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                            notification.innerHTML = 'âœ… å·²å•Ÿç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢';
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 2000);
                        } else {
                            console.log('âŒ å·²åœç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
                        }
                    }
                });
            }
        }, 1000);

        // ğŸ”§ é–‹ç™¼è€…æ¨¡å¼åˆå§‹åŒ–
        setTimeout(() => {
            initDeveloperMode();
        }, 1500);

        // --- HTTP GET è¼ªè©¢é…ç½® ---
        let httpPollingEnabled = true;
        let httpPollingTimer = null;
        let httpPollingInterval = 5000; // é è¨­ 5 ç§’è¼ªè©¢ä¸€æ¬¡
        let httpLastRequestTime = 0;
        let httpRequestCount = 0;
        let httpErrorCount = 0;
        let httpLastResponse = null;
        let corsQuietMode = true; // âœ… å•Ÿç”¨ CORS éœé»˜æ¨¡å¼ - éŒ¯èª¤åªè¨˜éŒ„åˆ°æ§åˆ¶å°ï¼Œä¸é¡¯ç¤ºè­¦å‘Šæ¡†
        
        // æ¸¬è©¦æ¨¡å¼è¨­å®šï¼ˆç”¨æ–¼ CORS å•é¡Œèª¿è©¦ï¼‰
        const isTestMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // HTTP GET ä¼ºæœå™¨é…ç½®
        const httpConfig = {
            // æ ¹æ“šæ˜¯å¦ç‚ºæ¸¬è©¦æ¨¡å¼åˆ‡æ›æœå‹™å™¨
            baseUrl: isTestMode 
                ? 'http://localhost:8080'  // æœ¬åœ°ä»£ç†ä¼ºæœå™¨
                : 'http://update.feiloli.com.tw:5539',  // æ­£å¼ä¼ºæœå™¨
            endpoint: '/textselectdata/{mac}', // {mac} å°‡è¢«å¯¦éš› MAC åœ°å€æ›¿æ›
            currentMac: '083A8DE1ED14', // é è¨­ MAC åœ°å€
            params: {},   // ä¸éœ€è¦æŸ¥è©¢åƒæ•¸ï¼ˆMAC åœ¨è·¯å¾‘ä¸­ï¼‰
            headers: {},  // ä¸éœ€è¦é¡å¤–æ¨™é ­
            timeout: 20000 // âœ… å¢åŠ åˆ° 20ç§’ (åŸæœ¬ 10ç§’)
        };

        // âœ… HTTP / HTTPS å‚³è¼¸æ¨¡å¼è¨­å®š
        const TRANSPORT_MODE_STORAGE_KEY = 'httpTransportMode';
        const TRANSPORT_MODE_CONFIGS = {
            'direct-http': {
                label: 'å…§ç¶² HTTPï¼ˆç›´æ¥é€£ç·šï¼‰',
                baseUrl: isTestMode ? 'http://localhost:8080' : 'http://update.feiloli.com.tw:5539',
                hint: 'å…§ç¶² HTTPï¼šé©åˆåœ¨åŒç¶²æ®µæˆ– HTTP ç’°å¢ƒä½¿ç”¨ï¼Œç›´æ¥é€£ç·šè¨­å‚™ã€‚'
            },
            'https-proxy': {
                label: 'HTTPSï¼ˆæ¸¬è©¦ / ä»£ç†ï¼‰',
                baseUrl: 'https://update.feiloli.com.tw:5539',
                hint: 'HTTPSï¼šé©åˆåœ¨ HTTPS ç’°å¢ƒæ¸¬è©¦ï¼Œéœ€è¨­å‚™æä¾› HTTPS æˆ–è‡ªè¡Œè¨­ç½®åå‘ä»£ç†ã€‚'
            }
        };
        let httpTransportMode = null;

        function determineDefaultTransportMode() {
            return window.location.protocol === 'https:' ? 'https-proxy' : 'direct-http';
        }

        function applyTransportMode(mode, options = {}) {
            if (!TRANSPORT_MODE_CONFIGS[mode]) {
                console.warn(`âš ï¸ æœªçŸ¥çš„å‚³è¼¸æ¨¡å¼: ${mode}ï¼Œæ”¹ç”¨é è¨­å€¼ã€‚`);
                mode = determineDefaultTransportMode();
            }

            const config = TRANSPORT_MODE_CONFIGS[mode];
            httpTransportMode = mode;
            httpConfig.baseUrl = config.baseUrl;
            localStorage.setItem(TRANSPORT_MODE_STORAGE_KEY, mode);

            const selector = document.getElementById('http-transport-mode');
            if (selector) {
                selector.value = mode;
            }

            const hint = document.getElementById('http-transport-mode-hint');
            if (hint) {
                hint.textContent = config.hint;
            }

            console.log(`ğŸš¦ HTTP å‚³è¼¸æ¨¡å¼å·²å¥—ç”¨ï¼š${config.label}`);
            console.log('ğŸ“¡ ç›®å‰ä½¿ç”¨çš„ baseUrl:', httpConfig.baseUrl);

            if (!(options && options.silent) && typeof showStatusMessage === 'function') {
                showStatusMessage(`å·²åˆ‡æ›è‡³ã€Œ${config.label}ã€`, 'info');
            }
        }

        function initTransportModeSelector() {
            const savedMode = localStorage.getItem(TRANSPORT_MODE_STORAGE_KEY);
            const defaultMode = savedMode && TRANSPORT_MODE_CONFIGS[savedMode]
                ? savedMode
                : determineDefaultTransportMode();

            applyTransportMode(defaultMode, { silent: true });

            const selector = document.getElementById('http-transport-mode');
            if (!selector) {
                return;
            }

            selector.addEventListener('change', (event) => {
                applyTransportMode(event.target.value);
            });
        }
        
        // âœ… æ–°å¢ï¼šæ•¸æ“šé©—è­‰å‡½æ•¸
        function validateMachineData(data) {
            if (!data) {
                console.warn('âš ï¸ é©—è­‰å¤±æ•—: æ•¸æ“šç‚ºç©º');
                return false;
            }
            
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²
            if (typeof data === 'string') {
                if (data.length === 0) {
                    console.warn('âš ï¸ é©—è­‰å¤±æ•—: å­—ç¬¦ä¸²ç‚ºç©º');
                    return false;
                }
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸æ“šæ ¼å¼
                if (data.includes('CMD') || data.includes('cmd') || data.match(/\d+/) ) {
                    console.log('âœ… å­—ç¬¦ä¸²æ•¸æ“šé©—è­‰é€šé');
                    return true;
                }
            }
            
            // å¦‚æœæ˜¯å°è±¡
            if (typeof data === 'object') {
                // æª¢æŸ¥æ˜¯å¦æœ‰é æœŸçš„æ¬„ä½
                if (data.plays !== undefined || data.payouts !== undefined || 
                    data.data !== undefined || Object.keys(data).length > 0) {
                    console.log('âœ… å°è±¡æ•¸æ“šé©—è­‰é€šé');
                    return true;
                }
            }
            
            console.warn('âš ï¸ é©—è­‰å¤±æ•—: ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼', data);
            return false;
        }
        
        // âœ… æ–°å¢ï¼šæ™ºèƒ½é‡è©¦å‡½æ•¸
        async function fetchWithRetry(mac, maxRetries = 3, delayMs = 1500, devid = null) {
            // ç²¾ç°¡æ¨¡å¼: åªè¨˜éŒ„é—œéµè¨Šæ¯
            const isQuickMode = maxRetries === 1 && delayMs <= 500;
            
            if (!isQuickMode) {
                console.log(`ğŸ”„ é‡è©¦è¨­å®š: æœ€å¤š ${maxRetries} æ¬¡ï¼Œé–“éš” ${delayMs}ms`);
            }
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    if (!isQuickMode && attempt > 1) {
                        console.log(`ğŸ“¤ é‡è©¦ ${attempt}/${maxRetries}...`);
                    }
                    
                    const result = await sendHttpRequest(mac, devid);
                    
                    if (result && validateMachineData(result)) {
                        if (!isQuickMode && attempt > 1) {
                            console.log(`âœ… ç¬¬ ${attempt} æ¬¡å˜—è©¦æˆåŠŸï¼`);
                        }
                        return result;
                    } else {
                        if (!isQuickMode) {
                            console.warn(`âš ï¸ ç¬¬ ${attempt} æ¬¡å˜—è©¦ç²å¾—ç„¡æ•ˆæ•¸æ“š`);
                        }
                    }
                } catch (error) {
                    if (!isQuickMode || attempt === maxRetries) {
                        console.warn(`âŒ ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—: ${error.message}`);
                    }
                }
                
                // ç­‰å¾…å¾Œé‡è©¦
                if (attempt < maxRetries) {
                    if (!isQuickMode) {
                        console.log(`â³ ç­‰å¾… ${delayMs}ms å¾Œé€²è¡Œä¸‹æ¬¡é‡è©¦...`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delayMs));
                }
            }
            
            if (!isQuickMode) {
                console.error(`âŒ æ‰€æœ‰ ${maxRetries} æ¬¡é‡è©¦éƒ½å¤±æ•—äº†`);
            }
            return null;
        }
        
    // åˆå§‹åŒ–å‚³è¼¸æ¨¡å¼ä¸¦é¡¯ç¤ºç•¶å‰æ¨¡å¼
    initTransportModeSelector();
        console.log(isTestMode ? 'ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼šä½¿ç”¨æœ¬åœ°æœå‹™å™¨' : 'ğŸŒ æ­£å¼æ¨¡å¼ï¼šä½¿ç”¨é ç«¯æœå‹™å™¨');
        console.log(corsQuietMode ? 'ğŸ”‡ CORS éœé»˜æ¨¡å¼å·²å•Ÿç”¨ - éŒ¯èª¤åªåœ¨æ§åˆ¶å°é¡¯ç¤º' : 'ğŸ”” CORS è©³ç´°æ¨¡å¼å·²å•Ÿç”¨ - å°‡é¡¯ç¤ºè­¦å‘Šæ¡†');
        console.log('ğŸ“¡ ç›®å‰ä½¿ç”¨çš„ baseUrl:', httpConfig.baseUrl);
        console.log('â±ï¸ HTTP è¶…æ™‚æ™‚é–“è¨­å®šç‚º:', httpConfig.timeout, 'ms');

        // --- MQTT ç›¸é—œè®Šæ•¸å’ŒåŠŸèƒ½ï¼ˆå·²æ£„ç”¨ï¼Œä¿ç•™ä¾›åƒè€ƒï¼‰ ---
        let mqttClient = null;
        let mqttConnected = false;
        let mqttReconnectTimer = null;
        let mqttHeartbeatTimer = null;
        let mqttReconnectAttempts = 0;
        let mqttAutoReconnect = false; // æ”¹ç‚º falseï¼Œåœç”¨è‡ªå‹•é‡é€£
        const mqttMaxReconnectAttempts = 10;
        
        // å°‡ MQTT è®Šæ•¸è¨­ç‚ºå…¨åŸŸï¼Œä¾›èª¿è©¦ä½¿ç”¨
        window.mqttClient = null;
        window.mqttConnected = false;
        const mqttReconnectInterval = 5000; // 5ç§’ï¼ˆä¸€èˆ¬ä¼ºæœå™¨ï¼‰
        const mqttReconnectIntervalOriginal = 30000; // 30ç§’ï¼ˆåŸä¼ºæœå™¨ï¼Œè¼ƒé•·é–“éš”ï¼‰
        const mqttHeartbeatInterval = 30000; // 30ç§’
        
        // MQTT ä¼ºæœå™¨è¨­å®š
        const mqttServerConfigs = {
            hivemq: {
                url: 'ws://broker.hivemq.com:8000/mqtt',
                topic: 'coffeelens/resp'
            }
        };
        
        // å¿«é€Ÿè¨­å®š MQTT ä¼ºæœå™¨
        function setMqttServer(serverKey) {
            const config = mqttServerConfigs[serverKey];
            if (!config) return;
            
            // å¦‚æœå·²é€£ç·šï¼Œå…ˆä¸­æ–·
            if (mqttConnected && mqttClient) {
                mqttClient.end();
                mqttConnected = false;
            }
            
            // æ›´æ–°è¼¸å…¥æ¡†
            document.getElementById('mqtt-broker-url').value = config.url;
            document.getElementById('mqtt-topic').value = config.topic;
            
            console.log(`å·²è¨­å®š MQTT ä¼ºæœå™¨: ${config.url}`);
        }
        
        // è®“å‡½æ•¸åœ¨å…¨åŸŸç¯„åœå¯ç”¨
        window.setMqttServer = setMqttServer;
        
        // ========================================
        // HTTP GET è¼ªè©¢åŠŸèƒ½
        // ========================================
        
        // ä»£ç†æˆåŠŸç‡è¿½è¹¤
        let proxySuccessStats = {
            // æ ¼å¼: { 'MAC_ä»£ç†åç¨±': { success: æ•¸é‡, total: æ•¸é‡, lastUsed: æ™‚é–“æˆ³ } }
        };
        
        // è¨˜éŒ„ä»£ç†ä½¿ç”¨çµæœ
        function recordProxyResult(macAddress, proxyName, success) {
            const key = `${macAddress}_${proxyName}`;
            if (!proxySuccessStats[key]) {
                proxySuccessStats[key] = { success: 0, total: 0, lastUsed: Date.now() };
            }
            
            proxySuccessStats[key].total++;
            if (success) {
                proxySuccessStats[key].success++;
            }
            proxySuccessStats[key].lastUsed = Date.now();
            
            // æ¸…ç†éèˆŠçš„çµ±è¨ˆè³‡æ–™ (è¶…é 7 å¤©)
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            Object.keys(proxySuccessStats).forEach(k => {
                if (proxySuccessStats[k].lastUsed < weekAgo) {
                    delete proxySuccessStats[k];
                }
            });
        }
        
        // ç²å–ä»£ç†æˆåŠŸç‡
        function getProxySuccessRate(macAddress, proxyName) {
            const key = `${macAddress}_${proxyName}`;
            const stats = proxySuccessStats[key];
            if (!stats || stats.total === 0) return 0.5; // é è¨­ 50%
            return stats.success / stats.total;
        }
        
        // å»ºæ§‹å®Œæ•´çš„ HTTP GET URL
        function buildHttpUrl(mac = null) {
            if (!httpConfig.baseUrl || !httpConfig.endpoint) {
                console.error('âŒ HTTP é…ç½®ä¸å®Œæ•´ï¼šç¼ºå°‘ baseUrl æˆ– endpoint');
                return null;
            }
            
            // ä½¿ç”¨æä¾›çš„ MAC æˆ–é è¨­çš„ MAC
            const macAddress = mac || httpConfig.currentMac;
            
            // æ›¿æ›è·¯å¾‘ä¸­çš„ {mac} åƒæ•¸
            let endpointPath = httpConfig.endpoint.replace('{mac}', macAddress);
            
            // å»ºæ§‹å®Œæ•´ URL
            const fullUrl = httpConfig.baseUrl + endpointPath;
            
            // å¦‚æœæœ‰æŸ¥è©¢åƒæ•¸ï¼Œæ·»åŠ åˆ° URL
            if (httpConfig.params && Object.keys(httpConfig.params).length > 0) {
                const url = new URL(fullUrl);
                Object.keys(httpConfig.params).forEach(key => {
                    url.searchParams.append(key, httpConfig.params[key]);
                });
                return url.toString();
            }
            
            return fullUrl;
        }
        
        // ç™¼é€ HTTP GET è«‹æ±‚
        async function sendHttpRequest(mac = null, devid = null) {
            const url = buildHttpUrl(mac);
            if (!url) {
                updateHttpStatus(false, 'é…ç½®éŒ¯èª¤');
                return null;
            }
            
            httpLastRequestTime = Date.now();
            httpRequestCount++;
            
            // æ›´æ–°è«‹æ±‚è¨ˆæ•¸é¡¯ç¤º
            const countElement = document.getElementById('http-request-count');
            if (countElement) {
                countElement.textContent = httpRequestCount;
            }
            
            console.log(`ğŸ“¤ [${httpRequestCount}] ç™¼é€ HTTP GET è«‹æ±‚: ${url}`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), httpConfig.timeout);
                
                let response;
                
                // ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šæ­£å¸¸ CORS è«‹æ±‚
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: httpConfig.headers || {},
                        signal: controller.signal,
                        mode: 'cors'
                    });
                } catch (corsError) {
                    clearTimeout(timeoutId);
                    
                    // å˜—è©¦ä½¿ç”¨ CORS ä»£ç†æœå‹™
                    console.warn('âŒ ç›´æ¥è«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦ CORS ä»£ç†æœå‹™...');
                    
                    // æ™ºèƒ½ä»£ç†é¸æ“‡ - æ ¹æ“šæ©Ÿå° MAC å’Œæ­·å²æˆåŠŸç‡
                    function getOptimizedProxyOrder(macAddress) {
                        // æ ¹æ“š MAC åœ°å€æ¨¡å¼å’Œéå¾€ç¶“é©—èª¿æ•´ä»£ç†é †åº
                        const baseProxies = [
                            { 
                                name: 'AllOrigins (æ¨è–¦)', 
                                buildUrl: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&pretty=true`,
                                parseResponse: async (response) => {
                                    const data = await response.json();
                                    if (!data.contents) throw new Error('No contents in response');
                                    return data.contents;
                                }
                            },
                            { 
                                name: 'AllOrigins (Raw)', 
                                buildUrl: (targetUrl) => `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'CORS Anywhere', 
                                buildUrl: (targetUrl) => `https://cors-anywhere.herokuapp.com/${targetUrl}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'ThingProxy', 
                                buildUrl: (targetUrl) => `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'Proxyjump', 
                                buildUrl: (targetUrl) => `https://proxy.cross-origin.com/?url=${encodeURIComponent(targetUrl)}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'YACDN', 
                                buildUrl: (targetUrl) => `https://yacdn.org/proxy/${targetUrl}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'JsonBox (å‚™ç”¨)', 
                                buildUrl: (targetUrl) => `https://api.jsonbox.io/?url=${encodeURIComponent(targetUrl)}`,
                                parseResponse: async (response) => {
                                    const data = await response.json();
                                    return JSON.stringify(data);
                                }
                            }
                        ];
                        
                        // æ ¹æ“šæ­·å²æˆåŠŸç‡å‹•æ…‹æ’åºä»£ç†
                        const proxiesWithStats = baseProxies.map(proxy => ({
                            ...proxy,
                            successRate: getProxySuccessRate(macAddress, proxy.name)
                        }));
                        
                        // æŒ‰æˆåŠŸç‡é™åºæ’åˆ—ï¼Œä½†ä¿ç•™ä¸€äº›éš¨æ©Ÿæ€§é¿å…éåº¦å„ªåŒ–
                        proxiesWithStats.sort((a, b) => {
                            const aRate = a.successRate + (Math.random() * 0.1 - 0.05); // Â±5% éš¨æ©Ÿæ€§
                            const bRate = b.successRate + (Math.random() * 0.1 - 0.05);
                            return bRate - aRate;
                        });
                        
                        // é‡å°ç‰¹å®šæ©Ÿå° MAC æ¨¡å¼çš„é¡å¤–èª¿æ•´
                        if (macAddress.startsWith('48E729')) {
                            // é€™é¡æ©Ÿå°å¦‚æœ AllOrigins Raw æˆåŠŸç‡ä¸éŒ¯ï¼Œæå‡å…¶å„ªå…ˆç´š
                            const rawProxy = proxiesWithStats.find(p => p.name.includes('Raw'));
                            if (rawProxy && rawProxy.successRate > 0.6) {
                                proxiesWithStats.splice(proxiesWithStats.indexOf(rawProxy), 1);
                                proxiesWithStats.unshift(rawProxy);
                            }
                        } else if (macAddress.startsWith('3494')) {
                            // å·²çŸ¥é€™é¡æ©Ÿå°é€£ç·šè¼ƒç©©å®šï¼Œå¦‚æœæŸå€‹ä»£ç†æ•ˆæœå¥½å°±æå‡å®ƒ
                            const bestProxy = proxiesWithStats[0];
                            if (bestProxy.successRate > 0.8) {
                                console.log(`ğŸ¯ æ©Ÿå° ${macAddress} å„ªå…ˆä½¿ç”¨é«˜æˆåŠŸç‡ä»£ç†: ${bestProxy.name} (${Math.round(bestProxy.successRate * 100)}%)`);
                            }
                        }
                        
                        return proxiesWithStats;
                    }
                    
                    // æ”¹é€²çš„ä»£ç†é…ç½® - ä½¿ç”¨æ™ºèƒ½é¸æ“‡
                    const proxyConfigs = getOptimizedProxyOrder(mac);
                    
                    let proxySuccess = false;
                    
                    for (const proxyConfig of proxyConfigs) {
                        try {
                            const proxyUrl = proxyConfig.buildUrl(url);
                            console.log(`ğŸ”„ å˜—è©¦ä»£ç† (${proxyConfig.name}): ${proxyUrl.substring(0, 80)}...`);
                            
                            const proxyResponse = await fetch(proxyUrl, {
                                signal: controller.signal,
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json, text/plain, */*'
                                }
                            });
                            
                            if (proxyResponse.ok) {
                                let parsedData;
                                
                                try {
                                    parsedData = await proxyConfig.parseResponse(proxyResponse);
                                } catch (parseErr) {
                                    console.warn(`âš ï¸ ä»£ç†å›æ‡‰è§£æå¤±æ•—:`, parseErr);
                                    parsedData = await proxyResponse.text();
                                }
                                
                                // å˜—è©¦è§£æç‚º JSON
                                if (typeof parsedData === 'string') {
                                    try {
                                        parsedData = JSON.parse(parsedData);
                                    } catch (jsonErr) {
                                        // ä¸æ˜¯ JSONï¼Œç¶­æŒæ–‡å­—æ ¼å¼
                                    }
                                }
                                
                                httpLastResponse = parsedData;
                                console.log(`âœ… ä»£ç†è«‹æ±‚æˆåŠŸ (${proxyConfig.name}):`, parsedData);
                                updateHttpStatus(true, `âœ… å·²é€é ${proxyConfig.name} ä»£ç†å–å¾—è³‡æ–™ (${new Date().toLocaleTimeString()})`);
                                
                                // è¨˜éŒ„ä»£ç†æˆåŠŸ
                                recordProxyResult(mac, proxyConfig.name, true);
                                
                                // ä»£ç†æˆåŠŸæ™‚é€²è¡Œè³‡æ–™è™•ç†ï¼Œå‚³é MAC å’Œ devid
                                handleHttpResponse(parsedData, mac, devid);
                                httpErrorCount = 0;
                                
                                proxySuccess = true;
                                return parsedData;
                            } else {
                                // è©³ç´°çš„éŒ¯èª¤ç‹€æ…‹ç¢¼è™•ç†
                                let errorMsg = `HTTP ${proxyResponse.status}`;
                                if (proxyResponse.status === 400) {
                                    errorMsg += ' (Bad Request - å¯èƒ½ URL æ ¼å¼å•é¡Œ)';
                                } else if (proxyResponse.status === 403) {
                                    errorMsg += ' (Forbidden - ä»£ç†æœå‹™é™åˆ¶)';
                                } else if (proxyResponse.status === 404) {
                                    errorMsg += ' (Not Found - ç›®æ¨™æœå‹™ä¸å­˜åœ¨)';
                                } else if (proxyResponse.status === 500) {
                                    errorMsg += ' (Internal Server Error - ä»£ç†æœå‹™éŒ¯èª¤)';
                                } else if (proxyResponse.status === 503) {
                                    errorMsg += ' (Service Unavailable - ä»£ç†æœå‹™éè¼‰)';
                                }
                                
                                console.warn(`âš ï¸ ä»£ç† ${proxyConfig.name} è¿”å› ${errorMsg}`);
                                
                                // è¨˜éŒ„ä»£ç†å¤±æ•—
                                recordProxyResult(mac, proxyConfig.name, false);
                                
                                // ç‰¹æ®Šè™•ç† HTTP 400 - å¯èƒ½æ˜¯ URL ç·¨ç¢¼å•é¡Œï¼Œå˜—è©¦ä¸åŒçš„ç·¨ç¢¼æ–¹å¼
                                if (proxyResponse.status === 400 && proxyConfig.name.includes('AllOrigins')) {
                                    console.log(`ğŸ”„ ${proxyConfig.name} HTTP 400ï¼Œå¯èƒ½ URL ç·¨ç¢¼å•é¡Œï¼Œå°‡å˜—è©¦ä¸‹å€‹ä»£ç†...`);
                                }
                            }
                        } catch (proxyError) {
                            console.warn(`âŒ ä»£ç† ${proxyConfig.name} å¤±æ•—:`, proxyError.message);
                            
                            // è¨˜éŒ„ä»£ç†å¤±æ•—
                            recordProxyResult(mac, proxyConfig.name, false);
                            
                            continue;
                        }
                    }
                    
                    if (!proxySuccess) {
                        // æ‰€æœ‰ä»£ç†éƒ½å¤±æ•—
                        console.error('âŒ CORS éŒ¯èª¤:', corsError.message);
                        console.error('ğŸ“ æ‰€æœ‰ä»£ç†æœå‹™å‡å¤±æ•—ï¼Œå¯é¸æ–¹æ¡ˆï¼š');
                        console.log('   1ï¸âƒ£ æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸');
                        console.log('   2ï¸âƒ£ æª¢æŸ¥ç›®æ¨™ä¼ºæœå™¨ ' + url + ' æ˜¯å¦åœ¨ç·š');
                        console.log('   3ï¸âƒ£ åœ¨æ–°åˆ†é ä¸­ç›´æ¥è¨ªå•æ­¤ URL æ¸¬è©¦');
                        console.log('   4ï¸âƒ£ è¯ç¹«å¾Œç«¯ç®¡ç†å“¡å•Ÿç”¨ CORS æ”¯æŒ');
                        
                        updateHttpStatus(false, 'âŒ ç¶²è·¯é€£ç·šæˆ–ä¼ºæœå™¨ç•°å¸¸ - è«‹æª¢æŸ¥');
                        
                        httpErrorCount++;
                        const errorCountElement = document.getElementById('http-error-count');
                        if (errorCountElement) {
                            errorCountElement.textContent = httpErrorCount;
                        }
                        
                        // è¨˜éŒ„åˆ°å‘½ä»¤æ—¥èªŒ
                        addCommandLog('error', `HTTP è«‹æ±‚å¤±æ•—: ${corsError.message}`, {
                            url: url,
                            error: corsError.message
                        });
                        
                        return null;
                    }
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // å˜—è©¦è§£æå›æ‡‰
                let data;
                const contentType = response.headers.get('content-type');
                
                try {
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }
                } catch (parseError) {
                    console.warn('âš ï¸ ç„¡æ³•è§£æå›æ‡‰:', parseError);
                    data = await response.text();
                }
                
                httpLastResponse = data;
                httpErrorCount = 0; // é‡ç½®éŒ¯èª¤è¨ˆæ•¸
                
                console.log('ğŸ“¥ æ”¶åˆ°å›æ‡‰:', data);
                console.log('ğŸ“Š è³‡æ–™é¡å‹:', typeof data);
                console.log('ğŸ“ è³‡æ–™é•·åº¦:', typeof data === 'string' ? data.length : JSON.stringify(data).length);
                
                updateHttpStatus(true, 'è«‹æ±‚æˆåŠŸ');
                
                // è™•ç†å›æ‡‰è³‡æ–™ï¼Œå‚³é MAC å’Œ devid
                handleHttpResponse(data, mac, devid);
                
                return data;
                
            } catch (error) {
                httpErrorCount++;
                
                // æ›´æ–°éŒ¯èª¤è¨ˆæ•¸é¡¯ç¤º
                const errorCountElement = document.getElementById('http-error-count');
                if (errorCountElement) {
                    errorCountElement.textContent = httpErrorCount;
                }
                
                console.error(`âŒ HTTP è«‹æ±‚å¤±æ•— (${httpErrorCount}):`, error.message);
                console.error('éŒ¯èª¤è©³æƒ…:', error);
                
                if (error.name === 'AbortError') {
                    updateHttpStatus(false, 'è«‹æ±‚è¶…æ™‚');
                } else if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    updateHttpStatus(false, 'CORS éŒ¯èª¤');
                } else {
                    updateHttpStatus(false, `éŒ¯èª¤: ${error.message}`);
                }
                
                return null;
            }
        }
        
        // âœ… æ–°å¢ï¼šå¿«é€Ÿæª¢æŸ¥æ˜¯å¦åŒ…å«ç›®æ¨™è³‡æ–™ï¼ˆå„ªå…ˆç´šéæ¿¾ï¼‰
        function quickCheckForTargetData(data, devid) {
            try {
                console.log(`ğŸ” [å„ªå…ˆç´šéæ¿¾] æª¢æŸ¥è³‡æ–™ï¼ŒDevID: ${devid}`);
                
                // å¦‚æœæ˜¯é™£åˆ—ï¼Œå¿«é€Ÿæª¢æŸ¥æ˜¯å¦åŒ…å« re_readdata å‘½ä»¤
                if (Array.isArray(data)) {
                    console.log(`ğŸ“Š [å„ªå…ˆç´šéæ¿¾] é™£åˆ—æ•¸æ“šï¼Œå…± ${data.length} ç­†è¨˜éŒ„`);
                    
                    let reReaddataCount = 0;
                    let targetDevidCount = 0;
                    
                    const hasTargetData = data.some(record => {
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.cmd === 're_readdata') {
                                    reReaddataCount++;
                                    if (devid === null || parseInt(parsed.devid) === parseInt(devid)) {
                                        targetDevidCount++;
                                        return true;
                                    }
                                }
                            } catch (e) {
                                // JSON è§£æå¤±æ•—ï¼Œå¿½ç•¥
                            }
                        }
                        return false;
                    });
                    
                    console.log(`ğŸ“‹ [å„ªå…ˆç´šéæ¿¾] æ‰¾åˆ° ${reReaddataCount} ç­† re_readdata è¨˜éŒ„`);
                    console.log(`ğŸ¯ [å„ªå…ˆç´šéæ¿¾] å…¶ä¸­ ${targetDevidCount} ç­†ç¬¦åˆ DevID ${devid}`);
                    console.log(`âœ… [å„ªå…ˆç´šéæ¿¾] çµæœ: ${hasTargetData ? 'é€šé' : 'ä¸é€šé'}`);
                    
                    return hasTargetData;
                }
                
                // å…¶ä»–è³‡æ–™æ ¼å¼çš„å¿«é€Ÿæª¢æŸ¥
                if (typeof data === 'object' && data.cmd === 're_readdata') {
                    console.log(`âœ… [å„ªå…ˆç´šéæ¿¾] ç‰©ä»¶æ ¼å¼ï¼Œcmd=re_readdataï¼Œé€šé`);
                    return true;
                }
                
                // å¦‚æœæ˜¯æ–‡æœ¬ï¼Œæª¢æŸ¥æ˜¯å¦åŒ…å«é—œéµå­—
                if (typeof data === 'string' && data.includes('re_readdata')) {
                    console.log(`âœ… [å„ªå…ˆç´šéæ¿¾] å­—ä¸²æ ¼å¼ï¼ŒåŒ…å« re_readdataï¼Œé€šé`);
                    return true;
                }
                
                console.log(`âŒ [å„ªå…ˆç´šéæ¿¾] è³‡æ–™æ ¼å¼ä¸ç¬¦æˆ–ç„¡ç›®æ¨™æ•¸æ“šï¼Œä¸é€šé`);
                console.log(`ğŸ“Š [å„ªå…ˆç´šéæ¿¾] è³‡æ–™é¡å‹: ${typeof data}, æ˜¯å¦é™£åˆ—: ${Array.isArray(data)}`);
                
                return false;
            } catch (error) {
                console.warn('âš ï¸ å„ªå…ˆç´šéæ¿¾æª¢æŸ¥å‡ºéŒ¯:', error);
                return false;
            }
        }

        // ğŸ“„ è™•ç† HTTP å›æ‡‰è³‡æ–™
        // è¼ªè©¢è¨˜éŒ„ç®¡ç†å‡½æ•¸ - åƒ…ç”¨æ–¼è¼ªè©¢è‡¨æ™‚è¨˜éŒ„ï¼Œä¸å½±éŸ¿æ­£å¼çš„ Firebase è¨˜éŒ„
        // âœ… æ³¨æ„ï¼šæ­¤å‡½æ•¸åƒ…ç”¨æ–¼è¼ªè©¢è‡ªå‹•è¨˜å¸³çš„è‡¨æ™‚é¡¯ç¤ºï¼Œä¸æœƒä¿®æ”¹ Firebase æ•¸æ“šåº«
        // ğŸ§ª è‡ªå‹•è¼ªè©¢åŠŸèƒ½æ¸¬è©¦å‡½æ•¸
        window.testAutoPoll = function() {
            console.log('\nğŸ§ª æ¸¬è©¦è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
            console.log(`ç•¶å‰é–€å¸‚: ${selectedGroupId}/${selectedStoreId}`);
            
            if (selectedGroupId && selectedStoreId) {
                const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
                const rawValue = localStorage.getItem(settingKey);
                const parsedValue = getAutoPollOnLoadSetting();
                
                console.log(`è¨­å®šéµå€¼: ${settingKey}`);
                console.log(`localStorage åŸå§‹å€¼: "${rawValue}"`);
                console.log(`è§£æå¾Œç‹€æ…‹: ${parsedValue ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`);
                
                // æª¢æŸ¥ UI ç‹€æ…‹
                const checkbox = document.getElementById('auto-poll-on-load');
                console.log(`UI å‹¾é¸æ¡†ç‹€æ…‹: ${checkbox ? checkbox.checked : 'æ‰¾ä¸åˆ°å…ƒç´ '}`);
                
                console.log('æ‰‹å‹•è§¸ç™¼è‡ªå‹•è¼ªè©¢...');
                triggerAutoPollOnLoad();
            } else {
                console.log('âŒ æœªé¸æ“‡é–€å¸‚');
            }
        };
        
        // ğŸ”§ å¼·åˆ¶å•Ÿç”¨è‡ªå‹•è¼ªè©¢æ¸¬è©¦å‡½æ•¸
        window.forceEnableAutoPoll = function() {
            if (selectedGroupId && selectedStoreId) {
                setAutoPollOnLoadSetting(true);
                const checkbox = document.getElementById('auto-poll-on-load');
                if (checkbox) {
                    checkbox.checked = true;
                }
                console.log('âœ… å·²å¼·åˆ¶å•Ÿç”¨è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
                triggerAutoPollOnLoad();
            } else {
                console.log('âŒ æœªé¸æ“‡é–€å¸‚ï¼Œç„¡æ³•è¨­å®š');
            }
        };
        
        // ï¿½ é–‹ç™¼è€…æ¨¡å¼åŠŸèƒ½
        function initDeveloperMode() {
            const toggleBtn = document.getElementById('toggle-dev-mode');
            const devTools = document.getElementById('developer-tools');
            
            if (!toggleBtn || !devTools) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°é–‹ç™¼è€…æ¨¡å¼å…ƒç´ ');
                return;
            }
            
            // å¾ localStorage è®€å–é–‹ç™¼è€…æ¨¡å¼ç‹€æ…‹
            let isDevMode = localStorage.getItem('developerMode') === 'true';
            
            // è¨­å®šåˆå§‹ç‹€æ…‹
            updateDeveloperModeUI(isDevMode, toggleBtn, devTools);
            
            // ç¶å®šåˆ‡æ›äº‹ä»¶
            toggleBtn.addEventListener('click', () => {
                isDevMode = !isDevMode;
                localStorage.setItem('developerMode', isDevMode.toString());
                updateDeveloperModeUI(isDevMode, toggleBtn, devTools);
                
                // é¡¯ç¤ºç‹€æ…‹é€šçŸ¥
                showDeveloperModeNotification(isDevMode);
                
                console.log(`ğŸ”§ é–‹ç™¼è€…æ¨¡å¼${isDevMode ? 'å·²å•Ÿç”¨' : 'å·²é—œé–‰'}`);
            });
        }
        
        function updateDeveloperModeUI(isEnabled, toggleBtn, devTools) {
            if (isEnabled) {
                devTools.classList.remove('hidden');
                toggleBtn.textContent = 'éš±è—èª¿è©¦å·¥å…·';
                toggleBtn.className = 'bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition-colors';
            } else {
                devTools.classList.add('hidden');
                toggleBtn.textContent = 'é¡¯ç¤ºèª¿è©¦å·¥å…·';
                toggleBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-colors';
            }
        }
        
        function showDeveloperModeNotification(isEnabled) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300 ${
                isEnabled ? 'bg-green-600' : 'bg-gray-600'
            }`;
            notification.innerHTML = `ğŸ”§ é–‹ç™¼è€…æ¨¡å¼${isEnabled ? 'å·²å•Ÿç”¨' : 'å·²é—œé–‰'}`;
            
            document.body.appendChild(notification);
            
            // æ·¡å‡ºå‹•ç•«
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // ï¿½ğŸ” å®Œæ•´è¨ºæ–·å‡½æ•¸
        window.diagnoseAutoPoll = function() {
            console.log('\nğŸ” ===== è‡ªå‹•è¼ªè©¢åŠŸèƒ½è¨ºæ–· =====');
            
            // æª¢æŸ¥åŸºæœ¬ç‹€æ…‹
            console.log('1. åŸºæœ¬ç‹€æ…‹:');
            console.log(`   selectedGroupId: ${selectedGroupId}`);
            console.log(`   selectedStoreId: ${selectedStoreId}`);
            console.log(`   appData.machines: ${appData?.machines?.length || 'æœªè¼‰å…¥'} å°`);
            
            // æª¢æŸ¥UIå…ƒç´ 
            console.log('\n2. UI å…ƒç´ :');
            const checkbox = document.getElementById('auto-poll-on-load');
            console.log(`   å‹¾é¸æ¡†å­˜åœ¨: ${!!checkbox}`);
            console.log(`   å‹¾é¸æ¡†ç‹€æ…‹: ${checkbox?.checked}`);
            console.log(`   å‹¾é¸æ¡†åˆå§‹åŒ–: ${checkbox?._initialized}`);
            
            // æª¢æŸ¥è¨­å®š
            console.log('\n3. å„²å­˜è¨­å®š:');
            if (selectedGroupId && selectedStoreId) {
                const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
                const rawValue = localStorage.getItem(settingKey);
                const parsedValue = getAutoPollOnLoadSetting();
                
                console.log(`   è¨­å®šéµå€¼: ${settingKey}`);
                console.log(`   åŸå§‹å€¼: "${rawValue}"`);
                console.log(`   è§£æå€¼: ${parsedValue}`);
            }
            
            // æª¢æŸ¥è¨ˆæ™‚å™¨
            console.log('\n4. è¨ˆæ™‚å™¨ç‹€æ…‹:');
            console.log(`   autoPollOnLoadTimer: ${autoPollOnLoadTimer ? 'é‹è¡Œä¸­' : 'ç©ºé–’'}`);
            
            // æª¢æŸ¥å‡½æ•¸
            console.log('\n5. å‡½æ•¸æª¢æŸ¥:');
            console.log(`   triggerAutoPollOnLoad: ${typeof triggerAutoPollOnLoad}`);
            console.log(`   pollAllMachines: ${typeof pollAllMachines}`);
            
            console.log('\n===== è¨ºæ–·å®Œæˆ =====\n');
            
            // æä¾›ä¿®å¾©å»ºè­°
            if (selectedGroupId && selectedStoreId && checkbox) {
                console.log('ğŸ”§ å˜—è©¦ä¿®å¾©...');
                
                // å¼·åˆ¶è¨­å®šå‹¾é¸æ¡†ç‹€æ…‹
                const currentSetting = getAutoPollOnLoadSetting();
                checkbox.checked = currentSetting;
                
                if (currentSetting) {
                    console.log('âœ… è¨­å®šå·²å•Ÿç”¨ï¼Œæ‰‹å‹•è§¸ç™¼æ¸¬è©¦...');
                    triggerAutoPollOnLoad();
                } else {
                    console.log('âŒ è¨­å®šæœªå•Ÿç”¨ï¼Œè«‹æ‰‹å‹•å‹¾é¸æˆ–åŸ·è¡Œ forceEnableAutoPoll()');
                }
            }
        };
        
        // ğŸ”§ é–‹ç™¼è€…æ¨¡å¼æ¸¬è©¦å‡½æ•¸
        window.toggleDeveloperMode = function() {
            const toggleBtn = document.getElementById('toggle-dev-mode');
            if (toggleBtn) {
                toggleBtn.click();
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°é–‹ç™¼è€…æ¨¡å¼åˆ‡æ›æŒ‰éˆ•');
            }
        };
        
        // ğŸ’¡ é–‹ç™¼è€…æ¨¡å¼èªªæ˜
        window.showDeveloperModeHelp = function() {
            console.log('\nğŸ”§ ===== é–‹ç™¼è€…æ¨¡å¼èªªæ˜ =====');
            console.log('');
            console.log('ğŸ“Œ åŠŸèƒ½èªªæ˜:');
            console.log('   é–‹ç™¼è€…æ¨¡å¼éš±è—äº†å·¥ç¨‹èª¿è©¦å·¥å…·å’Œæ‰¹æ¬¡è™•ç†è¨­å®šï¼Œè®“ç•Œé¢æ›´ç°¡æ½”');
            console.log('');
            console.log('ğŸ¯ ä½¿ç”¨æ–¹å¼:');
            console.log('   1. é»æ“Šã€Œé¡¯ç¤ºèª¿è©¦å·¥å…·ã€æŒ‰éˆ•å•Ÿç”¨');
            console.log('   2. æˆ–åœ¨æ§åˆ¶å°åŸ·è¡Œ: toggleDeveloperMode()');
            console.log('');
            console.log('ğŸ”§ å¯ç”¨å‘½ä»¤:');
            console.log('   â€¢ toggleDeveloperMode() - åˆ‡æ›é–‹ç™¼è€…æ¨¡å¼');
            console.log('   â€¢ testAutoPoll() - æ¸¬è©¦è‡ªå‹•è¼ªè©¢');
            console.log('   â€¢ diagnoseAutoPoll() - è¨ºæ–·è‡ªå‹•è¼ªè©¢');
            console.log('   â€¢ forceEnableAutoPoll() - å¼·åˆ¶å•Ÿç”¨è‡ªå‹•è¼ªè©¢');
            console.log('');
            console.log('ğŸ› ï¸ é–‹ç™¼è€…å·¥å…·åŒ…å«:');
            console.log('   â€¢ HTTP GET è³‡æ–™æ“·å–æ¸¬è©¦');
            console.log('   â€¢ æ‰¹æ¬¡è™•ç†è¨­å®š (å¤§å°èª¿æ•´ã€ç„¡é™åˆ¶æ¨¡å¼)');
            console.log('   â€¢ å‘½ä»¤è¨˜éŒ„æŸ¥çœ‹');
            console.log('   â€¢ æ©Ÿå°è³‡æ–™å³æ™‚é¡¯ç¤º');
            console.log('');
            console.log('ğŸ’¾ ç‹€æ…‹ä¿å­˜:');
            console.log('   é–‹ç™¼è€…æ¨¡å¼ç‹€æ…‹æœƒè‡ªå‹•ä¿å­˜åˆ° localStorage');
            console.log('');
            console.log('==============================\n');
        };
        
        // ğŸ§ª æ¸¬è©¦ä¿®æ”¹æŒ‰éˆ•åŠŸèƒ½
        window.testEditButton = function() {
            console.log('\nğŸ§ª æ¸¬è©¦ä¿®æ”¹æŒ‰éˆ•åŠŸèƒ½');
            
            const editBtns = document.querySelectorAll('.edit-machine-btn');
            console.log(`æ‰¾åˆ° ${editBtns.length} å€‹ä¿®æ”¹æŒ‰éˆ•`);
            
            if (editBtns.length > 0) {
                const firstBtn = editBtns[0];
                console.log('ç¬¬ä¸€å€‹ä¿®æ”¹æŒ‰éˆ•çš„è³‡æ–™:', firstBtn.dataset);
                console.log('å˜—è©¦è§¸ç™¼é»æ“Šäº‹ä»¶...');
                firstBtn.click();
            } else {
                console.log('âŒ æ²’æœ‰æ‰¾åˆ°ä¿®æ”¹æŒ‰éˆ•');
            }
        }

        // ğŸŒ æª¢æŸ¥éƒ¨ç½²ç’°å¢ƒ
        window.checkDeploymentEnvironment = function() {
            console.log('\nğŸ” ===== éƒ¨ç½²ç’°å¢ƒå®Œæ•´æª¢æŸ¥ =====');
            console.log('ç•¶å‰ URL:', window.location.href);
            console.log('å”è­°:', window.location.protocol);
            console.log('ä¸»æ©Ÿå:', window.location.hostname);
            console.log('æ˜¯å¦ HTTPS:', window.location.protocol === 'https:');
            console.log('æ˜¯å¦ GitHub Pages:', window.location.hostname.includes('github.io'));
            console.log('');
            console.log('ç›®æ¨™ä¼ºæœå™¨é…ç½®:');
            console.log('  åŸºç¤ URL:', httpConfig.baseUrl);
            console.log('  API ç«¯é»:', httpConfig.endpoint);
            console.log('  è¶…æ™‚æ™‚é–“:', httpConfig.timeout, 'ms');
            console.log('');
            
            const isHttps = window.location.protocol === 'https:';
            const targetIsHttp = httpConfig.baseUrl.startsWith('http:');
            
            if (isHttps && targetIsHttp) {
                console.warn('âš ï¸ æª¢æ¸¬åˆ°æ··åˆå…§å®¹å•é¡Œï¼');
                console.log('HTTPS é é¢ + HTTP ç›®æ¨™ = ç€è¦½å™¨æœƒé˜»æ­¢ç›´æ¥è«‹æ±‚');
                console.log('');
                console.log('âœ… è§£æ±ºæ–¹æ¡ˆå·²éƒ¨ç½²:');
                console.log('   1ï¸âƒ£ è‡ªå‹•ä½¿ç”¨ CORS ä»£ç†æœå‹™');
                console.log('   2ï¸âƒ£ æ”¯æ´å¤šå€‹ä»£ç†å‚™ä»½');
                console.log('   3ï¸âƒ£ è‡ªå‹•æ•…éšœè½‰ç§»');
                console.log('');
                console.log('ğŸ§ª æ¸¬è©¦ä»£ç†ï¼šè¼¸å…¥ testCorsProxy()');
            } else if (!isHttps) {
                console.log('âœ… HTTP ç’°å¢ƒ: å¯ä»¥å®Œå…¨æ”¯æ´æ‰€æœ‰åŠŸèƒ½');
            }
            
            console.log('===============================');
        }

        // ğŸ§ª æ¸¬è©¦ CORS ä»£ç†åŠŸèƒ½
        window.testCorsProxy = function() {
            console.log('\nğŸ§ª ===== CORS ä»£ç†åŠŸèƒ½æ¸¬è©¦ =====');
            
            const testMac = '083A8DE1ED14';
            const testUrl = `http://update.feiloli.com.tw:5539/textselectdata/${testMac}`;
            
            console.log(`ç›®æ¨™ URL: ${testUrl}\n`);
            
            // æ¸¬è©¦æ‰€æœ‰ä»£ç†
            const proxyConfigs = [
                { 
                    name: 'AllOrigins (æ¨è–¦)', 
                    buildUrl: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&pretty=true`,
                    parseResponse: async (response) => {
                        const data = await response.json();
                        if (!data.contents) throw new Error('No contents in response');
                        return data.contents;
                    }
                },
                { 
                    name: 'Proxyjump', 
                    buildUrl: (targetUrl) => `https://proxy.cross-origin.com/?url=${encodeURIComponent(targetUrl)}`,
                    parseResponse: async (response) => {
                        const text = await response.text();
                        return text;
                    }
                }
            ];
            
            (async () => {
                for (const proxyConfig of proxyConfigs) {
                    try {
                        const proxyUrl = proxyConfig.buildUrl(testUrl);
                        console.log(`ğŸ”„ æ¸¬è©¦ä»£ç† (${proxyConfig.name})...`);
                        console.log(`   ä»£ç† URL: ${proxyUrl.substring(0, 100)}...`);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json, text/plain, */*'
                            }
                        });
                        
                        if (response.ok) {
                            try {
                                const data = await proxyConfig.parseResponse(response);
                                console.log(`âœ… ${proxyConfig.name} å¯ç”¨ï¼`);
                                console.log(`   å›æ‡‰é•·åº¦: ${JSON.stringify(data).length} å­—å…ƒ`);
                                console.log(`   é è¦½: ${JSON.stringify(data).substring(0, 100)}...`);
                            } catch (parseErr) {
                                console.warn(`âš ï¸ ${proxyConfig.name} å›æ‡‰è§£æå¤±æ•—:`, parseErr.message);
                            }
                        } else {
                            console.warn(`âŒ ${proxyConfig.name} HTTP ${response.status}`);
                        }
                    } catch (err) {
                        console.warn(`âŒ ${proxyConfig.name} å¤±æ•—:`, err.message);
                    }
                    
                    // é–“éš” 1 ç§’é¿å…éå¿«
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                console.log('\n=============================');
                console.log('âœ… ä»£ç†æ¸¬è©¦å®Œæˆ');
                console.log('å»ºè­°ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„ä»£ç†');
                console.log('=============================');
            })();
        }

        // ğŸ” æ©Ÿå°è³‡æ–™è¨ºæ–·å·¥å…·
        window.diagnoseMachineData = function() {
            console.log('\nğŸ” ===== æ©Ÿå°è³‡æ–™è¨ºæ–· =====');
            
            if (!appData || !appData.machines) {
                console.log('âŒ æ©Ÿå°è³‡æ–™ä¸å­˜åœ¨');
                return;
            }
            
            console.log(`ğŸ“Š å…±æœ‰ ${appData.machines.length} å°æ©Ÿå°:`);
            appData.machines.forEach((machine, index) => {
                console.log(`\næ©Ÿå° ${index + 1}:`);
                console.log(`   ID: ${machine.id}`);
                console.log(`   ä½ç½®: ${machine.location}`);
                console.log(`   MAC: ${machine.mac || 'æœªè¨­å®š'}`);
                console.log(`   è¨­å‚™ID: ${machine.devid || 'æœªè¨­å®š'}`);
                console.log(`   æŠ•å¹£æ ¡æ­£: ${machine.playsCalibration || 0}`);
                console.log(`   å‡ºè²¨æ ¡æ­£: ${machine.payoutsCalibration || 0}`);
                console.log(`   DocID: ${machine.docId}`);
            });
            
            // æª¢æŸ¥è¡¨æ ¼ä¸­çš„æŒ‰éˆ•å±¬æ€§
            console.log('\nğŸ”§ æª¢æŸ¥è¡¨æ ¼æŒ‰éˆ•å±¬æ€§:');
            const pollBtns = document.querySelectorAll('.poll-machine-btn');
            pollBtns.forEach((btn, index) => {
                console.log(`è¼ªè©¢æŒ‰éˆ• ${index + 1}:`);
                console.log(`   MAC: ${btn.getAttribute('data-mac')}`);
                console.log(`   è¨­å‚™ID: ${btn.getAttribute('data-devid')}`);
            });
            
            // æª¢æŸ¥è¼¸å…¥æ¡†çš„å€¼
            console.log('\nğŸ”§ æª¢æŸ¥è¡¨æ ¼è¼¸å…¥æ¡†:');
            const macInputs = document.querySelectorAll('.mac-address-input');
            const devidInputs = document.querySelectorAll('.device-id-input');
            
            macInputs.forEach((input, index) => {
                console.log(`MACè¼¸å…¥æ¡† ${index + 1}: ${input.value}`);
            });
            
            devidInputs.forEach((input, index) => {
                console.log(`è¨­å‚™IDè¼¸å…¥æ¡† ${index + 1}: ${input.value}`);
            });
            
            console.log('\n===============================');
        }

        // ğŸ§ª GitHub Pages CORS ä»£ç†é€£æ¥æ¸¬è©¦å·¥å…·
        window.testHttpConnection = function() {
            console.log('\nğŸ§ª ===== HTTP é€£æ¥æ¸¬è©¦ (CORS ä»£ç†æ¨¡å¼) =====\n');
            
            const isHttps = window.location.protocol === 'https:';
            const isGitHub = window.location.hostname.includes('github.io');
            
            console.log(`ğŸ“ ç•¶å‰ç’°å¢ƒ: ${isHttps ? 'HTTPS' : 'HTTP'}`);
            console.log(`ğŸ”— ä¸»æ©Ÿ: ${window.location.hostname}`);
            console.log(`ğŸ“¡ GitHub Pages: ${isGitHub ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`);
            
            const testUrl = 'http://update.feiloli.com.tw:5539/textselectdata/083A8DE1ED14';
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(testUrl)}&pretty=true`;
            
            console.log(`ğŸ¯ æ¸¬è©¦ä¼ºæœå™¨: ${testUrl}`);
            console.log(`ğŸ”„ ä½¿ç”¨ä»£ç†: AllOrigins\n`);
            
            console.log('â³ æ­£åœ¨é€£æ¥...\n');
            
            fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`ğŸ“Š HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('\nâœ… ===== é€£æ¥æˆåŠŸï¼=====');
                console.log('ğŸ“ å›æ‡‰å…§å®¹:');
                console.log(data.contents ? data.contents.substring(0, 200) + '...' : data);
                console.log('\nğŸ‰ ä»£ç†å·¥ä½œæ­£å¸¸ï¼');
                console.log('======================\n');
            })
            .catch(error => {
                console.log('\nâŒ ===== é€£æ¥å¤±æ•— =====');
                console.log(`âš ï¸ éŒ¯èª¤: ${error.message}`);
                console.log('\nğŸ“‹ å¯èƒ½çš„åŸå› :');
                console.log('1. ç›®æ¨™ä¼ºæœå™¨ (update.feiloli.com.tw:5539) é›¢ç·š');
                console.log('2. AllOrigins ä»£ç†æœå‹™æš«æ™‚ä¸å¯ç”¨');
                console.log('3. ç¶²è·¯é€£æ¥ç•°å¸¸');
                console.log('\nğŸ”§ è§£æ±ºæ–¹æ¡ˆ:');
                console.log('1. æª¢æŸ¥ä¼ºæœå™¨æ˜¯å¦åœ¨ç·š');
                console.log('2. å˜—è©¦å…¶ä»–ä»£ç†æœå‹™');
                console.log('3. æª¢æŸ¥ç¶²è·¯é€£æ¥');
                console.log('======================\n');
            });
        };

        // é¦–æ¬¡è¼‰å…¥æ™‚é¡¯ç¤ºèªªæ˜
        setTimeout(() => {
            console.log('ğŸ’¡ è¼¸å…¥ showDeveloperModeHelp() æŸ¥çœ‹é–‹ç™¼è€…æ¨¡å¼èªªæ˜');
            console.log('ğŸ’¡ è¼¸å…¥ diagnoseMachineData() è¨ºæ–·æ©Ÿå°è³‡æ–™åŒæ­¥å•é¡Œ');
            console.log('ğŸ’¡ è¼¸å…¥ testEditButton() æ¸¬è©¦ä¿®æ”¹æŒ‰éˆ•åŠŸèƒ½');
            console.log('ğŸ’¡ è¼¸å…¥ checkDeploymentEnvironment() æª¢æŸ¥éƒ¨ç½²ç’°å¢ƒ');
            console.log('ğŸ’¡ è¼¸å…¥ testCorsProxy() æ¸¬è©¦ CORS ä»£ç†åŠŸèƒ½');
            console.log('ğŸ’¡ è¼¸å…¥ testHttpConnection() æ¸¬è©¦ GitHub Pages HTTP é€£æ¥');
        }, 3000);
        
        // ğŸ§ª æ ¡æ­£åŠŸèƒ½æ¸¬è©¦å‡½æ•¸
        window.testCalibration = function(machineId, location, testPlays = 100, testPayouts = 50) {
            console.log(`\nğŸ§ª æ¸¬è©¦æ©Ÿå°æ ¡æ­£åŠŸèƒ½`);
            console.log(`æ¸¬è©¦æ©Ÿå°: ${machineId}/${location}`);
            console.log(`æ¸¬è©¦æ•¸å€¼: æŠ•å¹£=${testPlays}, å‡ºè²¨=${testPayouts}`);
            console.log(`${'='.repeat(50)}`);
            
            const result = applyMachineCalibration(machineId, location, testPlays, testPayouts);
            
            console.log(`æ ¡æ­£çµæœ:`);
            console.log(`  åŸå§‹æŠ•å¹£: ${result.rawPlays}`);
            console.log(`  æ ¡æ­£æŠ•å¹£: ${result.plays} (æ ¡æ­£å€¼: ${result.playsCalibration})`);
            console.log(`  åŸå§‹å‡ºè²¨: ${result.rawPayouts}`);
            console.log(`  æ ¡æ­£å‡ºè²¨: ${result.payouts} (æ ¡æ­£å€¼: ${result.payoutsCalibration})`);
            
            return result;
        };
        
        // ğŸ”§ æ©Ÿå°æ•¸å€¼æ ¡æ­£å‡½æ•¸ - è‡ªå‹•è¨ˆç®—å¯¦éš›å¡«è¡¨æ•¸å€¼
        function applyMachineCalibration(machineId, location, rawPlays, rawPayouts) {
            console.log(`ğŸ”§ é–‹å§‹æ ¡æ­£è¨ˆç®— - æ©Ÿå°: ${machineId}/${location}, åŸå§‹å€¼: plays=${rawPlays}, payouts=${rawPayouts}`);
            
            // å°‹æ‰¾å°æ‡‰çš„æ©Ÿå°é…ç½®
            if (!appData || !appData.machines) {
                console.log(`âš ï¸ æ‰¾ä¸åˆ°æ©Ÿå°é…ç½®è³‡æ–™ï¼Œä½¿ç”¨åŸå§‹å€¼`);
                return { plays: rawPlays, payouts: rawPayouts };
            }
            
            const machine = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machine) {
                console.log(`âš ï¸ æ‰¾ä¸åˆ°æ©Ÿå° ${machineId}/${location} çš„é…ç½®ï¼Œä½¿ç”¨åŸå§‹å€¼`);
                return { plays: rawPlays, payouts: rawPayouts };
            }
            
            // ç²å–æ ¡æ­£å€¼
            const playsCalibration = machine.playsCalibration || 0;
            const payoutsCalibration = machine.payoutsCalibration || 0;
            
            // è¨ˆç®—æ ¡æ­£å¾Œçš„æ•¸å€¼
            const calibratedPlays = rawPlays + playsCalibration;
            const calibratedPayouts = rawPayouts + payoutsCalibration;
            
            // ç¢ºä¿æ ¡æ­£å¾Œçš„å€¼ä¸ç‚ºè² æ•¸
            const finalPlays = Math.max(0, calibratedPlays);
            const finalPayouts = Math.max(0, calibratedPayouts);
            
            console.log(`ğŸ”§ æ ¡æ­£è¨ˆç®—å®Œæˆ:`);
            console.log(`   åŸå§‹æŠ•å¹£: ${rawPlays} + æ ¡æ­£å€¼: ${playsCalibration} = å¯¦éš›æŠ•å¹£: ${finalPlays}`);
            console.log(`   åŸå§‹å‡ºè²¨: ${rawPayouts} + æ ¡æ­£å€¼: ${payoutsCalibration} = å¯¦éš›å‡ºè²¨: ${finalPayouts}`);
            
            // è¨˜éŒ„æ ¡æ­£è®ŠåŒ–
            if (playsCalibration !== 0 || payoutsCalibration !== 0) {
                console.log(`ğŸ“Š æ©Ÿå° ${machineId}/${location} å·²æ‡‰ç”¨æ ¡æ­£å€¼`);
            }
            
            return { 
                plays: finalPlays, 
                payouts: finalPayouts,
                playsCalibration: playsCalibration,
                payoutsCalibration: payoutsCalibration,
                rawPlays: rawPlays,
                rawPayouts: rawPayouts
            };
        }

        function updateDailyRecord(machineId, location, plays, payouts, date = null) {
            console.log(`ğŸ“ æ›´æ–°è¼ªè©¢è‡¨æ™‚è¨˜éŒ„ - æ©Ÿå°: ${machineId}/${location}, plays: ${plays}, payouts: ${payouts}`);

            const rawPlays = plays;
            const rawPayouts = payouts;
            const calibration = applyMachineCalibration(machineId, location, rawPlays, rawPayouts) || {};
            const calibratedPlays = calibration.plays ?? rawPlays;
            const calibratedPayouts = calibration.payouts ?? rawPayouts;
            const playsCalibration = calibration.playsCalibration ?? 0;
            const payoutsCalibration = calibration.payoutsCalibration ?? 0;

            // åˆå§‹åŒ–è¼ªè©¢è‡¨æ™‚å­˜å„²ï¼ˆèˆ‡æ­£å¼çš„ Firebase è¨˜éŒ„åˆ†é›¢ï¼‰
            if (!window.dailyRecords) {
                window.dailyRecords = {};
            }

            // ä½¿ç”¨æä¾›çš„æ—¥æœŸæˆ–å–å¾—ä»Šå¤©çš„æ—¥æœŸ
            const recordDate = date || new Date().toISOString().split('T')[0];
            const recordKey = `${machineId}_${location}_${recordDate}`;

            // ç²å–è©²æ©Ÿå°ä»Šå¤©çš„è¼ªè©¢è¨˜éŒ„
            let todayRecord = window.dailyRecords[recordKey];
            const now = new Date();
            const nowString = now.toLocaleString('zh-TW');
            const nowTimeString = now.toLocaleTimeString('zh-TW');

            if (!todayRecord) {
                // æ–°å»ºä»Šå¤©çš„è¼ªè©¢è¨˜éŒ„
                todayRecord = {
                    machineId: machineId,
                    location: location,
                    date: recordDate,
                    plays: calibratedPlays,
                    payouts: calibratedPayouts,
                    rawPlays: rawPlays,
                    rawPayouts: rawPayouts,
                    playsCalibration: playsCalibration,
                    payoutsCalibration: payoutsCalibration,
                    createdAt: nowString,
                    updatedAt: nowString,
                    updateCount: 1,
                    // âœ… è¼ªè©¢å°ˆç”¨ï¼šè®Šæ›´æª¢æ¸¬çš„è©³ç´°æ¬„ä½
                    lastPlays: calibratedPlays,
                    lastPayouts: calibratedPayouts,
                    lastRawPlays: rawPlays,
                    lastRawPayouts: rawPayouts,
                    playsChanged: false,
                    payoutsChanged: false,
                    isPollingRecord: true, // âœ… æ¨™è¨˜ç‚ºè¼ªè©¢è¨˜éŒ„
                    history: [{
                        timestamp: nowTimeString,
                        plays: calibratedPlays,
                        payouts: calibratedPayouts,
                        rawPlays: rawPlays,
                        rawPayouts: rawPayouts,
                        playsCalibration: playsCalibration,
                        payoutsCalibration: payoutsCalibration,
                        playsChanged: false,
                        payoutsChanged: false,
                        playsDelta: 0,
                        payoutsDelta: 0
                    }]
                };
                window.dailyRecords[recordKey] = todayRecord;
                console.log(`âœ… æ–°å»ºè¼ªè©¢è‡¨æ™‚è¨˜éŒ„ - æ©Ÿå°: ${machineId}/${location}, æ—¥æœŸ: ${recordDate}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts}`);

                return { status: 'created', record: todayRecord, playsChanged: false, payoutsChanged: false };
            }

            // âœ… èˆ‡è¼ªè©¢è¨˜éŒ„æ¯”å° - è©³ç´°çš„è®Šæ›´æª¢æ¸¬ï¼ˆä½¿ç”¨æ ¡æ­£å¾Œæ•¸å€¼ï¼‰
            const playsChanged = (todayRecord.plays !== calibratedPlays);
            const payoutsChanged = (todayRecord.payouts !== calibratedPayouts);
            const isChanged = playsChanged || payoutsChanged;

            if (isChanged) {
                // è¨ˆç®—è®ŠåŒ–é‡
                const playsDelta = calibratedPlays - todayRecord.plays;
                const payoutsDelta = calibratedPayouts - todayRecord.payouts;

                // æ•¸æ“šæœ‰è®ŠåŒ–ï¼Œæ›´æ–°è¼ªè©¢è¨˜éŒ„
                console.log(`ğŸ”„ è¼ªè©¢æ•¸æ“šæœ‰è®ŠåŒ– - æ©Ÿå°: ${machineId}/${location}`);
                if (playsChanged) {
                    console.log(`   â­ æŠ•å¹£æ¬¡æ•¸è®ŠåŒ–: ${todayRecord.plays} â†’ ${calibratedPlays} (å¢åŠ : +${playsDelta})`);
                }
                if (payoutsChanged) {
                    console.log(`   â­ å‡ºè²¨æ•¸é‡è®ŠåŒ–: ${todayRecord.payouts} â†’ ${calibratedPayouts} (å¢åŠ : +${payoutsDelta})`);
                }

                // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„ï¼ˆåŒ…å«è©³ç´°çš„è®Šæ›´ä¿¡æ¯ï¼‰
                todayRecord.history.push({
                    timestamp: nowTimeString,
                    plays: calibratedPlays,
                    payouts: calibratedPayouts,
                    rawPlays: rawPlays,
                    rawPayouts: rawPayouts,
                    playsCalibration: playsCalibration,
                    payoutsCalibration: payoutsCalibration,
                    playsChanged: playsChanged,
                    payoutsChanged: payoutsChanged,
                    playsDelta: playsDelta,
                    payoutsDelta: payoutsDelta
                });

                // æ›´æ–°ä¸»è¨˜éŒ„
                todayRecord.lastPlays = todayRecord.plays;  // âœ… ä¿å­˜èˆŠå€¼ä¾›å¾ŒçºŒæ¯”å°
                todayRecord.lastPayouts = todayRecord.payouts;  // âœ… ä¿å­˜èˆŠå€¼ä¾›å¾ŒçºŒæ¯”å°
                todayRecord.lastRawPlays = todayRecord.rawPlays;
                todayRecord.lastRawPayouts = todayRecord.rawPayouts;
                todayRecord.plays = calibratedPlays;
                todayRecord.payouts = calibratedPayouts;
                todayRecord.rawPlays = rawPlays;
                todayRecord.rawPayouts = rawPayouts;
                todayRecord.playsCalibration = playsCalibration;
                todayRecord.payoutsCalibration = payoutsCalibration;
                todayRecord.playsChanged = playsChanged;  // âœ… æ¨™è¨˜æŠ•å¹£æ¬¡æ•¸æ˜¯å¦è®ŠåŒ–
                todayRecord.payoutsChanged = payoutsChanged;  // âœ… æ¨™è¨˜å‡ºè²¨æ•¸é‡æ˜¯å¦è®ŠåŒ–
                todayRecord.updatedAt = nowString;
                todayRecord.updateCount = (todayRecord.updateCount || 0) + 1;

                window.dailyRecords[recordKey] = todayRecord;
                console.log(`âœ… å·²æ›´æ–°è¼ªè©¢è‡¨æ™‚è¨˜éŒ„ - æ©Ÿå°: ${machineId}/${location}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts}, æ›´æ–°æ¬¡æ•¸: ${todayRecord.updateCount}`);
                console.log(`   ğŸ“Š æ›´æ–°çµ±è¨ˆ: playsè®ŠåŒ–=${playsChanged}, payoutsè®ŠåŒ–=${payoutsChanged}, æ­·å²è¨˜éŒ„æ•¸=${todayRecord.history.length}`);

                return { status: 'updated', record: todayRecord, playsChanged, payoutsChanged, playsDelta, payoutsDelta };
            } else {
                // æ•¸æ“šç›¸åŒï¼Œä¸æ›´æ–°
                console.log(`â„¹ï¸ è¼ªè©¢æ•¸æ“šæœªè®ŠåŒ– - æ©Ÿå°: ${machineId}/${location}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts} (ç¶­æŒä¸è®Š)`);
                todayRecord.rawPlays = rawPlays;
                todayRecord.rawPayouts = rawPayouts;
                todayRecord.playsCalibration = playsCalibration;
                todayRecord.payoutsCalibration = payoutsCalibration;
                return { status: 'unchanged', record: todayRecord, playsChanged: false, payoutsChanged: false, playsDelta: 0, payoutsDelta: 0 };
            }
        }
        
        // æ§‹å»ºå‹•æ…‹æ©Ÿå°é…ç½®æ˜ å°„è¡¨ {MAC_devid} -> {machineId, location}
        function buildMachineConfigMap() {
            if (window.machineConfigMap) {
                return window.machineConfigMap;
            }
            
            window.machineConfigMap = {};
            // å»ºç«‹ MAC-only æ˜ å°„ä½œç‚ºå‚™ç”¨æŸ¥æ‰¾
            window.machineConfigMapByMac = {};
            // å»ºç«‹ devid-only æ˜ å°„ä½œç‚ºå‚™ç”¨æŸ¥æ‰¾
            window.machineConfigMapByDevid = {};
            
            if (!appData || !appData.machines) {
                console.warn('âš ï¸ appData.machines æœªåˆå§‹åŒ–');
                return window.machineConfigMap;
            }
            
            console.log(`ğŸ” é–‹å§‹å»ºæ§‹æ©Ÿå°é…ç½®æ˜ å°„è¡¨ï¼Œå…± ${appData.machines.length} å°æ©Ÿå°`);
            
            // éæ­·æ‰€æœ‰æ©Ÿå°é…ç½®
            appData.machines.forEach((machine, index) => {
                console.log(`ğŸ“‹ [${index}] è™•ç†æ©Ÿå°:`, {
                    id: machine.id,
                    location: machine.location,
                    mac: machine.mac,
                    devid: machine.devid,
                    hasDevidData: !!machine.devidData,
                    devidDataKeys: machine.devidData ? Object.keys(machine.devidData) : []
                });
                
                // æ¯å€‹æ©Ÿå°å¯èƒ½æœ‰ MAC å’Œ devid ä¿¡æ¯
                if (machine.mac && machine.devidData) {
                    // å¦‚æœæ©Ÿå°æœ‰å¤šå€‹ devidï¼ˆå¦‚ devid=1 å’Œ devid=2ï¼‰
                    Object.keys(machine.devidData).forEach(devid => {
                        const mapKey = `${machine.mac}_${devid}`;
                        
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„æ˜ å°„
                        if (window.machineConfigMap[mapKey]) {
                            console.warn(`âš ï¸ æ˜ å°„è¡çª: ${mapKey} å·²å­˜åœ¨ï¼Œå°‡è¦†è“‹ç‚º ${machine.id}/${machine.location}`);
                        }
                        
                        const machineInfo = {
                            machineId: machine.id,
                            location: machine.location,
                            mac: machine.mac,
                            devid: parseInt(devid)
                        };
                        
                        window.machineConfigMap[mapKey] = machineInfo;
                        console.log(`ğŸ“Œ æ˜ å°„: ${mapKey} -> ${machine.id}/${machine.location}`);
                        
                        // å»ºç«‹å‚™ç”¨æ˜ å°„
                        if (!window.machineConfigMapByMac[machine.mac]) {
                            window.machineConfigMapByMac[machine.mac] = [];
                        }
                        window.machineConfigMapByMac[machine.mac].push(machineInfo);
                        
                        if (!window.machineConfigMapByDevid[devid]) {
                            window.machineConfigMapByDevid[devid] = [];
                        }
                        window.machineConfigMapByDevid[devid].push(machineInfo);
                    });
                } else if (machine.mac && machine.devid) {
                    // ç°¡å–®æƒ…æ³ï¼šå–®å€‹ devid
                    const mapKey = `${machine.mac}_${machine.devid}`;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„æ˜ å°„
                    if (window.machineConfigMap[mapKey]) {
                        console.warn(`âš ï¸ æ˜ å°„è¡çª: ${mapKey} å·²å­˜åœ¨ï¼Œå°‡è¦†è“‹ç‚º ${machine.id}/${machine.location}`);
                    }
                    
                    const machineInfo = {
                        machineId: machine.id,
                        location: machine.location,
                        mac: machine.mac,
                        devid: parseInt(machine.devid)
                    };
                    
                    window.machineConfigMap[mapKey] = machineInfo;
                    console.log(`ğŸ“Œ æ˜ å°„: ${mapKey} -> ${machine.id}/${machine.location}`);
                    
                    // å»ºç«‹å‚™ç”¨æ˜ å°„
                    if (!window.machineConfigMapByMac[machine.mac]) {
                        window.machineConfigMapByMac[machine.mac] = [];
                    }
                    window.machineConfigMapByMac[machine.mac].push(machineInfo);
                    
                    if (!window.machineConfigMapByDevid[machine.devid]) {
                        window.machineConfigMapByDevid[machine.devid] = [];
                    }
                    window.machineConfigMapByDevid[machine.devid].push(machineInfo);
                } else {
                    console.warn(`âš ï¸ æ©Ÿå° ${machine.id}/${machine.location} ç¼ºå°‘å¿…è¦çš„ MAC æˆ– devid è³‡è¨Š`);
                }
            });
            
            console.log(`âœ… å·²æ§‹å»ºæ©Ÿå°é…ç½®æ˜ å°„è¡¨ï¼Œå…± ${Object.keys(window.machineConfigMap).length} æ¢æ˜ å°„`);
            console.log(`ğŸ“Š MAC-only æ˜ å°„: ${Object.keys(window.machineConfigMapByMac).length} å€‹ MAC`);
            console.log(`ğŸ“Š DevID-only æ˜ å°„: ${Object.keys(window.machineConfigMapByDevid).length} å€‹ DevID`);
            console.log('ï¿½ å®Œæ•´æ˜ å°„è¡¨:', window.machineConfigMap);
            console.log('ğŸ” MAC æ˜ å°„è¡¨:', window.machineConfigMapByMac);
            console.log('ğŸ” DevID æ˜ å°„è¡¨:', window.machineConfigMapByDevid);
            return window.machineConfigMap;
        }

        // æ™ºèƒ½æ©Ÿå°é…ç½®æŸ¥æ‰¾å‡½æ•¸ - æ”¯æ´å¤šç¨®æŸ¥æ‰¾ç­–ç•¥
        function findMachineConfig(mac, devid) {
            console.log(`ğŸ” æ™ºèƒ½æŸ¥æ‰¾æ©Ÿå°é…ç½®: MAC=${mac}, DevID=${devid}`);
            
            // ç¢ºä¿æ˜ å°„è¡¨å·²æ§‹å»º
            buildMachineConfigMap();
            
            // ç­–ç•¥1: ç›´æ¥ä½¿ç”¨ MAC_devid æŸ¥æ‰¾
            const primaryKey = `${mac}_${devid}`;
            if (window.machineConfigMap[primaryKey]) {
                console.log(`âœ… [ç­–ç•¥1] ç›´æ¥æŸ¥æ‰¾æˆåŠŸ: ${primaryKey} -> ${window.machineConfigMap[primaryKey].machineId}`);
                return window.machineConfigMap[primaryKey];
            }
            
            // ç­–ç•¥2: å¦‚æœ MAC ç‚º null æˆ– undefinedï¼Œä½¿ç”¨ DevID-only æŸ¥æ‰¾
            if (!mac || mac === 'null' || mac === 'undefined') {
                console.log(`ğŸ”„ [ç­–ç•¥2] MAC ç„¡æ•ˆï¼Œå˜—è©¦ DevID-only æŸ¥æ‰¾: ${devid}`);
                if (window.machineConfigMapByDevid[devid] && window.machineConfigMapByDevid[devid].length > 0) {
                    const config = window.machineConfigMapByDevid[devid][0]; // å–ç¬¬ä¸€å€‹åŒ¹é…
                    console.log(`âœ… [ç­–ç•¥2] DevID æŸ¥æ‰¾æˆåŠŸ: ${devid} -> ${config.machineId}`);
                    if (window.machineConfigMapByDevid[devid].length > 1) {
                        console.warn(`âš ï¸ å¤šå€‹æ©Ÿå°ä½¿ç”¨ç›¸åŒ DevID ${devid}ï¼Œå·²é¸æ“‡ç¬¬ä¸€å€‹: ${config.machineId}`);
                    }
                    return config;
                }
            }
            
            // ç­–ç•¥3: å¦‚æœ DevID ç„¡æ•ˆï¼Œä½¿ç”¨ MAC-only æŸ¥æ‰¾
            if (!devid || devid === 'null' || devid === 'undefined') {
                console.log(`ğŸ”„ [ç­–ç•¥3] DevID ç„¡æ•ˆï¼Œå˜—è©¦ MAC-only æŸ¥æ‰¾: ${mac}`);
                if (window.machineConfigMapByMac[mac] && window.machineConfigMapByMac[mac].length > 0) {
                    const config = window.machineConfigMapByMac[mac][0]; // å–ç¬¬ä¸€å€‹åŒ¹é…
                    console.log(`âœ… [ç­–ç•¥3] MAC æŸ¥æ‰¾æˆåŠŸ: ${mac} -> ${config.machineId}`);
                    if (window.machineConfigMapByMac[mac].length > 1) {
                        console.warn(`âš ï¸ æ©Ÿå° ${mac} æœ‰å¤šå€‹ DevIDï¼Œå·²é¸æ“‡ç¬¬ä¸€å€‹: ${config.devid}`);
                    }
                    return config;
                }
            }
            
            // ç­–ç•¥4: å˜—è©¦æ¨¡ç³ŠåŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å¯«ã€å»é™¤ç©ºæ ¼ï¼‰
            if (mac && devid) {
                const normalizedMac = mac.toString().trim().toLowerCase();
                const normalizedDevid = devid.toString().trim();
                
                console.log(`ğŸ”„ [ç­–ç•¥4] å˜—è©¦æ¨¡ç³ŠåŒ¹é…: ${normalizedMac}_${normalizedDevid}`);
                
                for (const [key, config] of Object.entries(window.machineConfigMap)) {
                    const [keyMac, keyDevid] = key.split('_');
                    if (keyMac && keyDevid && 
                        keyMac.toLowerCase().trim() === normalizedMac && 
                        keyDevid.trim() === normalizedDevid) {
                        console.log(`âœ… [ç­–ç•¥4] æ¨¡ç³ŠåŒ¹é…æˆåŠŸ: ${key} -> ${config.machineId}`);
                        return config;
                    }
                }
            }
            
            // ç­–ç•¥5: æœ€å¾Œå˜—è©¦ - åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åŒ¹é…ä¾›èª¿è©¦
            console.warn(`âŒ æ‰€æœ‰ç­–ç•¥éƒ½å¤±æ•—ï¼Œç„¡æ³•æ‰¾åˆ°æ©Ÿå°é…ç½®`);
            console.log(`ğŸ” å¯ç”¨çš„æ˜ å°„éµ:`, Object.keys(window.machineConfigMap));
            console.log(`ğŸ” å¯ç”¨çš„ MAC:`, Object.keys(window.machineConfigMapByMac));
            console.log(`ğŸ” å¯ç”¨çš„ DevID:`, Object.keys(window.machineConfigMapByDevid));
            console.log(`ğŸ’¡ æŸ¥æ‰¾åƒæ•¸: MAC="${mac}" (type: ${typeof mac}), DevID="${devid}" (type: ${typeof devid})`);
            
            return null;
        }

        // æ¸¬è©¦æ™ºèƒ½æŸ¥æ‰¾åŠŸèƒ½
        function testSmartMachineMapping() {
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ§ª æ¸¬è©¦æ™ºèƒ½æ©Ÿå°æ˜ å°„æŸ¥æ‰¾åŠŸèƒ½');
            console.log('='.repeat(70));
            
            // æ¸¬è©¦æ¡ˆä¾‹
            const testCases = [
                { mac: 'AA:BB:CC:DD:EE:FF', devid: 1, description: 'æ­£å¸¸æŸ¥æ‰¾' },
                { mac: null, devid: 1, description: 'MAC ç‚º null' },
                { mac: 'null', devid: 1, description: "MAC ç‚ºå­—ä¸² 'null'" },
                { mac: 'AA:BB:CC:DD:EE:FF', devid: null, description: 'DevID ç‚º null' },
                { mac: 'AA:BB:CC:DD:EE:FF', devid: 'null', description: "DevID ç‚ºå­—ä¸² 'null'" },
                { mac: null, devid: 2, description: 'åƒ…ä½¿ç”¨ DevID=2 æŸ¥æ‰¾' },
                { mac: 'invalid', devid: 999, description: 'ç„¡æ•ˆçš„ MAC å’Œ DevID' }
            ];
            
            testCases.forEach((testCase, index) => {
                console.log(`\nğŸ“‹ æ¸¬è©¦æ¡ˆä¾‹ ${index + 1}: ${testCase.description}`);
                console.log(`   è¼¸å…¥: MAC="${testCase.mac}", DevID="${testCase.devid}"`);
                
                const result = findMachineConfig(testCase.mac, testCase.devid);
                if (result) {
                    console.log(`   âœ… çµæœ: æ‰¾åˆ°æ©Ÿå° ${result.machineId} (${result.location})`);
                } else {
                    console.log(`   âŒ çµæœ: æœªæ‰¾åˆ°åŒ¹é…çš„æ©Ÿå°`);
                }
            });
            
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ§ª æ™ºèƒ½æ˜ å°„æ¸¬è©¦å®Œæˆ');
            console.log('='.repeat(70));
        }
        
        // å°‡æ¸¬è©¦å‡½æ•¸æ·»åŠ åˆ°å…¨åŸŸç¯„åœ
        window.testSmartMachineMapping = testSmartMachineMapping;
        
        // âœ… è¨ºæ–· MAC + DevID æ˜ å°„é—œä¿‚
        function diagnoseMacDevidMapping() {
            console.log('\n' + '='.repeat(80));
            console.log('ğŸ” MAC + DevID æ˜ å°„é—œä¿‚è¨ºæ–·');
            console.log('='.repeat(80));
            
            // é‡å»ºæ˜ å°„è¡¨
            buildMachineConfigMap();
            
            if (!appData || !appData.machines) {
                console.error('âŒ appData.machines æœªåˆå§‹åŒ–');
                return;
            }
            
            console.log(`\nğŸ“Š æ©Ÿå°ç¸½æ•¸: ${appData.machines.length}`);
            console.log(`ğŸ“Š æ˜ å°„è¡¨è¨˜éŒ„æ•¸: ${Object.keys(window.machineConfigMap || {}).length}\n`);
            
            // å»ºç«‹åˆ†çµ„çµ±è¨ˆ
            const stats = {
                withMacAndDevid: [],
                withMacOnly: [],
                withDevidOnly: [],
                noMacNoDevid: [],
                duplicateMac: {}
            };
            
            // åˆ†ææ¯å°æ©Ÿå°
            appData.machines.forEach((machine, index) => {
                const hasMac = machine.mac && machine.mac.trim();
                const hasDevid = machine.devid || (machine.devidData && Object.keys(machine.devidData).length > 0);
                const hasDevidData = machine.devidData && Object.keys(machine.devidData).length > 0;
                
                console.log(`\nğŸ“± æ©Ÿå° [${index + 1}/${appData.machines.length}]`);
                console.log(`   ç·¨è™Ÿ: ${machine.id}`);
                console.log(`   ä½ç½®: ${machine.location}`);
                console.log(`   MAC: ${machine.mac || 'âŒ æœªè¨­å®š'}`);
                console.log(`   DevID (èˆŠæ¬„ä½): ${machine.devid || 'âŒ æœªè¨­å®š'}`);
                console.log(`   devidData (æ–°çµæ§‹): ${hasDevidData ? JSON.stringify(machine.devidData) : 'âŒ æœªè¨­å®š'}`);
                
                // æª¢æŸ¥æ˜ å°„è¡¨ä¸­çš„è¨˜éŒ„
                if (hasMac) {
                    // æª¢æŸ¥ DevID 1 å’Œ 2
                    for (let devid = 1; devid <= 2; devid++) {
                        const mapKey = `${machine.mac}_${devid}`;
                        const inMap = window.machineConfigMap[mapKey];
                        
                        if (inMap) {
                            console.log(`   âœ… æ˜ å°„è¡¨å­˜åœ¨: ${mapKey} -> ${inMap.machineId}/${inMap.location}`);
                            
                            // é©—è­‰æ˜ å°„æ˜¯å¦æ­£ç¢º
                            if (inMap.machineId !== machine.id || inMap.location !== machine.location) {
                                console.error(`   âŒâŒâŒ æ˜ å°„éŒ¯èª¤ï¼æœŸæœ› ${machine.id}/${machine.location}ï¼Œä½†æ˜ å°„åˆ° ${inMap.machineId}/${inMap.location}`);
                            }
                        } else {
                            console.log(`   âš ï¸ æ˜ å°„è¡¨ç¼ºå¤±: ${mapKey}`);
                        }
                    }
                    
                    // æª¢æŸ¥é‡è¤‡ MAC
                    if (!stats.duplicateMac[machine.mac]) {
                        stats.duplicateMac[machine.mac] = [];
                    }
                    stats.duplicateMac[machine.mac].push({
                        id: machine.id,
                        location: machine.location,
                        devid: machine.devid,
                        devidData: machine.devidData
                    });
                }
                
                // åˆ†é¡çµ±è¨ˆ
                if (hasMac && hasDevid) {
                    stats.withMacAndDevid.push(machine);
                } else if (hasMac && !hasDevid) {
                    stats.withMacOnly.push(machine);
                } else if (!hasMac && hasDevid) {
                    stats.withDevidOnly.push(machine);
                } else {
                    stats.noMacNoDevid.push(machine);
                }
            });
            
            // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
            console.log('\n' + '='.repeat(80));
            console.log('ğŸ“Š çµ±è¨ˆæ‘˜è¦');
            console.log('='.repeat(80));
            console.log(`âœ… MAC + DevID å®Œæ•´: ${stats.withMacAndDevid.length} å°`);
            stats.withMacAndDevid.forEach(m => {
                console.log(`   - ${m.id}/${m.location} (MAC: ${m.mac}, DevID: ${m.devid || 'devidData:' + Object.keys(m.devidData || {}).join(',')})`);
            });
            
            if (stats.withMacOnly.length > 0) {
                console.log(`\nâš ï¸ åªæœ‰ MACï¼Œç¼ºå°‘ DevID: ${stats.withMacOnly.length} å°`);
                stats.withMacOnly.forEach(m => {
                    console.log(`   - ${m.id}/${m.location} (MAC: ${m.mac})`);
                });
            }
            
            if (stats.withDevidOnly.length > 0) {
                console.log(`\nâš ï¸ åªæœ‰ DevIDï¼Œç¼ºå°‘ MAC: ${stats.withDevidOnly.length} å°`);
                stats.withDevidOnly.forEach(m => {
                    console.log(`   - ${m.id}/${m.location} (DevID: ${m.devid})`);
                });
            }
            
            if (stats.noMacNoDevid.length > 0) {
                console.log(`\nâŒ ç¼ºå°‘ MAC å’Œ DevID: ${stats.noMacNoDevid.length} å°`);
                stats.noMacNoDevid.forEach(m => {
                    console.log(`   - ${m.id}/${m.location}`);
                });
            }
            
            // æª¢æŸ¥é‡è¤‡ MAC
            console.log('\n' + '='.repeat(80));
            console.log('ğŸ” é‡è¤‡ MAC æª¢æŸ¥');
            console.log('='.repeat(80));
            Object.entries(stats.duplicateMac).forEach(([mac, machines]) => {
                if (machines.length > 1) {
                    console.log(`\nâš ï¸ MAC ${mac} è¢« ${machines.length} å°æ©Ÿå°ä½¿ç”¨:`);
                    machines.forEach(m => {
                        console.log(`   - ${m.id}/${m.location} (DevID: ${m.devid || 'devidData:' + Object.keys(m.devidData || {}).join(',')})`);
                    });
                    console.log(`   ğŸ’¡ é€™æ˜¯æ­£å¸¸çš„ï¼ä¸€å€‹ MAC å¯ä»¥æœ‰å¤šå€‹ DevID (å·¦å³å¤©è»Š)`);
                }
            });
            
            // é©—è­‰æ˜ å°„è¡¨å®Œæ•´æ€§
            console.log('\n' + '='.repeat(80));
            console.log('ğŸ” æ˜ å°„è¡¨å®Œæ•´æ€§é©—è­‰');
            console.log('='.repeat(80));
            console.log(`ğŸ“Š æ˜ å°„è¡¨ç¸½è¨˜éŒ„: ${Object.keys(window.machineConfigMap || {}).length}`);
            console.log(`ğŸ“Š æœŸæœ›è¨˜éŒ„æ•¸: ${stats.withMacAndDevid.length} (æœ‰ MAC + DevID çš„æ©Ÿå°)`);
            
            // åˆ—å‡ºæ‰€æœ‰æ˜ å°„
            console.log('\nğŸ—ºï¸ å®Œæ•´æ˜ å°„è¡¨:');
            Object.entries(window.machineConfigMap || {}).forEach(([key, config]) => {
                console.log(`   ${key} -> ${config.machineId}/${config.location}`);
            });
            
            console.log('\n' + '='.repeat(80));
            console.log('âœ… è¨ºæ–·å®Œæˆï¼');
            console.log('='.repeat(80));
            
            return stats;
        }
        
        // å°‡è¨ºæ–·å‡½æ•¸æ·»åŠ åˆ°å…¨åŸŸç¯„åœ
        window.diagnoseMacDevidMapping = diagnoseMacDevidMapping;
        
        // âœ… è¨ºæ–·æ ¡æ­£å€¼è¨ˆç®—å•é¡Œ
        function diagnoseCalibrationIssue(machineId, location) {
            console.log('\n' + '='.repeat(80));
            console.log('ğŸ”§ è¨ºæ–·æ ¡æ­£å€¼è¨ˆç®—å•é¡Œ');
            console.log('='.repeat(80));
            
            if (!appData || !appData.machines) {
                console.error('âŒ appData.machines æœªåˆå§‹åŒ–');
                return;
            }
            
            // æŸ¥æ‰¾æ©Ÿå°é…ç½®
            const machine = appData.machines.find(m => 
                m.id === machineId && m.location === location
            );
            
            if (!machine) {
                console.error(`âŒ æ‰¾ä¸åˆ°æ©Ÿå°: ${machineId}/${location}`);
                console.log('ğŸ“‹ å¯ç”¨æ©Ÿå°:');
                appData.machines.forEach(m => {
                    console.log(`   - ${m.id}/${m.location}`);
                });
                return;
            }
            
            console.log(`\nğŸ“± æ©Ÿå°è³‡è¨Š: ${machine.id}/${machine.location}`);
            console.log(`   MAC: ${machine.mac || 'âŒ æœªè¨­å®š'}`);
            console.log(`   DevID: ${machine.devid || 'âŒ æœªè¨­å®š'}`);
            console.log(`   devidData: ${JSON.stringify(machine.devidData || {})}`);
            
            console.log(`\nğŸ”§ æ ¡æ­£å€¼è¨­å®š:`);
            console.log(`   æŠ•å¹£æ ¡æ­£å€¼: ${machine.playsCalibration || 0}`);
            console.log(`   å‡ºè²¨æ ¡æ­£å€¼: ${machine.payoutsCalibration || 0}`);
            
            // æª¢æŸ¥è¼ªè©¢è‡¨æ™‚è¨˜éŒ„
            console.log(`\nğŸ“Š è¼ªè©¢è‡¨æ™‚è¨˜éŒ„:`);
            if (window.dailyRecords) {
                const recordKey = `${machineId}_${location}_${new Date().toISOString().split('T')[0]}`;
                const record = window.dailyRecords[recordKey];
                
                if (record) {
                    console.log(`   âœ… æ‰¾åˆ°è¨˜éŒ„: ${recordKey}`);
                    console.log(`   åŸå§‹å€¼: plays=${record.rawPlays}, payouts=${record.rawPayouts}`);
                    console.log(`   æ ¡æ­£å¾Œ: plays=${record.plays}, payouts=${record.payouts}`);
                    console.log(`   æ ¡æ­£å€¼: playsCalibration=${record.playsCalibration}, payoutsCalibration=${record.payoutsCalibration}`);
                } else {
                    console.log(`   âš ï¸ æ²’æœ‰æ‰¾åˆ°è¨˜éŒ„: ${recordKey}`);
                    console.log(`   ğŸ“‹ å¯ç”¨è¨˜éŒ„:`, Object.keys(window.dailyRecords));
                }
            } else {
                console.log(`   âŒ window.dailyRecords æœªåˆå§‹åŒ–`);
            }
            
            // æª¢æŸ¥ DevID æ•¸æ“š
            console.log(`\nğŸ” DevID æ•¸æ“šæª¢æŸ¥:`);
            if (window.machineDataByDevid) {
                Object.keys(window.machineDataByDevid).forEach(devid => {
                    const data = window.machineDataByDevid[devid];
                    console.log(`   DevID ${devid}: plays=${data.plays}, payouts=${data.payouts}`);
                });
            } else {
                console.log(`   âŒ window.machineDataByDevid æœªåˆå§‹åŒ–`);
            }
            
            // æ¸¬è©¦æ ¡æ­£å€¼è¨ˆç®—
            console.log(`\nğŸ§ª æ¸¬è©¦æ ¡æ­£å€¼è¨ˆç®—:`);
            const testRawPlays = 118;
            const testRawPayouts = 4;
            const testResult = applyMachineCalibration(machineId, location, testRawPlays, testRawPayouts);
            
            console.log(`   è¼¸å…¥: plays=${testRawPlays}, payouts=${testRawPayouts}`);
            console.log(`   çµæœ: plays=${testResult.plays}, payouts=${testResult.payouts}`);
            console.log(`   æ ¡æ­£å€¼: playsCalibration=${testResult.playsCalibration}, payoutsCalibration=${testResult.payoutsCalibration}`);
            
            console.log('\n' + '='.repeat(80));
            console.log('âœ… è¨ºæ–·å®Œæˆï¼');
            console.log('='.repeat(80));
        }
        
        // å°‡è¨ºæ–·å‡½æ•¸æ·»åŠ åˆ°å…¨åŸŸç¯„åœ
        window.diagnoseCalibrationIssue = diagnoseCalibrationIssue;
        
        // æ–°å¢ï¼šèª¿è©¦æ©Ÿå°è¼ªè©¢ç‹€æ…‹å‡½æ•¸
        // æ©Ÿå°é€£ç·šè¨ºæ–·å‡½æ•¸
        function debugMachineConnectivity() {
            console.log('\nğŸ” æ©Ÿå°é€£ç·šç‹€æ…‹è¨ºæ–·');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const machinesWithMac = availableMachines.filter(m => m.mac && m.mac.trim() !== '');
            const failedMachines = [];
            const successfulMachines = [];
            
            machinesWithMac.forEach(machine => {
                // æª¢æŸ¥æœ€è¿‘è¼ªè©¢çµæœ
                const hasRecentData = tempPollingData.some(record => 
                    record.machineId === machine.id && 
                    new Date(record.date).toDateString() === new Date().toDateString()
                );
                
                if (hasRecentData) {
                    successfulMachines.push(machine);
                } else {
                    failedMachines.push(machine);
                }
                
                console.log(`ğŸ“± æ©Ÿå° ${machine.id} (MAC: ${machine.mac})`);
                console.log(`   ğŸ“Š æœ€è¿‘è¼ªè©¢: ${hasRecentData ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
                console.log(`   ğŸ”— æ¸¬è©¦ URL: http://update.feiloli.com.tw:5539/textselectdata/${machine.mac}`);
                console.log(`   ğŸ› ï¸ å»ºè­°å‹•ä½œ: ${hasRecentData ? 'ç„¡éœ€å‹•ä½œ' : 'æª¢æŸ¥æ©Ÿå°ç¶²è·¯é€£ç·šèˆ‡ä¼ºæœå™¨ç‹€æ…‹'}`);
                console.log('');
            });
            
            console.log('ğŸ“Š é€£ç·šçµ±è¨ˆæ‘˜è¦:');
            console.log(`   âœ… æˆåŠŸæ©Ÿå°: ${successfulMachines.length} å°`);
            successfulMachines.forEach(m => console.log(`      - ${m.id} (${m.mac})`));
            console.log(`   âŒ å¤±æ•—æ©Ÿå°: ${failedMachines.length} å°`);
            failedMachines.forEach(m => console.log(`      - ${m.id} (${m.mac})`));
            console.log(`   ğŸ“ˆ æˆåŠŸç‡: ${Math.round((successfulMachines.length / machinesWithMac.length) * 100)}%`);
            
            if (failedMachines.length > 0) {
                console.log('\nğŸ”§ æ•…éšœæ’é™¤å»ºè­°:');
                console.log('1. æª¢æŸ¥å¤±æ•—æ©Ÿå°çš„ç¶²è·¯é€£ç·š');
                console.log('2. ç¢ºèªæ©Ÿå°æ˜¯å¦æ­£å¸¸é–‹æ©Ÿé‹è¡Œ');
                console.log('3. æª¢æŸ¥ update.feiloli.com.tw:5539 ä¼ºæœå™¨ç‹€æ…‹');
                console.log('4. æ‰‹å‹•æ¸¬è©¦æ©Ÿå° URL æ˜¯å¦å¯è¨ªå•');
                console.log('5. æª¢æŸ¥é˜²ç«ç‰†è¨­ç½®æ˜¯å¦é˜»æ“‹é€£ç·š');
            }
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
        }

        function debugMachinePollingStatus() {
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ” èª¿è©¦æ©Ÿå°è¼ªè©¢ç‹€æ…‹');
            console.log('='.repeat(70));
            
            if (!appData || !appData.machines) {
                console.warn('âš ï¸ appData.machines æœªåˆå§‹åŒ–');
                return;
            }
            
            const allMachines = appData.machines;
            const machinesWithMac = allMachines.filter(m => m.mac && m.mac.trim());
            
            console.log(`ğŸ“Š ç¸½æ©Ÿå°æ•¸: ${allMachines.length}`);
            console.log(`ğŸ“Š æœ‰ MAC çš„æ©Ÿå°æ•¸: ${machinesWithMac.length}`);
            console.log(`ğŸ“Š ç„¡ MAC çš„æ©Ÿå°æ•¸: ${allMachines.length - machinesWithMac.length}`);
            
            console.log('\nğŸ“‹ æ‰€æœ‰æ©Ÿå°è©³ç´°ç‹€æ…‹:');
            allMachines.forEach((machine, index) => {
                const hasMac = machine.mac && machine.mac.trim();
                const devid = machine.devid || 1;
                const mapKey = hasMac ? `${machine.mac}_${devid}` : 'N/A';
                const hasMapping = hasMac ? !!window.machineConfigMap[mapKey] : false;
                
                console.log(`   ${index + 1}. ${machine.id}/${machine.location}:`);
                console.log(`      MAC: ${machine.mac || 'N/A'} ${hasMac ? 'âœ…' : 'âŒ'}`);
                console.log(`      DevID: ${devid}`);
                console.log(`      æ˜ å°„éµ: ${mapKey}`);
                console.log(`      æ˜ å°„å­˜åœ¨: ${hasMapping ? 'âœ…' : 'âŒ'}`);
                console.log(`      å¯è¼ªè©¢: ${hasMac ? 'âœ…' : 'âŒ'}`);
            });
            
            console.log('\nğŸ¯ ç„¡æ³•è¼ªè©¢çš„æ©Ÿå°:');
            const unpollableMachines = allMachines.filter(m => !m.mac || !m.mac.trim());
            if (unpollableMachines.length === 0) {
                console.log('   âœ… æ‰€æœ‰æ©Ÿå°éƒ½å¯ä»¥è¼ªè©¢');
            } else {
                unpollableMachines.forEach((machine, index) => {
                    console.log(`   ${index + 1}. ${machine.id}/${machine.location} - åŸå› : ç¼ºå°‘ MAC åœ°å€`);
                });
            }
            
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ” èª¿è©¦å®Œæˆ');
            console.log('='.repeat(70));
        }
        
        // å°‡èª¿è©¦å‡½æ•¸æ·»åŠ åˆ°å…¨åŸŸç¯„åœ
        window.debugMachinePollingStatus = debugMachinePollingStatus;
        window.debugMachineConnectivity = debugMachineConnectivity;
        
        // æŸ¥çœ‹ä»£ç†æˆåŠŸç‡çµ±è¨ˆ
        window.showProxyStats = function() {
            console.log('\nğŸ“Š ä»£ç†æœå‹™æˆåŠŸç‡çµ±è¨ˆ');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            if (Object.keys(proxySuccessStats).length === 0) {
                console.log('ğŸ“ å°šç„¡çµ±è¨ˆè³‡æ–™');
                return;
            }
            
            // æŒ‰æ©Ÿå°åˆ†çµ„çµ±è¨ˆ
            const machineStats = {};
            Object.entries(proxySuccessStats).forEach(([key, stats]) => {
                const [mac, proxyName] = key.split('_');
                if (!machineStats[mac]) machineStats[mac] = {};
                machineStats[mac][proxyName] = {
                    rate: Math.round((stats.success / stats.total) * 100),
                    attempts: stats.total,
                    lastUsed: new Date(stats.lastUsed).toLocaleString()
                };
            });
            
            Object.entries(machineStats).forEach(([mac, proxies]) => {
                console.log(`\nğŸ–¥ï¸ æ©Ÿå° ${mac}:`);
                const sortedProxies = Object.entries(proxies)
                    .sort(([,a], [,b]) => b.rate - a.rate);
                
                sortedProxies.forEach(([proxyName, stats]) => {
                    const emoji = stats.rate >= 80 ? 'ğŸŸ¢' : stats.rate >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
                    console.log(`   ${emoji} ${proxyName}: ${stats.rate}% (${stats.attempts} æ¬¡å˜—è©¦)`);
                });
            });
            
            console.log('\nğŸ“ˆ ç¸½é«”ä»£ç†æ’å:');
            const globalStats = {};
            Object.entries(proxySuccessStats).forEach(([key, stats]) => {
                const proxyName = key.split('_')[1];
                if (!globalStats[proxyName]) {
                    globalStats[proxyName] = { success: 0, total: 0 };
                }
                globalStats[proxyName].success += stats.success;
                globalStats[proxyName].total += stats.total;
            });
            
            Object.entries(globalStats)
                .map(([name, stats]) => ({
                    name,
                    rate: (stats.success / stats.total) * 100,
                    total: stats.total
                }))
                .sort((a, b) => b.rate - a.rate)
                .forEach((proxy, index) => {
                    const emoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ“Š';
                    console.log(`   ${emoji} ${proxy.name}: ${Math.round(proxy.rate)}% (${proxy.total} æ¬¡)`);
                });
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
        };
        
        // æ‰‹å‹•æ¸¬è©¦å–®ä¸€æ©Ÿå°é€£ç·š
        window.testMachineConnection = async function(macAddress) {
            if (!macAddress) {
                console.log('ä½¿ç”¨æ–¹æ³•: testMachineConnection("MACåœ°å€")');
                console.log('ä¾‹å¦‚: testMachineConnection("48E729540E3D")');
                return;
            }
            
            console.log(`\nğŸ” æ¸¬è©¦æ©Ÿå°é€£ç·š: ${macAddress}`);
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            const testUrl = `http://update.feiloli.com.tw:5539/textselectdata/${macAddress}`;
            console.log(`ğŸ“¡ ç›®æ¨™ URL: ${testUrl}`);
            
            try {
                console.log('â³ é–‹å§‹æ¸¬è©¦...');
                const result = await sendHttpRequest(testUrl, 10000, macAddress, 1);
                
                if (result && Array.isArray(result) && result.length > 0) {
                    console.log('âœ… é€£ç·šæ¸¬è©¦æˆåŠŸ!');
                    console.log(`ğŸ“Š å›æ‡‰æ•¸æ“š: ${result.length} ç­†è¨˜éŒ„`);
                    console.log('ğŸ“‹ æœ€æ–°è¨˜éŒ„é è¦½:', result.slice(0, 3));
                } else {
                    console.log('âš ï¸ é€£ç·šæˆåŠŸä½†ç„¡æœ‰æ•ˆæ•¸æ“š');
                }
            } catch (error) {
                console.log('âŒ é€£ç·šæ¸¬è©¦å¤±æ•—:', error.message);
                console.log('ğŸ”§ å»ºè­°æª¢æŸ¥:');
                console.log('   1. æ©Ÿå°æ˜¯å¦åœ¨ç·š');
                console.log('   2. MAC åœ°å€æ˜¯å¦æ­£ç¢º');
                console.log('   3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸');
            }
            
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');
        };

        // èª¿è©¦æ©Ÿå°æ˜ å°„è¡¨å‡½æ•¸
        function debugMachineMapping() {
            console.log('ğŸ” ===== æ©Ÿå°æ˜ å°„èª¿è©¦è³‡è¨Š =====');
            
            // 1. é¡¯ç¤ºåŸå§‹æ©Ÿå°è³‡æ–™
            if (appData && appData.machines) {
                console.log(`ğŸ“‹ å…±æœ‰ ${appData.machines.length} å°æ©Ÿå°:`);
                appData.machines.forEach((machine, index) => {
                    console.log(`[${index}] ${machine.id}/${machine.location}:`, {
                        docId: machine.docId,
                        mac: machine.mac,
                        devid: machine.devid,
                        hasDevidData: !!machine.devidData,
                        devidDataKeys: machine.devidData ? Object.keys(machine.devidData) : []
                    });
                });
            } else {
                console.warn('âš ï¸ appData.machines æœªåˆå§‹åŒ–');
            }
            
            // 2. é‡å»ºä¸¦é¡¯ç¤ºæ˜ å°„è¡¨
            window.machineConfigMap = null; // å¼·åˆ¶é‡å»º
            buildMachineConfigMap();
            
            // 3. é¡¯ç¤ºè¼ªè©¢è³‡æ–™ç‹€æ…‹
            if (window.dailyRecords) {
                const recordCount = Object.keys(window.dailyRecords).length;
                console.log(`ğŸ“Š è¼ªè©¢è¨˜éŒ„æ•¸é‡: ${recordCount}`);
                Object.entries(window.dailyRecords).forEach(([key, record]) => {
                    console.log(`è¨˜éŒ„: ${key} -> ${record.machineId}/${record.location} (æŠ•å¹£: ${record.plays}, å‡ºè²¨: ${record.payouts})`);
                });
            } else {
                console.log('ğŸ“Š è¼ªè©¢è¨˜éŒ„: ç„¡');
            }
            
            // 4. æª¢æŸ¥æ˜ å°„ç¼ºå¤±
            const allDevids = new Set();
            if (appData && appData.machines) {
                appData.machines.forEach(machine => {
                    if (machine.mac) {
                        if (machine.devidData) {
                            Object.keys(machine.devidData).forEach(devid => {
                                allDevids.add(`${machine.mac}_${devid}`);
                            });
                        } else if (machine.devid) {
                            allDevids.add(`${machine.mac}_${machine.devid}`);
                        }
                    }
                });
            }
            
            console.log(`ğŸ” é æœŸçš„æ˜ å°„æ•¸é‡: ${allDevids.size}`);
            console.log(`ğŸ” å¯¦éš›çš„æ˜ å°„æ•¸é‡: ${window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0}`);
            
            if (allDevids.size !== (window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0)) {
                console.warn('âš ï¸ æ˜ å°„æ•¸é‡ä¸ç¬¦ï¼å¯èƒ½æœ‰é…ç½®å•é¡Œ');
            }
            
            // 5. é¡¯ç¤ºæ‘˜è¦
            alert(`èª¿è©¦å®Œæˆï¼\næ©Ÿå°æ•¸é‡: ${appData?.machines?.length || 0}\næ˜ å°„æ•¸é‡: ${window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0}\nè¼ªè©¢è¨˜éŒ„: ${window.dailyRecords ? Object.keys(window.dailyRecords).length : 0}\n\nè©³ç´°è³‡è¨Šè«‹æŸ¥çœ‹æ§åˆ¶å°è¼¸å‡º`);
        }
        
        // åˆ·æ–°è‡ªå‹•è¨˜å¸³è¡¨æ ¼ - å¢å¼·ç‰ˆæœ¬ï¼Œé¡¯ç¤ºè©³ç´°çš„è®Šæ›´ä¿¡æ¯
        function refreshAutoRecordTable() {
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°è‡ªå‹•è¨˜å¸³è¡¨æ ¼');
                return;
            }
            
            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¨˜éŒ„
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">æš«ç„¡è¨˜éŒ„</td></tr>';
                return;
            }
            
            // ğŸ”§ éæ¿¾åªé¡¯ç¤ºç•¶å‰é–€å¸‚çš„è¨˜éŒ„
            // å–å¾—ç•¶å‰é–€å¸‚çš„æ‰€æœ‰æ©Ÿå° ID
            const currentMachineIds = new Set();
            if (appData && appData.machines) {
                appData.machines.forEach(machine => {
                    if (machine.id) {
                        currentMachineIds.add(machine.id);
                    }
                });
            }
            
            console.log(`ğŸ” ç•¶å‰é–€å¸‚æ©Ÿå°: ${Array.from(currentMachineIds).join(', ')}`);
            
            // éæ¿¾å‡ºç•¶å‰é–€å¸‚çš„è¨˜éŒ„
            const currentStoreRecords = Object.values(window.dailyRecords)
                .filter(record => currentMachineIds.has(record.machineId));
            
            console.log(`ğŸ“Š å…¨éƒ¨è¨˜éŒ„: ${Object.keys(window.dailyRecords).length} ç­†`);
            console.log(`ğŸ“Š ç•¶å‰é–€å¸‚è¨˜éŒ„: ${currentStoreRecords.length} ç­†`);
            
            if (currentStoreRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">æ­¤é–€å¸‚æš«ç„¡è¨˜éŒ„</td></tr>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºè¨˜éŒ„
            const sortedRecords = currentStoreRecords.sort((a, b) => {
                    // å…ˆæŒ‰æ—¥æœŸé™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                    const dateCompare = new Date(b.date) - new Date(a.date);
                    if (dateCompare !== 0) return dateCompare;
                    // ç›¸åŒæ—¥æœŸæŒ‰æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®æ’åº
                    if (a.machineId !== b.machineId) {
                        return a.machineId.localeCompare(b.machineId);
                    }
                    return a.location.localeCompare(b.location);
                });
            
            // å¡«å……è¡¨æ ¼
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // âœ… æ–°å¢ï¼šè®Šæ›´ç‹€æ…‹æŒ‡ç¤º
                let changeIndicator = '';
                if (record.updateCount > 1) {
                    // æ ¹æ“šæ˜¯å¦æŠ•å¹£æ¬¡æ•¸æˆ–å‡ºè²¨æ•¸é‡æœ‰è®ŠåŒ–ä¾†é¡¯ç¤ºä¸åŒçš„æŒ‡ç¤ºç¬¦
                    const playsStatus = record.playsChanged ? 'ğŸ’°' : '';
                    const payoutsStatus = record.payoutsChanged ? 'ï¿½' : '';
                    changeIndicator = `ğŸ”„ ${playsStatus}${payoutsStatus}`;
                } else {
                    changeIndicator = 'âœ¨';
                }
                
                const machineLabel = `${record.machineId} / ${record.location}`;
                
                // âœ… æ–°å¢ï¼šè®Šæ›´å€¼é¡¯ç¤ºï¼ˆå¦‚æœæœ‰è®ŠåŒ–ï¼‰
                let changeInfo = '';
                if (record.history && record.history.length > 1) {
                    // ç²å–æœ€å¾Œä¸€æ¬¡è®ŠåŒ–çš„è¨˜éŒ„ï¼ˆæœ€æ–°çš„æ›´æ–°ï¼‰
                    const lastHistory = record.history[record.history.length - 1];
                    const prevHistory = record.history[record.history.length - 2];
                    
                    changeInfo = '<br/><small style="color: #9ca3af; font-size: 0.75rem;">';
                    if (lastHistory.playsChanged && lastHistory.playsDelta !== undefined) {
                        changeInfo += `ğŸ’° æŠ•å¹£: +${lastHistory.playsDelta} `;
                    }
                    if (lastHistory.payoutsChanged && lastHistory.payoutsDelta !== undefined) {
                        changeInfo += `ğŸ“¦ å‡ºè²¨: +${lastHistory.payoutsDelta}`;
                    }
                    changeInfo += '</small>';
                }
                
                // ğŸ”§ æ‡‰ç”¨æ ¡æ­£å€¼è¨ˆç®—é¡¯ç¤ºæ•¸å€¼
                const calibratedData = applyMachineCalibration(record.machineId, record.location, record.plays, record.payouts);
                
                // é¡¯ç¤ºæ ¡æ­£å¾Œçš„æ•¸å€¼ï¼Œå¦‚æœæœ‰æ ¡æ­£å‰‡é¡¯ç¤ºæç¤º
                let playsDisplay = `${calibratedData.plays.toLocaleString()}`;
                let payoutsDisplay = `${calibratedData.payouts.toLocaleString()}`;
                
                if (calibratedData.playsCalibration !== 0) {
                    playsDisplay += ` <small style="color: #fbbf24; font-size: 0.7rem;" title="åŸå§‹å€¼: ${record.plays}">ğŸ“Š</small>`;
                }
                if (calibratedData.payoutsCalibration !== 0) {
                    payoutsDisplay += ` <small style="color: #fbbf24; font-size: 0.7rem;" title="åŸå§‹å€¼: ${record.payouts}">ğŸ“Š</small>`;
                }
                
                row.innerHTML = `
                    <td class="p-4">${record.date}</td>
                    <td class="p-4 font-semibold text-blue-400">${machineLabel}</td>
                    <td class="p-4 text-right font-semibold text-blue-300">${playsDisplay}</td>
                    <td class="p-4 text-right font-semibold text-green-300">${payoutsDisplay}</td>
                    <td class="p-4 text-center">${changeIndicator} ${record.updateCount}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.updatedAt}${changeInfo}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.createdAt}</td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log(`âœ… å·²åˆ·æ–°è‡ªå‹•è¨˜å¸³è¡¨æ ¼ï¼Œå…± ${sortedRecords.length} ç­†è¨˜éŒ„`);
        }
        
        // å»ºç«‹ devid èˆ‡æ©Ÿå°çš„æ˜ å°„é—œä¿‚
        function buildDevidMachineMap() {
            if (!window.devidMachineMap) {
                window.devidMachineMap = {
                    1: { label: 'å·¦å¤©è»Š', machineId: 'A001', location: 'ä¸Š1' },
                    2: { label: 'å³å¤©è»Š', machineId: 'A001', location: 'ä¸Š2' }
                };
            }
            return window.devidMachineMap;
        }
        
        // å¾è¼ªè©¢å¸¶å…¥æ•¸æ“šåˆ°è¡¨å–®
        function importFromPoll() {
            console.log('ğŸ“¥ å¾è¼ªè©¢å¸¶å…¥æ•¸æ“š...');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¼ªè©¢æ•¸æ“š
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('âŒ æš«ç„¡è¼ªè©¢æ•¸æ“šï¼Œè«‹å…ˆé€²è¡Œè¼ªè©¢');
                return;
            }
            
            // å»ºæ§‹å‹•æ…‹æ©Ÿå°æ˜ å°„
            buildMachineConfigMap();
            
            // âœ… ä¿®æ­£ï¼šä¸å¼·åˆ¶ä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸï¼Œè€Œæ˜¯æŸ¥æ‰¾æ‰€æœ‰å¯ç”¨çš„è¼ªè©¢è¨˜éŒ„
            console.log(`ğŸ“Š æ‰¾åˆ° ${Object.keys(window.dailyRecords).length} ç­†è¼ªè©¢è¨˜éŒ„`);
            
            // æŸ¥æ‰¾ç¬¬ä¸€å€‹å¯ç”¨çš„è¨˜éŒ„ï¼ˆä¸é™åˆ¶æ—¥æœŸï¼‰
            let selectedRecord = null;
            let selectedMachine = null;
            
            if (appData && appData.machines) {
                for (let [recordKey, record] of Object.entries(window.dailyRecords)) {
                    // å¾ recordKey è§£ææ©Ÿå°ä¿¡æ¯ (æ ¼å¼: machineId_location_date)
                    const parts = recordKey.split('_');
                    const recordDate = parts.pop(); // å–å¾—æ—¥æœŸ
                    const recordLocation = parts.pop(); // å–å¾—ä½ç½®
                    const recordMachineId = parts.join('_'); // å‰©ä¸‹çš„å°±æ˜¯æ©Ÿå°ID
                    
                    // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°
                    const machine = appData.machines.find(m => 
                        m.id === recordMachineId && m.location === recordLocation
                    );
                    
                    if (machine) {
                        selectedRecord = record;
                        selectedMachine = machine;
                        console.log(`âœ… æ‰¾åˆ°è¼ªè©¢è¨˜éŒ„: ${recordKey} (æ—¥æœŸ: ${recordDate})`, selectedRecord);
                        break;
                    }
                }
            }
            
            if (!selectedRecord || !selectedMachine) {
                alert('âŒ æ‰¾ä¸åˆ°å¯ç”¨çš„è¼ªè©¢è¨˜éŒ„');
                return;
            }
            
            // å¡«å…¥è¡¨å–®
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            
            // å¡«å…¥æ—¥æœŸï¼ˆä½¿ç”¨è¼ªè©¢è¨˜éŒ„çš„å¯¦éš›æ—¥æœŸï¼‰
            if (entryDate) {
                entryDate.value = selectedRecord.date;
            }
            
            // ğŸ”§ æ‡‰ç”¨æ ¡æ­£å€¼ä¸¦å¡«å…¥æŠ•å¹£æ•¸å’Œå‡ºçæ•¸
            const calibratedData = applyMachineCalibration(selectedRecord.machineId, selectedRecord.location, selectedRecord.plays, selectedRecord.payouts);
            
            if (cumulativePlays) {
                cumulativePlays.value = calibratedData.plays;
                console.log(`ğŸ”§ æŠ•å¹£æ•¸å€¼: åŸå§‹=${selectedRecord.plays} â†’ æ ¡æ­£å¾Œ=${calibratedData.plays} (æ ¡æ­£å€¼: ${calibratedData.playsCalibration})`);
            }
            if (cumulativePayouts) {
                cumulativePayouts.value = calibratedData.payouts;
                console.log(`ğŸ”§ å‡ºè²¨æ•¸å€¼: åŸå§‹=${selectedRecord.payouts} â†’ æ ¡æ­£å¾Œ=${calibratedData.payouts} (æ ¡æ­£å€¼: ${calibratedData.payoutsCalibration})`);
            }
            
            // é¸æ“‡æ©Ÿå°ï¼ˆä½¿ç”¨ docIdï¼‰
            if (machineSelector && selectedMachine) {
                machineSelector.value = selectedMachine.docId;
                console.log(`âœ… å·²é¸æ“‡æ©Ÿå°: ${selectedMachine.id}/${selectedMachine.location} (docId: ${selectedMachine.docId})`);
            }
            
            console.log(`âœ… å·²å¸¶å…¥è¼ªè©¢æ•¸æ“š: ${selectedRecord.machineId}/${selectedRecord.location}, æ—¥æœŸ=${selectedRecord.date}, plays=${selectedRecord.plays}, payouts=${selectedRecord.payouts}`);
            
            // è§¸ç™¼è¡¨å–®æäº¤ï¼ˆä½¿ç”¨è¼ªè©¢è¨˜éŒ„çš„å¯¦éš›æ—¥æœŸï¼‰
            const dailyEntryForm = document.getElementById('daily-entry-form');
            if (dailyEntryForm) {
                dailyEntryForm.dispatchEvent(new Event('submit'));
                console.log('ğŸ“ å·²è§¸ç™¼è¡¨å–®æäº¤');
            }
        }
        
        // æ‰¹é‡æ–°å¢æ‰€æœ‰æ©Ÿå°è¨˜éŒ„ - ç„¡é™åˆ¶ç‰ˆæœ¬ï¼Œæ”¯æŒå¤§é‡æ•¸æ“šè™•ç†
        async function batchAddAllMachines() {
            console.log('âœ… æ‰¹é‡æ–°å¢æ‰€æœ‰æ©Ÿå°è¨˜éŒ„ (ç„¡é™åˆ¶ç‰ˆæœ¬)...');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¼ªè©¢æ•¸æ“š
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('âŒ æš«ç„¡è¼ªè©¢æ•¸æ“šï¼Œè«‹å…ˆé€²è¡Œè¼ªè©¢');
                return;
            }
            
            // æª¢æŸ¥ appData å’Œ machines
            if (!appData || !appData.machines || appData.machines.length === 0) {
                alert('âŒ æ²’æœ‰å¯ç”¨çš„æ©Ÿå°åˆ—è¡¨');
                return;
            }
            
            const machineSelector = document.getElementById('machine-selector');
            const dailyEntryForm = document.getElementById('daily-entry-form');
            
            if (!dailyEntryForm) {
                alert('âŒ æ‰¾ä¸åˆ°è¡¨å–®');
                return;
            }
            
            // å»ºæ§‹å‹•æ…‹æ©Ÿå°æ˜ å°„
            buildMachineConfigMap();
            
            // ğŸš€ ç„¡é™åˆ¶è™•ç†æ‰€æœ‰è¼ªè©¢è¨˜éŒ„
            const allRecords = Object.entries(window.dailyRecords);
            const totalRecords = allRecords.length;
            
            console.log(`ğŸ“Š æº–å‚™è™•ç† ${totalRecords} ç­†è¼ªè©¢è¨˜éŒ„ (ç„¡æ•¸é‡é™åˆ¶)`);
            
            let newCount = 0;      // âœ… æ–°å¢çš„æ©Ÿå°è¨˜éŒ„æ•¸
            let updateCount = 0;   // âœ… æ›´æ–°çš„æ©Ÿå°è¨˜éŒ„æ•¸
            let unchangedCount = 0; // âœ… æ²’æœ‰è®ŠåŒ–çš„æ©Ÿå°è¨˜éŒ„æ•¸
            let failedCount = 0;
            
            // çµ±è¨ˆä¿¡æ¯
            const summaryInfo = {
                new: [],      // æ–°å¢çš„æ©Ÿå°
                updated: [],  // æ›´æ–°çš„æ©Ÿå°ï¼ˆæœ‰è®ŠåŒ–ï¼‰
                unchanged: [] // æ²’æœ‰è®ŠåŒ–çš„æ©Ÿå°
            };
            
            // ğŸ”„ åˆ†æ‰¹è™•ç†ï¼Œé¿å…ä¸€æ¬¡æ€§è™•ç†å¤ªå¤šé€ æˆæ•ˆèƒ½å•é¡Œ
            const batchSize = window.batchProcessingSize || 50; // å¯è‡ªå®šç¾©æ‰¹æ¬¡å¤§å°
            let processedCount = 0;
            
            // ğŸš€ åˆ†æ‰¹è™•ç†æ‰€æœ‰è¼ªè©¢è¨˜éŒ„ï¼ˆç„¡æ•¸é‡é™åˆ¶ï¼‰
            for (let i = 0; i < allRecords.length; i += batchSize) {
                const batch = allRecords.slice(i, i + batchSize);
                const batchNumber = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(allRecords.length / batchSize);
                
                console.log(`ğŸ”„ è™•ç†ç¬¬ ${batchNumber}/${totalBatches} æ‰¹ï¼Œå…± ${batch.length} ç­†è¨˜éŒ„`);
                
                for (let [recordKey, record] of batch) {
                    try {
                        processedCount++;
                        console.log(`ğŸ”„ [${processedCount}/${totalRecords}] è™•ç†è¼ªè©¢è¨˜éŒ„: ${recordKey}`);
                        console.log(`ğŸ“Š è¼ªè©¢è¨˜éŒ„è©³æƒ…:`, {
                            machineId: record.machineId,
                            location: record.location,
                            plays: record.plays,
                            payouts: record.payouts,
                            rawPlays: record.rawPlays,
                            rawPayouts: record.rawPayouts,
                            updateCount: record.updateCount,
                            lastPlays: record.lastPlays,
                            lastPayouts: record.lastPayouts
                        });
                        
                        // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°
                        const machine = appData.machines.find(m => 
                            m.id === record.machineId && m.location === record.location
                        );
                        
                        if (!machine) {
                            console.warn(`âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰æ©Ÿå°: ${record.machineId}/${record.location}`);
                            failedCount++;
                            continue;
                        }
                        
                        console.log(`âœ… æ‰¾åˆ°æ©Ÿå°: ${machine.id}/${machine.location} (æ—¥æœŸ: ${record.date})`);
                        
                        // é©—è­‰é¸æ“‡å™¨ä¸­æ˜¯å¦å­˜åœ¨æ­¤æ©Ÿå°
                        const options = Array.from(machineSelector.options);
                        const hasOption = options.some(opt => opt.value === machine.docId);
                        
                        if (!hasOption) {
                            console.warn(`âš ï¸ æ©Ÿå°é¸æ“‡å™¨ä¸­æ‰¾ä¸åˆ° docId=${machine.docId}ï¼Œè·³é`);
                            failedCount++;
                            continue;
                        }
                        
                        // é¸æ“‡æ©Ÿå°ï¼ˆä½¿ç”¨ docIdï¼‰
                        machineSelector.value = machine.docId;
                        
                        // è§¸ç™¼ change äº‹ä»¶ä»¥è‡ªå‹•å¡«å…¥æŠ•å¹£æ•¸å’Œå‡ºçæ•¸
                        machineSelector.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        console.log(`âœ… å·²è¨­ç½®é¸æ“‡å™¨: docId=${machine.docId}, value=${machineSelector.value}`);
                        
                        // é©—è­‰é¸æ“‡æ˜¯å¦æˆåŠŸ
                        if (machineSelector.value !== machine.docId) {
                            console.error(`âŒ è¨­ç½®é¸æ“‡å™¨å¤±æ•—: æœŸæœ›=${machine.docId}, å¯¦éš›=${machineSelector.value}`);
                            failedCount++;
                            continue;
                        }
                        
                        // âœ… å¡«å…¥è¡¨å–®æ•¸æ“š
                        const entryDate = document.getElementById('entry-date');
                        const cumulativePlays = document.getElementById('cumulative-plays');
                        const cumulativePayouts = document.getElementById('cumulative-payouts');
                        
                        // è¨­ç½®è¼ªè©¢è¨˜éŒ„çš„å¯¦éš›æ—¥æœŸï¼ˆé‡è¦ï¼šä¸å¼·åˆ¶ä½¿ç”¨ä»Šå¤©ï¼‰
                        if (entryDate) {
                            entryDate.value = record.date;
                        }
                        
                        // è¨­ç½®ç´¯ç©æ•¸å€¼
                        if (cumulativePlays) {
                            cumulativePlays.value = record.plays;
                        }
                        if (cumulativePayouts) {
                            cumulativePayouts.value = record.payouts;
                        }
                        
                        console.log(`ğŸ“‹ è¡¨å–®å·²å¡«å…¥ (ä½¿ç”¨è¨˜éŒ„æ—¥æœŸ):`, {
                            date: entryDate.value,
                            machineDocId: machineSelector.value,
                            plays: cumulativePlays.value,
                            payouts: cumulativePayouts.value,
                            recordDate: record.date // é¡¯ç¤ºä½¿ç”¨çš„æ˜¯è¨˜éŒ„çš„æ—¥æœŸ
                        });
                        
                        // ğŸ”§ é‡æ¸…æ•¸å€¼å«ç¾©ï¼Œç¢ºä¿æ•¸æ“šé¡å‹æ­£ç¢º
                        const currentMachinePlays = parseInt(machine.plays) || 0;     // è³‡æ–™åº«ä¸­ç›®å‰çš„ç´¯ç©å€¼
                        const currentMachinePayouts = parseInt(machine.payouts) || 0; // è³‡æ–™åº«ä¸­ç›®å‰çš„ç´¯ç©å€¼
                        
                        // ğŸ”§ é‡æ–°å¾æœ€æ–°çš„è¼ªè©¢è¨˜éŒ„ä¸­ç²å–æ•¸å€¼
                        const latestRecord = window.dailyRecords[recordKey];
                        
                        // âœ… é—œéµä¿®å¾©ï¼šrecord.plays å’Œ record.payouts å·²ç¶“æ˜¯æ ¡æ­£å¾Œçš„å€¼
                        // ä¸éœ€è¦å†æ¬¡æ‡‰ç”¨æ ¡æ­£ï¼Œé¿å…é›™é‡æ ¡æ­£å•é¡Œ
                        const polledPlays = parseInt(latestRecord?.plays || record.plays);      // å·²æ ¡æ­£çš„ç´¯ç©å€¼
                        const polledPayouts = parseInt(latestRecord?.payouts || record.payouts); // å·²æ ¡æ­£çš„ç´¯ç©å€¼
                        
                        console.log(`âœ… ä½¿ç”¨å·²æ ¡æ­£çš„è¼ªè©¢å€¼ (é¿å…é›™é‡æ ¡æ­£):`, {
                            machineId: `${machine.id}/${machine.location}`,
                            å·²æ ¡æ­£æŠ•å¹£: polledPlays,
                            å·²æ ¡æ­£å‡ºè²¨: polledPayouts,
                            åŸå§‹å€¼: { rawPlays: record.rawPlays, rawPayouts: record.rawPayouts },
                            æ ¡æ­£é‡: { playsCalibration: record.playsCalibration, payoutsCalibration: record.payoutsCalibration }
                        });
                        

                        
                        console.log(`ğŸ”„ æ•¸å€¼ç¢ºèª:`, {
                            machineId: `${machine.id}/${machine.location}`,
                            currentMachinePlays: currentMachinePlays,
                            currentMachinePayouts: currentMachinePayouts,
                            polledPlays: polledPlays,
                            polledPayouts: polledPayouts,
                            shouldUpdate: polledPlays > currentMachinePlays || polledPayouts > currentMachinePayouts
                        });
                        
                        // ğŸ”§ æ±ºå®šæ­£ç¢ºçš„æ›´æ–°æ–¹å‘ï¼šè¼ªè©¢å€¼æ‡‰è©² >= è³‡æ–™åº«å€¼
                        const beforePlays = currentMachinePlays;
                        const afterPlays = Math.max(currentMachinePlays, polledPlays); // å–è¼ƒå¤§å€¼
                        const beforePayouts = currentMachinePayouts;
                        const afterPayouts = Math.max(currentMachinePayouts, polledPayouts); // å–è¼ƒå¤§å€¼
                        
                        console.log(`ğŸ”§ æ›´æ–°è¨ˆç®—è©³æƒ…:`, {
                            machineId: `${machine.id}/${machine.location}`,
                            'è³‡æ–™åº«å€¼': { plays: currentMachinePlays, payouts: currentMachinePayouts },
                            'è¼ªè©¢å€¼': { plays: polledPlays, payouts: polledPayouts },
                            'è¨ˆç®—å‰': { plays: `max(${currentMachinePlays}, ${polledPlays})`, payouts: `max(${currentMachinePayouts}, ${polledPayouts})` },
                            'è¨ˆç®—å¾Œ': { plays: afterPlays, payouts: afterPayouts },
                            'æœ‰è®ŠåŒ–': { plays: afterPlays !== beforePlays, payouts: afterPayouts !== beforePayouts }
                        });
                        
                        // âœ… æ ¹æ“šæ˜¯å¦æœ‰è®ŠåŒ–ä¾†æ±ºå®šæ“ä½œé¡å‹
                        if (record.updateCount > 1) {
                            console.log(`ğŸ”„ æª¢æ¸¬åˆ°è®ŠåŒ– - æŠ•å¹£æ•¸è®ŠåŒ–: ${record.playsChanged}, å‡ºè²¨æ•¸é‡è®ŠåŒ–: ${record.payoutsChanged}`);
                            updateCount++;
                            summaryInfo.updated.push({
                                id: machine.id,
                                location: machine.location,
                                date: record.date,
                                beforePlays: beforePlays,
                                afterPlays: afterPlays,
                                beforePayouts: beforePayouts,
                                afterPayouts: afterPayouts,
                                playsChanged: record.playsChanged,
                                payoutsChanged: record.payoutsChanged,
                                playsChange: afterPlays - beforePlays,
                                payoutsChange: afterPayouts - beforePayouts
                            });
                        } else {
                            console.log(`âœ¨ æ–°å¢è¨˜éŒ„ - æ©Ÿå°: ${machine.id}/${machine.location}, æ—¥æœŸ: ${record.date}`);
                            newCount++;
                            summaryInfo.new.push({
                                id: machine.id,
                                location: machine.location,
                                date: record.date,
                                beforePlays: beforePlays,
                                afterPlays: afterPlays,
                                beforePayouts: beforePayouts,
                                afterPayouts: afterPayouts,
                                playsChange: afterPlays - beforePlays,
                                payoutsChange: afterPayouts - beforePayouts
                            });
                        }
                        
                        // ç›´æ¥åŸ·è¡Œè³‡æ–™åº«æ“ä½œï¼ˆä¸ä½¿ç”¨è¡¨å–®æäº¤ï¼‰
                        try {
                            console.log(`ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸:`, {
                                selectedGroupId,
                                selectedStoreId,
                                machineDocId: machine.docId,
                                recordKey,
                                recordDate: record.date
                            });
                            
                            if (!selectedStoreId) {
                                throw new Error('æœªé¸æ“‡é–€å¸‚');
                            }
                            
                            if (!selectedGroupId) {
                                throw new Error('æœªé¸æ“‡ç¾¤çµ„');
                            }
                            
                            // è¨ˆç®—åŸºæº–å€¼å’Œæ—¥å¢é‡
                            console.log(`ğŸ”¢ æ©Ÿå°åŸå§‹æ•¸æ“š:`, {
                                machineId: `${machine.id}/${machine.location}`,
                                machinePlays: machine.plays,
                                machinePayouts: machine.payouts,
                                machineInitialPlays: machine.initialPlays,
                                machineInitialPayouts: machine.initialPayouts
                            });
                            
                            const lastRecordedPlays = normalizeCount(machine.plays);
                            const lastRecordedPayouts = normalizeCount(machine.payouts);
                            const initialPlays = normalizeCount(machine.initialPlays);
                            const initialPayouts = normalizeCount(machine.initialPayouts);
                            const baselinePlays = Math.max(lastRecordedPlays, initialPlays);
                            const baselinePayouts = Math.max(lastRecordedPayouts, initialPayouts);
                            
                            // ä½¿ç”¨æ›´æ–°å¾Œçš„æ•¸å€¼é€²è¡Œè³‡æ–™åº«æ“ä½œ
                            const cumulativePlaysInput = afterPlays;
                            const cumulativePayoutsInput = afterPayouts;
                            
                            if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                                throw new Error(`è¼ªè©¢æ•¸æ“šæ ¼å¼éŒ¯èª¤: plays=${record.plays}, payouts=${record.payouts}`);
                            }
                            
                            if (cumulativePlaysInput < baselinePlays || cumulativePayoutsInput < baselinePayouts) {
                                const errorMsg = `ç´¯ç©æ•¸å€¼ä¸å¯å°æ–¼åŸºæº–å€¼ - æ©Ÿå°:${machine.id}/${machine.location}, è¼ªè©¢å€¼:(${cumulativePlaysInput}, ${cumulativePayoutsInput}), åŸºæº–å€¼:(${baselinePlays}, ${baselinePayouts})`;
                                console.error('âŒ æ•¸æ“šé©—è­‰å¤±æ•—:', errorMsg);
                                throw new Error(errorMsg);
                            }
                            
                            const dailyPlays = cumulativePlaysInput - baselinePlays;
                            const dailyPayouts = cumulativePayoutsInput - baselinePayouts;
                            
                            console.log(`ğŸ“Š æ•¸æ“šè¨ˆç®—çµæœ:`, {
                                machineId: `${machine.id}/${machine.location}`,
                                lastRecordedPlays,
                                lastRecordedPayouts,
                                initialPlays,
                                initialPayouts,
                                baselinePlays,
                                baselinePayouts,
                                cumulativePlaysInput,
                                cumulativePayoutsInput,
                                dailyPlays,
                                dailyPayouts
                            });
                            
                            // å¦‚æœæ²’æœ‰è®ŠåŒ–ï¼Œè·³éè™•ç†
                            if (dailyPlays === 0 && dailyPayouts === 0) {
                                console.log(`â­ï¸ æ•¸æ“šæœªè®Šæ›´ï¼Œè·³é: ${machine.id}/${machine.location}`);
                                unchangedCount++;
                                summaryInfo.unchanged.push({
                                    id: machine.id,
                                    location: machine.location,
                                    date: record.date,
                                    beforePlays: beforePlays,
                                    afterPlays: afterPlays,
                                    beforePayouts: beforePayouts,
                                    afterPayouts: afterPayouts,
                                    playsChange: 0,
                                    payoutsChange: 0
                                });
                            } else {
                                // æ›´æ–°æ©Ÿå°ç´¯ç©æ•¸æ“š
                                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machine.docId);
                                console.log(`ğŸ”— æº–å‚™æ›´æ–°æ©Ÿå°æ•¸æ“š:`, {
                                    selectedGroupId,
                                    selectedStoreId,
                                    machineDocId: machine.docId,
                                    plays: cumulativePlaysInput,
                                    payouts: cumulativePayoutsInput
                                });
                                
                                const updateResult = await machineRef.update({
                                    plays: cumulativePlaysInput,
                                    payouts: cumulativePayoutsInput
                                });
                                console.log(`ğŸ’¾ å·²æ›´æ–°æ©Ÿå°ç´¯ç©æ•¸æ“š: plays=${cumulativePlaysInput}, payouts=${cumulativePayoutsInput}`, updateResult);
                                
                                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ—¥æœŸå’Œæ©Ÿå°çš„æ­·å²è¨˜éŒ„
                                const historyQuery = db.collection('groups').doc(selectedGroupId)
                                    .collection('stores').doc(selectedStoreId)
                                    .collection('history');
                                
                                let existingRecords = null;
                                try {
                                    // å˜—è©¦è¤‡åˆæŸ¥è©¢
                                    existingRecords = await historyQuery
                                        .where('date', '==', record.date)
                                        .where('machineId', '==', machine.id)
                                        .where('location', '==', machine.location)
                                        .get();
                                } catch (queryError) {
                                    // å¦‚æœè¤‡åˆæŸ¥è©¢å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                                    console.warn(`âš ï¸ è¤‡åˆæŸ¥è©¢å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ: ${queryError.message}`);
                                    const allRecords = await historyQuery.get();
                                    const filtered = allRecords.docs.filter(doc => {
                                        const data = doc.data();
                                        return data.date === record.date && 
                                               data.machineId === machine.id && 
                                               data.location === machine.location;
                                    });
                                    existingRecords = { docs: filtered };
                                }
                                
                                if (existingRecords.docs.length > 0) {
                                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                                    const docId = existingRecords.docs[0].id;
                                    await db.collection('groups').doc(selectedGroupId)
                                        .collection('stores').doc(selectedStoreId)
                                        .collection('history').doc(docId)
                                        .update({
                                            date: record.date,
                                            machineId: machine.id,
                                            location: machine.location,
                                            newPlays: dailyPlays,
                                            newPayouts: dailyPayouts,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    console.log(`âœ… å·²æ›´æ–°æ­·å²è¨˜éŒ„: ${docId}, æ—¥å¢é‡ plays=${dailyPlays}, payouts=${dailyPayouts}`);
                                } else {
                                    // æ–°å¢æ–°è¨˜éŒ„
                                    console.log(`ğŸ“ æº–å‚™æ–°å¢æ­·å²è¨˜éŒ„:`, {
                                        selectedGroupId,
                                        selectedStoreId,
                                        date: record.date,
                                        machineId: machine.id,
                                        location: machine.location,
                                        newPlays: dailyPlays,
                                        newPayouts: dailyPayouts
                                    });
                                    
                                    const addResult = await db.collection('groups').doc(selectedGroupId)
                                        .collection('stores').doc(selectedStoreId)
                                        .collection('history')
                                        .add({
                                            date: record.date,
                                            machineId: machine.id,
                                            location: machine.location,
                                            newPlays: dailyPlays,
                                            newPayouts: dailyPayouts,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    console.log(`âœ… å·²æ–°å¢æ­·å²è¨˜éŒ„: ${addResult.id}, æ—¥å¢é‡ plays=${dailyPlays}, payouts=${dailyPayouts}`);
                                }
                            }
                            
                        } catch (dbError) {
                            console.error(`âŒ è³‡æ–™åº«æ“ä½œå¤±æ•—: ${machine.id}/${machine.location}`, {
                                error: dbError,
                                message: dbError.message,
                                code: dbError.code,
                                stack: dbError.stack
                            });
                            throw dbError;
                        }
                        
                        // ç¨ä½œåœé “ï¼Œé¿å…éå¿«æ“ä½œ
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        console.log(`âœ… [${processedCount}/${totalRecords}] å·²è™•ç† ${machine.id}/${machine.location} çš„è¨˜éŒ„ (æ—¥æœŸ: ${record.date})`);
                        
                    } catch (error) {
                        console.error(`âŒ è™•ç†è¨˜éŒ„å¤±æ•—: ${recordKey}`, error);
                        failedCount++;
                    }
                }
                
                // æ‰¹æ¬¡é–“ç¨ä½œåœé “ï¼Œé¿å…éåº¦è² è¼‰
                if (i + batchSize < allRecords.length) {
                    console.log(`â³ æ‰¹æ¬¡ ${batchNumber} å®Œæˆï¼Œç¨ä½œåœé “...`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            const processedTotal = newCount + updateCount;
            const skippedTotal = unchangedCount;
            
            if (processedTotal === 0 && skippedTotal === 0) {
                alert(`âŒ æ²’æœ‰æˆåŠŸè™•ç†ä»»ä½•è¨˜éŒ„ (å¤±æ•—: ${failedCount})`);
            } else {
                // è¨ˆç®—ç¸½æŠ•å¹£æ•¸å’Œç¸½å‡ºè²¨æ•¸
                let totalPlays = 0;
                let totalPayouts = 0;
                
                // ç´¯åŠ æ–°å¢å’Œæ›´æ–°çš„è¨˜éŒ„
                [...summaryInfo.new, ...summaryInfo.updated].forEach(m => {
                    totalPlays += (m.afterPlays - m.beforePlays);
                    totalPayouts += (m.afterPayouts - m.beforePayouts);
                });
                
                // å»ºç«‹è©³ç´°çš„æ‘˜è¦è¨Šæ¯
                let detailMessages = [];
                
                if (newCount > 0) {
                    detailMessages.push(`âœ¨ æ–°å¢ ${newCount} ç­†:`);
                    summaryInfo.new.forEach(m => {
                        detailMessages.push(`   ${m.id}/${m.location}: æŠ•å¹£ ${m.beforePlays}â†’${m.afterPlays}, å‡ºè²¨ ${m.beforePayouts}â†’${m.afterPayouts}`);
                    });
                }
                
                if (updateCount > 0) {
                    detailMessages.push(`ğŸ”„ æ›´æ–° ${updateCount} ç­†:`);
                    summaryInfo.updated.forEach(m => {
                        detailMessages.push(`   ${m.id}/${m.location}: æŠ•å¹£ ${m.beforePlays}â†’${m.afterPlays}, å‡ºè²¨ ${m.beforePayouts}â†’${m.afterPayouts}`);
                    });
                }
                
                if (skippedTotal > 0) {
                    detailMessages.push(`â­ï¸ è·³é ${skippedTotal} ç­† (ç„¡è®ŠåŒ–)`);
                }
                
                if (failedCount > 0) {
                    detailMessages.push(`âŒ å¤±æ•— ${failedCount} ç­†`);
                }
                
                // æ·»åŠ ç¸½è¨ˆçµ±è¨ˆ
                detailMessages.push(`\nğŸ“Š æœ¬æ¬¡æ›´æ–°çµ±è¨ˆ:`);
                detailMessages.push(`   ç¸½æŠ•å¹£æ•¸: ${totalPlays} æ¬¡`);
                detailMessages.push(`   ç¸½å‡ºè²¨æ•¸: ${totalPayouts} æ¬¡`);
                
                const message = `âœ… æ‰¹é‡è™•ç†å®Œæˆ\n\n${detailMessages.join('\n')}`;
                alert(message);
                
                // âœ… æ–°å¢ï¼šè©³ç´°çš„æ“ä½œç¸½çµ
                console.log(`ğŸ‰ æ‰¹é‡æ“ä½œå®Œæˆçµ±è¨ˆ:`);
                console.log(`   âœ¨ æ–°å¢è¨˜éŒ„: ${newCount} ç­†`);
                if (summaryInfo.new.length > 0) {
                    summaryInfo.new.forEach(m => {
                        console.log(`      ${m.id}/${m.location} æŠ•å¹£: ${m.beforePlays} â†’ ${m.afterPlays} (+${m.playsChange})  å‡ºè²¨: ${m.beforePayouts} â†’ ${m.afterPayouts} (+${m.payoutsChange})`);
                    });
                }
                console.log(`   ğŸ”„ æ›´æ–°è¨˜éŒ„: ${updateCount} ç­†`);
                if (summaryInfo.updated.length > 0) {
                    summaryInfo.updated.forEach(m => {
                        const playsIndicator = m.playsChange > 0 ? `+${m.playsChange}` : m.playsChange < 0 ? `${m.playsChange}` : 'Â±0';
                        const payoutsIndicator = m.payoutsChange > 0 ? `+${m.payoutsChange}` : m.payoutsChange < 0 ? `${m.payoutsChange}` : 'Â±0';
                        console.log(`      ${m.id}/${m.location} æŠ•å¹£: ${m.beforePlays} â†’ ${m.afterPlays} (${playsIndicator})  å‡ºè²¨: ${m.beforePayouts} â†’ ${m.afterPayouts} (${payoutsIndicator})`);
                    });
                }
                console.log(`   â­ï¸ è·³éè¨˜éŒ„: ${unchangedCount} ç­†`);
                if (summaryInfo.unchanged.length > 0) {
                    summaryInfo.unchanged.forEach(m => {
                        console.log(`      ${m.id}/${m.location} æŠ•å¹£: ${m.beforePlays} â†’ ${m.afterPlays} (Â±0)  å‡ºè²¨: ${m.beforePayouts} â†’ ${m.afterPayouts} (Â±0) [ç„¡è®ŠåŒ–]`);
                    });
                }
                console.log(`   âŒ å¤±æ•—: ${failedCount} ç­†`);
                
                // âœ… é‡è¦ï¼šæ‰¹é‡æ“ä½œå®Œæˆå¾Œï¼Œé‡æ–°è¼‰å…¥é–€å¸‚æ•¸æ“šå’Œæ¸…é™¤è¼ªè©¢è‡¨æ™‚è¨˜éŒ„
                console.log('ğŸ”„ é‡æ–°è¼‰å…¥é–€å¸‚æ•¸æ“š...');
                try {
                    suppressNextAutoPoll = true;
                    await loadStoreData();
                    console.log('âœ… é–€å¸‚æ•¸æ“šå·²é‡æ–°è¼‰å…¥');
                } catch (reloadError) {
                    console.error('âŒ é‡æ–°è¼‰å…¥é–€å¸‚æ•¸æ“šå¤±æ•—:', reloadError);
                }
                
                // æ¸…é™¤è¼ªè©¢è‡¨æ™‚è¨˜éŒ„ï¼ˆæ³¨æ„ï¼šé€™ä¸æœƒå½±éŸ¿ Firebase ä¸­çš„æ­£å¼è¨˜éŒ„ï¼‰
                console.log('ğŸ—‘ï¸ æ¸…é™¤è¼ªè©¢è‡¨æ™‚è¨˜éŒ„...');
                window.dailyRecords = {};
                if (typeof refreshAutoRecordTable === 'function') {
                    refreshAutoRecordTable();
                }
            }
        }
        
        // ğŸš€ æ‰¹æ¬¡è™•ç†é…ç½®åŠŸèƒ½
        window.setBatchSize = function(size) {
            window.batchProcessingSize = size || 50;
            console.log(`ğŸ“Š å·²è¨­å®šæ‰¹æ¬¡è™•ç†å¤§å°: ${window.batchProcessingSize}`);
            return window.batchProcessingSize;
        };
        
        // ğŸš€ å•Ÿç”¨ç„¡é™åˆ¶æ‰¹æ¬¡è™•ç†æ¨¡å¼
        window.enableUnlimitedBatch = function(enable = true) {
            window.unlimitedBatchMode = enable;
            if (enable) {
                console.log('ğŸš€ å·²å•Ÿç”¨ç„¡é™åˆ¶æ‰¹æ¬¡è™•ç†æ¨¡å¼');
                window.setBatchSize(Number.MAX_SAFE_INTEGER);
            } else {
                console.log('âš ï¸ å·²åœç”¨ç„¡é™åˆ¶æ‰¹æ¬¡è™•ç†æ¨¡å¼');
                window.setBatchSize(50); // æ¢å¾©é è¨­å€¼
            }
            return window.unlimitedBatchMode;
        };
        
        // ğŸ” æª¢æŸ¥æ‰¹æ¬¡è™•ç†ç‹€æ…‹
        window.getBatchStatus = function() {
            const status = {
                batchSize: window.batchProcessingSize || 50,
                unlimitedMode: window.unlimitedBatchMode || false,
                recordCount: window.dailyRecords ? Object.keys(window.dailyRecords).length : 0,
                machineCount: appData?.machines?.length || 0
            };
            console.table(status);
            return status;
        };
        
        // åˆå§‹åŒ–é è¨­è¨­å®š
        if (typeof window.batchProcessingSize === 'undefined') {
            window.setBatchSize(50); // é è¨­æ‰¹æ¬¡å¤§å°
        }
        
        function handleHttpResponse(data, mac = null, devid = null) {
            console.log('ğŸ”„ è™•ç† HTTP å›æ‡‰è³‡æ–™:', data, 'MAC:', mac, 'DevID:', devid);
            console.log('ğŸ“Š [DEBUG] å®Œæ•´ HTTP å›æ‡‰:', JSON.stringify(data, null, 2));
            
            // æ›´æ–°æœ€å¾Œå›æ‡‰é¡¯ç¤º
            const lastResponseElement = document.getElementById('http-last-response');
            if (lastResponseElement) {
                if (typeof data === 'string') {
                    lastResponseElement.textContent = data.substring(0, 50) + (data.length > 50 ? '...' : '');
                } else {
                    lastResponseElement.textContent = JSON.stringify(data).substring(0, 50) + '...';
                }
            }
            
            // æ·»åŠ åˆ°å‘½ä»¤è¨˜éŒ„
            addCommandLog('success', `æ”¶åˆ°å›æ‡‰è³‡æ–™ï¼š${JSON.stringify(data).substring(0, 100)}...`, {
                timestamp: new Date().toLocaleTimeString(),
                dataPreview: data
            });
            
            // åˆå§‹åŒ– devid å°æ‡‰çš„å­˜å„²
            if (!window.machineDataByDevid) {
                window.machineDataByDevid = {};
            }
            
            // å¦‚æœæ˜¯é™£åˆ—ï¼Œå„ªå…ˆæŒ‰æŒ‡å®šçš„ devid è§£æï¼Œå¦å‰‡è§£ææ‰€æœ‰ devid
            if (Array.isArray(data)) {
                console.log('ğŸ“Š æª¢æ¸¬åˆ°é™£åˆ—æ•¸æ“šï¼Œè™•ç†å¤š devid... (æŒ‡å®šDevID:', devid, ')');
                
                if (devid !== null && devid !== undefined) {
                    // âœ… å„ªå…ˆæŒ‰æŒ‡å®šçš„ devid è§£æ
                    console.log(`â­ å„ªå…ˆè§£ææŒ‡å®šçš„ devid: ${devid}`);
                    const parsedData = parseHttpData(data, devid);
                    
                    if (parsedData && parsedData.plays !== null) {
                        window.machineDataByDevid[devid] = parsedData;
                        console.log(`âœ… devid ${devid} æ•¸æ“šå·²å„²å­˜:`, parsedData);
                        console.log(`   ğŸ” [DEBUG] è§£æçµæœ - plays: ${parsedData.plays}, payouts: ${parsedData.payouts}, hasData: ${parsedData.hasData}`);
                        
                        // ğŸ“ ä½¿ç”¨æ™ºèƒ½æŸ¥æ‰¾å‡½æ•¸ç²å–æ©Ÿå°é…ç½®
                        const machineConfig = findMachineConfig(mac, devid);
                        
                        if (machineConfig) {
                            // âœ… ç›´æ¥ä½¿ç”¨åŸå§‹æ•¸å€¼ï¼Œè®“ updateDailyRecord è™•ç†æ ¡æ­£å€¼è¨ˆç®—
                            const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                            console.log(`ğŸ“‹ æ¯æ—¥è¨˜éŒ„æ›´æ–°çµæœ (${recordResult.status}):`, recordResult.record);
                            console.log(`   ğŸ” [DEBUG] åŸå§‹å€¼: plays=${parsedData.plays}, payouts=${parsedData.payouts}`);
                            console.log(`   ğŸ”§ [æ ¡æ­£å¾Œ] é¡¯ç¤ºå€¼: plays=${recordResult.record.plays}, payouts=${recordResult.record.payouts}`);
                            console.log(`   ğŸ“Š [è®ŠåŒ–] æŠ•å¹£è®ŠåŒ–: ${recordResult.playsChanged}, å‡ºè²¨è®ŠåŒ–: ${recordResult.payoutsChanged}`);
                        } else {
                            console.warn(`âš ï¸ æ‰¾ä¸åˆ°æ©Ÿå°é…ç½®: MAC=${mac}, DevID=${devid}ï¼Œè·³éè¨˜éŒ„æ›´æ–°`);
                        }
                        
                        // ğŸ”„ åˆ·æ–°è‡ªå‹•è¨˜å¸³è¡¨æ ¼
                        refreshAutoRecordTable();
                        
                        updateMachineDataDisplay(parsedData, devid);
                    } else {
                        console.warn(`âš ï¸ [CRITICAL ERROR] devid ${devid} è§£æå¤±æ•—ï¼plays=${parsedData?.plays}, payouts=${parsedData?.payouts}, hasData=${parsedData?.hasData}`);
                        console.log('   ğŸ“Š [DEBUG] parsedData å®Œæ•´ä¿¡æ¯:', JSON.stringify(parsedData, null, 2));
                        console.log('   ğŸ”´ HTTP å›æ‡‰æ ¼å¼å¯èƒ½ä¸æ˜¯é æœŸçš„ re_readdata çµæ§‹');
                        console.log('   ğŸ’¡ è«‹æª¢æŸ¥: window.parmByDevid ä¸­çš„ parm åå…­é€²ä½æ•¸æ“š');
                    }
                } else {
                    // âœ… å¦‚æœæ²’æŒ‡å®š devidï¼Œå‰‡æ‰¾å‡ºæ¯å€‹ devid çš„æœ€æ–°è¨˜éŒ„
                    console.log('ğŸ“Š æœªæŒ‡å®š DevIDï¼Œè‡ªå‹•è§£ææ‰€æœ‰ DevID çš„æœ€æ–°è¨˜éŒ„');
                    
                    // å»ºç«‹ DevID åˆ°æœ€æ–°è¨˜éŒ„çš„æ˜ å°„
                    const latestByDevid = {};
                    
                    data.forEach((record, index) => {
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.devid && parsed.cmd === 're_readdata') {
                                    const devid = parseInt(parsed.devid);
                                    
                                    // å¦‚æœé‚„æ²’æœ‰é€™å€‹ devid çš„è¨˜éŒ„ï¼Œæˆ–è€…ç•¶å‰è¨˜éŒ„æ›´æ–°ï¼Œå‰‡æ›´æ–°
                                    if (!latestByDevid[devid] || record.date > latestByDevid[devid].date) {
                                        latestByDevid[devid] = {
                                            record: record,
                                            parsed: parsed,
                                            date: record.date
                                        };
                                        console.log(`   ğŸ”„ æ›´æ–° DevID=${devid} æœ€æ–°è¨˜éŒ„: ${record.date}`);
                                    }
                                }
                            } catch (e) {
                                console.warn(`âš ï¸ [${index}] ç„¡æ³•è§£æè¨˜éŒ„:`, record);
                            }
                        }
                    });
                    
                    const devidCount = Object.keys(latestByDevid).length;
                    console.log(`âœ… æ‰¾åˆ° ${devidCount} å€‹ DevID çš„æœ€æ–°è¨˜éŒ„:`, Object.keys(latestByDevid).map(d => `DevID=${d} (${latestByDevid[d].date})`));
                    
                    // ç‚ºæ¯å€‹ devid è§£ææœ€æ–°æ•¸æ“š
                    let processedCount = 0;
                    Object.keys(latestByDevid).forEach(targetDevid => {
                        const devid = parseInt(targetDevid);
                        const latestRecord = latestByDevid[devid];
                        
                        console.log(`\nğŸ“Š [${processedCount + 1}/${devidCount}] è™•ç† DevID=${devid}`);
                        console.log(`   æ™‚é–“: ${latestRecord.date}`);
                        console.log(`   parm: ${latestRecord.parsed.parm?.substring(0, 40)}...`);
                        
                        const parsedData = parseHttpData(data, devid);
                        
                        if (parsedData && parsedData.plays !== null) {
                            window.machineDataByDevid[devid] = parsedData;
                            console.log(`   âœ… DevID ${devid} æ•¸æ“šå·²å„²å­˜: plays=${parsedData.plays}, payouts=${parsedData.payouts}`);
                            
                            // ğŸ“ ä½¿ç”¨æ™ºèƒ½æŸ¥æ‰¾å‡½æ•¸ç²å–æ©Ÿå°é…ç½®
                            const machineConfig = findMachineConfig(mac, devid);
                            
                            console.log(`   ğŸ”‘ æ™ºèƒ½æŸ¥æ‰¾æ˜ å°„ MAC=${mac}, DevID=${devid}:`, machineConfig ? `æ‰¾åˆ° ${machineConfig.machineId}/${machineConfig.location}` : 'âŒ æœªæ‰¾åˆ°');
                            
                            if (machineConfig) {
                                // âœ… ç›´æ¥ä½¿ç”¨åŸå§‹æ•¸å€¼ï¼Œè®“ updateDailyRecord è™•ç†æ ¡æ­£å€¼è¨ˆç®—
                                const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                                console.log(`   ğŸ“‹ æ¯æ—¥è¨˜éŒ„æ›´æ–°çµæœ (${recordResult.status}):`, recordResult.record);
                                console.log(`   ğŸ”§ [æ ¡æ­£] åŸå§‹: ${parsedData.plays}/${parsedData.payouts} â†’ é¡¯ç¤º: ${recordResult.record.plays}/${recordResult.record.payouts}`);
                                processedCount++;
                            } else {
                                console.warn(`   âš ï¸ æ‰¾ä¸åˆ°æ©Ÿå°é…ç½®: MAC=${mac}, DevID=${devid}ï¼Œè·³éè¨˜éŒ„æ›´æ–°`);
                                console.log(`   ğŸ’¡ å¯ç”¨çš„æ˜ å°„éµ:`, Object.keys(window.machineConfigMap || {}).slice(0, 10));
                            }
                            
                            // é¡¯ç¤ºè©² devid çš„æ•¸æ“š
                            updateMachineDataDisplay(parsedData, devid);
                        } else {
                            console.warn(`   âŒ DevID ${devid} è§£æå¤±æ•—:`, parsedData);
                        }
                    });
                    
                    console.log(`\nğŸ¯ è™•ç†å®Œæˆï¼šå…±è™•ç† ${processedCount}/${devidCount} å€‹ DevID`);
                    
                    // ğŸ”„ åˆ·æ–°è‡ªå‹•è¨˜å¸³è¡¨æ ¼
                    refreshAutoRecordTable();
                }
                
                // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾›å¾ŒçºŒä½¿ç”¨
                window.lastParsedMachineData = window.machineDataByDevid;
            } else {
                // å–®å€‹æ•¸æ“šè™•ç†
                const parsedData = parseHttpData(data, devid);
                
                // å¦‚æœæˆåŠŸè§£æï¼Œè¨˜éŒ„æå–çš„æ•¸æ“š
                if (parsedData) {
                    console.log('âœ… æ•¸æ“šè§£ææˆåŠŸ:', parsedData);
                    
                    // æŒ‰ devid å„²å­˜
                    if (parsedData.devid || devid) {
                        const saveDevid = parsedData.devid || devid;
                        if (!window.machineDataByDevid) {
                            window.machineDataByDevid = {};
                        }
                        window.machineDataByDevid[saveDevid] = parsedData;
                        console.log(`ğŸ’¾ devid ${saveDevid} æ•¸æ“šå·²ä¿å­˜`);
                    }
                    
                    // æ›´æ–° UI ä¸­é¡¯ç¤ºçš„æ©Ÿå°æ•¸æ“š
                    updateMachineDataDisplay(parsedData, devid);
                    
                    // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾›å¾ŒçºŒä½¿ç”¨
                    window.lastParsedMachineData = parsedData;
                } else {
                    console.warn('âš ï¸ ç„¡æ³•è§£ææ•¸æ“š');
                }
            }
        }
        
        // è§£æ HTTP å›æ‡‰æ•¸æ“š - æ”¯æŒå¤šç¨®æ ¼å¼å’Œå¤šå€‹ devid
        function parseHttpData(data, targetDevid = null) {
            try {
                console.log('ğŸ“¥ é–‹å§‹è§£ææ•¸æ“šï¼Œé¡å‹:', typeof data, targetDevid ? `ï¼Œç›®æ¨™ devid: ${targetDevid}` : '');
                
                // æƒ…æ³ 1: å¦‚æœæ˜¯é™£åˆ—ï¼Œå°‹æ‰¾å°æ‡‰ devid çš„ re_readdata å‘½ä»¤
                if (Array.isArray(data)) {
                    console.log('ğŸ” æª¢æ¸¬åˆ°é™£åˆ—çµæ§‹ï¼Œå…± ' + data.length + ' æ¢è¨˜éŒ„');
                    
                    // å…ˆåˆ—å‡ºæ‰€æœ‰ re_readdata è¨˜éŒ„ä»¥ä¾¿èª¿è©¦
                    const reReadRecords = [];
                    for (let i = 0; i < data.length; i++) {
                        const record = data[i];
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.cmd === 're_readdata' && parsed.parm) {
                                    // ğŸ”§ ä¿®æ­£: å°‡æ—¥æœŸæ ¼å¼è½‰æ›ç‚ºæ¨™æº– ISO æ ¼å¼
                                    // "2025-11-02 00:12:44.324" â†’ "2025-11-02T00:12:44.324"
                                    const dateStr = record.date.replace(' ', 'T');
                                    const timestamp = new Date(dateStr).getTime();
                                    
                                    reReadRecords.push({
                                        index: i,
                                        date: record.date,
                                        devid: parsed.devid,
                                        timestamp: timestamp,
                                        record: record,
                                        parsed: parsed
                                    });
                                }
                            } catch (e) {}
                        }
                    }
                    
                    if (reReadRecords.length > 0) {
                        console.log('ğŸ“‹ ç™¼ç¾æ‰€æœ‰ re_readdata è¨˜éŒ„:');
                        reReadRecords.forEach(r => console.log(`   [${r.index}] ${r.date} (devid=${r.devid}) timestamp=${r.timestamp}`));
                    }
                    
                    // âœ… é—œéµä¿®æ­£ï¼šæŒ‰æ™‚é–“æˆ³æ’åºï¼Œæ‰¾æœ€æ–°çš„ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„
                    // å¦‚æœæŒ‡å®šäº† devidï¼Œå‰‡å…ˆéæ¿¾è©² devidï¼Œå†æŒ‰æ™‚é–“æ’åº
                    let targetRecords = reReadRecords;
                    if (targetDevid !== null) {
                        targetRecords = reReadRecords.filter(r => parseInt(r.devid) == parseInt(targetDevid));
                        console.log(`ğŸ” éæ¿¾ devid=${targetDevid} çš„è¨˜éŒ„ï¼Œæ‰¾åˆ° ${targetRecords.length} æ¢`);
                    }
                    
                    if (targetRecords.length > 0) {
                        // æŒ‰æ™‚é–“æˆ³å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        targetRecords.sort((a, b) => b.timestamp - a.timestamp);
                        const newestRecord = targetRecords[0];
                        
                        console.log(`âœ… é¸æ“‡æœ€æ–°è¨˜éŒ„: [${newestRecord.index}] ${newestRecord.date} (devid=${newestRecord.devid})`);
                        console.log(`   æ™‚é–“æˆ³: ${newestRecord.timestamp}, æ¯”è¼ƒå…¶ä»–è¨˜éŒ„:`);
                        targetRecords.slice(1, 3).forEach(r => {
                            const timeDiff = newestRecord.timestamp - r.timestamp;
                            console.log(`   - [${r.index}] ${r.date} (ç›¸å·® ${timeDiff}ms)`);
                        });
                        
                        // ğŸ” æª¢æ¸¬æ•¸æ“šæ–°é®®åº¦
                        const now = Date.now();
                        const dataAge = now - newestRecord.timestamp;
                        const ageSeconds = Math.floor(dataAge / 1000);
                        
                        if (dataAge > 60000) { // è¶…é 60 ç§’
                            console.warn(`âš ï¸ æ•¸æ“šå¯èƒ½éæœŸ! è¨˜éŒ„æ™‚é–“: ${newestRecord.date}, è·ä»Š ${ageSeconds} ç§’`);
                            console.warn(`   å»ºè­°: æ­¤ MAC å¯èƒ½éœ€è¦é‡è©¦è®€å–`);
                            // åœ¨è¿”å›çš„æ•¸æ“šä¸­æ·»åŠ æ¨™è¨˜
                            const result = parseReReadData(newestRecord.parsed);
                            result._isStale = true;
                            result._dataAge = ageSeconds;
                            return result;
                        } else {
                            console.log(`âœ… æ•¸æ“šæ–°é®®: è·ä»Šåƒ… ${ageSeconds} ç§’`);
                        }
                        
                        return parseReReadData(newestRecord.parsed);
                    }
                    
                    // å¦‚æœæŒ‡å®šäº† devid ä½†æ²’æ‰¾åˆ°ï¼Œè¨˜éŒ„
                    if (targetDevid !== null) {
                        console.warn(`âš ï¸ æœªæ‰¾åˆ° devid ${targetDevid} çš„ re_readdata å‘½ä»¤`);
                    } else {
                        console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ re_readdata å‘½ä»¤');
                    }
                    
                    return {
                        plays: null,
                        payouts: null,
                        timestamp: new Date().toLocaleTimeString('zh-TW'),
                        format: 'array_no_data',
                        hasData: false,
                        devid: targetDevid
                    };
                }
                
                let jsonData = data;
                
                // æƒ…æ³ 2: å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå˜—è©¦è§£æç‚º JSON
                if (typeof data === 'string') {
                    // å˜—è©¦ JSON è§£æ
                    try {
                        jsonData = JSON.parse(data);
                        // å¦‚æœè§£æå¾Œæ˜¯é™£åˆ—ï¼Œéæ­¸è™•ç†
                        if (Array.isArray(jsonData)) {
                            return parseHttpData(jsonData, targetDevid);
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œå˜—è©¦æå–æ•¸æ“š
                        console.log('ğŸ“„ æ¥æ”¶åˆ°æ–‡æœ¬æ•¸æ“šï¼Œå˜—è©¦æå–çµæ§‹åŒ–ä¿¡æ¯...');
                        return parseTextData(data);
                    }
                }
                
                // æƒ…æ³ 3: å¦‚æœæ˜¯å°è±¡
                if (typeof jsonData === 'object' && jsonData !== null) {
                    // é¦–å…ˆæª¢æŸ¥æ˜¯å¦æ˜¯ re_readdata å‘½ä»¤
                    if (jsonData.cmd === 're_readdata' && jsonData.parm) {
                        console.log('ğŸ” æª¢æ¸¬åˆ° re_readdata å‘½ä»¤ï¼Œè§£æ parm å­—æ®µ...');
                        return parseReReadData(jsonData);
                    }
                    // å¦å‰‡ä½¿ç”¨é€šç”¨ JSON è§£æ
                    return extractMachineData(jsonData);
                }
                
                return null;
            } catch (error) {
                console.error('âŒ æ•¸æ“šè§£æå¤±æ•—:', error);
                return null;
            }
        }
        
        // è§£æ re_readdata å‘½ä»¤çš„ parm åå…­é€²ä½å­—æ®µ
        function parseReReadData(jsonData) {
            console.log('âš™ï¸ è§£æ re_readdata å”è­°æ•¸æ“š...');
            console.log('ğŸ” [DEBUG] jsonData:', JSON.stringify(jsonData));
            
            const result = {
                raw: jsonData,
                plays: null,        // ç´¯ç©æŠ•å¹£æ•¸
                payouts: null,      // ç´¯ç©å‡ºçæ¬¡æ•¸
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 're_readdata',
                hasData: false
            };
            
            try {
                const parm = jsonData.parm;
                if (!parm || typeof parm !== 'string') {
                    console.warn('âš ï¸ parm å­—æ®µç„¡æ•ˆ', {parm, type: typeof parm});
                    console.log('ğŸ” [DEBUG] jsonData.parm:', jsonData.parm);
                    return result;
                }
                
                console.log('ğŸ“ parm åå…­é€²ä½å­—ç¬¦ä¸²: ' + parm);
                console.log('ğŸ“Š parm å­—ç¬¦ä¸²é•·åº¦: ' + parm.length + ' å­—ç¬¦ (' + (parm.length / 2) + ' å­—ç¯€)');
                console.log('ğŸ” [DEBUG] parm å‰ 100 å­—ç¬¦:', parm.substring(0, 100));
                console.log('ğŸ” [DEBUG] parm å®Œæ•´å…§å®¹:', parm);
                
                // ä¿å­˜åˆ°å…¨å±€è®Šæ•¸ä¾¿æ–¼æŸ¥è©¢
                if (!window.parmByDevid) window.parmByDevid = {};
                window.parmByDevid[jsonData.devid] = parm;
                console.log(`ğŸ’¾ å·²ä¿å­˜åˆ° window.parmByDevid[${jsonData.devid}]`);
                
                // å°‡åå…­é€²ä½å­—ç¬¦ä¸²è½‰æ›ç‚ºå­—ç¯€é™£åˆ—
                const bytes = [];
                for (let i = 0; i < parm.length; i += 2) {
                    const hex = parm.substring(i, i + 2);
                    bytes.push(parseInt(hex, 16));
                }
                
                console.log('ğŸ” å‰ 40 å€‹å­—ç¯€å€¼(åé€²ä½): ' + bytes.slice(0, 40).join(', '));
                
                // âœ… ä¸»è¦ä½ç½®: å˜—è©¦å¤šå€‹å·²çŸ¥ä½ç½®
                // âœ… ä¸»è¦ä½ç½®: æŠ•å¹£æ•¸å’Œå‡ºè²¨æ¬¡æ•¸ä½ç½®
                // æ ¹æ“šå¯¦éš› parm æ•¸æ“šåˆ†æï¼š
                // å­—ç¯€: ... 11, 0, 1, 40, 0, 0, 135, 0, 9, 0, 210, 0, 94, 1, ...
                // ä½ç½®: ... 26 27 28 29 30 31 32  33 34 35 36   37 38  39 ...
                //
                // Byte[32] = 135, Byte[33] = 0   â†’ plays = 135 + (0 << 8) = 135 âœ…
                // Byte[34] = 9,   Byte[35] = 0   â†’ payouts = 9 + (0 << 8) = 9 âœ…
                
                console.log(`ğŸ” devid=${parseInt(jsonData.devid) || 1}, å˜—è©¦å¤šå€‹ä½ç½®...`);
                
                // ğŸ“ æ­£ç¢ºä½ç½® (32-35)
                if (bytes.length >= 36) {
                    const plays = bytes[32] + (bytes[33] << 8);
                    const payouts = bytes[34] + (bytes[35] << 8);
                    const isValid = isValidPair(plays, payouts);
                    
                    console.log(`ğŸ“ è©¦ ä½ç½®32-35 (æ­£ç¢ºä½ç½®): bytes[32]=${bytes[32]?.toString(16).padStart(2,'0')}, bytes[33]=${bytes[33]?.toString(16).padStart(2,'0')}, bytes[34]=${bytes[34]?.toString(16).padStart(2,'0')}, bytes[35]=${bytes[35]?.toString(16).padStart(2,'0')} â†’ plays=${plays}, payouts=${payouts}, æœ‰æ•ˆ=${isValid}`);
                    
                    if (isValid) {
                        result.plays = plays;
                        result.payouts = payouts;
                        result.hasData = true;
                        console.log(`âœ… ä½ç½®32-35 æˆåŠŸæå–: plays=${plays}, payouts=${payouts}`);
                        return result;
                    } else {
                        console.log(`âš ï¸ ä½ç½®32-35 æ•¸æ“šç„¡æ•ˆï¼Œå˜—è©¦å‚™ç”¨ä½ç½®...`);
                    }
                }
                
                // ğŸ”„ å‚™ç”¨ä½ç½®: å˜—è©¦å…¶ä»–å·²çŸ¥ä½ç½®
                const knownPositions = [
                    {name: 'ä½ç½®36-39', start: 36},
                    {name: 'ä½ç½®42-45', start: 42},
                    {name: 'ä½ç½®52-55', start: 52}
                ];
                
                for (const pos of knownPositions) {
                    if (bytes.length >= pos.start + 4) {
                        const plays = bytes[pos.start] + (bytes[pos.start+1] << 8);
                        const payouts = bytes[pos.start+2] + (bytes[pos.start+3] << 8);
                        const isValid = isValidPair(plays, payouts);
                        
                        console.log(`ğŸ“ è©¦ ${pos.name}: bytes[${pos.start}]=${bytes[pos.start]?.toString(16).padStart(2,'0')}, bytes[${pos.start+1}]=${bytes[pos.start+1]?.toString(16).padStart(2,'0')}, bytes[${pos.start+2}]=${bytes[pos.start+2]?.toString(16).padStart(2,'0')}, bytes[${pos.start+3}]=${bytes[pos.start+3]?.toString(16).padStart(2,'0')} â†’ plays=${plays}, payouts=${payouts}, æœ‰æ•ˆ=${isValid}`);
                        
                        if (isValid) {
                            result.plays = plays;
                            result.payouts = payouts;
                            result.hasData = true;
                            console.log(`âœ… ${pos.name} æˆåŠŸæå–: plays=${plays}, payouts=${payouts}`);
                            return result;
                        }
                    }
                }
                
                // å‚™ç”¨ä½ç½®: å¤šå€‹å›ºå®šä½ç½® (4å­—ç¯€)
                const positions = [
                    {name: 'ä½ç½®A (2-6, 6-10)', plays: [2, 6], payouts: [6, 10]},
                    {name: 'ä½ç½®B (4-8, 8-12)', plays: [4, 8], payouts: [8, 12]},
                    {name: 'ä½ç½®C (8-12, 12-16)', plays: [8, 12], payouts: [12, 16]},
                    {name: 'ä½ç½®D (10-14, 14-18)', plays: [10, 14], payouts: [14, 18]},
                    {name: 'ä½ç½®E (16-20, 20-24)', plays: [16, 20], payouts: [20, 24]},
                    {name: 'ä½ç½®F (18-22, 22-26)', plays: [18, 22], payouts: [22, 26]},
                    {name: 'ä½ç½®G (24-28, 28-32)', plays: [24, 28], payouts: [28, 32]},
                ];
                
                console.log('ğŸ” å˜—è©¦å‚™ç”¨ 4å­—ç¯€ä½ç½®...');
                for (const pos of positions) {
                    if (bytes.length >= pos.payouts[1]) {
                        const p1 = bytes[pos.plays[0]] | (bytes[pos.plays[0]+1] << 8) | (bytes[pos.plays[0]+2] << 16) | (bytes[pos.plays[0]+3] << 24);
                        const p2 = bytes[pos.payouts[0]] | (bytes[pos.payouts[0]+1] << 8) | (bytes[pos.payouts[0]+2] << 16) | (bytes[pos.payouts[0]+3] << 24);
                        
                        console.log(`  è©¦ ${pos.name}: plays=${p1}, payouts=${p2}`);
                        
                        if (isValidPair(p1, p2)) {
                            result.plays = p1;
                            result.payouts = p2;
                            result.hasData = true;
                            console.log(`âœ… ${pos.name} æˆåŠŸ: plays=${p1}, payouts=${p2}`);
                            return result;
                        }
                    }
                }
                
                // å‚™ç”¨æ–¹æ³•: å‹•æ…‹æƒæ - å˜—è©¦æ‰€æœ‰å¯èƒ½çš„ 4 å­—ç¯€å°
                console.log('ğŸ” é–‹å§‹å‹•æ…‹æƒææ‰€æœ‰ 4å­—ç¯€ ä½ç½®...');
                for (let i = 0; i < bytes.length - 15; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8) | (bytes[i+2] << 16) | (bytes[i+3] << 24);
                    const val2 = bytes[i+4] | (bytes[i+5] << 8) | (bytes[i+6] << 16) | (bytes[i+7] << 24);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`âœ… å‹•æ…‹æƒææˆåŠŸ (ä½ç½® ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                // å‚™ç”¨æ–¹æ³•: å˜—è©¦ 2 å­—ç¯€çµ„åˆ (å‹•æ…‹)
                console.log('ğŸ” å˜—è©¦ 2å­—ç¯€çµ„åˆ (å‹•æ…‹æƒæ)...');
                for (let i = 0; i < bytes.length - 3; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8);
                    const val2 = bytes[i+2] | (bytes[i+3] << 8);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`âœ… 2å­—ç¯€æˆåŠŸ (ä½ç½® ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                console.warn('âš ï¸ å˜—è©¦äº†æ‰€æœ‰æ–¹æ³•ï¼Œç„¡æ³•å¾ parm ä¸­æå–æœ‰æ•ˆæ•¸æ“š');
                console.log('ğŸ’¡ parm æ¨£æœ¬: ' + parm);
                console.log('ğŸ” [DEBUG] ç„¡æ³•è§£æçš„åŸå› åˆ†æ:');
                console.log('   - æ‰€æœ‰ä½ç½®éƒ½æ²’æœ‰æå–åˆ°æœ‰æ•ˆçš„æŠ•å¹£/å‡ºè²¨å°');
                console.log('   - å¯èƒ½åŸå› : parm çµæ§‹ä¸ç¬¦åˆé æœŸï¼Œæˆ–è§£æé‚è¼¯éœ€è¦èª¿æ•´');
                console.log('   - å»ºè­°: æª¢æŸ¥ HTTP ä¼ºæœå™¨çš„ parm å­—æ®µæ ¼å¼');
                result.hasData = false;
                
            } catch (error) {
                console.error('âŒ re_readdata è§£æéŒ¯èª¤:', error);
                result.hasData = false;
            }
            
            return result;
        }
        
        // é©—è­‰æŠ•å¹£å’Œå‡ºçæ•¸æ“šæ˜¯å¦æœ‰æ•ˆ
        function isValidPair(plays, payouts) {
            // æŠ•å¹£æ•¸æ‡‰è©²å¤§æ–¼ 0ï¼Œå°æ–¼ 100 è¬
            // å‡ºçæ•¸æ‡‰è©²å¤§æ–¼ç­‰æ–¼ 0ï¼Œå°æ–¼ç­‰æ–¼æŠ•å¹£æ•¸ï¼Œå°æ–¼ 100 è¬
            const playsValid = plays > 0 && plays < 1000000;
            const payoutsValid = payouts >= 0 && payouts <= plays && payouts < 1000000;
            
            return playsValid && payoutsValid;
        }
        
        // âš¡ èª¿è©¦å·¥å…·ï¼šæª¢æŸ¥ç³»çµ±ç•¶å‰ç‹€æ…‹
        window.debugHttpPolling = function() {
            console.log('='.repeat(60));
            console.log('ğŸ” HTTP è¼ªè©¢ç³»çµ±èª¿è©¦ä¿¡æ¯');
            console.log('='.repeat(60));
            
            console.log('\nğŸ“‹ ç•¶å‰ç³»çµ±è¨˜éŒ„:');
            if (window.dailyRecords) {
                Object.entries(window.dailyRecords).forEach(([key, record]) => {
                    console.log(`  ${key}:`, {
                        machineId: record.machineId,
                        location: record.location,
                        plays: record.plays,
                        payouts: record.payouts,
                        updateCount: record.updateCount,
                        lastPlays: record.lastPlays,
                        lastPayouts: record.lastPayouts
                    });
                });
            } else {
                console.log('  âŒ window.dailyRecords æœªåˆå§‹åŒ–');
            }
            
            console.log('\nğŸ”Œ æœ€å¾Œ parm åå…­é€²ä½æ•¸æ“š:');
            if (window.parmByDevid) {
                Object.entries(window.parmByDevid).forEach(([devid, parm]) => {
                    console.log(`  devid ${devid}: ${parm.substring(0, 100)}...`);
                });
            } else {
                console.log('  âŒ window.parmByDevid æœªåˆå§‹åŒ–');
            }
            
            console.log('\nğŸ—ºï¸ æ©Ÿå°é…ç½®æ˜ å°„:');
            if (window.machineConfigMap) {
                Object.entries(window.machineConfigMap).forEach(([key, config]) => {
                    console.log(`  ${key}: ${config.machineId}/${config.location}`);
                });
            } else {
                console.log('  âŒ window.machineConfigMap æœªåˆå§‹åŒ–');
            }
            
            console.log('='.repeat(60));
        };
        
        // âš¡ èª¿è©¦å·¥å…·ï¼šæ‰‹å‹•æ¸¬è©¦æ›´æ–°
        window.testUpdateDaily = function(machineId, location, plays, payouts) {
            console.log(`\nğŸ§ª æ¸¬è©¦æ‰‹å‹•æ›´æ–°: ${machineId}/${location} - plays:${plays}, payouts:${payouts}`);
            const result = updateDailyRecord(machineId, location, plays, payouts);
            console.log('çµæœ:', result);
            refreshAutoRecordTable();
        };
        
        // âš¡ å¼·åˆ¶åŒæ­¥ï¼šç›´æ¥å¾è¡¨æ ¼è®€å–æœ€æ–°å€¼ä¸¦å¼·åˆ¶æ›´æ–°ç³»çµ±
        window.forceSyncFromTable = function() {
            console.log('\nâš¡ é–‹å§‹å¼·åˆ¶åŒæ­¥è¡¨æ ¼æ•¸æ“šåˆ°ç³»çµ±...');
            
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.error('âŒ æ‰¾ä¸åˆ°è¡¨æ ¼');
                return;
            }
            
            const rows = tableBody.querySelectorAll('tr');
            let syncCount = 0;
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const dateStr = cells[0]?.textContent?.trim();
                    const machineLink = cells[1]?.querySelector('a');
                    const machineText = machineLink?.textContent?.trim() || cells[1]?.textContent?.trim();
                    const plays = parseInt(cells[2]?.textContent?.trim()) || 0;
                    const payouts = parseInt(cells[3]?.textContent?.trim()) || 0;
                    
                    if (machineText && plays > 0) {
                        // è§£ææ©Ÿå°ä¿¡æ¯: "A001 / æ²™æ­¢æ¹–ç•”å¸‚/A0011/ä¸Š1"
                        const parts = machineText.split('/');
                        const machineId = parts[0]?.trim() || '';
                        const location = machineText.substring(machineText.indexOf('/')+1)?.trim() || '';
                        
                        console.log(`  [${syncCount+1}] åŒæ­¥: ${machineId}/${location} -> plays:${plays}, payouts:${payouts}`);
                        
                        const result = updateDailyRecord(machineId, location, plays, payouts);
                        syncCount++;
                        
                        if (result.status === 'updated') {
                            console.log(`    âœ… å·²æ›´æ–°`);
                        } else if (result.status === 'unchanged') {
                            console.log(`    â„¹ï¸ æ•¸æ“šæœªè®ŠåŒ–`);
                        } else {
                            console.log(`    âœ¨ æ–°å»ºè¨˜éŒ„`);
                        }
                    }
                }
            });
            
            console.log(`\nâœ… å¼·åˆ¶åŒæ­¥å®Œæˆï¼Œå…±åŒæ­¥ ${syncCount} æ¢è¨˜éŒ„`);
            refreshAutoRecordTable();
        };
        
        // âš¡ ä¿®å¾©æ¨¡å¼ï¼šä½¿ç”¨è¡¨å–®ä¸­çš„æ‰‹å‹•è¼¸å…¥å€¼ç›´æ¥æ›´æ–°ï¼ˆè‡¨æ™‚è§£æ±º parm è§£æå•é¡Œï¼‰
        window.useManualValuesMode = function(enable = true) {
            window.useManualValues = enable;
            if (enable) {
                console.log('âœ… å·²å•Ÿç”¨æ‰‹å‹•å€¼æ¨¡å¼ - ç³»çµ±å°‡ä½¿ç”¨è¡¨å–®ä¸­çš„æ‰‹å‹•æŠ•å¹£/å‡ºè²¨å€¼ï¼Œè€Œä¸æ˜¯è§£æ parm');
                console.log('   ç¾åœ¨é»æ“Šã€Œæ–°å¢è¨˜éŒ„ã€æŒ‰éˆ•æ™‚ï¼Œæœƒä½¿ç”¨è¡¨å–®ä¸­çš„å€¼é€²è¡Œæ›´æ–°');
                console.log('   æ‚¨å¯ä»¥åœ¨è¡¨å–®ä¸­æ‰‹å‹•è¼¸å…¥æŠ•å¹£æ¬¡æ•¸å’Œå‡ºè²¨æ•¸é‡');
            } else {
                console.log('âŒ å·²ç¦ç”¨æ‰‹å‹•å€¼æ¨¡å¼ - ç³»çµ±å°‡ç¹¼çºŒå˜—è©¦å¾ parm è§£ææ•¸æ“š');
            }
        };
        
        // âš¡ ä¸€ç­†ä¸€ç­†æ‰‹å‹•æ–°å¢è¨˜éŒ„ - ç›´æ¥å¾è¡¨æ ¼è®€å–ç•¶å‰å€¼ä¸¦åŸ·è¡Œæ–°å¢æµç¨‹ï¼ˆæœ€å¼·ä¿®å¾©æ–¹æ¡ˆï¼‰
        window.manualAddOneByOne = async function() {
            console.log('\n' + '='.repeat(60));
            console.log('ğŸ”¥ é–‹å§‹é€ç­†æ‰‹å‹•æ–°å¢è¨˜éŒ„ - ç›´æ¥è®€å–è¡¨æ ¼ç•¶å‰å€¼');
            console.log('='.repeat(60));
            
            // ç²å–è¡¨æ ¼
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.error('âŒ æ‰¾ä¸åˆ°è¡¨æ ¼ (auto-record-table-body)');
                return;
            }
            
            // ç²å–è¡¨å–®å…ƒç´ 
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            const dailyEntryForm = document.getElementById('daily-entry-form');
            
            if (!dailyEntryForm || !machineSelector) {
                console.error('âŒ æ‰¾ä¸åˆ°è¡¨å–®å…ƒç´ ');
                return;
            }
            
            // ç²å–è¡¨æ ¼ä¸­çš„æ‰€æœ‰è¡Œ
            const rows = tableBody.querySelectorAll('tr');
            console.log(`ğŸ“Š æ‰¾åˆ° ${rows.length} æ¢è¨˜éŒ„`);
            
            let successCount = 0;
            let failedCount = 0;
            
            // ä¸€ç­†ä¸€ç­†è™•ç†
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length < 5) continue;
                
                // è§£æè¡¨æ ¼æ•¸æ“š
                const dateStr = cells[0]?.textContent?.trim();
                const machineLink = cells[1]?.querySelector('a');
                const machineText = machineLink?.textContent?.trim() || cells[1]?.textContent?.trim();
                const plays = parseInt(cells[2]?.textContent?.trim()) || 0;
                const payouts = parseInt(cells[3]?.textContent?.trim()) || 0;
                
                if (!machineText || plays === 0) {
                    console.warn(`â­ï¸ [ç¬¬ ${i+1} ç­†] è³‡æ–™ä¸å®Œæ•´ï¼Œè·³é`);
                    continue;
                }
                
                console.log(`\nğŸ“Œ [ç¬¬ ${i+1} ç­†] è™•ç†: ${machineText}`);
                console.log(`   ğŸ“… æ—¥æœŸ: ${dateStr}`);
                console.log(`   ğŸ’° æŠ•å¹£: ${plays}`);
                console.log(`   ğŸ“¦ å‡ºè²¨: ${payouts}`);
                
                try {
                    // æ­¥é©Ÿ 1ï¼šå¾ appData æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°
                    buildMachineConfigMap();
                    let foundMachine = null;
                    
                    // å˜—è©¦å¾ window.dailyRecords æ‰¾åˆ°æ©Ÿå°ä¿¡æ¯
                    if (window.dailyRecords) {
                        for (const [key, record] of Object.entries(window.dailyRecords)) {
                            if (record.plays === plays && record.payouts === payouts) {
                                // æ‰¾åˆ°åŒ¹é…çš„è¨˜éŒ„
                                for (let machine of appData.machines) {
                                    if (machine.id === record.machineId && machine.location === record.location) {
                                        foundMachine = machine;
                                        break;
                                    }
                                }
                                if (foundMachine) break;
                            }
                        }
                    }
                    
                    // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦å¾æ©Ÿå°åˆ—è¡¨åŒ¹é…
                    if (!foundMachine) {
                        for (let machine of appData.machines) {
                            const machineDisplayText = `${machine.id} / ${machine.location}`;
                            if (machineText.includes(machine.id) && machineText.includes(machine.location)) {
                                foundMachine = machine;
                                break;
                            }
                        }
                    }
                    
                    if (!foundMachine) {
                        console.error(`   âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°`);
                        failedCount++;
                        continue;
                    }
                    
                    console.log(`   âœ… æ‰¾åˆ°æ©Ÿå°: docId=${foundMachine.docId}`);
                    
                    // æ­¥é©Ÿ 2ï¼šè¨­ç½®è¡¨å–®å€¼
                    machineSelector.value = foundMachine.docId;
                    machineSelector.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // ç­‰å¾… change äº‹ä»¶è™•ç†å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    entryDate.value = dateStr || new Date().toISOString().split('T')[0];
                    cumulativePlays.value = plays;
                    cumulativePayouts.value = payouts;
                    
                    console.log(`   âœ… è¡¨å–®å·²å¡«å…¥:`);
                    console.log(`      æ©Ÿå°: ${machineSelector.value}`);
                    console.log(`      æ—¥æœŸ: ${entryDate.value}`);
                    console.log(`      æŠ•å¹£: ${cumulativePlays.value}`);
                    console.log(`      å‡ºè²¨: ${cumulativePayouts.value}`);
                    
                    // æ­¥é©Ÿ 3ï¼šæäº¤è¡¨å–®
                    console.log(`   â³ æäº¤è¡¨å–®...`);
                    dailyEntryForm.dispatchEvent(new Event('submit', { bubbles: true }));
                    
                    // ç­‰å¾…è¡¨å–®æäº¤å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    console.log(`   âœ… å·²æäº¤`);
                    successCount++;
                    
                } catch (error) {
                    console.error(`   âŒ è™•ç†å¤±æ•—: ${error.message}`);
                    failedCount++;
                }
                
                // æ¯ç­†é–“éš” 1000msï¼ˆ1ç§’ï¼‰ï¼Œç¢ºä¿è³‡æ–™è™•ç†ç©©å®š
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            console.log(`\n${'='.repeat(60)}`);
            console.log(`âœ… æ‰‹å‹•æ–°å¢å®Œæˆ`);
            console.log(`   æˆåŠŸ: ${successCount} ç­†`);
            console.log(`   å¤±æ•—: ${failedCount} ç­†`);
            console.log(`   ç¸½è¨ˆ: ${successCount + failedCount} ç­†`);
            console.log('='.repeat(60));
            
            alert(`âœ… æ‰‹å‹•æ–°å¢å®Œæˆ\næˆåŠŸ: ${successCount} ç­†\nå¤±æ•—: ${failedCount} ç­†`);
        };
        
        // å¾æ–‡æœ¬æ ¼å¼è§£ææ•¸æ“š
        function parseTextData(textData) {
            console.log('ğŸ” åˆ†ææ–‡æœ¬æ•¸æ“šçµæ§‹...');
            
            const result = {
                raw: textData,
                plays: null,        // ç´¯ç©æŠ•å¹£æ•¸
                payouts: null,      // ç´¯ç©å‡ºè²¨æ¬¡æ•¸
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'text'
            };
            
            // å˜—è©¦å¤šç¨®å¸¸è¦‹çš„åˆ†éš”ç¬¦æ ¼å¼
            // æ ¼å¼ 1: "plays:123,payouts:456" æˆ–é¡ä¼¼
            const colonFormat = textData.match(/plays[:\s]+(\d+).*?payouts[:\s]+(\d+)/i);
            if (colonFormat) {
                result.plays = parseInt(colonFormat[1]);
                result.payouts = parseInt(colonFormat[2]);
                console.log('âœ… æ ¼å¼è­˜åˆ¥: å†’è™Ÿåˆ†éš”ç¬¦');
                return result;
            }
            
            // æ ¼å¼ 2: "123,456" (å‡è¨­ç¬¬ä¸€å€‹æ•¸å­—æ˜¯æŠ•å¹£ï¼Œç¬¬äºŒå€‹æ˜¯å‡ºè²¨)
            const commaFormat = textData.match(/^(\d+)[,\s]+(\d+)$/);
            if (commaFormat) {
                result.plays = parseInt(commaFormat[1]);
                result.payouts = parseInt(commaFormat[2]);
                console.log('âœ… æ ¼å¼è­˜åˆ¥: é€—è™Ÿåˆ†éš”ç¬¦');
                return result;
            }
            
            // æ ¼å¼ 3: æ›è¡Œåˆ†éš” "123\n456"
            const lineFormat = textData.match(/(\d+)\s+(\d+)/);
            if (lineFormat) {
                result.plays = parseInt(lineFormat[1]);
                result.payouts = parseInt(lineFormat[2]);
                console.log('âœ… æ ¼å¼è­˜åˆ¥: ç©ºç™½åˆ†éš”ç¬¦');
                return result;
            }
            
            // æ ¼å¼ 4: åªæå–æ‰€æœ‰æ•¸å­—
            const numbers = textData.match(/\d+/g);
            if (numbers && numbers.length >= 2) {
                result.plays = parseInt(numbers[0]);
                result.payouts = parseInt(numbers[1]);
                console.log('âœ… æ ¼å¼è­˜åˆ¥: è‡ªå‹•æå–æ•¸å­—');
                return result;
            }
            
            return null;
        }
        
        // å¾ JSON å°è±¡æå–æ©Ÿå°æ•¸æ“š
        function extractMachineData(jsonData) {
            console.log('ğŸ“¦ åˆ†æ JSON çµæ§‹...');
            
            const result = {
                raw: jsonData,
                plays: null,
                payouts: null,
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'json'
            };
            
            // å¸¸è¦‹çš„æ¬„ä½åç¨±åˆ—è¡¨
            const playsKeywords = ['plays', 'play', 'coins', 'coin', 'æŠ•å¹£', 'æŠ•å¸', 'investment', 'cumulative_plays', 'total_plays', 'count'];
            const payoutsKeywords = ['payouts', 'payout', 'dispense', 'dispenses', 'å‡ºè²¨', 'å‡ºè´§', 'distribution', 'cumulative_payouts', 'total_payouts', 'times'];
            
            // å°‹æ‰¾æŠ•å¹£æ•¸
            for (const key of playsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.plays = parseInt(jsonData[key]);
                    console.log(`âœ… æ‰¾åˆ°æŠ•å¹£æ¬„ä½: "${key}" = ${result.plays}`);
                    break;
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦æŸ¥æ‰¾åµŒå¥—æ¬„ä½
            if (result.plays === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of playsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.plays = parseInt(jsonData[key][subKey]);
                                console.log(`âœ… æ‰¾åˆ°åµŒå¥—æŠ•å¹£æ¬„ä½: "${key}.${subKey}" = ${result.plays}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // å°‹æ‰¾å‡ºè²¨æ¬¡æ•¸
            for (const key of payoutsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.payouts = parseInt(jsonData[key]);
                    console.log(`âœ… æ‰¾åˆ°å‡ºè²¨æ¬„ä½: "${key}" = ${result.payouts}`);
                    break;
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦æŸ¥æ‰¾åµŒå¥—æ¬„ä½
            if (result.payouts === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of payoutsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.payouts = parseInt(jsonData[key][subKey]);
                                console.log(`âœ… æ‰¾åˆ°åµŒå¥—å‡ºè²¨æ¬„ä½: "${key}.${subKey}" = ${result.payouts}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå˜—è©¦æŒ‰ä½ç½®çŒœæ¸¬ï¼ˆç¬¬ä¸€å€‹å’Œç¬¬äºŒå€‹æ•¸å­—å€¼ï¼‰
            if (result.plays === null || result.payouts === null) {
                let numberCount = 0;
                for (const key in jsonData) {
                    const value = jsonData[key];
                    if (typeof value === 'number' && !isNaN(value)) {
                        numberCount++;
                        if (numberCount === 1 && result.plays === null) {
                            result.plays = value;
                            console.log(`âš ï¸ æŒ‰ä½ç½®æ¨æ¸¬æŠ•å¹£æ¬„ä½: "${key}" = ${result.plays}`);
                        } else if (numberCount === 2 && result.payouts === null) {
                            result.payouts = value;
                            console.log(`âš ï¸ æŒ‰ä½ç½®æ¨æ¸¬å‡ºè²¨æ¬„ä½: "${key}" = ${result.payouts}`);
                        }
                    }
                }
            }
            
            return result;
        }
        
        // æ›´æ–° UI é¡¯ç¤ºæ©Ÿå°æ•¸æ“š - æ”¯æŒå¤š devid
        function updateMachineDataDisplay(machineData, devid = null) {
            console.log('ğŸ–¼ï¸ æ›´æ–° UI é¡¯ç¤º:', machineData, 'devid:', devid);
            
            if (!machineData) {
                console.warn('âš ï¸ ç„¡æ•ˆçš„æ•¸æ“šå°è±¡');
                return;
            }
            
            // æŸ¥æ‰¾å‘½ä»¤è¨˜éŒ„å®¹å™¨çš„çˆ¶å®¹å™¨
            const commandLogParent = document.getElementById('mqtt-command-log')?.parentElement;
            if (!commandLogParent) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°å‘½ä»¤è¨˜éŒ„å®¹å™¨');
                return;
            }
            
            // æ ¹æ“š devid ç”Ÿæˆå”¯ä¸€çš„å®¹å™¨ ID
            const containerId = devid ? `machine-data-display-devid-${devid}` : 'machine-data-display';
            const displayLabel = devid ? `å¤©è»Š ${devid === 1 ? 'å·¦' : devid === 2 ? 'å³' : devid}` : 'æ©Ÿå°';
            
            // æŸ¥æ‰¾æˆ–å‰µå»ºé¡¯ç¤ºå®¹å™¨
            let displayContainer = document.getElementById(containerId);
            
            if (!displayContainer) {
                // å‰µå»ºæ–°çš„é¡¯ç¤ºå®¹å™¨
                displayContainer = document.createElement('div');
                displayContainer.id = containerId;
                displayContainer.className = 'mt-4 p-4 bg-gray-800/50 rounded-lg border-l-4 border-blue-500';
                
                // æ’å…¥åˆ°å‘½ä»¤è¨˜éŒ„å®¹å™¨çš„ä¸‹æ–¹
                commandLogParent.appendChild(displayContainer);
                console.log(`âœ… å·²å‰µå»º ${displayLabel} æ•¸æ“šé¡¯ç¤ºå®¹å™¨`);
            }
            
            // æ§‹å»º HTML å…§å®¹
            let html = `<h4 class="text-sm font-medium text-yellow-300 mb-3">ğŸ“Š ${displayLabel}æ•¸æ“šè§£æçµæœ</h4>`;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ•¸æ“š
            const hasValidData = machineData.plays !== null || machineData.payouts !== null;
            const isReReadData = machineData.format === 're_readdata';
            
            // å¦‚æœæ˜¯ re_readdata ä½†æ²’æœ‰æå–åˆ°æ•¸æ“š
            if (isReReadData && !hasValidData && machineData.hasData === false) {
                html += `
                    <div class="bg-yellow-900/40 p-4 rounded-lg border border-yellow-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-yellow-300">âš ï¸ ç„¡è³‡è¨Šæ›´æ–°</div>
                            <div class="text-xs text-yellow-200 mt-2">ç„¡æ³•å¾ä¼ºæœå™¨å›æ‡‰ä¸­è§£ææœ‰æ•ˆçš„æŠ•å¹£æˆ–å‡ºçæ•¸æ“š</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>å‘½ä»¤: ${machineData.raw.cmd || 'N/A'}</div>
                                <div>MAC: ${machineData.raw.mac || 'N/A'}</div>
                                <div>æ ¼å¼: ${machineData.format} | æ™‚é–“: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!hasValidData) {
                // å¦‚æœæ˜¯å…¶ä»–æ ¼å¼ä¸”æ²’æœ‰æœ‰æ•ˆçš„æ•¸æ“š
                html += `
                    <div class="bg-orange-900/40 p-4 rounded-lg border border-orange-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-orange-300">âš ï¸ ç„¡æ³•è­˜åˆ¥æ•¸æ“š</div>
                            <div class="text-xs text-orange-200 mt-2">ç„¡æ³•å¾ä¼ºæœå™¨å›æ‡‰ä¸­æå–æŠ•å¹£æˆ–å‡ºçä¿¡æ¯</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>æ ¼å¼: ${machineData.format} | æ™‚é–“: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // æœ‰æ•ˆçš„æ•¸æ“šé¡¯ç¤º
                html += '<div class="grid grid-cols-2 gap-4 mb-3">';
                
                // é¡¯ç¤ºæŠ•å¹£æ•¸
                if (machineData.plays !== null) {
                    html += `
                        <div class="bg-blue-900/50 p-4 rounded-lg border border-blue-500/50">
                            <div class="text-xs text-blue-300 font-semibold mb-1">âœ… æŠ•å¹£éŠæˆ²æ¬¡æ•¸</div>
                            <div class="text-3xl font-bold text-blue-300">${machineData.plays.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">æŠ•å¹£éŠæˆ²æ¬¡æ•¸</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                // é¡¯ç¤ºå‡ºè²¨æ¬¡æ•¸
                if (machineData.payouts !== null) {
                    html += `
                        <div class="bg-green-900/50 p-4 rounded-lg border border-green-500/50">
                            <div class="text-xs text-green-300 font-semibold mb-1">âœ… ç¦®å“å‡ºçæ¬¡æ•¸</div>
                            <div class="text-3xl font-bold text-green-300">${machineData.payouts.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">ç¦®å“å‡ºçæ¬¡æ•¸</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            // é¡¯ç¤ºæ•¸æ“šæ ¼å¼å’Œæ™‚é–“æˆ³
            const statusColor = isReReadData && !hasValidData ? 'text-yellow-400' : 'text-cyan-400';
            html += `<div class="text-xs text-gray-400 bg-gray-900/50 p-2 rounded">
                <div>æ ¼å¼: <span class="${statusColor} font-semibold">${machineData.format}</span> | æ™‚é–“: <span class="text-cyan-400 font-semibold">${machineData.timestamp}</span></div>
            </div>`;
            
            displayContainer.innerHTML = html;
            
            if (hasValidData) {
                console.log('âœ… UI å·²æˆåŠŸæ›´æ–° - æŠ•å¹£æ•¸: ' + machineData.plays + ', å‡ºçæ•¸: ' + machineData.payouts);
            } else {
                console.log('âš ï¸ ç„¡æ³•æå–æœ‰æ•ˆçš„æ•¸æ“š');
            }
        }
        
        // é–‹å§‹ HTTP è¼ªè©¢
        function startHttpPolling() {
            if (httpPollingTimer) {
                console.log('âš ï¸ HTTP è¼ªè©¢å·²åœ¨é‹è¡Œä¸­');
                return;
            }
            
            httpPollingEnabled = true;
            console.log(`ğŸš€ é–‹å§‹ HTTP è¼ªè©¢ï¼ˆé–“éš”: ${httpPollingInterval}msï¼‰`);
            updateHttpStatus(true, 'è¼ªè©¢ä¸­...');
            
            // ç«‹å³ç™¼é€ç¬¬ä¸€æ¬¡è«‹æ±‚
            sendHttpRequest();
            
            // è¨­å®šå®šæ™‚è¼ªè©¢
            httpPollingTimer = setInterval(() => {
                if (httpPollingEnabled) {
                    sendHttpRequest();
                }
            }, httpPollingInterval);
        }
        
        // åœæ­¢ HTTP è¼ªè©¢
        function stopHttpPolling() {
            if (httpPollingTimer) {
                clearInterval(httpPollingTimer);
                httpPollingTimer = null;
            }
            
            httpPollingEnabled = false;
            console.log('â¹ï¸ HTTP è¼ªè©¢å·²åœæ­¢');
            updateHttpStatus(false, 'å·²åœæ­¢');
        }
        
        // æ›´æ–° HTTP é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateHttpStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator'); // æš«æ™‚ä½¿ç”¨ MQTT çš„å…ƒç´ 
            const statusText = document.getElementById('mqtt-status-text');
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                }
                if (statusText) {
                    statusText.textContent = `âœ… HTTP é€£ç·šä¸­ - ${message} - ${timeStr}`;
                }
            } else {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                }
                if (statusText) {
                    statusText.textContent = `âŒ HTTP æœªé€£ç·š - ${message} - ${timeStr}`;
                }
            }
            
            console.log(`ğŸ“Š HTTP ç‹€æ…‹: ${connected ? 'é€£ç·šä¸­' : 'æœªé€£ç·š'} - ${message}`);
        }
        
        // æ¸¬è©¦ HTTP é€£ç·š
        async function testHttpConnection() {
            console.log('ğŸ§ª æ¸¬è©¦ HTTP é€£ç·š...');
            console.log('ğŸ“ ç›®æ¨™ URL:', buildHttpUrl());
            console.log('ğŸŒ ç•¶å‰åŸŸå:', window.location.origin);
            
            const result = await sendHttpRequest();
            
            if (result) {
                console.log('âœ… HTTP é€£ç·šæ¸¬è©¦æˆåŠŸ');
                alert('âœ… HTTP é€£ç·šæ¸¬è©¦æˆåŠŸï¼\n\næ•¸æ“šå·²æˆåŠŸè¿”å›');
            } else {
                console.log('âŒ HTTP é€£ç·šæ¸¬è©¦å¤±æ•—');
                alert('âŒ HTTP é€£ç·šæ¸¬è©¦å¤±æ•—\n\nå»ºè­°ï¼š\n1. æª¢æŸ¥ç›®æ¨™ä¼ºæœå™¨æ˜¯å¦åœ¨ç·š\n2. æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å° (F12) çš„ Console é¸é …å¡\n3. ç¢ºèªç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸');
            }
        }
        
        // è¨ºæ–· HTTP é€£ç·šå•é¡Œ
        async function diagnoseHttpConnection() {
            console.clear();
            console.log('ğŸ” ===== HTTP é€£ç·šè¨ºæ–·é–‹å§‹ =====');
            console.log('â° è¨ºæ–·æ™‚é–“:', new Date().toLocaleString('zh-TW'));
            console.log('');
            
            console.log('ğŸ“‹ === ç’°å¢ƒä¿¡æ¯ ===');
            console.log('ğŸŒ ç•¶å‰é é¢ URL:', window.location.href);
            console.log('ğŸ“ ç•¶å‰åŸŸå:', window.location.hostname);
            console.log('ğŸ”— ç•¶å‰å”è­°:', window.location.protocol);
            console.log('');
            
            console.log('ğŸ¯ === ç›®æ¨™ä¼ºæœå™¨ä¿¡æ¯ ===');
            const targetUrl = buildHttpUrl();
            console.log('ğŸ”— ç›®æ¨™ URL:', targetUrl);
            console.log('ğŸ“¡ ä¼ºæœå™¨ä½å€:', httpConfig.baseUrl);
            console.log('ğŸ”Œ API ç«¯é»:', httpConfig.endpoint);
            console.log('');
            
            console.log('ğŸ§ª === é€£ç·šæ¸¬è©¦ ===');
            console.log('ğŸ“¤ å˜—è©¦ç›´æ¥è«‹æ±‚...');
            
            try {
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });
                console.log('âœ… ç›´æ¥è«‹æ±‚æˆåŠŸï¼');
                console.log('ğŸ“Š HTTP ç‹€æ…‹ç¢¼:', response.status);
                console.log('ğŸ“‹ Content-Type:', response.headers.get('content-type'));
                const data = await response.text();
                console.log('ğŸ“¥ æ”¶åˆ°è³‡æ–™é•·åº¦:', data.length, 'å­—å…ƒ');
                console.log('ğŸ“„ è³‡æ–™é è¦½:', data.substring(0, 200));
            } catch (directError) {
                console.warn('âŒ ç›´æ¥è«‹æ±‚å¤±æ•—:', directError.message);
                console.log('ğŸ”„ å˜—è©¦ä»£ç†æœå‹™...');
                
                // å˜—è©¦æœ€ç°¡å–®çš„ä»£ç†
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    console.log('ğŸš€ ä»£ç† URL:', proxyUrl.substring(0, 100) + '...');
                    
                    const proxyResponse = await fetch(proxyUrl, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        console.log('âœ… ä»£ç†è«‹æ±‚æˆåŠŸï¼');
                        console.log('ğŸ“ ä»£ç†å›æ‡‰:', proxyData.contents.substring(0, 200));
                    } else {
                        console.error('âŒ ä»£ç†è¿”å› HTTP', proxyResponse.status);
                    }
                } catch (proxyError) {
                    console.error('âŒ ä»£ç†è«‹æ±‚ä¹Ÿå¤±æ•—:', proxyError.message);
                    console.error('ğŸ’¥ æ ¹æœ¬åŸå› ï¼š', proxyError.name);
                    
                    if (proxyError.message.includes('ERR_NAME_NOT_RESOLVED')) {
                        console.error('ğŸ”´ DNS è§£æå¤±æ•— - å¯èƒ½çš„åŸå› ï¼š');
                        console.error('  â€¢ ç¶²è·¯é€£ç·šä¸­æ–·');
                        console.error('  â€¢ åŸŸåä¼ºæœå™¨ç„¡éŸ¿æ‡‰');
                        console.error('  â€¢ é˜²ç«ç‰†æˆ–ä»£ç†é˜»æ­¢');
                    }
                }
            }
            
            console.log('');
            console.log('ğŸ” ===== è¨ºæ–·çµæŸ =====');
        }
        
        // æŠŠè¨ºæ–·å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸ
        window.diagnoseHttpConnection = diagnoseHttpConnection;
        
        // è®“ HTTP å‡½æ•¸åœ¨å…¨åŸŸç¯„åœå¯ç”¨
        window.startHttpPolling = startHttpPolling;
        window.stopHttpPolling = stopHttpPolling;
        window.testHttpConnection = testHttpConnection;
        window.sendHttpRequest = sendHttpRequest;
        
        // ========================================
        // MQTT é…ç½®ï¼ˆå·²æ£„ç”¨ï¼‰
        // ========================================
        const mqttConfig = {
            keepalive: 60,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30000,
            will: {
                topic: 'client/disconnect',
                payload: 'Client Disconnected',
                qos: 0,
                retain: false
            }
        };
        
        // MQTT é€£ç·šç‹€æ…‹ç®¡ç†
        function updateMqttStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator');
            const statusText = document.getElementById('mqtt-status-text');
            const connectBtn = document.getElementById('mqtt-connect-btn');
            const testBtn = document.getElementById('mqtt-test-btn');
            const diagnoseBtn = document.getElementById('mqtt-diagnose-btn');
            const businessTestBtn = document.getElementById('mqtt-business-test-btn');
            const readBtn = document.getElementById('send-read-command');
            
            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                statusText.textContent = 'âœ… å·²é€£æ¥ - ' + timeStr;
                connectBtn.innerHTML = '<span>ä¸­æ–·é€£æ¥</span>';
                connectBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•ã€è¨ºæ–·æŒ‰éˆ•ã€ç‡Ÿæ¥­æ¸¬è©¦æŒ‰éˆ•å’Œè®€å–æŒ‰éˆ•
                if (testBtn) {
                    testBtn.disabled = false;
                    testBtn.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = false;
                    diagnoseBtn.className = 'flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = false;
                    businessTestBtn.className = 'flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = false;
                    readBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition';
                }
                
                // é‡ç½®é‡é€£æ¬¡æ•¸
                mqttReconnectAttempts = 0;
                
                // å•Ÿå‹•å¿ƒè·³æª¢æ¸¬
                startMqttHeartbeat();
                
            } else {
                // æ ¹æ“šç‹€æ…‹è¨­ç½®ä¸åŒçš„æŒ‡ç¤ºå™¨å’Œè¨Šæ¯
                if (message && (message.includes('é€£ç·šä¸­') || message.includes('å»ºç«‹'))) {
                    indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-spin';
                    statusText.textContent = 'ğŸ”„ ' + message;
                } else if (message && message.includes('è¶…æ™‚')) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = 'â° ' + message;
                } else if (message && (message.includes('éŒ¯èª¤') || message.includes('å¤±æ•—'))) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = 'âŒ ' + message;
                } else {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = message || 'âŒ æœªé€£æ¥';
                }
                
                connectBtn.innerHTML = '<span>é€£æ¥ MQTT</span>';
                connectBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // ç¦ç”¨æ¸¬è©¦æŒ‰éˆ•ã€è¨ºæ–·æŒ‰éˆ•ã€ç‡Ÿæ¥­æ¸¬è©¦æŒ‰éˆ•å’Œè®€å–æŒ‰éˆ•
                if (testBtn) {
                    testBtn.disabled = true;
                    testBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = true;
                    diagnoseBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = true;
                    businessTestBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = true;
                    readBtn.className = 'w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed';
                }
                
                // åœæ­¢å¿ƒè·³æª¢æ¸¬
                stopMqttHeartbeat();
            }
            
            mqttConnected = connected;
            window.mqttConnected = connected; // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
            
            // æ§åˆ¶å°æ—¥èªŒ
            console.log('MQTT ç‹€æ…‹æ›´æ–°: ' + (connected ? 'å·²é€£æ¥' : 'æœªé€£æ¥') + (message ? ' - ' + message : '') + ' (' + timeStr + ')');
        }
        
        // æ·»åŠ å‘½ä»¤æ—¥èªŒ
        function addCommandLog(type, message, data = null) {
            const logContainer = document.getElementById('mqtt-command-log');
            if (!logContainer) return;
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¢è¨Šæ¯ï¼Œæ¸…é™¤é è¨­æ–‡å­—
            if (logContainer.querySelector('.text-gray-500')) {
                logContainer.innerHTML = '';
            }
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs p-2 rounded-lg ' + 
                (type === 'send' ? 'bg-blue-900/30 border border-blue-500/30' : 
                 type === 'receive' ? 'bg-green-900/30 border border-green-500/30' :
                 'bg-red-900/30 border border-red-500/30');
            
            let icon = type === 'send' ? 'ğŸ“¤' : type === 'receive' ? 'ğŸ“¥' : 'âŒ';
            let content = `<div class="flex items-start space-x-2">
                <span>${icon}</span>
                <div class="flex-1">
                    <p class="font-medium">[${timestamp}] ${message}</p>`;
            
            if (data) {
                content += `<pre class="mt-1 text-xs bg-gray-900/50 p-1 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            content += `</div></div>`;
            logEntry.innerHTML = content;
            
            // æ·»åŠ åˆ°æ—¥èªŒå®¹å™¨
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // å•Ÿå‹• MQTT å¿ƒè·³æª¢æ¸¬
        function startMqttHeartbeat() {
            stopMqttHeartbeat(); // å…ˆåœæ­¢ç¾æœ‰çš„å¿ƒè·³
            
            mqttHeartbeatTimer = setInterval(function() {
                if (mqttClient && mqttConnected) {
                    try {
                        // ç™¼é€ ping æ¸¬è©¦é€£ç·šç‹€æ…‹
                        const pingTopic = 'system/ping';
                        const pingMessage = {
                            timestamp: new Date().toISOString(),
                            clientId: 'webapp_' + Date.now()
                        };
                        
                        mqttClient.publish(pingTopic, JSON.stringify(pingMessage), { qos: 0 }, function(err) {
                            if (err) {
                                console.warn('MQTT å¿ƒè·³å¤±æ•—:', err);
                                // å¿ƒè·³å¤±æ•—ï¼Œå¯èƒ½éœ€è¦é‡é€£
                                if (mqttAutoReconnect) {
                                    reconnectMqtt();
                                }
                            } else {
                                console.log('âœ“ MQTT å¿ƒè·³æ­£å¸¸');
                            }
                        });
                    } catch (error) {
                        console.error('MQTT å¿ƒè·³æª¢æ¸¬éŒ¯èª¤:', error);
                        if (mqttAutoReconnect) {
                            reconnectMqtt();
                        }
                    }
                }
            }, mqttHeartbeatInterval);
        }
        
        // åœæ­¢ MQTT å¿ƒè·³æª¢æ¸¬
        function stopMqttHeartbeat() {
            if (mqttHeartbeatTimer) {
                clearInterval(mqttHeartbeatTimer);
                mqttHeartbeatTimer = null;
            }
        }
        
        // MQTT è‡ªå‹•é‡é€£
        function reconnectMqtt() {
            if (!mqttAutoReconnect || mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                console.log('åœæ­¢ MQTT é‡é€£ - è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸');
                updateMqttStatus(false, 'é‡é€£å¤±æ•— - è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸');
                return;
            }
            
            mqttReconnectAttempts++;
            console.log('MQTT é‡é€£å˜—è©¦ ' + mqttReconnectAttempts + '/' + mqttMaxReconnectAttempts);
            
            updateMqttStatus(false, 'é‡é€£ä¸­... (ç¬¬ ' + mqttReconnectAttempts + ' æ¬¡)');
            
            // æ¸…ç†ç¾æœ‰é€£ç·š
            if (mqttClient) {
                try {
                    mqttClient.end(true); // å¼·åˆ¶é—œé–‰
                } catch (error) {
                    console.warn('é—œé–‰ MQTT å®¢æˆ¶ç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
                mqttClient = null;
            }
            
            // æ ¹æ“šä¼ºæœå™¨é¡å‹æ±ºå®šé‡è©¦é–“éš”
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            let reconnectDelay = mqttReconnectInterval; // é è¨­ 5 ç§’
            
            if (brokerUrl.includes('update.feiloli.com.tw')) {
                // åŸä¼ºæœå™¨ä½¿ç”¨æ›´é•·çš„é‡è©¦é–“éš”
                reconnectDelay = mqttReconnectIntervalOriginal; // 30 ç§’
                console.log('â° åŸä¼ºæœå™¨é‡é€£é–“éš”ï¼š30 ç§’');
                updateMqttStatus(false, 'ç­‰å¾… 30 ç§’å¾Œé‡è©¦åŸä¼ºæœå™¨... (ç¬¬ ' + mqttReconnectAttempts + ' æ¬¡)');
                addCommandLog('error', `â° åŸä¼ºæœå™¨ç„¡æ³•é€£ç·šï¼Œå°‡åœ¨ 30 ç§’å¾Œé‡è©¦ï¼ˆç¬¬ ${mqttReconnectAttempts} æ¬¡ï¼‰`);
            } else {
                console.log('â° é‡é€£é–“éš”ï¼š5 ç§’');
            }
            
            // å»¶é²å¾Œé‡æ–°é€£ç·š
            mqttReconnectTimer = setTimeout(function() {
                connectMqtt();
            }, reconnectDelay);
        }
        
        // åœæ­¢ MQTT é‡é€£
        function stopMqttReconnect() {
            if (mqttReconnectTimer) {
                clearTimeout(mqttReconnectTimer);
                mqttReconnectTimer = null;
            }
        }
        
        // ä¸»è¦ MQTT é€£ç·šå‡½æ•¸
        function connectMqtt() {
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            const topic = document.getElementById('mqtt-topic').value;
            
            if (!brokerUrl) {
                alert('è«‹è¼¸å…¥ MQTT Broker ä½å€');
                return;
            }
            
            try {
                updateMqttStatus(false, 'å»ºç«‹é€£ç·šä¸­...');
                console.log('é–‹å§‹é€£ç·šåˆ°:', brokerUrl);
                
                // è‡ªå‹•åµæ¸¬ä¸¦ä¿®æ­£å”è­°ï¼ˆHTTPS é é¢éœ€è¦ä½¿ç”¨ wss://ï¼‰
                let finalBrokerUrl = brokerUrl;
                if (window.location.protocol === 'https:' && brokerUrl.startsWith('ws://')) {
                    finalBrokerUrl = brokerUrl.replace('ws://', 'wss://');
                    console.log('âš ï¸ åµæ¸¬åˆ° HTTPS é é¢ï¼Œè‡ªå‹•å°‡ ws:// è½‰æ›ç‚º wss://');
                    console.log('åŸå§‹ URL:', brokerUrl);
                    console.log('ä¿®æ­£å¾Œ URL:', finalBrokerUrl);
                    addCommandLog('error', 'âš ï¸ HTTPS å®‰å…¨é™åˆ¶ï¼šè‡ªå‹•å°‡ ws:// è½‰ç‚º wss://');
                }
                
                // æ ¹æ“šä¸åŒçš„ä¼ºæœå™¨èª¿æ•´é…ç½®
                let customConfig = {...mqttConfig};
                
                // HiveMQ éœ€è¦ç‰¹æ®Šé…ç½®
                if (finalBrokerUrl.includes('broker.hivemq.com')) {
                    customConfig = {
                        keepalive: 60,
                        clean: true,
                        reconnectPeriod: 5000,
                        connectTimeout: 10000,
                        clientId: 'mqtt_client_' + Math.random().toString(16).substr(2, 8)
                    };
                    console.log('ä½¿ç”¨ HiveMQ é…ç½®');
                } else if (finalBrokerUrl.includes('test.mosquitto.org')) {
                    customConfig.connectTimeout = 8000;
                    console.log('ä½¿ç”¨ Mosquitto é…ç½®');
                } else if (finalBrokerUrl.includes('broker.emqx.io')) {
                    customConfig.connectTimeout = 8000;
                    console.log('ä½¿ç”¨ EMQX é…ç½®');
                }
                
                // å‰µå»º MQTT å®¢æˆ¶ç«¯
                console.log('æœ€çµ‚é€£ç·š URL:', finalBrokerUrl);
                mqttClient = mqtt.connect(finalBrokerUrl, customConfig);
                window.mqttClient = mqttClient; // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
                console.log('MQTT å®¢æˆ¶ç«¯å·²å‰µå»ºä¸¦è¨­ç‚ºå…¨åŸŸ');
                
                // è¨­ç½®é€£ç·šè¶…æ™‚
                const connectTimeout = setTimeout(function() {
                    if (!mqttConnected) {
                        const isOriginalServer = finalBrokerUrl.includes('update.feiloli.com.tw');
                        
                        console.error('âŒ MQTT é€£ç·šè¶…æ™‚ (30ç§’)');
                        
                        if (isOriginalServer) {
                            updateMqttStatus(false, 'åŸä¼ºæœå™¨é€£ç·šè¶…æ™‚ - ä¼ºæœå™¨å¯èƒ½é›¢ç·šæˆ–ç¶²è·¯ä¸é€š');
                            addCommandLog('error', 'âŒ åŸä¼ºæœå™¨ (update.feiloli.com.tw:5438) é€£ç·šè¶…æ™‚ï¼Œå°‡åœ¨ 30 ç§’å¾Œé‡è©¦');
                        } else {
                            updateMqttStatus(false, 'é€£ç·šè¶…æ™‚ - è«‹æª¢æŸ¥ä¼ºæœå™¨åœ°å€æˆ–ç¶²è·¯é€£ç·š');
                            addCommandLog('error', 'é€£ç·šè¶…æ™‚ï¼šç„¡æ³•åœ¨ 30 ç§’å…§å»ºç«‹é€£ç·š');
                        }
                        
                        if (mqttClient) {
                            try {
                                mqttClient.end(true);
                            } catch (e) {
                                console.warn('çµæŸå®¢æˆ¶ç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                            }
                        }
                        
                        // å¦‚æœæ˜¯åŸä¼ºæœå™¨ä¸”æœªè‡ªå‹•é‡é€£ï¼Œè©¢å•æ˜¯å¦åˆ‡æ›
                        if (isOriginalServer && !mqttAutoReconnect) {
                            if (confirm('åŸä¼ºæœå™¨ç›®å‰ç„¡æ³•é€£ç·šï¼\n\næ˜¯å¦è¦åˆ‡æ›åˆ° HiveMQ å…¬é–‹æ¸¬è©¦ä¼ºæœå™¨ï¼Ÿ\n\nï¼ˆç³»çµ±å°‡è‡ªå‹•æ¯ 30 ç§’é‡è©¦åŸä¼ºæœå™¨ï¼‰')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        } else if (!isOriginalServer) {
                            // éåŸä¼ºæœå™¨è¶…æ™‚ï¼Œè©¢å•åˆ‡æ›åˆ° HiveMQ
                            if (confirm('é€£ç·šè¶…æ™‚ï¼\n\næ˜¯å¦è¦åˆ‡æ›åˆ° HiveMQ å…¬é–‹ä¼ºæœå™¨ï¼Ÿ')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        }
                    }
                }, 30000);
                
                // é€£ç·šæˆåŠŸäº‹ä»¶
                mqttClient.on('connect', function() {
                    clearTimeout(connectTimeout);
                    console.log('âœ… MQTT é€£ç·šæˆåŠŸï¼');
                    
                    // ç¢ºä¿å…¨åŸŸè®Šæ•¸åŒæ­¥
                    window.mqttClient = mqttClient;
                    window.mqttConnected = true;
                    console.log('âœ… å…¨åŸŸ MQTT è®Šæ•¸å·²åŒæ­¥');
                    
                    updateMqttStatus(true, 'é€£ç·šæˆåŠŸ');
                    addCommandLog('receive', 'âœ… MQTT é€£ç·šå»ºç«‹æˆåŠŸ');
                    
                    // è¨‚é–±ä¸»é¡Œ
                    mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('è¨‚é–±ä¸»é¡Œå¤±æ•—:', err);
                            addCommandLog('error', 'è¨‚é–±ä¸»é¡Œå¤±æ•—: ' + topic);
                        } else {
                            console.log('âœ… è¨‚é–±ä¸»é¡ŒæˆåŠŸ:', topic);
                            addCommandLog('receive', 'âœ… å·²è¨‚é–±ä¸»é¡Œ: ' + topic);
                        }
                    });
                    
                    // é¡å¤–è¨‚é–±ä¸€äº›å¯èƒ½çš„å›æ‡‰ä¸»é¡Œé€²è¡Œæ¸¬è©¦
                    const additionalTopics = ['coffeelens/+', 'machine/+', 'device/+', 'test/echo'];
                    additionalTopics.forEach(additionalTopic => {
                        mqttClient.subscribe(additionalTopic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn('è¨‚é–±é¡å¤–ä¸»é¡Œå¤±æ•—:', additionalTopic, err);
                            } else {
                                console.log('âœ… è¨‚é–±é¡å¤–ä¸»é¡ŒæˆåŠŸ:', additionalTopic);
                            }
                        });
                    });
                });
                
                // è¨Šæ¯æ¥æ”¶äº‹ä»¶
                mqttClient.on('message', function(topic, message) {
                    console.log('ğŸ”¥ æ”¶åˆ°ä»»ä½• MQTT è¨Šæ¯:', { topic, message: message.toString() });
                    try {
                        handleMqttMessage(topic, message.toString());
                    } catch (error) {
                        console.error('è™•ç† MQTT è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        addCommandLog('error', 'è¨Šæ¯è™•ç†éŒ¯èª¤: ' + error.message);
                    }
                });
                
                // éŒ¯èª¤äº‹ä»¶
                mqttClient.on('error', function(error) {
                    clearTimeout(connectTimeout);
                    console.error('âŒ MQTT éŒ¯èª¤:', error);
                    
                    const brokerUrl = document.getElementById('mqtt-broker-url').value;
                    const isOriginalServer = brokerUrl.includes('update.feiloli.com.tw');
                    
                    let errorMsg = error.message || 'æœªçŸ¥éŒ¯èª¤';
                    if (errorMsg.includes('connack timeout')) {
                        errorMsg = 'é€£ç·šè¶…æ™‚ - ä¼ºæœå™¨æœªå›æ‡‰';
                        if (isOriginalServer) {
                            errorMsg += ' (åŸä¼ºæœå™¨ç›®å‰ç„¡æ³•é€£ç·šï¼Œå°‡åœ¨ 30 ç§’å¾Œé‡è©¦)';
                        }
                    } else if (errorMsg.includes('Connection refused')) {
                        errorMsg = 'é€£ç·šè¢«æ‹’ - è«‹æª¢æŸ¥ä¼ºæœå™¨åœ°å€';
                    } else if (errorMsg.includes('getaddrinfo ENOTFOUND')) {
                        errorMsg = 'æ‰¾ä¸åˆ°ä¼ºæœå™¨ - è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢º';
                    }
                    
                    updateMqttStatus(false, 'é€£ç·šéŒ¯èª¤: ' + errorMsg);
                    addCommandLog('error', 'âŒ MQTT éŒ¯èª¤: ' + errorMsg);
                    
                    // å¦‚æœæ˜¯åŸä¼ºæœå™¨ï¼Œå»ºè­°åˆ‡æ›
                    if (isOriginalServer && mqttReconnectAttempts >= 3) {
                        addCommandLog('error', 'ğŸ’¡ å»ºè­°ï¼šåŸä¼ºæœå™¨é€£ç·šå¤±æ•—å¤šæ¬¡ï¼Œå¯é»æ“Šã€Œâ­ HiveMQ å…¬é–‹ã€åˆ‡æ›åˆ°æ¸¬è©¦ä¼ºæœå™¨');
                    }
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        const retryDelay = isOriginalServer ? 3000 : 2000;
                        setTimeout(function() {
                            reconnectMqtt();
                        }, retryDelay);
                    } else if (mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                        addCommandLog('error', `âŒ å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (${mqttMaxReconnectAttempts} æ¬¡)ï¼Œè«‹æ‰‹å‹•é‡æ–°é€£ç·šæˆ–åˆ‡æ›ä¼ºæœå™¨`);
                    }
                });
                
                // é€£ç·šé—œé–‰äº‹ä»¶
                mqttClient.on('close', function() {
                    clearTimeout(connectTimeout);
                    console.log('ğŸ”Œ MQTT é€£ç·šå·²é—œé–‰');
                    updateMqttStatus(false, 'é€£ç·šå·²é—œé–‰');
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        setTimeout(function() {
                            reconnectMqtt();
                        }, 1000);
                    }
                });
                
                // é›¢ç·šäº‹ä»¶
                mqttClient.on('offline', function() {
                    console.warn('âš ï¸ MQTT å®¢æˆ¶ç«¯é›¢ç·š');
                    updateMqttStatus(false, 'å®¢æˆ¶ç«¯é›¢ç·š');
                });
                
                // é‡é€£äº‹ä»¶
                mqttClient.on('reconnect', function() {
                    console.log('ğŸ”„ MQTT æ­£åœ¨é‡é€£...');
                    updateMqttStatus(false, 'æ­£åœ¨é‡é€£...');
                });
                
            } catch (error) {
                console.error('âŒ MQTT é€£ç·šåˆå§‹åŒ–å¤±æ•—:', error);
                updateMqttStatus(false, 'åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }
        
        // æ–·é–‹ MQTT é€£ç·š
        function disconnectMqtt() {
            console.log('åŸ·è¡Œ MQTT æ–·é–‹é€£æ¥');
            mqttAutoReconnect = false; // åœæ­¢è‡ªå‹•é‡é€£
            stopMqttReconnect(); // åœæ­¢é‡é€£å®šæ™‚å™¨
            stopMqttHeartbeat(); // åœæ­¢å¿ƒè·³æª¢æ¸¬
            
            if (mqttClient) {
                try {
                    mqttClient.end();
                    mqttClient = null;
                } catch (error) {
                    console.error('æ–·é–‹ MQTT é€£ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }
            
            // æ¸…ç†å…¨åŸŸè®Šæ•¸
            window.mqttClient = null;
            window.mqttConnected = false;
            console.log('âœ… å…¨åŸŸ MQTT è®Šæ•¸å·²æ¸…ç†');
            
            updateMqttStatus(false, 'å·²æ–·é–‹é€£ç·š');
            mqttReconnectAttempts = 0;
        }
        
        // è§£æå¨ƒå¨ƒæ©Ÿ MQTT è³‡æ–™
        function parseMachineData(hexData) {
            // è§£æå¨ƒå¨ƒæ©Ÿå›å‚³çš„ hex è³‡æ–™
            try {
                if (!hexData || hexData.length < 2) { // è‡³å°‘éœ€è¦ 1 byte (2 hex chars)
                    console.warn('è³‡æ–™é•·åº¦ä¸è¶³:', hexData?.length);
                    return null;
                }
                
                console.log('æ”¶åˆ°æ©Ÿå°è³‡æ–™ï¼Œé•·åº¦:', hexData.length, 'å…§å®¹:', hexData);
                
                // è™•ç†ç°¡çŸ­çš„ç‹€æ…‹å›æ‡‰ï¼ˆå¦‚ "1"ï¼‰
                if (hexData.length < 20) {
                    return {
                        rawHex: hexData,
                        statusCode: parseInt(hexData, 16),
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: true,
                        message: `æ”¶åˆ°ç‹€æ…‹ç¢¼: ${hexData}`
                    };
                }
                
                // å°‡ hex å­—ä¸²è½‰æ›ç‚º bytes
                const bytes = [];
                for (let i = 0; i < hexData.length; i += 2) {
                    bytes.push(parseInt(hexData.substr(i, 2), 16));
                }
                
                // æ ¹æ“šæ‚¨æä¾›çš„å”è­°è§£ææ‰€æœ‰è³‡æ–™
                const data = {
                    // åŸºæœ¬å¸³å‹™è³‡æ–™
                    coinCount: 0,
                    payoutCount: 0,
                    
                    // è©³ç´°é›»å£“è³‡æ–™ (Byte33-38)
                    voltageData: {
                        strongVoltage: bytes[33] || 0,        // B1.å¼·é›»å£“
                        mediumVoltage: bytes[34] || 0,        // B2.ä¸­é›»å£“  
                        weakVoltage: bytes[35] || 0,          // B3.å¼±é›»å£“
                        heightToTop: bytes[36] || 0,          // B4.ä¸­å£“è·é›¢é ‚é»é«˜åº¦
                        clampVoltage: bytes[37] || 0          // B5.ä¿å¤¾å¼·é›»å£“
                    },
                    
                    // ç‡Ÿé‹è³‡æ–™ (Byte39-48)
                    operationData: {
                        winRateBank: (bytes[40] << 8) | bytes[39],          // C1.ä¸­çç‡éŠ€è¡Œ
                        coinGameCount: (bytes[42] << 8) | bytes[41],        // C2.æŠ•å¹£éŠæˆ²æ¬¡æ•¸
                        prizeCount: (bytes[44] << 8) | bytes[43],           // C3.ç¦®å“å‡ºçæ¬¡æ•¸
                        accumulatedAmount1: (bytes[46] << 8) | bytes[45],   // C4.ç´¯åŠ é‡‘é¡æŸ¥è©¢ç¬¬1ç­†
                        accumulatedAmount2: (bytes[48] << 8) | bytes[47],   // C4.ç´¯åŠ é‡‘é¡æŸ¥è©¢ç¬¬2ç­†
                        accumulatedAmount3: (bytes[50] << 8) | bytes[49]    // C4.ç´¯åŠ é‡‘é¡æŸ¥è©¢ç¬¬3ç­†
                    },
                    
                    // åŸå§‹ bytes é™£åˆ—ä¾›é™¤éŒ¯ä½¿ç”¨
                    rawBytes: bytes,
                    rawHex: hexData,
                    parseTime: new Date().toLocaleString()
                };
                
                // è§£æåŸºæœ¬æŠ•å¹£å’Œå‡ºè²¨æ•¸æ“š (å‡è¨­åœ¨å‰é¢çš„ bytes)
                if (bytes.length >= 10) {
                    data.coinCount = bytes[2] | (bytes[3] << 8) | (bytes[4] << 16) | (bytes[5] << 24);
                    data.payoutCount = bytes[6] | (bytes[7] << 8) | (bytes[8] << 16) | (bytes[9] << 24);
                }
                
                console.log('å®Œæ•´è§£ææ©Ÿå°è³‡æ–™:', data);
                return data;
                
            } catch (error) {
                console.error('è§£ææ©Ÿå°è³‡æ–™å¤±æ•—:', error);
                return null;
            }
        }
        
        // è™•ç† MQTT è¨Šæ¯
        function handleMqttMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                document.getElementById('last-mqtt-update').textContent = new Date().toLocaleString();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ©Ÿå°ç‹€æ…‹å›æ‡‰ï¼ˆåŒ…å« machine_name, machine_ip ç­‰ï¼‰
                if (data.machine_name && data.machine_ip) {
                    console.log('ğŸ¯ æ”¶åˆ°æ©Ÿå°ç‹€æ…‹å›æ‡‰:', data);
                    addCommandLog('receive', `æ”¶åˆ°æ©Ÿå°ç‹€æ…‹ - ${data.machine_name} (${data.machine_ip})`, data);
                    
                    // é¡¯ç¤ºæ©Ÿå°ç‹€æ…‹è³‡è¨Š
                    showStatusMessage(`æ©Ÿå° ${data.machine_name} å›æ‡‰: CPU ${data.cpu_usage}%, è¨˜æ†¶é«” ${data.memory_usage}%, å„²å­˜ ${data.storage_usage}%`, 'success');
                    
                    // å˜—è©¦æ ¹æ“š IP æˆ–åç¨±æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°
                    const matchedMachine = appData.machines.find(m => 
                        m.ip === data.machine_ip || 
                        m.name === data.machine_name ||
                        m.id === data.machine_name
                    );
                    
                    if (matchedMachine) {
                        console.log('âœ… æ‰¾åˆ°å°æ‡‰æ©Ÿå°:', matchedMachine);
                        // æ›´æ–°æ©Ÿå°ç‹€æ…‹è³‡è¨Š
                        matchedMachine.lastResponse = new Date().toISOString();
                        matchedMachine.status = {
                            cpu_usage: data.cpu_usage,
                            memory_usage: data.memory_usage,
                            storage_usage: data.storage_usage,
                            machine_ip: data.machine_ip
                        };
                    } else {
                        console.log('âš ï¸ ç„¡æ³•åŒ¹é…æ©Ÿå°ï¼Œå»ºè­°æ·»åŠ æ©Ÿå°è¨˜éŒ„');
                        addCommandLog('receive', 'âš ï¸ æ©Ÿå°å›æ‡‰ä½†æœªåœ¨ç³»çµ±ä¸­æ‰¾åˆ°å°æ‡‰è¨˜éŒ„');
                    }
                    
                    return; // ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦é€²ä¸€æ­¥è™•ç†
                }
                
                // è¨˜éŒ„æ”¶åˆ°çš„è¨Šæ¯åˆ°å‘½ä»¤æ—¥èªŒ
                if (data.cmd === 're_readdata') {
                    addCommandLog('receive', `æ”¶åˆ°è®€å–å›æ‡‰ - MAC: ${data.mac}, è¨­å‚™ID: ${data.devid}, ä»»å‹™ID: ${data.taskid}`, data);
                    
                    // é¡¯ç¤ºè³‡æ–™é•·åº¦
                    if (data.parm) {
                        const byteLength = data.parm.length / 2;
                        console.log(`âœ… æ”¶åˆ° ${byteLength} ä½å…ƒçµ„è³‡æ–™`);
                    }
                } else {
                    addCommandLog('receive', `æ”¶åˆ°è¨Šæ¯ - å‘½ä»¤: ${data.cmd || 'æœªçŸ¥'}`, data);
                }
                
                // è™•ç†æ©Ÿå°å›æ‡‰è³‡æ–™
                if ((data.cmd === 're_readdata' || data.cmd === 're_stat') && data.parm) {
                    console.log(`æ”¶åˆ° ${data.cmd} å›æ‡‰ï¼ŒMAC: ${data.mac}, è³‡æ–™: ${data.parm}`);
                    
                    const machineData = parseMachineData(data.parm);
                    console.log('è§£æå¾Œçš„æ©Ÿå°è³‡æ–™:', machineData);
                    
                    if (machineData) {
                        // æ ¹æ“š MAC ä½å€æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°
                        const machineInfo = findMachineByMac(data.mac);
                        console.log('å°‹æ‰¾æ©Ÿå°çµæœ:', machineInfo);
                        
                        if (machineInfo) {
                            console.log('æ‰¾åˆ°å°æ‡‰æ©Ÿå°:', machineInfo.id);
                            
                            // å¦‚æœåªæ˜¯ç‹€æ…‹å›æ‡‰ï¼Œé¡¯ç¤ºç°¡åŒ–ä¿¡æ¯ï¼Œä½†ä»ç„¶é¡¯ç¤ºè©³ç´°é¢æ¿
                            if (machineData.isStatusOnly) {
                                console.log('é€™æ˜¯ç‹€æ…‹å›æ‡‰ï¼Œé¡¯ç¤ºç‹€æ…‹å’Œè©³ç´°é¢æ¿');
                                showStatusMessage(`æ©Ÿå° ${machineInfo.id} ç‹€æ…‹: ${machineData.message}`, 'info');
                                // å³ä½¿æ˜¯ç‹€æ…‹å›æ‡‰ä¹Ÿé¡¯ç¤ºè©³ç´°é¢æ¿
                                showMachineDetailPanel(machineInfo, machineData);
                            } else {
                                console.log('é€™æ˜¯å®Œæ•´è³‡æ–™å›æ‡‰ï¼Œæ›´æ–°æ©Ÿå°è³‡æ–™');
                                updateMachineFromMqtt(machineInfo, machineData);
                            }
                        } else {
                            console.warn('æ‰¾ä¸åˆ° MAC å°æ‡‰çš„æ©Ÿå°:', data.mac);
                            console.log('ç›®å‰æ©Ÿå°åˆ—è¡¨:', appData.machines.map(m => ({ id: m.id, mac: m.mac })));
                            showStatusMessage(`æ”¶åˆ°æœªçŸ¥æ©Ÿå° ${data.mac} çš„å›æ‡‰`, 'info');
                        }
                    } else {
                        console.warn('ç„¡æ³•è§£ææ©Ÿå°è³‡æ–™:', data.parm);
                    }
                }
                
                console.log('æ”¶åˆ° MQTT è¨Šæ¯:', { topic, data });
            } catch (error) {
                console.error('è™•ç† MQTT è¨Šæ¯å¤±æ•—:', error);
                addCommandLog('error', 'è¨Šæ¯è™•ç†å¤±æ•—: ' + error.message);
            }
        }
        
        // æ ¹æ“š MAC ä½å€æ‰¾æ©Ÿå°
        function findMachineByMac(mac) {
            return appData.machines.find(machine => machine.mac === mac);
        }
        
        // å¾ MQTT è³‡æ–™æ›´æ–°æ©Ÿå°è³‡è¨Š
        function updateMachineFromMqtt(machine, mqttData) {
            console.log('=== é–‹å§‹æ›´æ–°æ©Ÿå°è³‡æ–™ ===');
            console.log('æ©Ÿå°è³‡è¨Š:', machine);
            console.log('MQTT è³‡æ–™:', mqttData);
            
            // è¨ˆç®—æ–°å¢çš„æŠ•å¹£å’Œå‡ºè²¨æ•¸
            const newCoins = Math.max(0, mqttData.coinCount - (machine.mqttLastCoinCount || 0));
            const newPayouts = Math.max(0, mqttData.payoutCount - (machine.mqttLastPayoutCount || 0));
            
            // å„²å­˜å®Œæ•´çš„ MQTT è³‡æ–™åˆ°æ©Ÿå°ç‰©ä»¶
            machine.mqttDetailData = mqttData;
            
            console.log('æº–å‚™é¡¯ç¤ºæ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿...');
            // é¡¯ç¤ºè©³ç´°è³‡æ–™é¢æ¿
            showMachineDetailPanel(machine, mqttData);
            
            if (newCoins > 0 || newPayouts > 0) {
                // è‡ªå‹•æ–°å¢è¨˜å¸³è¨˜éŒ„
                const today = new Date().toISOString().split('T')[0];
                addMqttRecord(machine.id, today, newCoins * COIN_VALUE, newPayouts);
                
                // æ›´æ–°æ©Ÿå°çš„ MQTT è¨ˆæ•¸å™¨
                machine.mqttLastCoinCount = mqttData.coinCount;
                machine.mqttLastPayoutCount = mqttData.payoutCount;
                
                // å„²å­˜åˆ° Firebase
                saveMachineData();
                
                console.log(`æ©Ÿå° ${machine.id} MQTT è‡ªå‹•æ›´æ–°: +${newCoins}å¹£ +${newPayouts}è²¨`);
            }
        }
        
        // è‡ªå‹•æ–°å¢ MQTT è¨˜éŒ„
        function addMqttRecord(machineId, date, revenue, payouts) {
            const existingRecord = appData.history.find(r => 
                r.machineId === machineId && r.date === date
            );
            
            if (existingRecord) {
                // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                existingRecord.totalRevenue += revenue;
                existingRecord.totalPayouts += payouts;
            } else {
                // æ–°å¢è¨˜éŒ„
                appData.history.push({
                    id: Date.now().toString(),
                    machineId,
                    date,
                    totalRevenue: revenue,
                    totalPayouts: payouts,
                    autoAdded: true // æ¨™è¨˜ç‚ºè‡ªå‹•æ–°å¢
                });
            }
            
            saveHistoryData();
            refreshCurrentView();
        }

        // --- END: MQTT åŠŸèƒ½ ---

        // --- GLOBAL STATE ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '' };
        let currentSort = { key: 'id', direction: 'asc' };
        let selectedGroupId = null;
        let selectedGroupName = '';
        let selectedStoreId = null; 
        let selectedStoreName = ''; 
        let confirmCallback = null;

        function normalizeCount(value) {
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }
        
        // è‡ªå‹•è¼ªè©¢è¨­å®š
    let autoPollOnLoadTimer = null;
    const AUTO_POLL_DELAY = 1000; // 1ç§’å»¶é²
    let suppressNextAutoPoll = false;
        
        // ğŸš€ è‡ªå‹•è¼ªè©¢è¨­å®šç®¡ç†å‡½æ•¸
        function getAutoPollOnLoadSetting() {
            const key = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            const saved = localStorage.getItem(key);
            return saved === 'true';
        }
        
        function setAutoPollOnLoadSetting(enabled) {
            const key = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            localStorage.setItem(key, enabled.toString());
            console.log(`ğŸ’¾ è‡ªå‹•è¼ªè©¢è¨­å®šå·²ä¿å­˜: ${key} = ${enabled}`);
        }
        
        // âš¡ ç›´æ¥è®€å–æ‰€æœ‰æ©Ÿå°æ•¸æ“š (ä¸ç™¼é€è¨Šæ¯,ä¸ç­‰å¾…,ç”¨æ–¼è‡ªå‹•è¼ªè©¢)
        async function directReadAllMachines() {
            console.log('\n' + '='.repeat(70));
            console.log('âš¡ ç›´æ¥è®€å–æ¨¡å¼ (ä¸ç™¼é€è¨Šæ¯,ç«‹å³è®€å–)');
            console.log('='.repeat(70));
            
            const startTime = Date.now();
            
            // ç²å–ç•¶å‰é–€å¸‚çš„æ‰€æœ‰æ©Ÿå°
            if (!appData.machines || appData.machines.length === 0) {
                showStatusMessage('âŒ ç•¶å‰é–€å¸‚æ²’æœ‰å¯è¼ªè©¢çš„æ©Ÿå°', 'error');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„ MAC åœ°å€
            const uniqueMacs = [...new Set(appData.machines
                .filter(machine => machine.mac && machine.mac.trim() !== '')
                .map(machine => machine.mac))];
            
            console.log(`ğŸ“‹ æº–å‚™ç›´æ¥è®€å– ${uniqueMacs.length} å°æ©Ÿå™¨`);
            showStatusMessage(`ğŸš€ é–‹å§‹ç›´æ¥è®€å– ${uniqueMacs.length} å€‹ MAC ä½å€...`, 'info');
            
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;
            
            // ============================================
            // âš¡ ä¸¦è¡Œè®€å–æ‰€æœ‰ MAC çš„æ•¸æ“š (ç„¡ç­‰å¾…,ç«‹å³åŸ·è¡Œ,æ¸›å°‘é‡è©¦)
            // ============================================
            const fetchPromises = uniqueMacs.map(async (mac, index) => {
                try {
                    // ä½¿ç”¨è¼ƒå°‘çš„é‡è©¦æ¬¡æ•¸å’Œè¼ƒçŸ­çš„å»¶é²,æå‡é€Ÿåº¦
                    const result = await fetchWithRetry(mac, 1, 500, null); // åªé‡è©¦1æ¬¡,é–“éš”500ms
                    
                    if (result && validateMachineData(result)) {
                        console.log(`âœ… [${index + 1}/${uniqueMacs.length}] ${mac} - è®€å–æˆåŠŸ`);
                        
                        handleHttpResponse(result, mac, null);
                        addCommandLog('receive', `ç›´æ¥è®€å–æˆåŠŸ - MAC: ${mac}`, result);
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`âš ï¸ [${index + 1}/${uniqueMacs.length}] ${mac} - è®€å–å¤±æ•—`);
                        addCommandLog('error', `ç›´æ¥è®€å–å¤±æ•— - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`âŒ [${index + 1}/${uniqueMacs.length}] ${mac} - ç•°å¸¸: ${error.message}`);
                    addCommandLog('error', `ç›´æ¥è®€å–ç•°å¸¸: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // ç­‰å¾…æ‰€æœ‰è®€å–å®Œæˆ
            const results = await Promise.all(fetchPromises);
            
            // çµ±è¨ˆçµæœ
            const successCount = results.filter(r => r.success).length;
            
            // ============================================
            // ğŸ“Š çµ±è¨ˆçµæœ
            // ============================================
            const endTime = Date.now();
            const pollDuration = ((endTime - startTime) / 1000).toFixed(1);
            
            console.log('='.repeat(70));
            console.log(`ğŸ“Š ç›´æ¥è®€å–å®Œæˆ - ${pollDuration}ç§’ - æˆåŠŸ: ${successCount}/${uniqueMacs.length}`);
            console.log('='.repeat(70));
            
            const summaryMsg = `âœ… ç›´æ¥è®€å–å®Œæˆï¼âš¡ (${pollDuration}ç§’) - æˆåŠŸ: ${successCount}/${uniqueMacs.length}`;
            
            showStatusMessage(summaryMsg, 'success');
            
            // åˆ·æ–°è¡¨æ ¼
            refreshAutoRecordTable();
        }
        
    // ğŸš€ åŸ·è¡Œè‡ªå‹•è¼ªè©¢ï¼ˆé–€å¸‚é€²å…¥å¾Œ1ç§’è§¸ç™¼ï¼‰
        function triggerAutoPollOnLoad() {
            console.log('ğŸ” triggerAutoPollOnLoad è¢«å‘¼å«');
            console.log(`   selectedGroupId: ${selectedGroupId}`);
            console.log(`   selectedStoreId: ${selectedStoreId}`);
            
            if (!selectedGroupId || !selectedStoreId) {
                console.log('âš ï¸ æœªé¸æ“‡é–€å¸‚ï¼Œè·³éè‡ªå‹•è¼ªè©¢');
                return;
            }
            
            const isEnabled = getAutoPollOnLoadSetting();
            const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            console.log(`ğŸ” æª¢æŸ¥è‡ªå‹•è¼ªè©¢è¨­å®š:`);
            console.log(`   è¨­å®šéµå€¼: ${settingKey}`);
            console.log(`   localStorage å€¼: ${localStorage.getItem(settingKey)}`);
            console.log(`   è§£æçµæœ: ${isEnabled ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`);
            
            if (!isEnabled) {
                console.log('â­ï¸ è‡ªå‹•è¼ªè©¢åŠŸèƒ½æœªå•Ÿç”¨ï¼Œè·³é');
                return;
            }
            
            console.log(`ğŸš€ æº–å‚™ç«‹å³åŸ·è¡Œè‡ªå‹•è®€å–ï¼ˆå…©æ¬¡ï¼Œä¸ç™¼é€è¨Šæ¯ï¼‰...`);
            
            // é¡¯ç¤ºé–‹å§‹æç¤º
            showStatusMessage('ğŸš€ é–‹å§‹è‡ªå‹•è¼ªè©¢è®€å–ï¼ˆç¬¬1æ¬¡ï¼‰...', 'info');
            
            // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
            if (autoPollOnLoadTimer) {
                clearTimeout(autoPollOnLoadTimer);
            }
            
            // ç«‹å³åŸ·è¡Œç¬¬ä¸€æ¬¡è®€å–ï¼Œç„¡éœ€å»¶é²
            autoPollOnLoadTimer = setTimeout(async () => {
                console.log('ğŸ¯ é–‹å§‹åŸ·è¡Œç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–ï¼ˆé–€å¸‚é€²å…¥è§¸ç™¼ï¼Œè·³éç™¼é€è¨Šæ¯ï¼‰');
                autoPollOnLoadTimer = null;
                
                try {
                    // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„æ©Ÿå°
                    if (!appData || !appData.machines || appData.machines.length === 0) {
                        console.log('âš ï¸ æ²’æœ‰å¯ç”¨çš„æ©Ÿå°ï¼Œè·³éè‡ªå‹•è®€å–');
                        showStatusMessage('âš ï¸ æ²’æœ‰å¯ç”¨çš„æ©Ÿå°', 'warning');
                        return;
                    }
                    
                    // åŸ·è¡Œç¬¬ä¸€æ¬¡ç›´æ¥è®€å–ï¼ˆä¸ç™¼é€è¨Šæ¯ï¼‰
                    console.log('ğŸ”„ åŸ·è¡Œç¬¬ä¸€æ¬¡ç›´æ¥è®€å–ï¼ˆä¸ç™¼é€è¨Šæ¯ï¼‰...');
                    await directReadAllMachines();
                    console.log('âœ… ç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–åŸ·è¡Œå®Œæˆ');
                    
                    // é¡¯ç¤ºç¬¬ä¸€æ¬¡å®Œæˆé€šçŸ¥
                    showPollNotification('ğŸš€ ç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–å·²å®Œæˆ', 'green');
                    
                    // ç­‰å¾…1ç§’å¾ŒåŸ·è¡Œç¬¬äºŒæ¬¡è®€å–
                    console.log('â³ ç­‰å¾… 1 ç§’å¾ŒåŸ·è¡Œç¬¬äºŒæ¬¡è®€å–...');
                    showStatusMessage('â³ ç­‰å¾… 1 ç§’å¾Œé€²è¡Œç¬¬äºŒæ¬¡è®€å–...', 'info');
                    
                    setTimeout(async () => {
                        try {
                            console.log('ğŸ”„ åŸ·è¡Œç¬¬äºŒæ¬¡ç›´æ¥è®€å–ï¼ˆä¸ç™¼é€è¨Šæ¯ï¼‰...');
                            showStatusMessage('ğŸš€ é–‹å§‹è‡ªå‹•è¼ªè©¢è®€å–ï¼ˆç¬¬2æ¬¡ï¼‰...', 'info');
                            
                            await directReadAllMachines();
                            console.log('âœ… ç¬¬äºŒæ¬¡è‡ªå‹•è®€å–åŸ·è¡Œå®Œæˆ');
                            
                            // é¡¯ç¤ºç¬¬äºŒæ¬¡å®Œæˆé€šçŸ¥
                            showPollNotification('âœ¨ ç¬¬äºŒæ¬¡è‡ªå‹•è®€å–å·²å®Œæˆ', 'blue');
                            
                        } catch (error) {
                            console.error('âŒ ç¬¬äºŒæ¬¡è‡ªå‹•è®€å–åŸ·è¡Œå¤±æ•—:', error);
                            showPollNotification('âŒ ç¬¬äºŒæ¬¡è‡ªå‹•è®€å–å¤±æ•—', 'red');
                            showStatusMessage('âŒ ç¬¬äºŒæ¬¡è‡ªå‹•è®€å–å¤±æ•—', 'error');
                        }
                    }, 1000); // ç­‰å¾…1ç§’
                    
                } catch (error) {
                    console.error('âŒ ç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–åŸ·è¡Œå¤±æ•—:', error);
                    showPollNotification('âŒ ç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–å¤±æ•—', 'red');
                    showStatusMessage('âŒ ç¬¬ä¸€æ¬¡è‡ªå‹•è®€å–å¤±æ•—', 'error');
                }
            }, 100); // 100ms å¾Œç«‹å³é–‹å§‹ï¼ˆå¹¾ä¹ç«‹å³ï¼‰
        }
        
        // é¡¯ç¤ºè¼ªè©¢é€šçŸ¥çš„è¼”åŠ©å‡½æ•¸
        function showPollNotification(message, color = 'green') {
            const colorClasses = {
                'green': 'bg-green-600',
                'blue': 'bg-blue-600',
                'red': 'bg-red-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colorClasses[color]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ğŸš€ æ¸…ç†è‡ªå‹•è¼ªè©¢è¨ˆæ™‚å™¨ï¼ˆåˆ‡æ›é–€å¸‚æ™‚å‘¼å«ï¼‰
        function clearAutoPollTimer() {
            if (autoPollOnLoadTimer) {
                clearTimeout(autoPollOnLoadTimer);
                autoPollOnLoadTimer = null;
                console.log('ğŸ§¹ å·²æ¸…ç†è‡ªå‹•è¼ªè©¢è¨ˆæ™‚å™¨');
            }
        }
        

        // --- PAGE & ELEMENT SELECTORS ---
        const groupSelectionPage = document.getElementById('group-selection-page');
        const storeSelectionPage = document.getElementById('store-selection-page');
        const reportPage = document.getElementById('report-page');
        const adminPage = document.getElementById('admin-page');
        
        const groupListContainer = document.getElementById('group-list');
        const createGroupForm = document.getElementById('create-group-form');
        const backToGroupsBtn = document.getElementById('back-to-groups-btn');
        const adminBtn = document.getElementById('admin-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');

        const storeListContainer = document.getElementById('store-list');
        const createStoreForm = document.getElementById('create-store-form');
        const backToStoresBtn = document.getElementById('back-to-stores-btn');
        const reportPeriodSelector = document.getElementById('report-period-selector');
        const reportDatePicker = document.getElementById('report-date-picker');
        const downloadAllStoresBtn = document.getElementById('download-all-stores-report-btn');
    const openStoreReportViewBtn = document.getElementById('open-store-report-view-btn');
        const openWeeklyTrendBtn = document.getElementById('open-weekly-trend-btn');
        const openMultiWeeklyTrendBtn = document.getElementById('open-multi-weekly-trend-btn');
        const weeklyTrendStartDate = document.getElementById('weekly-trend-start-date');
        const weeklyTrendEndDate = document.getElementById('weekly-trend-end-date');
        const allTabs = document.querySelectorAll('.tab-btn');
        const allTabContents = document.querySelectorAll('.tab-content');
        const searchInput = document.getElementById('searchInput');
        const sortableHeaders = document.querySelectorAll('.table-header-sortable');
        const statsControls = document.getElementById('stats-controls');
        const summaryControls = document.getElementById('summary-controls');
        const psdControls = document.getElementById('psd-controls');
        const psdCustomRange = document.getElementById('psd-custom-range');
        const psdStartDate = document.getElementById('psd-start-date');
        const psdEndDate = document.getElementById('psd-end-date');
        const psdCalculateBtn = document.getElementById('psd-calculate-btn');
        const psdWeeklyTrendBtn = document.getElementById('psd-weekly-trend-btn');
        const addMachineForm = document.getElementById('add-machine-form');
        const machineListTableBody = document.getElementById('machine-list-table-body');
        const historyTableBody = document.getElementById('history-table-body');
        const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
        const locationPresets = document.getElementById('location-presets');
        const selectAllStoresBtn = document.getElementById('select-all-stores-btn');
        const deselectAllStoresBtn = document.getElementById('deselect-all-stores-btn');
        const pollAllStoresBtn = document.getElementById('poll-all-stores-btn');
        const readAllStoresBtn = document.getElementById('read-all-stores-btn');
        const recalculateAllBtn = document.getElementById('recalculate-all-btn');

        // ç®¡ç†è€…ç•Œé¢å…ƒç´ 
        const adminPasswordForm = document.getElementById('admin-password-form');
        const guestAccountForm = document.getElementById('guest-account-form');
        const guestAccountsTable = document.getElementById('guest-accounts-table');
        const groupPermissions = document.getElementById('group-permissions');
        const cancelGuestEditBtn = document.getElementById('cancel-guest-edit');
        const exportConfigBtn = document.getElementById('export-config-btn');
        const importConfigBtn = document.getElementById('import-config-btn');
        const resetConfigBtn = document.getElementById('reset-config-btn');
        const configFileInput = document.getElementById('config-file-input');

        
        // Modal selectors
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const editStoreModal = document.getElementById('edit-store-modal');
        const editStoreForm = document.getElementById('edit-store-form');
        const editStoreCancelBtn = document.getElementById('edit-store-cancel-btn');
        
        const cloneStoreModal = document.getElementById('clone-store-modal');
        const cloneStoreForm = document.getElementById('clone-store-form');
        const cloneStoreCancelBtn = document.getElementById('clone-store-cancel-btn');
        
        const editHistoryModal = document.getElementById('edit-history-modal');
        const editHistoryForm = document.getElementById('edit-history-form');
        const editHistoryCancelBtn = document.getElementById('edit-history-cancel-btn');
        
        const editMachineModal = document.getElementById('edit-machine-modal');
        const editMachineForm = document.getElementById('edit-machine-form');
        const editMachineCancelBtn = document.getElementById('edit-machine-cancel-btn');

        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
        const pdfLoaderText = document.getElementById('pdf-loader-text-overlay');
        
        const checkoutHistoryBody = document.getElementById('checkout-history-body');
        const performCheckoutBtn = document.getElementById('perform-checkout-btn');
        const downloadCheckoutCsvBtn = document.getElementById('download-checkout-csv-btn');
        const headerDownloadButtons = document.getElementById('header-download-buttons');

        // è‡ªå®šç¾©å ±è¡¨æ¨¡æ…‹è¦–çª—å…ƒç´ 
        const customReportModal = document.getElementById('custom-report-modal');
        const customReportDownloadBtn = document.getElementById('custom-report-download');
        const customReportCancelBtn = document.getElementById('custom-report-cancel');
        const selectAllReportsBtn = document.getElementById('select-all-reports');
        const selectBasicReportsBtn = document.getElementById('select-basic-reports');
        const selectDetailedReportsBtn = document.getElementById('select-detailed-reports');
        const clearAllReportsBtn = document.getElementById('clear-all-reports');

        // è‡ªå®šç¾©é–€å¸‚å ±è¡¨æ¨¡æ…‹è¦–çª—å…ƒç´ 
        const customStoreReportModal = document.getElementById('custom-store-report-modal');
        const customStoreReportDownloadBtn = document.getElementById('custom-store-report-download');
        const customStoreReportCancelBtn = document.getElementById('custom-store-report-cancel');
        const selectAllStoreReportsBtn = document.getElementById('select-all-store-reports');
        const selectBasicStoreReportsBtn = document.getElementById('select-basic-store-reports');
        const selectDetailedStoreReportsBtn = document.getElementById('select-detailed-store-reports');
        const clearAllStoreReportsBtn = document.getElementById('clear-all-store-reports');


        // --- MODAL FUNCTIONS ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- CUSTOM REPORT FUNCTIONS ---
        function showCustomReportModal() {
            customReportModal.classList.remove('hidden');
        }

        function hideCustomReportModal() {
            customReportModal.classList.add('hidden');
        }

        function setReportCheckboxes(summary, details, operationSummary, history, analysis, checkout, profit) {
            document.getElementById('include-summary').checked = summary;
            document.getElementById('include-details').checked = details;
            document.getElementById('include-operation-summary').checked = operationSummary;
            document.getElementById('include-history').checked = history;
            document.getElementById('include-analysis').checked = analysis;
            document.getElementById('include-checkout').checked = checkout;
            document.getElementById('include-profit').checked = profit;
        }

        async function generateCustomReport() {
            const includeSummary = document.getElementById('include-summary').checked;
            const includeDetails = document.getElementById('include-details').checked;
            const includeOperationSummary = document.getElementById('include-operation-summary').checked;
            const includeHistory = document.getElementById('include-history').checked;
            const includeAnalysis = document.getElementById('include-analysis').checked;
            const includeCheckout = document.getElementById('include-checkout').checked;
            const includeProfit = document.getElementById('include-profit').checked;
            const format = document.querySelector('input[name="report-format"]:checked').value;

            if (!includeSummary && !includeDetails && !includeOperationSummary && !includeHistory && !includeAnalysis && !includeCheckout && !includeProfit) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …å ±è¡¨å…§å®¹ï¼');
                return;
            }

            pdfLoaderText.textContent = `æ­£åœ¨ç”Ÿæˆè‡ªå®šç¾©å ±è¡¨ (${format.toUpperCase()})...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const storeName = selectedStoreName || 'æœªçŸ¥é–€å¸‚';

                if (format === 'csv') {
                    // CSV æ ¼å¼å ±è¡¨
                    if (includeSummary) {
                        reportData.push('=== ç‡Ÿæ¥­æ‘˜è¦çµ±è¨ˆ ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                        reportData.push('çµ±è¨ˆé …ç›®,æ•¸å€¼');
                        reportData.push(`é–€å¸‚åç¨±,${storeName}`);
                        reportData.push(`çµ±è¨ˆæœŸé–“,${appData.startDate} ~ ${new Date().toISOString().split('T')[0]}`);
                        reportData.push(`ç¸½æŠ•å¹£æ¬¡æ•¸,${totalPlays}`);
                        reportData.push(`ç¸½ç‡Ÿæ¥­é¡,${totalRevenue}`);
                        reportData.push(`ç¸½å‡ºè²¨æ¬¡æ•¸,${totalPayouts}`);
                        reportData.push(`å¹³å‡å‡ºè²¨æˆæœ¬,${avgCost.toFixed(2)}`);
                        reportData.push('');
                    }

                    if (includeDetails) {
                        reportData.push('=== æ©Ÿå°è©³ç´°è³‡æ–™ ===');
                        reportData.push('æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,æŠ•å¹£æ¬¡æ•¸,ç‡Ÿæ¥­é¡,å‡ºè²¨æ¬¡æ•¸,å¹³å‡æˆæœ¬,åˆå§‹æŠ•å¹£,åˆå§‹å‡ºè²¨');
                        const processedMachines = appData.machines.map(processMachineData);
                        processedMachines.forEach(machine => {
                            reportData.push(`${machine.id},${machine.location},${machine.effectivePlays},${machine.revenue},${machine.effectivePayouts},${machine.cost.toFixed(2)},${machine.initialPlays || 0},${machine.initialPayouts || 0}`);
                        });
                        reportData.push('');
                    }

                    if (includeOperationSummary) {
                        reportData.push('=== ç‡Ÿé‹æ¦‚æ³ç¸½è¡¨ ===');
                        reportData.push('æ©Ÿå°ç·¨è™Ÿ,ç¸½æŠ•å¹£é‡‘é¡,ç¸½å‡ºè²¨æ•¸é‡,å¹³å‡å‡ºè²¨æˆæœ¬');
                        const summaryData = getAggregatedSummaryData('all');
                        summaryData.forEach(item => {
                            reportData.push(`${item.id},${item.revenue},${item.payouts},${item.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeHistory) {
                        reportData.push('=== è¨˜å¸³æ­·å²ç´€éŒ„ ===');
                        reportData.push('æ—¥æœŸ,æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,æŠ•å¹£æ¬¡æ•¸,å‡ºè²¨æ¬¡æ•¸,ç•¶æ—¥ç‡Ÿæ”¶');
                        appData.history.forEach(record => {
                            const dailyRevenue = record.dailyPlays * COIN_VALUE;
                            reportData.push(`${record.date},${record.machineId},${record.location},${record.dailyPlays},${record.dailyPayouts},${dailyRevenue}`);
                        });
                        reportData.push('');
                    }

                    if (includeAnalysis) {
                        reportData.push('=== ç‡Ÿé‹åˆ†ææ•¸æ“š ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
                        const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

                        reportData.push('ç‡Ÿæ”¶æ’è¡Œæ¦œ');
                        reportData.push('æ’å,æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,ç‡Ÿæ”¶');
                        sortedByRevenue.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.revenue}`);
                        });
                        reportData.push('');

                        reportData.push('å‡ºè²¨æˆæœ¬æ’è¡Œæ¦œ');
                        reportData.push('æ’å,æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,å¹³å‡æˆæœ¬');
                        sortedByCost.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeCheckout && selectedGroupId && selectedStoreId) {
                        reportData.push('=== çµå¸³ç´€éŒ„ ===');
                        const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                        const checkoutSnapshot = await checkoutCollection.get();
                        const checkouts = checkoutSnapshot.docs.map(doc => doc.data());

                        reportData.push('çµå¸³æ—¥æœŸ,çµå¸³é‡‘é¡,ç´¯ç©ç‡Ÿæ”¶,å‚™è¨»');
                        checkouts.forEach(checkout => {
                            reportData.push(`${checkout.checkoutDate},${checkout.checkoutAmount},${checkout.cumulativeRevenueAtCheckout || 0},${checkout.notes || ''}`);
                        });
                        reportData.push('');
                    }

                    if (includeProfit) {
                        reportData.push('=== ç›ˆåˆ©è¨ˆç®—åˆ†æ ===');
                        
                        // è¼‰å…¥æˆæœ¬è¨­å®š
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // è¨ˆç®—ç‡Ÿæ¥­æ•¸æ“š
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // è¨ˆç®—å„é …æˆæœ¬
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = totalRevenue * (rentPercentage / 100);
                        const totalTaxCost = totalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        
                        // è¨ˆç®—ç›ˆåˆ©æŒ‡æ¨™
                        const netProfit = totalRevenue - totalCost;
                        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                        const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                        
                        // æˆæœ¬è¨­å®šéƒ¨åˆ†
                        reportData.push('æˆæœ¬è¨­å®š');
                        reportData.push('é …ç›®,æ•¸å€¼');
                        reportData.push(`æ¯æ¬¡å‡ºè²¨ç¦®å“æˆæœ¬,${giftCost} å…ƒ`);
                        reportData.push(`åº—ç§Ÿæ¯”ä¾‹,${rentPercentage}%`);
                        reportData.push(`ç¨…é‡‘æ¯”ä¾‹,${taxPercentage}%`);
                        reportData.push('');
                        
                        // ç‡Ÿæ¥­æ•¸æ“šéƒ¨åˆ†
                        reportData.push('ç‡Ÿæ¥­æ•¸æ“š');
                        reportData.push('é …ç›®,æ•¸å€¼');
                        reportData.push(`ç¸½ç‡Ÿæ¥­é¡,${totalRevenue} å…ƒ`);
                        reportData.push(`ç¸½å‡ºè²¨æ¬¡æ•¸,${totalPayouts} æ¬¡`);
                        reportData.push('');
                        
                        // æˆæœ¬æ˜ç´°éƒ¨åˆ†
                        reportData.push('æˆæœ¬æ˜ç´°');
                        reportData.push('é …ç›®,é‡‘é¡');
                        reportData.push(`ç¦®å“æˆæœ¬,${totalGiftCost} å…ƒ`);
                        reportData.push(`åº—ç§Ÿè²»ç”¨,${totalRentCost} å…ƒ`);
                        reportData.push(`ç¨…é‡‘è²»ç”¨,${totalTaxCost} å…ƒ`);
                        reportData.push(`ç¸½æˆæœ¬,${totalCost} å…ƒ`);
                        reportData.push('');
                        
                        // ç›ˆåˆ©åˆ†æéƒ¨åˆ†
                        reportData.push('ç›ˆåˆ©åˆ†æ');
                        reportData.push('é …ç›®,æ•¸å€¼');
                        reportData.push(`æ·¨åˆ©æ½¤,${netProfit} å…ƒ`);
                        reportData.push(`åˆ©æ½¤ç‡,${profitMargin.toFixed(2)}%`);
                        reportData.push(`æ¯æ¬¡å‡ºè²¨æ·¨åˆ©,${profitPerPayout.toFixed(2)} å…ƒ`);
                        reportData.push('');
                    }

                    // ä¸‹è¼‰ CSV
                    const csvContent = reportData.join('\n');
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${storeName}_è‡ªå®šç¾©å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(link.href);

                } else if (format === 'pdf') {
                    // PDF æ ¼å¼å ±è¡¨ (ç°¡åŒ–ç‰ˆæœ¬)
                    alert('PDF æ ¼å¼å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆä½¿ç”¨ CSV æ ¼å¼ã€‚');
                }

                hideCustomReportModal();
                showFeedback('è‡ªå®šç¾©å ±è¡¨ä¸‹è¼‰æˆåŠŸï¼', false);

            } catch (error) {
                console.error('ç”Ÿæˆè‡ªå®šç¾©å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showFeedback('å ±è¡¨ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

        // --- CUSTOM STORE REPORT FUNCTIONS ---
        function showCustomStoreReportModal() {
            customStoreReportModal.classList.remove('hidden');
        }

        function hideCustomStoreReportModal() {
            customStoreReportModal.classList.add('hidden');
        }

        function setStoreReportCheckboxes(summary, machines, performance, topMachines, periodSummary, profit) {
            document.getElementById('store-include-summary').checked = summary;
            document.getElementById('store-include-machines').checked = machines;
            document.getElementById('store-include-performance').checked = performance;
            document.getElementById('store-include-top-machines').checked = topMachines;
            document.getElementById('store-include-period-summary').checked = periodSummary;
            document.getElementById('store-include-profit').checked = profit;
        }

        async function generateCustomStoreReport() {
            const includeSummary = document.getElementById('store-include-summary').checked;
            const includeMachines = document.getElementById('store-include-machines').checked;
            const includePerformance = document.getElementById('store-include-performance').checked;
            const includeTopMachines = document.getElementById('store-include-top-machines').checked;
            const includePeriodSummary = document.getElementById('store-include-period-summary').checked;
            const includeProfit = document.getElementById('store-include-profit').checked;
            const period = document.querySelector('input[name="store-report-period"]:checked').value;
            const date = document.getElementById('store-report-date').value;
            const sortOrder = document.querySelector('input[name="store-sort-order"]:checked').value;

            // æª¢æŸ¥å¿…è¦çš„å…¨åŸŸè®Šæ•¸
            if (!selectedGroupId) {
                alert('éŒ¯èª¤ï¼šæœªé¸æ“‡ç¾¤çµ„ï¼Œè«‹é‡æ–°é¸æ“‡ç¾¤çµ„ï¼');
                console.error('selectedGroupId æœªè¨­å®š:', selectedGroupId);
                return;
            }

            console.log('è‡ªå®šç¾©é–€å¸‚å ±è¡¨åƒæ•¸:', {
                includeSummary, includeMachines, includePerformance, includeTopMachines, includePeriodSummary,
                period, date, sortOrder, COIN_VALUE, selectedGroupId, selectedGroupName
            });

            if (!includeSummary && !includeMachines && !includePerformance && !includeTopMachines && !includePeriodSummary && !includeProfit) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …å ±è¡¨å…§å®¹ï¼');
                return;
            }

            // æª¢æŸ¥é¸ä¸­çš„é–€å¸‚
            let selectedStoreCheckboxes = Array.from(document.querySelectorAll('.store-checkbox:checked'));
            if (selectedStoreCheckboxes.length === 0) {
                alert('è«‹å…ˆåœ¨é–€å¸‚åˆ—è¡¨ä¸­å‹¾é¸è¦åŒ…å«çš„é–€å¸‚ï¼');
                return;
            }
            
            console.log('é¸ä¸­çš„é–€å¸‚æ•¸é‡:', selectedStoreCheckboxes.length);
            console.log('é¸ä¸­çš„é–€å¸‚è³‡è¨Š:', selectedStoreCheckboxes.map(cb => ({
                value: cb.value,
                storeName: cb.dataset.storeName
            })));

            pdfLoaderText.textContent = 'æ­£åœ¨ç”Ÿæˆè‡ªå®šç¾©é–€å¸‚å ±è¡¨...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const periodText = document.querySelector(`input[name="store-report-period"]:checked`).parentElement.textContent.trim();

                // ç”¨ä¾†æ”¶é›†æ‰€æœ‰é–€å¸‚çš„ç¸½ç‡Ÿæ¥­é¡ã€ç¸½å‡ºè²¨æ¬¡æ•¸
                let allStoresRevenue = 0;
                let allStoresPayouts = 0;
                let storeRevenueData = [];

                reportData.push('=== è‡ªå®šç¾©é–€å¸‚å ±è¡¨ ===');
                reportData.push(`å ±è¡¨ç”¢ç”Ÿæ™‚é–“ï¼š${timestamp}`);
                reportData.push(`å ±è¡¨æœŸé–“ï¼š${periodText}${date ? ` (${date})` : ''}`);
                reportData.push(`åŒ…å«é–€å¸‚æ•¸ï¼š"${selectedStoreCheckboxes.length}"`);
                
                // å…ˆè¨ˆç®—ç¸½ç‡Ÿæ¥­é¡ã€ç¸½å‡ºè²¨æ¬¡æ•¸ã€å¹³å‡å‡ºè²¨æˆæœ¬ (æœƒåœ¨å¾Œé¢è¿´åœˆä¸­å¡«å…¥)
                reportData.push('');

                // ç‚ºæ¯å€‹é¸ä¸­çš„é–€å¸‚ç”Ÿæˆå ±è¡¨
                for (const checkbox of selectedStoreCheckboxes) {
                    const storeId = checkbox.value;
                    const storeName = checkbox.dataset.storeName;
                    
                    console.log(`è™•ç†é–€å¸‚: ID=${storeId}, Name=${storeName}`);

                    reportData.push(`=== ${storeName} ===`);

                    try {
                        // ç²å–é–€å¸‚è³‡æ–™  
                        console.log(`æ­£åœ¨ç²å–é–€å¸‚è³‡æ–™ - GroupId: ${selectedGroupId}, StoreId: ${storeId}, StoreName: ${storeName}, Period: ${period}, Date: ${date}`);
                        
                        // ä½¿ç”¨å®Œæ•´çš„ Firebase è·¯å¾‘å’ŒéŒ¯èª¤è™•ç†
                        const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                        const machinesRef = storeRef.collection('machines');
                        const historyRef = storeRef.collection('history');
                        
                        // å…ˆæª¢æŸ¥é–€å¸‚æ˜¯å¦å­˜åœ¨
                        const storeDoc = await storeRef.get();
                        if (!storeDoc.exists) {
                            console.error(`é–€å¸‚ä¸å­˜åœ¨: ${storeId}`);
                            throw new Error(`é–€å¸‚ ${storeName} ä¸å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­`);
                        }
                        
                        // ç²å–æ©Ÿå°è³‡æ–™
                        const machinesSnapshot = await machinesRef.get();
                        console.log(`æ©Ÿå°è³‡æ–™æŸ¥è©¢çµæœ - æ–‡æª”æ•¸é‡: ${machinesSnapshot.docs.length}, æ˜¯å¦ç‚ºç©º: ${machinesSnapshot.empty}`);
                        
                        if (machinesSnapshot.empty) {
                            console.log(`é–€å¸‚ ${storeName} æ²’æœ‰æ©Ÿå°è³‡æ–™`);
                        }
                        
                        // æ ¹æ“šæœŸé–“é¡å‹æ±ºå®šè³‡æ–™ä¾†æº
                        let machines;
                        
                        if (period === 'all') {
                            // å…¨éƒ¨æœŸé–“ï¼šä½¿ç”¨æ©Ÿå°ç´¯ç©æ•¸æ“š
                            machines = machinesSnapshot.docs.map(doc => {
                                const data = doc.data();
                                console.log(`æ©Ÿå°åŸå§‹è³‡æ–™ (${doc.id}):`, data);
                                
                                // ç¢ºä¿æ‰€æœ‰å¿…è¦å­—æ®µå­˜åœ¨ä¸”ç‚ºæ•¸å­—
                                const machine = {
                                    docId: doc.id,
                                    id: data.id || doc.id,
                                    location: data.location || 'æœªçŸ¥ä½ç½®',
                                    plays: Number(data.plays) || 0,
                                    payouts: Number(data.payouts) || 0,
                                    initialPlays: Number(data.initialPlays) || 0,
                                    initialPayouts: Number(data.initialPayouts) || 0
                                };
                                
                                console.log(`æ©Ÿå°è½‰æ›å¾Œè³‡æ–™ (${doc.id}):`, machine);
                                return machine;
                            });
                        } else {
                            // å–®æ—¥/é€±å ±/æœˆå ±ç­‰ï¼šå¾æ­·å²è¨˜éŒ„è¨ˆç®—
                            const targetDate = date || new Date().toISOString().split('T')[0];
                            let historyQuery = historyRef;
                            
                            if (period === 'daily') {
                                // å–®æ—¥ï¼šç²¾ç¢ºåŒ¹é…æ—¥æœŸ
                                historyQuery = historyQuery.where('date', '==', targetDate);
                            } else if (period === 'weekly') {
                                // é€±å ±ï¼šè¨ˆç®—æœ¬é€±ç¯„åœ
                                const dateObj = new Date(targetDate);
                                const dayOfWeek = dateObj.getDay();
                                const startDate = new Date(dateObj);
                                startDate.setDate(dateObj.getDate() - dayOfWeek);
                                const endDate = new Date(startDate);
                                endDate.setDate(startDate.getDate() + 6);
                                
                                historyQuery = historyQuery
                                    .where('date', '>=', startDate.toISOString().split('T')[0])
                                    .where('date', '<=', endDate.toISOString().split('T')[0]);
                            } else if (period === 'monthly') {
                                // æœˆå ±ï¼šè¨ˆç®—æœ¬æœˆç¯„åœ
                                const dateObj = new Date(targetDate);
                                const startDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
                                const endDate = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0);
                                
                                historyQuery = historyQuery
                                    .where('date', '>=', startDate.toISOString().split('T')[0])
                                    .where('date', '<=', endDate.toISOString().split('T')[0]);
                            }
                            
                            const historySnapshot = await historyQuery.get();
                            console.log(`æ­·å²è¨˜éŒ„æŸ¥è©¢çµæœ - æ–‡æª”æ•¸é‡: ${historySnapshot.docs.length}, Period: ${period}, Date: ${targetDate}`);
                            
                            // æŒ‰æ©Ÿå°å½™ç¸½æ­·å²è¨˜éŒ„
                            const machineMap = new Map();
                            
                            historySnapshot.docs.forEach(doc => {
                                const data = doc.data();
                                const key = `${data.machineId}_${data.location}`;
                                
                                if (!machineMap.has(key)) {
                                    machineMap.set(key, {
                                        id: data.machineId,
                                        location: data.location,
                                        newPlays: 0,
                                        newPayouts: 0
                                    });
                                }
                                
                                const machine = machineMap.get(key);
                                machine.newPlays += Number(data.newPlays) || 0;
                                machine.newPayouts += Number(data.newPayouts) || 0;
                            });
                            
                            // è½‰æ›ç‚ºæ©Ÿå°é™£åˆ—æ ¼å¼
                            machines = Array.from(machineMap.values()).map(m => ({
                                docId: `${m.id}_${m.location}`,
                                id: m.id,
                                location: m.location,
                                plays: m.newPlays,
                                payouts: m.newPayouts,
                                initialPlays: 0,  // æœŸé–“çµ±è¨ˆä¸éœ€è¦æ‰£é™¤èµ·å§‹å€¼
                                initialPayouts: 0
                            }));
                        }
                        
                        console.log(`é–€å¸‚ ${storeName} æœ€çµ‚æ©Ÿå°è³‡æ–™:`, machines);
                        console.log(`æ©Ÿå°æ•¸é‡: ${machines.length}`);
                        
                        if (includeSummary) {
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                return { ...m, effectivePlays, effectivePayouts, revenue, cost };
                            });

                            console.log(`é–€å¸‚ ${storeName} è™•ç†å¾Œæ©Ÿå°è³‡æ–™:`, processedMachines);

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                            // ç´¯åŠ åˆ°ç¸½ç‡Ÿæ¥­é¡å’Œç¸½å‡ºè²¨æ¬¡æ•¸
                            allStoresRevenue += totalRevenue;
                            allStoresPayouts += totalPayouts;
                            storeRevenueData.push({name: storeName, revenue: totalRevenue});

                            reportData.push('ç‡Ÿæ¥­æ‘˜è¦');
                            reportData.push('é …ç›®,æ•¸å€¼');
                            reportData.push(`æ©Ÿå°æ•¸é‡,"${machines.length}"`);
                            reportData.push(`ç¸½æŠ•å¹£æ¬¡æ•¸,"${totalPlays}"`);
                            reportData.push(`ç¸½ç‡Ÿæ¥­é¡,"${totalRevenue}"`);
                            reportData.push(`ç¸½å‡ºè²¨æ¬¡æ•¸,"${totalPayouts}"`);
                            reportData.push(`å¹³å‡å‡ºè²¨æˆæœ¬,"${avgCost.toFixed(2)}"`);
                            reportData.push('');
                        }

                        if (includeMachines && machines.length > 0) {
                            reportData.push('æ©Ÿå°æ˜ç´°');
                            reportData.push('æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,æŠ•å¹£æ¬¡æ•¸,ç‡Ÿæ¥­é¡,å‡ºè²¨æ¬¡æ•¸,å¹³å‡æˆæœ¬');
                            machines.forEach(machine => {
                                const effectivePlays = Math.max(0, (machine.plays || 0) - (machine.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (machine.payouts || 0) - (machine.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                reportData.push(`"${machine.id || 'æœªçŸ¥'}","${machine.location || 'æœªçŸ¥'}","${effectivePlays}","${revenue}","${effectivePayouts}","${cost.toFixed(2)}"`);
                            });
                            reportData.push('');
                        }

                        if (includeTopMachines && machines.length > 0) {
                            reportData.push('å„ªç¸¾æ©Ÿå° TOP 3');
                            reportData.push('æ’å,æ©Ÿå°ç·¨è™Ÿ,ä½ç½®,ç‡Ÿæ¥­é¡');
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, revenue };
                            }).filter(m => m.revenue > 0); // éæ¿¾æ‰ç‡Ÿæ”¶ç‚º0çš„æ©Ÿå°
                            
                            if (processedMachines.length > 0) {
                                processedMachines.sort((a, b) => b.revenue - a.revenue).slice(0, 3).forEach((machine, index) => {
                                    reportData.push(`"${index + 1}","${machine.id || 'æœªçŸ¥'}","${machine.location || 'æœªçŸ¥'}","${machine.revenue}"`);
                                });
                            } else {
                                reportData.push('"1","ç„¡","ç„¡","0"');
                            }
                            reportData.push('');
                        }

                        if (includeProfit && machines.length > 0) {
                            // è¼‰å…¥è©²é–€å¸‚çš„æˆæœ¬è¨­å®š
                            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${storeId}`) || '{}');
                            const giftCost = settings.giftCost || 50;
                            const rentPercentage = settings.rentPercentage || 30;
                            const taxPercentage = settings.taxPercentage || 5;
                            
                            // è¨ˆç®—ç‡Ÿæ¥­æ•¸æ“š
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, effectivePlays, effectivePayouts, revenue };
                            });

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            
                            // è¨ˆç®—å„é …æˆæœ¬
                            const totalGiftCost = totalPayouts * giftCost;
                            const totalRentCost = totalRevenue * (rentPercentage / 100);
                            const totalTaxCost = totalRevenue * (taxPercentage / 100);
                            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                            
                            // è¨ˆç®—ç›ˆåˆ©æŒ‡æ¨™
                            const netProfit = totalRevenue - totalCost;
                            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                            const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                            
                            reportData.push('ç›ˆåˆ©è¨ˆç®—åˆ†æ');
                            reportData.push('é …ç›®,æ•¸å€¼');
                            reportData.push(`"æˆæœ¬è¨­å®š - ç¦®å“æˆæœ¬","${giftCost} å…ƒ/æ¬¡"`);
                            reportData.push(`"æˆæœ¬è¨­å®š - åº—ç§Ÿæ¯”ä¾‹","${rentPercentage}%"`);
                            reportData.push(`"æˆæœ¬è¨­å®š - ç¨…é‡‘æ¯”ä¾‹","${taxPercentage}%"`);
                            reportData.push(`"ç‡Ÿæ¥­æ•¸æ“š - ç¸½ç‡Ÿæ¥­é¡","${totalRevenue} å…ƒ"`);
                            reportData.push(`"ç‡Ÿæ¥­æ•¸æ“š - ç¸½å‡ºè²¨æ¬¡æ•¸","${totalPayouts} æ¬¡"`);
                            reportData.push(`"æˆæœ¬æ˜ç´° - ç¦®å“æˆæœ¬","${totalGiftCost} å…ƒ"`);
                            reportData.push(`"æˆæœ¬æ˜ç´° - åº—ç§Ÿè²»ç”¨","${totalRentCost} å…ƒ"`);
                            reportData.push(`"æˆæœ¬æ˜ç´° - ç¨…é‡‘è²»ç”¨","${totalTaxCost} å…ƒ"`);
                            reportData.push(`"æˆæœ¬æ˜ç´° - ç¸½æˆæœ¬","${totalCost} å…ƒ"`);
                            reportData.push(`"ç›ˆåˆ©åˆ†æ - æ·¨åˆ©æ½¤","${netProfit} å…ƒ"`);
                            reportData.push(`"ç›ˆåˆ©åˆ†æ - åˆ©æ½¤ç‡","${profitMargin.toFixed(2)}%"`);
                            reportData.push(`"ç›ˆåˆ©åˆ†æ - æ¯æ¬¡å‡ºè²¨æ·¨åˆ©","${profitPerPayout.toFixed(2)} å…ƒ"`);
                            reportData.push('');
                        }

                    } catch (error) {
                        console.error(`ç²å–é–€å¸‚ ${storeName} è³‡æ–™å¤±æ•—:`, error);
                        console.error('è©³ç´°éŒ¯èª¤è³‡è¨Š:', {
                            selectedGroupId,
                            storeId,
                            storeName,
                            error: error.message,
                            stack: error.stack
                        });
                        reportData.push(`è³‡æ–™ç²å–å¤±æ•—: ${error.message}`);
                        reportData.push('');
                    }
                }

                // æ ¹æ“šæ’åºæ–¹å¼é‡æ–°æ’åº storeRevenueData
                if (sortOrder === 'revenue-desc') {
                    // ç‡Ÿæ¥­é¡é«˜åˆ°ä½
                    storeRevenueData.sort((a, b) => b.revenue - a.revenue);
                } else if (sortOrder === 'revenue-asc') {
                    // ç‡Ÿæ¥­é¡ä½åˆ°é«˜
                    storeRevenueData.sort((a, b) => a.revenue - b.revenue);
                } else if (sortOrder === 'name') {
                    // ä¾é–€å¸‚åç¨±æ’åº
                    storeRevenueData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                } else if (sortOrder === 'custom') {
                    // è‡ªè¨‚é †åº - æŒ‰ç…§å‹¾é¸æ¡†åœ¨é é¢ä¸Šçš„é †åº
                    const checkboxOrder = Array.from(selectedStoreCheckboxes).map(cb => cb.dataset.storeName);
                    storeRevenueData.sort((a, b) => {
                        const indexA = checkboxOrder.indexOf(a.name);
                        const indexB = checkboxOrder.indexOf(b.name);
                        return indexA - indexB;
                    });
                }

                // è¨ˆç®—æ‰€æœ‰é–€å¸‚å¹³å‡å‡ºè²¨æˆæœ¬
                const allStoresAvgCost = allStoresPayouts > 0 ? allStoresRevenue / allStoresPayouts : 0;

                // åœ¨ç¬¬5è¡Œæ’å…¥ç¸½ç‡Ÿæ¥­é¡ã€ç¸½å‡ºè²¨æ¬¡æ•¸ã€å¹³å‡å‡ºè²¨æˆæœ¬è³‡è¨Š
                reportData.splice(4, 0, `æ‰€æœ‰é–€å¸‚ç¸½ç‡Ÿæ¥­é¡ï¼š"${allStoresRevenue}"`);
                reportData.splice(5, 0, `æ‰€æœ‰é–€å¸‚ç¸½å‡ºè²¨æ¬¡æ•¸ï¼š"${allStoresPayouts}"`);
                reportData.splice(6, 0, `æ‰€æœ‰é–€å¸‚å¹³å‡å‡ºè²¨æˆæœ¬ï¼š"${allStoresAvgCost.toFixed(2)}"`);

                // ç¸½ç‡Ÿæ¥­é¡çµ±è¨ˆ
                reportData.push('=== ç¸½ç‡Ÿæ¥­é¡çµ±è¨ˆ ===');
                reportData.push('é …ç›®,é‡‘é¡');
                storeRevenueData.forEach(store => {
                    reportData.push(`"${store.name}","${store.revenue}"`);
                });
                reportData.push(`"æ‰€æœ‰é–€å¸‚ç¸½ç‡Ÿæ¥­é¡","${allStoresRevenue}"`);
                reportData.push(`"æ‰€æœ‰é–€å¸‚ç¸½å‡ºè²¨æ¬¡æ•¸","${allStoresPayouts}"`);
                reportData.push(`"æ‰€æœ‰é–€å¸‚å¹³å‡å‡ºè²¨æˆæœ¬","${allStoresAvgCost.toFixed(2)}"`);
                reportData.push('');

                // é–€å¸‚ç¸¾æ•ˆæ¯”è¼ƒ
                if (includePerformance && selectedStoreCheckboxes.length > 1) {
                    reportData.push('=== é–€å¸‚ç¸¾æ•ˆæ¯”è¼ƒ ===');
                    reportData.push('é–€å¸‚åç¨±,æ©Ÿå°æ•¸é‡,ç¸½ç‡Ÿæ¥­é¡,å¹³å‡æ¯å°ç‡Ÿæ”¶');
                    storeRevenueData.forEach(store => {
                        reportData.push(`"${store.name}","--","${store.revenue}","--"`);
                    });
                    reportData.push('');
                }

                // ä¸‹è¼‰ CSV
                const csvContent = reportData.join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `è‡ªå®šç¾©é–€å¸‚å ±è¡¨_${selectedGroupName}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);

                hideCustomStoreReportModal();
                showFeedback('è‡ªå®šç¾©é–€å¸‚å ±è¡¨ä¸‹è¼‰æˆåŠŸï¼', false);

            } catch (error) {
                console.error('ç”Ÿæˆé–€å¸‚å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showFeedback('å ±è¡¨ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

                // --- é–€å¸‚å ±è¡¨ã€Œç¶²é é è¦½ã€åŠŸèƒ½ ---

                // å–å¾—æŒ‡å®šé–€å¸‚æ–¼ç‰¹å®šæœŸé–“çš„å½™æ•´æ•¸æ“š
                async function getStorePeriodStats(storeId, period, date) {
                        const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                        const machinesRef = storeRef.collection('machines');
                        const historyRef = storeRef.collection('history');

                        // æ©Ÿå°æ•¸ä»¥å¯¦éš›æ©Ÿå°æ•¸ç‚ºæº–
                        const machinesSnapshot = await machinesRef.get();
                        const machinesCount = machinesSnapshot.size;

                        let totalPlays = 0;     // æŠ•å¹£æ¬¡æ•¸
                        let totalPayouts = 0;   // å‡ºè²¨æ¬¡æ•¸

                        if (period === 'all') {
                                // ç´¯ç©è³‡æ–™ï¼šæ‰£é™¤åˆå§‹å€¼
                                machinesSnapshot.forEach(doc => {
                                        const data = doc.data();
                                        const plays = Math.max(0, (Number(data.plays) || 0) - (Number(data.initialPlays) || 0));
                                        const payouts = Math.max(0, (Number(data.payouts) || 0) - (Number(data.initialPayouts) || 0));
                                        totalPlays += plays;
                                        totalPayouts += payouts;
                                });
                        } else {
                                // æœŸé–“æŸ¥è©¢ï¼šå¾ history åŒ¯ç¸½ newPlays/newPayouts
                                const targetDate = date || new Date().toISOString().split('T')[0];
                                let q = historyRef;

                                if (period === 'daily') {
                                        q = q.where('date', '==', targetDate);
                                } else if (period === 'weekly') {
                                        const d = new Date(targetDate);
                                        const start = new Date(d); start.setDate(d.getDate() - d.getDay());
                                        const end = new Date(start); end.setDate(start.getDate() + 6);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'monthly') {
                                        const d = new Date(targetDate);
                                        const start = new Date(d.getFullYear(), d.getMonth(), 1);
                                        const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'quarterly') {
                                        // å­£å ±ï¼šè¨ˆç®—æœ¬å­£ç¯„åœ
                                        const d = new Date(targetDate);
                                        const quarter = Math.floor(d.getMonth() / 3);
                                        const start = new Date(d.getFullYear(), quarter * 3, 1);
                                        const end = new Date(d.getFullYear(), quarter * 3 + 3, 0);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'yearly') {
                                        // å¹´å ±ï¼šè¨ˆç®—æœ¬å¹´ç¯„åœ
                                        const d = new Date(targetDate);
                                        const start = new Date(d.getFullYear(), 0, 1);
                                        const end = new Date(d.getFullYear(), 11, 31);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                }

                                const historySnapshot = await q.get();
                                historySnapshot.forEach(doc => {
                                        const h = doc.data();
                                        totalPlays += Number(h.newPlays) || 0;
                                        totalPayouts += Number(h.newPayouts) || 0;
                                });
                        }

                        const totalRevenue = totalPlays * COIN_VALUE;
                        return { machinesCount, totalPlays, totalPayouts, totalRevenue };
                }

                // ç”¢ç”Ÿæ–°åˆ†é çš„å ±è¡¨ HTML
                function generateStoresLiveReportHTML({ summary, rows, meta }) {
                        const buildTime = new Date().toLocaleString('zh-TW');
                        const dateText = new Date().toLocaleDateString('zh-TW');
                        const periodMap = { all:'å…¨éƒ¨æœŸé–“', daily:'å–®æ—¥', weekly:'é€±å ±', monthly:'æœˆå ±', quarterly:'å­£å ±', yearly:'å¹´å ±' };
                        const periodText = periodMap[meta.period] + (meta.date ? 'ï¼ˆ' + meta.date + 'ï¼‰' : '');

                        const rowsJSON = JSON.stringify(rows);
                        const summaryJSON = JSON.stringify({
                                storesCount: summary.storesCount,
                                totalRevenue: Math.round(summary.totalRevenue),
                                totalPayouts: Math.round(summary.totalPayouts),
                                avgPayoutCost: summary.totalPayouts > 0 ? summary.totalRevenue / summary.totalPayouts : 0
                        });

                        // ä½¿ç”¨å­—ä¸²æ‹¼æ¥è€Œéæ¨¡æ¿å­—ä¸²ï¼Œé¿å…å…§éƒ¨è®Šæ•¸è¡çª
                        let html = '<!DOCTYPE html>\n';
                        html += '<html lang="zh-Hant">\n';
                        html += '<head>\n';
                        html += '  <meta charset="utf-8" />\n';
                        html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                        html += '  <title>' + (meta.groupName || '') + 'ï½œè‡ªå®šç¾©é–€å¸‚å ±è¡¨ï½œ' + dateText + '</title>\n';
                        html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                        html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                        html += '  <style>\n';
                        html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; }\n';
                        html += '    *{box-sizing:border-box}\n';
                        html += '    body{margin:0; font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text)}\n';
                        html += '    .container{max-width:1100px; margin:24px auto; padding:0 16px}\n';
                        html += '    header{display:flex; flex-wrap:wrap; align-items:flex-end; gap:8px; margin-bottom:16px}\n';
                        html += '    header h1{font-size:1.6rem; margin:0; letter-spacing:.02em}\n';
                        html += '    header .sub{color:var(--muted); font-size:.95rem}\n';
                        html += '    .cards{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:16px 0 20px}\n';
                        html += '    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}\n';
                        html += '    @media (max-width:560px){.cards{grid-template-columns:1fr}}\n';
                        html += '    .card{background:var(--card); padding:14px 16px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                        html += '    .card .label{color:var(--muted); font-size:.85rem}\n';
                        html += '    .card .value{font-size:1.4rem; font-weight:700; margin-top:4px}\n';
                        html += '    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 14px}\n';
                        html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}\n';
                        html += '    .btn:hover{background:#233042}\n';
                        html += '    .grid{display:grid; grid-template-columns:2fr 1fr; gap:16px}\n';
                        html += '    @media (max-width:1000px){.grid{grid-template-columns:1fr}}\n';
                        html += '    .panel{background:var(--card); padding:16px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                        html += '    .panel h3{margin:0 0 12px; font-size:1.05rem}\n';
                        html += '    table{width:100%; border-collapse:separate; border-spacing:0 8px}\n';
                        html += '    thead th{font-size:.85rem; color:var(--muted); text-align:left; padding:6px 10px}\n';
                        html += '    tbody td{background:#0f1520; padding:10px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                        html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                        html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                        html += '    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.78rem; color:#07121f; background:var(--accent)}\n';
                        html += '    .muted{color:var(--muted)}\n';
                        html += '    footer{color:var(--muted); font-size:.85rem; margin:24px 0 40px}\n';
                        html += '  </style>\n';
                        html += '</head>\n';
                        html += '<body>\n';
                        html += '  <div class="container">\n';
                        html += '    <header>\n';
                        html += '      <h1>' + (meta.groupName || '') + ' è‡ªå®šç¾©é–€å¸‚å ±è¡¨</h1>\n';
                        html += '      <div class="sub">æ—¥æœŸï¼š' + dateText + 'ã€€/ã€€æœŸé–“ï¼š' + periodText + '</div>\n';
                        html += '    </header>\n';
                        html += '    <section class="cards" id="kpis"></section>\n';
                        html += '    <div class="toolbar">\n';
                        html += '      <button class="btn" id="exportBtn">åŒ¯å‡º CSV</button>\n';
                        html += '      <button class="btn" id="printBtn">åˆ—å° / å­˜æˆ PDF</button>\n';
                        html += '    </div>\n';
                        html += '    <div class="grid">\n';
                        html += '      <div class="panel">\n';
                        html += '        <h3>å„é–€å¸‚ç‡Ÿé‹æ˜ç´°</h3>\n';
                        html += '        <table id="storeTable">\n';
                        html += '          <thead><tr><th>é–€å¸‚</th><th>æ©Ÿå°æ•¸</th><th>ç¸½æŠ•å¹£æ¬¡æ•¸</th><th>ç‡Ÿæ¥­é¡</th><th>å‡ºè²¨æ¬¡æ•¸</th><th>å¹³å‡å‡ºè²¨æˆæœ¬</th></tr></thead>\n';
                        html += '          <tbody></tbody>\n';
                        html += '        </table>\n';
                        html += '      </div>\n';
                        html += '      <div class="panel">\n';
                        html += '        <h3>åœ–è¡¨</h3>\n';
                        html += '        <canvas id="revChart" height="180"></canvas>\n';
                        html += '        <div class="muted" style="margin:10px 0 6px">ç‡Ÿæ¥­é¡å æ¯”</div>\n';
                        html += '        <canvas id="pieChart" height="180"></canvas>\n';
                        html += '      </div>\n';
                        html += '    </div>\n';
                        html += '    <footer>ç”Ÿæˆæ™‚é–“ï¼š' + buildTime + 'ã€€ï½œã€€åŒ…å«é–€å¸‚æ•¸ï¼š' + summary.storesCount + '</footer>\n';
                        html += '  </div>\n';
                        html += '  <script>\n';
                        html += '    const summary = ' + summaryJSON + ';\n';
                        html += '    const rows = ' + rowsJSON + ';\n';
                        html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                        html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                        html += '    function buildCSV(rows){\n';
                        html += '      const header = ["é–€å¸‚","æ©Ÿå°æ•¸","ç¸½æŠ•å¹£æ¬¡æ•¸","ç‡Ÿæ¥­é¡","å‡ºè²¨æ¬¡æ•¸","å¹³å‡å‡ºè²¨æˆæœ¬"];\n';
                        html += '      const lines = [header.join(",")].concat(rows.map(r => [r.name, r.machines, r.coins, r.revenue, r.shipments, r.avgCost].join(",")));\n';
                        html += '      return "\\uFEFF" + lines.join("\\n");\n';
                        html += '    }\n';
                        html += '    function exportCSV(){\n';
                        html += '      try{\n';
                        html += '        const csv = buildCSV(rows);\n';
                        html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                        html += '        const url = URL.createObjectURL(blob);\n';
                        html += '        const a = document.createElement("a");\n';
                        html += '        a.href = url; a.download = "stores_report.csv";\n';
                        html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                        html += '      }catch(err){ console.error("CSV åŒ¯å‡ºå¤±æ•—ï¼š", err); alert("CSV åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Consoleã€‚"); }\n';
                        html += '    }\n';
                        html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                        html += '      const kpiRoot = document.getElementById("kpis");\n';
                        html += '      [\n';
                        html += '        { label:"åŒ…å«é–€å¸‚æ•¸", value: nt(summary.storesCount) },\n';
                        html += '        { label:"æ‰€æœ‰é–€å¸‚ç¸½ç‡Ÿæ¥­é¡", value: money(summary.totalRevenue) },\n';
                        html += '        { label:"æ‰€æœ‰é–€å¸‚ç¸½å‡ºè²¨æ¬¡æ•¸", value: nt(summary.totalPayouts) },\n';
                        html += '        { label:"æ‰€æœ‰é–€å¸‚å¹³å‡å‡ºè²¨æˆæœ¬", value: money(summary.totalPayouts>0? summary.totalRevenue/summary.totalPayouts : 0) }\n';
                        html += '      ].forEach(k=>{\n';
                        html += '        const el = document.createElement("div");\n';
                        html += '        el.className="card";\n';
                        html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                        html += '        kpiRoot.appendChild(el);\n';
                        html += '      });\n';
                        html += '      const tbody = document.querySelector("#storeTable tbody");\n';
                        html += '      rows.forEach(r=>{\n';
                        html += '        const tr = document.createElement("tr");\n';
                        html += '        tr.innerHTML = "<td><span class=\\"chip\\">" + r.name + "</span></td>"+\n';
                        html += '          "<td>" + nt(r.machines) + "</td>"+\n';
                        html += '          "<td>" + nt(r.coins) + "</td>"+\n';
                        html += '          "<td>" + money(r.revenue) + "</td>"+\n';
                        html += '          "<td>" + nt(r.shipments) + "</td>"+\n';
                        html += '          "<td>" + money(r.avgCost) + "</td>";\n';
                        html += '        tbody.appendChild(tr);\n';
                        html += '      });\n';
                        html += '      const labels = rows.map(r=>r.name);\n';
                        html += '      const dataRev = rows.map(r=>r.revenue);\n';
                        html += '      new Chart(document.getElementById("revChart"), {\n';
                        html += '        type:"bar",\n';
                        html += '        data:{ labels, datasets:[{ label:"ç‡Ÿæ¥­é¡", data:dataRev, backgroundColor:"#5aa9ff" }] },\n';
                        html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                        html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ display:false }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.06)" }}}\n';
                        html += '        }\n';
                        html += '      });\n';
                        html += '      new Chart(document.getElementById("pieChart"), {\n';
                        html += '        type:"pie",\n';
                        html += '        data:{ labels, datasets:[{ data:dataRev }] },\n';
                        html += '        options:{ plugins:{ legend:{ position:"bottom", labels:{ color:"#c9d7e3" }}} }\n';
                        html += '      });\n';
                        html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                        html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                        html += '    });\n';
                        html += '  <\/script>\n';
                        html += '</body>\n';
                        html += '</html>';
                        return html;
                }

                // æ‰“é–‹æ–°åˆ†é å‘ˆç¾å½™æ•´å ±è¡¨
                async function openStoresLiveReportView() {
                        if (!selectedGroupId) { alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„'); return; }
                        const selected = document.querySelectorAll('.store-checkbox:checked');
                        if (selected.length === 0) { alert('è«‹å…ˆå‹¾é¸è¦åŒ…å«åœ¨å ±è¡¨ä¸­çš„é–€å¸‚'); return; }

                        // ä½¿ç”¨ç¶²é é è¦½å°ˆç”¨çš„é¸æ“‡å™¨
                        const periodSelector = document.getElementById('preview-period-selector');
                        const datePicker = document.getElementById('preview-date-picker');
                        const period = periodSelector ? periodSelector.value : 'all';
                        const date = datePicker ? datePicker.value : '';
                        
                        // å–å¾—æ’åºæ–¹å¼
                        const sortOrderElement = document.querySelector('input[name="store-sort-order"]:checked');
                        const sortOrder = sortOrderElement ? sortOrderElement.value : 'revenue-desc';

                        const rows = [];
                        let totalRevenue = 0;
                        let totalPayouts = 0;

                        for (const cb of selected) {
                                const storeId = cb.value;
                                const storeName = cb.dataset.storeName;
                                const s = await getStorePeriodStats(storeId, period, date);
                                const avgCost = s.totalPayouts > 0 ? s.totalRevenue / s.totalPayouts : 0;
                                rows.push({
                                        name: storeName,
                                        machines: s.machinesCount,
                                        coins: s.totalPlays,
                                        revenue: Math.round(s.totalRevenue),
                                        shipments: s.totalPayouts,
                                        avgCost: Math.round(avgCost * 100) / 100
                                });
                                totalRevenue += s.totalRevenue;
                                totalPayouts += s.totalPayouts;
                        }

                        // æ ¹æ“šæ’åºæ–¹å¼é‡æ–°æ’åº rows
                        if (sortOrder === 'revenue-desc') {
                            // ç‡Ÿæ¥­é¡é«˜åˆ°ä½
                            rows.sort((a, b) => b.revenue - a.revenue);
                        } else if (sortOrder === 'revenue-asc') {
                            // ç‡Ÿæ¥­é¡ä½åˆ°é«˜
                            rows.sort((a, b) => a.revenue - b.revenue);
                        } else if (sortOrder === 'name') {
                            // ä¾é–€å¸‚åç¨±æ’åº
                            rows.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                        } else if (sortOrder === 'custom') {
                            // è‡ªè¨‚é †åº - æŒ‰ç…§å‹¾é¸æ¡†åœ¨é é¢ä¸Šçš„é †åº
                            const checkboxOrder = Array.from(selected).map(cb => cb.dataset.storeName);
                            rows.sort((a, b) => {
                                const indexA = checkboxOrder.indexOf(a.name);
                                const indexB = checkboxOrder.indexOf(b.name);
                                return indexA - indexB;
                            });
                        }

                        const summary = {
                                storesCount: selected.length,
                                totalRevenue: Math.round(totalRevenue),
                                totalPayouts: Math.round(totalPayouts)
                        };

                        const html = generateStoresLiveReportHTML({
                                summary,
                                rows,
                                meta: { now: new Date(), groupName: selectedGroupName || '', period, date }
                        });

                        const w = window.open('', '_blank');
                        if (!w) { alert('ç€è¦½å™¨å°é–äº†å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°åˆ†é '); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                }

                // --- WEEKLY TREND ANALYSIS FUNCTIONS ---
                
                // è¨ˆç®—æŒ‡å®šæ—¥æœŸç¯„åœå…§æ¯å‘¨çš„ç‡Ÿæ¥­æ•¸æ“š
                async function calculateWeeklyTrends(storeId, startDate, endDate) {
                    const weeks = [];
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    // èª¿æ•´èµ·å§‹æ—¥ç‚ºè©²é€±çš„é€±æ—¥
                    const startDay = start.getDay();
                    start.setDate(start.getDate() - startDay);
                    
                    let currentWeekStart = new Date(start);
                    
                    while (currentWeekStart <= end) {
                        const weekEnd = new Date(currentWeekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        
                        // å¦‚æœé€±çµæŸæ—¥è¶…éçµæŸæ—¥æœŸï¼Œä½¿ç”¨çµæŸæ—¥æœŸ
                        const actualWeekEnd = weekEnd > end ? end : weekEnd;
                        
                        const weekData = await getWeekRangeStats(storeId, currentWeekStart, actualWeekEnd);
                        
                        // è¨ˆç®—è©²é€±çš„å¤©æ•¸
                        const daysInWeek = Math.ceil((actualWeekEnd - currentWeekStart) / (1000 * 60 * 60 * 24)) + 1;
                        
                        weeks.push({
                            weekStart: new Date(currentWeekStart),
                            weekEnd: new Date(actualWeekEnd),
                            weekLabel: `${currentWeekStart.getMonth() + 1}/${currentWeekStart.getDate()}-${actualWeekEnd.getMonth() + 1}/${actualWeekEnd.getDate()}`,
                            revenue: weekData.totalRevenue,
                            payouts: weekData.totalPayouts,
                            plays: weekData.totalPlays,
                            avgCost: weekData.totalPayouts > 0 ? weekData.totalRevenue / weekData.totalPayouts : 0,
                            days: daysInWeek,
                            psd: weekData.totalRevenue / daysInWeek  // å¹³å‡æ¯æ—¥éŠ·å”®
                        });
                        
                        // ç§»åˆ°ä¸‹ä¸€é€±
                        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                    }
                    
                    // è¨ˆç®—å‘¨æ¯”è®ŠåŒ–
                    for (let i = 1; i < weeks.length; i++) {
                        const current = weeks[i];
                        const previous = weeks[i - 1];
                        
                        current.revenueChange = previous.revenue > 0 ? 
                            ((current.revenue - previous.revenue) / previous.revenue * 100) : 0;
                        current.payoutsChange = previous.payouts > 0 ? 
                            ((current.payouts - previous.payouts) / previous.payouts * 100) : 0;
                        current.psdChange = previous.psd > 0 ? 
                            ((current.psd - previous.psd) / previous.psd * 100) : 0;
                    }
                    
                    return weeks;
                }
                
                // å–å¾—æŒ‡å®šæ—¥æœŸç¯„åœçš„çµ±è¨ˆè³‡æ–™
                async function getWeekRangeStats(storeId, startDate, endDate) {
                    const storeRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId);
                    const historyRef = storeRef.collection('history');
                    
                    const startDateStr = startDate.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];
                    
                    const historySnapshot = await historyRef
                        .where('date', '>=', startDateStr)
                        .where('date', '<=', endDateStr)
                        .get();
                    
                    let totalPlays = 0;
                    let totalPayouts = 0;
                    
                    historySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        totalPlays += Number(data.newPlays) || 0;
                        totalPayouts += Number(data.newPayouts) || 0;
                    });
                    
                    return {
                        totalPlays,
                        totalPayouts,
                        totalRevenue: totalPlays * COIN_VALUE
                    };
                }
                
                // ç”Ÿæˆæ¯å‘¨è¶¨å‹¢åˆ†æå ±è¡¨ HTML
                function generateWeeklyTrendHTML({ storeName, weeks, dateRange, groupName }) {
                    const buildTime = new Date().toLocaleString('zh-TW');
                    const totalRevenue = weeks.reduce((sum, w) => sum + w.revenue, 0);
                    const totalPayouts = weeks.reduce((sum, w) => sum + w.payouts, 0);
                    const avgWeeklyRevenue = weeks.length > 0 ? totalRevenue / weeks.length : 0;
                    
                    const weeksJSON = JSON.stringify(weeks);
                    const summaryJSON = JSON.stringify({
                        totalRevenue,
                        totalPayouts,
                        avgWeeklyRevenue,
                        weeksCount: weeks.length
                    });
                    
                    let html = '<!DOCTYPE html>\n';
                    html += '<html lang="zh-Hant">\n';
                    html += '<head>\n';
                    html += '  <meta charset="utf-8" />\n';
                    html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                    html += '  <title>' + groupName + ' - ' + storeName + ' æ¯å‘¨ç‡Ÿæ¥­é¡è¶¨å‹¢åˆ†æ</title>\n';
                    html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                    html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                    html += '  <style>\n';
                    html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; --danger:#ff6b6b; --success:#51cf66; }\n';
                    html += '    *{box-sizing:border-box; margin:0; padding:0}\n';
                    html += '    body{font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text); padding:20px}\n';
                    html += '    .container{max-width:1200px; margin:0 auto}\n';
                    html += '    header{margin-bottom:24px}\n';
                    html += '    header h1{font-size:1.8rem; margin-bottom:8px; letter-spacing:.02em}\n';
                    html += '    header .subtitle{color:var(--muted); font-size:1rem}\n';
                    html += '    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:24px 0}\n';
                    html += '    .card{background:var(--card); padding:16px 20px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .card .label{color:var(--muted); font-size:.85rem; margin-bottom:8px}\n';
                    html += '    .card .value{font-size:1.6rem; font-weight:700}\n';
                    html += '    .toolbar{display:flex; gap:12px; margin:20px 0}\n';
                    html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:.95rem}\n';
                    html += '    .btn:hover{background:#233042}\n';
                    html += '    .chart-section{background:var(--card); padding:24px; border-radius:14px; margin:20px 0; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .chart-section h3{margin-bottom:16px; font-size:1.2rem}\n';
                    html += '    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:20px}\n';
                    html += '    thead th{font-size:.9rem; color:var(--muted); text-align:left; padding:8px 12px; font-weight:600}\n';
                    html += '    tbody td{background:#0f1520; padding:14px 12px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                    html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                    html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                    html += '    .trend-up{color:var(--success); font-weight:600}\n';
                    html += '    .trend-down{color:var(--danger); font-weight:600}\n';
                    html += '    .trend-neutral{color:var(--muted)}\n';
                    html += '    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600}\n';
                    html += '    .badge-up{background:rgba(81,207,102,.2); color:var(--success)}\n';
                    html += '    .badge-down{background:rgba(255,107,107,.2); color:var(--danger)}\n';
                    html += '    footer{color:var(--muted); font-size:.85rem; margin:30px 0 20px; text-align:center}\n';
                    html += '    @media print{body{background:white; color:black} .btn{display:none}}\n';
                    html += '  </style>\n';
                    html += '</head>\n';
                    html += '<body>\n';
                    html += '  <div class="container">\n';
                    html += '    <header>\n';
                    html += '      <h1>ğŸ“Š ' + storeName + ' æ¯å‘¨ç‡Ÿæ¥­é¡è¶¨å‹¢åˆ†æ</h1>\n';
                    html += '      <div class="subtitle">åˆ†ææœŸé–“ï¼š' + dateRange + 'ã€€ï½œã€€ç¾¤çµ„ï¼š' + groupName + '</div>\n';
                    html += '    </header>\n';
                    html += '    <section class="cards" id="kpis"></section>\n';
                    html += '    <div class="toolbar">\n';
                    html += '      <button class="btn" id="exportBtn">åŒ¯å‡º CSV</button>\n';
                    html += '      <button class="btn" id="printBtn">åˆ—å° / å­˜æˆ PDF</button>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ“ˆ ç‡Ÿæ¥­é¡è¶¨å‹¢åœ–</h3>\n';
                    html += '      <canvas id="revenueChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ï¿½ PSD (æ—¥å‡ç‡Ÿæ¥­é¡) è¶¨å‹¢åœ–</h3>\n';
                    html += '      <canvas id="psdChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ï¿½ğŸ“Š å‡ºè²¨æ¬¡æ•¸è¶¨å‹¢åœ–</h3>\n';
                    html += '      <canvas id="payoutsChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ“‹ æ¯å‘¨è©³ç´°æ•¸æ“š</h3>\n';
                    html += '      <table id="weekTable">\n';
                    html += '        <thead><tr><th>å‘¨æ¬¡</th><th>ç‡Ÿæ¥­é¡</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>PSD (æ—¥å‡)</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>å‡ºè²¨æ¬¡æ•¸</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>å¹³å‡å‡ºè²¨æˆæœ¬</th></tr></thead>\n';
                    html += '        <tbody></tbody>\n';
                    html += '      </table>\n';
                    html += '    </div>\n';
                    html += '    <footer>ç”Ÿæˆæ™‚é–“ï¼š' + buildTime + '</footer>\n';
                    html += '  </div>\n';
                    html += '  <script>\n';
                    html += '    const weeks = ' + weeksJSON + ';\n';
                    html += '    const summary = ' + summaryJSON + ';\n';
                    html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                    html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                    html += '    const percent = n => (n >= 0 ? "+" : "") + n.toFixed(1) + "%";\n';
                    html += '    function buildCSV(){\n';
                    html += '      const header = ["å‘¨æ¬¡","ç‡Ÿæ¥­é¡","ç‡Ÿæ¥­é¡å‘¨æ¯”è®ŠåŒ–(%)","PSD(æ—¥å‡)","PSDå‘¨æ¯”è®ŠåŒ–(%)","å‡ºè²¨æ¬¡æ•¸","å‡ºè²¨æ¬¡æ•¸å‘¨æ¯”è®ŠåŒ–(%)","å¹³å‡å‡ºè²¨æˆæœ¬"];\n';
                    html += '      const lines = [header.join(",")].concat(weeks.map((w,i) => [\n';
                    html += '        w.weekLabel,\n';
                    html += '        w.revenue,\n';
                    html += '        i > 0 ? w.revenueChange.toFixed(2) : "N/A",\n';
                    html += '        w.psd.toFixed(2),\n';
                    html += '        i > 0 ? w.psdChange.toFixed(2) : "N/A",\n';
                    html += '        w.payouts,\n';
                    html += '        i > 0 ? w.payoutsChange.toFixed(2) : "N/A",\n';
                    html += '        w.avgCost.toFixed(2)\n';
                    html += '      ].join(",")));\n';
                    html += '      return "\\uFEFF" + lines.join("\\n");\n';
                    html += '    }\n';
                    html += '    function exportCSV(){\n';
                    html += '      try{\n';
                    html += '        const csv = buildCSV();\n';
                    html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                    html += '        const url = URL.createObjectURL(blob);\n';
                    html += '        const a = document.createElement("a");\n';
                    html += '        a.href = url; a.download = "weekly_trend_report.csv";\n';
                    html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                    html += '      }catch(err){ console.error("CSVåŒ¯å‡ºå¤±æ•—", err); alert("CSVåŒ¯å‡ºå¤±æ•—"); }\n';
                    html += '    }\n';
                    html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                    html += '      const kpiRoot = document.getElementById("kpis");\n';
                    html += '      [\n';
                    html += '        { label:"åˆ†æå‘¨æ•¸", value: nt(summary.weeksCount) + " å‘¨" },\n';
                    html += '        { label:"ç¸½ç‡Ÿæ¥­é¡", value: money(summary.totalRevenue) },\n';
                    html += '        { label:"ç¸½å‡ºè²¨æ¬¡æ•¸", value: nt(summary.totalPayouts) + " æ¬¡" },\n';
                    html += '        { label:"å¹³å‡å‘¨ç‡Ÿæ¥­é¡", value: money(summary.avgWeeklyRevenue) }\n';
                    html += '      ].forEach(k=>{\n';
                    html += '        const el = document.createElement("div");\n';
                    html += '        el.className="card";\n';
                    html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                    html += '        kpiRoot.appendChild(el);\n';
                    html += '      });\n';
                    html += '      const tbody = document.querySelector("#weekTable tbody");\n';
                    html += '      weeks.forEach((w,i)=>{\n';
                    html += '        const tr = document.createElement("tr");\n';
                    html += '        const revChange = i > 0 ? "<span class=\\"" + (w.revenueChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.revenueChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const psdChange = i > 0 ? "<span class=\\"" + (w.psdChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.psdChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const payChange = i > 0 ? "<span class=\\"" + (w.payoutsChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.payoutsChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        tr.innerHTML = "<td>" + w.weekLabel + "</td>"+\n';
                    html += '          "<td>" + money(w.revenue) + "</td>"+\n';
                    html += '          "<td>" + revChange + "</td>"+\n';
                    html += '          "<td>" + money(w.psd) + "</td>"+\n';
                    html += '          "<td>" + psdChange + "</td>"+\n';
                    html += '          "<td>" + nt(w.payouts) + "</td>"+\n';
                    html += '          "<td>" + payChange + "</td>"+\n';
                    html += '          "<td>" + money(w.avgCost) + "</td>";\n';
                    html += '        tbody.appendChild(tr);\n';
                    html += '      });\n';
                    html += '      const labels = weeks.map(w=>w.weekLabel);\n';
                    html += '      const revenueData = weeks.map(w=>w.revenue);\n';
                    html += '      const psdData = weeks.map(w=>w.psd);\n';
                    html += '      const payoutsData = weeks.map(w=>w.payouts);\n';
                    html += '      new Chart(document.getElementById("revenueChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"ç‡Ÿæ¥­é¡", data:revenueData, borderColor:"#5aa9ff", backgroundColor:"rgba(90,169,255,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("psdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"PSD (æ—¥å‡)", data:psdData, borderColor:"#ffa94d", backgroundColor:"rgba(255,169,77,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("payoutsChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"å‡ºè²¨æ¬¡æ•¸", data:payoutsData, borderColor:"#8bd17c", backgroundColor:"rgba(139,209,124,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                    html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                    html += '    });\n';
                    html += '  <\/script>\n';
                    html += '</body>\n';
                    html += '</html>';
                    return html;
                }
                
                // æ‰“é–‹æ¯å‘¨è¶¨å‹¢åˆ†æå ±è¡¨
                async function openWeeklyTrendReport() {
                    if (!selectedGroupId) { alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„'); return; }
                    const selected = document.querySelectorAll('.store-checkbox:checked');
                    if (selected.length === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆ†æçš„é–€å¸‚'); return; }
                    if (selected.length > 1) { alert('æ¯å‘¨è¶¨å‹¢åˆ†æä¸€æ¬¡åªèƒ½é¸æ“‡ä¸€å€‹é–€å¸‚'); return; }
                    
                    const startDateInput = document.getElementById('weekly-trend-start-date');
                    const endDateInput = document.getElementById('weekly-trend-end-date');
                    
                    if (!startDateInput.value || !endDateInput.value) {
                        alert('è«‹é¸æ“‡èµ·å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸ');
                        return;
                    }
                    
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    
                    if (startDate > endDate) {
                        alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                        return;
                    }
                    
                    const storeId = selected[0].value;
                    const storeName = selected[0].dataset.storeName;
                    
                    // é¡¯ç¤ºè¼‰å…¥æç¤º
                    pdfLoaderText.textContent = 'æ­£åœ¨åˆ†ææ¯å‘¨ç‡Ÿæ¥­é¡è¶¨å‹¢...';
                    pdfLoaderOverlay.classList.remove('hidden');
                    pdfLoaderOverlay.classList.add('flex');
                    
                    try {
                        const weeks = await calculateWeeklyTrends(storeId, startDateInput.value, endDateInput.value);
                        
                        if (weeks.length === 0) {
                            alert('æ‰€é¸æ—¥æœŸç¯„åœå…§æ²’æœ‰æ•¸æ“š');
                            return;
                        }
                        
                        const html = generateWeeklyTrendHTML({
                            storeName,
                            weeks,
                            dateRange: `${startDateInput.value} ~ ${endDateInput.value}`,
                            groupName: selectedGroupName || ''
                        });
                        
                        const w = window.open('', '_blank');
                        if (!w) { alert('ç€è¦½å™¨å°é–äº†å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°åˆ†é '); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    } catch (error) {
                        console.error('ç”Ÿæˆæ¯å‘¨è¶¨å‹¢å ±è¡¨å¤±æ•—:', error);
                        alert('ç”Ÿæˆå ±è¡¨å¤±æ•—: ' + error.message);
                    } finally {
                        pdfLoaderOverlay.classList.add('hidden');
                        pdfLoaderOverlay.classList.remove('flex');
                    }
                }

                // æ‰“é–‹å¤šé–€å¸‚å‘¨å ±æ¯”è¼ƒ
                async function openMultiStoreWeeklyTrendReport() {
                    if (!selectedGroupId) { alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„'); return; }
                    const selected = document.querySelectorAll('.store-checkbox:checked');
                    if (selected.length === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆ†æçš„é–€å¸‚'); return; }
                    
                    const startDateInput = document.getElementById('weekly-trend-start-date');
                    const endDateInput = document.getElementById('weekly-trend-end-date');
                    
                    if (!startDateInput.value || !endDateInput.value) {
                        alert('è«‹é¸æ“‡èµ·å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸ');
                        return;
                    }
                    
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    
                    if (startDate > endDate) {
                        alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                        return;
                    }
                    
                    // é¡¯ç¤ºè¼‰å…¥æç¤º
                    pdfLoaderText.textContent = 'æ­£åœ¨åˆ†æå¤šé–€å¸‚å‘¨å ±æ•¸æ“š...';
                    pdfLoaderOverlay.classList.remove('hidden');
                    pdfLoaderOverlay.classList.add('flex');
                    
                    try {
                        // æ”¶é›†æ‰€æœ‰é–€å¸‚çš„å‘¨å ±æ•¸æ“š
                        const storesData = [];
                        
                        for (const cb of selected) {
                            const storeId = cb.value;
                            const storeName = cb.dataset.storeName;
                            const weeks = await calculateWeeklyTrends(storeId, startDateInput.value, endDateInput.value);
                            
                            storesData.push({
                                storeId,
                                storeName,
                                weeks
                            });
                        }
                        
                        if (storesData.length === 0 || storesData[0].weeks.length === 0) {
                            alert('æ‰€é¸æ—¥æœŸç¯„åœå…§æ²’æœ‰æ•¸æ“š');
                            return;
                        }
                        
                        // è¨ˆç®—ç¸½å’Œæ•¸æ“š
                        const combinedWeeks = calculateCombinedWeeklyData(storesData);
                        
                        const html = generateMultiStoreWeeklyTrendHTML({
                            storesData,
                            combinedWeeks,
                            dateRange: `${startDateInput.value} ~ ${endDateInput.value}`,
                            groupName: selectedGroupName || ''
                        });
                        
                        const w = window.open('', '_blank');
                        if (!w) { alert('ç€è¦½å™¨å°é–äº†å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°åˆ†é '); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    } catch (error) {
                        console.error('ç”Ÿæˆå¤šé–€å¸‚å‘¨å ±æ¯”è¼ƒå¤±æ•—:', error);
                        alert('ç”Ÿæˆå ±è¡¨å¤±æ•—: ' + error.message);
                    } finally {
                        pdfLoaderOverlay.classList.add('hidden');
                        pdfLoaderOverlay.classList.remove('flex');
                    }
                }
                
                // è¨ˆç®—å¤šé–€å¸‚çš„åˆä½µå‘¨å ±æ•¸æ“š
                function calculateCombinedWeeklyData(storesData) {
                    if (storesData.length === 0) return [];
                    
                    // ä½¿ç”¨ç¬¬ä¸€å€‹é–€å¸‚çš„å‘¨æ¬¡ä½œç‚ºåŸºæº–
                    const baseWeeks = storesData[0].weeks;
                    const combinedWeeks = [];
                    
                    baseWeeks.forEach((baseWeek, weekIndex) => {
                        let totalRevenue = 0;
                        let totalPayouts = 0;
                        let totalPlays = 0;
                        let totalDays = 0;
                        
                        // åŠ ç¸½æ‰€æœ‰é–€å¸‚åœ¨é€™ä¸€å‘¨çš„æ•¸æ“š
                        storesData.forEach(store => {
                            if (store.weeks[weekIndex]) {
                                totalRevenue += store.weeks[weekIndex].revenue;
                                totalPayouts += store.weeks[weekIndex].payouts;
                                totalPlays += store.weeks[weekIndex].plays;
                                totalDays = store.weeks[weekIndex].days; // æ‰€æœ‰é–€å¸‚çš„å¤©æ•¸ç›¸åŒ
                            }
                        });
                        
                        combinedWeeks.push({
                            weekStart: baseWeek.weekStart,
                            weekEnd: baseWeek.weekEnd,
                            weekLabel: baseWeek.weekLabel,
                            revenue: totalRevenue,
                            payouts: totalPayouts,
                            plays: totalPlays,
                            avgCost: totalPayouts > 0 ? totalRevenue / totalPayouts : 0,
                            days: totalDays,
                            psd: totalRevenue / totalDays  // å¹³å‡æ¯æ—¥éŠ·å”®
                        });
                    });
                    
                    // è¨ˆç®—å‘¨æ¯”è®ŠåŒ–
                    for (let i = 1; i < combinedWeeks.length; i++) {
                        const current = combinedWeeks[i];
                        const previous = combinedWeeks[i - 1];
                        
                        current.revenueChange = previous.revenue > 0 ? 
                            ((current.revenue - previous.revenue) / previous.revenue * 100) : 0;
                        current.payoutsChange = previous.payouts > 0 ? 
                            ((current.payouts - previous.payouts) / previous.payouts * 100) : 0;
                        current.psdChange = previous.psd > 0 ? 
                            ((current.psd - previous.psd) / previous.psd * 100) : 0;
                    }
                    
                    return combinedWeeks;
                }
                
                // ç”Ÿæˆå¤šé–€å¸‚å‘¨å ±æ¯”è¼ƒ HTML
                function generateMultiStoreWeeklyTrendHTML({ storesData, combinedWeeks, dateRange, groupName }) {
                    const buildTime = new Date().toLocaleString('zh-TW');
                    const totalRevenue = combinedWeeks.reduce((sum, w) => sum + w.revenue, 0);
                    const totalPayouts = combinedWeeks.reduce((sum, w) => sum + w.payouts, 0);
                    const avgWeeklyRevenue = combinedWeeks.length > 0 ? totalRevenue / combinedWeeks.length : 0;
                    
                    const storesJSON = JSON.stringify(storesData.map(s => ({
                        storeName: s.storeName,
                        weeks: s.weeks
                    })));
                    const combinedJSON = JSON.stringify(combinedWeeks);
                    const summaryJSON = JSON.stringify({
                        totalRevenue,
                        totalPayouts,
                        avgWeeklyRevenue,
                        weeksCount: combinedWeeks.length,
                        storesCount: storesData.length
                    });
                    
                    let html = '<!DOCTYPE html>\n';
                    html += '<html lang="zh-Hant">\n';
                    html += '<head>\n';
                    html += '  <meta charset="utf-8" />\n';
                    html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                    html += '  <title>' + groupName + ' å¤šé–€å¸‚å‘¨å ±ç‡Ÿæ¥­é¡æ¯”è¼ƒ</title>\n';
                    html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                    html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                    html += '  <style>\n';
                    html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; --danger:#ff6b6b; --success:#51cf66; }\n';
                    html += '    *{box-sizing:border-box; margin:0; padding:0}\n';
                    html += '    body{font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text); padding:20px}\n';
                    html += '    .container{max-width:1400px; margin:0 auto}\n';
                    html += '    header{margin-bottom:24px}\n';
                    html += '    header h1{font-size:1.8rem; margin-bottom:8px; letter-spacing:.02em}\n';
                    html += '    header .subtitle{color:var(--muted); font-size:1rem; margin-top:4px}\n';
                    html += '    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:24px 0}\n';
                    html += '    .card{background:var(--card); padding:16px 20px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .card .label{color:var(--muted); font-size:.85rem; margin-bottom:8px}\n';
                    html += '    .card .value{font-size:1.6rem; font-weight:700}\n';
                    html += '    .toolbar{display:flex; gap:12px; margin:20px 0}\n';
                    html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:.95rem}\n';
                    html += '    .btn:hover{background:#233042}\n';
                    html += '    .chart-section{background:var(--card); padding:24px; border-radius:14px; margin:20px 0; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .chart-section h3{margin-bottom:16px; font-size:1.2rem}\n';
                    html += '    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:20px 0}\n';
                    html += '    @media(max-width:1000px){.grid-2{grid-template-columns:1fr}}\n';
                    html += '    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:20px}\n';
                    html += '    thead th{font-size:.9rem; color:var(--muted); text-align:left; padding:8px 12px; font-weight:600}\n';
                    html += '    tbody td{background:#0f1520; padding:14px 12px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                    html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                    html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                    html += '    .trend-up{color:var(--success); font-weight:600}\n';
                    html += '    .trend-down{color:var(--danger); font-weight:600}\n';
                    html += '    .trend-neutral{color:var(--muted)}\n';
                    html += '    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600}\n';
                    html += '    .badge-up{background:rgba(81,207,102,.2); color:var(--success)}\n';
                    html += '    .badge-down{background:rgba(255,107,107,.2); color:var(--danger)}\n';
                    html += '    .store-tag{display:inline-block; padding:3px 10px; margin:2px; border-radius:999px; font-size:.8rem; background:rgba(90,169,255,.2); color:var(--accent)}\n';
                    html += '    footer{color:var(--muted); font-size:.85rem; margin:30px 0 20px; text-align:center}\n';
                    html += '    @media print{body{background:white; color:black} .btn{display:none}}\n';
                    html += '  </style>\n';
                    html += '</head>\n';
                    html += '<body>\n';
                    html += '  <div class="container">\n';
                    html += '    <header>\n';
                    html += '      <h1>ğŸ“Š å¤šé–€å¸‚å‘¨å ±ç‡Ÿæ¥­é¡æ¯”è¼ƒåˆ†æ</h1>\n';
                    html += '      <div class="subtitle">åˆ†ææœŸé–“ï¼š' + dateRange + 'ã€€ï½œã€€ç¾¤çµ„ï¼š' + groupName + '</div>\n';
                    html += '      <div class="subtitle" style="margin-top:8px">åŒ…å«é–€å¸‚ï¼š';
                    storesData.forEach((s, i) => {
                        html += '<span class="store-tag">' + s.storeName + '</span>';
                    });
                    html += '</div>\n';
                    html += '    </header>\n';
                    html += '    <section class="cards" id="kpis"></section>\n';
                    html += '    <div class="toolbar">\n';
                    html += '      <button class="btn" id="exportBtn">åŒ¯å‡º CSV</button>\n';
                    html += '      <button class="btn" id="printBtn">åˆ—å° / å­˜æˆ PDF</button>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ“ˆ å„é–€å¸‚ç‡Ÿæ¥­é¡è¶¨å‹¢å°æ¯”</h3>\n';
                    html += '      <canvas id="compareChart" height="100"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="grid-2">\n';
                    html += '      <div class="chart-section">\n';
                    html += '        <h3>ğŸ“Š åŠ ç¸½ç‡Ÿæ¥­é¡è¶¨å‹¢</h3>\n';
                    html += '        <canvas id="totalRevenueChart" height="120"></canvas>\n';
                    html += '      </div>\n';
                    html += '      <div class="chart-section">\n';
                    html += '        <h3>ğŸ’° åŠ ç¸½PSD (æ—¥å‡) è¶¨å‹¢</h3>\n';
                    html += '        <canvas id="totalPsdChart" height="120"></canvas>\n';
                    html += '      </div>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ“ˆ å„é–€å¸‚PSDè¶¨å‹¢å°æ¯”</h3>\n';
                    html += '      <canvas id="comparePsdChart" height="100"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ¯ åŠ ç¸½å‡ºè²¨æ¬¡æ•¸è¶¨å‹¢</h3>\n';
                    html += '      <canvas id="totalPayoutsChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>ğŸ“‹ åŠ ç¸½å‘¨å ±è©³ç´°æ•¸æ“š</h3>\n';
                    html += '      <table id="weekTable">\n';
                    html += '        <thead><tr><th>å‘¨æ¬¡</th><th>ç¸½ç‡Ÿæ¥­é¡</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>PSD (æ—¥å‡)</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>ç¸½å‡ºè²¨æ¬¡æ•¸</th><th>å‘¨æ¯”è®ŠåŒ–</th><th>å¹³å‡å‡ºè²¨æˆæœ¬</th></tr></thead>\n';
                    html += '        <tbody></tbody>\n';
                    html += '      </table>\n';
                    html += '    </div>\n';
                    html += '    <footer>ç”Ÿæˆæ™‚é–“ï¼š' + buildTime + '</footer>\n';
                    html += '  </div>\n';
                    html += '  <script>\n';
                    html += '    const storesData = ' + storesJSON + ';\n';
                    html += '    const combinedWeeks = ' + combinedJSON + ';\n';
                    html += '    const summary = ' + summaryJSON + ';\n';
                    html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                    html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                    html += '    const percent = n => (n >= 0 ? "+" : "") + n.toFixed(1) + "%";\n';
                    html += '    function buildCSV(){\n';
                    html += '      const header = ["å‘¨æ¬¡","ç¸½ç‡Ÿæ¥­é¡","ç‡Ÿæ¥­é¡å‘¨æ¯”è®ŠåŒ–(%)","PSD(æ—¥å‡)","PSDå‘¨æ¯”è®ŠåŒ–(%)","ç¸½å‡ºè²¨æ¬¡æ•¸","å‡ºè²¨æ¬¡æ•¸å‘¨æ¯”è®ŠåŒ–(%)","å¹³å‡å‡ºè²¨æˆæœ¬"];\n';
                    html += '      const lines = [header.join(",")].concat(combinedWeeks.map((w,i) => [\n';
                    html += '        w.weekLabel,\n';
                    html += '        w.revenue,\n';
                    html += '        i > 0 ? w.revenueChange.toFixed(2) : "N/A",\n';
                    html += '        w.psd.toFixed(2),\n';
                    html += '        i > 0 ? w.psdChange.toFixed(2) : "N/A",\n';
                    html += '        w.payouts,\n';
                    html += '        i > 0 ? w.payoutsChange.toFixed(2) : "N/A",\n';
                    html += '        w.avgCost.toFixed(2)\n';
                    html += '      ].join(",")));\n';
                    html += '      return "\\uFEFF" + lines.join("\\n");\n';
                    html += '    }\n';
                    html += '    function exportCSV(){\n';
                    html += '      try{\n';
                    html += '        const csv = buildCSV();\n';
                    html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                    html += '        const url = URL.createObjectURL(blob);\n';
                    html += '        const a = document.createElement("a");\n';
                    html += '        a.href = url; a.download = "multi_store_weekly_comparison.csv";\n';
                    html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                    html += '      }catch(err){ console.error("CSVåŒ¯å‡ºå¤±æ•—", err); alert("CSVåŒ¯å‡ºå¤±æ•—"); }\n';
                    html += '    }\n';
                    html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                    html += '      const kpiRoot = document.getElementById("kpis");\n';
                    html += '      [\n';
                    html += '        { label:"åŒ…å«é–€å¸‚æ•¸", value: nt(summary.storesCount) + " å®¶" },\n';
                    html += '        { label:"åˆ†æå‘¨æ•¸", value: nt(summary.weeksCount) + " å‘¨" },\n';
                    html += '        { label:"ç¸½ç‡Ÿæ¥­é¡", value: money(summary.totalRevenue) },\n';
                    html += '        { label:"ç¸½å‡ºè²¨æ¬¡æ•¸", value: nt(summary.totalPayouts) + " æ¬¡" },\n';
                    html += '        { label:"å¹³å‡å‘¨ç‡Ÿæ¥­é¡", value: money(summary.avgWeeklyRevenue) }\n';
                    html += '      ].forEach(k=>{\n';
                    html += '        const el = document.createElement("div");\n';
                    html += '        el.className="card";\n';
                    html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                    html += '        kpiRoot.appendChild(el);\n';
                    html += '      });\n';
                    html += '      const tbody = document.querySelector("#weekTable tbody");\n';
                    html += '      combinedWeeks.forEach((w,i)=>{\n';
                    html += '        const tr = document.createElement("tr");\n';
                    html += '        const revChange = i > 0 ? "<span class=\\"" + (w.revenueChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.revenueChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const psdChange = i > 0 ? "<span class=\\"" + (w.psdChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.psdChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const payChange = i > 0 ? "<span class=\\"" + (w.payoutsChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.payoutsChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        tr.innerHTML = "<td>" + w.weekLabel + "</td>"+\n';
                    html += '          "<td>" + money(w.revenue) + "</td>"+\n';
                    html += '          "<td>" + revChange + "</td>"+\n';
                    html += '          "<td>" + money(w.psd) + "</td>"+\n';
                    html += '          "<td>" + psdChange + "</td>"+\n';
                    html += '          "<td>" + nt(w.payouts) + "</td>"+\n';
                    html += '          "<td>" + payChange + "</td>"+\n';
                    html += '          "<td>" + money(w.avgCost) + "</td>";\n';
                    html += '        tbody.appendChild(tr);\n';
                    html += '      });\n';
                    html += '      const labels = combinedWeeks.map(w=>w.weekLabel);\n';
                    html += '      const colors = ["#5aa9ff","#8bd17c","#ffb454","#ff6b6b","#a78bfa","#f472b6","#fb923c","#34d399"];\n';
                    html += '      const datasets = storesData.map((store, idx) => ({\n';
                    html += '        label: store.storeName,\n';
                    html += '        data: store.weeks.map(w => w.revenue),\n';
                    html += '        borderColor: colors[idx % colors.length],\n';
                    html += '        backgroundColor: "transparent",\n';
                    html += '        tension: 0.3\n';
                    html += '      }));\n';
                    html += '      const psdDatasets = storesData.map((store, idx) => ({\n';
                    html += '        label: store.storeName,\n';
                    html += '        data: store.weeks.map(w => w.psd),\n';
                    html += '        borderColor: colors[idx % colors.length],\n';
                    html += '        backgroundColor: "transparent",\n';
                    html += '        tension: 0.3\n';
                    html += '      }));\n';
                    html += '      new Chart(document.getElementById("compareChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:true, position:"top", labels:{color:"#9fb0c0"} }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("comparePsdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets: psdDatasets },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:true, position:"top", labels:{color:"#9fb0c0"} }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalRevenueChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"ç¸½ç‡Ÿæ¥­é¡", data:combinedWeeks.map(w=>w.revenue), borderColor:"#5aa9ff", backgroundColor:"rgba(90,169,255,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalPsdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"PSD (æ—¥å‡)", data:combinedWeeks.map(w=>w.psd), borderColor:"#ffa94d", backgroundColor:"rgba(255,169,77,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalPayoutsChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"ç¸½å‡ºè²¨æ¬¡æ•¸", data:combinedWeeks.map(w=>w.payouts), borderColor:"#8bd17c", backgroundColor:"rgba(139,209,124,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                    html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                    html += '    });\n';
                    html += '  <\/script>\n';
                    html += '</body>\n';
                    html += '</html>';
                    return html;
                }

                // --- NAVIGATION & PAGE CONTROL ---
        
        function showGroupSelectionPage() {
            selectedGroupId = null;
            selectedGroupName = '';
            selectedStoreId = null;
            selectedStoreName = '';
            
            groupSelectionPage.classList.remove('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            
            loadGroups();
        }
        
        // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸç¯„åœä¾›ç™»å…¥ç³»çµ±ä½¿ç”¨
        window.showGroupSelectionPage = showGroupSelectionPage;

        // --- åˆå§‹åŒ–ç¶²é é è¦½æ—¥æœŸé¸æ“‡å™¨ ---
        const previewDatePicker = document.getElementById('preview-date-picker');
        if (previewDatePicker) {
            // è¨­å®šç‚ºä»Šå¤©çš„æ—¥æœŸ
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            previewDatePicker.value = `${year}-${month}-${day}`;
        }

        // --- åˆå§‹åŒ–æ¯å‘¨è¶¨å‹¢åˆ†ææ—¥æœŸé¸æ“‡å™¨ ---
        if (weeklyTrendStartDate && weeklyTrendEndDate) {
            const today = new Date();
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            // èµ·å§‹æ—¥æœŸè¨­ç‚ºä¸€å€‹æœˆå‰
            weeklyTrendStartDate.value = oneMonthAgo.toISOString().split('T')[0];
            // çµæŸæ—¥æœŸè¨­ç‚ºä»Šå¤©
            weeklyTrendEndDate.value = today.toISOString().split('T')[0];
        }

        // --- ç®¡ç†è€…ç•Œé¢å‡½æ•¸ ---
        function showAdminPage() {
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            
            loadAdminInterface();
        }

        function hideAdminPage() {
            adminPage.classList.add('hidden');
            showGroupSelectionPage();
        }

        function loadAdminInterface() {
            // è¼‰å…¥ç•¶å‰ç®¡ç†å“¡è³‡è¨Š
            const currentAdmin = window.adminConfig.config.adminCredentials;
            document.getElementById('new-username').value = currentAdmin.username;
            
            // è¼‰å…¥ç¾¤çµ„æ¬Šé™é¸é …
            loadGroupPermissions();
            
            // è¼‰å…¥è¨ªå®¢å¸³è™Ÿåˆ—è¡¨
            loadGuestAccountsTable();
            
            // é‡ç½®è¡¨å–®
            adminPasswordForm.reset();
            guestAccountForm.reset();
            document.getElementById('new-username').value = currentAdmin.username;
        }

        async function loadGroupPermissions() {
            try {
                const groupsSnapshot = await db.collection('groups').get();
                const groups = groupsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                groupPermissions.innerHTML = '';
                if (groups.length === 0) {
                    groupPermissions.innerHTML = '<p class="text-gray-400 text-sm">ç›®å‰æ²’æœ‰å¯ç”¨çš„ç¾¤çµ„</p>';
                } else {
                    groups.forEach(group => {
                        const checkbox = document.createElement('label');
                        checkbox.className = 'flex items-center space-x-2 text-white cursor-pointer';
                        checkbox.innerHTML = `
                            <input type="checkbox" value="${group.id}" class="group-permission-checkbox rounded">
                            <span>${group.name}</span>
                        `;
                        groupPermissions.appendChild(checkbox);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ç¾¤çµ„æ¬Šé™å¤±æ•—:', error);
                groupPermissions.innerHTML = '<p class="text-red-400 text-sm">è¼‰å…¥ç¾¤çµ„å¤±æ•—</p>';
            }
        }

        function loadGuestAccountsTable() {
            const guests = window.adminConfig.getGuestAccounts();
            guestAccountsTable.innerHTML = '';
            
            if (guests.length === 0) {
                guestAccountsTable.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-400">å°šç„¡è¨ªå®¢å¸³è™Ÿ</td></tr>';
            } else {
                guests.forEach(guest => {
                    const allowedGroupsText = guest.allowedGroups.length > 0 ? 
                        `${guest.allowedGroups.length} å€‹ç¾¤çµ„` : 'ç„¡æ¬Šé™';
                    
                    // é é¢æ¬Šé™é¡¯ç¤º
                    const pagePermissions = guest.pagePermissions || [];
                    const pagePermissionNames = {
                        'details': 'æ©Ÿå°æ˜ç´°', 'summary': 'ç‡Ÿé‹ç¸½è¦½', 'analysis': 'ç¶“ç‡Ÿåˆ†æ',
                        'charts': 'åœ–è¡¨çµ±è¨ˆ', 'statistics': 'æ•¸æ“šçµ±è¨ˆ', 'accounting': 'æ¯æ—¥è¨˜å¸³',
                        'machines': 'æ©Ÿå°ç®¡ç†', 'profit': 'ç›ˆåˆ©è¨ˆç®—', 'checkout': 'çµå¸³ä½œæ¥­', 'download': 'ä¸‹è¼‰å ±å‘Š', 'edit': 'ç·¨è¼¯åˆªé™¤'
                    };
                    const pagePermissionsText = pagePermissions.length > 0 ? 
                        pagePermissions.map(p => pagePermissionNames[p] || p).slice(0, 3).join(', ') + 
                        (pagePermissions.length > 3 ? `ç­‰${pagePermissions.length}é …` : '') : 'ç„¡æ¬Šé™';
                    
                    const statusText = guest.enabled ? 'å•Ÿç”¨' : 'åœç”¨';
                    const statusClass = guest.enabled ? 'text-green-400' : 'text-red-400';
                    const createdDate = new Date(guest.createdAt).toLocaleDateString();
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700/50 transition';
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${guest.username}</td>
                        <td class="p-4 ${statusClass}">${statusText}</td>
                        <td class="p-4 text-gray-300">${allowedGroupsText}</td>
                        <td class="p-4 text-gray-300 text-sm" title="${pagePermissions.map(p => pagePermissionNames[p] || p).join(', ')}">${pagePermissionsText}</td>
                        <td class="p-4 text-gray-300">${createdDate}</td>
                        <td class="p-4 text-center">
                            <button class="edit-guest-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-guest-id="${guest.id}">ç·¨è¼¯</button>
                            <button class="delete-guest-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" data-guest-id="${guest.id}">åˆªé™¤</button>
                        </td>
                    `;
                    guestAccountsTable.appendChild(row);
                });
            }
        }

        function showAdminFeedback(elementId, message, isError = false) {
            const feedbackEl = document.getElementById(elementId);
            feedbackEl.textContent = message;
            feedbackEl.className = `text-sm mt-2 ${isError ? 'text-red-400' : 'text-green-400'}`;
            feedbackEl.classList.remove('hidden');
            setTimeout(() => {
                feedbackEl.classList.add('hidden');
            }, 5000);
        }

        function showStoreSelectionPage(groupId, groupName) {
            selectedGroupId = groupId;
            selectedGroupName = groupName;
            
            document.getElementById('store-page-title').textContent = `${groupName} - é–€å¸‚ç®¡ç†`;
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
            reportPage.classList.add('hidden');
            document.getElementById('new-store-start-date').valueAsDate = new Date();
            document.getElementById('clone-store-start-date').valueAsDate = new Date();

            // æ ¹æ“šç”¨æˆ¶é¡å‹éš±è—/é¡¯ç¤ºæ–°å¢é–€å¸‚è¡¨å–®
            const userType = localStorage.getItem('userType');
            const createStoreForm = document.getElementById('create-store-form').parentElement;
            if (createStoreForm) {
                if (userType === 'admin') {
                    createStoreForm.style.display = 'block';
                } else {
                    createStoreForm.style.display = 'none';
                }
            }

            // âœ… è¨ˆç®—ä¸¦é¡¯ç¤ºç¸½ç‡Ÿæ¥­é¡çµ±è¨ˆ
            displayStoresSalesStatistics(groupId);
            
            loadStores();
        }

        // âœ… æ–°å¢å‡½æ•¸ï¼šè¨ˆç®—ä¸¦é¡¯ç¤ºæ‰€æœ‰é–€å¸‚çš„ç‡Ÿæ¥­é¡çµ±è¨ˆ
        async function displayStoresSalesStatistics(groupId) {
            try {
                // ç²å–è©²ç¾¤çµ„ä¸‹æ‰€æœ‰é–€å¸‚
                const storesSnapshot = await db.collection('groups').doc(groupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                if (stores.length === 0) {
                    console.log('âš ï¸ è©²ç¾¤çµ„æ²’æœ‰ä»»ä½•é–€å¸‚');
                    return;
                }

                // è¨ˆç®—æ¯é–“é–€å¸‚çš„ç‡Ÿæ¥­é¡
                const storesSalesData = [];
                let totalAllStoresRevenue = 0;
                let totalAllStoresCheckoutRevenue = 0;

                for (const store of stores) {
                    try {
                        // ç²å–è©²é–€å¸‚çš„æ©Ÿå°è³‡è¨Š
                        const machinesSnapshot = await db.collection('groups').doc(groupId)
                            .collection('stores').doc(store.id).collection('machines').get();
                        const machines = machinesSnapshot.docs.map(doc => ({docId: doc.id, ...doc.data()}));

                        // è¨ˆç®—ç•¶æœŸç‡Ÿæ¥­é¡ï¼ˆæœªçµå¸³ï¼‰
                        let storeRevenue = 0;
                        let storeCheckoutRevenue = 0;

                        // ç²å–æœ€å¾Œçµå¸³çš„ç´¯è¨ˆæ•¸æ“š
                        let lastCheckoutRevenue = 0;
                        try {
                            const lastCheckoutSnapshot = await db.collection('groups').doc(groupId)
                                .collection('stores').doc(store.id).collection('checkouts')
                                .orderBy('checkoutDate', 'desc').limit(1).get();

                            if (!lastCheckoutSnapshot.empty) {
                                lastCheckoutRevenue = lastCheckoutSnapshot.docs[0].data().checkoutAmount || 0;
                            }
                        } catch (checkoutError) {
                            console.warn(`ç„¡æ³•ç²å– ${store.name} çš„çµå¸³è¨˜éŒ„:`, checkoutError);
                            lastCheckoutRevenue = 0;
                        }

                        // è¨ˆç®—ç•¶å‰ç¸½ç‡Ÿæ¥­é¡
                        machines.forEach(machine => {
                            const plays = machine.plays || 0;
                            const initialPlays = machine.initialPlays || 0;
                            const effectivePlays = plays - initialPlays;
                            const revenue = effectivePlays * COIN_VALUE;
                            storeRevenue += revenue;
                        });

                        // ç•¶æœŸç‡Ÿæ¥­é¡ = ç¸½ç‡Ÿæ¥­é¡ - æœ€å¾Œçµå¸³ç‡Ÿæ¥­é¡
                        storeCheckoutRevenue = Math.max(0, storeRevenue - lastCheckoutRevenue);

                        storesSalesData.push({
                            storeName: store.name,
                            totalRevenue: storeRevenue,
                            checkoutRevenue: storeCheckoutRevenue,
                            lastCheckoutRevenue: lastCheckoutRevenue
                        });

                        totalAllStoresRevenue += storeRevenue;
                        totalAllStoresCheckoutRevenue += storeCheckoutRevenue;

                    } catch (error) {
                        console.error(`è¨ˆç®—é–€å¸‚ ${store.name} ç‡Ÿæ¥­é¡å¤±æ•—:`, error);
                    }
                }

                // æ¸²æŸ“çµ±è¨ˆè¡¨æ ¼
                renderSalesStatisticsTable(storesSalesData, totalAllStoresRevenue, totalAllStoresCheckoutRevenue);

            } catch (error) {
                console.error('è¨ˆç®—é–€å¸‚ç‡Ÿæ¥­é¡çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // âœ… æ–°å¢å‡½æ•¸ï¼šæ¸²æŸ“ç‡Ÿæ¥­é¡çµ±è¨ˆè¡¨æ ¼
        function renderSalesStatisticsTable(storesSalesData, totalRevenue, totalCheckoutRevenue) {
            // å°‹æ‰¾æˆ–å»ºç«‹çµ±è¨ˆå®¹å™¨
            let statsContainer = document.getElementById('stores-sales-statistics');

            if (!statsContainer) {
                // åœ¨é–€å¸‚é¸æ“‡å€ä¸Šæ–¹æ’å…¥çµ±è¨ˆå®¹å™¨
                const storeSelectionPage = document.getElementById('store-selection-page');
                if (!storeSelectionPage) return;

                statsContainer = document.createElement('div');
                statsContainer.id = 'stores-sales-statistics';
                statsContainer.className = 'bg-gray-800 rounded-xl shadow-lg p-6 mb-8';
                storeSelectionPage.insertBefore(statsContainer, storeSelectionPage.firstChild);
            }

            // å»ºç«‹çµ±è¨ˆ HTML - æ–°å¢æ”¶åˆåŠŸèƒ½
            let html = `
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <span class="text-green-400 mr-2">ğŸ“Š</span> === ç¸½ç‡Ÿæ¥­é¡çµ±è¨ˆï¼ˆå…¨éƒ¨æœŸé–“ç´¯ç©ï¼‰===
                    </h2>
                    <button id="toggle-stats-table" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors">
                        <span id="toggle-stats-icon">ğŸ“Š</span> æ”¶åˆçµ±è¨ˆ
                    </button>
                </div>

                <div id="stats-table-container" class="transition-all duration-300">
                    <div class="mb-4 flex gap-4 flex-wrap">
                        <button class="sales-view-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors active" data-view="total">
                            é¡¯ç¤ºç¸½ç‡Ÿæ¥­é¡
                        </button>
                        <button class="sales-view-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors" data-view="pending">
                            é¡¯ç¤ºå¾…çµå¸³ç‡Ÿæ¥­é¡
                        </button>
                    </div>

                    <!-- èªªæ˜æç¤º -->
                    <div class="mb-4 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                        <span class="font-semibold">ğŸ’¡ æç¤ºï¼š</span>æ­¤è™•é¡¯ç¤ºçš„æ˜¯å¾æ©Ÿå°è¨­ç½®é–‹å§‹è‡³ä»Šçš„<strong>ç´¯ç©ç¸½ç‡Ÿæ¥­é¡</strong>ã€‚è‹¥è¦æŸ¥çœ‹ç‰¹å®šæ™‚é–“æ®µçš„ç‡Ÿæ¥­é¡ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œæ¯å‘¨ç‡Ÿæ¥­é¡è¶¨å‹¢åˆ†æã€æˆ–ã€Œå¤šé–€å¸‚å‘¨å ±æ¯”è¼ƒã€åŠŸèƒ½ã€‚
                    </div>

                    <!-- é›™æ‘˜è¦é¡¯ç¤º -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/30 p-4 rounded-lg font-bold text-white">
                            <div class="text-sm text-gray-400 mb-1">ğŸ’° ç¸½ç‡Ÿæ¥­é¡ï¼ˆç´¯ç©ï¼‰</div>
                            <div class="text-2xl text-green-300"><span class="total-summary-total">${totalRevenue.toLocaleString()}</span> å…ƒ</div>
                        </div>
                        <div class="bg-yellow-900/30 p-4 rounded-lg font-bold text-white">
                            <div class="text-sm text-gray-400 mb-1">â³ å¾…çµå¸³ç‡Ÿæ¥­é¡</div>
                            <div class="text-2xl text-yellow-300"><span class="total-summary-pending">${totalCheckoutRevenue.toLocaleString()}</span> å…ƒ</div>
                        </div>
                    </div>

                    <!-- è©³ç´°è¡¨æ ¼ï¼ˆå¯æ”¶åˆï¼‰ -->
                    <div id="detailed-stats-table" class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-300 bg-gray-900/50 rounded-lg overflow-hidden">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left font-semibold">é …ç›®</th>
                                    <th class="px-4 py-2 text-right font-semibold sales-total-col">é‡‘é¡ï¼ˆç¸½è¨ˆï¼‰</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
            `;

            // æŒ‰ç‡Ÿæ¥­é¡æ’åºï¼ˆé™åºï¼‰
            const sortedData = [...storesSalesData].sort((a, b) => b.totalRevenue - a.totalRevenue);

            // æ–°å¢æ¯é–“é–€å¸‚çš„è³‡æ–™åˆ—
            sortedData.forEach(store => {
                const displayRevenue = store.totalRevenue.toLocaleString();
                const displayCheckoutRevenue = store.checkoutRevenue.toLocaleString();

                html += `
                <tr class="hover:bg-gray-800/50 transition-colors sales-row" data-total-revenue="${store.totalRevenue}" data-checkout-revenue="${store.checkoutRevenue}">
                    <td class="px-4 py-3 font-medium text-white">${store.storeName}</td>
                    <td class="px-4 py-3 text-right font-semibold text-green-400 sales-revenue">
                        ${displayRevenue}
                    </td>
                </tr>
                `;
            });

            // æ–°å¢ç¸½è¨ˆåˆ—
            const totalDisplayRevenue = totalRevenue.toLocaleString();
            const totalDisplayCheckout = totalCheckoutRevenue.toLocaleString();

            html += `
                <tr class="bg-blue-900/30 font-bold text-white sales-total-row">
                    <td class="px-4 py-3">æ‰€æœ‰é–€å¸‚ç¸½ç‡Ÿæ¥­é¡</td>
                    <td class="px-4 py-3 text-right text-blue-300 sales-total-revenue">
                        ${totalDisplayRevenue}
                    </td>
                </tr>
            `;

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 p-4 bg-gray-900/50 rounded-lg">
                        <p class="text-sm text-gray-400">
                            <span class="text-green-400 font-semibold">ğŸ’¡ èªªæ˜ï¼š</span>
                            ã€Œç¸½ç‡Ÿæ¥­é¡ã€= æ‰€æœ‰æ©Ÿå°ç´¯ç©æŠ•å¹£æ•¸ Ã— 10å…ƒï¼›ã€Œå¾…çµå¸³ç‡Ÿæ¥­é¡ã€= ä¸Šæ¬¡çµå¸³å¾Œçš„æ–°å¢ç‡Ÿæ¥­é¡
                        </p>
                    </div>
                </div>
            </div>
            `;

            statsContainer.innerHTML = html;

            // ç¶å®šæ”¶åˆæŒ‰éˆ•äº‹ä»¶
            const toggleBtn = document.getElementById('toggle-stats-table');
            const tableContainer = document.getElementById('detailed-stats-table');
            const icon = document.getElementById('toggle-stats-icon');
            
            let isCollapsed = localStorage.getItem('statsTableCollapsed') === 'true';
            
            function updateToggleState() {
                if (isCollapsed) {
                    tableContainer.style.display = 'none';
                    toggleBtn.innerHTML = '<span id="toggle-stats-icon">ğŸ“ˆ</span> å±•é–‹çµ±è¨ˆ';
                    toggleBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors';
                } else {
                    tableContainer.style.display = 'block';
                    toggleBtn.innerHTML = '<span id="toggle-stats-icon">ğŸ“Š</span> æ”¶åˆçµ±è¨ˆ';
                    toggleBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors';
                }
            }
            
            updateToggleState();
            
            toggleBtn.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                localStorage.setItem('statsTableCollapsed', isCollapsed);
                updateToggleState();
            });

            // ç¶å®šæª¢è¦–åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.sales-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–æŒ‰éˆ•çš„ active ç‹€æ…‹
                    document.querySelectorAll('.sales-view-btn').forEach(b => b.classList.remove('active', 'bg-blue-700'));
                    this.classList.add('active', 'bg-blue-700');

                    const viewType = this.dataset.view;
                    const isTotal = viewType === 'total';

                    // æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
                    const headerCell = document.querySelector('.sales-total-col');
                    if (headerCell) {
                        headerCell.textContent = isTotal ? 'é‡‘é¡ï¼ˆç¸½è¨ˆï¼‰' : 'é‡‘é¡ï¼ˆå¾…çµå¸³ï¼‰';
                    }

                    // æ›´æ–°æ¯è¡Œè³‡æ–™
                    document.querySelectorAll('.sales-row').forEach((row, index) => {
                        const revenue = row.dataset[isTotal ? 'totalRevenue' : 'checkoutRevenue'];
                        const displayRevenue = parseFloat(revenue).toLocaleString();
                        const revenueCell = row.querySelector('.sales-revenue');
                        if (revenueCell) {
                            revenueCell.textContent = displayRevenue;
                        }
                    });

                    // æ›´æ–°ç¸½è¨ˆåˆ—
                    const totalRow = document.querySelector('.sales-total-row');
                    if (totalRow) {
                        const totalRevenue = document.querySelectorAll('.sales-row').reduce((sum, row) => {
                            return sum + parseFloat(row.dataset[isTotal ? 'totalRevenue' : 'checkoutRevenue']);
                        }, 0);
                        const totalCell = totalRow.querySelector('.sales-total-revenue');
                        if (totalCell) {
                            totalCell.textContent = totalRevenue.toLocaleString();
                        }
                    }
                    
                    // æ›´æ–°é›™æ‘˜è¦é¡¯ç¤º
                    if (isTotal) {
                        const totalSum = document.querySelectorAll('.sales-row').reduce((sum, row) => {
                            return sum + parseFloat(row.dataset.totalRevenue);
                        }, 0);
                        const totalCell = document.querySelector('.total-summary-total');
                        if (totalCell) totalCell.textContent = totalSum.toLocaleString();
                    } else {
                        const pendingSum = document.querySelectorAll('.sales-row').reduce((sum, row) => {
                            return sum + parseFloat(row.dataset.checkoutRevenue);
                        }, 0);
                        const pendingCell = document.querySelector('.total-summary-pending');
                        if (pendingCell) pendingCell.textContent = pendingSum.toLocaleString();
                    }
                });
            });

            console.log('âœ… é–€å¸‚ç‡Ÿæ¥­é¡çµ±è¨ˆå·²æ¸²æŸ“ï¼ˆæ”¯æ´æ”¶åˆåŠŸèƒ½ï¼‰');
        }

        async function showReportPage(storeId, storeName, startDate) {
            console.log(`ğŸ“ showReportPage è¢«å‘¼å«: ${storeId}/${storeName}`);
            selectedStoreId = storeId;
            selectedStoreName = storeName;
            appData.startDate = startDate;
            
            // ğŸš€ åˆ‡æ›é–€å¸‚æ™‚æ¸…ç†è‡ªå‹•è¼ªè©¢è¨ˆæ™‚å™¨
            clearAutoPollTimer();
            
            // ğŸ”§ åˆ‡æ›é–€å¸‚æ™‚,ä¿ç•™ window.dailyRecords ä¸æ¸…ç©º
            // é€™æ¨£å¯ä»¥ä¿ç•™ã€Œç«‹å³è®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™ã€åŠŸèƒ½æ”¶é›†çš„è¨˜éŒ„
            // refreshAutoRecordTable() æœƒè‡ªå‹•éæ¿¾åªé¡¯ç¤ºç•¶å‰é–€å¸‚çš„è¨˜éŒ„
            console.log('ï¿½ åˆ‡æ›é–€å¸‚ï¼Œä¿ç•™ HTTP è¼ªè©¢è¨˜éŒ„ (å…± ' + Object.keys(window.dailyRecords || {}).length + ' ç­†)');
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
            
            document.getElementById('report-title-main').textContent = `${selectedStoreName} - ç‡Ÿæ¥­å ±å‘Š`;
            document.getElementById('report-period').textContent = `çµ±è¨ˆæœŸé–“ï¼š${startDate} ï½ ç¾åœ¨`;
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            // æª¢æŸ¥ç”¨æˆ¶é é¢æ¬Šé™ä¸¦éš±è—/é¡¯ç¤ºç›¸æ‡‰çš„æ¨™ç±¤é 
            applyPagePermissions();
            
            appData.machines = [];
            appData.history = [];
            
            // é¸æ“‡ç¬¬ä¸€å€‹å¯è¦‹çš„æ¨™ç±¤é 
            const firstVisibleTab = document.querySelector('.tab-btn:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.click();
            } else {
                document.querySelector('.tab-btn[data-tab="details"]').click(); // é»˜èªå›é€€
            }
            
            await updateUI(); 
            console.log('ğŸ“ æº–å‚™å‘¼å« loadStoreData()...');
            await loadStoreData();
        }

        // æ‡‰ç”¨é é¢æ¬Šé™
        function applyPagePermissions() {
            const userType = localStorage.getItem('userType');
            console.log('æ‡‰ç”¨é é¢æ¬Šé™ï¼Œç”¨æˆ¶é¡å‹:', userType);
            
            if (userType === 'admin') {
                // ç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™
                console.log('ç®¡ç†å“¡ç”¨æˆ¶ï¼Œé¡¯ç¤ºæ‰€æœ‰åŠŸèƒ½');
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.style.display = 'block';
                });
                document.getElementById('header-download-buttons').style.display = 'flex';
                return;
            }
            
            // è¨ªå®¢ç”¨æˆ¶ï¼Œæª¢æŸ¥é é¢æ¬Šé™
            const currentUser = localStorage.getItem('currentUser');
            const userPagePermissions = JSON.parse(localStorage.getItem('userPagePermissions') || '[]');
            console.log('è¨ªå®¢ç”¨æˆ¶é é¢æ¬Šé™:', userPagePermissions);
            
            // æ¨™ç±¤é æ¬Šé™æ˜ å°„
            const tabPermissionMap = {
                'details': 'details',
                'summary': 'summary', 
                'analysis': 'analysis',
                'charts': 'charts',
                'statistics': 'statistics',
                'accounting': 'accounting',
                'machines': 'machines',
                'profit': 'profit',
                'checkout': 'checkout'
            };
            
            // éš±è—/é¡¯ç¤ºæ¨™ç±¤é 
            document.querySelectorAll('.tab-btn').forEach(tab => {
                const tabName = tab.dataset.tab;
                const requiredPermission = tabPermissionMap[tabName];
                
                if (requiredPermission && userPagePermissions.includes(requiredPermission)) {
                    tab.style.display = 'block';
                    console.log(`é¡¯ç¤ºæ¨™ç±¤é : ${tabName}`);
                } else {
                    tab.style.display = 'none';
                    console.log(`éš±è—æ¨™ç±¤é : ${tabName}`);
                }
            });
            
            // ä¸‹è¼‰æŒ‰éˆ•æ¬Šé™
            if (userPagePermissions.includes('download')) {
                document.getElementById('header-download-buttons').style.display = 'flex';
                console.log('é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•');
            } else {
                document.getElementById('header-download-buttons').style.display = 'none';
                console.log('éš±è—ä¸‹è¼‰æŒ‰éˆ•');
            }
            
            // ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•æ¬Šé™
            const hasEditPermission = userPagePermissions.includes('edit');
            console.log('ç·¨è¼¯æ¬Šé™:', hasEditPermission);
            
            if (!hasEditPermission) {
                // éš±è—æ‰€æœ‰ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
                setTimeout(() => {
                    const style = document.createElement('style');
                    style.id = 'guest-permissions-style';
                    style.textContent = `
                        .edit-machine-btn, .delete-machine-btn, 
                        .edit-history-btn, .delete-history-btn,
                        .edit-store-btn, .clone-store-btn, .delete-store-btn,
                        .rename-group-btn, .delete-group-btn {
                            display: none !important;
                        }
                    `;
                    // ç§»é™¤ä¹‹å‰çš„æ¨£å¼å†æ·»åŠ æ–°çš„
                    const existingStyle = document.getElementById('guest-permissions-style');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    document.head.appendChild(style);
                    console.log('å·²éš±è—ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•');
                }, 100);
            }
        }

        // --- DATA PROCESSING & CALCULATION ---
        
        function processMachineData(machine) {
            // ğŸ”§ é›™é‡ä¿éšªï¼šç¢ºä¿æ‰€æœ‰æ•¸å€¼éƒ½æ˜¯æ•´æ•¸
            const plays = Math.round(Number(machine.plays) || 0);
            const payouts = Math.round(Number(machine.payouts) || 0);
            const initialPlays = Math.round(Number(machine.initialPlays) || 0);
            const initialPayouts = Math.round(Number(machine.initialPayouts) || 0);
            
            // âœ… è¨ˆç®—æœ‰æ•ˆå€¼ï¼ˆæ‡‰è©²éƒ½æ˜¯æ•´æ•¸ï¼‰
            const effectivePlays = plays - initialPlays;
            const effectivePayouts = payouts - initialPayouts;
            
            // âœ… æŠ•å¹£é‡‘é¡ = æŠ•å¹£æ¬¡æ•¸ Ã— 10ï¼ˆæ‡‰è©²æ°¸é æ˜¯æ•´æ•¸ä¸”æ˜¯10çš„å€æ•¸ï¼‰
            const revenue = effectivePlays * COIN_VALUE;
            
            // âœ… é©—è­‰æŠ•å¹£é‡‘é¡æ˜¯å¦ç‚º10çš„å€æ•¸ï¼ˆèª¿è©¦ç”¨ï¼‰
            if (revenue > 0 && revenue % 10 !== 0) {
                console.warn(`âš ï¸ è­¦å‘Šï¼šæ©Ÿå° ${machine.id} çš„æŠ•å¹£é‡‘é¡ ${revenue} ä¸æ˜¯10çš„å€æ•¸ï¼`);
                console.warn(`   åŸå› : effectivePlays=${effectivePlays}, plays=${plays}, initialPlays=${initialPlays}`);
            }
            
            // âœ… å¹³å‡å‡ºè²¨æˆæœ¬ï¼ˆå¯èƒ½æ˜¯å°æ•¸ï¼‰
            const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
            
            // ğŸ”§ ä¸å†æ¨™è¨˜ç•°å¸¸ï¼ˆå› ç‚ºæ‰€æœ‰æ•¸æ“šéƒ½å·²æ¸…æ½”åŒ–ç‚ºæ•´æ•¸ï¼‰
            const isAbnormal = false;
            
            return { 
                ...machine, 
                plays,
                payouts,
                initialPlays,
                initialPayouts,
                effectivePlays, 
                effectivePayouts, 
                revenue,  // âœ… æŠ•å¹£é‡‘é¡ - æ°¸é æ˜¯æ•´æ•¸ä¸”æ˜¯10çš„å€æ•¸
                cost,     // æˆæœ¬ - å¯èƒ½æ˜¯å°æ•¸
                isAbnormalCost: isAbnormal
            };
        }
        
        // âœ… æ–°å¢ï¼šé¡¯ç¤ºæˆæœ¬æ™‚è‡ªå‹•å››æ¨äº”å…¥åˆ°æ•´æ•¸
        function formatCost(cost) {
            if (typeof cost !== 'number' || isNaN(cost)) {
                return '0';
            }
            // å››æ¨äº”å…¥åˆ°æ•´æ•¸
            return Math.round(cost).toString();
        }
        
        // âœ… æ–°å¢ï¼šè¨ºæ–·å‡½æ•¸ - æª¢æŸ¥ç•°å¸¸æˆæœ¬
        function diagnoseAbnormalCosts(machines) {
            const abnormal = machines.filter(m => m.isAbnormalCost);
            
            if (abnormal.length > 0) {
                console.warn('âš ï¸ åµæ¸¬åˆ°ç•°å¸¸æˆæœ¬çš„æ©Ÿå°ï¼ˆå¯èƒ½å·²çµéå¸³å‹™ï¼‰:');
                abnormal.forEach(m => {
                    console.warn(`   - ${m.id} (${m.location}): æˆæœ¬=${formatCost(m.cost)}, åˆå§‹å‡ºè²¨=${m.initialPayouts}`);
                    console.warn(`     å»ºè­°: æª¢æŸ¥æœ€å¾Œä¸€æ¬¡çµå¸³ç´€éŒ„ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•èª¿æ•´åˆå§‹å€¼`);
                });
            }
            
            return abnormal;
        }
        
        // --- DATA FUNCTIONS (Multi-group Version) ---
        
        async function loadGroups() {
            try {
                const groupSnapshot = await db.collection('groups').orderBy('createdAt', 'desc').get();
                let groups = groupSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // å¦‚æœæ˜¯è¨ªå®¢ç”¨æˆ¶ï¼Œéæ¿¾åªé¡¯ç¤ºæœ‰æ¬Šé™çš„ç¾¤çµ„
                const userType = localStorage.getItem('userType');
                if (userType === 'guest') {
                    const allowedGroups = JSON.parse(localStorage.getItem('allowedGroups') || '[]');
                    groups = groups.filter(group => allowedGroups.includes(group.id));
                }
                
                renderGroups(groups);
            } catch (error) {
                console.error("è®€å–å–®ä½ç¾¤çµ„å¤±æ•—:", error);
                groupListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">ç„¡æ³•è®€å–ç¾¤çµ„åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚</p>';
            }
        }
        
        async function handleCreateGroup(e) {
            e.preventDefault();
            const newGroupNameInput = document.getElementById('new-group-name');
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) return alert('ç¾¤çµ„åç¨±ä¸å¯ç©ºç™½ï¼');
            
            try {
                await db.collection('groups').add({
                    name: groupName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newGroupNameInput.value = '';
                loadGroups();
            } catch (error) {
                console.error("å»ºç«‹ç¾¤çµ„å¤±æ•—:", error);
                alert('å»ºç«‹ç¾¤çµ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleRenameGroup(groupId, currentName) {
            const newName = prompt('è«‹è¼¸å…¥æ–°çš„å–®ä½ç¾¤çµ„åç¨±ï¼š', currentName);
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                try {
                    await db.collection('groups').doc(groupId).update({ name: newName.trim() });
                    loadGroups();
                } catch(error) {
                    console.error('æ›´æ–°ç¾¤çµ„åç¨±å¤±æ•—:', error);
                    alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }
        }

        async function handleDeleteGroup(groupId, groupName) {
            const message = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${groupName}ã€å–®ä½ç¾¤çµ„å—ï¼Ÿ\n\nè­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒæ°¸ä¹…åˆªé™¤è©²ç¾¤çµ„åº•ä¸‹çš„ã€æ‰€æœ‰é–€å¸‚ã€‘åŠå…¶æ‰€æœ‰æ©Ÿå°èˆ‡è¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
            showConfirmationModal(message, async () => {
                console.log(`é–‹å§‹åˆªé™¤å–®ä½ç¾¤çµ„: ${groupId}`);
                try {
                    const groupRef = db.collection('groups').doc(groupId);
                    
                    const storesSnapshot = await groupRef.collection('stores').get();
                    for (const storeDoc of storesSnapshot.docs) {
                        const storeRef = storeDoc.ref;
                        
                        const machinesSnapshot = await storeRef.collection('machines').get();
                        if (!machinesSnapshot.empty) {
                            const machineBatch = db.batch();
                            machinesSnapshot.docs.forEach(doc => machineBatch.delete(doc.ref));
                            await machineBatch.commit();
                        }

                        const historySnapshot = await storeRef.collection('history').get();
                         if (!historySnapshot.empty) {
                            const historyBatch = db.batch();
                            historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                            await historyBatch.commit();
                        }

                        await storeRef.delete();
                    }

                    await groupRef.delete();

                    console.log(`å–®ä½ç¾¤çµ„ ${groupId} å·²æˆåŠŸåˆªé™¤ã€‚`);
                    hideConfirmationModal();
                    loadGroups();

                } catch(error) {
                    console.error('åˆªé™¤å–®ä½ç¾¤çµ„å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }


        async function loadStores() {
            if(!selectedGroupId) return;
            try {
                const storeSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').orderBy('createdAt', 'desc').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStores(stores);
            } catch (error) {
                console.error("è®€å–é–€å¸‚åˆ—è¡¨å¤±æ•—:", error);
                storeListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">ç„¡æ³•è®€å–é–€å¸‚åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚</p>';
            }
        }
        
        async function loadStoreData() {
            if (!selectedGroupId || !selectedStoreId) return;
            console.log(`æ­£åœ¨è®€å–ç¾¤çµ„[${selectedGroupId}] -> é–€å¸‚ [${selectedStoreId}] çš„è³‡æ–™...`);
            const machinesCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines');
            const historyCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').orderBy('date', 'desc');
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        docId: doc.id,
                        // âœ… ç¢ºä¿ devid å’Œ devidData æ­£ç¢ºè®€å–
                        devid: data.devid || 1,
                        devidData: data.devidData || {},
                        mac: data.mac || '',
                        // ğŸ”§ å¼·åˆ¶æ‰€æœ‰æŠ•å¹£/å‡ºè²¨æ•¸å€¼ç‚ºæ•´æ•¸ï¼ˆå››æ¨äº”å…¥ï¼‰
                        plays: Math.round(Number(data.plays) || 0),
                        payouts: Math.round(Number(data.payouts) || 0),
                        initialPlays: Math.round(Number(data.initialPlays) || 0),
                        initialPayouts: Math.round(Number(data.initialPayouts) || 0),
                        playsCalibration: Math.round(Number(data.playsCalibration) || 0),
                        payoutsCalibration: Math.round(Number(data.payoutsCalibration) || 0)
                    };
                });
                
                const history = historySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        docId: doc.id,
                        // ğŸ”§ å¼·åˆ¶æ­·å²è¨˜éŒ„ä¸­æ‰€æœ‰æ•¸å€¼ç‚ºæ•´æ•¸
                        newPlays: Math.round(Number(data.newPlays) || 0),
                        newPayouts: Math.round(Number(data.newPayouts) || 0),
                        totalRevenue: Math.round(Number(data.totalRevenue) || 0),
                        totalPayouts: Math.round(Number(data.totalPayouts) || 0)
                    };
                });

                appData.machines = machines;
                appData.history = history;
                
                console.log("âœ… è³‡æ–™è®€å–æˆåŠŸï¼ˆå·²æ¸…æ½”åŒ–æ‰€æœ‰æ•¸å€¼ç‚ºæ•´æ•¸ï¼‰!", appData);
                await updateUI();
                
                // ğŸš€ é–€å¸‚è¼‰å…¥å®Œæˆå¾Œï¼Œæª¢æŸ¥ä¸¦è§¸ç™¼è‡ªå‹•è¼ªè©¢
                console.log('ğŸ“ loadStoreData å®Œæˆï¼Œæº–å‚™è§¸ç™¼è‡ªå‹•è¼ªè©¢æª¢æŸ¥...');
                console.log(`   æ©Ÿå°æ•¸é‡: ${appData?.machines?.length || 0}`);

                if (suppressNextAutoPoll) {
                    console.log('â¸ï¸ ç•¥éæœ¬æ¬¡è‡ªå‹•è¼ªè©¢ï¼ˆsuppressNextAutoPoll å·²å•Ÿç”¨ï¼‰');
                    suppressNextAutoPoll = false;
                } else {
                    triggerAutoPollOnLoad();
                }

            } catch (error) {
                console.error(`è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                showFeedback("ç„¡æ³•å¾é›²ç«¯è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
            }
        }

        async function handleCreateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('æœªé¸æ“‡å–®ä½ç¾¤çµ„');

            const newStoreNameInput = document.getElementById('new-store-name');
            const newStoreStartDateInput = document.getElementById('new-store-start-date');
            const storeName = newStoreNameInput.value.trim();
            const startDate = newStoreStartDateInput.value;

            if (!storeName || !startDate) return alert('é–€å¸‚åç¨±èˆ‡èµ·å§‹æ—¥ä¸å¯ç©ºç™½ï¼');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: storeName,
                    startDate: startDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                createStoreForm.reset();
                newStoreStartDateInput.valueAsDate = new Date();
                loadStores(); 
            } catch (error) {
                console.error("å»ºç«‹é–€å¸‚å¤±æ•—:", error);
                alert('å»ºç«‹é–€å¸‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }
        
        async function handleCloneStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('æœªé¸æ“‡å–®ä½ç¾¤çµ„');

            const sourceStoreId = document.getElementById('clone-source-store-id').value;
            const sourceStoreName = document.getElementById('clone-source-store-name').textContent;
            const newStoreName = document.getElementById('clone-store-name').value.trim();
            const newStartDate = document.getElementById('clone-store-start-date').value;

            if (!newStoreName || !newStartDate) return alert('é–€å¸‚åç¨±èˆ‡èµ·å§‹æ—¥ä¸å¯ç©ºç™½ï¼');
            
            if (!sourceStoreId) return alert('æœªæŒ‡å®šä¾†æºé–€å¸‚ï¼');

            // ç¢ºèªå°è©±æ¡†
            const confirmMessage = `ç¢ºå®šè¦è¤‡è£½é–€å¸‚å—ï¼Ÿ\n\nä¾†æºé–€å¸‚ï¼š${sourceStoreName}\næ–°é–€å¸‚åç¨±ï¼š${newStoreName}\nèµ·å§‹æ—¥æœŸï¼š${newStartDate}\n\næ³¨æ„ï¼š\nâ€¢ å°‡è¤‡è£½æ©Ÿå°é…ç½®å’Œè¨­å®š\nâ€¢ æ‰€æœ‰å¸³å‹™è¨˜éŒ„å°‡è¢«æ¸…é™¤\nâ€¢ æ©Ÿå°æ•¸æ“šå°‡é‡ç½®ç‚º 0`;
            
            if (!confirm(confirmMessage)) return;

            // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¤‡è£½ä¸­...';

            try {
                console.log('ğŸ”„ é–‹å§‹è¤‡è£½é–€å¸‚...');
                
                // æ­¥é©Ÿ 1ï¼šå‰µå»ºæ–°é–€å¸‚
                const newStoreRef = await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: newStoreName,
                    startDate: newStartDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    clonedFrom: sourceStoreId,
                    clonedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… æ–°é–€å¸‚å·²å‰µå»º:', newStoreRef.id);
                
                // æ­¥é©Ÿ 2ï¼šè¤‡è£½æ©Ÿå°é…ç½®ï¼ˆä½†ä¸è¤‡è£½å¸³å‹™æ•¸æ“šï¼‰
                const sourceStoreRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(sourceStoreId);
                const machinesSnapshot = await sourceStoreRef.collection('machines').get();
                
                if (!machinesSnapshot.empty) {
                    console.log(`ğŸ“¦ æ‰¾åˆ° ${machinesSnapshot.size} å°æ©Ÿå°ï¼Œé–‹å§‹è¤‡è£½é…ç½®...`);
                    
                    const batch = db.batch();
                    machinesSnapshot.docs.forEach(machineDoc => {
                        const originalMachine = machineDoc.data();
                        
                        // è¤‡è£½æ©Ÿå°é…ç½®ï¼Œä½†é‡ç½®æ•¸æ“šç‚º 0
                        const newMachineData = {
                            id: originalMachine.id,
                            location: originalMachine.location,
                            mac: originalMachine.mac || '',
                            devid: originalMachine.devid || null,
                            initialPlays: 0, // é‡ç½®ç‚º 0
                            initialPayouts: 0, // é‡ç½®ç‚º 0
                            playsCalibration: 0, // é‡ç½®æ ¡æ­£å€¼
                            payoutsCalibration: 0, // é‡ç½®æ ¡æ­£å€¼
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            clonedFrom: machineDoc.id,
                            clonedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        const newMachineRef = newStoreRef.collection('machines').doc();
                        batch.set(newMachineRef, newMachineData);
                    });
                    
                    await batch.commit();
                    console.log('âœ… æ©Ÿå°é…ç½®è¤‡è£½å®Œæˆ');
                } else {
                    console.log('â„¹ï¸ ä¾†æºé–€å¸‚æ²’æœ‰æ©Ÿå°é…ç½®');
                }
                
                // æ­¥é©Ÿ 3ï¼šé—œé–‰ Modal ä¸¦åˆ·æ–°åˆ—è¡¨
                cloneStoreModal.classList.add('hidden');
                cloneStoreForm.reset();
                loadStores();
                
                alert(`é–€å¸‚è¤‡è£½æˆåŠŸï¼\n\næ–°é–€å¸‚ã€Œ${newStoreName}ã€å·²å‰µå»ºï¼Œæ©Ÿå°é…ç½®å·²è¤‡è£½ä½†å¸³å‹™æ•¸æ“šå·²æ¸…é™¤ã€‚`);
                
            } catch (error) {
                console.error("è¤‡è£½é–€å¸‚å¤±æ•—:", error);
                alert('è¤‡è£½é–€å¸‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function handleUpdateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return;

            const storeId = document.getElementById('edit-store-id').value;
            const newName = document.getElementById('edit-store-name').value.trim();
            const newStartDate = document.getElementById('edit-store-start-date').value;

            if (!newName || !newStartDate) return alert('é–€å¸‚åç¨±èˆ‡èµ·å§‹æ—¥ä¸å¯ç©ºç™½ï¼');

            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).update({
                    name: newName,
                    startDate: newStartDate
                });
                editStoreModal.classList.add('hidden');
                loadStores();
            } catch(error) {
                console.error('æ›´æ–°é–€å¸‚è³‡è¨Šå¤±æ•—:', error);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        
        async function handleDeleteStore(storeId, storeName) {
            if(!selectedGroupId) return;
            const message = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${storeName}ã€å—ï¼Ÿ\n\nè­¦å‘Šï¼šæ­¤æ“ä½œå°‡æœƒæ°¸ä¹…åˆªé™¤è©²é–€å¸‚åŠå…¶åº•ä¸‹çš„æ‰€æœ‰æ©Ÿå°èˆ‡è¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
            showConfirmationModal(message, async () => {
                try {
                    const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                    
                    const machinesSnapshot = await storeRef.collection('machines').get();
                    if(!machinesSnapshot.empty){
                        const batch1 = db.batch();
                        machinesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                        await batch1.commit();
                    }

                    const historySnapshot = await storeRef.collection('history').get();
                     if(!historySnapshot.empty){
                        const batch2 = db.batch();
                        historySnapshot.docs.forEach(doc => batch2.delete(doc.ref));
                        await batch2.commit();
                    }

                    await storeRef.delete();
                    hideConfirmationModal();
                    loadStores();

                } catch(error) {
                    console.error('åˆªé™¤é–€å¸‚å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        async function handleAddMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return alert('æ²’æœ‰é¸æ“‡æœ‰æ•ˆçš„é–€å¸‚ã€‚');

            const idInput = document.getElementById('new-machine-id');
            const locationInput = document.getElementById('new-machine-location');
            const initialPlaysInput = document.getElementById('new-machine-initial-plays');
            const initialPayoutsInput = document.getElementById('new-machine-initial-payouts');
            const macInput = document.getElementById('new-machine-mac');
            const devidInput = document.getElementById('new-machine-devid');

            const machineId = idInput.value.trim();
            const machineLocation = locationInput.value.trim();
            const initialPlays = parseInt(initialPlaysInput.value, 10) || 0;
            const initialPayouts = parseInt(initialPayoutsInput.value, 10) || 0;
            const macAddress = macInput.value.trim();
            const deviceId = parseInt(devidInput.value, 10) || null;


            if (!machineId || !machineLocation) return alert('æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®ä¸èƒ½ç‚ºç©ºï¼');
            
            try {
                // âœ… æ§‹å»ºæ©Ÿå°è³‡æ–™ï¼ŒåŒ…å« devidData çµæ§‹
                const machineData = {
                    id: machineId,
                    location: machineLocation,
                    plays: initialPlays, // ç¸½è¡¨æ•¸å¾èµ·å§‹å€¼é–‹å§‹
                    payouts: initialPayouts, // ç¸½è¡¨æ•¸å¾èµ·å§‹å€¼é–‹å§‹
                    initialPlays: initialPlays,
                    initialPayouts: initialPayouts,
                    // MQTT ç›¸é—œæ¬„ä½
                    mac: macAddress,
                    devid: deviceId || 1,
                    mqttLastCoinCount: 0,
                    mqttLastPayoutCount: 0,
                };
                
                // âœ… å¦‚æœæœ‰ MAC å’Œè¨­å‚™IDï¼Œå»ºç«‹ devidData çµæ§‹
                if (macAddress && deviceId) {
                    machineData.devidData = {
                        [deviceId.toString()]: macAddress
                    };
                }
                
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').add(machineData);
                
                console.log('âœ… æ–°å¢æ©Ÿå°:', machineData);
                addMachineForm.reset();
                
                // ğŸ“Š é‡æ–°è¼‰å…¥è³‡æ–™ä¸¦å¼·åˆ¶é‡å»ºæ˜ å°„è¡¨
                await loadStoreData();
                console.log('âœ… æ©Ÿå°æ–°å¢å®Œæˆï¼Œé‡å»ºæ˜ å°„è¡¨');
                window.machineConfigMap = null; // å¼·åˆ¶é‡å»º
                buildMachineConfigMap();
                
            } catch(error) {
                console.error("æ–°å¢æ©Ÿå°å¤±æ•—ï¼š", error);
                alert('æ–°å¢æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        async function handleDeleteMachine(docId) {
            if(!selectedStoreId || !selectedGroupId || !docId) return;
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å°æ©Ÿå™¨å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', async () => {
                try {
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).delete();
                    hideConfirmationModal();
                    
                    // ğŸ“Š é‡æ–°è¼‰å…¥è³‡æ–™ä¸¦å¼·åˆ¶é‡å»ºæ˜ å°„è¡¨
                    await loadStoreData();
                    console.log('âœ… æ©Ÿå°åˆªé™¤å®Œæˆï¼Œé‡å»ºæ˜ å°„è¡¨');
                    window.machineConfigMap = null; // å¼·åˆ¶é‡å»º
                    buildMachineConfigMap();
                    
                } catch (error) {
                    console.error("åˆªé™¤æ©Ÿå°å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤æ©Ÿå°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }

        // è¨ˆç®—ä¸¦æ›´æ–°ç•¶å‰æ©Ÿå°çµ±è¨ˆæ•¸æ“š
        async function updateCurrentMachineStats(docId) {
            try {
                console.log('ğŸ” é–‹å§‹è¨ˆç®—æ©Ÿå°çµ±è¨ˆæ•¸æ“šï¼ŒdocId:', docId);
                
                // é‡ç½®é¡¯ç¤º
                document.getElementById('edit-current-plays').textContent = '--';
                document.getElementById('edit-current-payouts').textContent = '--';
                document.getElementById('edit-current-cost').textContent = '--';
                
                // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°è³‡æ–™
                const machine = appData.machines.find(m => m.docId === docId);
                if (!machine) {
                    console.error('æ‰¾ä¸åˆ°æ©Ÿå°è³‡æ–™');
                    return;
                }
                
                // è¨ˆç®—æœ‰æ•ˆæŠ•å¹£å’Œå‡ºè²¨æ•¸ï¼ˆå«æ ¡æ­£å€¼ï¼‰
                const effectivePlays = (machine.totalPlays || 0) + (machine.playsCalibration || 0);
                const effectivePayouts = (machine.totalPayouts || 0) + (machine.payoutsCalibration || 0);
                const revenue = effectivePlays * COIN_VALUE;
                const avgCost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('edit-current-plays').textContent = effectivePlays.toLocaleString();
                document.getElementById('edit-current-payouts').textContent = effectivePayouts.toLocaleString();
                document.getElementById('edit-current-cost').textContent = effectivePayouts > 0 ? `${Math.round(avgCost)} å…ƒ` : '-- å…ƒ';
                
                console.log('ğŸ“Š æ©Ÿå°çµ±è¨ˆæ›´æ–°å®Œæˆ:', {
                    plays: effectivePlays,
                    payouts: effectivePayouts,
                    avgCost: Math.round(avgCost)
                });
                
            } catch (error) {
                console.error('è¨ˆç®—æ©Ÿå°çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
                document.getElementById('edit-current-plays').textContent = 'éŒ¯èª¤';
                document.getElementById('edit-current-payouts').textContent = 'éŒ¯èª¤';
                document.getElementById('edit-current-cost').textContent = 'éŒ¯èª¤';
            }
        }

        // å¸¶é è¦½åŠŸèƒ½çš„æ©Ÿå°çµ±è¨ˆæ›´æ–°ï¼ˆè€ƒæ…®ç”¨æˆ¶æ­£åœ¨è¼¸å…¥çš„æ ¡æ­£å€¼ï¼‰
        async function updateCurrentMachineStatsWithPreview(docId) {
            try {
                console.log('ğŸ” é–‹å§‹è¨ˆç®—æ©Ÿå°çµ±è¨ˆæ•¸æ“šï¼ˆå«é è¦½ï¼‰ï¼ŒdocId:', docId);
                
                // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°è³‡æ–™
                const machine = appData.machines.find(m => m.docId === docId);
                if (!machine) {
                    console.error('æ‰¾ä¸åˆ°æ©Ÿå°è³‡æ–™');
                    return;
                }
                
                // å–å¾—ç”¨æˆ¶æ­£åœ¨è¼¸å…¥çš„æ ¡æ­£å€¼
                const previewPlaysCalibration = parseInt(document.getElementById('edit-machine-plays-calibration').value) || 0;
                const previewPayoutsCalibration = parseInt(document.getElementById('edit-machine-payouts-calibration').value) || 0;
                
                // è¨ˆç®—æœ‰æ•ˆæŠ•å¹£å’Œå‡ºè²¨æ•¸ï¼ˆä½¿ç”¨é è¦½æ ¡æ­£å€¼ï¼‰
                const effectivePlays = (machine.totalPlays || 0) + previewPlaysCalibration;
                const effectivePayouts = (machine.totalPayouts || 0) + previewPayoutsCalibration;
                const revenue = effectivePlays * COIN_VALUE;
                const avgCost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('edit-current-plays').textContent = effectivePlays.toLocaleString();
                document.getElementById('edit-current-payouts').textContent = effectivePayouts.toLocaleString();
                document.getElementById('edit-current-cost').textContent = effectivePayouts > 0 ? `${Math.round(avgCost)} å…ƒ` : '-- å…ƒ';
                
                console.log('ğŸ“Š æ©Ÿå°çµ±è¨ˆé è¦½æ›´æ–°å®Œæˆ:', {
                    plays: effectivePlays,
                    payouts: effectivePayouts,
                    avgCost: Math.round(avgCost),
                    playsCalibration: previewPlaysCalibration,
                    payoutsCalibration: previewPayoutsCalibration
                });
                
            } catch (error) {
                console.error('è¨ˆç®—æ©Ÿå°çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
                document.getElementById('edit-current-plays').textContent = 'éŒ¯èª¤';
                document.getElementById('edit-current-payouts').textContent = 'éŒ¯èª¤';
                document.getElementById('edit-current-cost').textContent = 'éŒ¯èª¤';
            }
        }
        
        async function handleUpdateMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-machine-doc-id').value;
            const newId = document.getElementById('edit-machine-id').value.trim();
            const newLocation = document.getElementById('edit-machine-location').value.trim();
            const newMac = document.getElementById('edit-machine-mac').value.trim();
            const newDevid = parseInt(document.getElementById('edit-machine-devid').value, 10) || 1;
            const newInitialPlays = parseInt(document.getElementById('edit-machine-initial-plays').value, 10) || 0;
            const newInitialPayouts = parseInt(document.getElementById('edit-machine-initial-payouts').value, 10) || 0;
            const newPlaysCalibration = parseInt(document.getElementById('edit-machine-plays-calibration').value, 10) || 0;
            const newPayoutsCalibration = parseInt(document.getElementById('edit-machine-payouts-calibration').value, 10) || 0;

            if (!newId || !newLocation) return alert('æ©Ÿå°ç·¨è™Ÿå’Œä½ç½®ä¸èƒ½ç‚ºç©ºï¼');

            // Find the original machine data to calculate the difference
            const originalMachine = appData.machines.find(m => m.docId === docId);
            if (!originalMachine) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹æ©Ÿå°è³‡æ–™ï¼');
                return;
            }

            // æ­£ç¢ºé‚è¼¯ï¼šåªæ›´æ–°èµ·å§‹å€¼ï¼Œä¸æ”¹è®Šç¸½ç´¯ç©æ•¸å€¼
            // ç‡Ÿæ”¶è¨ˆç®—ï¼šæœ‰æ•ˆç‡Ÿæ”¶ = ç¸½ç´¯ç© - æ–°èµ·å§‹å€¼
            // é€™æ¨£ä¿®æ”¹èµ·å§‹å€¼æ™‚ï¼Œç‡Ÿæ”¶æœƒæ­£ç¢ºåœ°é‡æ–°è¨ˆç®—
            
            try {
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'æ›´æ–°ä¸­...';
                submitBtn.disabled = true;

                // âœ… æ§‹å»º devidData çµæ§‹ï¼Œæ”¯æ´å¤šè¨­å‚™ID
                const devidData = {};
                if (newMac) {
                    devidData[newDevid.toString()] = newMac;
                    // ä¿ç•™èˆŠçš„ devidDataï¼Œåªæ›´æ–°ç•¶å‰ devid
                    if (originalMachine.devidData) {
                        Object.keys(originalMachine.devidData).forEach(key => {
                            if (key !== newDevid.toString()) {
                                devidData[key] = originalMachine.devidData[key];
                            }
                        });
                    }
                }

                // æ›´æ–°æ©Ÿå°è³‡æ–™ - åŒ…å«æ ¡æ­£å€¼ã€è¼ªè©¢è¨­å®šå’Œ devidData
                const updateData = {
                    id: newId,
                    location: newLocation,
                    mac: newMac,
                    devid: newDevid,  // ä¿ç•™èˆŠæ¬„ä½å‘ä¸‹ç›¸å®¹
                    initialPlays: newInitialPlays,
                    initialPayouts: newInitialPayouts,
                    playsCalibration: newPlaysCalibration,
                    payoutsCalibration: newPayoutsCalibration
                    // plays å’Œ payouts ä¿æŒåŸå€¼ï¼Œä¸æ›´æ–°
                };
                
                // âœ… åªåœ¨æœ‰ MAC æ™‚æ‰åŠ å…¥ devidData
                if (newMac && Object.keys(devidData).length > 0) {
                    updateData.devidData = devidData;
                }

                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).update(updateData);
                
                console.log(`ğŸ”§ æ©Ÿå° ${newId}/${newLocation} æ›´æ–°å®Œæˆ:`);
                console.log(`   MAC: ${newMac}, è¨­å‚™ID: ${newDevid}`, updateData.devidData ? ', devidData: ' + JSON.stringify(updateData.devidData) : '');
                console.log(`   æ ¡æ­£å€¼ - æŠ•å¹£: ${newPlaysCalibration}, å‡ºè²¨: ${newPayoutsCalibration}`);

                // é—œé–‰ç·¨è¼¯è¦–çª—
                editMachineModal.classList.add('hidden');
                
                // âœ… é‡å»ºæ©Ÿå°é…ç½®æ˜ å°„
                window.machineConfigMap = null;
                window.machineConfigMapByDevid = null;
                
                // é‡æ–°è¼‰å…¥ä¸¦é‡æ–°è¨ˆç®—æ‰€æœ‰è³‡æ–™
                await loadStoreData();
                
                // å¼·åˆ¶æ›´æ–°æ‰€æœ‰UIå…ƒä»¶ä»¥åæ˜ æ–°çš„è¨ˆç®—çµæœ
                setTimeout(async () => {
                    await updateUI();
                    
                    // ç¢ºä¿æ‰€æœ‰é é¢çš„æ•¸æ“šéƒ½è¢«æ›´æ–°
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const tabName = activeTab.dataset.tab;
                        switch(tabName) {
                            case 'summary':
                                await renderSummaryTab();
                                break;
                            case 'analysis':
                                renderAnalysisTab();
                                break;
                            case 'statistics':
                                renderStatisticsTab();
                                break;
                            case 'charts':
                                await renderChartsTab();
                                break;
                            case 'checkout':
                                renderCheckoutTab();
                                break;
                        }
                    }
                    
                    console.log('æ©Ÿå°è³‡æ–™æ›´æ–°å®Œæˆï¼Œæ‰€æœ‰çµ±è¨ˆæ•¸æ“šå·²é‡æ–°è¨ˆç®—');
                }, 200);

                showFeedback('âœ… æ©Ÿå°èµ·å§‹å€¼æ›´æ–°æˆåŠŸï¼<br>ğŸ“Š ç‡Ÿæ”¶è¨ˆç®—åŸºæº–å·²èª¿æ•´ï¼šç‡Ÿæ”¶ = æ­·å²ç´¯ç© - æ–°èµ·å§‹å€¼', false);

                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error("æ›´æ–°æ©Ÿå°è³‡è¨Šå¤±æ•—ï¼š", error);
                showFeedback('æ›´æ–°æ©Ÿå°è³‡è¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
            }
        }


        async function handleUpdateHistory(e) {
            e.preventDefault();
            if(!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-history-doc-id').value;
            const machineId = document.getElementById('edit-history-machine-id').value;
            const location = document.getElementById('edit-history-location').value;
            const newDate = document.getElementById('edit-history-date').value;
            const oldPlays = parseInt(document.getElementById('edit-history-old-plays').value, 10);
            const oldPayouts = parseInt(document.getElementById('edit-history-old-payouts').value, 10);
            const newPlays = parseInt(document.getElementById('edit-history-plays').value, 10);
            const newPayouts = parseInt(document.getElementById('edit-history-payouts').value, 10);
            
            if (!newDate) {
                alert('éŒ¯èª¤ï¼šè«‹é¸æ“‡ç´€éŒ„æ—¥æœŸã€‚');
                return;
            }
            
            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°ä¾†æ›´æ–°æ•¸æ“šã€‚');
                return;
            }

            const playsDiff = newPlays - oldPlays;
            const payoutsDiff = newPayouts - oldPayouts;

            const newTotalPlays = machineToUpdate.plays + playsDiff;
            const newTotalPayouts = machineToUpdate.payouts + payoutsDiff;
            
            try {
                // Batch update
                const batch = db.batch();
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                batch.update(machineRef, {
                    plays: newTotalPlays,
                    payouts: newTotalPayouts
                });

                const historyRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(docId);
                batch.update(historyRef, {
                    date: newDate,
                    newPlays: newPlays,
                    newPayouts: newPayouts
                });

                await batch.commit();

                editHistoryModal.classList.add('hidden');
                showFeedback("è¨˜å¸³ç´€éŒ„å·²æ›´æ–°ï¼", false);
                loadStoreData();
            } catch(error) {
                console.error("æ›´æ–°è¨˜å¸³ç´€éŒ„å¤±æ•—ï¼š", error);
                alert('æ›´æ–°ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }


        async function handleDeleteHistory(historyDocId, machineId, location, dailyPlays, dailyPayouts) {
            if(!selectedStoreId || !selectedGroupId || !historyDocId || !machineId) return;

            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„æ©Ÿå°ä¾†å›æ»¾æ•¸æ“šã€‚');
                return;
            }
            
            showConfirmationModal('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³ç´€éŒ„å—ï¼Ÿç³»çµ±å°‡è‡ªå‹•å›æ»¾æ©Ÿå°æ•¸æ“šã€‚', async () => {
                const revertedPlays = machineToUpdate.plays - dailyPlays;
                const revertedPayouts = machineToUpdate.payouts - dailyPayouts;

                if(revertedPlays < (machineToUpdate.initialPlays || 0) || revertedPayouts < (machineToUpdate.initialPayouts || 0) ) {
                    alert('éŒ¯èª¤ï¼šåˆªé™¤æ­¤ç´€éŒ„æœƒå°è‡´æ©Ÿå°ç´¯ç©æ•¸è®Šç‚ºè² æ•¸æˆ–å°æ–¼èµ·å§‹å€¼ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
                    hideConfirmationModal();
                    return;
                }

                try {
                    const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                    await machineRef.update({
                        plays: revertedPlays,
                        payouts: revertedPayouts
                    });
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(historyDocId).delete();
                    
                    hideConfirmationModal();
                    showFeedback("è¨˜å¸³ç´€éŒ„å·²åˆªé™¤ä¸¦æˆåŠŸå›æ»¾æ•¸æ“šï¼", false);
                    loadStoreData();

                } catch (error) {
                    console.error("åˆªé™¤è¨˜å¸³ç´€éŒ„å¤±æ•—ï¼š", error);
                    alert('åˆªé™¤ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    hideConfirmationModal();
                }
            });
        }
        
        function getAggregatedSummaryData(period = 'all') {
            let dataToAggregate;

            if (period === 'all') {
                dataToAggregate = appData.machines.map(m => {
                    // ğŸ”§ ç¢ºä¿è¨ˆç®—æ™‚éƒ½ç”¨æ•´æ•¸
                    const plays = Math.round(Number(m.plays) || 0);
                    const initialPlays = Math.round(Number(m.initialPlays) || 0);
                    const effectivePlays = plays - initialPlays;
                    const payouts = Math.round(Number(m.payouts) || 0);
                    const initialPayouts = Math.round(Number(m.initialPayouts) || 0);
                    const effectivePayouts = payouts - initialPayouts;
                    return { id: m.id, plays: effectivePlays, payouts: effectivePayouts };
                });
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                const filteredHistory = appData.history.filter(h => new Date(h.date) >= startDate);

                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: Math.round(Number(h.newPlays) || 0),
                    payouts: Math.round(Number(h.newPayouts) || 0)
                }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡è¨ˆç®—æ˜¯æ•´æ•¸
                const plays = Math.round(s.plays);
                const payouts = Math.round(s.payouts);
                const revenue = plays * COIN_VALUE;  // âœ… æ°¸é æ˜¯æ•´æ•¸
                const cost = payouts > 0 ? revenue / payouts : 0;
                return { id: s.id, revenue, payouts, cost };
            });
        }
        
        // åŸºæ–¼ç¯©é¸å¾Œçš„æ­·å²è¨˜éŒ„ç²å–ç‡Ÿæ¥­æ˜ç´°è³‡æ–™
        function getAggregatedSummaryDataFromHistory(period = 'all', filteredHistory) {
            let dataToAggregate;

            if (period === 'all') {
                // ä½¿ç”¨ç¯©é¸å¾Œçš„æ­·å²è¨˜éŒ„
                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: Math.round(Number(h.newPlays) || 0),
                    payouts: Math.round(Number(h.newPayouts) || 0)
                }));
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                // åœ¨å·²ç¯©é¸çš„æ­·å²è¨˜éŒ„ä¸­å†æ¬¡æŒ‰æœŸé–“ç¯©é¸
                dataToAggregate = filteredHistory
                    .filter(h => new Date(h.date) >= startDate)
                    .map(h => ({
                        id: h.machineId,
                        plays: h.newPlays || 0,
                        payouts: h.newPayouts || 0
                    }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { id: s.id, revenue, payouts: s.payouts, cost };
            });
        }
        
        async function handlePerformCheckout() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');

            try {
                const checkoutSnapshot = await checkoutCollection.limit(1).get();
                let lastCheckoutRevenue = 0;
                let lastCheckoutDate = appData.startDate;

                if (!checkoutSnapshot.empty) {
                    const lastCheckout = checkoutSnapshot.docs[0].data();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    lastCheckoutDate = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                }

                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;

                if (pendingAmount <= 0) {
                    alert("ç›®å‰æ²’æœ‰å¾…çµå¸³é‡‘é¡ã€‚");
                    return;
                }
                
                showConfirmationModal(`æ‚¨ç¢ºå®šè¦çµç®—æœ¬æœŸç‡Ÿæ”¶ ${pendingAmount.toLocaleString()} å…ƒå—ï¼Ÿ`, async () => {
                     try {
                        // è¨ˆç®—å‡ºè²¨æ•¸é‡å’Œç›ˆåˆ©æ•¸æ“š
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // è¼‰å…¥æˆæœ¬è¨­å®š
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // è¨ˆç®—å„é …æˆæœ¬ï¼ˆåŸºæ–¼ç¸½ç‡Ÿæ”¶ï¼‰
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = currentTotalRevenue * (rentPercentage / 100);
                        const totalTaxCost = currentTotalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        const netProfit = currentTotalRevenue - totalCost;
                        
                        // è¨ˆç®—æœ¬æœŸç›ˆåˆ©ï¼ˆåƒ…é‡å°æœ¬æœŸå¾…çµå¸³é‡‘é¡ï¼‰
                        let lastCheckoutPayouts = 0;
                        if (!checkoutSnapshot.empty) {
                            const lastCheckout = checkoutSnapshot.docs[0].data();
                            lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                        }
                        const pendingPayouts = totalPayouts - lastCheckoutPayouts;
                        const pendingGiftCost = pendingPayouts * giftCost;
                        const pendingRentCost = pendingAmount * (rentPercentage / 100);
                        const pendingTaxCost = pendingAmount * (taxPercentage / 100);
                        const pendingTotalCost = pendingGiftCost + pendingRentCost + pendingTaxCost;
                        const pendingNetProfit = pendingAmount - pendingTotalCost;
                        
                        const newCheckoutData = {
                            checkoutDate: firebase.firestore.FieldValue.serverTimestamp(),
                            checkoutAmount: pendingAmount,
                            cumulativeRevenueAtCheckout: currentTotalRevenue,
                            // æ–°å¢å‡ºè²¨æ•¸é‡è¨˜éŒ„
                            checkoutPayouts: pendingPayouts,
                            cumulativePayoutsAtCheckout: totalPayouts,
                            // æ–°å¢ç¸½ç›ˆåˆ©è¨ˆç®—
                            totalProfit: {
                                giftCost: totalGiftCost,
                                rentCost: totalRentCost,
                                taxCost: totalTaxCost,
                                totalCost: totalCost,
                                netProfit: netProfit,
                                costSettings: { giftCost, rentPercentage, taxPercentage }
                            },
                            // æ–°å¢æœ¬æœŸç›ˆåˆ©è¨ˆç®—
                            periodProfit: {
                                giftCost: pendingGiftCost,
                                rentCost: pendingRentCost,
                                taxCost: pendingTaxCost,
                                totalCost: pendingTotalCost,
                                netProfit: pendingNetProfit,
                                payouts: pendingPayouts
                            }
                        };
                        const newCheckoutRef = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').add(newCheckoutData);
                        
                        hideConfirmationModal();
                        showFeedback("çµå¸³æˆåŠŸï¼æ­£åœ¨é‡æ–°çµ±è¨ˆæ‰€æœ‰è³‡æ–™...", false);
                        
                        console.log('ğŸ¯ çµå¸³å®Œæˆï¼Œé–‹å§‹é‡æ–°çµ±è¨ˆæ‰€æœ‰è³‡æ–™...');
                        
                        // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿è³‡æ–™åº«å¯«å…¥å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // é‡æ–°æ•´ç†æ‰€æœ‰çµ±è¨ˆè³‡æ–™
                        const refreshSuccess = await refreshAllStatistics();
                        
                        if (refreshSuccess) {
                            // é¡¯ç¤ºå®Œæˆè¨Šæ¯
                            showFeedback("ğŸ‰ çµå¸³å®Œæˆï¼æ‰€æœ‰çµ±è¨ˆè³‡æ–™å·²æ›´æ–°ã€‚", false);
                        } else {
                            showFeedback("çµå¸³å®Œæˆï¼Œä½†çµ±è¨ˆæ›´æ–°æ™‚ç™¼ç”Ÿå•é¡Œï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†ã€‚", true);
                        }

                    } catch (error) {
                        hideConfirmationModal();
                        console.error("çµå¸³å¤±æ•—:", error);
                        showFeedback("çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
                    }
                });
            } catch (error) {
                console.error("è™•ç†çµå¸³æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showFeedback("è™•ç†çµå¸³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
            }
        }

        // çµ±è¨ˆè³‡æ–™é‡æ–°æ•´ç†å‡½æ•¸
        async function refreshAllStatistics() {
            console.log('ğŸ”„ é–‹å§‹é‡æ–°æ•´ç†æ‰€æœ‰çµ±è¨ˆè³‡æ–™...');
            
            try {
                // é‡æ–°è¼‰å…¥æœ€æ–°è³‡æ–™ (loadStoreData æœƒè‡ªå‹•èª¿ç”¨ updateUI)
                console.log('ğŸ“¥ é‡æ–°è¼‰å…¥é–€å¸‚è³‡æ–™...');
                await loadStoreData();
                
                // ç­‰å¾…è³‡æ–™è¼‰å…¥å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // ç¢ºä¿è³‡æ–™å·²æ›´æ–°
                if (!appData || !appData.machines) {
                    console.warn('âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œç„¡æ³•é‡æ–°è¨ˆç®—çµ±è¨ˆ');
                    return false;
                }
                
                console.log('ğŸ“Š è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ©Ÿå°æ•¸é‡:', appData.machines.length);
                console.log('ğŸ“ˆ æ­·å²è¨˜éŒ„æ•¸é‡:', appData.history?.length || 0);
                
                // æ‰‹å‹•è§¸ç™¼å„å€‹é é¢çš„é‡æ–°æ¸²æŸ“
                console.log('ğŸ”„ é‡æ–°æ¸²æŸ“æ‰€æœ‰çµ±è¨ˆé é¢...');
                
                // é‡æ–°è™•ç†æ©Ÿå°è³‡æ–™
                const processedMachines = appData.machines.map(processMachineData);
                
                // å¼·åˆ¶é‡æ–°æ¸²æŸ“æ‰€æœ‰çµ±è¨ˆé é¢
                await renderSummaryTab();
                renderAnalysisTab();
                renderStatisticsTab();
                await renderChartsTab();
                renderProfitTab();
                renderCheckoutTab();
                
                // å¦‚æœç•¶å‰æ­£åœ¨é¡¯ç¤ºæŸå€‹çµ±è¨ˆé é¢ï¼Œå¼·åˆ¶é‡æ–°æ•´ç†è©²é é¢
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.dataset.tab;
                    console.log('ğŸ¯ ç•¶å‰æ´»å‹•é ç±¤:', tabName);
                    
                    // æ ¹æ“šç•¶å‰é ç±¤åŸ·è¡Œå°æ‡‰çš„æ¸²æŸ“å‡½æ•¸
                    switch(tabName) {
                        case 'summary':
                            setTimeout(async () => await renderSummaryTab(), 200);
                            break;
                        case 'analysis':
                            setTimeout(() => renderAnalysisTab(), 200);
                            break;
                        case 'statistics':
                            setTimeout(() => renderStatisticsTab(), 200);
                            break;
                        case 'charts':
                            setTimeout(async () => await renderChartsTab(), 200);
                            break;
                        case 'profit':
                            setTimeout(() => renderProfitTab(), 200);
                            break;
                        case 'checkout':
                            setTimeout(() => renderCheckoutTab(), 200);
                            break;
                    }
                }
                
                console.log('âœ… æ‰€æœ‰çµ±è¨ˆè³‡æ–™é‡æ–°æ•´ç†å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ é‡æ–°æ•´ç†çµ±è¨ˆè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // è¨­å®šçµ±è¨ˆç¯„åœçš„å…¨å±€è®Šæ•¸
        let currentStatsRange = 'current'; // é è¨­ç‚ºç•¶æœŸçµ±è¨ˆ
        let currentChartsRange = 'current';
        let currentSummaryRange = 'current';

        // æ ¹æ“šçµ±è¨ˆç¯„åœç¯©é¸è³‡æ–™
        function filterDataByRange(data, range) {
            if (range === 'all') {
                return data; // è¿”å›å…¨éƒ¨è³‡æ–™
            }
            
            // ç•¶æœŸè³‡æ–™ç¯©é¸ - æ ¹æ“šæœ€å¾Œçµå¸³æ—¥æœŸ
            const lastCheckoutDate = getLastCheckoutDate();
            if (!lastCheckoutDate) {
                return data; // å¦‚æœæ²’æœ‰çµå¸³è¨˜éŒ„ï¼Œè¿”å›å…¨éƒ¨è³‡æ–™
            }
            
            // ç¯©é¸çµå¸³æ—¥æœŸä¹‹å¾Œçš„è³‡æ–™
            return data.filter(record => {
                if (!record.date) return true;
                const recordDate = new Date(record.date);
                return recordDate > lastCheckoutDate;
            });
        }

        // å–å¾—æœ€å¾Œçµå¸³æ—¥æœŸ
        function getLastCheckoutDate() {
            try {
                // é€™è£¡æ‡‰è©²å¾ Firebase å–å¾—æœ€å¾Œçµå¸³æ—¥æœŸ
                // æš«æ™‚è¿”å› nullï¼Œè¡¨ç¤ºä½¿ç”¨å…¨éƒ¨è³‡æ–™
                return null;
            } catch (error) {
                console.error('å–å¾—æœ€å¾Œçµå¸³æ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        // å–å¾—æœ€å¾Œçµå¸³çš„ç´¯è¨ˆè³‡æ–™
        async function getLastCheckoutData() {
            if (!selectedGroupId || !selectedStoreId) {
                return { revenue: 0, payouts: 0, plays: 0 };
            }

            try {
                // âœ… æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ­·å²è¨˜éŒ„
                const historyCollection = db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('history');

                const historySnapshot = await historyCollection.limit(1).get();

                // âœ… å¦‚æœæ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œç›´æ¥è¿”å› 0ï¼ˆå¿½ç•¥çµå¸³è¨˜éŒ„ï¼‰
                if (historySnapshot.empty) {
                    console.log('ğŸ“Š æ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œè¿”å› 0 å€¼ï¼ˆå¿½ç•¥çµå¸³è¨˜éŒ„ï¼‰');
                    return { revenue: 0, payouts: 0, plays: 0 };
                }

                const checkoutCollection = db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('checkouts')
                    .orderBy('checkoutDate', 'desc');

                const checkoutSnapshot = await checkoutCollection.limit(1).get();

                if (checkoutSnapshot.empty) {
                    // æ²’æœ‰çµå¸³è¨˜éŒ„ï¼Œè¿”å› 0
                    console.log('ğŸ“Š æ²’æœ‰çµå¸³è¨˜éŒ„ï¼Œè¿”å› 0 å€¼');
                    return { revenue: 0, payouts: 0, plays: 0 };
                }

                const lastCheckout = checkoutSnapshot.docs[0].data();
                const lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                const lastCheckoutPlays = lastCheckoutRevenue / COIN_VALUE; // å¾ç‡Ÿæ”¶åæ¨æŠ•å¹£æ¬¡æ•¸

                console.log('ğŸ“Š æœ€å¾Œçµå¸³ç´¯è¨ˆè³‡æ–™:', {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                });

                return {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                };
            } catch (error) {
                console.error('å–å¾—æœ€å¾Œçµå¸³è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return { revenue: 0, payouts: 0, plays: 0 };
            }
        }

        // Debug å‡½æ•¸ - æ¸¬è©¦é‡æ–°çµ±è¨ˆåŠŸèƒ½
        window.testRefreshStatistics = function() {
            console.log('ğŸ§ª æ¸¬è©¦é‡æ–°çµ±è¨ˆåŠŸèƒ½...');
            console.log('ç•¶å‰è³‡æ–™ç‹€æ…‹:');
            console.log('- æ©Ÿå°æ•¸é‡:', appData?.machines?.length || 0);
            console.log('- æ­·å²è¨˜éŒ„æ•¸é‡:', appData?.history?.length || 0);
            console.log('- é¸å®šç¾¤çµ„ID:', selectedGroupId);
            console.log('- é¸å®šé–€å¸‚ID:', selectedStoreId);
            
            // æ‰‹å‹•è§¸ç™¼é‡æ–°çµ±è¨ˆ
            refreshAllStatistics().then(success => {
                console.log('é‡æ–°çµ±è¨ˆçµæœ:', success ? 'æˆåŠŸ' : 'å¤±æ•—');
            });
        };

        // Debug å‡½æ•¸ - æª¢æŸ¥ç•¶å‰çµ±è¨ˆè¨­å®š
        window.checkStatisticsSettings = function() {
            console.log('ğŸ“Š ç•¶å‰çµ±è¨ˆè¨­å®š:');
            console.log('- çµ±è¨ˆé é¢ç¯„åœ:', currentStatsRange);
            console.log('- åœ–è¡¨é é¢ç¯„åœ:', currentChartsRange);  
            console.log('- ç‡Ÿæ¥­æ˜ç´°ç¯„åœ:', currentSummaryRange);
            
            const activeTab = document.querySelector('.tab-btn.active');
            console.log('- ç•¶å‰æ´»å‹•é ç±¤:', activeTab?.dataset?.tab || 'ç„¡');
        };


        // --- UI RENDERING FUNCTIONS ---
        function renderGroups(groups) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            groupListContainer.innerHTML = '';
            if (groups.length === 0) {
                const noGroupsMessage = isAdmin ? 
                    'å°šæœªå»ºç«‹ä»»ä½•å–®ä½ç¾¤çµ„ã€‚' : 
                    'æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•ä»»ä½•ç¾¤çµ„ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚';
                groupListContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center py-8">${noGroupsMessage}</p>`;
                return;
            }
            groups.forEach(group => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 pt-3">
                        <button class="rename-group-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">æ”¹å</button>
                        <button class="delete-group-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">åˆªé™¤</button>
                    </div>
                ` : '';
                
                const groupCard = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="card-base group-card-main cursor-pointer p-4 mb-3" data-group-id="${group.id}" data-group-name="${group.name}">
                            <h3 class="text-xl font-bold text-white truncate text-center">${group.name}</h3>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                groupListContainer.innerHTML += groupCard;
            });
            
            // éš±è—æ–°å¢ç¾¤çµ„è¡¨å–®ï¼ˆå¦‚æœæ˜¯è¨ªå®¢ï¼‰
            const createGroupForm = document.getElementById('create-group-form').parentElement;
            if (createGroupForm) {
                if (isAdmin) {
                    createGroupForm.style.display = 'block';
                } else {
                    createGroupForm.style.display = 'none';
                }
            }
        }
        
        function renderStores(stores) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            storeListContainer.innerHTML = ''; 
            if (stores.length === 0) {
                storeListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">æ­¤ç¾¤çµ„å°šæœªå»ºç«‹ä»»ä½•é–€å¸‚ã€‚</p>';
                return;
            }
            stores.forEach(store => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 px-4 py-3">
                        <button class="edit-store-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">ç·¨è¼¯</button>
                        <button class="clone-store-btn text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded flex items-center gap-1" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                            </svg>
                            è¤‡è£½
                        </button>
                        <button class="delete-store-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">åˆªé™¤</button>
                    </div>
                ` : '';
                
                const storeCard = `
                     <div class="bg-gray-700 rounded-lg">
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="card-base store-card-main cursor-pointer flex-grow" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                                    <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                                </div>
                                <input type="checkbox" class="store-checkbox h-6 w-6 bg-gray-800 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600 shrink-0 ml-3 cursor-pointer" value="${store.id}" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}" checked>
                            </div>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                storeListContainer.innerHTML += storeCard;
            });
        }
        
        async function updateUI() {
            if (!appData || !appData.machines) return;
            
            // ğŸ“Š æ¯æ¬¡ UI æ›´æ–°æ™‚é‡å»ºæ©Ÿå°é…ç½®æ˜ å°„è¡¨
            console.log('ğŸ”„ é–‹å§‹é‡å»ºæ©Ÿå°é…ç½®æ˜ å°„è¡¨...');
            window.machineConfigMap = null; // å¼·åˆ¶é‡å»º
            buildMachineConfigMap();
            
            const processedMachines = appData.machines.map(processMachineData);
            await renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            await renderSummaryTab();
            renderAnalysisTab();
            renderAccountingTab();
            renderMachineManagementTab(); 
            await renderChartsTab();
            renderStatisticsTab();
            renderProfitTab();
            updateFooterAndHeader();
            
            // ï¿½ åˆ·æ–° HTTP è¼ªè©¢è‡ªå‹•è¨˜å¸³è¡¨æ ¼
            // é€™æ¨£é€²å…¥é–€å¸‚æ™‚æœƒé¡¯ç¤ºä¹‹å‰ã€Œç«‹å³è®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™ã€åŠŸèƒ½æ”¶é›†çš„è¨˜éŒ„
            if (typeof refreshAutoRecordTable === 'function') {
                console.log('ğŸ”„ åˆ·æ–° HTTP è¼ªè©¢è‡ªå‹•è¨˜å¸³è¡¨æ ¼...');
                refreshAutoRecordTable();
            }
            
            // ï¿½ğŸš€ è¼‰å…¥è‡ªå‹•è¼ªè©¢è¨­å®š
            const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
            if (autoPollOnLoadCheckbox && selectedGroupId && selectedStoreId) {
                const currentSetting = getAutoPollOnLoadSetting();
                autoPollOnLoadCheckbox.checked = currentSetting;
                console.log(`ğŸ”„ æ›´æ–° UIï¼šè‡ªå‹•è¼ªè©¢å‹¾é¸æ¡†ç‹€æ…‹è¨­ç‚º ${currentSetting}`);
            } else {
                console.log(`âš ï¸ ç„¡æ³•æ›´æ–°è‡ªå‹•è¼ªè©¢è¨­å®š - checkbox: ${!!autoPollOnLoadCheckbox}, selectedGroupId: ${selectedGroupId}, selectedStoreId: ${selectedStoreId}`);
            }
            
            // ğŸ’ è¨ºæ–·ç•°å¸¸æˆæœ¬æƒ…æ³
            diagnoseAbnormalCosts(processedMachines);
        }

        function renderMachineManagementTab() {
            machineListTableBody.innerHTML = '';
            if (!appData.machines || appData.machines.length === 0) {
                machineListTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-400">æ­¤é–€å¸‚å°šç„¡æ©Ÿå°ï¼Œè«‹å…ˆå»ºç«‹ä¸€å°ã€‚</td></tr>`;
                // âœ… é‡ç½®äº‹ä»¶ç›£è½å™¨æ¨™è¨˜ï¼Œä»¥ä¾¿é‡æ–°ç¶å®š
                machineListTableBody._mqttInputHandler = false;
                return;
            }
            appData.machines.forEach(machine => {
                console.log('æ¸²æŸ“æ©Ÿå°:', machine); // èª¿è©¦ç”¨
                console.log(`  æ©Ÿå° ${machine.id}: MAC=${machine.mac}, DevID=${machine.devid}, æ ¡æ­£å€¼=${machine.playsCalibration || 0}/${machine.payoutsCalibration || 0}`);
                const row = `
                    <tr class="hover:bg-gray-700/50" data-machine-id="${machine.docId}">
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full text-sm">${machine.id || '--'}</div>
                        </td>
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full text-sm">${machine.location || '--'}</div>
                        </td>
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full font-mono text-sm">${machine.mac || '--'}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-16 text-center mx-auto">${machine.devid || 1}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-24 text-center mx-auto">${machine.initialPlays || 0}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-24 text-center mx-auto">${machine.initialPayouts || 0}</div>
                        </td>
                        <td class="p-2 text-center" style="background-color: #1a202c;">
                            <div class="bg-gray-600 text-white rounded px-3 py-2 w-20 text-center text-sm mx-auto" title="æŠ•å¹£æ ¡æ­£å€¼ (æ­£æ•¸åŠ ï¼Œè² æ•¸æ¸›)">
                                ${machine.playsCalibration || 0}
                            </div>
                        </td>
                        <td class="p-2 text-center" style="background-color: #1a202c;">
                            <div class="bg-gray-600 text-white rounded px-3 py-2 w-20 text-center text-sm mx-auto" title="å‡ºè²¨æ ¡æ­£å€¼ (æ­£æ•¸åŠ ï¼Œè² æ•¸æ¸›)">
                                ${machine.payoutsCalibration || 0}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <button class="poll-machine-btn bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded mr-1" 
                                data-doc-id="${machine.docId}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                title="è®€å–æ©Ÿå°è³‡æ–™">
                                ğŸ“Š
                            </button>
                            <button class="edit-machine-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2" 
                                data-doc-id="${machine.docId}" 
                                data-id="${machine.id}"
                                data-location="${machine.location}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                data-initial-plays="${machine.initialPlays || 0}"
                                data-initial-payouts="${machine.initialPayouts || 0}"
                                data-plays-calibration="${machine.playsCalibration || 0}"
                                data-payouts-calibration="${machine.payoutsCalibration || 0}"
                                data-total-plays="${machine.totalPlays || 0}"
                                data-total-payouts="${machine.totalPayouts || 0}">
                                ä¿®æ”¹
                           </button>
                            <button class="delete-machine-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" data-doc-id="${machine.docId}">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                machineListTableBody.innerHTML += row;
            });
            
            // âœ… é‡ç½®äº‹ä»¶ç›£è½å™¨æ¨™è¨˜ï¼Œä»¥ä¾¿é‡æ–°ç¶å®šæ–°çš„ input å…ƒç´ 
            machineListTableBody._mqttInputHandler = false;
            
            // âœ… é‡æ–°åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            setTimeout(() => {
                initializeMqttPolling();
            }, 0);
        }
        
        async function renderMainStats(data) {
            console.log('ğŸ“Š é–‹å§‹è¨ˆç®—ç¸½çµ±è¨ˆè³‡æ–™...');
            
            // è¨ˆç®—ç•¶å‰ç¸½æ•¸æ“š
            const currentTotalPlays = data.reduce((sum, m) => sum + m.effectivePlays, 0);
            const currentTotalRevenue = currentTotalPlays * COIN_VALUE;
            const currentTotalPayouts = data.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // å–å¾—æœ€å¾Œçµå¸³çš„ç´¯è¨ˆè³‡æ–™
            const lastCheckoutData = await getLastCheckoutData();
            
            // è¨ˆç®—ç•¶æœŸæœªçµå¸³çš„æ•¸æ“šï¼ˆç¸½æ•¸æ“š - æœ€å¾Œçµå¸³ç´¯è¨ˆæ•¸æ“šï¼‰
            const pendingPlays = Math.max(0, currentTotalPlays - lastCheckoutData.plays);
            const pendingRevenue = Math.max(0, currentTotalRevenue - lastCheckoutData.revenue);
            const pendingPayouts = Math.max(0, currentTotalPayouts - lastCheckoutData.payouts);
            
            // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
            const correctedPendingRevenue = Math.round(pendingRevenue / 10) * 10;
            const pendingAvgCost = pendingPayouts > 0 ? correctedPendingRevenue / pendingPayouts : 0;
            
            console.log('ğŸ“ˆ çµ±è¨ˆè³‡æ–™è¨ˆç®—çµæœ:', {
                current: { plays: currentTotalPlays, revenue: currentTotalRevenue, payouts: currentTotalPayouts },
                lastCheckout: lastCheckoutData,
                pending: { plays: pendingPlays, revenue: correctedPendingRevenue, payouts: pendingPayouts, avgCost: pendingAvgCost }
            });
            
            // æ›´æ–°é¡¯ç¤ºï¼ˆé¡¯ç¤ºç•¶æœŸæœªçµå¸³æ•¸æ“šï¼‰
            document.getElementById('total-plays').textContent = `${pendingPlays.toLocaleString()} æ¬¡`;
            document.getElementById('total-revenue').textContent = `${correctedPendingRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('total-payouts').textContent = `${pendingPayouts.toLocaleString()} æ¬¡`;
            // âœ… ä½¿ç”¨ formatCost é¡¯ç¤ºæ•´æ•¸
            document.getElementById('avg-cost').textContent = `${Math.round(pendingAvgCost)} å…ƒ/æ¬¡`;
            
            // å„²å­˜ç•¶æœŸæ•¸æ“šåˆ°å…¨åŸŸè®Šæ•¸ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
            window.currentPendingStats = {
                plays: pendingPlays,
                revenue: correctedPendingRevenue,
                payouts: pendingPayouts,
                avgCost: pendingAvgCost
            };
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            
            filteredData.sort((a, b) => {
                // Primary comparison based on the selected column
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                let primaryCompare = 0;
                if(typeof valA === 'number' && typeof valB === 'number') {
                    primaryCompare = valA - valB;
                } else {
                    primaryCompare = String(valA).localeCompare(String(valB), undefined, { numeric: true });
                }

                if (primaryCompare !== 0) {
                    return currentSort.direction === 'asc' ? primaryCompare : -primaryCompare;
                }

                // Secondary Sorting Logic
                if (currentSort.key !== 'id') {
                    const idCompare = a.id.localeCompare(b.id, undefined, { numeric: true });
                    if (idCompare !== 0) return idCompare;
                }

                // Tertiary Sorting Logic (or secondary if sorting by ID)
                return a.location.localeCompare(b.location, undefined, { numeric: true });
            });

            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.effectivePlays.toLocaleString()}</td>
                    <td class="p-4 text-right">${(Math.round(item.revenue / 10) * 10).toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.effectivePayouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${Math.round(item.cost)} å…ƒ/æ¬¡</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            const cumulativePlaysInput = document.getElementById('cumulative-plays');
            const cumulativePayoutsInput = document.getElementById('cumulative-payouts');
            
            machineSelector.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
            if(appData.machines.length === 0) {
                machineSelector.innerHTML = '<option value="" disabled selected>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°</option>';
            } else {
                appData.machines.sort((a, b) => a.id.localeCompare(b.id)).forEach(m => {
                    machineSelector.innerHTML += `<option value="${m.docId}">${m.id} - ${m.location}</option>`;
                });
            }
            document.getElementById('entry-date').valueAsDate = new Date();
            cumulativePlaysInput.value = '';
            cumulativePayoutsInput.value = '';
            
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">å°šç„¡è¨˜å¸³ç´€éŒ„</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr class="hover:bg-gray-700/50">
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || 'æœªçŸ¥'}</td>
                        <td class="p-4">${h.location || 'æœªçŸ¥'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                        <td class="p-4 text-right">
                           <button class="edit-history-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2"
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-date="${h.date}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                ä¿®æ”¹
                           </button>
                           <button class="delete-history-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" 
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                åˆªé™¤
                           </button>
                        </td>
                    </tr>`;
                });
            }
        }
        
        async function renderSummaryTab() {
            const activeButton = document.querySelector('#summary-controls .active');
            const period = activeButton ? activeButton.dataset.period : 'all';
            
            let summaryData;
            let rangeText;
            
            // å¦‚æœé¸æ“‡ç•¶æœŸï¼Œä½¿ç”¨èˆ‡ä¸»çµ±è¨ˆç›¸åŒçš„é‚è¼¯
            if (period === 'current') {
                // å–å¾—æœ€å¾Œçµå¸³çš„ç´¯è¨ˆè³‡æ–™
                const lastCheckoutData = await getLastCheckoutData();
                
                // è¨ˆç®—ç•¶æœŸæœªçµå¸³çš„ç‡Ÿæ¥­æ˜ç´°
                const processedMachines = appData.machines.map(processMachineData);
                
                // è¨ˆç®—ç•¶å‰æ‰€æœ‰æ©Ÿå°çš„ç¸½æ•¸æ“š
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                summaryData = processedMachines.map(machine => {
                    // è¨ˆç®—æ­¤æ©Ÿå°åœ¨ç¸½æ•¸æ“šä¸­çš„å æ¯”
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // åŸºæ–¼å æ¯”è¨ˆç®—æ­¤æ©Ÿå°åœ¨æœ€å¾Œçµå¸³æ™‚çš„æ•¸æ“š
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // è¨ˆç®—ç•¶æœŸæœªçµå¸³æ•¸æ“š
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    return {
                        id: machine.id,
                        revenue: pendingRevenue,
                        payouts: pendingPayouts,
                        cost: pendingCost
                    };
                });
                
                rangeText = 'ç•¶æœŸæœªçµå¸³';
            } else {
                // å…¶ä»–æœŸé–“ä½¿ç”¨åŸæœ‰é‚è¼¯
                summaryData = getAggregatedSummaryData(period);
                rangeText = period === 'all' ? 'å…¨éƒ¨æ­·å²' : 
                           period === 'weekly' ? 'æœ¬é€±' :
                           period === 'monthly' ? 'æœ¬æœˆ' :
                           period === 'quarterly' ? 'æœ¬å­£' : 'ç¸½è¨ˆ';
            }

            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            if (summaryData.length === 0) {
                const noDataMessage = `${rangeText}æ­¤æœŸé–“ç„¡è³‡æ–™å¯ä¾›é¡¯ç¤º`;
                summaryTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
            } else {
                summaryData.sort((a,b) => b.revenue - a.revenue).forEach((s, index) => {
                    const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                    // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
                    const displayRevenue = Math.round(s.revenue / 10) * 10;
                    const costDisplay = Math.round(s.cost);
                    const abnormalIndicator = s.isAbnormalCost ? ' âš ï¸' : '';
                    summaryTableBody.innerHTML += `<tr class="${rowClass}">
                        <td class="p-4 font-medium text-white">${s.id}</td>
                        <td class="p-4 text-right">${displayRevenue.toLocaleString()} å…ƒ</td>
                        <td class="p-4 text-right">${s.payouts.toLocaleString()} æ¬¡</td>
                        <td class="p-4 text-right">${costDisplay} å…ƒ/æ¬¡${abnormalIndicator}</td>
                    </tr>`;
                });
            }

            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red', 'indigo', 'pink'];
            
            if (summaryData.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-gray-500">ç„¡ä½”æ¯”è³‡æ–™</p>';
            } else {
                summaryData.forEach((s, index) => {
                    const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];
                    // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
                    const displayRevenue = Math.round(s.revenue / 10) * 10;
                    chartContainer.innerHTML += `<div class="w-full">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-${color}-300">${s.id}</span>
                            <span class="text-sm font-medium text-${color}-300">${displayRevenue.toLocaleString()} å…ƒ (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                });
            }
            
            console.log(`ğŸª ç‡Ÿæ¥­æ˜ç´°å·²æ›´æ–° - ç¯„åœ: ${rangeText}, è³‡æ–™ç­†æ•¸: ${summaryData.length}`);
        }

        function renderAnalysisTab(customRange = null) {
            const psdControls = document.getElementById('psd-controls');
            const activeButton = psdControls.querySelector('.active');
            let period = activeButton ? activeButton.dataset.period : 'all';
            let periodRevenue = 0;
            let diffDays = 1;
            let analysisTitle = activeButton ? activeButton.textContent : "è‡ªè¨‚å€é–“";

            // Handle custom range
            if(customRange){
                period = 'custom';
                analysisTitle = `${customRange.start} ~ ${customRange.end}`;
            }

            // Calculate revenue and days based on period
            if (period === 'all') {
                periodRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const startDate = new Date(appData.startDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            } else {
                let periodStartDate, periodEndDate;
                if (period === 'custom') {
                    periodStartDate = new Date(customRange.start + 'T00:00:00');
                    periodEndDate = new Date(customRange.end + 'T00:00:00');
                } else {
                     const now = new Date();
                    switch (period) {
                        case 'weekly':
                            const day = now.getDay();
                            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                            periodStartDate = new Date(new Date().setDate(diff));
                            periodEndDate = new Date();
                            break;
                        case 'monthly':
                            periodStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            periodEndDate = new Date();
                            break;
                        case 'quarterly':
                            const quarter = Math.floor(now.getMonth() / 3);
                            periodStartDate = new Date(now.getFullYear(), quarter * 3, 1);
                            periodEndDate = new Date();
                            break;
                    }
                }
                periodStartDate.setHours(0,0,0,0);
                periodEndDate.setHours(23,59,59,999);

                const filteredHistory = appData.history.filter(h => {
                    const recordDate = new Date(h.date);
                    return recordDate >= periodStartDate && recordDate <= periodEndDate;
                });
                periodRevenue = filteredHistory.reduce((sum, h) => sum + (h.newPlays * COIN_VALUE), 0);
                const diffTime = Math.abs(periodEndDate - periodStartDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            }
            
            const psd = periodRevenue > 0 && diffDays > 0 ? periodRevenue / diffDays : 0;
            document.getElementById('psd-display').innerHTML = `
                <div class="text-sm text-gray-400">${analysisTitle} æ¯æ—¥å¹³å‡ç‡Ÿæ”¶</div>
                <div class="text-2xl font-bold text-white mt-1">${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} å…ƒ / å¤©</div>
                <div class="text-xs text-gray-500 mt-1">(${periodRevenue.toLocaleString()} å…ƒ Ã· ${diffDays} å¤©)</div>`;

            
            // --- Detailed Analysis ---
            const observationEl = document.getElementById('analysis-observation');
            const suggestionEl = document.getElementById('analysis-suggestion');
            const processedMachines = appData.machines.map(processMachineData);

            if (processedMachines.length === 0) {
                 observationEl.innerHTML = '<p>å°šç„¡æ©Ÿå°æ•¸æ“šå¯é€²è¡Œåˆ†æã€‚</p>';
                 suggestionEl.innerHTML = '<p>è«‹å…ˆè‡³ã€Œæ©Ÿå°ç®¡ç†ã€å»ºç«‹æ©Ÿå°ï¼Œä¸¦åœ¨ã€Œæ¯æ—¥è¨˜å¸³ã€æ–°å¢ç´€éŒ„ã€‚</p>';
                 return;
            }

            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

            let observationHTML = '';
            let suggestionHTML = '';

            // Top 3 Revenue
            observationHTML += '<div><h4 class="text-lg font-semibold text-green-400 mb-2">ğŸ¥‡ ç‡Ÿæ”¶ TOP 3 æ©Ÿå° (é‡‘é›æ¯)</h4><ul class="list-disc pl-5 space-y-1">';
            sortedByRevenue.slice(0, 3).forEach(m => {
                observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: ç¸½ç‡Ÿæ”¶ ${m.revenue.toLocaleString()} å…ƒ</li>`;
            });
            observationHTML += '</ul></div>';
            suggestionHTML += '<div><p class="text-green-300/80">å°æ–¼é«˜ç‡Ÿæ”¶æ©Ÿå°ï¼Œå»ºè­°ç¶­æŒç›®å‰ç†±åº¦ï¼Œå¯è€ƒæ…®é©æ™‚è£œå……é¡ä¼¼çå“ï¼Œä»¥éå›ºç‡Ÿæ”¶è¡¨ç¾ã€‚</p></div>';


            // Bottom 3 Revenue
            if (sortedByRevenue.length > 3) {
                 observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-yellow-400 mb-2">ğŸ¥‰ ç‡Ÿæ”¶ BOTTOM 3 æ©Ÿå° (å¾…è§€å¯Ÿ)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByRevenue.slice(-3).reverse().forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: ç¸½ç‡Ÿæ”¶ ${m.revenue.toLocaleString()} å…ƒ</li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-yellow-300/80">å°æ–¼ç‡Ÿæ”¶æœ«æ®µç­ï¼Œå»ºè­°è§€å¯Ÿæ©Ÿå°ä½ç½®æ˜¯å¦ç†æƒ³ï¼Œæˆ–è€ƒæ…®æ›´æ›çå“é¡å‹ã€èª¿æ•´çˆªåŠ›è¨­å®šä»¥æå‡æŠ•å¹£æ„é¡˜ã€‚</p></div>';
            }

            // Top 3 Highest Cost
             if (sortedByCost.length > 0) {
                observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-red-400 mb-2">ğŸš¨ å‡ºè²¨æˆæœ¬æœ€é«˜ TOP 3 æ©Ÿå° (è­¦ç¤ºå€)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByCost.slice(0, 3).forEach(m => {
                    const costDisplay = formatCost(m.cost);
                    const abnormalIndicator = m.isAbnormalCost ? ' âš ï¸' : '';
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: å¹³å‡æˆæœ¬ <strong class="text-red-400">${costDisplay} å…ƒ/æ¬¡${abnormalIndicator}</strong></li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-red-300/80">æˆæœ¬éé«˜çš„æ©Ÿå°éœ€é‡é»é—œæ³¨ï¼å»ºè­°ç«‹å³æª¢è¨çˆªåŠ›è¨­å®šèˆ‡çå“åƒ¹å€¼æ˜¯å¦åŒ¹é…ï¼Œé¿å…åˆ©æ½¤è¢«ä¾µè•ã€‚</p></div>';

            }

            observationEl.innerHTML = observationHTML;
            suggestionEl.innerHTML = suggestionHTML;
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                        key = new Date(d.setDate(diff)).toISOString().split('T')[0];
                        break;
                    case 'monthly': key = curr.date.substring(0, 7); break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        break;
                    default: key = curr.date; // daily
                }
                if (!acc[key]) {
                    acc[key] = { period: key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            
            // æ ¹æ“šé¸å®šçš„çµ±è¨ˆç¯„åœç²å–è³‡æ–™
            let data = getAggregatedData(period);
            
            // æ ¹æ“šçµ±è¨ˆç¯„åœç¯©é¸è³‡æ–™
            if (currentStatsRange === 'current') {
                // ç•¶æœŸè³‡æ–™ï¼šåƒ…é¡¯ç¤ºæœ€å¾Œçµå¸³å¾Œçš„è³‡æ–™
                data = filterDataByRange(data, 'current');
            }
            // å¦‚æœæ˜¯ 'all'ï¼Œå‰‡ä½¿ç”¨å…¨éƒ¨è³‡æ–™
            
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            
            // æ›´æ–°é é¢æ¨™é¡Œé¡¯ç¤ºç•¶å‰çµ±è¨ˆç¯„åœ
            const rangeText = currentStatsRange === 'current' ? 'ç•¶æœŸç´€éŒ„' : 'å…¨éƒ¨æ­·å²';
            const titleElement = document.querySelector('#statistics .text-xl');
            
            if(data.length === 0) {
                const noDataMessage = currentStatsRange === 'current' ? 
                    `å°šç„¡${rangeText}å¯ä¾›å½™æ•´` : 
                    'å°šç„¡æ­·å²ç´€éŒ„å¯ä¾›å½™æ•´';
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
                return;
            }
            
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
                const displayRevenue = Math.round(item.revenue / 10) * 10;
                const costDisplay = Math.round(item.cost);
                const abnormalIndicator = item.isAbnormalCost ? ' âš ï¸' : '';
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.period}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${displayRevenue.toLocaleString()} å…ƒ</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${costDisplay} å…ƒ/æ¬¡${abnormalIndicator}</td>
                </tr>`;
            });
            
            console.log(`ğŸ“Š çµ±è¨ˆé é¢å·²æ›´æ–° - ç¯„åœ: ${rangeText}, è³‡æ–™ç­†æ•¸: ${data.length}`);
        }
        
        async function renderChartsTab() {
            const revenueChartEl = document.getElementById('revenue-chart');
            const costChartEl = document.getElementById('cost-chart');

            revenueChartEl.innerHTML = '';
            costChartEl.innerHTML = '';

            // æ ¹æ“šé¸å®šçš„åœ–è¡¨ç¯„åœè™•ç†æ©Ÿå°è³‡æ–™
            let processedMachines = appData.machines.map(processMachineData);
            
            // å¦‚æœé¸æ“‡ç•¶æœŸçµ±è¨ˆï¼Œä½¿ç”¨èˆ‡ä¸»çµ±è¨ˆç›¸åŒçš„é‚è¼¯è¨ˆç®—ç•¶æœŸæœªçµå¸³æ•¸æ“š
            if (currentChartsRange === 'current') {
                // å–å¾—æœ€å¾Œçµå¸³çš„ç´¯è¨ˆè³‡æ–™
                const lastCheckoutData = await getLastCheckoutData();
                
                // è¨ˆç®—ç•¶å‰æ‰€æœ‰æ©Ÿå°çš„ç¸½æ•¸æ“š
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                // ç‚ºæ¯å€‹æ©Ÿå°è¨ˆç®—ç•¶æœŸæœªçµå¸³æ•¸æ“š
                processedMachines = processedMachines.map(machine => {
                    // è¨ˆç®—æ­¤æ©Ÿå°åœ¨ç¸½æ•¸æ“šä¸­çš„å æ¯”
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // åŸºæ–¼å æ¯”è¨ˆç®—æ­¤æ©Ÿå°åœ¨æœ€å¾Œçµå¸³æ™‚çš„æ•¸æ“š
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // è¨ˆç®—ç•¶æœŸæœªçµå¸³æ•¸æ“š
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    // ğŸ”§ ç¢ºä¿æ˜¯æ•´æ•¸
                    const roundedPendingPayouts = Math.round(pendingPayouts);
                    // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
                    const roundedPendingRevenue = Math.round(pendingRevenue / 10) * 10;
                    const roundedCost = roundedPendingPayouts > 0 ? roundedPendingRevenue / roundedPendingPayouts : 0;
                    
                    return {
                        ...machine,
                        totalPlays: pendingPlays,
                        totalPayouts: roundedPendingPayouts,
                        revenue: roundedPendingRevenue,
                        cost: roundedCost,
                        isAbnormalCost: false  // âœ… ç•¶æœŸçµ±è¨ˆä¸æ¨™è¨˜ç‚ºç•°å¸¸
                    };
                });
            }
            
            const rangeText = currentChartsRange === 'current' ? 'ç•¶æœŸ' : 'å…¨éƒ¨æ­·å²';

            if (processedMachines.length === 0 || processedMachines.every(m => m.revenue === 0)) {
                const noDataMessage = `å°šç„¡${rangeText}è³‡æ–™å¯ç¹ªè£½åœ–è¡¨`;
                revenueChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
                costChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
            } else {
                const maxRevenue = Math.max(...processedMachines.map(m => m.revenue), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.revenue / maxRevenue * 100);
                    // ğŸ”§ ç¢ºä¿æŠ•å¹£é‡‘é¡æ˜¯10çš„å€æ•¸
                    const displayRevenue = Math.round(machine.revenue / 10) * 10;
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${displayRevenue.toLocaleString()} å…ƒ
                                </div>
                            </div>
                        </div>
                    `;
                    revenueChartEl.innerHTML += chartItem;
                });

                const maxCost = Math.max(...processedMachines.map(m => m.cost), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.cost / maxCost * 100);
                    // âœ… æˆæœ¬å››æ¨äº”å…¥ç‚ºæ•´æ•¸
                    const costDisplay = Math.round(machine.cost);
                    const abnormalIndicator = machine.isAbnormalCost ? ' âš ï¸' : '';
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${costDisplay} å…ƒ/æ¬¡${abnormalIndicator}
                                </div>
                            </div>
                        </div>
                    `;
                    costChartEl.innerHTML += chartItem;
                });
            }
            
            const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
            if (appData.history.length > 0) {
                const latestDate = appData.history.reduce((max, h) => h.date > max ? h.date : max, appData.history[0].date);
                trendChartDatePicker.value = latestDate;
            } else {
                trendChartDatePicker.valueAsDate = new Date();
            }
            
            renderTrendChartByDate();
            
            console.log(`ğŸ“ˆ åœ–è¡¨é é¢å·²æ›´æ–° - ç¯„åœ: ${rangeText}, æ©Ÿå°æ•¸: ${processedMachines.length}`);
        }

        function renderTrendChartByDate() {
            const trendChartContentEl = document.getElementById('trend-chart-content');
            const selectedDate = trendChartDatePicker.value;

            trendChartContentEl.innerHTML = '';

            if (!selectedDate) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">è«‹é¸æ“‡ä¸€å€‹æ—¥æœŸä¾†æŸ¥çœ‹æ•¸æ“š</p>';
                return;
            }

            const dailyRecords = appData.history.filter(h => h.date === selectedDate);

            if (dailyRecords.length === 0) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">è©²æ—¥æœŸæ²’æœ‰è¨˜å¸³ç´€éŒ„</p>';
                return;
            }
            
            const aggregatedData = dailyRecords.reduce((acc, record) => {
                const key = `${record.machineId}|${record.location}`;
                if (!acc[key]) {
                    acc[key] = {
                        machineId: record.machineId,
                        location: record.location,
                        newPlays: 0,
                        newPayouts: 0
                    };
                }
                acc[key].newPlays += record.newPlays;
                acc[key].newPayouts += record.newPayouts;
                return acc;
            }, {});
            const aggregatedRecords = Object.values(aggregatedData);

            const recordsWithCalc = aggregatedRecords.map(r => {
                const revenue = r.newPlays * COIN_VALUE;
                const cost = r.newPayouts > 0 ? revenue / r.newPayouts : 0;
                return {...r, revenue, cost };
            });

            const maxRevenue = Math.max(...recordsWithCalc.map(r => r.revenue), 1);
            const maxCost = Math.max(...recordsWithCalc.map(r => r.cost), 1);
            
            let totalDayRevenue = 0;
            let totalDayPayouts = 0;
            
            recordsWithCalc.forEach(record => {
                totalDayRevenue += record.revenue;
                totalDayPayouts += record.newPayouts;
            });

            const revenueCharts = [...recordsWithCalc].sort((a,b) => b.revenue - a.revenue).map(record => {
                const barWidth = (record.revenue / maxRevenue) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.revenue.toLocaleString()} å…ƒ
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const costCharts = [...recordsWithCalc].sort((a,b) => b.cost - a.cost).map(record => {
                const barWidth = (record.cost / maxCost) * 100;
                const costDisplay = formatCost(record.cost);
                const abnormalIndicator = record.isAbnormalCost ? ' âš ï¸' : '';
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${costDisplay} å…ƒ/æ¬¡${abnormalIndicator}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalDayCost = totalDayPayouts > 0 ? totalDayRevenue / totalDayPayouts : 0;

            trendChartContentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-h-80 overflow-y-auto pr-2">
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">ç•¶æ—¥ç‡Ÿæ”¶</h4>
                           <p class="text-sm text-blue-300">ç¸½è¨ˆï¼š${totalDayRevenue.toLocaleString()} å…ƒ</p>
                        </div>
                        <div class="space-y-4">${revenueCharts}</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">ç•¶æ—¥å‡ºè²¨æˆæœ¬</h4>
                           <p class="text-sm text-yellow-300">å¹³å‡ï¼š${formatCost(totalDayCost)} å…ƒ/æ¬¡</p>
                        </div>
                        <div class="space-y-4">${costCharts}</div>
                    </div>
                </div>
            `;
        }
        
        // ç›ˆåˆ©è¨ˆç®—åŠŸèƒ½
        function renderProfitTab() {
            if (!appData || !appData.machines) return;
            
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // æ›´æ–°åŸºæœ¬è³‡è¨Š
            document.getElementById('profit-revenue').textContent = `${totalRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('profit-payouts').textContent = `${totalPayouts.toLocaleString()} æ¬¡`;
            
            // è¼‰å…¥å„²å­˜çš„æˆæœ¬è¨­å®š
            loadCostSettings();
            
            // è¨ˆç®—ç›ˆåˆ©
            calculateProfit();
        }
        
        function loadCostSettings() {
            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
            document.getElementById('gift-cost').value = settings.giftCost || 50;
            document.getElementById('rent-percentage').value = settings.rentPercentage || 30;
            document.getElementById('tax-percentage').value = settings.taxPercentage || 5;
        }
        
        function saveCostSettings() {
            const settings = {
                giftCost: parseFloat(document.getElementById('gift-cost').value) || 50,
                rentPercentage: parseFloat(document.getElementById('rent-percentage').value) || 30,
                taxPercentage: parseFloat(document.getElementById('tax-percentage').value) || 5
            };
            localStorage.setItem(`costSettings_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(settings));
            showFeedback('æˆæœ¬è¨­å®šå·²å„²å­˜ï¼', false);
        }
        
        function calculateProfit() {
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // ç²å–æˆæœ¬è¨­å®š
            const giftCost = parseFloat(document.getElementById('gift-cost').value) || 50;
            const rentPercentage = parseFloat(document.getElementById('rent-percentage').value) || 30;
            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 5;
            
            // ç²å–è¨ˆç®—ç¯„åœ
            const calculationScope = document.querySelector('input[name="profit-calculation-scope"]:checked').value;
            
            let calculationRevenue, calculationPayouts, scopeTitle;
            
            if (calculationScope === 'pending') {
                // è¨ˆç®—å¾…çµå¸³æœŸé–“çš„æ•¸æ“š
                const lastCheckoutData = JSON.parse(localStorage.getItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`) || '{}');
                const lastCheckoutRevenue = lastCheckoutData.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckoutData.cumulativePayoutsAtCheckout || 0;
                
                calculationRevenue = totalRevenue - lastCheckoutRevenue;
                calculationPayouts = totalPayouts - lastCheckoutPayouts;
                scopeTitle = 'æœ¬æœŸå¾…çµå¸³';
            } else {
                // ç¸½ç´¯ç©è¨ˆç®—
                calculationRevenue = totalRevenue;
                calculationPayouts = totalPayouts;
                scopeTitle = 'ç¸½ç´¯ç©';
            }
            
            // è¨ˆç®—å„é …æˆæœ¬
            const totalGiftCost = calculationPayouts * giftCost;
            const totalRentCost = calculationRevenue * (rentPercentage / 100);
            const totalTaxCost = calculationRevenue * (taxPercentage / 100);
            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
            
            // è¨ˆç®—æ·¨åˆ©æ½¤
            const netProfit = calculationRevenue - totalCost;
            const profitMargin = calculationRevenue > 0 ? (netProfit / calculationRevenue) * 100 : 0;
            const profitPerPayout = calculationPayouts > 0 ? netProfit / calculationPayouts : 0;
            
            // æ›´æ–°UI - é¡¯ç¤ºè¨ˆç®—ç¯„åœ
            document.getElementById('profit-revenue').textContent = `${calculationRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('profit-payouts').textContent = `${calculationPayouts.toLocaleString()} æ¬¡`;
            
            // æ›´æ–°æˆæœ¬æ˜ç´°æ¨™é¡Œä»¥é¡¯ç¤ºè¨ˆç®—ç¯„åœ
            const costDetailTitle = document.querySelector('.bg-gray-700\\/50 h4');
            if (costDetailTitle && costDetailTitle.textContent.includes('æˆæœ¬æ˜ç´°')) {
                costDetailTitle.textContent = `ğŸ’¸ æˆæœ¬æ˜ç´° (${scopeTitle})`;
            }
            
            document.getElementById('total-gift-cost').textContent = `${totalGiftCost.toLocaleString()} å…ƒ`;
            document.getElementById('total-rent-cost').textContent = `${totalRentCost.toLocaleString()} å…ƒ`;
            document.getElementById('total-tax-cost').textContent = `${totalTaxCost.toLocaleString()} å…ƒ`;
            document.getElementById('total-cost').textContent = `${totalCost.toLocaleString()} å…ƒ`;
            
            document.getElementById('profit-total-revenue').textContent = `${calculationRevenue.toLocaleString()} å…ƒ`;
            document.getElementById('profit-total-cost').textContent = `${totalCost.toLocaleString()} å…ƒ`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString()} å…ƒ`;
            document.getElementById('profit-net').textContent = `${netProfit.toLocaleString()} å…ƒ`;
            
            // è¨­å®šé¡è‰²
            const profitColor = netProfit >= 0 ? 'text-green-300' : 'text-red-300';
            document.getElementById('net-profit').className = `${profitColor} font-bold text-xl`;
            document.getElementById('profit-net').parentElement.className = netProfit >= 0 ? 
                'bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl' : 
                'bg-gradient-to-br from-red-600 to-red-700 p-6 rounded-xl';
            
            document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('profit-margin').className = profitMargin >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
            
            document.getElementById('profit-per-payout').textContent = `${profitPerPayout.toFixed(2)} å…ƒ`;
            document.getElementById('profit-per-payout').className = profitPerPayout >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
        }

        async function renderCheckoutTab() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
            const lastCheckoutDateEl = document.getElementById('last-checkout-date');
            const pendingAmountEl = document.getElementById('pending-checkout-amount');

            checkoutHistoryBody.innerHTML = '';

            try {
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                let lastCheckoutRevenue = 0;
                if (checkouts.length > 0) {
                    const lastCheckout = checkouts[0];
                    lastCheckoutDateEl.textContent = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    
                    // ä¿å­˜æœ€å¾Œçµå¸³è³‡è¨Šåˆ° localStorage ä¾›ç›ˆåˆ©è¨ˆç®—ä½¿ç”¨
                    const lastCheckoutData = {
                        cumulativeRevenueAtCheckout: lastCheckout.cumulativeRevenueAtCheckout,
                        cumulativePayoutsAtCheckout: lastCheckout.cumulativePayoutsAtCheckout || 0,
                        checkoutDate: lastCheckout.checkoutDate
                    };
                    localStorage.setItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(lastCheckoutData));

                    checkouts.forEach((checkout, index) => {
                         const prevCheckoutDate = index < checkouts.length - 1 ? new Date(checkouts[index + 1].checkoutDate.toDate()).toLocaleString() : appData.startDate;
                         
                         // å–å¾—ç•¶æœŸå‡ºè²¨æ•¸é‡
                         const currentPayouts = checkout.checkoutPayouts || 0;
                         
                         // å–å¾—ç•¶æœŸç›ˆåˆ©ä¿¡æ¯
                         const periodProfit = checkout.periodProfit || {};
                         const periodNetProfit = periodProfit.netProfit || 0;
                         const profitColor = periodNetProfit >= 0 ? 'text-green-400' : 'text-red-400';
                         
                         // æª¢æŸ¥æ˜¯å¦æœ‰ç›ˆåˆ©è¨ˆç®—æ•¸æ“š
                         const hasProfitData = checkout.periodProfit || checkout.totalProfit;
                         
                        const row = `
                            <tr class="hover:bg-gray-700/50">
                                <td class="p-3 text-sm">${new Date(checkout.checkoutDate.toDate()).toLocaleString()}</td>
                                <td class="p-3 text-right text-sm font-semibold">${checkout.checkoutAmount.toLocaleString()} å…ƒ</td>
                                <td class="p-3 text-right text-sm">${currentPayouts.toLocaleString()} æ¬¡</td>
                                <td class="p-3 text-right text-sm font-semibold ${profitColor}">${periodNetProfit.toLocaleString()} å…ƒ</td>
                                <td class="p-3 text-right text-sm text-gray-400">${checkout.cumulativeRevenueAtCheckout.toLocaleString()} å…ƒ</td>
                                <td class="p-3 text-right text-sm">
                                    ${hasProfitData ? 
                                        `<button class="view-profit-detail-btn bg-purple-600 hover:bg-purple-700 text-white text-xs py-1 px-2 rounded mr-1"
                                            data-checkout-data='${JSON.stringify(checkout)}'>è©³æƒ…</button>` : 
                                        '<span class="text-gray-500 text-xs">ç„¡æ•¸æ“š</span>'
                                    }
                                </td>
                                <td class="p-3 text-right">
                                    <button class="download-checkout-pdf-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded"
                                        data-checkout-id="${checkout.id}"
                                        data-checkout-date="${new Date(checkout.checkoutDate.toDate()).toLocaleString()}"
                                        data-prev-checkout-date="${prevCheckoutDate}"
                                        data-amount="${checkout.checkoutAmount}"
                                        data-cumulative="${checkout.cumulativeRevenueAtCheckout}">
                                        å ±å‘Š
                                    </button>
                                </td>
                            </tr>
                        `;
                        checkoutHistoryBody.innerHTML += row;
                    });
                    
                    // æ¸²æŸ“åœ–è¡¨å’Œçµ±è¨ˆæ•¸æ“š
                    renderCheckoutCharts(checkouts);
                    renderCheckoutStats(checkouts);
                } else {
                    lastCheckoutDateEl.textContent = 'ç„¡ (ä»¥ç‡Ÿæ¥­èµ·å§‹æ—¥ç‚ºæº–)';
                    checkoutHistoryBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">å°šç„¡çµå¸³ç´€éŒ„</td></tr>`;
                    
                    // æ¸…ç©ºåœ–è¡¨å’Œçµ±è¨ˆ
                    clearCheckoutCharts();
                    clearCheckoutStats();
                }
                
                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;
                pendingAmountEl.textContent = `${pendingAmount.toLocaleString()} å…ƒ`;

            } catch (error) {
                console.error("è®€å–çµå¸³æ­·å²å¤±æ•—:", error);
                checkoutHistoryBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-400">ç„¡æ³•è®€å–çµå¸³æ­·å²</td></tr>`;
                clearCheckoutCharts();
                clearCheckoutStats();
            }
        }

        // æ¸²æŸ“çµå¸³åœ–è¡¨
        function renderCheckoutCharts(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutCharts();
                return;
            }

            // æŒ‰æ™‚é–“æ’åº (èˆŠåˆ°æ–°)
            const sortedCheckouts = [...checkouts].reverse();
            
            // çµå¸³é‡‘é¡è¶¨å‹¢åœ– - ä½¿ç”¨ç·šåœ– + å€åŸŸå¡«å……
            renderLineChart('checkout-amount-chart', sortedCheckouts, 'checkoutAmount', 'blue', 'çµå¸³é‡‘é¡');
            
            // ç´¯ç©ç‡Ÿæ”¶è¶¨å‹¢åœ– - ä½¿ç”¨ç·šåœ– + å€åŸŸå¡«å……
            renderLineChart('checkout-cumulative-chart', sortedCheckouts, 'cumulativeRevenueAtCheckout', 'green', 'ç´¯ç©ç‡Ÿæ”¶');
        }

        // æ¸²æŸ“ç·šåœ–
        function renderLineChart(elementId, data, valueKey, color, label) {
            const chartEl = document.getElementById(elementId);
            const values = data.map(d => d[valueKey]);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const valueRange = maxValue - minValue || 1;
            
            const chartWidth = 400;
            const chartHeight = 200;
            const padding = 40;
            
            chartEl.innerHTML = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4">
                    <svg width="100%" height="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" class="overflow-visible">
                        <!-- ç¶²æ ¼ç·š -->
                        ${Array.from({length: 5}, (_, i) => {
                            const y = padding + (i * (chartHeight - 2 * padding)) / 4;
                            return `<line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" stroke="#374151" stroke-width="1" opacity="0.3"/>`;
                        }).join('')}
                        
                        <!-- å€åŸŸå¡«å…… -->
                        <defs>
                            <linearGradient id="gradient-${color}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.3"/>
                                <stop offset="100%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.05"/>
                            </linearGradient>
                        </defs>
                        
                        <path d="M${padding},${chartHeight - padding} ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `L${x},${y}`;
                        }).join(' ')} L${chartWidth - padding},${chartHeight - padding} Z" 
                              fill="url(#gradient-${color})" stroke="none"/>
                        
                        <!-- ç·šæ¢ -->
                        <path d="M${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `${index === 0 ? 'M' : 'L'}${x},${y}`;
                        }).join(' ')}" 
                              fill="none" 
                              stroke="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                              stroke-width="3" 
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                        
                        <!-- æ•¸æ“šé» -->
                        ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                            const value = item[valueKey].toLocaleString();
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        fill="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                                        stroke="#1f2937" 
                                        stroke-width="2" 
                                        class="cursor-pointer transition-all hover:r-6"
                                        data-tooltip="${date}: ${value} å…ƒ">
                                    <title>${date}: ${value} å…ƒ</title>
                                </circle>
                            `;
                        }).join('')}
                        
                        <!-- Yè»¸æ¨™ç±¤ -->
                        ${Array.from({length: 5}, (_, i) => {
                            const value = minValue + (i * valueRange) / 4;
                            const y = chartHeight - padding - (i * (chartHeight - 2 * padding)) / 4;
                            return `<text x="${padding - 10}" y="${y + 4}" fill="#9ca3af" text-anchor="end" font-size="10">${Math.round(value).toLocaleString()}</text>`;
                        }).join('')}
                    </svg>
                    
                    <!-- æ•¸æ“šé»æ¨™ç±¤ -->
                    <div class="absolute bottom-2 left-0 right-0 flex justify-between px-10 text-xs text-gray-400">
                        ${data.map((item, index) => {
                            if (data.length <= 5 || index % Math.ceil(data.length / 5) === 0 || index === data.length - 1) {
                                const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                                return `<span class="transform -rotate-45 origin-bottom-left">${date}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <!-- åœ–ä¾‹ -->
                    <div class="absolute top-2 right-2 flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-gradient-to-br ${color === 'blue' ? 'from-blue-400 to-blue-600' : 'from-green-400 to-green-600'}"></div>
                        <span class="text-xs text-gray-300">${label}</span>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“çµå¸³çµ±è¨ˆ
        function renderCheckoutStats(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutStats();
                return;
            }

            const totalCheckouts = checkouts.length;
            const totalAmount = checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0);
            const avgAmount = totalAmount / totalCheckouts;
            const maxAmount = Math.max(...checkouts.map(c => c.checkoutAmount));
            
            // è¨ˆç®—ç´¯è¨ˆç›ˆåˆ© - ä½¿ç”¨ç•¶æœŸç›ˆåˆ©è¨˜éŒ„åŠ ç¸½
            const totalProfit = checkouts.reduce((sum, checkout) => {
                const periodProfit = checkout.periodProfit || {};
                return sum + (periodProfit.netProfit || 0);
            }, 0);

            document.getElementById('total-checkouts').textContent = totalCheckouts.toLocaleString();
            document.getElementById('avg-checkout-amount').textContent = `${Math.round(avgAmount).toLocaleString()} å…ƒ`;
            document.getElementById('max-checkout-amount').textContent = `${maxAmount.toLocaleString()} å…ƒ`;
            
            // æ›´æ–°ç´¯è¨ˆç›ˆåˆ©é¡¯ç¤º
            const profitColor = totalProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const totalProfitElement = document.getElementById('total-profit-summary');
            totalProfitElement.textContent = `${totalProfit.toLocaleString()} å…ƒ`;
            totalProfitElement.className = `text-2xl font-bold ${profitColor}`;
        }

        // æ¸…ç©ºåœ–è¡¨
        function clearCheckoutCharts() {
            const emptyChartHtml = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-gray-500 text-sm">æš«ç„¡æ•¸æ“šå¯é¡¯ç¤ºåœ–è¡¨</p>
                        <p class="text-gray-600 text-xs mt-1">å®Œæˆé¦–æ¬¡çµå¸³å¾Œå°‡é¡¯ç¤ºè¶¨å‹¢åœ–</p>
                    </div>
                </div>
            `;
            document.getElementById('checkout-amount-chart').innerHTML = emptyChartHtml;
            document.getElementById('checkout-cumulative-chart').innerHTML = emptyChartHtml;
        }

        // æ¸…ç©ºçµ±è¨ˆ
        function clearCheckoutStats() {
            document.getElementById('total-checkouts').textContent = '0';
            document.getElementById('avg-checkout-amount').textContent = '0 å…ƒ';
            document.getElementById('max-checkout-amount').textContent = '0 å…ƒ';
            document.getElementById('total-profit-summary').textContent = '0 å…ƒ';
            document.getElementById('total-profit-summary').className = 'text-2xl font-bold text-white';
        }


        function updateFooterAndHeader() {
            // æ›´æ–°é é¦–è³‡è¨Š
            const headerEl = document.querySelector('#accounting-header');
            if (headerEl && currentGroupName && currentStoreName) {
                headerEl.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4">
                        ${currentGroupName} - ${currentStoreName} å¸³å‹™ç´€éŒ„
                    </h2>
                `;
            }

            // æ›´æ–°è¡¨æ ¼è¡¨å°¾çµ±è¨ˆ
            const tableFooter = document.querySelector('#accounting-table tfoot');
            if (tableFooter && accountingData && accountingData.length > 0) {
                const totalRevenue = accountingData.reduce((sum, item) => sum + (item.revenue || 0), 0);
                const totalPayouts = accountingData.reduce((sum, item) => sum + (item.payouts || 0), 0);
                const avgCost = accountingData.length > 0 ? 
                    accountingData.reduce((sum, item) => sum + (item.cost || 0), 0) / accountingData.length : 0;

                tableFooter.innerHTML = `
                    <tr class="bg-gray-700/50 font-bold">
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ç¸½è¨ˆ</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">${totalRevenue.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">${totalPayouts.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-blue-400 uppercase tracking-wider">${avgCost.toFixed(2)}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                    </tr>
                `;
            }
        }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        function getPeriodDateRange(period, dateStr) {
            const today = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            switch (period) {
                case 'daily':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'weekly':
                    const day = today.getDay();
                    const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                    startDate = new Date(new Date(today).setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'yearly':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            return {
                startDate: toYYYYMMDD(startDate),
                endDate: toYYYYMMDD(endDate)
            };
        }

        async function getStoreSummaryForPeriod(storeId, period, date) {
            if (period === 'all') {
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('machines').get();
                const machines = machinesSnapshot.docs.map(doc => doc.data());
                return machines.map(m => {
                    const processed = processMachineData(m);
                    return { id: m.id, location: m.location, revenue: processed.revenue, payouts: processed.effectivePayouts, cost: processed.cost };
                });
            }

            const { startDate, endDate } = getPeriodDateRange(period, date);
            
            const historySnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('history').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const filteredHistory = historySnapshot.docs.map(doc => doc.data());

            if (filteredHistory.length === 0) return [];

            const summary = filteredHistory.reduce((acc, curr) => {
                const key = `${curr.machineId}|${curr.location}`;
                if (!acc[key]) {
                     acc[key] = { id: curr.machineId, location: curr.location, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});
            
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        async function handleDownloadAllStoresReport() {
            if(!selectedGroupId) return alert('No group selected.');
            const btn = document.getElementById('download-all-stores-report-btn');
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¦ä¸‹è¼‰çš„é–€å¸‚ã€‚");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>è™•ç†ä¸­...</span>`;
            btn.disabled = true;

            const period = reportPeriodSelector.value;
            const date = reportDatePicker.value;
            const periodText = reportPeriodSelector.options[reportPeriodSelector.selectedIndex].text;

            if (period !== 'all' && !date) {
                alert('è«‹é¸æ“‡ä¸€å€‹åŸºæº–æ—¥æœŸï¼');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const storesToDownload = Array.from(selectedStoreCheckboxes).map(cb => ({
                    id: cb.dataset.storeId,
                    name: cb.dataset.storeName,
                    startDate: cb.dataset.startDate
                }));

                const csvRows = [];
                let grandTotalRevenue = 0;
                let grandTotalPayouts = 0;
                let grandTotalDays = 0;
                let psdCalculated = false;
                
                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    if (summaryData.length > 0) {
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        grandTotalRevenue += storeTotalRevenue;
                        grandTotalPayouts += storeTotalPayouts;
                    }
                }

                const grandTotalAvgCost = grandTotalPayouts > 0 ? grandTotalRevenue / grandTotalPayouts : 0;

                csvRows.push(`æ‰€é¸é–€å¸‚ç‡Ÿé‹ç¸½è¨ˆ - ${periodText}${period !== 'all' ? ' (' + date + ')' : ''}`);
                csvRows.push(`å ±è¡¨ç”¢ç”Ÿæ—¥æœŸ: ${new Date().toLocaleString()}`);
                csvRows.push("");
                csvRows.push("--- å…¨é¸é–€å¸‚ç¸½è¨ˆ ---");
                csvRows.push(["é …ç›®", "ç¸½è¨ˆ"].join(','));
                csvRows.push(["ç¸½ç‡Ÿæ”¶", grandTotalRevenue].join(','));
                csvRows.push(["ç¸½å‡ºè²¨æ•¸", grandTotalPayouts].join(','));
                csvRows.push(["ç¸½å¹³å‡å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)", grandTotalAvgCost.toFixed(2)].join(','));
                
                let grandPsd = 0;
                if (period === 'all') {
                    // Cannot accurately calculate combined PSD for 'all' without a common start date.
                } else {
                    const { startDate, endDate } = getPeriodDateRange(period, date);
                    const d1 = new Date(startDate);
                    const d2 = new Date(endDate);
                    const diffTime = Math.abs(d2 - d1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    grandPsd = grandTotalRevenue / diffDays;
                    csvRows.push([`æœŸé–“PSD (æ¯æ—¥å¹³å‡ç‡Ÿæ”¶)`, `"${grandPsd.toFixed(2)} å…ƒ/å¤©"`].join(","));
                }


                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    
                    csvRows.push("");
                    csvRows.push(`--- ${store.name} ---`);
                    const summaryTableHeaders = ["æ©Ÿå°ç·¨è™Ÿ", "ä½ç½®", "æœŸé–“ç‡Ÿæ”¶", "æœŸé–“å‡ºè²¨æ•¸", "æœŸé–“å‡ºè²¨æˆæœ¬(å…ƒ/æ¬¡)"];
                    csvRows.push(summaryTableHeaders.join(","));

                    if (summaryData.length > 0) {
                        summaryData.forEach(item => {
                            csvRows.push([
                                item.id,
                                `"${item.location}"`,
                                item.revenue,
                                item.payouts,
                                item.cost.toFixed(2)
                            ].join(","));
                        });
                        
                        // Add Store Total and PSD
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        const storeAvgCost = storeTotalPayouts > 0 ? storeTotalRevenue / storeTotalPayouts : 0;
                        
                        csvRows.push(""); // blank line
                        csvRows.push([`é–€å¸‚ç¸½è¨ˆ`, "", storeTotalRevenue, storeTotalPayouts, storeAvgCost.toFixed(2)].join(","));

                        let psd = 0;
                        if (period === 'all') {
                             if (store.startDate) {
                                const storeStartDate = new Date(store.startDate);
                                const today = new Date();
                                const diffTime = Math.abs(today - storeStartDate);
                                const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
                                const machineDocs = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(store.id).collection('machines').get();
                                const machines = machineDocs.docs.map(doc => doc.data());
                                const totalCumulativeRevenue = machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                                psd = totalCumulativeRevenue / diffDays;
                            }
                        } else {
                            const { startDate, endDate } = getPeriodDateRange(period, date);
                            const d1 = new Date(startDate);
                            const d2 = new Date(endDate);
                            const diffTime = Math.abs(d2 - d1);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            psd = storeTotalRevenue / diffDays;
                        }
                         csvRows.push([`é–€å¸‚PSD (æ¯æ—¥å¹³å‡ç‡Ÿæ”¶)`, "", `"${psd.toFixed(2)} å…ƒ/å¤©"`].join(","));


                    } else {
                        csvRows.push("æ­¤æœŸé–“å°šç„¡æ•¸æ“š");
                    }
                }
                
                let csvContent = "\uFEFF";
                csvContent += csvRows.join("\n");

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `${selectedGroupName}-ç‡Ÿé‹å ±è¡¨-${periodText}-${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("ä¸‹è¼‰å…¨é–€å¸‚å ±è¡¨å¤±æ•—:", error);
                alert("ä¸‹è¼‰å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // --- EVENT LISTENERS ---
        
        // ç®¡ç†è€…ç•Œé¢äº‹ä»¶
        adminBtn.addEventListener('click', showAdminPage);
        backToMainBtn.addEventListener('click', hideAdminPage);

        // é é¢æ¬Šé™å¿«æ·æŒ‰éˆ•äº‹ä»¶
        document.getElementById('select-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('select-readonly-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            // åªå‹¾é¸æª¢è¦–ç›¸é—œæ¬Šé™
            const readonlyPermissions = ['details', 'summary', 'analysis', 'charts', 'statistics'];
            readonlyPermissions.forEach(permission => {
                const checkbox = document.querySelector(`.page-permission-checkbox[value="${permission}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        document.getElementById('clear-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
        });

        // ç®¡ç†å“¡å¯†ç¢¼æ›´æ–°
        adminPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newUsername = document.getElementById('new-username').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAdminFeedback('admin-password-feedback', 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', true);
                return;
            }

            try {
                await window.adminConfig.updateAdminCredentials(newUsername, newPassword, currentPassword);
                showAdminFeedback('admin-password-feedback', 'ç®¡ç†å“¡å¸³å¯†æ›´æ–°æˆåŠŸ');
                adminPasswordForm.reset();
                document.getElementById('new-username').value = newUsername;
            } catch (error) {
                showAdminFeedback('admin-password-feedback', error.message, true);
            }
        });

        // è¨ªå®¢å¸³è™Ÿç®¡ç†
        guestAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('guest-username').value;
            const password = document.getElementById('guest-password').value;
            const selectedGroups = Array.from(document.querySelectorAll('.group-permission-checkbox:checked'))
                .map(cb => cb.value);
            const selectedPagePermissions = Array.from(document.querySelectorAll('.page-permission-checkbox:checked'))
                .map(cb => cb.value);

            const isEditing = guestAccountForm.dataset.editingId;

            try {
                if (isEditing) {
                    await window.adminConfig.updateGuestAccount(isEditing, {
                        username,
                        password,
                        allowedGroups: selectedGroups,
                        pagePermissions: selectedPagePermissions
                    });
                    showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿæ›´æ–°æˆåŠŸ');
                    cancelGuestEdit();
                } else {
                    await window.adminConfig.addGuestAccount(username, password, selectedGroups, selectedPagePermissions);
                    showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿæ–°å¢æˆåŠŸ');
                }
                
                guestAccountForm.reset();
                document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
                loadGuestAccountsTable();
            } catch (error) {
                showAdminFeedback('guest-account-feedback', error.message, true);
            }
        });

        // å–æ¶ˆç·¨è¼¯
        cancelGuestEditBtn.addEventListener('click', cancelGuestEdit);

        function cancelGuestEdit() {
            delete guestAccountForm.dataset.editingId;
            guestAccountForm.reset();
            document.querySelectorAll('.group-permission-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            cancelGuestEditBtn.classList.add('hidden');
            guestAccountForm.querySelector('button[type="submit"]').textContent = 'æ–°å¢è¨ªå®¢';
        }

        // è¨ªå®¢å¸³è™Ÿè¡¨æ ¼äº‹ä»¶
        guestAccountsTable.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-guest-btn');
            const deleteBtn = e.target.closest('.delete-guest-btn');

            if (editBtn) {
                const guestId = editBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest) {
                    // å¡«å…¥ç·¨è¼¯è¡¨å–®
                    document.getElementById('guest-username').value = guest.username;
                    document.getElementById('guest-password').value = guest.password;
                    
                    // è¨­å®šç¾¤çµ„æ¬Šé™
                    document.querySelectorAll('.group-permission-checkbox').forEach(cb => {
                        cb.checked = guest.allowedGroups.includes(cb.value);
                    });
                    
                    // è¨­å®šé é¢æ¬Šé™
                    document.querySelectorAll('.page-permission-checkbox').forEach(cb => {
                        cb.checked = (guest.pagePermissions || []).includes(cb.value);
                    });
                    
                    // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
                    guestAccountForm.dataset.editingId = guestId;
                    cancelGuestEditBtn.classList.remove('hidden');
                    guestAccountForm.querySelector('button[type="submit"]').textContent = 'æ›´æ–°è¨ªå®¢';
                }
            } else if (deleteBtn) {
                const guestId = deleteBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest && confirm(`ç¢ºå®šè¦åˆªé™¤è¨ªå®¢å¸³è™Ÿã€Œ${guest.username}ã€å—ï¼Ÿ`)) {
                    try {
                        await window.adminConfig.deleteGuestAccount(guestId);
                        loadGuestAccountsTable();
                        showAdminFeedback('guest-account-feedback', 'è¨ªå®¢å¸³è™Ÿå·²åˆªé™¤');
                    } catch (error) {
                        showAdminFeedback('guest-account-feedback', error.message, true);
                    }
                }
            }
        });

        // ç³»çµ±å·¥å…·äº‹ä»¶
        exportConfigBtn.addEventListener('click', () => {
            const config = window.adminConfig.exportConfig();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        importConfigBtn.addEventListener('click', () => {
            configFileInput.click();
        });

        configFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await window.adminConfig.importConfig(e.target.result);
                        alert('è¨­å®šåŒ¯å…¥æˆåŠŸ');
                        loadAdminInterface();
                    } catch (error) {
                        alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        resetConfigBtn.addEventListener('click', async () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šå—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰è¨ªå®¢å¸³è™Ÿä¸¦æ¢å¾©é è¨­ç®¡ç†å“¡å¯†ç¢¼ã€‚')) {
                await window.adminConfig.resetToDefault();
                alert('ç³»çµ±å·²é‡ç½®ç‚ºé è¨­è¨­å®š');
                loadAdminInterface();
            }
        });

        groupListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.group-card-main');
            const renameBtn = e.target.closest('.rename-group-btn');
            const deleteBtn = e.target.closest('.delete-group-btn');

            if (mainCard) {
                const groupId = mainCard.dataset.groupId;
                const groupName = mainCard.dataset.groupName;
                showStoreSelectionPage(groupId, groupName);
            } else if (renameBtn) {
                const groupId = renameBtn.dataset.groupId;
                const groupName = renameBtn.dataset.groupName;
                handleRenameGroup(groupId, groupName);
            } else if (deleteBtn) {
                const groupId = deleteBtn.dataset.groupId;
                const groupName = deleteBtn.dataset.groupName;
                handleDeleteGroup(groupId, groupName);
            }
        });

        storeListContainer.addEventListener('click', async (e) => {
            const mainCard = e.target.closest('.store-card-main');
            const editBtn = e.target.closest('.edit-store-btn');
            const cloneBtn = e.target.closest('.clone-store-btn');
            const deleteBtn = e.target.closest('.delete-store-btn');

            if (mainCard) {
                const storeId = mainCard.dataset.storeId;
                const storeName = mainCard.dataset.storeName;
                const startDate = mainCard.dataset.startDate;
                await showReportPage(storeId, storeName, startDate);
            } else if (editBtn) {
                document.getElementById('edit-store-id').value = editBtn.dataset.storeId;
                document.getElementById('edit-store-name').value = editBtn.dataset.storeName;
                document.getElementById('edit-store-start-date').value = editBtn.dataset.startDate;
                editStoreModal.classList.remove('hidden');
            } else if (cloneBtn) {
                document.getElementById('clone-source-store-id').value = cloneBtn.dataset.storeId;
                document.getElementById('clone-source-store-name').textContent = cloneBtn.dataset.storeName;
                document.getElementById('clone-store-name').value = cloneBtn.dataset.storeName + ' (è¤‡è£½)';
                document.getElementById('clone-store-start-date').valueAsDate = new Date();
                cloneStoreModal.classList.remove('hidden');
            } else if (deleteBtn) {
                const storeId = deleteBtn.dataset.storeId;
                const storeName = deleteBtn.dataset.storeName;
                handleDeleteStore(storeId, storeName);
            }
        });
        
        selectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = true);
        });

        deselectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = false);
        });

        createGroupForm.addEventListener('submit', handleCreateGroup);
        createStoreForm.addEventListener('submit', handleCreateStore);
        editStoreForm.addEventListener('submit', handleUpdateStore);
        editStoreCancelBtn.addEventListener('click', () => editStoreModal.classList.add('hidden'));
        
        cloneStoreForm.addEventListener('submit', handleCloneStore);
        cloneStoreCancelBtn.addEventListener('click', () => cloneStoreModal.classList.add('hidden'));

        addMachineForm.addEventListener('submit', handleAddMachine);
        downloadAllStoresBtn.addEventListener('click', () => {
            if (!selectedGroupId) {
                alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„');
                return;
            }
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦åŒ…å«åœ¨å ±è¡¨ä¸­çš„é–€å¸‚');
                return;
            }
            
            showCustomStoreReportModal();
        });
        if (openStoreReportViewBtn) {
            openStoreReportViewBtn.addEventListener('click', openStoresLiveReportView);
        }
        if (openWeeklyTrendBtn) {
            openWeeklyTrendBtn.addEventListener('click', openWeeklyTrendReport);
        }
        if (openMultiWeeklyTrendBtn) {
            openMultiWeeklyTrendBtn.addEventListener('click', openMultiStoreWeeklyTrendReport);
        }
        trendChartDatePicker.addEventListener('change', renderTrendChartByDate);

        locationPresets.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-tag')) {
                document.getElementById('new-machine-location').value = e.target.textContent;
            }
        });

        // ç¶å®šã€Œç«‹å³è¼ªè©¢æ‰€æœ‰é–€å¸‚ã€æŒ‰éˆ•
        if (pollAllStoresBtn) {
            pollAllStoresBtn.addEventListener('click', pollAllStoresMachines);
        }

        // ç¶å®šã€Œç«‹å³è®€å–æ‰€æœ‰é–€å¸‚ã€æŒ‰éˆ•
        if (readAllStoresBtn) {
            readAllStoresBtn.addEventListener('click', readAllStoresMachines);
        }

        // ğŸš€ ç¶å®šã€Œä¸€éµå…¨è‡ªå‹•æ›´æ–°ã€æŒ‰éˆ•
        const autoUpdateAllStoresBtn = document.getElementById('auto-update-all-stores-btn');
        if (autoUpdateAllStoresBtn) {
            autoUpdateAllStoresBtn.addEventListener('click', autoUpdateAllStores);
        }

        // ğŸ§ª ç¶å®šã€Œæ¸¬è©¦è®€å–æ‰€æœ‰é–€å¸‚ã€æŒ‰éˆ• (åªè™•ç†å‰4çµ„)
        const readAllStoresTestBtn = document.getElementById('read-all-stores-test-btn');
        if (readAllStoresTestBtn) {
            readAllStoresTestBtn.addEventListener('click', () => {
                readAllStoresMachines(4); // åªè™•ç†å‰4çµ„
            });
        }

        reportPeriodSelector.addEventListener('change', () => {
            if (reportPeriodSelector.value === 'all') {
                reportDatePicker.classList.add('hidden');
            } else {
                reportDatePicker.classList.remove('hidden');
                if (!reportDatePicker.value) {
                    reportDatePicker.valueAsDate = new Date();
                }
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
        });
        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        
        machineListTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-machine-btn')) {
                handleDeleteMachine(e.target.dataset.docId);
            } else if (e.target.classList.contains('edit-machine-btn')) {
                console.log('ğŸ”§ ä¿®æ”¹æŒ‰éˆ•è¢«é»æ“Š');
                const btn = e.target;
                console.log('æŒ‰éˆ•è³‡æ–™:', btn.dataset);
                
                // å¡«å…¥åŸºæœ¬è³‡æ–™
                document.getElementById('edit-machine-doc-id').value = btn.dataset.docId;
                document.getElementById('edit-machine-id').value = btn.dataset.id;
                document.getElementById('edit-machine-location').value = btn.dataset.location;
                document.getElementById('edit-machine-mac').value = btn.dataset.mac || '';
                document.getElementById('edit-machine-devid').value = btn.dataset.devid || '1';
                document.getElementById('edit-machine-initial-plays').value = btn.dataset.initialPlays;
                document.getElementById('edit-machine-initial-payouts').value = btn.dataset.initialPayouts;
                document.getElementById('edit-machine-plays-calibration').value = btn.dataset.playsCalibration || '0';
                document.getElementById('edit-machine-payouts-calibration').value = btn.dataset.payoutsCalibration || '0';
                
                // è¨ˆç®—ä¸¦é¡¯ç¤ºç•¶å‰æ•¸æ“š
                updateCurrentMachineStatsWithPreview(btn.dataset.docId);
                
                console.log('é¡¯ç¤ºä¿®æ”¹æ¨¡æ…‹æ¡†');
                editMachineModal.classList.remove('hidden');
            } else if (e.target.classList.contains('poll-machine-btn')) {
                const btn = e.target;
                const mac = btn.dataset.mac;
                const devid = btn.dataset.devid;
                
                if (!mac) {
                    alert('è«‹å…ˆè¨­å®šæ©Ÿå° MAC ä½å€');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'ğŸ“Š';
                btn.classList.add('opacity-50');
                
                try {
                    await pollSingleMachine(mac, devid || 1);
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            }
        });
        editMachineForm.addEventListener('submit', handleUpdateMachine);
        editMachineCancelBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));
        
        // æ·»åŠ ç·¨è¼¯æ©Ÿå°æ¨¡æ…‹æ¡†é—œé–‰æŒ‰éˆ•äº‹ä»¶
        const editMachineCloseBtn = document.getElementById('edit-machine-close-btn');
        if (editMachineCloseBtn) {
            editMachineCloseBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));
        }
        
        // æ·»åŠ æ ¡æ­£å€¼å³æ™‚é è¦½åŠŸèƒ½
        const editPlaysCalibrationInput = document.getElementById('edit-machine-plays-calibration');
        const editPayoutsCalibrationInput = document.getElementById('edit-machine-payouts-calibration');
        
        if (editPlaysCalibrationInput && editPayoutsCalibrationInput) {
            [editPlaysCalibrationInput, editPayoutsCalibrationInput].forEach(input => {
                input.addEventListener('input', () => {
                    const docId = document.getElementById('edit-machine-doc-id').value;
                    if (docId) {
                        updateCurrentMachineStatsWithPreview(docId);
                    }
                });
            });
        }

        historyTableBody.addEventListener('click', (e) => {
            const button = e.target;
            if (button.classList.contains('delete-history-btn')) {
                handleDeleteHistory(button.dataset.docId, button.dataset.machineId, button.dataset.location, parseInt(button.dataset.plays, 10), parseInt(button.dataset.payouts, 10));
            } else if (button.classList.contains('edit-history-btn')) {
                document.getElementById('edit-history-doc-id').value = button.dataset.docId;
                document.getElementById('edit-history-machine-id').value = button.dataset.machineId;
                document.getElementById('edit-history-location').value = button.dataset.location;
                document.getElementById('edit-history-old-plays').value = button.dataset.plays;
                document.getElementById('edit-history-old-payouts').value = button.dataset.payouts;
                document.getElementById('edit-history-date').value = button.dataset.date || '';
                document.getElementById('edit-history-plays').value = button.dataset.plays;
                document.getElementById('edit-history-payouts').value = button.dataset.payouts;
                editHistoryModal.classList.remove('hidden');
            }
        });
        editHistoryForm.addEventListener('submit', handleUpdateHistory);
        editHistoryCancelBtn.addEventListener('click', () => editHistoryModal.classList.add('hidden'));
        
        backToGroupsBtn.addEventListener('click', showGroupSelectionPage);
        backToStoresBtn.addEventListener('click', () => showStoreSelectionPage(selectedGroupId, selectedGroupName));

        allTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                const activeContent = document.getElementById(tab.dataset.tab);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                if (tab.dataset.tab === 'charts') { await renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
                if (tab.dataset.tab === 'summary') { await renderSummaryTab(); }
                if (tab.dataset.tab === 'analysis') { renderAnalysisTab(); }
                 if (tab.dataset.tab === 'checkout') { 
                    headerDownloadButtons.classList.add('hidden');
                    renderCheckoutTab(); 
                } else {
                    headerDownloadButtons.classList.remove('hidden');
                }
            });
        });

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        summaryControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                summaryControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderSummaryTab();
            }
        });
        
        psdControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const customRange = document.getElementById('psd-custom-range');
                if(e.target.dataset.period === 'custom'){
                    customRange.classList.remove('hidden');
                    customRange.classList.add('flex');
                } else {
                    customRange.classList.add('hidden');
                    customRange.classList.remove('flex');
                    e.target.classList.add('active');
                    renderAnalysisTab();
                }
            }
        });

        psdCalculateBtn.addEventListener('click', () => {
            const start = psdStartDate.value;
            const end = psdEndDate.value;
            if (start && end && start <= end) {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                renderAnalysisTab({start, end});
            } else {
                alert('è«‹é¸æ“‡æœ‰æ•ˆçš„èµ·è¨–æ—¥æœŸï¼');
            }
        });

        // PSD å‘¨å ±æ¯”è¼ƒæŒ‰éˆ•
        if (psdWeeklyTrendBtn) {
            psdWeeklyTrendBtn.addEventListener('click', async () => {
                const start = psdStartDate.value;
                const end = psdEndDate.value;
                
                if (!start || !end) {
                    alert('è«‹å…ˆé¸æ“‡èµ·è¨–æ—¥æœŸï¼');
                    return;
                }
                
                if (start > end) {
                    alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼');
                    return;
                }
                
                if (!selectedStoreId) {
                    alert('è«‹å…ˆé¸æ“‡é–€å¸‚ï¼');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥æç¤º
                pdfLoaderText.textContent = 'æ­£åœ¨ç”ŸæˆPSDå‘¨å ±æ¯”è¼ƒ...';
                pdfLoaderOverlay.classList.remove('hidden');
                pdfLoaderOverlay.classList.add('flex');
                
                try {
                    const weeks = await calculateWeeklyTrends(selectedStoreId, start, end);
                    
                    if (weeks.length === 0) {
                        alert('æ‰€é¸æ—¥æœŸç¯„åœå…§æ²’æœ‰æ•¸æ“š');
                        return;
                    }
                    
                    const html = generateWeeklyTrendHTML({
                        storeName: selectedStoreName,
                        weeks,
                        dateRange: `${start} ~ ${end}`,
                        groupName: selectedGroupName || ''
                    });
                    
                    const w = window.open('', '_blank');
                    if (!w) { alert('ç€è¦½å™¨å°é–äº†å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™é–‹å•Ÿæ–°åˆ†é '); return; }
                    w.document.open();
                    w.document.write(html);
                    w.document.close();
                } catch (error) {
                    console.error('ç”ŸæˆPSDå‘¨å ±æ¯”è¼ƒå¤±æ•—:', error);
                    alert('ç”Ÿæˆå ±è¡¨å¤±æ•—: ' + error.message);
                } finally {
                    pdfLoaderOverlay.classList.add('hidden');
                    pdfLoaderOverlay.classList.remove('flex');
                }
            });
        }

        // --- HTTP é€£æ¥ç‹€æ…‹ç®¡ç† (å·²åœç”¨ MQTT) ---
        // MQTT æŒ‰éˆ•äº‹ä»¶å·²åœç”¨ï¼Œæ”¹ç”¨ HTTP æ–¹å¼
        // const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        // if (mqttConnectBtn) {
        //     mqttConnectBtn.addEventListener('click', function() { /* MQTT å·²åœç”¨ */ });
        // }
        
        // HTTP æ¸¬è©¦é€£ç·šæŒ‰éˆ•
        const mqttTestBtn = document.getElementById('mqtt-test-btn');
        if (mqttTestBtn) {
            mqttTestBtn.addEventListener('click', async function() {
                // æ¸¬è©¦ HTTP é€£ç·š
                await testHttpConnection();
            });
        }

        // ç«‹å³è¼ªè©¢æ‰€æœ‰æ©Ÿå°æŒ‰éˆ•
        const pollAllBtn = document.getElementById('poll-all-btn');
        if (pollAllBtn) {
            pollAllBtn.addEventListener('click', async function() {
                console.log('ç«‹å³è¼ªè©¢æŒ‰éˆ•è¢«é»æ“Š');
                await executePollAllMachines();
            });
        }

        // ğŸ§ª æ¸¬è©¦è¼ªè©¢æŒ‰éˆ• (åªè™•ç†å‰4çµ„)
        const pollTestBtn = document.getElementById('poll-test-btn');
        if (pollTestBtn) {
            pollTestBtn.addEventListener('click', async function() {
                console.log('ğŸ§ª æ¸¬è©¦è¼ªè©¢æŒ‰éˆ•è¢«é»æ“Š (åªè™•ç†å‰4çµ„)');
                await executePollAllMachines(4); // å‚³å…¥é™åˆ¶æ•¸é‡
            });
        }

        // âš¡ å¿«é€Ÿè®€å–æŒ‰éˆ• (è·³éç™¼é€æŸ¥è©¢,ç›´æ¥è®€å–)
        const quickReadBtn = document.getElementById('quick-read-btn');
        if (quickReadBtn) {
            quickReadBtn.addEventListener('click', async function() {
                console.log('âš¡ å¿«é€Ÿè®€å–æŒ‰éˆ•è¢«é»æ“Š (è·³éæŸ¥è©¢,ç›´æ¥è®€å–)');
                await quickReadAllMachines(); // ç›´æ¥è®€å–,ä¸é™åˆ¶æ•¸é‡
            });
        }

        // èª¿è©¦æ˜ å°„è¡¨æŒ‰éˆ•
        const debugMappingBtn = document.getElementById('debug-mapping-btn');
        if (debugMappingBtn) {
            debugMappingBtn.addEventListener('click', function() {
                console.log('ğŸ” èª¿è©¦æ˜ å°„è¡¨æŒ‰éˆ•è¢«é»æ“Š');
                debugMachineMapping();
            });
        }

        // å¾è¼ªè©¢å¸¶å…¥æŒ‰éˆ•
        const importFromPollBtn = document.getElementById('import-from-poll-btn');
        if (importFromPollBtn) {
            importFromPollBtn.addEventListener('click', function() {
                console.log('ğŸ“¥ å¾è¼ªè©¢å¸¶å…¥æŒ‰éˆ•è¢«é»æ“Š');
                importFromPoll();
            });
        }

        // æ‰¹é‡æ–°å¢æ‰€æœ‰æ©Ÿå°æŒ‰éˆ•
        const batchAddAllBtn = document.getElementById('batch-add-all-btn');
        if (batchAddAllBtn) {
            batchAddAllBtn.addEventListener('click', function() {
                console.log('âœ… æ‰¹é‡æ–°å¢æŒ‰éˆ•è¢«é»æ“Š');
                batchAddAllMachines();
            });
        }

        // ğŸš€ æ‰¹æ¬¡è™•ç†è¨­å®šæŒ‰éˆ•
        const setBatchSizeBtn = document.getElementById('set-batch-size-btn');
        if (setBatchSizeBtn) {
            setBatchSizeBtn.addEventListener('click', function() {
                const input = document.getElementById('batch-size-input');
                const size = parseInt(input.value) || 50;
                window.setBatchSize(size);
                updateBatchStatusDisplay();
                console.log(`ğŸ“Š æ‰¹æ¬¡å¤§å°å·²è¨­å®šç‚º: ${size}`);
            });
        }

        // ğŸš€ ç„¡é™åˆ¶æ¨¡å¼æŒ‰éˆ•
        const unlimitedModeBtn = document.getElementById('unlimited-mode-btn');
        if (unlimitedModeBtn) {
            unlimitedModeBtn.addEventListener('click', function() {
                const isUnlimited = !window.unlimitedBatchMode;
                window.enableUnlimitedBatch(isUnlimited);
                updateBatchStatusDisplay();
                
                if (isUnlimited) {
                    unlimitedModeBtn.textContent = 'âš¡ ç„¡é™åˆ¶æ¨¡å¼ (å·²å•Ÿç”¨)';
                    unlimitedModeBtn.className = 'bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded';
                } else {
                    unlimitedModeBtn.textContent = 'ğŸš€ ç„¡é™åˆ¶æ¨¡å¼';
                    unlimitedModeBtn.className = 'bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded';
                }
            });
        }

        // ğŸ“Š æª¢æŸ¥æ‰¹æ¬¡ç‹€æ…‹æŒ‰éˆ•
        const checkBatchStatusBtn = document.getElementById('check-batch-status-btn');
        if (checkBatchStatusBtn) {
            checkBatchStatusBtn.addEventListener('click', function() {
                const status = window.getBatchStatus();
                updateBatchStatusDisplay();
                alert(`æ‰¹æ¬¡è™•ç†ç‹€æ…‹ï¼š
æ‰¹æ¬¡å¤§å°: ${status.batchSize}
ç„¡é™åˆ¶æ¨¡å¼: ${status.unlimitedMode ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}
è¼ªè©¢è¨˜éŒ„æ•¸: ${status.recordCount}
æ©Ÿå°æ•¸é‡: ${status.machineCount}`);
            });
        }

        // ğŸ”„ æ›´æ–°æ‰¹æ¬¡ç‹€æ…‹é¡¯ç¤º
        function updateBatchStatusDisplay() {
            const display = document.getElementById('batch-status-display');
            if (display) {
                const batchSize = window.batchProcessingSize || 50;
                const mode = window.unlimitedBatchMode ? 'ç„¡é™åˆ¶' : 'æ¨™æº–';
                const recordCount = window.dailyRecords ? Object.keys(window.dailyRecords).length : 0;
                display.textContent = `ç›®å‰æ‰¹æ¬¡å¤§å°: ${batchSize} | æ¨¡å¼: ${mode} | è¼ªè©¢è¨˜éŒ„: ${recordCount} ç­†`;
            }
        }

        // åˆå§‹åŒ–æ‰¹æ¬¡ç‹€æ…‹é¡¯ç¤º
        updateBatchStatusDisplay();

        // ç™¼é€è®€å–å‘½ä»¤æŒ‰éˆ•ï¼ˆä½¿ç”¨ HTTPï¼‰
        const sendReadCmd = document.getElementById('send-read-command');
        if (sendReadCmd) {
            sendReadCmd.addEventListener('click', async function() {
                try {
                    // ç²å–ç”¨æˆ¶è¼¸å…¥çš„ MAC åœ°å€
                    const mac = document.getElementById('read-machine-mac').value.trim();
                    const devid = document.getElementById('read-device-id').value || 1;
                    
                    // é©—è­‰ MAC åœ°å€
                    if (!mac) {
                        alert('âŒ è«‹è¼¸å…¥æ©Ÿå° MAC ä½å€');
                        return;
                    }
                    
                    // æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹
                    this.disabled = true;
                    this.innerHTML = 'ğŸ”„ ç™¼é€ä¸­...';
                    
                    // è¨˜éŒ„åˆ°å‘½ä»¤æ—¥èªŒ
                    addCommandLog('send', `ç™¼é€ HTTP GET è«‹æ±‚ - MAC: ${mac}`);
                    
                    // ç™¼é€ HTTP è«‹æ±‚
                    const result = await sendHttpRequest(mac);
                    
                    if (result) {
                        addCommandLog('receive', `HTTP è«‹æ±‚æˆåŠŸ - MAC: ${mac}`, result);
                    }
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    this.disabled = false;
                    this.innerHTML = 'ğŸ“¤ æ¸¬è©¦æŸ¥è©¢';
                    
                } catch (error) {
                    console.error('âŒ HTTP è«‹æ±‚åŸ·è¡ŒéŒ¯èª¤:', error);
                    alert('âŒ HTTP è«‹æ±‚åŸ·è¡ŒéŒ¯èª¤: ' + error.message);
                    addCommandLog('error', 'åŸ·è¡ŒéŒ¯èª¤: ' + error.message);
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    this.disabled = false;
                    this.innerHTML = 'ğŸ“¤ æ¸¬è©¦æŸ¥è©¢';
                }
            });
        }

        // æ©Ÿå°é¸æ“‡å™¨è®Šæ›´äº‹ä»¶
        const machineSelector = document.getElementById('machine-selector');
        if (machineSelector) {
            machineSelector.addEventListener('change', (e) => {
                const selectedDocId = e.target.value;
                if(!selectedDocId) return;

                const selectedMachine = appData.machines.find(m => m.docId === selectedDocId);
                if (selectedMachine) {
                    document.getElementById('cumulative-plays').value = selectedMachine.plays;
                    document.getElementById('cumulative-payouts').value = selectedMachine.payouts;
                    document.getElementById('cumulative-plays').focus();
                }
            });
        }
        
        // æ—¥å¸¸ç´€éŒ„è¡¨å–®æäº¤
        const dailyEntryForm = document.getElementById('daily-entry-form');
        if (dailyEntryForm) {
            dailyEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedStoreId) {
                    return showFeedback('éŒ¯èª¤ï¼šæœªé¸æ“‡ä»»ä½•é–€å¸‚ã€‚', true);
                }
                
                const date = document.getElementById('entry-date').value;
                const machineSelector = document.getElementById('machine-selector');
                const machineDocId = machineSelector.value;

                if (!machineDocId) {
                     console.error('âŒ æ©Ÿå°é¸æ“‡å™¨æœªé¸æ“‡', {
                        selectorValue: machineSelector.value,
                        selectedOptions: machineSelector.selectedOptions.length,
                        options: machineSelector.options.length
                     });
                     return showFeedback('éŒ¯èª¤ï¼šè«‹é¸æ“‡ä¸€å°æ©Ÿå°ã€‚', true);
                }

                const selectedMachine = appData.machines.find(m => m.docId === machineDocId);

                const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
                const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

                if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                    return showFeedback('éŒ¯èª¤ï¼šè«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚', true);
                }

                if (!selectedMachine) { return showFeedback('éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥æ‰€é¸æ©Ÿå°ã€‚', true); }

                const lastRecordedPlays = normalizeCount(selectedMachine.plays);
                const lastRecordedPayouts = normalizeCount(selectedMachine.payouts);
                const initialPlays = normalizeCount(selectedMachine.initialPlays);
                const initialPayouts = normalizeCount(selectedMachine.initialPayouts);
                const baselinePlays = Math.max(lastRecordedPlays, initialPlays);
                const baselinePayouts = Math.max(lastRecordedPayouts, initialPayouts);

                if (cumulativePlaysInput < baselinePlays || cumulativePayoutsInput < baselinePayouts) {
                    return showFeedback(`éŒ¯èª¤ï¼šè¼¸å…¥çš„ç´¯ç©æ•¸å€¼ä¸å¯å°æ–¼åŸºæº–å€¼ (æŠ•å¹£: ${baselinePlays}, å‡ºè²¨: ${baselinePayouts})ã€‚`, true);
                }


            const dailyPlays = cumulativePlaysInput - baselinePlays;
            const dailyPayouts = cumulativePayoutsInput - baselinePayouts;
            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('æ•¸æ“šæœªè®Šæ›´ï¼Œç„¡éœ€æ–°å¢ç´€éŒ„ã€‚');
            }

            try {
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ—¥æœŸå’Œæ©Ÿå°çš„æ­·å²è¨˜éŒ„
                console.log(`ğŸ” æŸ¥è©¢æ¢ä»¶: date=${date}, machineId=${selectedMachine.id}, location=${selectedMachine.location}`);
                
                const historyQuery = db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(selectedStoreId)
                    .collection('history');
                
                let existingRecords = null;
                let updateMode = false;
                
                try {
                    // å˜—è©¦è¤‡åˆæŸ¥è©¢
                    existingRecords = await historyQuery
                        .where('date', '==', date)
                        .where('machineId', '==', selectedMachine.id)
                        .where('location', '==', selectedMachine.location)
                        .get();
                    
                    console.log(`ğŸ“‹ è¤‡åˆæŸ¥è©¢çµæœ: ${existingRecords.docs.length} ç­†è¨˜éŒ„`);
                    
                } catch (queryError) {
                    // å¦‚æœè¤‡åˆæŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½ç¼ºå°‘ç´¢å¼•ï¼‰ï¼Œä½¿ç”¨å–®å€‹æŸ¥è©¢é€ä¸€æª¢æŸ¥
                    console.warn(`âš ï¸ è¤‡åˆæŸ¥è©¢å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ: ${queryError.message}`);
                    const allRecords = await historyQuery.get();
                    const filtered = allRecords.docs.filter(doc => {
                        const data = doc.data();
                        return data.date === date && 
                               data.machineId === selectedMachine.id && 
                               data.location === selectedMachine.location;
                    });
                    existingRecords = { docs: filtered };
                    console.log(`ğŸ“‹ å‚™ç”¨æŸ¥è©¢çµæœ: ${filtered.length} ç­†è¨˜éŒ„`);
                }
                
                if (existingRecords.docs.length > 0) {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    updateMode = true;
                    const docId = existingRecords.docs[0].id;
                    console.log(`ğŸ”„ æ‰¾åˆ°ç¾æœ‰è¨˜éŒ„ï¼Œæº–å‚™æ›´æ–°: ${docId}`);
                    
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history').doc(docId)
                        .update({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`âœ… å·²æ›´æ–°è¨˜éŒ„: ${docId}`);
                } else {
                    // æ–°å¢æ–°è¨˜éŒ„
                    console.log(`ğŸ“ æœªæ‰¾åˆ°ç¾æœ‰è¨˜éŒ„ï¼Œæº–å‚™æ–°å¢`);
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history')
                        .add({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`âœ… å·²æ–°å¢è¨˜éŒ„`);
                }
                
                await loadStoreData(); 
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const actionType = updateMode ? 'æ›´æ–°' : 'æ–°å¢';
                const successMessage = `ç´€éŒ„å·²${actionType}ä¸¦åŒæ­¥è‡³ [${selectedStoreName}]ï¼æœ¬æ—¥ ${selectedMachine.id} æ–°å¢ï¼š<strong class="text-white">${dailyPlays}</strong> æŠ•å¹£ã€<strong class="text-white">${dailyPayouts}</strong> å‡ºè²¨ã€‚`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("å¯«å…¥ Firestore æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                showFeedback("ç„¡æ³•å°‡ç´€éŒ„åŒæ­¥è‡³é›²ç«¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", true);
            }
            });
        }
        
        // æœå°‹è¼¸å…¥æ¡†äº‹ä»¶
        const searchInputElem = document.getElementById('search-input') || searchInput;
        if (searchInputElem) {
            searchInputElem.addEventListener('input', async () => await updateUI());
        }
        sortableHeaders.forEach(header => {
            header.addEventListener('click', async () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    if(h !== header) h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? 'â–²' : 'â–¼';
                await updateUI();
            });
        });
        
        recalculateAllBtn.addEventListener('click', async () => {
            if (!selectedStoreId) return;

            pdfLoaderText.textContent = 'æ­£åœ¨é‡æ–°æ•´ç†èˆ‡è¨ˆç®—æ‰€æœ‰æ•¸æ“š...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                await loadStoreData(); // This function already re-fetches and calls updateUI()
                showFeedback("æ‰€æœ‰æ•¸æ“šå·²æˆåŠŸé‡æ–°è¨ˆç®—ä¸¦æ›´æ–°ï¼", false);
            } catch (error) {
                console.error("é‡æ–°è¨ˆç®—å¤±æ•—:", error);
                showFeedback("æ•¸æ“šæ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        downloadPdfBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active');
            if (!activeTab) return;

            const tabId = activeTab.dataset.tab;
            const tabName = activeTab.textContent;

            if (tabId === 'accounting' || tabId === 'machines' || tabId === 'checkout') {
                alert('æ­¤é é¢ä¸æ”¯æ´ PDF åŒ¯å‡ºã€‚è«‹é¸æ“‡ä¸€å€‹å ±è¡¨é ç±¤ã€‚');
                return;
            }

            pdfLoaderText.textContent = `æ­£åœ¨ç”Ÿæˆã€Œ${tabName}ã€å ±è¡¨...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById(tabId);
                const originalScrollTop = content.scrollTop;
                content.scrollTop = 0; // Ensure we capture from the top

                const canvas = await html2canvas(content, {
                    backgroundColor: '#1f2937',
                    scale: 2,
                    useCORS: true,
                    windowHeight: content.scrollHeight
                });
                content.scrollTop = originalScrollTop; // Restore scroll

                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const margin = 10;

                const imgProps = doc.getImageProperties(imgData);
                const imgWidth = pdfWidth - margin * 2;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 30);

                while (heightLeft > 0) {
                    doc.addPage();
                    position -= (pdfHeight - 30);
                    doc.addImage(imgData, 'PNG', margin, position + 20, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 30);
                }

                for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                    doc.setPage(i);
                    doc.setFontSize(14);
                    doc.setTextColor(150);
                    doc.text(selectedStoreName, margin, 15);
                    doc.setFontSize(10);
                    doc.text(`å ±è¡¨ç”Ÿæˆæ—¥æœŸ: ${new Date().toLocaleDateString()}`, pdfWidth - margin, 15, { align: 'right' });
                    doc.setFontSize(8);
                    doc.text(`ç¬¬ ${i} é  / å…± ${doc.internal.getNumberOfPages()} é `, pdfWidth / 2, pdfHeight - margin, { align: 'center' });
                }
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                doc.save(`${selectedStoreName}-${tabName}-å ±å‘Š-${dateString}.pdf`);

            } catch (error) {
                console.error("PDF ç”Ÿæˆå¤±æ•—:", error);
                alert("ç”Ÿæˆ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            if (!selectedStoreId) {
                showFeedback("è«‹å…ˆé¸æ“‡é–€å¸‚å†ä¸‹è¼‰å ±å‘Šã€‚", true);
                return;
            }

            const processedMachines = appData.machines.map(processMachineData);
            if (processedMachines.length === 0 && appData.history.length === 0) {
                showFeedback("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›ä¸‹è¼‰ã€‚è«‹å…ˆæ–°å¢æ©Ÿå°ä¸¦è¨˜éŒ„æ•¸æ“šã€‚", true);
                return;
            }

            showCustomReportModal();
        });

        // è‡ªå®šç¾©å ±è¡¨æ¨¡æ…‹è¦–çª—äº‹ä»¶ç›£è½å™¨
        customReportCancelBtn.addEventListener('click', hideCustomReportModal);
        
        customReportDownloadBtn.addEventListener('click', generateCustomReport);

        // å¿«é€Ÿé¸æ“‡æŒ‰éˆ•äº‹ä»¶
        selectAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        selectBasicReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, false, false, false, false);
        });

        selectDetailedReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        clearAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(false, false, false, false, false, false, false);
        });

        // æ¨¡æ…‹è¦–çª—é»æ“Šå¤–éƒ¨é—œé–‰
        customReportModal.addEventListener('click', (e) => {
            if (e.target === customReportModal) {
                hideCustomReportModal();
            }
        });

        // è‡ªå®šç¾©é–€å¸‚å ±è¡¨æ¨¡æ…‹è¦–çª—äº‹ä»¶ç›£è½å™¨
        customStoreReportCancelBtn.addEventListener('click', hideCustomStoreReportModal);
        
        customStoreReportDownloadBtn.addEventListener('click', generateCustomStoreReport);

        // é–€å¸‚å ±è¡¨å¿«é€Ÿé¸æ“‡æŒ‰éˆ•äº‹ä»¶
        selectAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        selectBasicStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, false, false, false, false);
        });

        selectDetailedStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        clearAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(false, false, false, false, false, false);
        });

        // é–€å¸‚å ±è¡¨æ¨¡æ…‹è¦–çª—é»æ“Šå¤–éƒ¨é—œé–‰
        customStoreReportModal.addEventListener('click', (e) => {
            if (e.target === customStoreReportModal) {
                hideCustomStoreReportModal();
            }
        });

        performCheckoutBtn.addEventListener('click', handlePerformCheckout);

        // çµ±è¨ˆç¯„åœæ§åˆ¶æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        document.addEventListener('click', async function(e) {
            // çµ±è¨ˆé é¢ç¯„åœæŒ‰éˆ•
            if (e.target.classList.contains('stats-range-btn')) {
                document.querySelectorAll('.stats-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentStatsRange = e.target.dataset.range;
                renderStatisticsTab(); // é‡æ–°æ•´ç†çµ±è¨ˆé é¢
            }
            
            // åœ–è¡¨é é¢ç¯„åœæŒ‰éˆ•
            if (e.target.classList.contains('chart-range-btn')) {
                document.querySelectorAll('.chart-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentChartsRange = e.target.dataset.range;
                await renderChartsTab(); // é‡æ–°æ•´ç†åœ–è¡¨é é¢
            }
            
            // ç‡Ÿæ¥­æ˜ç´°é é¢ç¯„åœæŒ‰éˆ•
            if (e.target.classList.contains('summary-range-btn')) {
                document.querySelectorAll('.summary-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentSummaryRange = e.target.dataset.range;
                renderSummaryTab(); // é‡æ–°æ•´ç†ç‡Ÿæ¥­æ˜ç´°é é¢
            }
        });

        // é‡æ–°æ•´ç†æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        const refreshAllStatsBtn = document.getElementById('refresh-all-stats-btn');

        if (refreshAllStatsBtn) {
            refreshAllStatsBtn.addEventListener('click', async function() {
                console.log('ğŸ”„ æ‰‹å‹•è§¸ç™¼é‡æ–°çµ±è¨ˆæ‰€æœ‰è³‡æ–™...');
                this.innerHTML = 'ğŸ”„ çµ±è¨ˆä¸­...';
                this.disabled = true;
                
                const success = await refreshAllStatistics();
                
                this.innerHTML = 'ğŸ”„ é‡æ–°çµ±è¨ˆå…¨éƒ¨';
                this.disabled = false;
                
                if (success) {
                    showFeedback('âœ… æ‰€æœ‰çµ±è¨ˆè³‡æ–™å·²é‡æ–°æ•´ç†å®Œæˆï¼', false);
                } else {
                    showFeedback('âŒ é‡æ–°çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                }
            });
        }

        // ç›ˆåˆ©è¨ˆç®—ç›¸é—œäº‹ä»¶ç›£è½å™¨
        const calculateProfitBtn = document.getElementById('calculate-profit-btn');
        const saveCostSettingsBtn = document.getElementById('save-cost-settings-btn');
        const giftCostInput = document.getElementById('gift-cost');
        const rentPercentageInput = document.getElementById('rent-percentage');
        const taxPercentageInput = document.getElementById('tax-percentage');

        if (calculateProfitBtn) {
            calculateProfitBtn.addEventListener('click', calculateProfit);
        }

        if (saveCostSettingsBtn) {
            saveCostSettingsBtn.addEventListener('click', saveCostSettings);
        }

        // å³æ™‚è¨ˆç®—åŠŸèƒ½
        [giftCostInput, rentPercentageInput, taxPercentageInput].forEach(input => {
            if (input) {
                input.addEventListener('input', () => {
                    // å»¶é²è¨ˆç®—ä»¥é¿å…éæ–¼é »ç¹çš„æ›´æ–°
                    clearTimeout(window.profitCalculateTimeout);
                    window.profitCalculateTimeout = setTimeout(calculateProfit, 500);
                });
            }
        });

        // è¨ˆç®—ç¯„åœè®Šæ›´äº‹ä»¶
        document.querySelectorAll('input[name="profit-calculation-scope"]').forEach(radio => {
            radio.addEventListener('change', calculateProfit);
        });

        // ç›ˆåˆ©è©³æƒ…æŸ¥çœ‹äº‹ä»¶
        const profitDetailModal = document.getElementById('profit-detail-modal');
        const closeProfitDetailBtn = document.getElementById('close-profit-detail');

        if (closeProfitDetailBtn) {
            closeProfitDetailBtn.addEventListener('click', () => {
                profitDetailModal.classList.add('hidden');
            });
        }

        // çµå¸³æ­·å²è¡¨æ ¼ä¸­çš„ç›ˆåˆ©è©³æƒ…æŒ‰éˆ•äº‹ä»¶
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-profit-detail-btn')) {
                const checkoutData = JSON.parse(e.target.dataset.checkoutData);
                showProfitDetail(checkoutData);
            }
        });

        function showProfitDetail(checkout) {
            const periodProfit = checkout.periodProfit || {};
            const totalProfit = checkout.totalProfit || {};
            
            // ç‡Ÿæ¥­æ•¸æ“š
            document.getElementById('detail-checkout-date').textContent = 
                new Date(checkout.checkoutDate.toDate()).toLocaleString();
            document.getElementById('detail-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} å…ƒ`;
            document.getElementById('detail-payouts').textContent = 
                `${(checkout.checkoutPayouts || 0).toLocaleString()} æ¬¡`;
            
            // æˆæœ¬è¨­å®š
            const costSettings = totalProfit.costSettings || {};
            document.getElementById('detail-gift-cost').textContent = 
                `${costSettings.giftCost || 0} å…ƒ/æ¬¡`;
            document.getElementById('detail-rent-percentage').textContent = 
                `${costSettings.rentPercentage || 0}%`;
            document.getElementById('detail-tax-percentage').textContent = 
                `${costSettings.taxPercentage || 0}%`;
            
            // æˆæœ¬æ˜ç´° (ä½¿ç”¨ç•¶æœŸæ•¸æ“š)
            document.getElementById('detail-total-gift-cost').textContent = 
                `${(periodProfit.giftCost || 0).toLocaleString()} å…ƒ`;
            document.getElementById('detail-total-rent-cost').textContent = 
                `${(periodProfit.rentCost || 0).toLocaleString()} å…ƒ`;
            document.getElementById('detail-total-tax-cost').textContent = 
                `${(periodProfit.taxCost || 0).toLocaleString()} å…ƒ`;
            document.getElementById('detail-total-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} å…ƒ`;
            
            // ç›ˆåˆ©åˆ†æ
            document.getElementById('detail-profit-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} å…ƒ`;
            document.getElementById('detail-profit-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} å…ƒ`;
                
            const netProfit = periodProfit.netProfit || 0;
            const profitColor = netProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const profitMargin = checkout.checkoutAmount > 0 ? 
                (netProfit / checkout.checkoutAmount) * 100 : 0;
                
            document.getElementById('detail-net-profit').textContent = 
                `${netProfit.toLocaleString()} å…ƒ`;
            document.getElementById('detail-net-profit').className = 
                `font-bold text-lg ${profitColor}`;
            document.getElementById('detail-profit-margin').textContent = 
                `${profitMargin.toFixed(2)}%`;
            document.getElementById('detail-profit-margin').className = 
                `font-semibold ${profitColor}`;
            
            profitDetailModal.classList.remove('hidden');
        }

        // ä¸‹è¼‰çµå¸³å ±è¡¨ CSV
        downloadCheckoutCsvBtn.addEventListener('click', async () => {
            if (!selectedGroupId || !selectedStoreId) {
                alert('è«‹å…ˆé¸æ“‡é–€å¸‚');
                return;
            }

            try {
                const btn = downloadCheckoutCsvBtn;
                const originalText = btn.textContent;
                btn.textContent = 'ç”¢ç”Ÿä¸­...';
                btn.disabled = true;

                // ç²å–çµå¸³æ­·å²
                const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                // ç”Ÿæˆ CSV å…§å®¹
                const csvRows = [];
                csvRows.push('\uFEFF'); // UTF-8 BOM
                csvRows.push(`çµå¸³å ±è¡¨ - ${selectedStoreName}`);
                csvRows.push(`å ±è¡¨ç”¢ç”Ÿæ—¥æœŸ: ${new Date().toLocaleString()}`);
                csvRows.push('');
                
                if (checkouts.length === 0) {
                    csvRows.push('å°šç„¡çµå¸³ç´€éŒ„');
                } else {
                    // è¡¨é ­
                    csvRows.push(['çµå¸³æ—¥æœŸ', 'çµå¸³é‡‘é¡', 'ç´¯ç©ç‡Ÿæ”¶', 'æœŸé–“å¤©æ•¸', 'å¹³å‡æ¯æ—¥ç‡Ÿæ”¶'].join(','));
                    
                    // è³‡æ–™è¡Œ
                    checkouts.forEach((checkout, index) => {
                        const checkoutDate = new Date(checkout.checkoutDate.toDate());
                        const prevCheckoutDate = index < checkouts.length - 1 ? 
                            new Date(checkouts[index + 1].checkoutDate.toDate()) : 
                            new Date(appData.startDate);
                        
                        const daysDiff = Math.ceil((checkoutDate - prevCheckoutDate) / (1000 * 60 * 60 * 24));
                        const avgDailyRevenue = daysDiff > 0 ? checkout.checkoutAmount / daysDiff : 0;
                        
                        csvRows.push([
                            checkoutDate.toLocaleString(),
                            checkout.checkoutAmount,
                            checkout.cumulativeRevenueAtCheckout,
                            daysDiff,
                            avgDailyRevenue.toFixed(2)
                        ].join(','));
                    });

                    // çµ±è¨ˆæ‘˜è¦
                    csvRows.push('');
                    csvRows.push('--- çµ±è¨ˆæ‘˜è¦ ---');
                    const totalCheckouts = checkouts.length;
                    const totalRevenue = checkouts.length > 0 ? checkouts[0].cumulativeRevenueAtCheckout : 0;
                    const avgCheckoutAmount = checkouts.length > 0 ? 
                        checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0) / checkouts.length : 0;
                    
                    csvRows.push(`ç¸½çµå¸³æ¬¡æ•¸,${totalCheckouts}`);
                    csvRows.push(`ç´¯ç©ç¸½ç‡Ÿæ”¶,${totalRevenue} å…ƒ`);
                    csvRows.push(`å¹³å‡çµå¸³é‡‘é¡,${avgCheckoutAmount.toFixed(2)} å…ƒ`);
                }

                // ä¸‹è¼‰ CSV
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute('download', `${selectedStoreName}-çµå¸³å ±è¡¨-${dateString}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('ä¸‹è¼‰çµå¸³å ±è¡¨å¤±æ•—:', error);
                alert('ä¸‹è¼‰å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                
                downloadCheckoutCsvBtn.textContent = 'ä¸‹è¼‰çµå¸³å ±è¡¨ (CSV)';
                downloadCheckoutCsvBtn.disabled = false;
            }
        });

        // === æ©Ÿå°è©³ç´°è³‡æ–™é¡¯ç¤ºåŠŸèƒ½ ===
        
        // é¡¯ç¤ºæ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿
        function showMachineDetailPanel(machine, mqttData) {
            console.log('=== é¡¯ç¤ºæ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿ ===');
            console.log('æ©Ÿå°:', machine);
            console.log('MQTT è³‡æ–™:', mqttData);
            
            const panel = document.getElementById('machine-detail-panel');
            console.log('é¢æ¿å…ƒç´ :', panel);
            
            if (!panel) {
                console.error('æ‰¾ä¸åˆ°æ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿å…ƒç´ ï¼');
                alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©³ç´°è³‡æ–™é¢æ¿');
                return;
            }
            
            // æ›´æ–°åŸºæœ¬è³‡æ–™
            document.getElementById('detail-machine-id').textContent = machine.id;
            document.getElementById('detail-mac-address').textContent = machine.mac || '--';
            document.getElementById('detail-device-id').textContent = machine.devid || '--';
            document.getElementById('detail-last-update').textContent = mqttData.parseTime;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç‹€æ…‹å›æ‡‰
            if (mqttData.isStatusOnly) {
                // æ¸…ç©ºè©³ç´°è³‡æ–™ï¼Œåªé¡¯ç¤ºç‹€æ…‹
                ['detail-strong-voltage', 'detail-medium-voltage', 'detail-weak-voltage', 
                 'detail-height-to-top', 'detail-clamp-voltage', 'detail-win-rate-bank',
                 'detail-coin-game-count', 'detail-prize-count', 'detail-amount-1',
                 'detail-amount-2', 'detail-amount-3'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '--';
                });
                
                // é¡¯ç¤ºç‹€æ…‹ä¿¡æ¯
                document.getElementById('detail-raw-hex').textContent = `ç‹€æ…‹å›æ‡‰: ${mqttData.rawHex} (ç‹€æ…‹ç¢¼: ${mqttData.statusCode})`;
            } else {
                // æ›´æ–°é›»å£“è³‡æ–™
                const voltage = mqttData.voltageData || {};
                document.getElementById('detail-strong-voltage').textContent = voltage.strongVoltage || '--';
                document.getElementById('detail-medium-voltage').textContent = voltage.mediumVoltage || '--';
                document.getElementById('detail-weak-voltage').textContent = voltage.weakVoltage || '--';
                document.getElementById('detail-height-to-top').textContent = voltage.heightToTop || '--';
                document.getElementById('detail-clamp-voltage').textContent = voltage.clampVoltage || '--';
                
                // æ›´æ–°ç‡Ÿé‹è³‡æ–™
                const operation = mqttData.operationData || {};
                document.getElementById('detail-win-rate-bank').textContent = operation.winRateBank || '--';
                document.getElementById('detail-coin-game-count').textContent = operation.coinGameCount || '--';
                document.getElementById('detail-prize-count').textContent = operation.prizeCount || '--';
                
                // æ›´æ–°ç´¯åŠ é‡‘é¡
                document.getElementById('detail-amount-1').textContent = operation.accumulatedAmount1 || '--';
                document.getElementById('detail-amount-2').textContent = operation.accumulatedAmount2 || '--';
                document.getElementById('detail-amount-3').textContent = operation.accumulatedAmount3 || '--';
                
                // æ›´æ–°åŸå§‹è³‡æ–™
                document.getElementById('detail-raw-hex').textContent = mqttData.rawHex || '--';
            }
            
            console.log('æº–å‚™é¡¯ç¤ºé¢æ¿...');
            
            // ç¢ºä¿åœ¨æ©Ÿå°ç®¡ç†é ç±¤ä¸‹é¡¯ç¤º
            const machinesTab = document.querySelector('[data-tab="machines"]');
            if (machinesTab && !document.getElementById('machines').classList.contains('hidden')) {
                console.log('ç•¶å‰åœ¨æ©Ÿå°ç®¡ç†é ç±¤');
            } else {
                console.log('åˆ‡æ›åˆ°æ©Ÿå°ç®¡ç†é ç±¤');
                // åˆ‡æ›åˆ°æ©Ÿå°ç®¡ç†é ç±¤
                if (machinesTab) {
                    machinesTab.click();
                }
            }
            
            // é¡¯ç¤ºé¢æ¿
            panel.classList.remove('hidden');
            console.log('é¢æ¿ hidden é¡å·²ç§»é™¤');
            
            // æ»¾å‹•åˆ°é¢æ¿ä½ç½®
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('æ»¾å‹•åˆ°é¢æ¿ä½ç½®');
            
            // æ·»åŠ é«˜äº®æ•ˆæœ
            panel.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => {
                panel.classList.remove('ring-2', 'ring-blue-500');
            }, 2000);
            
            console.log('âœ… æ©Ÿå°è©³ç´°è³‡æ–™é¢æ¿é¡¯ç¤ºå®Œæˆ');
        }
        
        // é—œé–‰è©³ç´°è³‡æ–™é¢æ¿ (å®‰å…¨åˆå§‹åŒ–)
        function initializeDetailPanel() {
            const closeBtn = document.getElementById('close-detail-panel');
            if (closeBtn && !closeBtn._initialized) {
                closeBtn._initialized = true;
                closeBtn.addEventListener('click', () => {
                    document.getElementById('machine-detail-panel').classList.add('hidden');
                });
            }
        }
        
        // === MQTT è¼ªè©¢åŠŸèƒ½ ===
        let pollInterval = null;
        
        // ğŸ”§ è¼ªè©¢æ™‚é–“é–“éš”è¨­å®š
        let pollSettings = {
            cmdInterval: 100,      // è®€å–æŒ‡ä»¤é–“éš” (æ¯«ç§’)
            pollInterval: 10000    // è¼ªè©¢é€±æœŸé–“éš” (æ¯«ç§’)
        };
        
        // å¾ localStorage è¼‰å…¥è¨­å®š
        function loadPollSettings() {
            const saved = localStorage.getItem('pollSettings');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    pollSettings = { ...pollSettings, ...loaded };
                    console.log('ğŸ“‹ å·²è¼‰å…¥è¼ªè©¢è¨­å®š:', pollSettings);
                } catch (e) {
                    console.warn('è¼ªè©¢è¨­å®šè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                }
            }
            updatePollSettingsDisplay();
        }
        
        // ä¿å­˜è¨­å®šåˆ° localStorage
        function savePollSettings() {
            localStorage.setItem('pollSettings', JSON.stringify(pollSettings));
            console.log('âœ… è¼ªè©¢è¨­å®šå·²ä¿å­˜:', pollSettings);
        }
        
        // æ›´æ–° UI é¡¯ç¤º
        function updatePollSettingsDisplay() {
            const cmdDisplay = document.getElementById('cmd-interval-display');
            const pollDisplay = document.getElementById('poll-interval-display');
            
            if (cmdDisplay) {
                cmdDisplay.textContent = `ç›®å‰: ${pollSettings.cmdInterval}ms`;
            }
            if (pollDisplay) {
                pollDisplay.textContent = `ç›®å‰: ${pollSettings.pollInterval / 1000}ç§’`;
            }
        }
        
        // åˆå§‹åŒ– MQTT è¼ªè©¢åŠŸèƒ½ (ç¢ºä¿å…ƒç´ å·²è¼‰å…¥)
        function initializeMqttPolling() {
            try {
                const machineListTableBody = document.getElementById('machine-list-table-body');
                if (!machineListTableBody) {
                    console.warn('machineListTableBody not found, retrying...');
                    setTimeout(initializeMqttPolling, 100);
                    return;
                }

                // âŒ å·²ç§»é™¤ï¼šæ©Ÿå°åˆ—è¡¨ç›´æ¥è¼¸å…¥åŠŸèƒ½ (é˜²æ­¢èª¤è§¸ä¿®æ”¹)
                // ç¾åœ¨åªèƒ½é€éã€Œä¿®æ”¹ã€æŒ‰éˆ•ä¾†ç·¨è¼¯æ©Ÿå°è³‡æ–™
                /*
                // MAC ä½å€è¼¸å…¥æ¡†å³æ™‚æ›´æ–° (ä½¿ç”¨äº‹ä»¶å§”æ´¾é¿å…é‡è¤‡ç›£è½)
                if (!machineListTableBody._mqttInputHandler) {
                    machineListTableBody._mqttInputHandler = true;
                    machineListTableBody.addEventListener('input', async (e) => {
                        // ... å·²ç§»é™¤çš„ç›´æ¥ç·¨è¼¯ä»£ç¢¼ ...
                    });
                }
                */

                console.log('MQTT è¼ªè©¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ– MQTT è¼ªè©¢åŠŸèƒ½å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ– MQTT æ§åˆ¶é¢æ¿äº‹ä»¶ç›£è½å™¨
        function initializeMqttControls() {
            try {
                // è‡ªå‹•è¼ªè©¢æ§åˆ¶ (ä½¿ç”¨æ­£ç¢ºçš„ ID)
                const autoPollCheckbox = document.getElementById('auto-poll-enabled');
                if (autoPollCheckbox && !autoPollCheckbox._initialized) {
                    autoPollCheckbox._initialized = true;
                    autoPollCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            startAutoPolling();
                        } else {
                            stopAutoPolling();
                        }
                    });
                }

                // æ‰‹å‹•è§¸ç™¼è¼ªè©¢ (ä½¿ç”¨æ­£ç¢ºçš„ ID)
                const pollTriggerBtn = document.getElementById('poll-all-btn');
                if (pollTriggerBtn && !pollTriggerBtn._initialized) {
                    pollTriggerBtn._initialized = true;
                    pollTriggerBtn.addEventListener('click', () => {
                        pollAllMachines();
                    });
                }

                // è¼ªè©¢é–“éš”æ›´æ”¹ (ä½¿ç”¨æ­£ç¢ºçš„ ID)
                const intervalSelect = document.getElementById('poll-interval');
                if (intervalSelect && !intervalSelect._initialized) {
                    intervalSelect._initialized = true;
                    intervalSelect.addEventListener('change', (e) => {
                        const autoPoll = document.getElementById('auto-poll-enabled');
                        if (autoPoll && autoPoll.checked) {
                            stopAutoPolling();
                            startAutoPolling();
                        }
                    });
                }
                
                // ğŸš€ è‡ªå‹•è¼ªè©¢å•Ÿå‹•è¨­å®š (æ–°åŠŸèƒ½)
                const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
                if (autoPollOnLoadCheckbox && !autoPollOnLoadCheckbox._initialized) {
                    autoPollOnLoadCheckbox._initialized = true;
                    
                    // è¨­ç½®åˆå§‹ç‹€æ…‹
                    if (selectedGroupId && selectedStoreId) {
                        autoPollOnLoadCheckbox.checked = getAutoPollOnLoadSetting();
                    }
                    
                    autoPollOnLoadCheckbox.addEventListener('change', (e) => {
                        if (selectedGroupId && selectedStoreId) {
                            setAutoPollOnLoadSetting(e.target.checked);
                            
                            if (e.target.checked) {
                                console.log('âœ… å·²å•Ÿç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
                                // é¡¯ç¤ºæç¤º
                                const notification = document.createElement('div');
                                notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                                notification.innerHTML = 'âœ… å·²å•Ÿç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢';
                                document.body.appendChild(notification);
                                
                                setTimeout(() => {
                                    if (notification.parentNode) {
                                        notification.parentNode.removeChild(notification);
                                    }
                                }, 2000);
                            } else {
                                console.log('âŒ å·²åœç”¨é€²å…¥é–€å¸‚è‡ªå‹•è¼ªè©¢åŠŸèƒ½');
                            }
                        }
                    });
                }
                
                console.log('MQTT æ§åˆ¶é¢æ¿åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.warn('åˆå§‹åŒ– MQTT æ§åˆ¶é¢æ¿æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // å–®å°æ©Ÿå°è¼ªè©¢ (HTTP ç‰ˆæœ¬)
        async function pollSingleMachine(mac, devid) {
            console.log('=== å–®å° HTTP è¼ªè©¢ ===');
            
            if (!mac) {
                console.error('MAC åœ°å€ç„¡æ•ˆ');
                return;
            }
            
            // ğŸ”’ å¼·åˆ¶åµæ¸¬ç’°å¢ƒ - ç¢ºä¿æº–ç¢º
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\nğŸ” ç’°å¢ƒåµæ¸¬: å”è­°=${currentProtocol}, æ˜¯å¦HTTPS=${isHttps}, GitHub Pages=${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`ğŸ”’ HTTPS ç’°å¢ƒç¢ºèª: ${isGitHubPages ? '(GitHub Pages)' : '(å…¶ä»– HTTPS æœå‹™)'}`);
                console.log('ğŸ“‹ HTTPS ç’°å¢ƒèªªæ˜: ç€è¦½å™¨æœƒè‡ªå‹•ä½¿ç”¨ CORS ä»£ç†ä¾†æå–æ•¸æ“š');
            }
            
            try {
                // åœ¨ HTTP ç’°å¢ƒæ‰ç™¼é€è®€å–æŒ‡ä»¤ï¼ˆHTTPS ç’°å¢ƒæœƒè¢«ç€è¦½å™¨é˜»æ­¢ï¼‰
                if (!isHttps) {
                    console.log(`\nğŸ“¤ [æ­¥é©Ÿ 1] ç™¼é€è®€å–æŒ‡ä»¤ - MAC: ${mac}, DevID: ${devid}`);
                    const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                    console.log(`ğŸ“Œ è®€å–æŒ‡ä»¤ URL: ${readCmdUrl}`);
                    
                    try {
                        const readCmdResponse = await fetch(readCmdUrl, {
                            method: 'GET',
                            mode: 'cors',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        if (readCmdResponse.ok) {
                            const readCmdData = await readCmdResponse.json();
                            console.log(`âœ… è®€å–æŒ‡ä»¤å›æ‡‰:`, readCmdData);
                            
                            // é©—è­‰å›æ‡‰
                            if (readCmdData.Valid === true && readCmdData.ResultCode === 200) {
                                console.log(`âœ… è®€å–æŒ‡ä»¤ç¢ºèª: "${readCmdData.ResultMessage}"`);
                            } else {
                                console.warn(`âš ï¸ è®€å–æŒ‡ä»¤ç•°å¸¸: Valid=${readCmdData.Valid}, ResultCode=${readCmdData.ResultCode}`);
                            }
                        } else {
                            console.warn(`âš ï¸ è®€å–æŒ‡ä»¤ HTTP ${readCmdResponse.status}`);
                        }
                    } catch (readCmdError) {
                        console.warn(`âš ï¸ è®€å–æŒ‡ä»¤å¤±æ•— (ç¹¼çºŒé€²è¡Œ): ${readCmdError.message}`);
                    }
                    
                    // ç­‰å¾… 1 ç§’ï¼Œè®“æ©Ÿå°æº–å‚™æ•¸æ“š
                    console.log(`â³ [æ­¥é©Ÿ2] ç­‰å¾… 1 ç§’ï¼Œè®“æ©Ÿå°æº–å‚™æ•¸æ“š...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    console.log(`âœ… ç­‰å¾…å®Œæˆ`);
                } else {
                    console.log(`â³ HTTPS ç’°å¢ƒ: è·³éè®€å–æŒ‡ä»¤ï¼Œç›´æ¥é€²è¡Œæ•¸æ“šæŠ“å–...`);
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // ğŸ“Œ æ­¥é©Ÿ 2ï¼šé€²è¡Œæ•¸æ“šæŠ“å–
                console.log(`\nï¿½ [æ­¥é©Ÿ 2] ç™¼é€ HTTP GET è«‹æ±‚æŠ“å–æ•¸æ“š - MAC: ${mac}, DevID: ${devid}`);
                const result = await sendHttpRequest(mac);
                
                if (result) {
                    console.log(`âœ… æ•¸æ“šæŠ“å–æˆåŠŸ - MAC: ${mac}, DevID: ${devid}`);
                    // å‚³é devid çµ¦ handleHttpResponse
                    handleHttpResponse(result, mac, devid);
                    addCommandLog('receive', `HTTP å›æ‡‰æˆåŠŸ - MAC: ${mac}, DevID: ${devid}`, result);
                } else {
                    console.warn(`âŒ æ•¸æ“šæŠ“å–å¤±æ•— - MAC: ${mac}`);
                    addCommandLog('error', `æ•¸æ“šæŠ“å–å¤±æ•— - MAC: ${mac}`);
                }
                
            } catch (error) {
                console.error('HTTP è¼ªè©¢å¤±æ•—:', error);
                addCommandLog('error', `HTTP è¼ªè©¢å¤±æ•—: ${error.message}`);
            }
        }

        // âœ… å„ªåŒ–é…ç½®ï¼šå¿«é€Ÿè¼ªè©¢æ¨¡å¼
        let fastPollConfig = {
            enableEarlyTermination: true,      // âœ… æå‰çµ‚æ­¢
            enablePriorityFiltering: true,     // âœ… å„ªå…ˆç´šéæ¿¾
            maxRetries: 2,                     // âœ… æœ€å¤§é‡è©¦æ¬¡æ•¸æ”¹ç‚º 2 æ¬¡
            retryDelay: 1000,                  // âœ… é‡è©¦é–“éš”æ”¹ç‚º 1000ms
            earlyTerminationThreshold: 0.8,    // âœ… ç²å¾— 80% è³‡æ–™å¾Œæå‰çµ‚æ­¢
            waitBeforeRead: 3000               // âœ… ç™¼é€è®€å–æŒ‡ä»¤å¾Œç­‰å¾…æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰0.5s~5s
        };

        // ğŸ” è¨ºæ–·è¼ªå·¡æ•¸æ“šé¡¯ç¤ºå•é¡Œ
        window.diagnosePollingDisplay = function() {
            console.log('\nğŸ” è¨ºæ–·è¼ªå·¡æ•¸æ“šé¡¯ç¤ºå•é¡Œ');
            console.log('='.repeat(80));
            
            // æª¢æŸ¥è¼ªå·¡æ•¸æ“š
            if (!window.dailyRecords) {
                console.error('âŒ æ²’æœ‰è¼ªå·¡æ•¸æ“š');
                return;
            }
            
            const records = Object.entries(window.dailyRecords);
            console.log(`ğŸ“Š è¼ªå·¡è¨˜éŒ„ç¸½æ•¸: ${records.length}`);
            
            records.forEach(([key, record]) => {
                console.log(`\nğŸ“‹ è¨˜éŒ„: ${key}`);
                console.log(`   æ©Ÿå°: ${record.machineId}/${record.location}`);
                console.log(`   æŠ•å¹£: ${record.plays} (åŸå§‹: ${record.rawPlays}, æ ¡æ­£: +${record.playsCalibration})`);
                console.log(`   å‡ºè²¨: ${record.payouts} (åŸå§‹: ${record.rawPayouts}, æ ¡æ­£: +${record.payoutsCalibration})`);
                console.log(`   æ›´æ–°æ¬¡æ•¸: ${record.updateCount}`);
                console.log(`   æ˜¯å¦è¼ªå·¡è¨˜éŒ„: ${record.isPollingRecord}`);
            });
            
            // æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„
            console.log('\nğŸ” æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„:');
            buildMachineConfigMap();
            console.log(`ğŸ“Š æ˜ å°„è¡¨ç¸½æ•¸: ${Object.keys(window.machineConfigMap || {}).length}`);
            
            // åˆ—å‡ºæ‰€æœ‰æ˜ å°„
            Object.entries(window.machineConfigMap || {}).forEach(([key, config]) => {
                console.log(`   ${key} â†’ ${config.machineId}/${config.location}`);
            });
            
            // æª¢æŸ¥æœ€æ–°çš„æ©Ÿå°æ•¸æ“š
            console.log('\nğŸ” æª¢æŸ¥æŒ‰DevIDå„²å­˜çš„æ•¸æ“š:');
            if (window.machineDataByDevid) {
                Object.entries(window.machineDataByDevid).forEach(([devid, data]) => {
                    console.log(`   DevID ${devid}: æŠ•å¹£=${data.plays}, å‡ºè²¨=${data.payouts}, æ ¼å¼=${data.format}`);
                });
            } else {
                console.log('   âŒ æ²’æœ‰æŒ‰DevIDå„²å­˜çš„æ•¸æ“š');
            }
            
            console.log('='.repeat(80));
        };
        
        // ğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„æ ¡æ­£è¨ˆç®—
        window.testFixedCalibration = function(machineId = 'A-112', location = '3', rawPlays = 65, rawPayouts = -2) {
            console.log('\nğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„æ ¡æ­£è¨ˆç®—');
            console.log(`ğŸ¯ æ¸¬è©¦æ©Ÿå°: ${machineId}/${location}`);
            console.log(`ğŸ“Š æ¨¡æ“¬åŸå§‹å€¼: plays=${rawPlays}, payouts=${rawPayouts}`);
            
            // ç›´æ¥èª¿ç”¨ updateDailyRecord
            const result = updateDailyRecord(machineId, location, rawPlays, rawPayouts);
            
            console.log(`âœ… æ›´æ–°çµæœ:`, result.status);
            console.log(`ğŸ“‹ è¨˜éŒ„å…§å®¹:`);
            console.log(`   åŸå§‹æŠ•å¹£: ${result.record.rawPlays}`);
            console.log(`   åŸå§‹å‡ºè²¨: ${result.record.rawPayouts}`);
            console.log(`   æ ¡æ­£å€¼: æŠ•å¹£+${result.record.playsCalibration}, å‡ºè²¨+${result.record.payoutsCalibration}`);
            console.log(`   é¡¯ç¤ºæŠ•å¹£: ${result.record.plays}`);
            console.log(`   é¡¯ç¤ºå‡ºè²¨: ${result.record.payouts}`);
            
            // åˆ·æ–°è¡¨æ ¼
            refreshAutoRecordTable();
            
            return result;
        };

        // è¼ªè©¢æ‰€æœ‰æ©Ÿå° (HTTP ç‰ˆæœ¬) - å¾ªåºè™•ç†ç‰ˆæœ¬
        async function pollAllMachines(limitCount = null) {
            console.log('\n' + '='.repeat(70));
            console.log('ğŸš€ é–‹å§‹ HTTP å¾ªåºè¼ªè©¢ - æ¯å°æ©Ÿå°ç¨ç«‹è™•ç†');
            if (limitCount) {
                console.log(`ğŸ§ª æ¸¬è©¦æ¨¡å¼: åªè™•ç†å‰ ${limitCount} å°æ©Ÿå°`);
            }
            console.log('='.repeat(70));
            
            // ç’°å¢ƒåµæ¸¬
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\nğŸ” ç’°å¢ƒè©³ç´°æª¢æŸ¥:`);
            console.log(`   å”è­°: ${currentProtocol}`);
            console.log(`   ä¸»æ©Ÿ: ${currentHostname}`);
            console.log(`   æ˜¯å¦ HTTPS: ${isHttps}`);
            console.log(`   æ˜¯å¦ GitHub Pages: ${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`\nâœ… HTTPS ç’°å¢ƒç¢ºèª: ${isGitHubPages ? '(GitHub Pages)' : '(å…¶ä»– HTTPS æœå‹™)'}`);
                console.log('ğŸ“‹ HTTPS ç’°å¢ƒèªªæ˜: å°‡è·³éè®€å–æŒ‡ä»¤ï¼Œç›´æ¥ä½¿ç”¨ CORS ä»£ç†è®€å–æ•¸æ“š');
            } else {
                console.log(`\nâœ… HTTP ç’°å¢ƒç¢ºèª: ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼ˆè®€å–æŒ‡ä»¤ + æ•¸æ“šè®€å–ï¼‰`);
            }

            if (!appData.machines || appData.machines.length === 0) {
                alert('æ²’æœ‰æ©Ÿå°å¯ä»¥è¼ªè©¢');
                return;
            }

            let machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
            
            // ğŸ§ª å¦‚æœæŒ‡å®šäº†é™åˆ¶æ•¸é‡,åªå–å‰ N å°
            if (limitCount && limitCount > 0) {
                machinesWithMac = machinesWithMac.slice(0, limitCount);
                console.log(`\nğŸ§ª æ¸¬è©¦æ¨¡å¼: å¾ ${appData.machines.length} å°æ©Ÿå°ä¸­é¸å–å‰ ${machinesWithMac.length} å°`);
            }
            
            if (machinesWithMac.length === 0) {
                alert('æ²’æœ‰è¨­å®š MAC ä½å€çš„æ©Ÿå°');
                return;
            }
            
            console.log('\nğŸ“‹ è¼ªè©¢æ©Ÿå°æ¸…å–®:');
            machinesWithMac.forEach((machine, index) => {
                console.log(`   ${index + 1}. æ©Ÿå°ID: ${machine.id}, MAC: ${machine.mac}, DevID: ${machine.devid || 1}`);
            });
            
            // æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„
            console.log('\nğŸ” æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„:');
            buildMachineConfigMap();
            console.log('ğŸ“Š å¯ç”¨çš„æ˜ å°„éµ:', Object.keys(window.machineConfigMap));
            
            // é æ¸¬æ¯å°æ©Ÿå°çš„æ˜ å°„éµ
            console.log('\nğŸ¯ é æ¸¬æ©Ÿå°æ˜ å°„:');
            machinesWithMac.forEach((machine, index) => {
                const devid = machine.devid || 1;
                const expectedKey = `${machine.mac}_${devid}`;
                const hasMapping = !!window.machineConfigMap[expectedKey];
                console.log(`   ${index + 1}. ${machine.id}: ${expectedKey} ${hasMapping ? 'âœ…' : 'âŒ'} ${hasMapping ? '(æœ‰æ˜ å°„)' : '(ç„¡æ˜ å°„)'}`);
            });

            showStatusMessage(`é–‹å§‹å¾ªåºè¼ªè©¢ ${machinesWithMac.length} å°æ©Ÿå°...`, 'info');
            
            const pollStartTime = new Date();
            let pollCount = 0;
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;

            // ============================================
            // ğŸ“Œ å¾ªåºè™•ç†ï¼šæ¯å°æ©Ÿå°ç¨ç«‹åŸ·è¡Œã€Œç™¼é€æŒ‡ä»¤ â†’ ç­‰å¾…1ç§’ â†’ è®€å–è³‡æ–™ â†’ ç­‰å¾…0.5ç§’ã€
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('ï¿½ é–‹å§‹å¾ªåºè™•ç†æ¯å°æ©Ÿå°');
            console.log('   æµç¨‹: ç™¼é€æŒ‡ä»¤ â†’ ç­‰å¾…1ç§’ â†’ è®€å–è³‡æ–™ â†’ ç­‰å¾…0.5ç§’ â†’ ä¸‹ä¸€å°');
            console.log('='.repeat(70));
            
            for (let i = 0; i < machinesWithMac.length; i++) {
                const machine = machinesWithMac[i];
                const devid = machine.devid || 1;
                
                console.log(`\n${'â”€'.repeat(60)}`);
                console.log(`ï¿½ [${i + 1}/${machinesWithMac.length}] è™•ç†æ©Ÿå°: ${machine.id} (MAC: ${machine.mac})`);
                console.log(`${'â”€'.repeat(60)}`);
                
                try {
                    // ============================================
                    // æ­¥é©Ÿ 1: ç™¼é€è®€å–æŒ‡ä»¤ï¼ˆåƒ…é™ HTTP ç’°å¢ƒï¼‰
                    // ============================================
                    if (!isHttps) {
                        const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${machine.mac}/${devid}/`;
                        
                        try {
                            console.log(`ğŸ“¤ [æ­¥é©Ÿ1] ç™¼é€è®€å–æŒ‡ä»¤...`);
                            console.log(`   URL: ${readCmdUrl}`);
                            
                            const readCmdResponse = await fetch(readCmdUrl, {
                                method: 'GET',
                                mode: 'cors',
                                headers: { 'Accept': 'application/json' }
                            });
                            
                            if (readCmdResponse.ok) {
                                const readCmdData = await readCmdResponse.json();
                                console.log(`   âœ… æŒ‡ä»¤ç™¼é€æˆåŠŸ: ${readCmdData.ResultMessage || 'OK'}`);
                            } else {
                                console.warn(`   âš ï¸ æŒ‡ä»¤ç™¼é€å¤±æ•—: HTTP ${readCmdResponse.status}`);
                            }
                        } catch (readCmdError) {
                            // CORS éŒ¯èª¤æ˜¯é æœŸçš„ï¼Œä½†æŒ‡ä»¤å¯èƒ½å·²ç¶“åˆ°é”ä¼ºæœå™¨
                            if (readCmdError.message.includes('CORS') || readCmdError.message.includes('Failed to fetch')) {
                                console.log(`   âš ï¸ CORS é™åˆ¶é˜»æ“‹å›æ‡‰ï¼Œä½†æŒ‡ä»¤å¯èƒ½å·²ç™¼é€ (${readCmdError.message})`);
                                console.log(`   ğŸ’¡ é€™æ˜¯æ­£å¸¸ç¾è±¡ï¼Œæœƒç¹¼çºŒè®€å–æ•¸æ“š...`);
                            } else {
                                console.warn(`   âš ï¸ æŒ‡ä»¤ç™¼é€ç•°å¸¸: ${readCmdError.message}`);
                            }
                        }
                        
                        // ============================================
                        // æ­¥é©Ÿ 2: ç­‰å¾… 1 ç§’è®“æ©Ÿå°æº–å‚™æ•¸æ“š
                        // ============================================
                        console.log(`â³ [æ­¥é©Ÿ2] ç­‰å¾… 1 ç§’ï¼Œè®“æ©Ÿå°æº–å‚™æ•¸æ“š...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        console.log(`   âœ… ç­‰å¾…å®Œæˆ`);
                        
                    } else {
                        // HTTPS ç’°å¢ƒï¼šè·³éæŒ‡ä»¤ç™¼é€ï¼Œä½†ä»ç­‰å¾…ä¸€ä¸‹
                        console.log(`ğŸ”’ HTTPS ç’°å¢ƒ: è·³éè®€å–æŒ‡ä»¤`);
                        console.log(`â³ ç­‰å¾… 0.3 ç§’å¾Œè®€å–...`);
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    // ============================================
                    // æ­¥é©Ÿ 3: è®€å–è³‡æ–™ä¸¦è§£æ
                    // ============================================
                    console.log(`ğŸ“¥ [æ­¥é©Ÿ3] é–‹å§‹è®€å–è³‡æ–™...`);
                    
                    const result = await fetchWithRetry(machine.mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, devid);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   âœ… è³‡æ–™è®€å–æˆåŠŸ (å·²é©—è­‰)`);
                        
                        // å„ªå…ˆç´šéæ¿¾
                        if (fastPollConfig.enablePriorityFiltering) {
                            const hasTargetData = quickCheckForTargetData(result, devid);
                            if (!hasTargetData) {
                                console.log(`   âš ï¸ [å„ªå…ˆç´šéæ¿¾] ä¸åŒ…å«ç›®æ¨™è³‡æ–™ï¼Œè·³éè™•ç†`);
                                console.log(`   ğŸ” [èª¿è©¦] æ©Ÿå° ${machine.id} (MAC: ${machine.mac}, DevID: ${devid}) æ•¸æ“šä¸ç¬¦åˆå„ªå…ˆç´šéæ¿¾æ¢ä»¶`);
                                console.log(`   ğŸ“Š [èª¿è©¦] å›æ‡‰æ•¸æ“šé¡å‹: ${typeof result}, é•·åº¦: ${Array.isArray(result) ? result.length : 'N/A'}`);
                                if (Array.isArray(result) && result.length > 0) {
                                    console.log(`   ğŸ“‹ [èª¿è©¦] å‰3ç­†è¨˜éŒ„é è¦½:`, result.slice(0, 3).map(r => ({date: r.date, type: r.type, hasData: !!r.data})));
                                }
                            } else {
                                console.log(`   âœ… [å„ªå…ˆç´šéæ¿¾] åŒ…å«ç›®æ¨™è³‡æ–™ï¼Œé€²è¡Œè™•ç†`);
                                handleHttpResponse(result, machine.mac, devid);
                                addCommandLog('receive', `HTTP å›æ‡‰æˆåŠŸ - MAC: ${machine.mac}`, result);
                                fetchSuccessCount++;
                                targetDataReceived++;
                            }
                        } else {
                            handleHttpResponse(result, machine.mac, devid);
                            addCommandLog('receive', `HTTP å›æ‡‰æˆåŠŸ - MAC: ${machine.mac}`, result);
                            fetchSuccessCount++;
                            targetDataReceived++;
                        }
                    } else {
                        console.warn(`   âŒ è³‡æ–™è®€å–å¤±æ•— (æ•¸æ“šé©—è­‰å¤±æ•—æˆ–ç„¡æ•ˆ)`);
                        console.log(`   ğŸ” [èª¿è©¦] æ©Ÿå° ${machine.id} (MAC: ${machine.mac}, DevID: ${devid}) è®€å–å¤±æ•—è©³æƒ…:`);
                        console.log(`   ğŸ“Š [èª¿è©¦] result æ˜¯å¦å­˜åœ¨: ${!!result}`);
                        console.log(`   ğŸ“Š [èª¿è©¦] result é¡å‹: ${typeof result}`);
                        console.log(`   ğŸ“Š [èª¿è©¦] validateMachineData çµæœ: ${result ? validateMachineData(result) : 'N/A'}`);
                        if (result) {
                            console.log(`   ğŸ“‹ [èª¿è©¦] result å…§å®¹é è¦½:`, JSON.stringify(result).substring(0, 200) + '...');
                        }
                        addCommandLog('error', `æ•¸æ“šè®€å–å¤±æ•—æˆ–ç„¡æ•ˆ - MAC: ${machine.mac}`);
                    }
                    
                    pollCount++;
                    
                    // ============================================
                    // æ­¥é©Ÿ 4: ç­‰å¾… 0.5 ç§’å†è™•ç†ä¸‹ä¸€å°
                    // ============================================
                    if (i < machinesWithMac.length - 1) { // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å°
                        console.log(`â³ [æ­¥é©Ÿ4] ç­‰å¾… 0.5 ç§’å¾Œè™•ç†ä¸‹ä¸€å°...`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        console.log(`   âœ… æº–å‚™è™•ç†ä¸‹ä¸€å°æ©Ÿå°`);
                    } else {
                        console.log(`ğŸ å·²æ˜¯æœ€å¾Œä¸€å°ï¼Œä¸éœ€ç­‰å¾…`);
                    }
                    
                } catch (error) {
                    console.error(`âŒ è™•ç†æ©Ÿå°æ™‚ç™¼ç”Ÿç•°å¸¸: ${error.message}`);
                    addCommandLog('error', `HTTP è™•ç†ç•°å¸¸: ${error.message}`);
                    pollCount++;
                    
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¹Ÿç­‰å¾… 0.5 ç§’å†ç¹¼çºŒ
                    if (i < machinesWithMac.length - 1) {
                        console.log(`â³ éŒ¯èª¤å¾Œç­‰å¾… 0.5 ç§’å†ç¹¼çºŒ...`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }

            // ============================================
            // ğŸ“Š çµ±è¨ˆè¼ªè©¢çµæœ
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ“Š å¾ªåºè¼ªè©¢çµ±è¨ˆçµæœ');
            console.log('='.repeat(70));
            
            let updateCount = 0;
            let unchangedCount = 0;
            
            if (window.dailyRecords) {
                Object.values(window.dailyRecords).forEach(record => {
                    if (record.updateCount > 1) {
                        updateCount++;
                    } else {
                        unchangedCount++;
                    }
                });
            }
            
            const pollEndTime = new Date();
            const pollDuration = ((pollEndTime - pollStartTime) / 1000).toFixed(1);
            const avgTimePerMachine = (pollDuration / pollCount).toFixed(2);

            const summaryMsg = `
âœ… å¾ªåºè¼ªè©¢å®Œæˆï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š è¼ªè©¢çµæœ:
  â€¢ æ©Ÿå°ç¸½æ•¸: ${machinesWithMac.length} å°
  â€¢ å¯¦éš›è™•ç†: ${pollCount} å°
  â€¢ å®Œæ•´è¼ªè©¢: âœ“ æ‰€æœ‰æ©Ÿå°å®Œæˆ
  â€¢ æˆåŠŸç‡: ${fetchSuccessCount}/${pollCount} (${Math.round(fetchSuccessCount/pollCount*100)}%)
  
ğŸ“ˆ è³‡æ–™çµ±è¨ˆ:
  â€¢ ç›®æ¨™è³‡æ–™: ${targetDataReceived} ç­†
  â€¢ æ–°å¢è¨˜éŒ„: ${unchangedCount} ç­†
  â€¢ æ›´æ–°è¨˜éŒ„: ${updateCount} ç­†

â±ï¸ æ™‚é–“çµ±è¨ˆ:
  â€¢ ç¸½è€—æ™‚: ${pollDuration} ç§’
  â€¢ å¹³å‡æ¯å°: ${avgTimePerMachine} ç§’
  
ğŸ”§ è™•ç†æµç¨‹:
  â€¢ ç™¼é€æŒ‡ä»¤å¾Œç­‰å¾…: 1 ç§’
  â€¢ æ¯å°æ©Ÿå°é–“éš”: 0.5 ç§’
  â€¢ é‡è©¦æ¬¡æ•¸: ${fastPollConfig.maxRetries} æ¬¡
  â€¢ é‡è©¦é–“éš”: ${fastPollConfig.retryDelay}ms
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // é‹è¡Œè¼ªè©¢å¾Œè¨ºæ–·
            setTimeout(() => {
                console.log('\nğŸ” åŸ·è¡Œè¼ªè©¢å¾Œé€£ç·šè¨ºæ–·...');
                debugMachineConnectivity();
            }, 1000);
        }

        // ============================================
        // ğŸš€ æ‰¹æ¬¡è¼ªè©¢æ¨¡å¼ï¼šå…ˆç™¼é€æ‰€æœ‰æŸ¥è©¢ï¼Œç­‰2ç§’å¾Œçµ±ä¸€è®€å–
        // ============================================
        async function pollAllMachinesBatch() {
            console.log('\n' + '='.repeat(70));
            console.log('ğŸš€ é–‹å§‹ HTTP æ‰¹æ¬¡è¼ªè©¢ - å…ˆç™¼é€æ‰€æœ‰æŸ¥è©¢ï¼Œç­‰å¾…2ç§’å¾Œçµ±ä¸€è®€å–');
            console.log('='.repeat(70));
            
            // ç’°å¢ƒåµæ¸¬
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\nğŸ” ç’°å¢ƒè©³ç´°æª¢æŸ¥:`);
            console.log(`   å”è­°: ${currentProtocol}`);
            console.log(`   ä¸»æ©Ÿ: ${currentHostname}`);
            console.log(`   æ˜¯å¦ HTTPS: ${isHttps}`);
            console.log(`   æ˜¯å¦ GitHub Pages: ${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`\nâœ… HTTPS ç’°å¢ƒç¢ºèª: å°‡è·³éç™¼é€éšæ®µï¼Œç›´æ¥è®€å–`);
            } else {
                console.log(`\nâœ… HTTP ç’°å¢ƒç¢ºèª: å°‡ç™¼é€æŸ¥è©¢æŒ‡ä»¤å¾Œçµ±ä¸€è®€å–`);
            }

            if (!appData.machines || appData.machines.length === 0) {
                alert('æ²’æœ‰æ©Ÿå°å¯ä»¥è¼ªè©¢');
                return;
            }

            // å–å¾—å”¯ä¸€çš„ MAC ä½å€åˆ—è¡¨ï¼ˆæ¯å€‹ MAC åªè™•ç†ä¸€æ¬¡ï¼‰
            const uniqueMacs = [...new Set(appData.machines
                .filter(m => m.mac && m.mac.trim())
                .map(m => m.mac.trim()))];
            
            if (uniqueMacs.length === 0) {
                alert('æ²’æœ‰è¨­å®š MAC ä½å€çš„æ©Ÿå°');
                return;
            }
            
            console.log('\nğŸ“‹ æ‰¹æ¬¡è¼ªè©¢ MAC æ¸…å–®ï¼ˆæ¯å€‹ MAC åªè®€å–ä¸€æ¬¡ï¼‰:');
            uniqueMacs.forEach((mac, index) => {
                const machinesWithThisMac = appData.machines.filter(m => m.mac === mac);
                console.log(`   ${index + 1}. MAC: ${mac}`);
                machinesWithThisMac.forEach(m => {
                    console.log(`      - æ©Ÿå°: ${m.id} / ${m.location}, DevID: ${m.devid || 1}`);
                });
            });
            
            // æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„
            console.log('\nğŸ” æª¢æŸ¥æ©Ÿå°é…ç½®æ˜ å°„:');
            buildMachineConfigMap();
            console.log('ğŸ“Š å¯ç”¨çš„æ˜ å°„éµ:', Object.keys(window.machineConfigMap));

            showStatusMessage(`é–‹å§‹æ‰¹æ¬¡è¼ªè©¢ ${uniqueMacs.length} å€‹ MAC ä½å€...`, 'info');
            
            const pollStartTime = new Date();
            let sendSuccessCount = 0;
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;

            // ============================================
            // éšæ®µ 1: ç™¼é€æ‰€æœ‰æŸ¥è©¢æŒ‡ä»¤ï¼ˆåƒ… HTTP ç’°å¢ƒï¼‰
            // ============================================
            if (!isHttps) {
                console.log('\n' + '='.repeat(70));
                console.log('ğŸ“¤ éšæ®µ 1: ç™¼é€æ‰€æœ‰æŸ¥è©¢æŒ‡ä»¤');
                console.log('='.repeat(70));
                
                for (let i = 0; i < uniqueMacs.length; i++) {
                    const mac = uniqueMacs[i];
                    
                    // ç‚ºæ¯å€‹ MAC ç™¼é€ devid=1 å’Œ devid=2 çš„æŸ¥è©¢
                    for (let devid = 1; devid <= 2; devid++) {
                        const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                        
                        try {
                            console.log(`ğŸ“¤ [${i + 1}/${uniqueMacs.length}] ç™¼é€æŸ¥è©¢: MAC=${mac}, DevID=${devid}`);
                            
                            const readCmdResponse = await fetch(readCmdUrl, {
                                method: 'GET',
                                mode: 'cors',
                                headers: { 'Accept': 'application/json' }
                            });
                            
                            if (readCmdResponse.ok) {
                                const readCmdData = await readCmdResponse.json();
                                console.log(`   âœ… æŸ¥è©¢ç™¼é€æˆåŠŸ: ${readCmdData.ResultMessage || 'OK'}`);
                                sendSuccessCount++;
                            } else {
                                console.warn(`   âš ï¸ æŸ¥è©¢ç™¼é€å¤±æ•—: HTTP ${readCmdResponse.status}`);
                            }
                        } catch (readCmdError) {
                            // CORS éŒ¯èª¤æ˜¯é æœŸçš„
                            if (readCmdError.message.includes('CORS') || readCmdError.message.includes('Failed to fetch')) {
                                console.log(`   âš ï¸ CORS é™åˆ¶ï¼ˆé æœŸï¼‰ï¼ŒæŸ¥è©¢å¯èƒ½å·²ç™¼é€`);
                                sendSuccessCount++;
                            } else {
                                console.warn(`   âš ï¸ æŸ¥è©¢ç™¼é€ç•°å¸¸: ${readCmdError.message}`);
                            }
                        }
                        
                        // é¿å…ç™¼é€éå¿«ï¼Œæ¯æ¬¡é–“éš” 50ms
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                
                console.log(`\nâœ… æ‰€æœ‰æŸ¥è©¢æŒ‡ä»¤å·²ç™¼é€ (æˆåŠŸ: ${sendSuccessCount}/${uniqueMacs.length * 2})`);
            }
            
            // ============================================
            // éšæ®µ 2: ç­‰å¾…æ©Ÿå°æº–å‚™æ•¸æ“š (ç¢ºä¿è®€å–æœ€æ–°æ•¸æ“š)
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('â³ éšæ®µ 2: ç­‰å¾… 2 ç§’ï¼Œè®“æ‰€æœ‰æ©Ÿå°æº–å‚™æ•¸æ“š...');
            console.log('   ğŸ’¡ æç¤º: æ©Ÿå°éœ€è¦æ™‚é–“æº–å‚™æ–°æ•¸æ“šï¼Œé¿å…è®€åˆ°èˆŠç·©å­˜');
            console.log('='.repeat(70));
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            console.log('âœ… ç­‰å¾…å®Œæˆï¼Œé–‹å§‹ä¸¦è¡Œè®€å–æ•¸æ“š\n');
            
            // ============================================
            // éšæ®µ 3: ä¸¦è¡Œè®€å–æ‰€æœ‰ MAC çš„æ•¸æ“š (âš¡ é€Ÿåº¦å„ªåŒ–)
            // ============================================
            console.log('='.repeat(70));
            console.log('ğŸ“¥ éšæ®µ 3: ä¸¦è¡Œè®€å–æ‰€æœ‰ MAC çš„æ•¸æ“š (âš¡ åŠ é€Ÿæ¨¡å¼)');
            console.log('='.repeat(70));
            
            // ğŸš€ ä¸¦è¡Œè®€å–æ‰€æœ‰æ©Ÿå™¨ (è€Œéå¾ªåºç­‰å¾…)
            const fetchPromises = uniqueMacs.map(async (mac, index) => {
                console.log(`\n${'â”€'.repeat(60)}`);
                console.log(`ğŸ“¥ [${index + 1}/${uniqueMacs.length}] é–‹å§‹è®€å– MAC: ${mac}`);
                console.log(`${'â”€'.repeat(60)}`);
                
                try {
                    const result = await fetchWithRetry(mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, null);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   âœ… [${index + 1}] è³‡æ–™è®€å–æˆåŠŸ - MAC: ${mac}`);
                        console.log(`   ğŸ“Š æ•¸æ“šé¡å‹: ${Array.isArray(result) ? `é™£åˆ— (${result.length} ç­†)` : typeof result}`);
                        
                        // ğŸ” æª¢æŸ¥æ•¸æ“šæ–°é®®åº¦ - å¦‚æœæ•¸æ“šéæœŸ,è‡ªå‹•é‡è©¦ä¸€æ¬¡
                        let dataIsStale = false;
                        if (Array.isArray(result) && result.length > 0) {
                            // æª¢æŸ¥æœ€æ–°è¨˜éŒ„çš„æ™‚é–“
                            for (const record of result.slice(0, 10)) { // åªæª¢æŸ¥å‰ 10 ç­†
                                if (record.data && typeof record.data === 'string') {
                                    try {
                                        const parsed = JSON.parse(record.data);
                                        if (parsed.cmd === 're_readdata' && record.date) {
                                            const dateStr = record.date.replace(' ', 'T');
                                            const recordTime = new Date(dateStr).getTime();
                                            const now = Date.now();
                                            const age = now - recordTime;
                                            
                                            if (age > 60000) { // è¶…é 60 ç§’
                                                console.warn(`   âš ï¸ æª¢æ¸¬åˆ°éæœŸæ•¸æ“š: ${record.date} (è·ä»Š ${Math.floor(age/1000)} ç§’)`);
                                                dataIsStale = true;
                                            }
                                            break; // åªæª¢æŸ¥ç¬¬ä¸€ç­†æœ‰æ•ˆè¨˜éŒ„
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        
                        // ğŸ”„ å¦‚æœæ•¸æ“šéæœŸ,è‡ªå‹•é‡è©¦
                        if (dataIsStale) {
                            console.warn(`   ğŸ”„ æ•¸æ“šéæœŸï¼Œè‡ªå‹•é‡è©¦è®€å– MAC: ${mac}...`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾… 1 ç§’
                            
                            const retryResult = await fetchWithRetry(mac, 2, 500, null);
                            if (retryResult && validateMachineData(retryResult)) {
                                console.log(`   âœ… é‡è©¦æˆåŠŸ! ä½¿ç”¨æ–°æ•¸æ“š`);
                                handleHttpResponse(retryResult, mac, null);
                                addCommandLog('receive', `æ‰¹æ¬¡è®€å–æˆåŠŸ (é‡è©¦) - MAC: ${mac}`, retryResult);
                            } else {
                                console.warn(`   âš ï¸ é‡è©¦å¤±æ•—ï¼Œä½¿ç”¨åŸæ•¸æ“š`);
                                handleHttpResponse(result, mac, null);
                                addCommandLog('receive', `æ‰¹æ¬¡è®€å–æˆåŠŸ (ä½¿ç”¨èˆŠæ•¸æ“š) - MAC: ${mac}`, result);
                            }
                        } else {
                            // è™•ç†å›æ‡‰æ•¸æ“šï¼ˆå…§éƒ¨æœƒè‡ªå‹•è§£æ devid=1 å’Œ devid=2ï¼‰
                            handleHttpResponse(result, mac, null);
                            addCommandLog('receive', `æ‰¹æ¬¡è®€å–æˆåŠŸ - MAC: ${mac}`, result);
                        }
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`   âŒ [${index + 1}] è³‡æ–™è®€å–å¤±æ•— - MAC: ${mac}`);
                        addCommandLog('error', `æ‰¹æ¬¡è®€å–å¤±æ•— - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`âŒ [${index + 1}] è®€å– MAC ${mac} æ™‚ç™¼ç”Ÿç•°å¸¸: ${error.message}`);
                    addCommandLog('error', `æ‰¹æ¬¡è®€å–ç•°å¸¸: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // ç­‰å¾…æ‰€æœ‰è®€å–å®Œæˆ
            console.log(`\nâ³ ç­‰å¾…æ‰€æœ‰ ${uniqueMacs.length} å°æ©Ÿå™¨å®Œæˆè®€å–...`);
            const results = await Promise.all(fetchPromises);
            
            // çµ±è¨ˆä¸¦è¡Œè®€å–çµæœ
            const successCount = results.filter(r => r.success).length;
            console.log(`\nâœ… ä¸¦è¡Œè®€å–å®Œæˆ: ${successCount}/${uniqueMacs.length} æˆåŠŸ`);

            // ============================================
            // ğŸ“Š çµ±è¨ˆè¼ªè©¢çµæœ
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ“Š æ‰¹æ¬¡è¼ªè©¢çµ±è¨ˆçµæœ');
            console.log('='.repeat(70));
            
            let updateCount = 0;
            let unchangedCount = 0;
            
            if (window.dailyRecords) {
                Object.values(window.dailyRecords).forEach(record => {
                    if (record.updateCount > 1) {
                        updateCount++;
                    } else {
                        unchangedCount++;
                    }
                });
            }
            
            const pollEndTime = new Date();
            const pollDuration = ((pollEndTime - pollStartTime) / 1000).toFixed(1);
            const avgTimePerMac = (pollDuration / uniqueMacs.length).toFixed(2);

            const summaryMsg = `
âœ… æ‰¹æ¬¡è¼ªè©¢å®Œæˆï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š è¼ªè©¢çµæœ:
  â€¢ MAC ç¸½æ•¸: ${uniqueMacs.length} å€‹
  â€¢ æŸ¥è©¢ç™¼é€: ${sendSuccessCount}/${uniqueMacs.length * 2} (DevID 1+2)
  â€¢ æ•¸æ“šè®€å–: ${fetchSuccessCount}/${uniqueMacs.length}
  â€¢ æˆåŠŸç‡: ${Math.round(fetchSuccessCount/uniqueMacs.length*100)}%
  
ğŸ“ˆ è³‡æ–™çµ±è¨ˆ:
  â€¢ ç›®æ¨™è³‡æ–™: ${targetDataReceived} å€‹ MAC
  â€¢ æ–°å¢è¨˜éŒ„: ${unchangedCount} ç­†
  â€¢ æ›´æ–°è¨˜éŒ„: ${updateCount} ç­†

â±ï¸ æ™‚é–“çµ±è¨ˆ:
  â€¢ ç¸½è€—æ™‚: ${pollDuration} ç§’
  â€¢ å¹³å‡æ¯ MAC: ${avgTimePerMac} ç§’
  â€¢ ç­‰å¾…æ™‚é–“: 2 ç§’
  
ğŸ”§ è™•ç†æµç¨‹:
  â€¢ éšæ®µ1: ç™¼é€æ‰€æœ‰æŸ¥è©¢ (${sendSuccessCount} å€‹)
  â€¢ éšæ®µ2: ç­‰å¾… 2 ç§’
  â€¢ éšæ®µ3: çµ±ä¸€è®€å– (${fetchSuccessCount} å€‹)
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // é‹è¡Œè¼ªè©¢å¾Œè¨ºæ–·
            setTimeout(() => {
                console.log('\nğŸ” åŸ·è¡Œè¼ªè©¢å¾Œé€£ç·šè¨ºæ–·...');
                debugMachineConnectivity();
            }, 1000);
        }

        // ============================================
        // è¼ªè©¢æ¨¡å¼é¸æ“‡å™¨
        // ============================================
        async function executePollAllMachines(limitCount = null) {
            const pollMode = document.getElementById('http-poll-mode')?.value || 'sequential';
            
            console.log(`\nğŸ¯ é¸æ“‡çš„è¼ªè©¢æ¨¡å¼: ${pollMode === 'batch' ? 'æ‰¹æ¬¡æ¨¡å¼' : 'å¾ªåºæ¨¡å¼'}`);
            if (limitCount) {
                console.log(`ğŸ§ª æ¸¬è©¦æ¨¡å¼: åªè™•ç†å‰ ${limitCount} çµ„`);
            }
            
            if (pollMode === 'batch') {
                await pollAllMachinesBatch(limitCount);
            } else {
                await pollAllMachines(limitCount);
            }
        }

        // ============================================
        // âš¡ å¿«é€Ÿè®€å–æ¨¡å¼ (è·³éç™¼é€æŸ¥è©¢,ç›´æ¥è®€å–)
        // ============================================
        async function quickReadAllMachines(limitCount = null) {
            console.log('\n' + '='.repeat(70));
            console.log('âš¡ å¿«é€Ÿè®€å–æ¨¡å¼ (å‡è¨­å·²åœ¨é–€å¸‚ç®¡ç†é é¢ç™¼é€æŸ¥è©¢)');
            console.log('='.repeat(70));
            
            const startTime = Date.now();
            
            // ç²å–ç•¶å‰é–€å¸‚çš„æ‰€æœ‰æ©Ÿå°
            if (!appData.machines || appData.machines.length === 0) {
                showStatusMessage('âŒ ç•¶å‰é–€å¸‚æ²’æœ‰å¯è¼ªè©¢çš„æ©Ÿå°', 'error');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„ MAC åœ°å€
            const uniqueMacs = [...new Set(appData.machines
                .filter(machine => machine.mac && machine.mac.trim() !== '')
                .map(machine => machine.mac))];
            
            // å¥—ç”¨é™åˆ¶
            let targetMacs = uniqueMacs;
            if (limitCount && limitCount > 0) {
                targetMacs = uniqueMacs.slice(0, limitCount);
                console.log(`ğŸ§ª æ¸¬è©¦æ¨¡å¼: åªè®€å–å‰ ${targetMacs.length}/${uniqueMacs.length} å°æ©Ÿå™¨`);
            }
            
            console.log(`ğŸ“‹ æº–å‚™è®€å– ${targetMacs.length} å°æ©Ÿå™¨: ${targetMacs.join(', ')}\n`);
            
            // ============================================
            // ğŸ• æ™ºèƒ½ç­‰å¾…æ©Ÿåˆ¶ (ç¢ºä¿è®€å–åˆ°æœ€æ–°æ•¸æ“š)
            // ============================================
            console.log('â³ ç­‰å¾… 0.8 ç§’ç¢ºä¿è®€å–æœ€æ–°æ•¸æ“š...');
            await new Promise(resolve => setTimeout(resolve, 800));
            console.log('âœ… ç­‰å¾…å®Œæˆï¼Œé–‹å§‹è®€å–\n');
            
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;
            
            // ============================================
            // âš¡ ä¸¦è¡Œè®€å–æ‰€æœ‰ MAC çš„æ•¸æ“š
            // ============================================
            console.log('='.repeat(70));
            console.log('ğŸ“¥ ä¸¦è¡Œè®€å–æ‰€æœ‰ MAC çš„æ•¸æ“š (âš¡ åŠ é€Ÿæ¨¡å¼)');
            console.log('='.repeat(70));
            
            const fetchPromises = targetMacs.map(async (mac, index) => {
                console.log(`\n${'â”€'.repeat(60)}`);
                console.log(`ğŸ“¥ [${index + 1}/${targetMacs.length}] é–‹å§‹è®€å– MAC: ${mac}`);
                console.log(`${'â”€'.repeat(60)}`);
                
                try {
                    const result = await fetchWithRetry(mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, null);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   âœ… [${index + 1}] è³‡æ–™è®€å–æˆåŠŸ - MAC: ${mac}`);
                        console.log(`   ğŸ“Š æ•¸æ“šé¡å‹: ${Array.isArray(result) ? `é™£åˆ— (${result.length} ç­†)` : typeof result}`);
                        
                        // ğŸ” æª¢æŸ¥æ•¸æ“šæ–°é®®åº¦ - å¦‚æœæ•¸æ“šéæœŸ,è‡ªå‹•é‡è©¦ä¸€æ¬¡
                        let dataIsStale = false;
                        if (Array.isArray(result) && result.length > 0) {
                            // æª¢æŸ¥æœ€æ–°è¨˜éŒ„çš„æ™‚é–“
                            for (const record of result.slice(0, 10)) { // åªæª¢æŸ¥å‰ 10 ç­†
                                if (record.data && typeof record.data === 'string') {
                                    try {
                                        const parsed = JSON.parse(record.data);
                                        if (parsed.cmd === 're_readdata' && record.date) {
                                            const dateStr = record.date.replace(' ', 'T');
                                            const recordTime = new Date(dateStr).getTime();
                                            const now = Date.now();
                                            const age = now - recordTime;
                                            
                                            if (age > 60000) { // è¶…é 60 ç§’
                                                console.warn(`   âš ï¸ æª¢æ¸¬åˆ°éæœŸæ•¸æ“š: ${record.date} (è·ä»Š ${Math.floor(age/1000)} ç§’)`);
                                                dataIsStale = true;
                                            }
                                            break; // åªæª¢æŸ¥ç¬¬ä¸€ç­†æœ‰æ•ˆè¨˜éŒ„
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        
                        // ğŸ”„ å¦‚æœæ•¸æ“šéæœŸ,è‡ªå‹•é‡è©¦
                        if (dataIsStale) {
                            console.warn(`   ğŸ”„ æ•¸æ“šéæœŸï¼Œè‡ªå‹•é‡è©¦è®€å– MAC: ${mac}...`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾… 1 ç§’
                            
                            const retryResult = await fetchWithRetry(mac, 2, 500, null);
                            if (retryResult && validateMachineData(retryResult)) {
                                console.log(`   âœ… é‡è©¦æˆåŠŸ! ä½¿ç”¨æ–°æ•¸æ“š`);
                                handleHttpResponse(retryResult, mac, null);
                                addCommandLog('receive', `å¿«é€Ÿè®€å–æˆåŠŸ (é‡è©¦) - MAC: ${mac}`, retryResult);
                            } else {
                                console.warn(`   âš ï¸ é‡è©¦å¤±æ•—ï¼Œä½¿ç”¨åŸæ•¸æ“š`);
                                handleHttpResponse(result, mac, null);
                                addCommandLog('receive', `å¿«é€Ÿè®€å–æˆåŠŸ (ä½¿ç”¨èˆŠæ•¸æ“š) - MAC: ${mac}`, result);
                            }
                        } else {
                            handleHttpResponse(result, mac, null);
                            addCommandLog('receive', `å¿«é€Ÿè®€å–æˆåŠŸ - MAC: ${mac}`, result);
                        }
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`   âŒ [${index + 1}] è³‡æ–™è®€å–å¤±æ•— - MAC: ${mac}`);
                        addCommandLog('error', `å¿«é€Ÿè®€å–å¤±æ•— - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`âŒ [${index + 1}] è®€å– MAC ${mac} æ™‚ç™¼ç”Ÿç•°å¸¸: ${error.message}`);
                    addCommandLog('error', `å¿«é€Ÿè®€å–ç•°å¸¸: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // ç­‰å¾…æ‰€æœ‰è®€å–å®Œæˆ
            console.log(`\nâ³ ç­‰å¾…æ‰€æœ‰ ${targetMacs.length} å°æ©Ÿå™¨å®Œæˆè®€å–...`);
            const results = await Promise.all(fetchPromises);
            
            // çµ±è¨ˆçµæœ
            const successCount = results.filter(r => r.success).length;
            console.log(`\nâœ… ä¸¦è¡Œè®€å–å®Œæˆ: ${successCount}/${targetMacs.length} æˆåŠŸ`);
            
            // ============================================
            // ğŸ“Š çµ±è¨ˆçµæœ
            // ============================================
            const endTime = Date.now();
            const pollDuration = ((endTime - startTime) / 1000).toFixed(1);
            const avgTimePerMac = ((endTime - startTime) / targetMacs.length / 1000).toFixed(2);
            
            // çµ±è¨ˆæ›´æ–°å’Œæ–°å¢è¨˜éŒ„
            const recordOperations = window.dailyRecordOperations || [];
            const updateCount = recordOperations.filter(op => op === 'updated').length;
            const unchangedCount = recordOperations.filter(op => op === 'unchanged' || op === 'created').length;
            
            console.log('\n' + '='.repeat(70));
            console.log('ğŸ“Š å¿«é€Ÿè®€å–çµ±è¨ˆçµæœ');
            console.log('='.repeat(70));
            
            const summaryMsg = `
âœ… å¿«é€Ÿè®€å–å®Œæˆï¼âš¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š è®€å–çµæœ:
  â€¢ MAC ç¸½æ•¸: ${targetMacs.length} å€‹
  â€¢ æ•¸æ“šè®€å–: ${fetchSuccessCount}/${targetMacs.length}
  â€¢ æˆåŠŸç‡: ${Math.round(fetchSuccessCount / targetMacs.length * 100)}%
  
ğŸ“ˆ è³‡æ–™çµ±è¨ˆ:
  â€¢ è®€å–è³‡æ–™: ${targetDataReceived} å€‹ MAC
  â€¢ æ–°å¢è¨˜éŒ„: ${unchangedCount} ç­†
  â€¢ æ›´æ–°è¨˜éŒ„: ${updateCount} ç­†

â±ï¸ æ™‚é–“çµ±è¨ˆ:
  â€¢ ç¸½è€—æ™‚: ${pollDuration} ç§’ âš¡
  â€¢ å¹³å‡æ¯ MAC: ${avgTimePerMac} ç§’
  â€¢ ç­‰å¾…æ™‚é–“: 0.8 ç§’ (æ™ºèƒ½ç­‰å¾…)
  
ğŸ”§ è™•ç†æµç¨‹:
  â€¢ è·³ééšæ®µ1: ç™¼é€æŸ¥è©¢ âœ“
  â€¢ æ™ºèƒ½ç­‰å¾…: 0.8ç§’ç¢ºä¿æ–°æ•¸æ“š âœ“
  â€¢ éšæ®µ3: ä¸¦è¡Œè®€å– (${fetchSuccessCount} å€‹)
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // åˆ·æ–°è¡¨æ ¼
            refreshAutoRecordTable();
        }

        // ============================================
        // ğŸš€ ä¸€éµå…¨è‡ªå‹•æ›´æ–°æ‰€æœ‰é–€å¸‚ (å®Œæ•´æµç¨‹)
        // ============================================
        async function autoUpdateAllStores() {
            if (!selectedGroupId) {
                alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„');
                return;
            }

            // ç¢ºèªæ“ä½œ
            const confirmMsg = 'ğŸš€ ä¸€éµå…¨è‡ªå‹•æ›´æ–°æ‰€æœ‰é–€å¸‚\n\n' +
                'å®Œæ•´æµç¨‹ï¼š\n' +
                '1ï¸âƒ£ ç™¼é€æ‰€æœ‰é–€å¸‚è®€å–è¨Šæ¯\n' +
                '2ï¸âƒ£ ç­‰å¾…å®Œæˆå¾Œå»¶é² 3 ç§’\n' +
                '3ï¸âƒ£ å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™ (ç¬¬1æ¬¡)\n' +
                '4ï¸âƒ£ å®Œæˆå¾Œå»¶é² 2 ç§’\n' +
                '5ï¸âƒ£ å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™ (ç¬¬2æ¬¡,ç¢ºä¿æœ€æ–°)\n' +
                '6ï¸âƒ£ ä¾åºå®Œæˆå„é–€å¸‚æ‰¹é‡è‡ªå‹•è¨˜å¸³\n\n' +
                'â±ï¸ é è¨ˆè€—æ™‚: 15-30 ç§’\n\n' +
                'ç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ';
            
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('ğŸš€ é–‹å§‹ä¸€éµå…¨è‡ªå‹•æ›´æ–°æ‰€æœ‰é–€å¸‚');
            console.log('='.repeat(80));

            // é¡¯ç¤ºå¤§å‹é€²åº¦æç¤ºæ¡†
            const progressDiv = document.createElement('div');
            progressDiv.id = 'auto-update-progress';
            progressDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            progressDiv.innerHTML = `
                <div class="bg-gradient-to-br from-blue-900 to-purple-900 text-white px-8 py-6 rounded-2xl shadow-2xl max-w-2xl w-full mx-4">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-bold text-2xl">ğŸš€ ä¸€éµå…¨è‡ªå‹•æ›´æ–°</span>
                    </div>
                    <div class="space-y-3">
                        <div id="auto-step-1" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>1ï¸âƒ£ ç™¼é€æ‰€æœ‰é–€å¸‚è®€å–è¨Šæ¯</span>
                        </div>
                        <div id="auto-step-2" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>2ï¸âƒ£ ç­‰å¾… 3 ç§’...</span>
                        </div>
                        <div id="auto-step-3" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>3ï¸âƒ£ å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚ (ç¬¬1æ¬¡)</span>
                        </div>
                        <div id="auto-step-4" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>4ï¸âƒ£ ç­‰å¾… 2 ç§’...</span>
                        </div>
                        <div id="auto-step-5" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>5ï¸âƒ£ å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚ (ç¬¬2æ¬¡)</span>
                        </div>
                        <div id="auto-step-6" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">â³</span>
                            <span>6ï¸âƒ£ æ‰¹é‡è‡ªå‹•è¨˜å¸³</span>
                        </div>
                    </div>
                    <div id="auto-progress-detail" class="mt-4 text-sm text-blue-200 bg-black bg-opacity-30 p-3 rounded">
                        æº–å‚™ä¸­...
                    </div>
                </div>
            `;
            document.body.appendChild(progressDiv);

            const updateStep = (stepNum, status, emoji = 'â³') => {
                const stepEl = document.getElementById(`auto-step-${stepNum}`);
                if (stepEl) {
                    const emojiSpan = stepEl.querySelector('.text-2xl');
                    emojiSpan.textContent = emoji;
                    if (status === 'active') {
                        stepEl.className = 'flex items-center gap-2 text-white font-bold';
                    } else if (status === 'done') {
                        stepEl.className = 'flex items-center gap-2 text-green-400';
                    }
                }
            };

            const updateDetail = (text) => {
                const detailEl = document.getElementById('auto-progress-detail');
                if (detailEl) detailEl.textContent = text;
            };

            try {
                // ============================================
                // æ­¥é©Ÿ 1: ç™¼é€æ‰€æœ‰é–€å¸‚è®€å–è¨Šæ¯
                // ============================================
                updateStep(1, 'active', 'ğŸ”„');
                updateDetail('æ­£åœ¨ç™¼é€æ‰€æœ‰é–€å¸‚çš„è®€å–æŸ¥è©¢...');
                console.log('\nğŸ“¤ æ­¥é©Ÿ 1/6: ç™¼é€æ‰€æœ‰é–€å¸‚è®€å–è¨Šæ¯');

                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let totalSent = 0;
                for (const store of stores) {
                    const machinesSnapshot = await db.collection('groups')
                        .doc(selectedGroupId)
                        .collection('stores')
                        .doc(store.id)
                        .collection('machines')
                        .get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // æ”¶é›†æ‰€æœ‰ mac/devid çµ„åˆ
                    for (const machine of machines) {
                        const mac = machine.mac;
                        const devid = machine.devid || 1;
                        
                        if (!mac || mac.trim() === '') continue;
                        
                        const url = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                        
                        try {
                            // ä½¿ç”¨ XMLHttpRequest ç›´æ¥ç™¼é€ (èˆ‡ã€Œç«‹å³è¼ªå·¡æ‰€æœ‰é–€å¸‚ã€ç›¸åŒæ–¹å¼)
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.timeout = 5000;
                            
                            xhr.onload = function() {
                                console.log(`âœ… æŸ¥è©¢å·²ç™¼é€: ${mac}/${devid} (HTTP ${xhr.status})`);
                            };
                            
                            xhr.onerror = function() {
                                console.log(`âœ… æŸ¥è©¢å·²ç™¼é€: ${mac}/${devid} (CORS å¯å¿½ç•¥)`);
                            };
                            
                            xhr.ontimeout = function() {
                                console.log(`âœ… æŸ¥è©¢å·²ç™¼é€: ${mac}/${devid} (å¯èƒ½é›¢ç·š)`);
                            };
                            
                            xhr.send();
                            totalSent++;
                            
                            // ç¨å¾®å»¶é²é¿å…å¤ªå¿«
                            await new Promise(resolve => setTimeout(resolve, 50));
                            
                        } catch (error) {
                            console.warn(`âš ï¸ ç™¼é€å¤±æ•—: ${mac}/${devid}`, error);
                        }
                    }
                }
                
                updateStep(1, 'done', 'âœ…');
                updateDetail(`å·²ç™¼é€ ${totalSent} å€‹æŸ¥è©¢è¨Šæ¯`);
                console.log(`âœ… æ­¥é©Ÿ 1 å®Œæˆ: å·²ç™¼é€ ${totalSent} å€‹æŸ¥è©¢`);

                // ============================================
                // æ­¥é©Ÿ 2: ç­‰å¾… 3 ç§’
                // ============================================
                updateStep(2, 'active', 'â°');
                console.log('\nâ³ æ­¥é©Ÿ 2/6: ç­‰å¾… 3 ç§’è®“æ©Ÿå™¨æº–å‚™æ•¸æ“š...');
                
                for (let i = 3; i > 0; i--) {
                    updateDetail(`ç­‰å¾…æ©Ÿå™¨æº–å‚™æ•¸æ“š... ${i} ç§’`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateStep(2, 'done', 'âœ…');
                updateDetail('ç­‰å¾…å®Œæˆ');
                console.log('âœ… æ­¥é©Ÿ 2 å®Œæˆ: ç­‰å¾…æ™‚é–“çµæŸ');

                // ============================================
                // æ­¥é©Ÿ 3: ç¬¬ä¸€æ¬¡å¿«é€Ÿè®€å–
                // ============================================
                updateStep(3, 'active', 'ğŸ“–');
                updateDetail('æ­£åœ¨é€²è¡Œç¬¬1æ¬¡å¿«é€Ÿè®€å–...');
                console.log('\nğŸ“– æ­¥é©Ÿ 3/6: ç¬¬1æ¬¡å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™');
                
                await quickReadAllStoresData(updateDetail);
                
                updateStep(3, 'done', 'âœ…');
                updateDetail('ç¬¬1æ¬¡è®€å–å®Œæˆ');
                console.log('âœ… æ­¥é©Ÿ 3 å®Œæˆ: ç¬¬1æ¬¡è®€å–å®Œæˆ');

                // ============================================
                // æ­¥é©Ÿ 4: ç­‰å¾… 2 ç§’
                // ============================================
                updateStep(4, 'active', 'â°');
                console.log('\nâ³ æ­¥é©Ÿ 4/6: ç­‰å¾… 2 ç§’...');
                
                for (let i = 2; i > 0; i--) {
                    updateDetail(`ç­‰å¾…ç¢ºä¿æœ€æ–°æ•¸æ“š... ${i} ç§’`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateStep(4, 'done', 'âœ…');
                updateDetail('ç­‰å¾…å®Œæˆ');
                console.log('âœ… æ­¥é©Ÿ 4 å®Œæˆ: ç­‰å¾…æ™‚é–“çµæŸ');

                // ============================================
                // æ­¥é©Ÿ 5: ç¬¬äºŒæ¬¡å¿«é€Ÿè®€å– (ç¢ºä¿æœ€æ–°)
                // ============================================
                updateStep(5, 'active', 'ğŸ“–');
                updateDetail('æ­£åœ¨é€²è¡Œç¬¬2æ¬¡å¿«é€Ÿè®€å– (ç¢ºä¿æœ€æ–°æ•¸æ“š)...');
                console.log('\nğŸ“– æ­¥é©Ÿ 5/6: ç¬¬2æ¬¡å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™');
                
                await quickReadAllStoresData(updateDetail);
                
                updateStep(5, 'done', 'âœ…');
                updateDetail('ç¬¬2æ¬¡è®€å–å®Œæˆ');
                console.log('âœ… æ­¥é©Ÿ 5 å®Œæˆ: ç¬¬2æ¬¡è®€å–å®Œæˆ');

                // ============================================
                // æ­¥é©Ÿ 6: æ‰¹é‡è‡ªå‹•è¨˜å¸³
                // ============================================
                updateStep(6, 'active', 'ğŸ’¾');
                updateDetail('æ­£åœ¨æ‰¹é‡è‡ªå‹•è¨˜å¸³...');
                console.log('\nğŸ’¾ æ­¥é©Ÿ 6/6: æ‰¹é‡è‡ªå‹•è¨˜å¸³');
                console.log('ğŸ“Š æª¢æŸ¥ dailyRecords:', window.dailyRecords);
                
                let savedCount = 0;
                let skippedCount = 0;
                const today = new Date().toISOString().split('T')[0];
                
                for (const store of stores) {
                    updateDetail(`æ­£åœ¨è™•ç†é–€å¸‚: ${store.name}...`);
                    console.log(`\nğŸª è™•ç†é–€å¸‚: ${store.name}`);
                    
                    try {
                        const machinesSnapshot = await db.collection('groups')
                            .doc(selectedGroupId)
                            .collection('stores')
                            .doc(store.id)
                            .collection('machines')
                            .get();
                        
                        const machines = machinesSnapshot.docs.map(doc => ({ 
                            docId: doc.id, 
                            ...doc.data() 
                        }));
                        
                        console.log(`   æ©Ÿå°æ•¸: ${machines.length}`);
                        
                        for (const machine of machines) {
                            // ä½¿ç”¨ mac å’Œ devid ä¾†æŸ¥æ‰¾æ©Ÿå°é…ç½®
                            const mac = machine.mac;
                            const devid = machine.devid || 1;
                            const machineConfig = findMachineConfig(mac, devid);
                            
                            if (!machineConfig) {
                                skippedCount++;
                                console.log(`   âš ï¸ æ‰¾ä¸åˆ°æ©Ÿå°é…ç½®: mac=${mac}, devid=${devid}`);
                                continue;
                            }
                            
                            // å¾ dailyRecords æŸ¥æ‰¾ä»Šå¤©çš„æ•¸æ“š
                            const recordKey = `${machineConfig.machineId}_${machineConfig.location}_${today}`;
                            const dailyRecord = window.dailyRecords?.[recordKey];
                            
                            if (dailyRecord && dailyRecord.plays !== undefined && dailyRecord.payouts !== undefined) {
                                console.log(`   âœ… æ‰¾åˆ°æ•¸æ“š: ${recordKey}`, { plays: dailyRecord.plays, payouts: dailyRecord.payouts });
                                
                                try {
                                    await db.collection('groups')
                                        .doc(selectedGroupId)
                                        .collection('stores')
                                        .doc(store.id)
                                        .collection('machines')
                                        .doc(machine.docId)
                                        .collection('daily_records')
                                        .doc(today)
                                        .set({
                                            date: today,
                                            cumulativePlays: dailyRecord.plays,
                                            cumulativePayouts: dailyRecord.payouts,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            source: 'auto_batch_update'
                                        }, { merge: true });
                                    
                                    savedCount++;
                                    console.log(`      ğŸ’¾ å·²ä¿å­˜: ${machineConfig.machineId}/${machineConfig.location}`);
                                } catch (error) {
                                    console.error(`      âŒ ä¿å­˜å¤±æ•—: ${machineConfig.machineId}`, error);
                                }
                            } else {
                                skippedCount++;
                                console.log(`   âš ï¸ æ²’æœ‰æ•¸æ“š: ${recordKey}`);
                            }
                        }
                    } catch (error) {
                        console.error(`âŒ è™•ç†é–€å¸‚ ${store.name} å¤±æ•—:`, error);
                    }
                }
                
                updateStep(6, 'done', 'âœ…');
                updateDetail(`æ‰¹é‡è¨˜å¸³å®Œæˆ! å·²ä¿å­˜ ${savedCount} ç­†, è·³é ${skippedCount} ç­†`);
                console.log(`âœ… æ­¥é©Ÿ 6 å®Œæˆ: å·²ä¿å­˜ ${savedCount} ç­†è¨˜éŒ„, è·³é ${skippedCount} ç­†`);

                // ============================================
                // å®Œæˆ
                // ============================================
                console.log('\n' + '='.repeat(80));
                console.log(`ğŸ‰ ä¸€éµå…¨è‡ªå‹•æ›´æ–°å®Œæˆï¼`);
                console.log(`ğŸ“Š çµ±è¨ˆ: ${stores.length} å€‹é–€å¸‚, ${savedCount} ç­†è¨˜éŒ„`);
                console.log('='.repeat(80));

                // å»¶é² 2 ç§’å¾Œé—œé–‰é€²åº¦æ¡†
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                progressDiv.remove();
                alert(`âœ… ä¸€éµå…¨è‡ªå‹•æ›´æ–°å®Œæˆï¼\n\n` +
                      `ğŸ“Š é–€å¸‚æ•¸: ${stores.length}\n` +
                      `ğŸ’¾ è¨˜å¸³ç­†æ•¸: ${savedCount}\n` +
                      `â±ï¸ æ‰€æœ‰æµç¨‹å·²å®Œæˆ`);

            } catch (error) {
                console.error('âŒ ä¸€éµå…¨è‡ªå‹•æ›´æ–°å¤±æ•—:', error);
                updateDetail(`âŒ éŒ¯èª¤: ${error.message}`);
                
                setTimeout(() => {
                    progressDiv.remove();
                    alert('âŒ ä¸€éµå…¨è‡ªå‹•æ›´æ–°å¤±æ•—:\n' + error.message);
                }, 2000);
            }
        }

        // ============================================
        // ğŸ“– å¿«é€Ÿè®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™ (å…§éƒ¨è¼”åŠ©å‡½æ•¸)
        // ============================================
        async function quickReadAllStoresData(updateCallback) {
            const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
            const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let processedCount = 0;
            let totalReadCount = 0;
            
            for (const store of stores) {
                updateCallback(`æ­£åœ¨è®€å–: ${store.name} (${++processedCount}/${stores.length})`);
                console.log(`ğŸ“– è®€å–é–€å¸‚: ${store.name}`);
                
                try {
                    const machinesSnapshot = await db.collection('groups')
                        .doc(selectedGroupId)
                        .collection('stores')
                        .doc(store.id)
                        .collection('machines')
                        .get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({ 
                        docId: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // è‡¨æ™‚è¨­ç½®ç•¶å‰é–€å¸‚çš„ appData å’Œ machineConfigMap
                    const originalAppData = window.appData;
                    const originalConfigMap = window.machineConfigMap;
                    
                    window.appData = {
                        machines: machines,
                        storeId: store.id,
                        storeName: store.name
                    };
                    
                    // é‡å»ºæ©Ÿå°é…ç½®æ˜ å°„è¡¨
                    window.machineConfigMap = null;
                    buildMachineConfigMap();
                    
                    console.log(`   æ©Ÿå°æ•¸: ${machines.length}`);
                    
                    // ä¸¦è¡Œè®€å–è©²é–€å¸‚çš„æ‰€æœ‰æ©Ÿå°
                    const readPromises = machines
                        .filter(m => m.mac && m.mac.trim() !== '')
                        .map(async (machine) => {
                            const mac = machine.mac;
                            const devid = machine.devid || 1;
                            
                            try {
                                // å‚³å…¥æ­£ç¢ºçš„ mac å’Œ devid
                                const result = await fetchWithRetry(mac, 3, 500, devid);
                                if (result && validateMachineData(result)) {
                                    handleHttpResponse(result, mac, devid);
                                    console.log(`   âœ… è®€å–æˆåŠŸ: ${mac}/${devid}`);
                                    return true;
                                }
                                return false;
                            } catch (error) {
                                console.warn(`   âš ï¸ è®€å–å¤±æ•—: ${mac}/${devid}`, error.message);
                                return false;
                            }
                        });
                    
                    const results = await Promise.all(readPromises);
                    const successCount = results.filter(r => r).length;
                    totalReadCount += successCount;
                    
                    console.log(`   âœ… å®Œæˆ: ${successCount}/${machines.length} å€‹æ©Ÿå°`);
                    
                    // æ¢å¾©åŸå§‹ appData å’Œ machineConfigMap
                    window.appData = originalAppData;
                    window.machineConfigMap = originalConfigMap;
                    
                } catch (error) {
                    console.error(`   âŒ è™•ç†é–€å¸‚ ${store.name} å¤±æ•—:`, error);
                }
            }
            
            console.log(`ğŸ“Š å¿«é€Ÿè®€å–å®Œæˆ: ${processedCount} å€‹é–€å¸‚, ${totalReadCount} å€‹æˆåŠŸè®€å–`);
            return processedCount;
        }

        // ============================================
        // ğŸŒ ç«‹å³ç™¼é€æ‰€æœ‰é–€å¸‚æ©Ÿå°æŸ¥è©¢è¨Šæ¯
        // ============================================
        async function pollAllStoresMachines() {
            if (!selectedGroupId) {
                alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„');
                return;
            }

            // ç¢ºèªæ“ä½œ
            const confirmMsg = 'ç¢ºå®šè¦ç™¼é€æ‰€æœ‰é–€å¸‚æ©Ÿå°çš„æŸ¥è©¢è¨Šæ¯å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. å°æ¯å€‹é–€å¸‚çš„æ‰€æœ‰æ©Ÿå°ç™¼é€ HTTP æŸ¥è©¢\n2. ä¸ç­‰å¾…å›æ‡‰ï¼ˆæ‰‹å‹•é€²å…¥é–€å¸‚å¾Œå†è®€å–ï¼‰\n3. å»ºè­°ç­‰å¾… 2-3 ç§’å¾Œå†é€²å…¥é–€å¸‚æŸ¥çœ‹\n\né©åˆåœ¨é–‹å§‹å·¥ä½œå‰é å…ˆç™¼é€æŸ¥è©¢ã€‚';
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('ğŸŒ é–‹å§‹ç™¼é€æ‰€æœ‰é–€å¸‚æ©Ÿå°æŸ¥è©¢è¨Šæ¯');
            console.log('='.repeat(80));

            // é¡¯ç¤ºé€²åº¦æç¤º
            const progressDiv = document.createElement('div');
            progressDiv.id = 'poll-all-stores-progress';
            progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
            progressDiv.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="font-bold">æ­£åœ¨ç™¼é€æŸ¥è©¢...</span>
                </div>
                <div id="poll-progress-text" class="text-sm">æº–å‚™ä¸­...</div>
            `;
            document.body.appendChild(progressDiv);

            const updateProgress = (text) => {
                const progressText = document.getElementById('poll-progress-text');
                if (progressText) progressText.textContent = text;
            };

            try {
                // ç²å–æ‰€æœ‰é–€å¸‚
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`ğŸ“‹ æ‰¾åˆ° ${stores.length} å€‹é–€å¸‚`);
                updateProgress(`æ‰¾åˆ° ${stores.length} å€‹é–€å¸‚ï¼Œé–‹å§‹ç™¼é€æŸ¥è©¢...`);

                let totalStores = stores.length;
                let completedStores = 0;
                let totalMachines = 0;
                let totalSent = 0;
                let totalFailed = 0;

                // æ”¶é›†æ‰€æœ‰æ©Ÿå°çš„ MAC ä½å€
                const allMacAddresses = [];

                for (const store of stores) {
                    completedStores++;
                    console.log(`\n[${completedStores}/${totalStores}] ğŸª è™•ç†é–€å¸‚: ${store.name}`);
                    updateProgress(`[${completedStores}/${totalStores}] æ­£åœ¨è™•ç†: ${store.name}`);

                    try {
                        // ç²å–è©²é–€å¸‚çš„æ‰€æœ‰æ©Ÿå°
                        const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(store.id)
                            .collection('machines').get();
                        
                        const machines = machinesSnapshot.docs.map(doc => ({
                            docId: doc.id,
                            ...doc.data()
                        }));

                        console.log(`   ğŸ“Š æ‰¾åˆ° ${machines.length} å°æ©Ÿå°`);
                        totalMachines += machines.length;

                        // ç™¼é€æ¯å°æ©Ÿå°çš„æŸ¥è©¢
                        for (const machine of machines) {
                            console.log(`      æ©Ÿå°è³‡æ–™:`, machine);
                            console.log(`      MAC: ${machine.mac}, ID: ${machine.id}, DevID: ${machine.devid}`);
                            
                            if (machine.mac && machine.mac.trim()) {
                                // è™•ç† devidDataï¼ˆå¤šå€‹ devidï¼‰
                                if (machine.devidData && typeof machine.devidData === 'object') {
                                    const devids = Object.keys(machine.devidData);
                                    for (const devid of devids) {
                                        allMacAddresses.push({
                                            mac: machine.mac.trim(),
                                            devid: devid,
                                            storeName: store.name,
                                            machineId: machine.id || machine.docId,
                                            location: machine.location || 'æœªçŸ¥ä½ç½®'
                                        });
                                        console.log(`      âœ… å·²åŠ å…¥ MAC: ${machine.mac.trim()}, DevID: ${devid}`);
                                    }
                                }
                                // è™•ç†å–®ä¸€ devid
                                else if (machine.devid) {
                                    allMacAddresses.push({
                                        mac: machine.mac.trim(),
                                        devid: machine.devid,
                                        storeName: store.name,
                                        machineId: machine.id || machine.docId,
                                        location: machine.location || 'æœªçŸ¥ä½ç½®'
                                    });
                                    console.log(`      âœ… å·²åŠ å…¥ MAC: ${machine.mac.trim()}, DevID: ${machine.devid}`);
                                }
                                // æ²’æœ‰ devidï¼Œé è¨­ç‚º 1
                                else {
                                    allMacAddresses.push({
                                        mac: machine.mac.trim(),
                                        devid: 1,
                                        storeName: store.name,
                                        machineId: machine.id || machine.docId,
                                        location: machine.location || 'æœªçŸ¥ä½ç½®'
                                    });
                                    console.log(`      âœ… å·²åŠ å…¥ MAC: ${machine.mac.trim()}, DevID: 1 (é è¨­)`);
                                }
                            } else {
                                console.log(`      âš ï¸ æ©Ÿå°æ²’æœ‰ MAC ä½å€`);
                            }
                        }

                    } catch (error) {
                        console.error(`   âŒ è®€å– ${store.name} æ©Ÿå°å¤±æ•—:`, error);
                        totalFailed++;
                    }
                }

                console.log(`\nğŸ“‹ ç¸½å…±æ”¶é›†åˆ° ${allMacAddresses.length} å€‹ MAC+DevID çµ„åˆ`);
                console.log('ğŸ“‹ æ”¶é›†åˆ°çš„åˆ—è¡¨:', allMacAddresses);
                updateProgress(`æº–å‚™ç™¼é€ ${allMacAddresses.length} å€‹æŸ¥è©¢...`);

                // ä½¿ç”¨å»é‡å¾Œçš„ MAC+DevID çµ„åˆ
                const uniqueCombos = [];
                const seenKeys = new Set();
                for (const item of allMacAddresses) {
                    const key = `${item.mac}_${item.devid}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueCombos.push(item);
                    }
                }
                console.log(`ğŸ“‹ å»é‡å¾Œ: ${uniqueCombos.length} å€‹å”¯ä¸€çµ„åˆ`);
                console.log('ğŸ“‹ å»é‡å¾Œçš„çµ„åˆ:', uniqueCombos.map(c => `${c.mac}_${c.devid}`));

                if (uniqueCombos.length === 0) {
                    alert('æ²’æœ‰æ‰¾åˆ°ä»»ä½• MAC ä½å€ï¼Œè«‹ç¢ºèªæ©Ÿå°è¨­å®š');
                    progressDiv.parentNode.removeChild(progressDiv);
                    return;
                }

                // å¼·åˆ¶ä½¿ç”¨ HTTP ç™¼é€æŸ¥è©¢
                console.log('âœ… é–‹å§‹ç™¼é€ HTTP æŸ¥è©¢è¨Šæ¯');
                updateProgress('æ­£åœ¨ç™¼é€æŸ¥è©¢è¨Šæ¯...');

                // ä½¿ç”¨ XMLHttpRequest ç™¼é€æ‰€æœ‰æŸ¥è©¢
                for (let i = 0; i < uniqueCombos.length; i++) {
                    const combo = uniqueCombos[i];
                    const url = `http://update.feiloli.com.tw:5539/webReadCmd/${combo.mac}/${combo.devid}/`;
                    
                    console.log(`\n[${i+1}/${uniqueCombos.length}] ğŸ“¤ æº–å‚™ç™¼é€æŸ¥è©¢`);
                    console.log(`   MAC: ${combo.mac}, DevID: ${combo.devid}`);
                    console.log(`   URL: ${url}`);
                    
                    try {
                        // ä½¿ç”¨ XMLHttpRequestï¼ˆæ›´åº•å±¤ï¼Œæ›´å¯é ï¼‰
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.timeout = 5000; // 5ç§’è¶…æ™‚
                        
                        xhr.onload = function() {
                            console.log(`   âœ… ç™¼é€æˆåŠŸ: ${combo.mac}_${combo.devid} (ç‹€æ…‹: ${xhr.status})`);
                            totalSent++;
                        };
                        
                        xhr.onerror = function() {
                            console.log(`   âœ… æŸ¥è©¢å·²ç™¼é€åˆ°è¨­å‚™: ${combo.mac}_${combo.devid} (CORS éŒ¯èª¤å¯å¿½ç•¥)`);
                            totalSent++; // CORS éŒ¯èª¤è¡¨ç¤ºè«‹æ±‚å·²ç™¼å‡ºï¼Œåªæ˜¯ç„¡æ³•è®€å–å›æ‡‰
                        };
                        
                        xhr.ontimeout = function() {
                            console.log(`   âœ… æŸ¥è©¢å·²ç™¼é€: ${combo.mac}_${combo.devid} (è¨­å‚™å¯èƒ½é›¢ç·š)`);
                            totalSent++;
                        };
                        
                        xhr.send();
                        console.log(`   ğŸ“¡ è«‹æ±‚å·²ç™¼é€ï¼`);
                        
                        // æ¯å€‹è«‹æ±‚ä¹‹é–“ç¨å¾®å»¶é²ï¼Œé¿å…å¤ªå¿«
                        if (i < uniqueCombos.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`   âŒ ç™¼é€å¤±æ•— ${combo.mac}_${combo.devid}:`, error);
                        totalFailed++;
                    }
                    
                    // æ›´æ–°é€²åº¦
                    updateProgress(`æ­£åœ¨ç™¼é€... (${i+1}/${uniqueCombos.length})`);
                }

                // å®Œæˆæç¤º
                progressDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">æŸ¥è©¢å·²ç™¼é€ï¼</span>
                    </div>
                    <div class="text-sm">
                        é–€å¸‚: ${totalStores} å€‹<br>
                        æ©Ÿå°: ${totalMachines} å°<br>
                        å·²ç™¼é€: ${totalSent} å€‹æŸ¥è©¢<br>
                        <span class="text-yellow-200">â± è«‹ç­‰å¾… 2-3 ç§’å¾Œé€²å…¥é–€å¸‚æŸ¥çœ‹</span><br>
                        <span class="text-xs text-gray-200 mt-1 block">ğŸ’¡ CORS éŒ¯èª¤å¯å¿½ç•¥ï¼ŒæŸ¥è©¢å·²é€é”è¨­å‚™</span>
                    </div>
                `;

                console.log('\nâœ… æ‰€æœ‰æŸ¥è©¢å·²ç™¼é€å®Œæˆï¼');
                console.log(`ğŸ“Š çµ±è¨ˆ: ${totalStores} é–€å¸‚, ${totalMachines} æ©Ÿå°, ${totalSent} å€‹æŸ¥è©¢`);
                console.log('ğŸ’¡ æç¤º: CORS éŒ¯èª¤æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºæŸ¥è©¢å·²é€åˆ°è¨­å‚™ï¼Œåªæ˜¯ç€è¦½å™¨ç„¡æ³•è®€å–å›æ‡‰');
                console.log('ğŸ“ è«‹ç­‰å¾… 2-3 ç§’å¾Œï¼Œé€²å…¥é–€å¸‚é»æ“Šã€Œæ‰¹æ¬¡è®€å–ã€æŸ¥çœ‹çµæœ');

                // 5ç§’å¾Œè‡ªå‹•é—œé–‰
                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);

            } catch (error) {
                console.error('âŒ ç™¼é€æŸ¥è©¢å¤±æ•—:', error);
                
                progressDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">ç™¼é€å¤±æ•—</span>
                    </div>
                    <div class="text-sm">${error.message}</div>
                `;

                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);
            }
        }

        // ============================================
        // ğŸ“Š ç«‹å³è®€å–æ‰€æœ‰é–€å¸‚æ©Ÿå°è³‡æ–™
        // ============================================
        async function readAllStoresMachines(limitCount = null) {
            if (!selectedGroupId) {
                alert('è«‹å…ˆé¸æ“‡å–®ä½ç¾¤çµ„');
                return;
            }

            // ç¢ºèªæ“ä½œ
            let confirmMsg = 'ç¢ºå®šè¦ç«‹å³è®€å–æ‰€æœ‰é–€å¸‚çš„æ©Ÿå°è³‡æ–™å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. å…ˆç™¼é€æŸ¥è©¢çµ¦æ‰€æœ‰æ©Ÿå°\n2. ç­‰å¾… 2 ç§’è®“è¨­å‚™æº–å‚™è³‡æ–™\n3. è®€å–ä¸¦æ›´æ–°æ‰€æœ‰æ©Ÿå°çš„è³‡æ–™åˆ°è³‡æ–™åº«\n\næ­¤æ“ä½œéœ€è¦è¼ƒé•·æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚';
            
            if (limitCount) {
                confirmMsg = `ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼šåªè®€å–å‰ ${limitCount} çµ„æ©Ÿå°è³‡æ–™\n\né€™å°‡æœƒï¼š\n1. å…ˆç™¼é€æŸ¥è©¢çµ¦å‰ ${limitCount} çµ„æ©Ÿå°\n2. ç­‰å¾… 2 ç§’è®“è¨­å‚™æº–å‚™è³‡æ–™\n3. è®€å–ä¸¦æ›´æ–°é€™äº›æ©Ÿå°çš„è³‡æ–™\n\né©åˆå¿«é€Ÿæ¸¬è©¦åŠŸèƒ½ã€‚`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('ğŸ“Š é–‹å§‹è®€å–æ‰€æœ‰é–€å¸‚æ©Ÿå°è³‡æ–™');
            if (limitCount) {
                console.log(`ğŸ§ª æ¸¬è©¦æ¨¡å¼: åªè™•ç†å‰ ${limitCount} çµ„`);
            }
            console.log('='.repeat(80));

            // é¡¯ç¤ºé€²åº¦æç¤º
            const progressDiv = document.createElement('div');
            progressDiv.id = 'read-all-stores-progress';
            progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
            progressDiv.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="font-bold">æ­£åœ¨è™•ç†...</span>
                </div>
                <div id="read-progress-text" class="text-sm">æº–å‚™ä¸­...</div>
            `;
            document.body.appendChild(progressDiv);

            const updateProgress = (text) => {
                const progressText = document.getElementById('read-progress-text');
                if (progressText) progressText.textContent = text;
            };

            try {
                // ğŸ”§ å…ˆç¢ºä¿ appData å·²åˆå§‹åŒ–
                if (!window.appData) {
                    window.appData = { machines: [] };
                }
                
                // ç²å–æ‰€æœ‰é–€å¸‚
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`ğŸ“‹ æ‰¾åˆ° ${stores.length} å€‹é–€å¸‚`);
                updateProgress(`æ‰¾åˆ° ${stores.length} å€‹é–€å¸‚ï¼Œè¼‰å…¥æ©Ÿå°é…ç½®...`);
                
                // ğŸ”§ è¼‰å…¥æ‰€æœ‰æ©Ÿå°é…ç½®åˆ° appData.machines
                window.appData.machines = [];
                for (const store of stores) {
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({
                        docId: doc.id,
                        storeId: store.id,
                        storeName: store.name,
                        ...doc.data()
                    }));
                    
                    window.appData.machines.push(...machines);
                }
                
                console.log(`ğŸ“¦ å·²è¼‰å…¥ ${window.appData.machines.length} å°æ©Ÿå°é…ç½®`);
                
                // ğŸ”§ æ§‹å»ºæ©Ÿå°é…ç½®æ˜ å°„è¡¨
                buildMachineConfigMap();
                console.log(`âœ… æ˜ å°„è¡¨å·²æ§‹å»ºï¼Œå…± ${Object.keys(window.machineConfigMap || {}).length} æ¢æ˜ å°„`);

                updateProgress(`é–‹å§‹è™•ç† ${stores.length} å€‹é–€å¸‚...`);

                let totalStores = stores.length;
                let completedStores = 0;
                let totalMachines = 0;
                let totalSuccess = 0;
                let totalFailed = 0;

                // éšæ®µ 1: å…ˆç™¼é€æ‰€æœ‰æŸ¥è©¢
                console.log('\nğŸ“¤ éšæ®µ 1: ç™¼é€æŸ¥è©¢åˆ°æ‰€æœ‰æ©Ÿå°');
                updateProgress('éšæ®µ 1: ç™¼é€æŸ¥è©¢åˆ°æ‰€æœ‰æ©Ÿå°...');

                // ğŸ”§ ä½¿ç”¨å·²ç¶“è¼‰å…¥çš„ appData.machines ä¾†æ§‹å»º allCombos
                // é¿å…é‡è¤‡å¾ Firebase è¼‰å…¥,ç¢ºä¿ä½¿ç”¨åŒä¸€ä»½æ•¸æ“š
                const allCombos = [];
                
                for (const machine of window.appData.machines) {
                    totalMachines++;
                    
                    if (machine.mac && machine.mac.trim()) {
                        if (machine.devidData && typeof machine.devidData === 'object') {
                            const devids = Object.keys(machine.devidData);
                            for (const devid of devids) {
                                allCombos.push({
                                    mac: machine.mac.trim(),
                                    devid: devid,
                                    storeId: machine.storeId,
                                    storeName: machine.storeName,
                                    machine: machine
                                });
                            }
                        } else if (machine.devid) {
                            allCombos.push({
                                mac: machine.mac.trim(),
                                devid: machine.devid,
                                storeId: machine.storeId,
                                storeName: machine.storeName,
                                machine: machine
                            });
                        } else {
                            allCombos.push({
                                mac: machine.mac.trim(),
                                devid: 1,
                                storeId: machine.storeId,
                                storeName: machine.storeName,
                                machine: machine
                            });
                        }
                    }
                }

                console.log(`ğŸ“‹ ç¸½å…±æ‰¾åˆ° ${allCombos.length} å€‹æ©Ÿå°é…ç½®`);

                // å»é‡
                const uniqueCombos = [];
                const seenKeys = new Set();
                for (const item of allCombos) {
                    const key = `${item.mac}_${item.devid}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueCombos.push(item);
                    }
                }

                console.log(`ğŸ“‹ å»é‡å¾Œ: ${uniqueCombos.length} å€‹å”¯ä¸€é…ç½®`);

                // ğŸ§ª å¦‚æœæŒ‡å®šäº†é™åˆ¶æ•¸é‡,åªå–å‰ N çµ„
                let processedCombos = uniqueCombos;
                if (limitCount && limitCount > 0) {
                    processedCombos = uniqueCombos.slice(0, limitCount);
                    console.log(`ğŸ§ª æ¸¬è©¦æ¨¡å¼: å¾ ${uniqueCombos.length} çµ„ä¸­é¸å–å‰ ${processedCombos.length} çµ„`);
                }

                // ç™¼é€æŸ¥è©¢
                for (let i = 0; i < processedCombos.length; i++) {
                    const combo = processedCombos[i];
                    const url = `http://update.feiloli.com.tw:5539/webReadCmd/${combo.mac}/${combo.devid}/`;
                    
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.timeout = 3000;
                        xhr.send();
                        
                        if (i % 10 === 0) {
                            updateProgress(`ç™¼é€æŸ¥è©¢... (${i+1}/${processedCombos.length})`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (error) {
                        console.error(`ç™¼é€å¤±æ•—: ${combo.mac}_${combo.devid}`);
                    }
                }

                // éšæ®µ 2: ç­‰å¾…è¨­å‚™æº–å‚™è³‡æ–™
                console.log('\nâ±ï¸ éšæ®µ 2: ç­‰å¾… 2 ç§’è®“è¨­å‚™æº–å‚™è³‡æ–™');
                updateProgress('ç­‰å¾…è¨­å‚™æº–å‚™è³‡æ–™... (2ç§’)');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // éšæ®µ 3: è®€å–æ‰€æœ‰æ©Ÿå°è³‡æ–™ï¼ˆä½¿ç”¨åŸæœ¬çš„è®€å–æ–¹å¼ï¼‰
                console.log('\nğŸ“¥ éšæ®µ 3: é–‹å§‹è®€å–æ‰€æœ‰æ©Ÿå°è³‡æ–™');
                
                // ğŸ”§ ç¢ºèªæ˜ å°„è¡¨å­˜åœ¨ä¸”æœ‰æ•¸æ“š
                if (!window.machineConfigMap || Object.keys(window.machineConfigMap).length === 0) {
                    console.warn('âš ï¸ æ˜ å°„è¡¨ç‚ºç©º,é‡æ–°æ§‹å»º...');
                    buildMachineConfigMap();
                }
                console.log(`âœ… æ˜ å°„è¡¨ç‹€æ…‹: ${Object.keys(window.machineConfigMap || {}).length} æ¢æ˜ å°„`);
                console.log(`âœ… appData.machines: ${(window.appData?.machines || []).length} å°æ©Ÿå°`);
                
                // æŒ‰ MAC åˆ†çµ„ï¼ˆä¸€å€‹ MAC å¯èƒ½æœ‰å¤šå€‹ DevIDï¼‰
                const macGroups = {};
                for (const combo of processedCombos) {
                    if (!macGroups[combo.mac]) {
                        macGroups[combo.mac] = [];
                    }
                    macGroups[combo.mac].push(combo);
                }
                
                const uniqueMacs = Object.keys(macGroups);
                console.log(`ğŸ“‹ ç¸½å…± ${uniqueMacs.length} å€‹å”¯ä¸€ MAC ä½å€éœ€è¦è®€å–`);
                
                let readIndex = 0;
                for (const mac of uniqueMacs) {
                    readIndex++;
                    const combos = macGroups[mac];
                    updateProgress(`è®€å–è³‡æ–™: ${combos[0].storeName} (${readIndex}/${uniqueMacs.length})`);
                    
                    console.log(`\nğŸ“¥ [${readIndex}/${uniqueMacs.length}] è®€å– MAC: ${mac}`);
                    console.log(`   é–€å¸‚: ${combos[0].storeName}`);
                    console.log(`   æ©Ÿå°: ${combos.map(c => `${c.machine.id}(DevID=${c.devid})`).join(', ')}`);
                    
                    try {
                        // ğŸ”§ é‡è¦: éœ€è¦ç‚ºæ¯å€‹ DevID åˆ†åˆ¥èª¿ç”¨ sendHttpRequest
                        // å› ç‚º handleHttpResponse éœ€è¦çŸ¥é“è¦è™•ç†å“ªå€‹ DevID çš„æ•¸æ“š
                        for (const combo of combos) {
                            console.log(`   ğŸ“¡ è™•ç† ${combo.machine.id} (DevID=${combo.devid})`);
                            
                            try {
                                // è¨˜éŒ„è™•ç†å‰çš„ dailyRecords ç‹€æ…‹
                                const beforeRecordCount = Object.keys(window.dailyRecords || {}).length;
                                
                                // ğŸ”§ é—œéµä¿®æ­£: æŒ‡å®š devid åƒæ•¸,é€™æ¨£ handleHttpResponse æ‰èƒ½æ­£ç¢ºéæ¿¾æ•¸æ“š
                                const result = await sendHttpRequest(mac, combo.devid);
                                
                                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°å¢è¨˜éŒ„
                                const afterRecordCount = Object.keys(window.dailyRecords || {}).length;
                                const newRecords = afterRecordCount - beforeRecordCount;
                                
                                if (result && validateMachineData(result)) {
                                    console.log(`      âœ… è®€å–æˆåŠŸ`);
                                    console.log(`      ğŸ“Š è³‡æ–™é¡å‹: ${Array.isArray(result) ? `é™£åˆ— (${result.length} ç­†)` : typeof result}`);
                                    console.log(`      ğŸ“ æ–°å¢/æ›´æ–°è¨˜éŒ„: ${newRecords} ç­†`);
                                    
                                    // ä½¿ç”¨ findMachineConfig æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå°é…ç½®
                                    const machineConfig = findMachineConfig(mac, combo.devid);
                                    
                                    if (machineConfig) {
                                        const today = new Date().toISOString().split('T')[0];
                                        // ğŸ”§ ä½¿ç”¨æ­£ç¢ºçš„ key æ ¼å¼: machineId_location_date (åº•ç·šåˆ†éš”,èˆ‡ updateDailyRecord ä¸€è‡´)
                                        const recordKey = `${machineConfig.machineId}_${machineConfig.location}_${today}`;
                                        
                                        // æª¢æŸ¥ window.dailyRecords ä¸­æ˜¯å¦æœ‰é€™å€‹æ©Ÿå°çš„è¨˜éŒ„
                                        if (window.dailyRecords && window.dailyRecords[recordKey]) {
                                            const record = window.dailyRecords[recordKey];
                                            console.log(`      âœ… æŠ•å¹£=${record.plays}, å‡ºç=${record.payouts} (å·²è‡ªå‹•æ›´æ–°)`);
                                            totalSuccess++;
                                        } else {
                                            console.log(`      âš ï¸ æœªæ‰¾åˆ°è™•ç†è¨˜éŒ„ (key=${recordKey})`);
                                            console.log(`      ğŸ” å¯ç”¨çš„è¨˜éŒ„éµ:`, Object.keys(window.dailyRecords || {}).slice(0, 5));
                                            totalFailed++;
                                        }
                                    } else {
                                        console.log(`      âš ï¸ ç„¡æ³•æŸ¥æ‰¾æ©Ÿå°é…ç½®`);
                                        totalFailed++;
                                    }
                                    
                                } else {
                                    console.log(`      âš ï¸ è®€å–å¤±æ•—æˆ–è³‡æ–™ç„¡æ•ˆ`);
                                    totalFailed++;
                                }
                                
                                // æ¯å€‹ DevID ä¹‹é–“å»¶é² 200ms
                                await new Promise(resolve => setTimeout(resolve, 200));
                                
                            } catch (error) {
                                console.error(`      âŒ è™•ç†å¤±æ•—: ${error.message}`);
                                totalFailed++;
                            }
                        }
                        
                    } catch (error) {
                        console.error(`   âŒ MAC è™•ç†å¤±æ•—: ${error.message}`);
                        totalFailed += combos.length;
                    }

                    // æ¯å€‹ MAC ä¹‹é–“å»¶é²
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // å®Œæˆæç¤º
                progressDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">è®€å–å®Œæˆï¼</span>
                    </div>
                    <div class="text-sm">
                        é–€å¸‚: ${totalStores} å€‹<br>
                        æ©Ÿå°: ${totalMachines} å°<br>
                        æˆåŠŸ: ${totalSuccess} å€‹<br>
                        å¤±æ•—: ${totalFailed} å€‹
                    </div>
                `;

                console.log('\nâœ… æ‰€æœ‰é–€å¸‚è³‡æ–™è®€å–å®Œæˆï¼');
                console.log(`ğŸ“Š çµ±è¨ˆ: ${totalStores} é–€å¸‚, ${totalMachines} æ©Ÿå°, æˆåŠŸ ${totalSuccess}, å¤±æ•— ${totalFailed}`);

                // 5ç§’å¾Œè‡ªå‹•é—œé–‰
                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);

            } catch (error) {
                console.error('âŒ è®€å–æ‰€æœ‰é–€å¸‚è³‡æ–™å¤±æ•—:', error);
                
                progressDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">è®€å–å¤±æ•—</span>
                    </div>
                    <div class="text-sm">${error.message}</div>
                `;

                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);
            }
        }

        // é–‹å§‹è‡ªå‹•è¼ªè©¢ (HTTP ç‰ˆæœ¬)
        function startAutoPolling() {
            stopAutoPolling(); // ç¢ºä¿æ²’æœ‰é‡è¤‡çš„è¼ªè©¢
            
            const interval = pollSettings.pollInterval; // ä½¿ç”¨å¯é…ç½®çš„è¼ªè©¢é–“éš”
            
            console.log(`å•Ÿå‹•è‡ªå‹• HTTP è¼ªè©¢ï¼Œé–“éš”: ${interval/1000} ç§’`);
            
            pollInterval = setInterval(() => {
                console.log(`åŸ·è¡Œè‡ªå‹•è¼ªè©¢ (HTTP)`);
                executePollAllMachines();
            }, interval);
            
            showStatusMessage(`å·²å•Ÿå‹•è‡ªå‹•è¼ªè©¢ï¼Œé–“éš” ${interval/1000} ç§’`, 'success');
        }

        // åœæ­¢è‡ªå‹•è¼ªè©¢
        function stopAutoPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                showStatusMessage('å·²åœæ­¢è‡ªå‹•è¼ªè©¢', 'info');
            }
        }

        // ç‹€æ…‹è¨Šæ¯é¡¯ç¤º
        function showStatusMessage(message, type = 'info') {
            console.log(`ç‹€æ…‹è¨Šæ¯: ${message} (${type})`); // èª¿è©¦ç”¨
            
            // å°‹æ‰¾æˆ–å‰µå»ºç‹€æ…‹è¨Šæ¯å®¹å™¨
            let statusContainer = document.getElementById('mqtt-status-messages');
            if (!statusContainer) {
                statusContainer = document.createElement('div');
                statusContainer.id = 'mqtt-status-messages';
                statusContainer.className = 'fixed top-4 right-4 z-50 max-w-sm';
                document.body.appendChild(statusContainer);
            }

            const messageDiv = document.createElement('div');
            const bgColors = {
                info: 'bg-blue-600',
                success: 'bg-green-600', 
                error: 'bg-red-600'
            };

            messageDiv.className = `${bgColors[type]} text-white px-4 py-2 rounded-lg mb-2 shadow-lg transform transition-all duration-300`;
            messageDiv.textContent = message;

            statusContainer.appendChild(messageDiv);

            // è‡ªå‹•ç§»é™¤è¨Šæ¯
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // --- INITIAL LOAD ---
        // å»¶é²åˆå§‹åŒ– MQTT åŠŸèƒ½ï¼Œç¢ºä¿ä¸å½±éŸ¿ä¸»è¦è¼‰å…¥æµç¨‹
        setTimeout(() => {
            try {
                console.log('é–‹å§‹åˆå§‹åŒ– MQTT åŠŸèƒ½...');
                
                // è¼‰å…¥è¼ªè©¢è¨­å®š
                loadPollSettings();
                
                // åˆå§‹åŒ–è¼ªè©¢è¨­å®šæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
                const setCmdIntervalBtn = document.getElementById('set-cmd-interval-btn');
                const setPollIntervalBtn = document.getElementById('set-poll-interval-btn');
                const cmdIntervalInput = document.getElementById('cmd-interval-input');
                const pollIntervalInput = document.getElementById('poll-interval-input');
                
                if (setCmdIntervalBtn) {
                    setCmdIntervalBtn.addEventListener('click', () => {
                        const newValue = parseInt(cmdIntervalInput.value, 10);
                        if (newValue >= 0 && newValue <= 10000) {
                            pollSettings.cmdInterval = newValue;
                            savePollSettings();
                            updatePollSettingsDisplay();
                            showStatusMessage(`âœ… è®€å–æŒ‡ä»¤é–“éš”å·²è¨­å®šç‚º ${newValue}ms`, 'success');
                            console.log(`ğŸ“¤ è®€å–æŒ‡ä»¤é–“éš”è¨­å®šç‚º: ${newValue}ms`);
                        } else {
                            showStatusMessage(`âŒ è«‹è¼¸å…¥ 0-10000 ä¹‹é–“çš„æ•¸å€¼`, 'error');
                        }
                    });
                }
                
                if (setPollIntervalBtn) {
                    setPollIntervalBtn.addEventListener('click', () => {
                        const newValue = parseInt(pollIntervalInput.value, 10);
                        if (newValue >= 3 && newValue <= 300) {
                            pollSettings.pollInterval = newValue * 1000; // è½‰æ›ç‚ºæ¯«ç§’
                            savePollSettings();
                            updatePollSettingsDisplay();
                            
                            // å¦‚æœè¼ªè©¢æ­£åœ¨é€²è¡Œï¼Œéœ€è¦é‡æ–°å•Ÿå‹•
                            if (pollInterval) {
                                stopAutoPolling();
                                startAutoPolling();
                                showStatusMessage(`âœ… è¼ªè©¢é€±æœŸå·²æ›´æ–°ç‚º ${newValue}ç§’ï¼Œè¼ªè©¢å·²é‡æ–°å•Ÿå‹•`, 'success');
                            } else {
                                showStatusMessage(`âœ… è¼ªè©¢é€±æœŸå·²è¨­å®šç‚º ${newValue}ç§’`, 'success');
                            }
                            console.log(`ğŸ“Š è¼ªè©¢é€±æœŸè¨­å®šç‚º: ${newValue}ç§’`);
                        } else {
                            showStatusMessage(`âŒ è«‹è¼¸å…¥ 3-300 ä¹‹é–“çš„æ•¸å€¼`, 'error');
                        }
                    });
                }
                
                // âœ… æ–°å¢ï¼šåˆå§‹åŒ–å¿«é€Ÿè¼ªè©¢å„ªåŒ–è¨­å®šäº‹ä»¶ç›£è½å™¨
                const applyFastPollBtn = document.getElementById('apply-fast-poll-config');
                const resetFastPollBtn = document.getElementById('reset-fast-poll-config');
                const thresholdSlider = document.getElementById('early-termination-threshold');
                const thresholdDisplay = document.getElementById('threshold-display');
                const waitSlider = document.getElementById('wait-before-read');
                const waitDisplay = document.getElementById('wait-display');
                
                if (thresholdSlider && thresholdDisplay) {
                    thresholdSlider.addEventListener('input', () => {
                        thresholdDisplay.textContent = `${thresholdSlider.value}%`;
                    });
                }
                
                if (waitSlider && waitDisplay) {
                    waitSlider.addEventListener('input', () => {
                        const seconds = (waitSlider.value / 1000).toFixed(1);
                        waitDisplay.textContent = `${seconds}s`;
                    });
                }
                
                if (applyFastPollBtn) {
                    applyFastPollBtn.addEventListener('click', () => {
                        const maxRetries = parseInt(document.getElementById('fast-poll-max-retries')?.value) || 2;
                        const retryDelay = parseInt(document.getElementById('fast-poll-retry-delay')?.value) || 1000;
                        const threshold = parseInt(document.getElementById('early-termination-threshold')?.value) || 80;
                        const waitTime = parseInt(document.getElementById('wait-before-read')?.value) || 3000;
                        const enableEarlyTermination = document.getElementById('enable-early-termination')?.checked ?? true;
                        const enablePriorityFiltering = document.getElementById('enable-priority-filtering')?.checked ?? true;
                        
                        // æ›´æ–°å…¨åŸŸé…ç½®
                        fastPollConfig.maxRetries = maxRetries;
                        fastPollConfig.retryDelay = retryDelay;
                        fastPollConfig.earlyTerminationThreshold = threshold / 100;
                        fastPollConfig.waitBeforeRead = waitTime;
                        fastPollConfig.enableEarlyTermination = enableEarlyTermination;
                        fastPollConfig.enablePriorityFiltering = enablePriorityFiltering;
                        
                        console.log('ğŸ”§ å¿«é€Ÿè¼ªè©¢å„ªåŒ–é…ç½®å·²å¥—ç”¨:');
                        console.log(`   âœ“ æœ€å¤§é‡è©¦æ¬¡æ•¸: ${maxRetries} æ¬¡`);
                        console.log(`   âœ“ é‡è©¦é–“éš”: ${retryDelay}ms`);
                        console.log(`   âœ“ æå‰çµ‚æ­¢è‡¨ç•Œå€¼: ${threshold}%`);
                        console.log(`   âœ“ è®€å–ç­‰å¾…æ™‚é–“: ${waitTime}ms (${(waitTime/1000).toFixed(1)}ç§’)`);
                        console.log(`   âœ“ å•Ÿç”¨æå‰çµ‚æ­¢: ${enableEarlyTermination ? 'æ˜¯' : 'å¦'}`);
                        console.log(`   âœ“ å•Ÿç”¨å„ªå…ˆç´šéæ¿¾: ${enablePriorityFiltering ? 'æ˜¯' : 'å¦'}`);
                        
                        showStatusMessage('âœ… å¿«é€Ÿè¼ªè©¢å„ªåŒ–é…ç½®å·²å¥—ç”¨', 'success');
                    });
                }
                
                if (resetFastPollBtn) {
                    resetFastPollBtn.addEventListener('click', () => {
                        // é‡ç½®ç‚ºé è¨­å€¼
                        document.getElementById('fast-poll-max-retries').value = '2';
                        document.getElementById('fast-poll-retry-delay').value = '1000';
                        document.getElementById('early-termination-threshold').value = '80';
                        document.getElementById('wait-before-read').value = '3000';
                        document.getElementById('enable-early-termination').checked = true;
                        document.getElementById('enable-priority-filtering').checked = true;
                        
                        if (thresholdDisplay) {
                            thresholdDisplay.textContent = '80%';
                        }
                        if (waitDisplay) {
                            waitDisplay.textContent = '3.0s';
                        }
                        
                        // é‡ç½®å…¨åŸŸé…ç½®
                        fastPollConfig = {
                            enableEarlyTermination: true,
                            enablePriorityFiltering: true,
                            maxRetries: 2,
                            retryDelay: 1000,
                            earlyTerminationThreshold: 0.8,
                            waitBeforeRead: 3000
                        };
                        
                        console.log('ğŸ”„ å¿«é€Ÿè¼ªè©¢é…ç½®å·²é‡ç½®ç‚ºé è¨­å€¼');
                        showStatusMessage('âœ… å¿«é€Ÿè¼ªè©¢é…ç½®å·²é‡ç½®ç‚ºé è¨­å€¼', 'success');
                    });
                }
                
                initializeMqttPolling();
                initializeMqttControls();
                initializeDetailPanel();
                console.log('MQTT åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
                
                // æ·»åŠ å…¨åŸŸæ¸¬è©¦å‡½æ•¸ä¾›èª¿è©¦ä½¿ç”¨
                window.testMqttPolling = function() {
                    console.log('=== æ¸¬è©¦ MQTT è¼ªè©¢åŠŸèƒ½ ===');
                    console.log('MQTT å®¢æˆ¶ç«¯:', mqttClient);
                    console.log('MQTT é€£æ¥ç‹€æ…‹:', mqttConnected);
                    console.log('appData:', appData);
                    
                    if (appData && appData.machines) {
                        console.log('ç•¶å‰æ©Ÿå°åˆ—è¡¨:', appData.machines);
                        const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                        console.log('æœ‰ MAC ä½å€çš„æ©Ÿå°:', machinesWithMac);
                        if (machinesWithMac.length > 0) {
                            pollAllMachines();
                        } else {
                            console.log('æ²’æœ‰è¨­å®š MAC ä½å€çš„æ©Ÿå°');
                        }
                    } else {
                        console.log('appData æˆ–æ©Ÿå°åˆ—è¡¨ä¸å­˜åœ¨');
                    }
                };
                
                // æ·»åŠ  MQTT ç‹€æ…‹æª¢æŸ¥å‡½æ•¸
                window.checkMqttStatus = function() {
                    console.log('=== MQTT ç‹€æ…‹æª¢æŸ¥ ===');
                    console.log('mqttClient å­˜åœ¨:', !!mqttClient);
                    console.log('mqttConnected ç‹€æ…‹:', mqttConnected);
                    
                    // æª¢æŸ¥ MQTT ç‹€æ…‹æŒ‡ç¤ºå™¨
                    const statusIndicator = document.getElementById('mqtt-status-indicator');
                    const statusText = document.getElementById('mqtt-status-text');
                    if (statusIndicator) {
                        console.log('ç‹€æ…‹æŒ‡ç¤ºå™¨ class:', statusIndicator.className);
                    }
                    if (statusText) {
                        console.log('ç‹€æ…‹æ–‡å­—:', statusText.textContent);
                    }
                    
                    return { client: !!mqttClient, connected: mqttConnected };
                };
                
                // æ·»åŠ å¿«é€Ÿæ¸¬è©¦è¼ªè©¢åŠŸèƒ½ï¼ˆä½¿ç”¨åœ–ç‰‡ä¸­çš„ MAC ä½å€ï¼‰
                window.testQuickPoll = function() {
                    console.log('=== å¿«é€Ÿè¼ªè©¢æ¸¬è©¦ ===');
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    
                    // æª¢æŸ¥æœ¬åœ°å’Œå…¨åŸŸ MQTT å®¢æˆ¶ç«¯
                    const localClient = mqttClient;
                    const globalClient = window.mqttClient;
                    const activeClient = localClient || globalClient;
                    
                    console.log('æœ¬åœ°å®¢æˆ¶ç«¯:', !!localClient);
                    console.log('å…¨åŸŸå®¢æˆ¶ç«¯:', !!globalClient);
                    console.log('ä½¿ç”¨å®¢æˆ¶ç«¯:', !!activeClient);
                    
                    if (activeClient) {
                        console.log('å˜—è©¦è¼ªè©¢æ¸¬è©¦æ©Ÿå°...');
                        console.log('ä½¿ç”¨æ­£ç¢ºçš„å‘½ä»¤æ ¼å¼ï¼šåŒ…å« cmd, mac, floor, devid, taskid');
                        pollSingleMachine(testMac, testDevId);
                    } else {
                        console.log('ç„¡ MQTT å®¢æˆ¶ç«¯å¯ç”¨');
                        alert('è«‹å…ˆé€£æ¥ MQTT å†é€²è¡Œæ¸¬è©¦');
                    }
                };
                
                // æ·»åŠ  MQTT ç‹€æ…‹æª¢æŸ¥åŠŸèƒ½
                window.checkMqttStatus = function() {
                    console.log('=== MQTT ç‹€æ…‹æª¢æŸ¥ ===');
                    console.log('æœ¬åœ° mqttClient:', !!mqttClient);
                    console.log('æœ¬åœ° mqttConnected:', mqttConnected);
                    console.log('å…¨åŸŸ window.mqttClient:', !!window.mqttClient);
                    console.log('å…¨åŸŸ window.mqttConnected:', window.mqttConnected);
                    
                    if (mqttClient) {
                        console.log('mqttClient.connected:', mqttClient.connected);
                        console.log('mqttClient.disconnected:', mqttClient.disconnected);
                        console.log('mqttClient.reconnecting:', mqttClient.reconnecting);
                    }
                    
                    const statusElement = document.getElementById('mqtt-status-text');
                    if (statusElement) {
                        console.log('UI ç‹€æ…‹æ–‡å­—:', statusElement.textContent);
                    }
                };
                
                // å¼·åˆ¶åŒæ­¥ MQTT ç‹€æ…‹
                window.syncMqttStatus = function() {
                    console.log('=== å¼·åˆ¶åŒæ­¥ MQTT ç‹€æ…‹ ===');
                    
                    // å¦‚æœæœ¬åœ° mqttClient å­˜åœ¨ä½†å…¨åŸŸæ²’æœ‰ï¼ŒåŒæ­¥åˆ°å…¨åŸŸ
                    if (mqttClient && !window.mqttClient) {
                        console.log('åŒæ­¥æœ¬åœ°å®¢æˆ¶ç«¯åˆ°å…¨åŸŸ');
                        window.mqttClient = mqttClient;
                    }
                    
                    // å¦‚æœå…¨åŸŸ mqttClient å­˜åœ¨ä½†æœ¬åœ°æ²’æœ‰ï¼Œå¾å…¨åŸŸå–å¾—
                    if (!mqttClient && window.mqttClient) {
                        console.log('å¾å…¨åŸŸå–å¾—å®¢æˆ¶ç«¯åˆ°æœ¬åœ°');
                        mqttClient = window.mqttClient;
                    }
                    
                    // åŒæ­¥é€£æ¥ç‹€æ…‹
                    if (mqttClient && mqttClient.connected) {
                        console.log('åµæ¸¬åˆ°å®¢æˆ¶ç«¯å·²é€£æ¥ï¼ŒåŒæ­¥ç‹€æ…‹');
                        mqttConnected = true;
                        window.mqttConnected = true;
                        updateMqttStatus(true, 'ç‹€æ…‹å·²åŒæ­¥');
                    }
                    
                    console.log('åŒæ­¥å®Œæˆ - æœ¬åœ°å®¢æˆ¶ç«¯:', !!mqttClient, 'å…¨åŸŸå®¢æˆ¶ç«¯:', !!window.mqttClient);
                    return {
                        localClient: !!mqttClient,
                        globalClient: !!window.mqttClient,
                        localConnected: mqttConnected,
                        globalConnected: window.mqttConnected
                    };
                };

                // ç°¡æ˜“è¨ºæ–·å’Œä¿®å¾©åŠŸèƒ½
                window.fixMqttPolling = function() {
                    console.log('=== MQTT è¼ªè©¢ä¿®å¾©ç¨‹åº ===');
                    
                    // 1. æª¢æŸ¥ UI ç‹€æ…‹
                    const statusText = document.getElementById('mqtt-status-text');
                    const connectBtn = document.getElementById('mqtt-connect-btn');
                    console.log('UI ç‹€æ…‹:', statusText?.textContent);
                    console.log('æŒ‰éˆ•æ–‡å­—:', connectBtn?.textContent);
                    
                    // 2. æª¢æŸ¥è®Šæ•¸ç‹€æ…‹
                    console.log('è®Šæ•¸ç‹€æ…‹ - æœ¬åœ°å®¢æˆ¶ç«¯:', !!mqttClient, 'å…¨åŸŸå®¢æˆ¶ç«¯:', !!window.mqttClient);
                    console.log('é€£æ¥ç‹€æ…‹ - æœ¬åœ°:', mqttConnected, 'å…¨åŸŸ:', window.mqttConnected);
                    
                    // 3. å¦‚æœ UI é¡¯ç¤ºå·²é€£æ¥ä½†è®Šæ•¸æœªåŒæ­¥ï¼Œå¼·åˆ¶åŒæ­¥
                    if (statusText?.textContent.includes('å·²é€£æ¥') || statusText?.textContent.includes('é€£ç·šæˆåŠŸ')) {
                        console.log('UI é¡¯ç¤ºå·²é€£æ¥ï¼Œä½†è®Šæ•¸å¯èƒ½æœªåŒæ­¥ï¼ŒåŸ·è¡Œä¿®å¾©...');
                        
                        // å¦‚æœæ²’æœ‰å®¢æˆ¶ç«¯ä½† UI èªªå·²é€£æ¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°é€£æ¥
                        if (!mqttClient && !window.mqttClient) {
                            console.log('æœªæ‰¾åˆ°å®¢æˆ¶ç«¯ï¼Œå»ºè­°é‡æ–°é€£æ¥');
                            alert('æª¢æ¸¬åˆ°é€£æ¥ç•°å¸¸ï¼Œè«‹é»æ“Šã€Œé‡æ–°é€£ç·šã€æŒ‰éˆ•');
                            return false;
                        }
                        
                        // åŒæ­¥ç‹€æ…‹
                        window.syncMqttStatus();
                    }
                    
                    // 4. æ¸¬è©¦è¼ªè©¢
                    console.log('å˜—è©¦æ¸¬è©¦è¼ªè©¢...');
                    if (window.testQuickPoll) {
                        window.testQuickPoll();
                        return true;
                    } else {
                        console.error('testQuickPoll å‡½æ•¸ä¸å­˜åœ¨');
                        return false;
                    }
                };

                // æ¸¬è©¦è©³ç´°é¢æ¿é¡¯ç¤ºåŠŸèƒ½
                window.testDetailPanel = function() {
                    console.log('=== æ¸¬è©¦è©³ç´°é¢æ¿é¡¯ç¤º ===');
                    
                    // å‰µå»ºæ¨¡æ“¬è³‡æ–™
                    const mockMachine = {
                        id: 'TEST-001',
                        mac: '083A8DE1ED14',
                        devid: 1
                    };
                    
                    const mockMqttData = {
                        voltageData: {
                            strongVoltage: 12,
                            mediumVoltage: 8,
                            weakVoltage: 5,
                            heightToTop: 10,
                            clampVoltage: 15
                        },
                        operationData: {
                            winRateBank: 100,
                            coinGameCount: 50,
                            prizeCount: 10,
                            accumulatedAmount1: 500,
                            accumulatedAmount2: 300,
                            accumulatedAmount3: 200
                        },
                        rawHex: '1234567890ABCDEF',
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: false
                    };
                    
                    console.log('ä½¿ç”¨æ¨¡æ“¬è³‡æ–™æ¸¬è©¦é¢æ¿é¡¯ç¤º...');
                    showMachineDetailPanel(mockMachine, mockMqttData);
                };

                // æª¢æŸ¥é ç±¤å’Œé¢æ¿ç‹€æ…‹
                window.checkTabAndPanel = function() {
                    console.log('=== æª¢æŸ¥é ç±¤å’Œé¢æ¿ç‹€æ…‹ ===');
                    
                    const currentTab = document.querySelector('.tab-btn.active');
                    const machinesTabContent = document.getElementById('machines');
                    const detailPanel = document.getElementById('machine-detail-panel');
                    
                    console.log('ç•¶å‰æ´»å‹•é ç±¤:', currentTab?.textContent);
                    console.log('æ©Ÿå°ç®¡ç†é ç±¤æ˜¯å¦é¡¯ç¤º:', !machinesTabContent?.classList.contains('hidden'));
                    console.log('è©³ç´°é¢æ¿æ˜¯å¦é¡¯ç¤º:', !detailPanel?.classList.contains('hidden'));
                    console.log('è©³ç´°é¢æ¿å…ƒç´ å­˜åœ¨:', !!detailPanel);
                    
                    if (detailPanel) {
                        console.log('è©³ç´°é¢æ¿é¡åˆ¥:', detailPanel.className);
                    }
                    
                    return {
                        currentTab: currentTab?.textContent,
                        machinesTabVisible: !machinesTabContent?.classList.contains('hidden'),
                        detailPanelVisible: !detailPanel?.classList.contains('hidden'),
                        detailPanelExists: !!detailPanel
                    };
                };

                // é©—è­‰ MQTT å‘½ä»¤æ ¼å¼
                window.validateMqttCommand = function() {
                    console.log('=== MQTT å‘½ä»¤æ ¼å¼é©—è­‰ ===');
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const expectedCommand = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    console.log('æ­£ç¢ºçš„å‘½ä»¤æ ¼å¼æ‡‰è©²æ˜¯:');
                    console.log(JSON.stringify(expectedCommand, null, 2));
                    console.log('');
                    console.log('å‘½ä»¤èªªæ˜:');
                    console.log('- cmd: å‘½ä»¤é¡å‹ (readdata)');
                    console.log('- mac: æ©Ÿå°WiFiå°å¡MAC');
                    console.log('- floor: å›ºå®šç‚º "1"');
                    console.log('- devid: å¤©è»Šæ¿ (å·¦å¤©è»ŠID:1ï¼Œå³å¤©è»ŠID:2)');
                    console.log('- taskid: å‘½ä»¤ç·¨è™Ÿ (æ™‚é–“æˆ³æ ¼å¼)');
                    
                    return expectedCommand;
                };

                // ç›´æ¥æ¸¬è©¦å‘½ä»¤ç™¼é€ï¼ˆä¸ä¾è³´å…¶ä»–å‡½æ•¸ï¼‰
                window.testDirectMqttSend = function() {
                    console.log('=== ç›´æ¥æ¸¬è©¦ MQTT å‘½ä»¤ç™¼é€ ===');
                    
                    const activeClient = mqttClient || window.mqttClient;
                    if (!activeClient) {
                        console.error('æ²’æœ‰å¯ç”¨çš„ MQTT å®¢æˆ¶ç«¯');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const topic = 'coffeelens/req';
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const commandObject = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    const message = JSON.stringify(commandObject);
                    
                    console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ç›´æ¥ç™¼é€æ¸¬è©¦ ğŸ”¥ğŸ”¥ğŸ”¥');
                    console.log('ä¸»é¡Œ:', topic);
                    console.log('å‘½ä»¤ç‰©ä»¶:', commandObject);
                    console.log('JSON å­—ä¸²:', message);
                    console.log('ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥');
                    
                    activeClient.publish(topic, message, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('ç™¼é€å¤±æ•—:', err);
                        } else {
                            console.log('âœ… ç›´æ¥æ¸¬è©¦å‘½ä»¤ç™¼é€æˆåŠŸï¼');
                        }
                    });
                    
                    return true;
                };
                
                // ç™¼é€ç°¡å–®çš„ ping æ¸¬è©¦
                window.testMachinePing = function() {
                    console.log('=== æ¸¬è©¦æ©Ÿå° Ping ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT æœªé€£æ¥');
                        return;
                    }
                    
                    // ç™¼é€ç°¡å–®çš„ ping å‘½ä»¤
                    const pingCommand = {
                        cmd: 'ping',
                        timestamp: new Date().toISOString()
                    };
                    
                    const topics = ['coffeelens/req', 'machine/ping', 'system/ping'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            console.log(`ç™¼é€ ping åˆ°: ${topic}`);
                            client.publish(topic, JSON.stringify(pingCommand), { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`Ping ${topic} å¤±æ•—:`, err);
                                } else {
                                    console.log(`âœ… Ping ${topic} ç™¼é€æˆåŠŸ`);
                                }
                            });
                        }, index * 1000);
                    });
                };

                // æ¸¬è©¦ç²å–ç‡Ÿæ¥­è³‡æ–™çš„ä¸åŒå‘½ä»¤
                window.testBusinessDataCommands = function() {
                    console.log('=== æ¸¬è©¦ç‡Ÿæ¥­è³‡æ–™å‘½ä»¤ ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT æœªé€£æ¥');
                        return;
                    }
                    
                    const machineId = '65db7656fb39'; // å¾å›æ‡‰ä¸­ç²å¾—çš„æ©Ÿå° ID
                    const timestamp = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    // å˜—è©¦ä¸åŒçš„ç‡Ÿæ¥­è³‡æ–™å‘½ä»¤æ ¼å¼
                    const commands = [
                        // åŸå§‹æ ¼å¼
                        {
                            cmd: 'readdata',
                            mac: '083A8DE1ED14',
                            floor: '1',
                            devid: '1',
                            taskid: timestamp + '001'
                        },
                        // ä½¿ç”¨æ©Ÿå°åç¨±
                        {
                            cmd: 'getdata',
                            machine_id: machineId,
                            request_type: 'business_data',
                            taskid: timestamp + '002'
                        },
                        // ç°¡åŒ–å‘½ä»¤
                        {
                            cmd: 'data',
                            target: machineId,
                            taskid: timestamp + '003'
                        },
                        // ç‹€æ…‹æŸ¥è©¢
                        {
                            cmd: 'status',
                            machine: machineId,
                            type: 'sales',
                            taskid: timestamp + '004'
                        },
                        // éŠ·å”®è³‡æ–™
                        {
                            cmd: 'sales_data',
                            device_id: machineId,
                            taskid: timestamp + '005'
                        }
                    ];
                    
                    const topics = ['coffeelens/req', 'machine/command', 'device/request'];
                    
                    commands.forEach((command, cmdIndex) => {
                        topics.forEach((topic, topicIndex) => {
                            const delay = (cmdIndex * topics.length + topicIndex) * 2000;
                            setTimeout(() => {
                                const message = JSON.stringify(command);
                                console.log(`æ¸¬è©¦å‘½ä»¤ ${cmdIndex + 1}.${topicIndex + 1}: ${topic}`);
                                console.log('å‘½ä»¤:', command);
                                
                                client.publish(topic, message, { qos: 0 }, function(err) {
                                    if (err) {
                                        console.error(`å‘½ä»¤ ${cmdIndex + 1}.${topicIndex + 1} ç™¼é€å¤±æ•—:`, err);
                                    } else {
                                        console.log(`âœ… å‘½ä»¤ ${cmdIndex + 1}.${topicIndex + 1} ç™¼é€æˆåŠŸ`);
                                        addCommandLog('send', `æ¸¬è©¦ç‡Ÿæ¥­è³‡æ–™å‘½ä»¤ - ${command.cmd}`, command);
                                    }
                                });
                            }, delay);
                        });
                    });
                };

                // æª¢æŸ¥ç•¶å‰é é¢æ™‚é–“æˆ³ï¼Œç¢ºä¿æ˜¯æœ€æ–°ç‰ˆæœ¬
                window.checkPageVersion = function() {
                    console.log('=== é é¢ç‰ˆæœ¬æª¢æŸ¥ ===');
                    console.log('ç•¶å‰æ™‚é–“:', new Date().toLocaleString());
                    console.log('pollSingleMachine å‡½æ•¸å­˜åœ¨:', typeof pollSingleMachine === 'function');
                    console.log('testDirectMqttSend å‡½æ•¸å­˜åœ¨:', typeof window.testDirectMqttSend === 'function');
                    
                    // æª¢æŸ¥å‡½æ•¸å…§å®¹æ˜¯å¦åŒ…å«æ–°çš„æ ¼å¼
                    const funcString = pollSingleMachine.toString();
                    const hasCorrectFormat = funcString.includes('cmd: \'readdata\'') && 
                                           funcString.includes('floor: \'1\'') && 
                                           funcString.includes('taskid: taskid');
                    
                    console.log('pollSingleMachine åŒ…å«æ­£ç¢ºæ ¼å¼:', hasCorrectFormat);
                    
                    if (!hasCorrectFormat) {
                        console.error('âš ï¸ å‡½æ•¸é‚„æ˜¯èˆŠç‰ˆæœ¬ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢ï¼');
                        alert('è«‹æŒ‰ Ctrl+F5 å¼·åˆ¶é‡æ–°è¼‰å…¥é é¢');
                    } else {
                        console.log('âœ… å‡½æ•¸å·²æ›´æ–°ç‚ºæ–°ç‰ˆæœ¬');
                    }
                };

                // æª¢æŸ¥æ©Ÿå°åˆ—è¡¨å’Œ MAC ä½å€
                window.checkMachineList = function() {
                    console.log('=== æª¢æŸ¥æ©Ÿå°åˆ—è¡¨ ===');
                    
                    if (!appData || !appData.machines) {
                        console.error('æ²’æœ‰æ©Ÿå°è³‡æ–™');
                        return;
                    }
                    
                    console.log('ç¸½æ©Ÿå°æ•¸é‡:', appData.machines.length);
                    
                    const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                    console.log('æœ‰ MAC ä½å€çš„æ©Ÿå°:', machinesWithMac.length);
                    
                    console.log('æ©Ÿå°æ¸…å–®:');
                    appData.machines.forEach((machine, index) => {
                        console.log(`${index + 1}. ID: ${machine.id}`);
                        console.log(`   MAC: ${machine.mac || 'æœªè¨­å®š'}`);
                        console.log(`   DevID: ${machine.devid || '1'}`);
                        console.log(`   æœ‰MAC: ${!!(machine.mac && machine.mac.trim())}`);
                        console.log('---');
                    });
                    
                    // æª¢æŸ¥æ¸¬è©¦ç”¨çš„ MAC æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
                    const testMac = '083A8DE1ED14';
                    const foundMachine = appData.machines.find(m => m.mac === testMac);
                    
                    console.log(`æ¸¬è©¦ MAC (${testMac}) æ˜¯å¦åœ¨æ©Ÿå°åˆ—è¡¨ä¸­:`, !!foundMachine);
                    if (foundMachine) {
                        console.log('æ‰¾åˆ°çš„æ©Ÿå°:', foundMachine);
                    } else {
                        console.warn('æ¸¬è©¦ MAC ä¸åœ¨æ©Ÿå°åˆ—è¡¨ä¸­ï¼Œéœ€è¦å…ˆæ·»åŠ æ©Ÿå°');
                    }
                    
                    return {
                        totalMachines: appData.machines.length,
                        machinesWithMac: machinesWithMac.length,
                        testMacExists: !!foundMachine
                    };
                };

                // æ‰‹å‹•æ·»åŠ æ¸¬è©¦æ©Ÿå°
                window.addTestMachine = function() {
                    const testMac = '083A8DE1ED14';
                    const existingMachine = appData.machines.find(m => m.mac === testMac);
                    
                    if (existingMachine) {
                        console.log('æ¸¬è©¦æ©Ÿå°å·²å­˜åœ¨:', existingMachine);
                        return existingMachine;
                    }
                    
                    const newMachine = {
                        id: 'TEST-001',
                        mac: testMac,
                        devid: 1,
                        storeName: 'æ¸¬è©¦åº—èˆ–',
                        addedBy: 'manual',
                        addedAt: new Date().toISOString()
                    };
                    
                    appData.machines.push(newMachine);
                    console.log('å·²æ·»åŠ æ¸¬è©¦æ©Ÿå°:', newMachine);
                    
                    // æ›´æ–° UI
                    if (typeof renderMachineManagementTab === 'function') {
                        renderMachineManagementTab();
                    }
                    
                    return newMachine;
                };

                // æ¸¬è©¦æ©Ÿå°å›æ‡‰ä¸»é¡Œ
                window.testMachineTopics = function() {
                    console.log('=== æ¸¬è©¦æ©Ÿå°å›æ‡‰ä¸»é¡Œ ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT æœªé€£æ¥');
                        return;
                    }
                    
                    // æ¸¬è©¦å¸¸è¦‹çš„æ©Ÿå°å›æ‡‰ä¸»é¡Œ
                    const testTopics = [
                        'machine/response',
                        'machine/data',
                        'machine/status',
                        'device/response',
                        'device/data',
                        'coffeelens/machine',
                        'coffeelens/data',
                        'system/response',
                        'response',
                        'data'
                    ];
                    
                    console.log('å˜—è©¦è¨‚é–±æ¸¬è©¦ä¸»é¡Œ...');
                    testTopics.forEach(topic => {
                        client.subscribe(topic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn(`è¨‚é–± ${topic} å¤±æ•—:`, err);
                            } else {
                                console.log(`âœ… æˆåŠŸè¨‚é–±: ${topic}`);
                            }
                        });
                    });
                    
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œç™¼é€è®€å–å‘½ä»¤
                    setTimeout(() => {
                        console.log('ç™¼é€æ¸¬è©¦è®€å–å‘½ä»¤...');
                        testDirectMqttSend();
                    }, 2000);
                };

                // æ¸¬è©¦ MQTT é€£æ¥å’Œè¨‚é–±ç‹€æ…‹
                window.testMqttConnection = function() {
                    console.log('=== MQTT é€£æ¥ç‹€æ…‹æ¸¬è©¦ ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('æ²’æœ‰ MQTT å®¢æˆ¶ç«¯');
                        return false;
                    }
                    
                    console.log('MQTT å®¢æˆ¶ç«¯å­˜åœ¨:', !!client);
                    console.log('é€£æ¥ç‹€æ…‹:', client.connected);
                    console.log('é‡æ–°é€£æ¥ä¸­:', client.reconnecting);
                    console.log('æ–·é–‹ä¸­:', client.disconnecting);
                    
                    // æª¢æŸ¥è¨‚é–±çš„ä¸»é¡Œ
                    const subscribedTopics = Object.keys(client.options.subscriptions || {});
                    console.log('å·²è¨‚é–±çš„ä¸»é¡Œ:', subscribedTopics);
                    
                    // æª¢æŸ¥ UI è¨­å®šçš„ä¸»é¡Œ
                    const topicInput = document.getElementById('mqtt-topic');
                    console.log('UI è¨­å®šçš„è¨‚é–±ä¸»é¡Œ:', topicInput?.value);
                    
                    // ç™¼é€ä¸€å€‹æ¸¬è©¦è¨Šæ¯åˆ°è‡ªå·±
                    const testTopic = 'test/echo';
                    const testMessage = JSON.stringify({ test: true, timestamp: new Date().toISOString() });
                    
                    console.log('ç™¼é€æ¸¬è©¦å›è²è¨Šæ¯...');
                    client.publish(testTopic, testMessage, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('æ¸¬è©¦è¨Šæ¯ç™¼é€å¤±æ•—:', err);
                        } else {
                            console.log('æ¸¬è©¦è¨Šæ¯ç™¼é€æˆåŠŸ');
                        }
                    });
                    
                    return {
                        connected: client.connected,
                        reconnecting: client.reconnecting,
                        subscribedTopics: subscribedTopics,
                        uiTopic: topicInput?.value
                    };
                };

                // æ‰‹å‹•è¨‚é–±æ¸¬è©¦ä¸»é¡Œ
                window.subscribeTestTopic = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('æ²’æœ‰ MQTT å®¢æˆ¶ç«¯');
                        return false;
                    }
                    
                    const testTopic = 'test/echo';
                    console.log('è¨‚é–±æ¸¬è©¦ä¸»é¡Œ:', testTopic);
                    
                    client.subscribe(testTopic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('è¨‚é–±æ¸¬è©¦ä¸»é¡Œå¤±æ•—:', err);
                        } else {
                            console.log('âœ… è¨‚é–±æ¸¬è©¦ä¸»é¡ŒæˆåŠŸ');
                        }
                    });
                };

                // æ¸¬è©¦ä¸åŒçš„æ©Ÿå°å‘½ä»¤æ ¼å¼
                window.testDifferentFormats = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('æ²’æœ‰ MQTT å®¢æˆ¶ç«¯');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const topics = ['coffeelens/req', 'machine/request', 'device/command'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            const message = JSON.stringify({
                                cmd: 'readdata',
                                mac: testMac,
                                floor: '1',
                                devid: '1',
                                taskid: new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17)
                            });
                            
                            console.log(`æ¸¬è©¦ä¸»é¡Œ ${index + 1}: ${topic}`);
                            console.log(`è¨Šæ¯: ${message}`);
                            
                            client.publish(topic, message, { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`ä¸»é¡Œ ${topic} ç™¼é€å¤±æ•—:`, err);
                                } else {
                                    console.log(`âœ… ä¸»é¡Œ ${topic} ç™¼é€æˆåŠŸ`);
                                }
                            });
                        }, index * 2000); // æ¯ 2 ç§’ç™¼é€ä¸€å€‹
                    });
                };
                
            } catch (error) {
                console.error('åˆå§‹åŒ– MQTT åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }, 2000); // å¢åŠ åˆ° 2 ç§’ç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
        
        // åˆå§‹åŒ–è‡ªå‹•è¨˜å¸³è¡¨æ ¼
        setTimeout(() => {
            console.log('ğŸ“Š åˆå§‹åŒ–è‡ªå‹•è¨˜å¸³è¡¨æ ¼...');
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
        }, 500);
        
        // ä¸å†ç›´æ¥è¼‰å…¥ç¾¤çµ„é é¢ï¼Œç”±ç™»å…¥é‚è¼¯æ§åˆ¶
        // showGroupSelectionPage(); 
        
        // é€šçŸ¥ç™»å…¥ç³»çµ±ä¸»æ‡‰ç”¨ç¨‹å¼å·²è¼‰å…¥å®Œæˆ
        window.dispatchEvent(new CustomEvent('appLoaded'));
    });
    </script>
</body>
</html>

