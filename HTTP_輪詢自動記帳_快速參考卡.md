# 🚀 HTTP 輪詢自動記帳 - 快速參考卡

**版本**: v2.0 | **日期**: 2025-10-23

---

## ⚡ 快速開始

### 1️⃣ 啟動輪詢
```
點擊: 📊 立即輪詢所有機台
↓
系統輪詢所有機台（3.2 秒）
↓
自動收集營業數據
```

### 2️⃣ 檢查結果
```
查看: 📊 HTTP 輪詢自動記帳 表格
↓
觀察變化指示符: 🔄 💰 📦 ✨
↓
確認新增和更新機台數量
```

### 3️⃣ 批量新增
```
點擊: ✅ 批量新增所有機台
↓
系統自動區分操作型態
✨ 新增 X 筆
🔄 更新 Y 筆
↓
表格清空，準備下次輪詢
```

---

## 📊 表格指示符速查

| 符號 | 含義 | 顏色 | 操作 |
|------|------|------|------|
| ✨ | 新記錄 | 白色 | 首次新增 |
| 🔄 | 已更新 | 藍色 | 檢測到變化 |
| 💰 | 投幣變化 | 黃色 | 投幣次數增加 |
| 📦 | 出貨變化 | 綠色 | 出貨數量增加 |

### 組合示例
```
✨ 1              新記錄，尚無變化
🔄 💰 2           更新2次，投幣有變化
🔄 📦 3           更新3次，出貨有變化
🔄 💰📦 5         更新5次，投幣和出貨都有變化
```

---

## 📈 數據欄位速查

### 日期記錄結構
```
{
  date: "2025-10-23",           // 記錄日期
  machineId: "A001",            // 機台編號
  location: "上1",              // 機台位置
  plays: 135,                   // 當前投幣數
  payouts: 9,                   // 當前出貨數
  
  // 變化標記
  playsChanged: true,           // 投幣是否變化
  payoutsChanged: true,         // 出貨是否變化
  
  // 變化值
  lastPlays: 130,               // 上一次投幣數
  lastPayouts: 8,               // 上一次出貨數
  
  // 統計信息
  updateCount: 3,               // 已更新3次
  createdAt: "08:57:07",        // 建立時間
  updatedAt: "08:57:09"         // 最後更新時間
}
```

---

## 🔍 輪詢狀態檢查

### 狀態訊息解讀

```
✅ 輪詢完成！
- 已查詢: 3 台機台
- 新增: 1 筆記錄
- 更新: 2 筆記錄
- 耗時: 3.2 秒
```

### 含義
- **已查詢** = 成功輪詢的機台總數
- **新增** = 首次記錄的機台 (updateCount=1)
- **更新** = 檢測到變化的機台 (updateCount>1)
- **耗時** = 從開始輪詢到完成的總時間

---

## 🎯 常見操作

### 操作 1: 查看詳細變化
```
在表格中找到該機台的行
↓
查看「最後更新」欄
↓
顯示示例:
  08:57:09
  💰 投幣: +5
  📦 出貨: +2
↓
表示此次更新增加了 5 次投幣和 2 次出貨
```

### 操作 2: 查看完整歷史
```
打開瀏覽器控制台 (F12)
↓
輸入: window.dailyRecords
↓
展開相應機台的記錄
↓
查看 history 陣列的所有變化
```

### 操作 3: 手動刷新表格
```
打開瀏覽器控制台
↓
輸入: refreshAutoRecordTable()
↓
表格立即重新整理
```

---

## ⚙️ 輪詢間隔設定

### 推薦配置

| 使用場景 | 推薦間隔 | 說明 |
|---------|---------|------|
| 實時監控 | 5 秒 | 數據最及時，伺服器負荷較高 |
| 常規營業 | 30 秒 | 推薦配置，平衡性能和及時性 |
| 低頻檢查 | 60 秒 | 數據延遲較大，伺服器負荷低 |
| 定時結帳 | 手動 | 營業結束時手動執行輪詢 |

### 設定方法
```
1. 打開「HTTP 即時同步」區塊
2. 選擇「輪詢間隔」下拉選單
3. 選擇需要的時間間隔
4. 勾選「啟用自動輪詢所有機台」
5. 系統開始定時執行
```

---

## 🐛 快速故障排除

### 問題: 沒有新增記錄
```
□ 確認機台是否有 MAC 位址
□ 檢查 HTTP 伺服器是否在線
□ 查看控制台錯誤訊息
→ 檢查 HTTP 連線狀態
```

### 問題: 變化值不對
```
□ 確認輪詢數據是否正確接收
□ 檢查上次記錄值是否准確
□ 查看計算公式: playsDelta = plays - lastPlays
→ 手動刷新頁面重試
```

### 問題: 批量新增失敗
```
□ 確認表單欄位是否完整
□ 檢查機台選擇器是否有相應選項
□ 查看 Firebase 連線狀態
→ 手動重新新增單筆記錄
```

---

## 🎓 工作流程圖

```
┌─────────────────────┐
│  開始輪詢所有機台   │
└──────────┬──────────┘
           │
     ┌─────▼────────────────────┐
     │ 遍歷所有有MAC的機台      │
     └──────┬─────────────────┬──┘
            │                 │
       [機台A]           [機台B]
            │                 │
  ┌─────────▼──────┐  ┌──────▼────────┐
  │HTTP GET請求    │  │HTTP GET請求   │
  └────────┬───────┘  └───────┬───────┘
           │                  │
      [取得數據]           [取得數據]
           │                  │
    ┌──────▼────────┐  ┌─────▼────────┐
    │更新記錄      │  │更新記錄      │
    │檢測變化      │  │檢測變化      │
    └──────┬───────┘  └─────┬────────┘
           │                 │
    ┌──────▼─────────────────▼─────┐
    │  刷新自動記帳表格             │
    │  - 顯示新增記錄               │
    │  - 顯示更新記錄               │
    │  - 顯示變化指示符 (💰📦🔄✨) │
    └──────┬──────────────────────┘
           │
     ┌─────▼──────────────────────┐
     │ 輪詢完成！                  │
     │ 已查詢: 3 台機台            │
     │ 新增: 1 筆, 更新: 2 筆      │
     └─────┬──────────────────────┘
           │
     ┌─────▼──────────────┐
     │ 用戶檢查表格      │
     │ 確認數據無誤      │
     └─────┬──────────────┘
           │
     ┌─────▼──────────────────────┐
     │ 點擊「批量新增所有機台」   │
     └─────┬──────────────────────┘
           │
     ┌─────▼─────────────────────────┐
     │ 系統自動執行:                  │
     │ ✨ 新增 1 筆 (首次記錄)       │
     │ 🔄 更新 2 筆 (檢測到變化)    │
     └─────┬──────────────────────────┘
           │
     ┌─────▼──────────────┐
     │ 記錄保存完成      │
     │ 表格清空          │
     │ 等待下一次輪詢    │
     └───────────────────┘
```

---

## 💾 鍵盤快捷鍵 (控制台)

### 常用命令

```javascript
// 查看所有輪詢記錄
window.dailyRecords

// 查看指定機台的記錄
window.dailyRecords['A001_上1_2025-10-23']

// 刷新表格
refreshAutoRecordTable()

// 手動執行輪詢
pollAllMachines()

// 批量新增
batchAddAllMachines()

// 查看 HTTP 配置
httpConfig

// 查看最後一次回應
httpLastResponse

// 查看輪詢計數
console.log(`請求數: ${httpRequestCount}, 錯誤數: ${httpErrorCount}`)
```

---

## 📚 相關文檔

| 文檔名 | 用途 | 對象 |
|--------|------|------|
| HTTP_輪詢自動記帳_改進說明.md | 功能介紹 | 📌 用戶 |
| HTTP_輪詢自動記帳_技術實現清單.md | 技術細節 | 👨‍💻 開發者 |
| HTTP_輪詢自動記帳_完整總結.md | 項目總結 | 📊 管理者 |
| **HTTP_輪詢自動記帳_快速參考卡.md** | 快速查詢 | ⚡ 所有人 |

---

## ✅ 功能清單

### 核心功能
- ✅ 批量輪詢所有機台
- ✅ 自動檢測投幣次數變化
- ✅ 自動檢測出貨數量變化
- ✅ 智能區分新增/更新操作
- ✅ 批量新增/更新記錄

### 顯示功能
- ✅ 變化指示符 (🔄💰📦✨)
- ✅ 變化值顯示 (+N)
- ✅ 更新計數 (N 次)
- ✅ 時間戳記錄

### 統計功能
- ✅ 輪詢機台計數
- ✅ 新增記錄計數
- ✅ 更新記錄計數
- ✅ 耗時統計

---

**提示**: 打印此頁面作為速查手冊，或保存到您的設備以便快速查閱。

**版本**: 1.0 | **最後更新**: 2025-10-23

