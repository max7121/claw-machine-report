<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式查帳系統 - 娃娃機營業報告 (多單位雲端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: white; background-color: #1f2937; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .stats-period-btn { transition: all 0.2s; }
        .stats-period-btn.active { background-color: #3b82f6; color: white; }
        .table-header-sortable { cursor: pointer; transition: background-color 0.2s; }
        .table-header-sortable:hover { background-color: #374151; }
        .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        .table-header-sortable.sorted .sort-indicator { opacity: 1; }
        input, select { color-scheme: dark; }
        .chart-container { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; }
        .chart-bar { transition: width 0.5s ease-in-out; }
        .card-base { transition: transform 0.2s, box-shadow 0.2s; }
        .card-base:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .preset-tag { cursor: pointer; transition: background-color 0.2s; }
        .preset-tag:hover { background-color: #4f46e5; }
        
        /* 圖表樣式 */
        .checkout-chart svg { filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)); }
        .checkout-chart circle { transition: all 0.2s ease; }
        .checkout-chart circle:hover { filter: brightness(1.2); transform: scale(1.2); }
        .checkout-chart path { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)); }
        
        /* 編輯模態框樣式 */
        #edit-machine-modal { 
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease-out;
        }
        #edit-machine-modal.hidden {
            animation: modalFadeOut 0.3s ease-in;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .edit-modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* 戰情室專用樣式 */
        .cc-rank-period-btn.active {
            background-color: #2563eb !important;
            color: white !important;
        }
        
        .cc-trend-bar {
            transition: height 0.5s ease-out;
            background: linear-gradient(to top, #3b82f6, #8b5cf6);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
        }
        
        .cc-trend-bar:hover {
            filter: brightness(1.2);
        }
        
        .cc-alert-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .cc-machine-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .cc-machine-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .cc-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 輪巡管理卡牌樣式 */
        .patrol-store-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .patrol-store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);
        }
        
        .patrol-status {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- 登入/使用者區塊 -->
    <div id="user-bar" class="max-w-7xl mx-auto flex justify-end mb-4 hidden">
        <div class="flex items-center gap-3">
            <span id="user-greeting" class="text-gray-300">歡迎，<strong id="user-name">使用者</strong></span>
            <button id="admin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded hidden">管理</button>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">登出</button>
        </div>
    </div>

    <!-- 登入 modal (預設顯示，如果未登入) -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">請先登入</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-1">帳號</label>
                    <input id="username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="輸入帳號">
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-1">密碼</label>
                    <input id="password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="輸入密碼">
                </div>
                <div class="flex items-center justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">登入</button>
                </div>
                <div id="login-feedback" class="text-sm text-red-400 mt-2 hidden"></div>
            </form>
        </div>
    </div>

    <!-- 層級 1: 單位群組選擇頁面 -->
    <div id="group-selection-page" class="max-w-4xl mx-auto hidden">
        <h1 class="text-4xl font-bold text-white text-center mb-8">娃娃機查帳系統</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">建立新單位群組</h2>
            <form id="create-group-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-group-name" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入單位名稱 (例如：A單位)" required>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">建立群組</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">選擇您的單位群組</h2>
            <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">正在讀取群組列表...</p>
            </div>
        </div>
    </div>

    <!-- 管理者設定頁面 -->
    <div id="admin-page" class="max-w-6xl mx-auto hidden">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-4xl font-bold text-white">系統管理</h1>
            <button id="back-to-main-btn" class="text-blue-400 hover:text-blue-300 transition flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                <span>返回主系統</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 管理員帳密設定 -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">管理員帳密設定</h2>
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm text-gray-300 mb-1">目前密碼</label>
                        <input id="current-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-username" class="block text-sm text-gray-300 mb-1">新帳號</label>
                        <input id="new-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm text-gray-300 mb-1">新密碼</label>
                        <input id="new-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm text-gray-300 mb-1">確認密碼</label>
                        <input id="confirm-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">更新管理員帳密</button>
                </form>
                <div id="admin-password-feedback" class="text-sm mt-2 hidden"></div>
            </div>

            <!-- 訪客帳號管理 -->
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-4">訪客帳號管理</h2>
                <form id="guest-account-form" class="space-y-4 mb-6">
                    <div>
                        <label for="guest-username" class="block text-sm text-gray-300 mb-1">訪客帳號</label>
                        <input id="guest-username" type="text" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label for="guest-password" class="block text-sm text-gray-300 mb-1">訪客密碼</label>
                        <input id="guest-password" type="password" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">可訪問的群組</label>
                        <div id="group-permissions" class="space-y-2 max-h-32 overflow-y-auto bg-gray-700 p-3 rounded-lg">
                            <p class="text-gray-400 text-sm">載入群組列表中...</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">頁面訪問權限</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 bg-gray-700 p-4 rounded-lg">
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">報表功能</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="details" class="page-permission-checkbox rounded text-blue-600">
                                    <span>機台明細</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="summary" class="page-permission-checkbox rounded text-blue-600">
                                    <span>營運總覽</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="analysis" class="page-permission-checkbox rounded text-blue-600">
                                    <span>經營分析</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="charts" class="page-permission-checkbox rounded text-blue-600">
                                    <span>圖表統計</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="statistics" class="page-permission-checkbox rounded text-blue-600">
                                    <span>數據統計</span>
                                </label>
                            </div>
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-green-300">操作功能</h4>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="accounting" class="page-permission-checkbox rounded text-green-600">
                                    <span>每日記帳</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="machines" class="page-permission-checkbox rounded text-green-600">
                                    <span>機台管理</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="profit" class="page-permission-checkbox rounded text-yellow-600">
                                    <span>盈利計算</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="checkout" class="page-permission-checkbox rounded text-green-600">
                                    <span>結帳作業</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="download" class="page-permission-checkbox rounded text-purple-600">
                                    <span>下載報告</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" value="edit" class="page-permission-checkbox rounded text-orange-600">
                                    <span>編輯/刪除</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" id="select-all-permissions" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">全選</button>
                            <button type="button" id="select-readonly-permissions" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">僅檢視</button>
                            <button type="button" id="clear-all-permissions" class="text-xs bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">清除</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">新增訪客</button>
                        <button type="button" id="cancel-guest-edit" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">取消</button>
                    </div>
                </form>
                <div id="guest-account-feedback" class="text-sm mt-2 hidden"></div>
            </div>
        </div>

        <!-- 訪客帳號列表 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">現有訪客帳號</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-4">帳號</th>
                            <th class="p-4">狀態</th>
                            <th class="p-4">可訪問群組</th>
                            <th class="p-4">頁面權限</th>
                            <th class="p-4">建立時間</th>
                            <th class="p-4 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="guest-accounts-table" class="divide-y divide-gray-700">
                        <tr><td colspan="6" class="text-center p-8 text-gray-400">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 系統工具 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">系統工具</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="export-config-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">匯出設定</button>
                <button id="import-config-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition">匯入設定</button>
                <button id="reset-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">重置系統</button>
            </div>
            <input type="file" id="config-file-input" accept=".json" class="hidden">
        </div>
    </div>

    <!-- 層級 2: 門市選擇頁面 (預設隱藏) -->
    <div id="store-selection-page" class="max-w-4xl mx-auto hidden">
         <button id="back-to-groups-btn" class="text-blue-400 hover:text-blue-300 transition mb-4 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <span>返回群組列表</span>
        </button>
        <h1 id="store-page-title" class="text-4xl font-bold text-white text-center mb-8">門市管理</h1>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">建立新門市</h2>
            <form id="create-store-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="new-store-name" class="block text-sm font-medium text-gray-300 mb-1">門市名稱</label>
                    <input type="text" id="new-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：台中逢甲店" required>
                </div>
                 <div>
                    <label for="new-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">營業起始日</label>
                    <input type="date" id="new-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <button type="submit" class="sm:col-span-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition shrink-0">建立門市</button>
            </form>
        </div>
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
             <h2 class="text-2xl font-bold text-white mb-4">選擇要管理的門市</h2>
            <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-3">下載所選門市報表</h3>
                <div class="flex flex-col gap-4 w-full">
                    <!-- 第一排：CSV報表按鈕 -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
                        <!-- 隱藏外部選擇器，改由彈窗內選擇 -->
                        <select id="report-period-selector" class="hidden bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                            <option value="all">總和</option>
                            <option value="daily">單日</option>
                            <option value="weekly">週報</option>
                            <option value="monthly">月報</option>
                            <option value="quarterly">季報</option>
                            <option value="yearly">年報</option>
                        </select>
                        <input type="date" id="report-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto hidden" title="選擇報表基準日">
                        <button id="download-all-stores-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0 w-full sm:w-auto justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                            </svg>
                            <span>自定義門市報表</span>
                        </button>
                    </div>
                    
                    <!-- 第二排：網頁預覽報表區塊 -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full border-t border-gray-700 pt-4">
                        <select id="preview-period-selector" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto">
                            <option value="all">全部期間</option>
                            <option value="daily">單日</option>
                            <option value="weekly">週報</option>
                            <option value="monthly">月報</option>
                            <option value="quarterly">季報</option>
                            <option value="yearly">年報</option>
                        </select>
                        <input type="date" id="preview-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="選擇報表基準日">
                        <button id="open-store-report-view-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto justify-center">
                            網頁預覽報表
                        </button>
                    </div>
                    
                    <!-- 第三排：每周營業額趨勢分析 -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full border-t border-gray-700 pt-4 mt-4">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label class="text-gray-300 text-sm whitespace-nowrap">起始日期</label>
                            <input type="date" id="weekly-trend-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="選擇起始日期">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label class="text-gray-300 text-sm whitespace-nowrap">結束日期</label>
                            <input type="date" id="weekly-trend-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full sm:w-auto" title="選擇結束日期">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <button id="open-weekly-trend-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                                </svg>
                                單一門市趨勢
                            </button>
                            <button id="open-multi-weekly-trend-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                                </svg>
                                多門市周報比較
                            </button>
                        </div>
                    </div>
                    
                    <!-- 第四排：禮品管理 -->
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full border-t border-gray-700 pt-4 mt-4">
                        <button id="open-gift-management-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                            🎁 禮品資料管理
                        </button>
                        <button id="open-store-gift-config-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto flex items-center justify-center gap-2">
                            🎰 門市禮品配置
                        </button>
                        <span class="text-gray-400 text-sm">管理禮品資料與機台禮品配置</span>
                    </div>
                </div>
            </div>
             <div class="flex justify-end gap-4 mb-4">
                 <button id="poll-all-stores-btn" class="text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                     </svg>
                     立即輪詢所有門市
                 </button>
                 <button id="select-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">全選</button>
                 <button id="deselect-all-stores-btn" class="text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">取消全選</button>
             </div>
            <div id="store-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">正在讀取門市列表...</p>
            </div>
        </div>
        
        <!-- 戰情室入口按鈕 -->
        <div class="bg-gradient-to-r from-purple-900 via-indigo-900 to-blue-900 rounded-xl shadow-lg p-6 mt-8 border border-purple-500/30">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-4 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">🎯 戰情室</h2>
                        <p class="text-purple-200">即時監控所有門市營運狀況、數據分析與異常警示</p>
                    </div>
                </div>
                <button id="open-command-center-btn" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    進入戰情室
                </button>
            </div>
        </div>
        
        <!-- 輪巡管理入口按鈕 -->
        <div class="bg-gradient-to-r from-green-900 via-teal-900 to-cyan-900 rounded-xl shadow-lg p-6 mt-8 border border-green-500/30">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-green-500 to-teal-600 p-4 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">🔄 輪巡管理</h2>
                        <p class="text-green-200">快速輪巡所有門市機台、批量新增記錄</p>
                    </div>
                </div>
                <button id="open-patrol-management-btn" class="bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    進入輪巡管理
                </button>
            </div>
        </div>
    </div>

    <!-- 輪巡管理頁面 -->
    <div id="patrol-management-page" class="max-w-7xl mx-auto hidden">
        <!-- 輪巡管理標題區 -->
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <button id="back-from-patrol-management-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span>返回門市列表</span>
                    </button>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2 flex items-center gap-3">
                        <span class="bg-gradient-to-r from-green-500 to-teal-500 bg-clip-text text-transparent">🔄 輪巡管理</span>
                        <span class="text-lg font-normal text-gray-400" id="patrol-management-group-name"></span>
                    </h1>
                    <p class="text-gray-400 flex items-center gap-2">
                        <span id="patrol-management-last-update">最後輪巡：--</span>
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="patrol-all-stores-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        輪巡所有門市
                    </button>
                    <button id="batch-add-all-stores-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        批量新增所有門市
                    </button>
                    <button id="fix-today-history-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        修正今日記錄
                    </button>
                    <button id="show-cumulative-data-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        查看累計資料
                    </button>
                    <button id="delete-today-records-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        刪除今日記錄
                    </button>
                </div>
            </div>
        </header>

        <!-- 輪巡狀態總覽 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-white mb-4">📊 輪巡狀態總覽</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-900/50 p-4 rounded-lg text-center">
                    <p class="text-gray-400 text-sm">總門市數</p>
                    <p class="text-2xl font-bold text-white" id="patrol-total-stores">0</p>
                </div>
                <div class="bg-gray-900/50 p-4 rounded-lg text-center">
                    <p class="text-gray-400 text-sm">總機台數</p>
                    <p class="text-2xl font-bold text-cyan-400" id="patrol-total-machines">0</p>
                </div>
                <div class="bg-gray-900/50 p-4 rounded-lg text-center">
                    <p class="text-gray-400 text-sm">已輪巡記錄</p>
                    <p class="text-2xl font-bold text-green-400" id="patrol-total-records">0</p>
                </div>
                <div class="bg-gray-900/50 p-4 rounded-lg text-center">
                    <p class="text-gray-400 text-sm">待新增記錄</p>
                    <p class="text-2xl font-bold text-yellow-400" id="patrol-pending-records">0</p>
                </div>
            </div>
        </div>

        <!-- 門市卡牌列表 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">🏪 門市輪巡操作</h2>
            <div id="patrol-store-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="text-gray-400 col-span-full text-center py-8">正在載入門市列表...</p>
            </div>
        </div>

        <!-- 輪巡操作記錄 -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">📋 輪巡操作記錄</h2>
                <button id="clear-patrol-log-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded">清除記錄</button>
            </div>
            <div id="patrol-operation-log" class="max-h-64 overflow-y-auto space-y-2">
                <p class="text-gray-500 text-sm text-center py-4">尚無輪巡操作記錄</p>
            </div>
        </div>
    </div>

    <!-- 戰情室頁面 -->
    <div id="command-center-page" class="max-w-7xl mx-auto hidden">
        <!-- 戰情室標題區 -->
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <button id="back-from-command-center-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        <span>返回門市列表</span>
                    </button>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2 flex items-center gap-3">
                        <span class="bg-gradient-to-r from-purple-500 to-indigo-500 bg-clip-text text-transparent">🎯 戰情室</span>
                        <span class="text-lg font-normal text-gray-400" id="command-center-group-name"></span>
                    </h1>
                    <p class="text-gray-400 flex items-center gap-2">
                        <span id="command-center-last-update">最後更新：--</span>
                        <button id="refresh-command-center-btn" class="text-blue-400 hover:text-blue-300 transition p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </p>
                    <span id="cc-snapshot-status" class="text-xs text-gray-500 ml-2"></span>
                </div>
                <div class="flex items-center gap-3">
                    <button id="cc-snapshot-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 px-3 rounded-lg transition flex items-center gap-1" title="建立今日快照，用於計算每日/週/月數據">
                        📸 建立快照
                    </button>
                    <select id="command-center-period" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4">
                        <option value="today">今日</option>
                        <option value="week" selected>本週</option>
                        <option value="month">本月</option>
                        <option value="current">當期（未結帳）</option>
                        <option value="all">全部期間</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Phase 1: 即時營運總覽面板 - KPI 卡片 -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <!-- 今日營收 -->
            <div class="bg-gradient-to-br from-green-900/50 to-green-800/30 p-4 rounded-xl border border-green-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-green-400 text-sm font-medium" id="cc-revenue-label">💰 期間營收</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-total-revenue">$0</p>
                <p class="text-xs text-green-300 mt-1" id="cc-revenue-change">-- vs 上期</p>
            </div>
            
            <!-- 總投幣數 -->
            <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 p-4 rounded-xl border border-blue-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-blue-400 text-sm font-medium">🎮 總投幣數</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-total-plays">0</p>
                <p class="text-xs text-blue-300 mt-1" id="cc-plays-change">-- vs 上期</p>
            </div>
            
            <!-- 總出貨數 -->
            <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 p-4 rounded-xl border border-purple-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-purple-400 text-sm font-medium">🎁 總出貨數</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-total-payouts">0</p>
                <p class="text-xs text-purple-300 mt-1" id="cc-payouts-change">-- vs 上期</p>
            </div>
            
            <!-- 平均出貨成本 -->
            <div class="bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 p-4 rounded-xl border border-yellow-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-yellow-400 text-sm font-medium">📊 平均成本</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-avg-cost">$0</p>
                <p class="text-xs mt-1" id="cc-cost-status">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-300">● 正常</span>
                </p>
            </div>
            
            <!-- 活躍門市 -->
            <div class="bg-gradient-to-br from-cyan-900/50 to-cyan-800/30 p-4 rounded-xl border border-cyan-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-cyan-400 text-sm font-medium">🏪 活躍門市</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-active-stores">0/0</p>
                <p class="text-xs text-cyan-300 mt-1">有資料回傳</p>
            </div>
            
            <!-- 總機台數 -->
            <div class="bg-gradient-to-br from-pink-900/50 to-pink-800/30 p-4 rounded-xl border border-pink-500/30 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-pink-400 text-sm font-medium">🎰 總機台數</span>
                </div>
                <p class="text-2xl font-bold text-white" id="cc-total-machines">0</p>
                <p class="text-xs text-pink-300 mt-1">跨所有門市</p>
            </div>
        </div>

        <!-- 主要內容區域 - 左右兩欄 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 左側：門市排行榜 (Phase 2) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 門市營收排行榜 -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <span>🏆</span> 門市營收排行
                        </h3>
                        <div class="flex gap-2">
                            <button class="cc-rank-period-btn text-xs py-1 px-3 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600" data-period="today">今日</button>
                            <button class="cc-rank-period-btn active text-xs py-1 px-3 rounded-lg bg-blue-600 text-white" data-period="week">本週</button>
                            <button class="cc-rank-period-btn text-xs py-1 px-3 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600" data-period="month">本月</button>
                        </div>
                    </div>
                    <div id="cc-store-ranking" class="space-y-3">
                        <p class="text-gray-400 text-center py-8">載入中...</p>
                    </div>
                </div>

                <!-- 營收趨勢圖 (Phase 2) -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <span>📈</span> 當期營收分佈
                        </h3>
                    </div>
                    <div id="cc-revenue-trend-chart" class="h-64 flex items-end justify-between gap-2 px-4">
                        <!-- 趨勢圖將由 JavaScript 動態生成 -->
                        <p class="text-gray-400 text-center w-full py-8">載入中...</p>
                    </div>
                    <div id="cc-trend-labels" class="flex justify-between px-4 mt-2 text-xs text-gray-400">
                        <!-- 日期標籤 -->
                    </div>
                </div>
            </div>

            <!-- 右側：警示與快速統計 (Phase 3) -->
            <div class="space-y-6">
                <!-- 異常警示面板 -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-4">
                        <span>⚠️</span> 異常警示
                    </h3>
                    <div id="cc-alerts" class="space-y-3 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-center py-4">檢查中...</p>
                    </div>
                </div>

                <!-- 快速統計 -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-4">
                        <span>📋</span> 快速統計
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">最高營收門市</span>
                            <span class="text-white font-medium" id="cc-top-store">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">最佳機台</span>
                            <span class="text-white font-medium" id="cc-top-machine">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">日均營收</span>
                            <span class="text-white font-medium" id="cc-daily-avg">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">本週成長</span>
                            <span class="text-green-400 font-medium" id="cc-weekly-growth">--%</span>
                        </div>
                    </div>
                </div>

                <!-- 待處理事項 -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-4">
                        <span>📝</span> 待處理事項
                    </h3>
                    <div id="cc-pending-items" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">檢查中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 門市詳細表格 -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>🏪</span> 各門市營運概況
                </h3>
                <button id="cc-export-data-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    匯出報表
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-4">排名</th>
                            <th class="p-4">門市名稱</th>
                            <th class="p-4 text-right">營收</th>
                            <th class="p-4 text-right">投幣數</th>
                            <th class="p-4 text-right">出貨數</th>
                            <th class="p-4 text-right">平均成本</th>
                            <th class="p-4 text-center">狀態</th>
                            <th class="p-4 text-center">趨勢</th>
                        </tr>
                    </thead>
                    <tbody id="cc-stores-table" class="divide-y divide-gray-700">
                        <tr><td colspan="8" class="text-center py-8 text-gray-400">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 三週 PSD 分析 -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>📊</span> 三週 PSD 分析 (每店每日平均營收)
                </h3>
                <div class="flex items-center gap-3">
                    <label class="text-gray-300 text-sm">基準日期：</label>
                    <input type="date" id="cc-psd-base-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                    <button id="cc-calculate-psd-btn" onclick="calculateThreeWeekPSD()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                        計算三週 PSD
                    </button>
                    <button id="cc-export-psd-btn" onclick="exportPSDToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        匯出 CSV
                    </button>
                </div>
            </div>
            <!-- PSD 週期摘要卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="cc-psd-summary-cards">
                <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 p-4 rounded-xl border border-blue-500/30">
                    <div class="text-blue-400 text-sm font-medium mb-1">第一週 (最近)</div>
                    <div class="text-xs text-gray-400 mb-2" id="cc-psd-week1-range">--</div>
                    <div class="text-2xl font-bold text-white" id="cc-psd-week1-value">$0</div>
                    <div class="text-xs text-blue-300 mt-1" id="cc-psd-week1-total">總營收: $0</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 p-4 rounded-xl border border-purple-500/30">
                    <div class="text-purple-400 text-sm font-medium mb-1">第二週</div>
                    <div class="text-xs text-gray-400 mb-2" id="cc-psd-week2-range">--</div>
                    <div class="text-2xl font-bold text-white" id="cc-psd-week2-value">$0</div>
                    <div class="text-xs text-purple-300 mt-1" id="cc-psd-week2-total">總營收: $0</div>
                </div>
                <div class="bg-gradient-to-br from-pink-900/50 to-pink-800/30 p-4 rounded-xl border border-pink-500/30">
                    <div class="text-pink-400 text-sm font-medium mb-1">第三週</div>
                    <div class="text-xs text-gray-400 mb-2" id="cc-psd-week3-range">--</div>
                    <div class="text-2xl font-bold text-white" id="cc-psd-week3-value">$0</div>
                    <div class="text-xs text-pink-300 mt-1" id="cc-psd-week3-total">總營收: $0</div>
                </div>
            </div>
            <!-- PSD 詳細表格 -->
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-3">門市名稱</th>
                            <th class="p-3 text-right">第一週營收</th>
                            <th class="p-3 text-right">第一週 PSD</th>
                            <th class="p-3 text-right">第二週營收</th>
                            <th class="p-3 text-right">第二週 PSD</th>
                            <th class="p-3 text-right">第三週營收</th>
                            <th class="p-3 text-right">第三週 PSD</th>
                            <th class="p-3 text-center">趨勢</th>
                        </tr>
                    </thead>
                    <tbody id="cc-psd-table" class="divide-y divide-gray-700">
                        <tr><td colspan="8" class="text-center py-8 text-gray-400">請選擇基準日期並點擊「計算三週 PSD」</td></tr>
                    </tbody>
                    <tfoot class="bg-gray-700/30 font-bold">
                        <tr id="cc-psd-total-row">
                            <td class="p-3 text-white">全部門市合計</td>
                            <td class="p-3 text-right text-blue-400" id="cc-psd-total-week1-revenue">--</td>
                            <td class="p-3 text-right text-blue-400" id="cc-psd-total-week1-psd">--</td>
                            <td class="p-3 text-right text-purple-400" id="cc-psd-total-week2-revenue">--</td>
                            <td class="p-3 text-right text-purple-400" id="cc-psd-total-week2-psd">--</td>
                            <td class="p-3 text-right text-pink-400" id="cc-psd-total-week3-revenue">--</td>
                            <td class="p-3 text-right text-pink-400" id="cc-psd-total-week3-psd">--</td>
                            <td class="p-3 text-center">--</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- 機台績效分析 (Phase 2 延伸) -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>��</span> 跨門市機台績效 TOP 10
                </h3>
                <select id="cc-machine-sort" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-3 text-sm">
                    <option value="revenue">依營收</option>
                    <option value="plays">依投幣數</option>
                    <option value="efficiency">依效率</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="cc-top-machines">
                <p class="text-gray-400 text-center py-8 col-span-full">載入中...</p>
            </div>
        </div>
    </div>

    <!-- 層級 3: 報表主頁面 (預設隱藏) -->
    <div id="report-page" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button id="back-to-stores-btn" class="text-blue-400 hover:text-blue-300 transition mb-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span>返回門市列表</span>
                    </button>
                    <h1 id="report-title-main" class="text-3xl sm:text-4xl font-bold text-white mb-2">娃娃機營業報告</h1>
                    <p class="text-lg text-gray-400" id="report-period">統計期間：</p>
                </div>
                <div id="header-download-buttons" class="flex items-center gap-2">
                    <button id="download-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>自定義報表下載</span>
                    </button>
                     <button id="download-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        <span>快速列印 (PDF)</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 當期統計說明 -->
        <div class="mb-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
            <p class="text-blue-300 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                以下數據為當期未結帳統計（總數據扣除最後結帳資料後的數值）
            </p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-blue-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期投幣次數</p>
                    <p class="text-2xl font-bold text-white" id="total-plays">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-green-500 p-3 rounded-full">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-7 6h7m-3 4h3m-4-11H9m4 0h1M9 12H7m2 4h1m-1 4H8m12 0h-1m-1-4h1m-1-4h1m-4-4h1m4 4h1m-1 4h1" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期投幣金額</p>
                    <p class="text-2xl font-bold text-white" id="total-revenue">0 元</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-purple-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期出貨次數</p>
                    <p class="text-2xl font-bold text-white" id="total-payouts">0 次</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="bg-yellow-500 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 14h.01M18 11h.01M18 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">當期平均成本</p>
                    <p class="text-2xl font-bold text-white" id="avg-cost">0 元/次</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
            <div class="flex border-b border-gray-700 mb-6 flex-wrap">
                <button class="tab-btn active text-lg py-3 px-6 font-semibold transition" data-tab="accounting">每日記帳</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="machines">機台管理</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="charts">圖表分析</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="statistics">統計彙整</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="details">機台營業明細</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="summary">各機台營運概況</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="analysis">分析與建議</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="profit">盈利計算</button>
                <button class="tab-btn text-lg py-3 px-6 font-semibold transition text-gray-400" data-tab="checkout">結帳作業</button>
            </div>

            <div>
                <div id="accounting" class="tab-content">
                     <h3 class="text-xl font-bold text-white mb-4">新增每日紀錄</h3>
                    <div class="relative">
                        <form id="daily-entry-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-4">
                            <div>
                                <label for="entry-date" class="block text-sm font-medium text-gray-300 mb-1">日期</label>
                                <input type="date" id="entry-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                            </div>
                            <div>
                                <label for="machine-selector" class="block text-sm font-medium text-gray-300 mb-1">機台位置</label>
                                <select id="machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                                </select>
                            </div>
                            <div>
                                <label for="cumulative-plays" class="block text-sm font-medium text-gray-300 mb-1">累積投幣數 (抄表)</label>
                                <input type="number" id="cumulative-plays" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <div>
                                <label for="cumulative-payouts" class="block text-sm font-medium text-gray-300 mb-1">累積出貨數 (抄表)</label>
                                <input type="number" id="cumulative-payouts" min="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="表上顯示的總次數" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">新增紀錄</button>
                        </form>
                        <div id="form-feedback" class="text-center p-3 rounded-lg transition-opacity duration-500 opacity-0"></div>
                        
                        <!-- 輪詢帶入按鈕 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                            <button id="import-from-poll-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>📥 從輪詢帶入</span>
                            </button>
                            <button id="batch-add-all-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                <span>🚀 批量新增所有機台 (無限制)</span>
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">📊 HTTP 輪詢自動記帳</h3>
                    <p class="text-sm text-gray-400 mb-4">從 HTTP 端點自動輪詢收集的每日記帳數據（devid=1 左天車、devid=2 右天車）</p>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">日期</th>
                                    <th class="p-4">天車</th>
                                    <th class="p-4 text-right">投幣數</th>
                                    <th class="p-4 text-right">出獎數</th>
                                    <th class="p-4 text-center">更新次數</th>
                                    <th class="p-4 text-center">最後更新</th>
                                    <th class="p-4 text-center">建立時間</th>
                                </tr>
                            </thead>
                            <tbody id="auto-record-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4 mt-6">記帳歷史紀錄</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">日期</th>
                                    <th class="p-4">機台編號</th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4 text-right">當日投幣數</th>
                                    <th class="p-4 text-right">當日出貨數</th>
                                    <th class="p-4 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="machines" class="tab-content hidden">
                    <!-- HTTP 即時同步區塊 -->
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">HTTP 即時同步</h3>

                        <!-- HTTP 輪詢控制 -->
                        <div class="mt-4 flex flex-col lg:flex-row items-start lg:items-center justify-between bg-gray-800/50 p-3 rounded-lg gap-4">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 flex-1">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="auto-poll-enabled" class="rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-300">啟用自動輪詢所有機台</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="auto-poll-on-load" class="rounded bg-gray-700 border-gray-600 text-green-600 focus:ring-green-500">
                                    <span class="text-sm text-gray-300">⚡ 進入門市後自動輪詢兩次（並行優化，間隔1秒）</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-300">間隔：</label>
                                    <select id="poll-interval" class="bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                        <option value="500">0.5秒</option>
                                        <option value="1000">1秒</option>
                                        <option value="2000">2秒</option>
                                        <option value="3000">3秒</option>
                                        <option value="5000">5秒</option>
                                        <option value="10000" selected>10秒</option>
                                        <option value="30000">30秒</option>
                                        <option value="60000">1分鐘</option>
                                        <option value="300000">5分鐘</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 固定使用 HTTP 模式（已隱藏選擇器） -->
                            <input type="hidden" id="http-transport-mode" value="direct-http">
                            <input type="hidden" id="http-poll-mode" value="parallel">
                            <button id="poll-all-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                ⚡ 立即輪詢所有機台 (並行優化)
                            </button>
                            <button id="poll-test-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                🧪 測試輪詢 (前4組)
                            </button>
                            <button id="quick-read-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                ⚡ 快速讀取 (跳過查詢)
                            </button>
                            <button id="debug-mapping-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition shrink-0 w-full sm:w-auto">
                                🔍 調試映射表
                            </button>
                        </div>
                        

                        
                        <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                            <div class="flex items-center space-x-2">
                                <div id="mqtt-status-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span id="mqtt-status-text" class="text-sm text-gray-400">未連接</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>最後更新：</span>
                                <span id="last-mqtt-update">無</span>
                            </div>
                        </div>

                    </div>

                    <!-- 🔧 開發者模式容器 -->
                    <div class="bg-gray-800/50 rounded-lg p-4 border-l-4 border-purple-500 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <h4 class="text-lg font-medium text-purple-300">🔧 開發者工具</h4>
                                <span class="text-xs bg-purple-600 text-purple-100 px-2 py-0.5 rounded">工程專用</span>
                            </div>
                            <button id="toggle-dev-mode" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-colors">
                                顯示調試工具
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">此區域包含機台調試、批次處理設定和系統診斷工具，供技術人員使用</p>
                        
                        <!-- 開發者工具區域 (預設隱藏) -->
                        <div id="developer-tools" class="hidden mt-4 space-y-4">
                            <!-- HTTP 讀取資料功能 -->
                            <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                                <h3 class="text-red-400 font-bold text-lg mb-4">📖 擷取機台資料 (HTTP GET)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="read-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">機台 MAC 位址</label>
                                <input type="text" id="read-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="083A8DE1ED14" value="083A8DE1ED14">
                                <p class="text-xs text-gray-500 mt-1">機台 WiFi 小卡的 MAC 位址</p>
                            </div>
                            <div>
                                <label for="read-device-id" class="block text-sm font-medium text-gray-300 mb-1">天車 ID</label>
                                <select id="read-device-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                    <option value="1">左天車 (ID: 1)</option>
                                    <option value="2">右天車 (ID: 2)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="send-read-command" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    📤 測試查詢
                                </button>
                            </div>
                        </div>

                        <!-- HTTP 連線測試按鈕 -->
                        <div class="mb-4">
                            <button id="mqtt-test-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                🔗 測試 HTTP 連線
                            </button>
                        </div>

                                <!-- 命令記錄 -->
                                <div class="bg-gray-900/50 p-3 rounded-lg">
                                    <h4 class="text-sm font-medium text-yellow-400 mb-2">📋 命令記錄</h4>
                                    <div id="mqtt-command-log" class="space-y-2 max-h-32 overflow-y-auto text-xs">
                                        <p class="text-gray-500">HTTP 命令記錄將在此顯示...</p>
                                    </div>
                                </div>
                                
                                <!-- 批次處理設定 -->
                                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                                    <h5 class="text-blue-400 font-medium mb-3">⚙️ 批次處理設定</h5>
                                    <div class="flex flex-wrap items-center gap-4">
                                        <div class="flex items-center space-x-2">
                                            <label for="batch-size-input" class="text-sm text-gray-300">批次大小:</label>
                                            <input type="number" id="batch-size-input" min="1" max="1000" value="50" 
                                                   class="w-20 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                            <button id="set-batch-size-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded">
                                                設定
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button id="unlimited-mode-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                                🚀 無限制模式
                                            </button>
                                            <button id="check-batch-status-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded">
                                                📊 檢查狀態
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <span id="batch-status-display" class="text-xs text-gray-400">
                                            目前批次大小: 50 | 模式: 標準
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- 🚀 數據限制設定 -->
                                <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                                    <h5 class="text-green-400 font-medium mb-3">⚡ 資料處理優化</h5>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <label for="data-limit-input" class="text-sm text-gray-300">最多處理筆數:</label>
                                                <input type="number" id="data-limit-input" min="5" max="100" value="10" 
                                                       class="w-20 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                                                <span class="text-xs text-gray-400">筆</span>
                                            </div>
                                            <button id="set-data-limit-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                                套用
                                            </button>
                                        </div>
                                        <div class="text-xs text-gray-400 bg-gray-800/50 p-2 rounded">
                                            <span id="data-limit-status">✅ 目前只處理最新 <span class="text-green-400 font-bold">10</span> 筆資料 (節省流量)</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            💡 提示: 數值越小速度越快，建議設定 10-20 筆即可獲得最新數據
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 機台資料顯示區域 -->
                                <div class="space-y-3" id="machine-data-displays">
                                    <!-- 動態生成的機台資料顯示會出現在這裡 -->
                                </div>
                            </div>
                        </div>
                    </div>



                    <h3 class="text-xl font-bold text-white mb-4">建立新機台</h3>
                    <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end bg-gray-900/50 p-4 rounded-lg mb-6">
                        <div>
                            <label for="new-machine-id" class="block text-sm font-medium text-gray-300 mb-1">機台編號</label>
                            <input type="text" id="new-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：A01" required>
                        </div>
                        <div>
                            <label for="new-machine-location" class="block text-sm font-medium text-gray-300 mb-1">位置/內容物</label>
                            <input type="text" id="new-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：門口/大娃娃" required>
                            <div id="location-presets" class="flex flex-wrap gap-2 mt-2">
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">上層 / 左側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">上層 / 右側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">下層 / 左側</span>
                                <span class="preset-tag bg-indigo-600 text-white text-xs font-semibold px-2 py-1 rounded-full">下層 / 右側</span>
                            </div>
                        </div>
                         <div>
                            <label for="new-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-1">起始投幣數 (測試用)</label>
                            <input type="number" id="new-machine-initial-plays" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-1">起始出貨數 (測試用)</label>
                            <input type="number" id="new-machine-initial-payouts" min="0" value="0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        </div>
                        <div>
                            <label for="new-machine-mac" class="block text-sm font-medium text-gray-300 mb-1">機台 MAC 位址 (MQTT)</label>
                            <input type="text" id="new-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：083A8DE1E8FB">
                        </div>
                        <div>
                            <label for="new-machine-devid" class="block text-sm font-medium text-gray-300 mb-1">設備 ID (MQTT)</label>
                            <input type="number" id="new-machine-devid" min="1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" placeholder="例如：2">
                        </div>
                        <button type="submit" class="md:col-span-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">建立機台</button>
                    </form>
                    
                    <!-- 機台校正功能說明 -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-900 to-purple-900 rounded-lg border border-blue-600">
                        <h4 class="text-lg font-semibold text-white mb-2">🔧 機台數值校正功能</h4>
                        <div class="text-sm text-gray-300 space-y-1">
                            <p>• <strong>功能說明</strong>：修正電子內表與機械碼表的出廠前數值差異</p>
                            <p>• <strong>投幣校正</strong>：輪詢得到的投幣數 + 校正值 = 實際填表數值</p>
                            <p>• <strong>出貨校正</strong>：輪詢得到的出貨數 + 校正值 = 實際填表數值</p>
                            <p>• <strong>使用方式</strong>：在下方表格的校正欄位直接輸入正數（加值）或負數（減值），系統會自動保存並應用於所有輪詢資料</p>
                            <p>• <strong>顯示標記</strong>：輪詢表格中有 📊 圖示表示該數值已應用校正</p>
                            <p>• <strong>🚀 新功能</strong>：勾選「進入門市後自動輪詢兩次」可在每次開啟門市頁面時立即執行第一次直接讀取（不發送訊息），完成後等待1秒再執行第二次直接讀取</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4 mt-4">
                         <h3 class="text-xl font-bold text-white">現有機台列表</h3>
                         <button id="recalculate-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.082.541a5.002 5.002 0 00-8.736-1.613L8 8H4V4l2.293 2.293A6.996 6.996 0 0111 3.055a6.996 6.996 0 015.688 3.568l1.082-.54A8.996 8.996 0 0012.22 2.022 8.996 8.996 0 004 5.101V3a1 1 0 01-1-1H2a1 1 0 01-1-1V1a1 1 0 011-1h2zm12 16a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.899-2.186l1.082-.541a5.002 5.002 0 008.736 1.613L12 12h4v4l-2.293-2.293A6.996 6.996 0 019 16.945a6.996 6.996 0 01-5.688-3.568l-1.082.54A8.996 8.996 0 007.78 17.978 8.996 8.996 0 0016 14.899V17a1 1 0 011 1h1a1 1 0 011 1v1a1 1 0 01-1 1h-2z" clip-rule="evenodd" />
                            </svg>
                            <span>重新計算所有數據</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4">禮品</th>
                                    <th class="p-4">機台編號</th>
                                    <th class="p-4">位置</th>
                                    <th class="p-4">MAC 位址</th>
                                    <th class="p-4">設備ID</th>
                                    <th class="p-4 text-right">起始投幣</th>
                                    <th class="p-4 text-right">起始出貨</th>
                                    <th class="p-4 text-center" style="background-color: #2d3748;">投幣校正</th>
                                    <th class="p-4 text-center" style="background-color: #2d3748;">出貨校正</th>
                                    <th class="p-4 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="machine-list-table-body" class="divide-y divide-gray-700">
                                <!-- 機台列表將動態插入 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 機台詳細資料面板 -->
                    <div id="machine-detail-panel" class="hidden mt-6 bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">機台詳細資料</h3>
                            <button id="close-detail-panel" class="text-gray-400 hover:text-white text-2xl">×</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 電壓資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-blue-400 mb-3">電壓資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">強電壓:</span>
                                        <span id="detail-strong-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中電壓:</span>
                                        <span id="detail-medium-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">弱電壓:</span>
                                        <span id="detail-weak-voltage" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中壓距離頂點高度:</span>
                                        <span id="detail-height-to-top" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">保夾強電壓:</span>
                                        <span id="detail-clamp-voltage" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 營運資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-green-400 mb-3">營運資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">中獎率銀行:</span>
                                        <span id="detail-win-rate-bank" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">投幣遊戲次數:</span>
                                        <span id="detail-coin-game-count" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">禮品出獎次數:</span>
                                        <span id="detail-prize-count" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 累加金額資料 -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-yellow-400 mb-3">累加金額</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第1筆:</span>
                                        <span id="detail-amount-1" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第2筆:</span>
                                        <span id="detail-amount-2" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">第3筆:</span>
                                        <span id="detail-amount-3" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 基本資料 -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2 lg:col-span-1">
                                <h4 class="text-lg font-semibold text-purple-400 mb-3">基本資料</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">機台編號:</span>
                                        <span id="detail-machine-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">MAC位址:</span>
                                        <span id="detail-mac-address" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">設備ID:</span>
                                        <span id="detail-device-id" class="text-white font-mono">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">最後更新:</span>
                                        <span id="detail-last-update" class="text-white font-mono">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 原始資料 -->
                            <div class="bg-gray-700 rounded-lg p-4 md:col-span-2">
                                <h4 class="text-lg font-semibold text-red-400 mb-3">原始 Hex 資料</h4>
                                <div class="bg-gray-900 rounded p-3 font-mono text-xs text-green-400 break-all">
                                    <span id="detail-raw-hex">無資料</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="charts" class="tab-content hidden">
                    <!-- 圖表統計範圍選擇 -->
                    <div class="flex justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">圖表統計範圍：</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="chart-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    📊 當期紀錄
                                </button>
                                <button type="button" class="chart-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    📈 全部歷史
                                </button>
                            </div>
                        </div>
                    </div>
                    
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台總營收比較</h3>
                            <div id="revenue-chart" class="space-y-4"></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-xl font-bold text-white mb-4">各機台平均出貨成本</h3>
                            <div id="cost-chart" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="chart-container mt-8">
                        <h3 class="text-xl font-bold text-white mb-4">單日各機台表現</h3>
                        <div class="flex items-center gap-4 mb-4">
                            <label for="trend-chart-date-picker" class="text-gray-300 shrink-0">選擇日期：</label>
                            <input type="date" id="trend-chart-date-picker" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 w-full sm:w-auto">
                        </div>
                        <div id="trend-chart-content" class="w-full"></div>
                    </div>

                    <!-- 機台營收趨勢圖 -->
                    <div class="bg-gray-900/50 rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-6">📈 機台營收趨勢圖</h3>
                        
                        <!-- 機台選擇區 -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-3">選擇要查看的機台：</label>
                            <div class="flex flex-wrap gap-2" id="machine-trend-selector">
                                <!-- 動態生成機台按鈕 -->
                            </div>
                        </div>
                        
                        <!-- 日期範圍選擇 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">起始日期</label>
                                <input type="date" id="trend-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">結束日期</label>
                                <input type="date" id="trend-end-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex items-end">
                                <button id="update-trend-chart" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    更新圖表
                                </button>
                            </div>
                        </div>
                        
                        <!-- 趨勢圖表 -->
                        <div class="bg-gray-800 rounded-lg p-4">
                            <canvas id="machine-trend-canvas" width="1200" height="400"></canvas>
                        </div>
                        
                        <!-- 統計摘要 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-gray-400 text-sm">期間總營收</div>
                                <div id="trend-total-revenue" class="text-2xl font-bold text-blue-400">-- 元</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-gray-400 text-sm">日均營收</div>
                                <div id="trend-avg-revenue" class="text-2xl font-bold text-green-400">-- 元</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-gray-400 text-sm">最高單日</div>
                                <div id="trend-max-revenue" class="text-2xl font-bold text-yellow-400">-- 元</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-gray-400 text-sm">最低單日</div>
                                <div id="trend-min-revenue" class="text-2xl font-bold text-red-400">-- 元</div>
                            </div>
                        </div>
                    </div>

                </div>
                <div id="statistics" class="tab-content hidden">
                    <!-- 統計範圍選擇 (已隱藏) -->
                    <div class="hidden flex-col sm:flex-row justify-between items-center mb-6 bg-gray-900/50 p-4 rounded-lg gap-4">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-300">統計範圍：</label>
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" class="stats-range-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-l-lg border border-blue-600 hover:bg-blue-700 hover:text-white" data-range="current">
                                    📊 當期紀錄
                                </button>
                                <button type="button" class="stats-range-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-range="all">
                                    📈 全部歷史
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="refresh-all-stats-btn" class="py-2 px-4 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                🔄 重新統計全部
                            </button>
                        </div>
                    </div>
                    
                     <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="stats-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="daily">每日</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">每週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">每月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">每季</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[30rem]">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-4" id="stats-period-header">期間</th>
                                    <th class="p-4 text-right">總投幣次數</th>
                                    <th class="p-4 text-right">總投幣金額</th>
                                    <th class="p-4 text-right">總出貨次數</th>
                                    <th class="p-4 text-right">平均出貨成本</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
                <div id="details" class="tab-content hidden">
                    <div class="mb-4">
                        <input type="text" id="searchInput" class="w-full sm:w-1/3 bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="依機台編號搜尋...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4 table-header-sortable sorted" data-sort="id">機台編號 <span class="sort-indicator">▲</span></th>
                                    <th class="p-4 table-header-sortable" data-sort="location">位置 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePlays">營業投幣次數 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="revenue">營業投幣金額 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="effectivePayouts">營業出貨數量 <span class="sort-indicator"></span></th>
                                    <th class="p-4 text-right table-header-sortable" data-sort="cost">平均出貨成本 <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>

                    <!-- 📊 機台協定資料查看器 (F58A) -->
                    <div class="bg-gray-900/50 rounded-xl p-6 mt-8">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                            📊 機台協定資料查看器 (F58A)
                        </h3>
                        
                        <!-- 機台選擇 -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-3">選擇要查看的機台：</label>
                            <select id="protocol-machine-selector" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">請選擇機台...</option>
                            </select>
                        </div>
                        
                        <!-- 協定資料顯示區 -->
                        <div id="protocol-data-viewer" class="hidden">
                            <!-- 資料來源說明 -->
                            <div class="mb-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
                                <p class="text-blue-300 text-sm flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span id="protocol-data-source">資料來源：等待選擇機台</span>
                                </p>
                            </div>
                            
                            <!-- 基本參數 & 營運數據 -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                <!-- 基本參數設定 -->
                                <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                                    <div class="bg-gray-700 p-3 border-b border-gray-600">
                                        <h4 class="font-bold text-white text-sm">⚙️ 基本參數設定</h4>
                                    </div>
                                    <div class="p-4 space-y-3 text-sm">
                                        <div class="flex justify-between items-center border-b border-dashed border-gray-700 pb-2">
                                            <span class="text-gray-400">遊戲模式</span>
                                            <span id="protocol-game-mode" class="font-semibold px-2 py-1 rounded text-xs bg-green-100 text-green-700">--</span>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-dashed border-gray-700 pb-2">
                                            <span class="text-gray-400">1投幾元</span>
                                            <span id="protocol-coin-insert" class="font-mono font-bold text-white">-- 元</span>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-dashed border-gray-700 pb-2">
                                            <span class="text-gray-400">每局幾元</span>
                                            <span id="protocol-coin-game" class="font-mono font-bold text-white">-- 元</span>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-dashed border-gray-700 pb-2">
                                            <span class="text-gray-400">遊戲時間</span>
                                            <span id="protocol-game-time" class="font-mono font-bold text-white">-- 秒</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400">禮品售價</span>
                                            <span id="protocol-gift-price" class="font-mono font-bold text-red-400 text-lg">--</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 營運計數統計 -->
                                <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                                    <div class="bg-gray-700 p-3 border-b border-gray-600">
                                        <h4 class="font-bold text-white text-sm">🎮 營運計數統計</h4>
                                    </div>
                                    <div class="p-4 grid grid-cols-2 gap-3">
                                        <div class="bg-indigo-900/30 p-3 rounded-lg text-center border border-indigo-700">
                                            <div class="text-xs text-indigo-300 mb-1">投幣遊戲次數</div>
                                            <div id="protocol-game-count" class="text-xl font-bold text-white">--</div>
                                        </div>
                                        <div class="bg-pink-900/30 p-3 rounded-lg text-center border border-pink-700">
                                            <div class="text-xs text-pink-300 mb-1">禮品出獎次數</div>
                                            <div id="protocol-prize-count" class="text-xl font-bold text-white">--</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 爪力電壓設定 -->
                                <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                                    <div class="bg-gray-700 p-3 border-b border-gray-600">
                                        <h4 class="font-bold text-white text-sm">⚡ 爪力電壓設定</h4>
                                    </div>
                                    <div class="p-4 flex flex-col gap-3">
                                        <div class="bg-orange-900/30 p-3 rounded-lg flex justify-between items-center border border-orange-700">
                                            <span class="text-sm font-semibold text-orange-300">強電壓</span>
                                            <div class="flex items-end gap-1">
                                                <span id="protocol-voltage-strong" class="text-2xl font-bold text-orange-400">--</span>
                                                <span class="text-xs text-orange-300 mb-1">V</span>
                                            </div>
                                        </div>
                                        <div class="bg-yellow-900/30 p-3 rounded-lg flex justify-between items-center border border-yellow-700">
                                            <span class="text-sm font-semibold text-yellow-300">中電壓</span>
                                            <div class="flex items-end gap-1">
                                                <span id="protocol-voltage-mid" class="text-2xl font-bold text-yellow-400">--</span>
                                                <span class="text-xs text-yellow-300 mb-1">V</span>
                                            </div>
                                        </div>
                                        <div class="bg-green-900/30 p-3 rounded-lg flex justify-between items-center border border-green-700">
                                            <span class="text-sm font-semibold text-green-300">弱電壓</span>
                                            <div class="flex items-end gap-1">
                                                <span id="protocol-voltage-weak" class="text-2xl font-bold text-green-400">--</span>
                                                <span class="text-xs text-green-300 mb-1">V</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 累加金額查詢 (C4) -->
                            <div class="bg-gray-800 rounded-xl shadow-md border border-blue-700 overflow-hidden mb-6">
                                <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white">
                                    <h4 class="text-lg font-bold">💰 C4. 累加金額查詢紀錄 (近10筆)</h4>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="protocol-c4-history">
                                        <!-- 動態生成 10 個卡片 -->
                                    </div>
                                    <p class="text-right text-xs text-gray-400 mt-4">* 數值格式為 Little Endian (低位在前)</p>
                                </div>
                            </div>
                            
                            <!-- 馬達速度設定 -->
                            <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                                <div class="bg-gray-700 p-3 border-b border-gray-600">
                                    <h4 class="font-bold text-white text-sm">🎛️ 馬達速度設定 (%)</h4>
                                </div>
                                <div class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E1 往前</div>
                                        <div id="protocol-motor-e1" class="text-lg font-bold text-white">--</div>
                                    </div>
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E2 往後</div>
                                        <div id="protocol-motor-e2" class="text-lg font-bold text-white">--</div>
                                    </div>
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E3 往左</div>
                                        <div id="protocol-motor-e3" class="text-lg font-bold text-white">--</div>
                                    </div>
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E4 往右</div>
                                        <div id="protocol-motor-e4" class="text-lg font-bold text-white">--</div>
                                    </div>
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E5 往上</div>
                                        <div id="protocol-motor-e5" class="text-lg font-bold text-white">--</div>
                                    </div>
                                    <div class="bg-purple-900/30 p-3 rounded border border-purple-700 text-center">
                                        <div class="text-xs text-purple-300 font-semibold mb-1">E6 往下</div>
                                        <div id="protocol-motor-e6" class="text-lg font-bold text-white">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 無資料提示 -->
                        <div id="protocol-no-data" class="text-center py-12 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>請先選擇機台並執行輪詢，才能查看協定資料</p>
                        </div>
                    </div>

                </div>
                <div id="summary" class="tab-content hidden">
                    <div class="flex justify-center mb-6 bg-gray-900/50 p-2 rounded-lg">
                        <div id="summary-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">總計</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">本週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">本月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">本季</button>
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-blue-600 rounded-r-md border border-blue-600 hover:bg-blue-700 hover:text-white" data-period="current">當期</button>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="overflow-x-auto">
                            <h3 class="text-xl font-bold text-white mb-4">營運概況總表</h3>
                             <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">機台編號</th>
                                        <th class="p-4 text-right">總投幣金額</th>
                                        <th class="p-4 text-right">總出貨數量</th>
                                        <th class="p-4 text-right">平均出貨成本</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                        <div>
                             <h3 class="text-xl font-bold text-white mb-4">各機台投幣金額佔比</h3>
                             <div id="summary-chart-container" class="bg-gray-900/50 p-6 rounded-lg space-y-4"></div>
                        </div>
                    </div>
                </div>
                <div id="analysis" class="tab-content hidden prose prose-invert max-w-none prose-h3:text-white prose-h3:font-bold prose-h3:mb-3 prose-p:text-gray-300 prose-li:text-gray-300">
                    <h3>📈 PSD（每日平均銷售表現）</h3>
                     <div class="flex flex-wrap justify-center items-center mb-4 bg-gray-900/50 p-2 rounded-lg gap-2">
                        <div id="psd-controls" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="stats-period-btn active py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-l-lg border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="all">總計</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-gray-600 hover:bg-gray-700 hover:text-white" data-period="weekly">本週</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent border-t border-b border-r border-gray-600 hover:bg-gray-700 hover:text-white" data-period="monthly">本月</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="quarterly">本季</button>
                            <button type="button" class="stats-period-btn py-2 px-4 text-sm font-medium text-gray-300 bg-transparent rounded-r-md border border-gray-600 hover:bg-gray-700 hover:text-white" data-period="custom">自訂區間</button>
                        </div>
                         <div id="psd-custom-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="psd-start-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <span class="text-gray-400">至</span>
                            <input type="date" id="psd-end-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-1 px-2 text-sm">
                            <button id="psd-calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">計算</button>
                            <button id="psd-weekly-trend-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                                </svg>
                                周報比較
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg not-prose">
                        <p id="psd-display" class="text-lg text-center"><strong>計算中...</strong></p>
                    </div>
                    <h3 class="mt-8">🔬 分析與觀察</h3>
                    <div id="analysis-observation" class="space-y-6"></div>
                    <h3 class="mt-8">💡 結論建議</h3>
                    <div id="analysis-suggestion" class="space-y-4"></div>
                </div>
                
                <!-- 盈利計算頁面 -->
                <div id="profit" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-6">💰 盈利計算器</h3>
                    
                    <!-- 基本資訊卡片 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-blue-100 mb-2">📊 營業資訊</h4>
                            <div class="text-2xl font-bold text-white" id="profit-revenue">0 元</div>
                            <div class="text-sm text-blue-100 mt-1">總營業額</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-green-100 mb-2">🎁 出貨統計</h4>
                            <div class="text-2xl font-bold text-white" id="profit-payouts">0 次</div>
                            <div class="text-sm text-green-100 mt-1">總出貨次數</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-6 rounded-xl">
                            <h4 class="text-sm font-medium text-purple-100 mb-2">💵 淨利潤</h4>
                            <div class="text-2xl font-bold text-white" id="profit-net">0 元</div>
                            <div class="text-sm text-purple-100 mt-1">扣除成本後</div>
                        </div>
                    </div>
                    
                    <!-- 成本設定區域 -->
                    <div class="bg-gray-700/50 rounded-xl p-6 mb-6">
                        <h4 class="text-lg font-semibold text-white mb-4">🔧 成本設定與計算範圍</h4>
                        
                        <!-- 計算範圍選擇 -->
                        <div class="mb-6 p-4 bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-300 mb-3">📊 計算範圍選擇</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="total" checked 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">📈 總累積計算</span>
                                        <p class="text-gray-400 text-sm">計算從營業開始至今的總盈利</p>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                                    <input type="radio" name="profit-calculation-scope" value="pending" 
                                           class="text-blue-600 focus:ring-blue-500">
                                    <div>
                                        <span class="text-white font-medium">💰 本期待結帳計算</span>
                                        <p class="text-gray-400 text-sm">僅計算本期待結帳金額的盈利</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🎁 每次出貨禮品成本 (元)</label>
                                <input type="number" id="gift-cost" value="50" min="0" step="1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🏠 店租比例 (%)</label>
                                <input type="number" id="rent-percentage" value="30" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">🏛️ 稅金比例 (%)</label>
                                <input type="number" id="tax-percentage" value="5" min="0" max="100" step="0.1" 
                                       class="w-full bg-gray-800 border border-gray-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="calculate-profit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                🧮 重新計算
                            </button>
                            <button id="save-cost-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition ml-2">
                                💾 儲存設定
                            </button>
                        </div>
                    </div>
                    
                    <!-- 詳細計算結果 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 成本分析 -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">💸 成本明細</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🎁 禮品成本</span>
                                    <span class="text-white font-semibold" id="total-gift-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🏠 店租費用</span>
                                    <span class="text-white font-semibold" id="total-rent-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">🏛️ 稅金費用</span>
                                    <span class="text-white font-semibold" id="total-tax-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-red-500">
                                    <span class="text-red-300 font-semibold">💰 總成本</span>
                                    <span class="text-red-300 font-bold text-lg" id="total-cost">0 元</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 盈利分析 -->
                        <div class="bg-gray-700/50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-white mb-4">📈 盈利分析</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">📊 總營業額</span>
                                    <span class="text-green-400 font-semibold" id="profit-total-revenue">0 元</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                    <span class="text-gray-300">💸 總成本</span>
                                    <span class="text-red-400 font-semibold" id="profit-total-cost">0 元</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t-2 border-green-500">
                                    <span class="text-green-300 font-semibold">💵 淨利潤</span>
                                    <span class="text-green-300 font-bold text-xl" id="net-profit">0 元</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-300">📊 利潤率</span>
                                        <span class="font-semibold" id="profit-margin">0%</span>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-gray-300">💰 每次出貨淨利</span>
                                        <span class="font-semibold" id="profit-per-payout">0 元</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div id="checkout" class="tab-content hidden">
                    <h3 class="text-xl font-bold text-white mb-4">本期營收結帳</h3>
                    <div class="bg-gray-900/50 p-6 rounded-lg mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-400">上次結帳日期：<span id="last-checkout-date" class="font-semibold">無</span></p>
                            <p class="text-lg text-white mt-1">本期待結帳金額：<span id="pending-checkout-amount" class="text-2xl font-bold text-green-400">0 元</span></p>
                        </div>
                        <div class="flex gap-2">
                           <button id="download-checkout-csv-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">下載結帳報表 (CSV)</button>
                           <button id="perform-checkout-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition shrink-0">執行結帳</button>
                        </div>
                    </div>
                    
                    <!-- 結帳趨勢圖表 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                結帳金額趨勢
                            </h4>
                            <div id="checkout-amount-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">暫無數據可顯示圖表</p>
                            </div>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                累積營收趨勢
                            </h4>
                            <div id="checkout-cumulative-chart" class="h-64 checkout-chart">
                                <p class="text-center text-gray-500 mt-20">暫無數據可顯示圖表</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 結帳統計摘要 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-blue-400 text-sm">總結帳次數</p>
                            <p id="total-checkouts" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-green-400 text-sm">平均結帳金額</p>
                            <p id="avg-checkout-amount" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                        <div class="bg-purple-900/30 p-4 rounded-lg text-center">
                            <p class="text-purple-400 text-sm">最高單次結帳</p>
                            <p id="max-checkout-amount" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                        <div class="bg-orange-900/30 p-4 rounded-lg text-center">
                            <p class="text-orange-400 text-sm">累計盈利</p>
                            <p id="total-profit-summary" class="text-2xl font-bold text-white">0 元</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-4 mt-8">結帳歷史紀錄</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-sm sticky top-0">
                                <tr>
                                    <th class="p-3 text-xs">結帳日期</th>
                                    <th class="p-3 text-right text-xs">當期營收</th>
                                    <th class="p-3 text-right text-xs">當期出貨</th>
                                    <th class="p-3 text-right text-xs">當期盈利</th>
                                    <th class="p-3 text-right text-xs">累積總營收</th>
                                    <th class="p-3 text-right text-xs">盈利計算</th>
                                    <th class="p-3 text-right text-xs">操作</th>
                                </tr>
                            </thead>
                            <tbody id="checkout-history-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p id="report-date">報表建立日期：</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">確認操作</h3>
            <p id="modal-message" class="text-gray-300 mb-6">您確定要執行此操作嗎？</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定</button>
            </div>
        </div>
    </div>

    <!-- Edit Store Modal -->
    <div id="edit-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">編輯門市資訊</h3>
            <form id="edit-store-form">
                <input type="hidden" id="edit-store-id">
                 <div class="mb-4">
                    <label for="edit-store-name" class="block text-sm font-medium text-gray-300 mb-1">門市名稱</label>
                    <input type="text" id="edit-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6">
                    <label for="edit-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">營業起始日</label>
                    <input type="date" id="edit-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clone Store Modal -->
    <div id="clone-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">複製門市</h3>
            <form id="clone-store-form">
                <input type="hidden" id="clone-source-store-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">來源門市</label>
                    <div class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                        <span id="clone-source-store-name" class="font-semibold"></span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="clone-store-name" class="block text-sm font-medium text-gray-300 mb-1">新門市名稱</label>
                    <input type="text" id="clone-store-name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required placeholder="請輸入新門市名稱">
                </div>
                <div class="mb-6">
                    <label for="clone-store-start-date" class="block text-sm font-medium text-gray-300 mb-1">營業起始日</label>
                    <input type="date" id="clone-store-start-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-6 p-4 bg-blue-900/30 border border-blue-500/50 rounded-lg">
                    <h4 class="text-sm font-semibold text-blue-300 mb-2">複製說明</h4>
                    <ul class="text-sm text-blue-200 space-y-1">
                        <li>• 複製機台配置和位置設定</li>
                        <li>• 複製機台的 MAC 地址和設備 ID</li>
                        <li>• <strong class="text-yellow-300">清除所有帳務記錄和歷史資料</strong></li>
                        <li>• 機台數據重置為 0（適合新門市）</li>
                    </ul>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="clone-store-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">開始複製</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="edit-history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4">修改記帳紀錄</h3>
            <form id="edit-history-form">
                <input type="hidden" id="edit-history-doc-id">
                <input type="hidden" id="edit-history-machine-id">
                <input type="hidden" id="edit-history-location">
                <input type="hidden" id="edit-history-old-plays">
                <input type="hidden" id="edit-history-old-payouts">
                <div class="mb-4">
                    <label for="edit-history-date" class="block text-sm font-medium text-gray-300 mb-1">紀錄日期</label>
                    <input type="date" id="edit-history-date" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required>
                </div>
                <div class="mb-4">
                    <label for="edit-history-plays" class="block text-sm font-medium text-gray-300 mb-1">當日投幣數</label>
                    <input type="number" id="edit-history-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="mb-6">
                    <label for="edit-history-payouts" class="block text-sm font-medium text-gray-300 mb-1">當日出貨數</label>
                    <input type="number" id="edit-history-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3" required min="0">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-history-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Machine Modal - Enhanced -->
    <div id="edit-machine-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto edit-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">修改機台資訊</h3>
                <button id="edit-machine-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            
            <form id="edit-machine-form">
                <input type="hidden" id="edit-machine-doc-id">
                
                <!-- 基本資訊 -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">📋 基本資訊</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="edit-machine-id" class="block text-sm font-medium text-gray-300 mb-2">機台編號</label>
                            <input type="text" id="edit-machine-id" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-machine-location" class="block text-sm font-medium text-gray-300 mb-2">位置/內容物</label>
                            <input type="text" id="edit-machine-location" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-machine-mac" class="block text-sm font-medium text-gray-300 mb-2">MAC 位址</label>
                            <input type="text" id="edit-machine-mac" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 font-mono focus:ring-2 focus:ring-blue-500" placeholder="083A8DE1ED14">
                        </div>
                        <div>
                            <label for="edit-machine-devid" class="block text-sm font-medium text-gray-300 mb-2">設備ID</label>
                            <input type="number" id="edit-machine-devid" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" min="1" max="9" value="1">
                        </div>
                        <div>
                            <label for="edit-machine-initial-plays" class="block text-sm font-medium text-gray-300 mb-2">起始投幣數</label>
                            <input type="number" id="edit-machine-initial-plays" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                        <div>
                            <label for="edit-machine-initial-payouts" class="block text-sm font-medium text-gray-300 mb-2">起始出貨數</label>
                            <input type="number" id="edit-machine-initial-payouts" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                    </div>
                </div>
                
                <!-- 校正值設定區塊 -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-green-400 mb-4">🔧 數值校正設定</h4>
                    <p class="text-sm text-gray-400 mb-4">用於修正電子內表與機械碼表的差異，正數為加值，負數為減值</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="edit-machine-plays-calibration" class="block text-sm font-medium text-gray-300 mb-2">投幣校正值</label>
                            <input type="number" id="edit-machine-plays-calibration" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-green-500" placeholder="0">
                            <small class="text-gray-500 block mt-1">例：電子表100，實際表98，輸入-2</small>
                        </div>
                        <div>
                            <label for="edit-machine-payouts-calibration" class="block text-sm font-medium text-gray-300 mb-2">出貨校正值</label>
                            <input type="number" id="edit-machine-payouts-calibration" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-green-500" placeholder="0">
                            <small class="text-gray-500 block mt-1">例：電子表50，實際表52，輸入+2</small>
                        </div>
                    </div>
                </div>
                
                <!-- 🎁 禮品設定區塊 -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-pink-400 mb-4">🎁 禮品設定</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="edit-machine-gift" class="block text-sm font-medium text-gray-300 mb-2">目前禮品</label>
                            <select id="edit-machine-gift" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-3 px-4 focus:ring-2 focus:ring-pink-500">
                                <option value="">-- 選擇禮品 --</option>
                            </select>
                            <small class="text-gray-500 block mt-1">選擇此機台目前放置的禮品</small>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">禮品預覽</label>
                            <div id="edit-machine-gift-preview" class="w-24 h-24 bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden">
                                <span class="text-4xl text-gray-500">🎁</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 當前數據顯示 -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-4">📊 當前數據</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400" id="edit-current-plays">--</div>
                            <div class="text-sm text-gray-400">當前投幣數</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400" id="edit-current-payouts">--</div>
                            <div class="text-sm text-gray-400">當前出貨數</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-400" id="edit-current-cost">--</div>
                            <div class="text-sm text-gray-400">平均成本</div>
                        </div>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="flex justify-end gap-4">
                    <button type="button" id="edit-machine-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">確認修改</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Report Download Modal -->
    <div id="custom-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">自定義報表內容</h3>
            
            <!-- 報表類型選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇報表類型</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📊 營業摘要統計</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-details" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📋 機台詳細資料</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-operation-summary" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📊 營運概況總表</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-history" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📝 記帳歷史紀錄</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-analysis" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📈 營運分析數據</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-checkout" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">💰 結帳紀錄</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="include-profit" class="report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🧮 盈利計算</span>
                    </label>
                </div>
            </div>
            
            <!-- 報表格式選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇檔案格式</h4>
                <div class="flex gap-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="csv" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">📄 CSV 格式</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="report-format" value="pdf" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">📑 PDF 格式</span>
                    </label>
                </div>
            </div>
            
            <!-- 快速選擇按鈕 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">快速選擇</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">全選</button>
                    <button type="button" id="select-basic-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">基本報表</button>
                    <button type="button" id="select-detailed-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">詳細報表</button>
                    <button type="button" id="clear-all-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">清空</button>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button type="button" id="custom-report-download" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>下載報表</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Store Report Modal -->
    <div id="custom-store-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">自定義門市報表內容</h3>
            
            <!-- 門市選擇提示 -->
            <div class="mb-4 p-3 bg-blue-900/50 rounded-lg">
                <p class="text-blue-300 text-sm">請先在門市列表中勾選要包含在報表中的門市</p>
            </div>
            
            <!-- 報表內容選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">選擇報表內容</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">📊 門市營業摘要</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked>
                        <span class="text-gray-300">🎰 各門市機台明細</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-performance" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📈 門市績效比較</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-top-machines" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🏆 各門市優績機台</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-period-summary" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">📅 期間營運統計</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="store-include-profit" class="store-report-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="text-gray-300">🧮 盈利計算分析</span>
                    </label>
                </div>
            </div>
            
            <!-- 報表期間選擇 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">報表期間</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="all" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">全部期間</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="daily" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">單日</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="weekly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">週報</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="monthly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">月報</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="quarterly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">季報</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-report-period" value="yearly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">年報</span>
                    </label>
                </div>
                <div class="mt-2">
                    <input type="date" id="store-report-date" class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 w-full" title="報表基準日期">
                </div>
            </div>
            
            <!-- 門市排序方式 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">門市排序方式</h4>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="revenue-desc" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-gray-300">📊 營業額高到低</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="revenue-asc" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">📉 營業額低到高</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="name" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">🔤 依門市名稱</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="store-sort-order" value="custom" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-gray-300">✋ 自訂順序 (勾選門市後可拖曳)</span>
                    </label>
                </div>
            </div>
            
            <!-- 快速選擇按鈕 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">快速選擇</h4>
                <div class="flex flex-wrap gap-2">
                    <button type="button" id="select-all-store-reports" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">全選</button>
                    <button type="button" id="select-basic-store-reports" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">基本報表</button>
                    <button type="button" id="select-detailed-store-reports" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">詳細報表</button>
                    <button type="button" id="clear-all-store-reports" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">清空</button>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-end gap-4">
                <button type="button" id="custom-store-report-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button type="button" id="custom-store-report-download" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>下載門市報表</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 盈利詳情查看模態視窗 -->
    <div id="profit-detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6">🧮 結帳期間盈利詳情</h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 營業數據 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">📊 營業數據</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">結帳日期</span>
                            <span class="text-white font-semibold" id="detail-checkout-date">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">當期營收</span>
                            <span class="text-green-400 font-semibold" id="detail-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">當期出貨</span>
                            <span class="text-blue-400 font-semibold" id="detail-payouts">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 成本設定 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">🔧 成本設定</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">禮品成本</span>
                            <span class="text-white font-semibold" id="detail-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">店租比例</span>
                            <span class="text-white font-semibold" id="detail-rent-percentage">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">稅金比例</span>
                            <span class="text-white font-semibold" id="detail-tax-percentage">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 成本明細 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">💸 成本明細</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">禮品成本</span>
                            <span class="text-red-400 font-semibold" id="detail-total-gift-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">店租費用</span>
                            <span class="text-red-400 font-semibold" id="detail-total-rent-cost">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">稅金費用</span>
                            <span class="text-red-400 font-semibold" id="detail-total-tax-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-red-300 font-semibold">總成本</span>
                            <span class="text-red-300 font-bold" id="detail-total-cost">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 盈利分析 -->
                <div class="bg-gray-700/50 rounded-xl p-4">
                    <h4 class="text-lg font-semibold text-white mb-3">📈 盈利分析</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">營收</span>
                            <span class="text-green-400 font-semibold" id="detail-profit-revenue">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">成本</span>
                            <span class="text-red-400 font-semibold" id="detail-profit-cost">-</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-600 pt-2">
                            <span class="text-white font-semibold">淨利潤</span>
                            <span class="font-bold text-lg" id="detail-net-profit">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">利潤率</span>
                            <span class="font-semibold" id="detail-profit-margin">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="close-profit-detail" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Loader Overlay -->
    <div id="pdf-loader-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center hidden z-50">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="pdf-loader-text-overlay" class="text-white text-lg mt-4">正在生成 PDF...</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="admin-config.js"></script>
    <script src="login.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Firebase Initialization ---
        // !!! 請將這裡的設定換成您自己的 Firebase 專案金鑰 !!!
        const firebaseConfig = {
          apiKey: "AIzaSyDZ3-lLtZ1L4SM1Xn_eQNfXlyoRqCYOgQc",
          authDomain: "claw-machine-report.firebaseapp.com",
          projectId: "claw-machine-report",
          storageBucket: "claw-machine-report.appspot.com",
          messagingSenderId: "751999178093",
          appId: "1:751999178093:web:d7e64343ebf14d0cebf664"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // 初始化管理員配置系統
        if (window.initAdminConfig) {
            window.initAdminConfig(db);
        }
        // --- END: Firebase Initialization ---

        // 🚨 檢測 file:// 協議並顯示嚴重警告
        if (window.location.protocol === 'file:') {
            console.error('');
            console.error('═'.repeat(80));
            console.error('❌❌❌ 嚴重錯誤: 使用 file:// 協議開啟網頁 ❌❌❌');
            console.error('═'.repeat(80));
            console.error('');
            console.error('🔴 當前狀態: origin = "null"');
            console.error('🔴 所有 CORS 代理都會失敗！');
            console.error('🔴 Google Apps Script 代理也無法使用！');
            console.error('🔴 無法讀取任何機台數據！');
            console.error('');
            console.error('📋 解決方案:');
            console.error('  1️⃣  關閉此瀏覽器視窗');
            console.error('  2️⃣  雙擊執行 "啟動服務器.bat"');
            console.error('  3️⃣  瀏覽器會自動開啟 http://localhost:8000/index.html');
            console.error('');
            console.error('💡 手動啟動方式:');
            console.error('  cmd> cd "' + (window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/')) || '').replace(/^\//, '') + '"');
            console.error('  cmd> python -m http.server 8000');
            console.error('  然後瀏覽器開啟: http://localhost:8000/index.html');
            console.error('');
            console.error('═'.repeat(80));
            console.error('');
            
            // 🔇 已停用全屏警告遮罩 (用戶要求)
            // 保留 Console 警告訊息供除錯使用
        }

        // 偵測 HTTPS 並顯示警告
        if (window.location.protocol === 'https:') {
            const httpsWarning = document.getElementById('https-warning');
            if (httpsWarning) {
                httpsWarning.classList.remove('hidden');
                console.warn('⚠️ 頁面使用 HTTPS，WebSocket 連線將自動從 ws:// 轉換為 wss://');
            }
            
            // 增強的 HTTPS 環境檢測
            const isGitHubPages = window.location.hostname.includes('github.io');
            console.log('🔒 HTTPS 環境檢測結果:');
            console.log(`   部署平台: ${isGitHubPages ? 'GitHub Pages' : '其他 HTTPS 服務'}`);
            console.log(`   目標伺服器: http://update.feiloli.com.tw:5539`);
            console.log(`   自動使用 CORS 代理讀取數據`);
            console.log(`   讀取指令功能受限 (僅限 HTTP 環境)`);
            
            // 顯示在 UI 上的提示（可選）
            setTimeout(() => {
                const pollAllBtn = document.getElementById('poll-all-btn');
                if (pollAllBtn) {
                    const badge = document.createElement('span');
                    badge.className = 'absolute top-0 right-0 bg-yellow-500 text-xs px-2 py-0.5 rounded-full';
                    badge.textContent = 'HTTPS 模式';
                    badge.title = '在 HTTPS 環境下，部分 HTTP 指令功能可能受限';
                    pollAllBtn.parentElement.style.position = 'relative';
                    pollAllBtn.parentElement.appendChild(badge);
                }
            }, 500);
        }
        
        // 頁面載入完成後顯示 HTTP 配置資訊
        console.log('🌐 HTTP GET 配置已載入');
        console.log('📡 伺服器位址:', 'http://update.feiloli.com.tw:5539');
        console.log('🔗 API 端點:', '/textselectdata/{mac}');
        console.log('📋 範例 URL:', 'http://update.feiloli.com.tw:5539/textselectdata/083A8DE1ED14');
        console.log('🚀 優先代理: Google Apps Script (自訂 HTTPS 代理)');
        console.log(`💡 優化說明: 前端會自動只處理最新 ${window.dataProcessLimit} 筆記錄,大幅減少流量`);
        console.log('   ⚙️  可在「開發者工具 → 資料處理優化」中調整處理筆數');


        // 🚀 初始化自動輪詢事件監聽器
        setTimeout(() => {
            const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
            if (autoPollOnLoadCheckbox && !autoPollOnLoadCheckbox._initialized) {
                console.log('🔧 強制初始化自動輪詢事件監聽器');
                autoPollOnLoadCheckbox._initialized = true;
                
                autoPollOnLoadCheckbox.addEventListener('change', (e) => {
                    console.log(`🚀 自動輪詢設定變更: ${e.target.checked}`);
                    if (selectedGroupId && selectedStoreId) {
                        setAutoPollOnLoadSetting(e.target.checked);
                        
                        if (e.target.checked) {
                            console.log('✅ 已啟用進入門市自動輪詢功能');
                            // 顯示提示
                            const notification = document.createElement('div');
                            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                            notification.innerHTML = '✅ 已啟用進入門市自動輪詢';
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 2000);
                        } else {
                            console.log('❌ 已停用進入門市自動輪詢功能');
                        }
                    }
                });
            }
        }, 1000);

        // 🔧 開發者模式初始化
        setTimeout(() => {
            initDeveloperMode();
        }, 1500);

        // --- HTTP GET 輪詢配置 ---
        let httpPollingEnabled = true;
        let httpPollingTimer = null;
        let httpPollingInterval = 5000; // 預設 5 秒輪詢一次
        let httpLastRequestTime = 0;
        let httpRequestCount = 0;
        let httpErrorCount = 0;
        let httpLastResponse = null;
        let corsQuietMode = true; // ✅ 啟用 CORS 靜默模式 - 錯誤只記錄到控制台，不顯示警告框
        
        // 🚀 資料處理限制 - 控制每次處理的最大筆數
        window.dataProcessLimit = 10; // 預設只處理最新 10 筆
        
        // 設定資料處理限制
        window.setDataLimit = function(limit) {
            if (limit < 5 || limit > 100) {
                console.error('❌ 資料限制必須在 5-100 之間');
                return false;
            }
            window.dataProcessLimit = limit;
            console.log(`✅ 資料處理限制已設定為: ${limit} 筆`);
            
            // 更新 UI 顯示
            const statusElement = document.getElementById('data-limit-status');
            if (statusElement) {
                statusElement.innerHTML = `✅ 目前只處理最新 <span class="text-green-400 font-bold">${limit}</span> 筆資料 (節省流量)`;
            }
            
            return true;
        };
        
        // 測試模式設定（用於 CORS 問題調試）
        // 🔧 修正: 只有當 port 是 8080 時才啟用測試模式，8000 是正常的 HTTP 服務器
        const isTestMode = window.location.port === '8080';
        
        // HTTP GET 伺服器配置
        const httpConfig = {
            // ✅ 永遠使用正式伺服器 (除非明確指定 port 8080)
            baseUrl: isTestMode 
                ? 'http://localhost:8080'  // 本地代理伺服器 (需另外架設)
                : 'http://update.feiloli.com.tw:5539',  // 正式伺服器 (預設)
            endpoint: '/textselectdata/{mac}', // 讀取資料端點 (前端會優化處理,只取最新10筆)
            currentMac: '083A8DE1ED14', // 預設 MAC 地址
            params: {},   // 不需要查詢參數（MAC 在路徑中）
            headers: {},  // 不需要額外標頭
            timeout: 15000 // 🚀 優化: 改為 15秒 (原 20秒) - 配合快速重試策略
        };

        // ✅ HTTP / HTTPS 傳輸模式設定
        const TRANSPORT_MODE_STORAGE_KEY = 'httpTransportMode';
        const TRANSPORT_MODE_CONFIGS = {
            'direct-http': {
                label: '內網 HTTP（直接連線）',
                baseUrl: isTestMode ? 'http://localhost:8080' : 'http://update.feiloli.com.tw:5539',
                hint: '內網 HTTP：適合在同網段或 HTTP 環境使用，直接連線設備。'
            },
            'https-proxy': {
                label: 'HTTPS（測試 / 代理）',
                baseUrl: 'https://update.feiloli.com.tw:5539',
                hint: 'HTTPS：適合在 HTTPS 環境測試，需設備提供 HTTPS 或自行設置反向代理。'
            }
        };
        let httpTransportMode = null;

        function determineDefaultTransportMode() {
            return window.location.protocol === 'https:' ? 'https-proxy' : 'direct-http';
        }

        function applyTransportMode(mode, options = {}) {
            if (!TRANSPORT_MODE_CONFIGS[mode]) {
                console.warn(`⚠️ 未知的傳輸模式: ${mode}，改用預設值。`);
                mode = determineDefaultTransportMode();
            }

            const config = TRANSPORT_MODE_CONFIGS[mode];
            httpTransportMode = mode;
            httpConfig.baseUrl = config.baseUrl;
            localStorage.setItem(TRANSPORT_MODE_STORAGE_KEY, mode);

            const selector = document.getElementById('http-transport-mode');
            if (selector) {
                selector.value = mode;
            }

            const hint = document.getElementById('http-transport-mode-hint');
            if (hint) {
                hint.textContent = config.hint;
            }

            console.log(`🚦 HTTP 傳輸模式已套用：${config.label}`);
            console.log('📡 目前使用的 baseUrl:', httpConfig.baseUrl);

            if (!(options && options.silent) && typeof showStatusMessage === 'function') {
                showStatusMessage(`已切換至「${config.label}」`, 'info');
            }
        }

        function initTransportModeSelector() {
            const savedMode = localStorage.getItem(TRANSPORT_MODE_STORAGE_KEY);
            const defaultMode = savedMode && TRANSPORT_MODE_CONFIGS[savedMode]
                ? savedMode
                : determineDefaultTransportMode();

            applyTransportMode(defaultMode, { silent: true });

            const selector = document.getElementById('http-transport-mode');
            if (!selector) {
                return;
            }

            selector.addEventListener('change', (event) => {
                applyTransportMode(event.target.value);
            });
        }
        
        // ✅ 新增：數據驗證函數
        function validateMachineData(data) {
            if (!data) {
                console.warn('⚠️ 驗證失敗: 數據為空');
                return false;
            }
            
            // 如果是字符串
            if (typeof data === 'string') {
                if (data.length === 0) {
                    console.warn('⚠️ 驗證失敗: 字符串為空');
                    return false;
                }
                // 檢查是否為有效的數據格式
                if (data.includes('CMD') || data.includes('cmd') || data.match(/\d+/) ) {
                    console.log('✅ 字符串數據驗證通過');
                    return true;
                }
            }
            
            // 如果是對象
            if (typeof data === 'object') {
                // 檢查是否有預期的欄位
                if (data.plays !== undefined || data.payouts !== undefined || 
                    data.data !== undefined || Object.keys(data).length > 0) {
                    console.log('✅ 對象數據驗證通過');
                    return true;
                }
            }
            
            console.warn('⚠️ 驗證失敗: 無效的數據格式', data);
            return false;
        }
        
        // ✅ 新增：智能重試函數
        async function fetchWithRetry(mac, maxRetries = 3, delayMs = 1500, devid = null) {
            // 精簡模式: 只記錄關鍵訊息
            const isQuickMode = maxRetries === 1 && delayMs <= 500;
            
            // 🚀 優化: 減少默認重試延遲到 500ms (原 1500ms)
            const optimizedDelay = Math.min(delayMs, 500);
            
            if (!isQuickMode) {
                console.log(`🔄 重試設定: 最多 ${maxRetries} 次，間隔 ${optimizedDelay}ms (優化後)`);
            }
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                const attemptStartTime = Date.now();
                
                try {
                    if (!isQuickMode && attempt > 1) {
                        console.log(`📤 重試 ${attempt}/${maxRetries}...`);
                    }
                    
                    const result = await sendHttpRequest(mac, devid);
                    
                    if (result && validateMachineData(result)) {
                        const attemptTime = Date.now() - attemptStartTime;
                        if (!isQuickMode && attempt > 1) {
                            console.log(`✅ 第 ${attempt} 次嘗試成功！(耗時 ${attemptTime}ms)`);
                        }
                        return result;
                    } else {
                        if (!isQuickMode) {
                            console.warn(`⚠️ 第 ${attempt} 次嘗試獲得無效數據`);
                        }
                    }
                } catch (error) {
                    if (!isQuickMode || attempt === maxRetries) {
                        console.warn(`❌ 第 ${attempt} 次嘗試失敗: ${error.message}`);
                    }
                }
                
                // 等待後重試
                if (attempt < maxRetries) {
                    if (!isQuickMode) {
                        console.log(`⏳ 等待 ${optimizedDelay}ms 後進行下次重試...`);
                    }
                    await new Promise(resolve => setTimeout(resolve, optimizedDelay));
                }
            }
            
            if (!isQuickMode) {
                console.error(`❌ 所有 ${maxRetries} 次重試都失敗了`);
            }
            return null;
        }
        
    // 初始化傳輸模式並顯示當前模式
    initTransportModeSelector();
        console.log(isTestMode ? '🧪 測試模式：使用本地服務器' : '🌐 正式模式：使用遠端服務器');
        console.log(corsQuietMode ? '🔇 CORS 靜默模式已啟用 - 錯誤只在控制台顯示' : '🔔 CORS 詳細模式已啟用 - 將顯示警告框');
        console.log('📡 目前使用的 baseUrl:', httpConfig.baseUrl);
        console.log('⏱️ HTTP 超時時間設定為:', httpConfig.timeout, 'ms');

        // --- MQTT 相關變數和功能（已棄用，保留供參考） ---
        let mqttClient = null;
        let mqttConnected = false;
        let mqttReconnectTimer = null;
        let mqttHeartbeatTimer = null;
        let mqttReconnectAttempts = 0;
        let mqttAutoReconnect = false; // 改為 false，停用自動重連
        const mqttMaxReconnectAttempts = 10;
        
        // 將 MQTT 變數設為全域，供調試使用
        window.mqttClient = null;
        window.mqttConnected = false;
        const mqttReconnectInterval = 5000; // 5秒（一般伺服器）
        const mqttReconnectIntervalOriginal = 30000; // 30秒（原伺服器，較長間隔）
        const mqttHeartbeatInterval = 30000; // 30秒
        
        // MQTT 伺服器設定
        const mqttServerConfigs = {
            hivemq: {
                url: 'ws://broker.hivemq.com:8000/mqtt',
                topic: 'coffeelens/resp'
            }
        };
        
        // 快速設定 MQTT 伺服器
        function setMqttServer(serverKey) {
            const config = mqttServerConfigs[serverKey];
            if (!config) return;
            
            // 如果已連線，先中斷
            if (mqttConnected && mqttClient) {
                mqttClient.end();
                mqttConnected = false;
            }
            
            // 更新輸入框
            document.getElementById('mqtt-broker-url').value = config.url;
            document.getElementById('mqtt-topic').value = config.topic;
            
            console.log(`已設定 MQTT 伺服器: ${config.url}`);
        }
        
        // 讓函數在全域範圍可用
        window.setMqttServer = setMqttServer;
        
        // ========================================
        // HTTP GET 輪詢功能
        // ========================================
        
        // 代理成功率追蹤
        let proxySuccessStats = {
            // 格式: { 'MAC_代理名稱': { success: 數量, total: 數量, lastUsed: 時間戳 } }
        };
        
        // 記錄代理使用結果
        function recordProxyResult(macAddress, proxyName, success) {
            const key = `${macAddress}_${proxyName}`;
            if (!proxySuccessStats[key]) {
                proxySuccessStats[key] = { success: 0, total: 0, lastUsed: Date.now() };
            }
            
            proxySuccessStats[key].total++;
            if (success) {
                proxySuccessStats[key].success++;
            }
            proxySuccessStats[key].lastUsed = Date.now();
            
            // 清理過舊的統計資料 (超過 7 天)
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            Object.keys(proxySuccessStats).forEach(k => {
                if (proxySuccessStats[k].lastUsed < weekAgo) {
                    delete proxySuccessStats[k];
                }
            });
        }
        
        // 獲取代理成功率
        function getProxySuccessRate(macAddress, proxyName) {
            const key = `${macAddress}_${proxyName}`;
            const stats = proxySuccessStats[key];
            if (!stats || stats.total === 0) return 0.5; // 預設 50%
            return stats.success / stats.total;
        }
        
        // 建構完整的 HTTP GET URL
        function buildHttpUrl(mac = null) {
            if (!httpConfig.baseUrl || !httpConfig.endpoint) {
                console.error('❌ HTTP 配置不完整：缺少 baseUrl 或 endpoint');
                return null;
            }
            
            // 使用提供的 MAC 或預設的 MAC
            const macAddress = mac || httpConfig.currentMac;
            
            // 替換路徑中的 {mac} 參數
            let endpointPath = httpConfig.endpoint.replace('{mac}', macAddress);
            
            // 建構完整 URL
            const fullUrl = httpConfig.baseUrl + endpointPath;
            
            // 如果有查詢參數，添加到 URL
            if (httpConfig.params && Object.keys(httpConfig.params).length > 0) {
                const url = new URL(fullUrl);
                Object.keys(httpConfig.params).forEach(key => {
                    url.searchParams.append(key, httpConfig.params[key]);
                });
                return url.toString();
            }
            
            return fullUrl;
        }
        
        // 發送 HTTP GET 請求
        async function sendHttpRequest(mac = null, devid = null) {
            const url = buildHttpUrl(mac);
            if (!url) {
                updateHttpStatus(false, '配置錯誤');
                return null;
            }
            
            httpLastRequestTime = Date.now();
            httpRequestCount++;
            
            // 更新請求計數顯示
            const countElement = document.getElementById('http-request-count');
            if (countElement) {
                countElement.textContent = httpRequestCount;
            }
            
            console.log(`📤 [${httpRequestCount}] 發送 HTTP GET 請求: ${url}`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), httpConfig.timeout);
                
                let response;
                
                // 第一次嘗試：正常 CORS 請求
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: httpConfig.headers || {},
                        signal: controller.signal,
                        mode: 'cors'
                    });
                } catch (corsError) {
                    clearTimeout(timeoutId);
                    
                    // 嘗試使用 CORS 代理服務
                    console.warn('❌ 直接請求失敗，嘗試 CORS 代理服務...');
                    
                    // 智能代理選擇 - 根據機台 MAC 和歷史成功率
                    function getOptimizedProxyOrder(macAddress) {
                        // 🚀 優化: 只保留最穩定有效的代理,減少嘗試次數
                        const baseProxies = [
                            { 
                                name: 'Google Apps Script (自訂代理) ⭐', 
                                buildUrl: (targetUrl) => `https://script.google.com/macros/s/AKfycbwjlQbQYB-sdnx-yEYgu25XktnW9zAA7w20yaA6i4C7L4Hz1UZUJ3-KqUBrbdHxND3sug/exec?url=${encodeURIComponent(targetUrl)}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    try {
                                        return JSON.parse(text);
                                    } catch (e) {
                                        return text;
                                    }
                                }
                            },
                            { 
                                name: 'AllOrigins (Raw)', 
                                buildUrl: (targetUrl) => `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            },
                            { 
                                name: 'AllOrigins (推薦)', 
                                buildUrl: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&pretty=true`,
                                parseResponse: async (response) => {
                                    const data = await response.json();
                                    if (!data.contents) throw new Error('No contents in response');
                                    return data.contents;
                                }
                            },
                            { 
                                name: 'ThingProxy', 
                                buildUrl: (targetUrl) => `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
                                parseResponse: async (response) => {
                                    const text = await response.text();
                                    return text;
                                }
                            }
                            // 🚀 優化: 移除不穩定的代理 (CORS Anywhere, Proxyjump, YACDN, JsonBox)
                            // ⭐ Google Apps Script 設為第一優先 - 需確保已設定 CORS 標頭
                        ];
                        
                        // 根據歷史成功率動態排序代理
                        const proxiesWithStats = baseProxies.map(proxy => ({
                            ...proxy,
                            successRate: getProxySuccessRate(macAddress, proxy.name)
                        }));
                        
                        // 按成功率降序排列，但保留一些隨機性避免過度優化
                        proxiesWithStats.sort((a, b) => {
                            const aRate = a.successRate + (Math.random() * 0.1 - 0.05); // ±5% 隨機性
                            const bRate = b.successRate + (Math.random() * 0.1 - 0.05);
                            return bRate - aRate;
                        });
                        
                        // 針對特定機台 MAC 模式的額外調整
                        if (macAddress.startsWith('48E729')) {
                            // 這類機台如果 AllOrigins Raw 成功率不錯，提升其優先級
                            const rawProxy = proxiesWithStats.find(p => p.name.includes('Raw'));
                            if (rawProxy && rawProxy.successRate > 0.6) {
                                proxiesWithStats.splice(proxiesWithStats.indexOf(rawProxy), 1);
                                proxiesWithStats.unshift(rawProxy);
                            }
                        } else if (macAddress.startsWith('3494')) {
                            // 已知這類機台連線較穩定，如果某個代理效果好就提升它
                            const bestProxy = proxiesWithStats[0];
                            if (bestProxy.successRate > 0.8) {
                                console.log(`🎯 機台 ${macAddress} 優先使用高成功率代理: ${bestProxy.name} (${Math.round(bestProxy.successRate * 100)}%)`);
                            }
                        }
                        
                        return proxiesWithStats;
                    }
                    
                    // 改進的代理配置 - 使用智能選擇
                    const proxyConfigs = getOptimizedProxyOrder(mac);
                    
                    let proxySuccess = false;
                    
                    for (const proxyConfig of proxyConfigs) {
                        try {
                            const proxyUrl = proxyConfig.buildUrl(url);
                            console.log(`🔄 嘗試代理 (${proxyConfig.name}): ${proxyUrl.substring(0, 80)}...`);
                            
                            // 🚀 優化: 為每個代理請求設置獨立的 10 秒超時
                            const proxyController = new AbortController();
                            const proxyTimeoutId = setTimeout(() => proxyController.abort(), 10000);
                            
                            const proxyResponse = await fetch(proxyUrl, {
                                signal: proxyController.signal,
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json, text/plain, */*'
                                }
                            });
                            
                            clearTimeout(proxyTimeoutId);
                            
                            if (proxyResponse.ok) {
                                let parsedData;
                                
                                try {
                                    parsedData = await proxyConfig.parseResponse(proxyResponse);
                                } catch (parseErr) {
                                    console.warn(`⚠️ 代理回應解析失敗:`, parseErr);
                                    parsedData = await proxyResponse.text();
                                }
                                
                                // 嘗試解析為 JSON
                                if (typeof parsedData === 'string') {
                                    try {
                                        parsedData = JSON.parse(parsedData);
                                    } catch (jsonErr) {
                                        // 不是 JSON，維持文字格式
                                    }
                                }
                                
                                // 🚀 優化: 如果是陣列且超過限制,立即只保留最新 N 筆
                                const limit = window.dataProcessLimit || 10;
                                if (Array.isArray(parsedData) && parsedData.length > limit) {
                                    console.log(`⚡ [代理優化] 資料有 ${parsedData.length} 筆,只保留最新 ${limit} 筆`);
                                    parsedData = parsedData.slice(0, limit);
                                }
                                
                                httpLastResponse = parsedData;
                                console.log(`✅ 代理請求成功 (${proxyConfig.name}):`, parsedData);
                                updateHttpStatus(true, `✅ 已透過 ${proxyConfig.name} 代理取得資料 (${new Date().toLocaleTimeString()})`);
                                
                                // 記錄代理成功
                                recordProxyResult(mac, proxyConfig.name, true);
                                
                                // 代理成功時進行資料處理，傳遞 MAC 和 devid
                                handleHttpResponse(parsedData, mac, devid);
                                httpErrorCount = 0;
                                
                                proxySuccess = true;
                                return parsedData;
                            } else {
                                // 詳細的錯誤狀態碼處理
                                let errorMsg = `HTTP ${proxyResponse.status}`;
                                if (proxyResponse.status === 400) {
                                    errorMsg += ' (Bad Request - 可能 URL 格式問題)';
                                } else if (proxyResponse.status === 403) {
                                    errorMsg += ' (Forbidden - 代理服務限制)';
                                } else if (proxyResponse.status === 404) {
                                    errorMsg += ' (Not Found - 目標服務不存在)';
                                } else if (proxyResponse.status === 500) {
                                    errorMsg += ' (Internal Server Error - 代理服務錯誤)';
                                } else if (proxyResponse.status === 503) {
                                    errorMsg += ' (Service Unavailable - 代理服務過載)';
                                }
                                
                                console.warn(`⚠️ 代理 ${proxyConfig.name} 返回 ${errorMsg}`);
                                
                                // 記錄代理失敗
                                recordProxyResult(mac, proxyConfig.name, false);
                                
                                // 特殊處理 HTTP 400 - 可能是 URL 編碼問題，嘗試不同的編碼方式
                                if (proxyResponse.status === 400 && proxyConfig.name.includes('AllOrigins')) {
                                    console.log(`🔄 ${proxyConfig.name} HTTP 400，可能 URL 編碼問題，將嘗試下個代理...`);
                                }
                            }
                        } catch (proxyError) {
                            console.warn(`❌ 代理 ${proxyConfig.name} 失敗:`, proxyError.message);
                            
                            // 記錄代理失敗
                            recordProxyResult(mac, proxyConfig.name, false);
                            
                            continue;
                        }
                    }
                    
                    if (!proxySuccess) {
                        // 所有代理都失敗
                        console.error('❌ CORS 錯誤:', corsError.message);
                        console.error('📝 所有代理服務均失敗，可選方案：');
                        console.log('   1️⃣ 檢查網路連線是否正常');
                        console.log('   2️⃣ 檢查目標伺服器 ' + url + ' 是否在線');
                        console.log('   3️⃣ 在新分頁中直接訪問此 URL 測試');
                        console.log('   4️⃣ 聯繫後端管理員啟用 CORS 支持');
                        
                        updateHttpStatus(false, '❌ 網路連線或伺服器異常 - 請檢查');
                        
                        httpErrorCount++;
                        const errorCountElement = document.getElementById('http-error-count');
                        if (errorCountElement) {
                            errorCountElement.textContent = httpErrorCount;
                        }
                        
                        // 記錄到命令日誌
                        addCommandLog('error', `HTTP 請求失敗: ${corsError.message}`, {
                            url: url,
                            error: corsError.message
                        });
                        
                        return null;
                    }
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 嘗試解析回應
                let data;
                const contentType = response.headers.get('content-type');
                
                try {
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }
                } catch (parseError) {
                    console.warn('⚠️ 無法解析回應:', parseError);
                    data = await response.text();
                }
                
                httpLastResponse = data;
                httpErrorCount = 0; // 重置錯誤計數
                
                console.log('📥 收到回應:', data);
                console.log('📊 資料類型:', typeof data);
                console.log('📏 資料長度:', typeof data === 'string' ? data.length : JSON.stringify(data).length);
                
                updateHttpStatus(true, '請求成功');
                
                // 處理回應資料，傳遞 MAC 和 devid
                handleHttpResponse(data, mac, devid);
                
                return data;
                
            } catch (error) {
                httpErrorCount++;
                
                // 更新錯誤計數顯示
                const errorCountElement = document.getElementById('http-error-count');
                if (errorCountElement) {
                    errorCountElement.textContent = httpErrorCount;
                }
                
                console.error(`❌ HTTP 請求失敗 (${httpErrorCount}):`, error.message);
                console.error('錯誤詳情:', error);
                
                if (error.name === 'AbortError') {
                    updateHttpStatus(false, '請求超時');
                } else if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    updateHttpStatus(false, 'CORS 錯誤');
                } else {
                    updateHttpStatus(false, `錯誤: ${error.message}`);
                }
                
                return null;
            }
        }
        
        // ✅ 新增：快速檢查是否包含目標資料（優先級過濾）
        function quickCheckForTargetData(data, devid) {
            try {
                console.log(`🔍 [優先級過濾] 檢查資料，DevID: ${devid}`);
                
                // 如果是陣列，快速檢查是否包含 re_readdata 命令
                if (Array.isArray(data)) {
                    console.log(`📊 [優先級過濾] 陣列數據，共 ${data.length} 筆記錄`);
                    
                    let reReaddataCount = 0;
                    let targetDevidCount = 0;
                    
                    const hasTargetData = data.some(record => {
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.cmd === 're_readdata') {
                                    reReaddataCount++;
                                    if (devid === null || parseInt(parsed.devid) === parseInt(devid)) {
                                        targetDevidCount++;
                                        return true;
                                    }
                                }
                            } catch (e) {
                                // JSON 解析失敗，忽略
                            }
                        }
                        return false;
                    });
                    
                    console.log(`📋 [優先級過濾] 找到 ${reReaddataCount} 筆 re_readdata 記錄`);
                    console.log(`🎯 [優先級過濾] 其中 ${targetDevidCount} 筆符合 DevID ${devid}`);
                    console.log(`✅ [優先級過濾] 結果: ${hasTargetData ? '通過' : '不通過'}`);
                    
                    return hasTargetData;
                }
                
                // 其他資料格式的快速檢查
                if (typeof data === 'object' && data.cmd === 're_readdata') {
                    console.log(`✅ [優先級過濾] 物件格式，cmd=re_readdata，通過`);
                    return true;
                }
                
                // 如果是文本，檢查是否包含關鍵字
                if (typeof data === 'string' && data.includes('re_readdata')) {
                    console.log(`✅ [優先級過濾] 字串格式，包含 re_readdata，通過`);
                    return true;
                }
                
                console.log(`❌ [優先級過濾] 資料格式不符或無目標數據，不通過`);
                console.log(`📊 [優先級過濾] 資料類型: ${typeof data}, 是否陣列: ${Array.isArray(data)}`);
                
                return false;
            } catch (error) {
                console.warn('⚠️ 優先級過濾檢查出錯:', error);
                return false;
            }
        }

        // 📄 處理 HTTP 回應資料
        // 輪詢記錄管理函數 - 僅用於輪詢臨時記錄，不影響正式的 Firebase 記錄
        // ✅ 注意：此函數僅用於輪詢自動記帳的臨時顯示，不會修改 Firebase 數據庫
        // 🧪 自動輪詢功能測試函數
        window.testAutoPoll = function() {
            console.log('\n🧪 測試自動輪詢功能');
            console.log(`當前門市: ${selectedGroupId}/${selectedStoreId}`);
            
            if (selectedGroupId && selectedStoreId) {
                const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
                const rawValue = localStorage.getItem(settingKey);
                const parsedValue = getAutoPollOnLoadSetting();
                
                console.log(`設定鍵值: ${settingKey}`);
                console.log(`localStorage 原始值: "${rawValue}"`);
                console.log(`解析後狀態: ${parsedValue ? '已啟用' : '已停用'}`);
                
                // 檢查 UI 狀態
                const checkbox = document.getElementById('auto-poll-on-load');
                console.log(`UI 勾選框狀態: ${checkbox ? checkbox.checked : '找不到元素'}`);
                
                console.log('手動觸發自動輪詢...');
                triggerAutoPollOnLoad();
            } else {
                console.log('❌ 未選擇門市');
            }
        };
        
        // 🔧 強制啟用自動輪詢測試函數
        window.forceEnableAutoPoll = function() {
            if (selectedGroupId && selectedStoreId) {
                setAutoPollOnLoadSetting(true);
                const checkbox = document.getElementById('auto-poll-on-load');
                if (checkbox) {
                    checkbox.checked = true;
                }
                console.log('✅ 已強制啟用自動輪詢功能');
                triggerAutoPollOnLoad();
            } else {
                console.log('❌ 未選擇門市，無法設定');
            }
        };
        
        // � 開發者模式功能
        function initDeveloperMode() {
            const toggleBtn = document.getElementById('toggle-dev-mode');
            const devTools = document.getElementById('developer-tools');
            
            if (!toggleBtn || !devTools) {
                console.warn('⚠️ 找不到開發者模式元素');
                return;
            }
            
            // 從 localStorage 讀取開發者模式狀態
            let isDevMode = localStorage.getItem('developerMode') === 'true';
            
            // 設定初始狀態
            updateDeveloperModeUI(isDevMode, toggleBtn, devTools);
            
            // 綁定切換事件
            toggleBtn.addEventListener('click', () => {
                isDevMode = !isDevMode;
                localStorage.setItem('developerMode', isDevMode.toString());
                updateDeveloperModeUI(isDevMode, toggleBtn, devTools);
                
                // 顯示狀態通知
                showDeveloperModeNotification(isDevMode);
                
                console.log(`🔧 開發者模式${isDevMode ? '已啟用' : '已關閉'}`);
            });
        }
        
        function updateDeveloperModeUI(isEnabled, toggleBtn, devTools) {
            if (isEnabled) {
                devTools.classList.remove('hidden');
                toggleBtn.textContent = '隱藏調試工具';
                toggleBtn.className = 'bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition-colors';
            } else {
                devTools.classList.add('hidden');
                toggleBtn.textContent = '顯示調試工具';
                toggleBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded transition-colors';
            }
        }
        
        function showDeveloperModeNotification(isEnabled) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium transition-all duration-300 ${
                isEnabled ? 'bg-green-600' : 'bg-gray-600'
            }`;
            notification.innerHTML = `🔧 開發者模式${isEnabled ? '已啟用' : '已關閉'}`;
            
            document.body.appendChild(notification);
            
            // 淡出動畫
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // �🔍 完整診斷函數
        window.diagnoseAutoPoll = function() {
            console.log('\n🔍 ===== 自動輪詢功能診斷 =====');
            
            // 檢查基本狀態
            console.log('1. 基本狀態:');
            console.log(`   selectedGroupId: ${selectedGroupId}`);
            console.log(`   selectedStoreId: ${selectedStoreId}`);
            console.log(`   appData.machines: ${appData?.machines?.length || '未載入'} 台`);
            
            // 檢查UI元素
            console.log('\n2. UI 元素:');
            const checkbox = document.getElementById('auto-poll-on-load');
            console.log(`   勾選框存在: ${!!checkbox}`);
            console.log(`   勾選框狀態: ${checkbox?.checked}`);
            console.log(`   勾選框初始化: ${checkbox?._initialized}`);
            
            // 檢查設定
            console.log('\n3. 儲存設定:');
            if (selectedGroupId && selectedStoreId) {
                const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
                const rawValue = localStorage.getItem(settingKey);
                const parsedValue = getAutoPollOnLoadSetting();
                
                console.log(`   設定鍵值: ${settingKey}`);
                console.log(`   原始值: "${rawValue}"`);
                console.log(`   解析值: ${parsedValue}`);
            }
            
            // 檢查計時器
            console.log('\n4. 計時器狀態:');
            console.log(`   autoPollOnLoadTimer: ${autoPollOnLoadTimer ? '運行中' : '空閒'}`);
            
            // 檢查函數
            console.log('\n5. 函數檢查:');
            console.log(`   triggerAutoPollOnLoad: ${typeof triggerAutoPollOnLoad}`);
            console.log(`   pollAllMachines: ${typeof pollAllMachines}`);
            
            console.log('\n===== 診斷完成 =====\n');
            
            // 提供修復建議
            if (selectedGroupId && selectedStoreId && checkbox) {
                console.log('🔧 嘗試修復...');
                
                // 強制設定勾選框狀態
                const currentSetting = getAutoPollOnLoadSetting();
                checkbox.checked = currentSetting;
                
                if (currentSetting) {
                    console.log('✅ 設定已啟用，手動觸發測試...');
                    triggerAutoPollOnLoad();
                } else {
                    console.log('❌ 設定未啟用，請手動勾選或執行 forceEnableAutoPoll()');
                }
            }
        };
        
        // 🔧 開發者模式測試函數
        window.toggleDeveloperMode = function() {
            const toggleBtn = document.getElementById('toggle-dev-mode');
            if (toggleBtn) {
                toggleBtn.click();
            } else {
                console.log('❌ 找不到開發者模式切換按鈕');
            }
        };
        
        // 💡 開發者模式說明
        window.showDeveloperModeHelp = function() {
            console.log('\n🔧 ===== 開發者模式說明 =====');
            console.log('');
            console.log('📌 功能說明:');
            console.log('   開發者模式隱藏了工程調試工具和批次處理設定，讓界面更簡潔');
            console.log('');
            console.log('🎯 使用方式:');
            console.log('   1. 點擊「顯示調試工具」按鈕啟用');
            console.log('   2. 或在控制台執行: toggleDeveloperMode()');
            console.log('');
            console.log('🔧 可用命令:');
            console.log('   • toggleDeveloperMode() - 切換開發者模式');
            console.log('   • testAutoPoll() - 測試自動輪詢');
            console.log('   • diagnoseAutoPoll() - 診斷自動輪詢');
            console.log('   • forceEnableAutoPoll() - 強制啟用自動輪詢');
            console.log('');
            console.log('🛠️ 開發者工具包含:');
            console.log('   • HTTP GET 資料擷取測試');
            console.log('   • 批次處理設定 (大小調整、無限制模式)');
            console.log('   • 命令記錄查看');
            console.log('   • 機台資料即時顯示');
            console.log('');
            console.log('💾 狀態保存:');
            console.log('   開發者模式狀態會自動保存到 localStorage');
            console.log('');
            console.log('==============================\n');
        };
        
        // 🧪 測試修改按鈕功能
        window.testEditButton = function() {
            console.log('\n🧪 測試修改按鈕功能');
            
            const editBtns = document.querySelectorAll('.edit-machine-btn');
            console.log(`找到 ${editBtns.length} 個修改按鈕`);
            
            if (editBtns.length > 0) {
                const firstBtn = editBtns[0];
                console.log('第一個修改按鈕的資料:', firstBtn.dataset);
                console.log('嘗試觸發點擊事件...');
                firstBtn.click();
            } else {
                console.log('❌ 沒有找到修改按鈕');
            }
        }

        // 🌐 檢查部署環境
        window.checkDeploymentEnvironment = function() {
            console.log('\n🔍 ===== 部署環境完整檢查 =====');
            console.log('當前 URL:', window.location.href);
            console.log('協議:', window.location.protocol);
            console.log('主機名:', window.location.hostname);
            console.log('是否 HTTPS:', window.location.protocol === 'https:');
            console.log('是否 GitHub Pages:', window.location.hostname.includes('github.io'));
            console.log('');
            console.log('目標伺服器配置:');
            console.log('  基礎 URL:', httpConfig.baseUrl);
            console.log('  API 端點:', httpConfig.endpoint);
            console.log('  超時時間:', httpConfig.timeout, 'ms');
            console.log('');
            
            const isHttps = window.location.protocol === 'https:';
            const targetIsHttp = httpConfig.baseUrl.startsWith('http:');
            
            if (isHttps && targetIsHttp) {
                console.warn('⚠️ 檢測到混合內容問題！');
                console.log('HTTPS 頁面 + HTTP 目標 = 瀏覽器會阻止直接請求');
                console.log('');
                console.log('✅ 解決方案已部署:');
                console.log('   1️⃣ 自動使用 CORS 代理服務');
                console.log('   2️⃣ 支援多個代理備份');
                console.log('   3️⃣ 自動故障轉移');
                console.log('');
                console.log('🧪 測試代理：輸入 testCorsProxy()');
            } else if (!isHttps) {
                console.log('✅ HTTP 環境: 可以完全支援所有功能');
            }
            
            console.log('===============================');
        }

        // 🧪 測試 CORS 代理功能
        window.testCorsProxy = function() {
            console.log('\n🧪 ===== CORS 代理功能測試 =====');
            
            const testMac = '083A8DE1ED14';
            const testUrl = `http://update.feiloli.com.tw:5539/textselectdata/${testMac}`;
            
            console.log(`目標 URL: ${testUrl} (優化: 只讀取最新10筆)\n`);
            
            // 測試所有代理
            const proxyConfigs = [
                { 
                    name: 'AllOrigins (推薦)', 
                    buildUrl: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&pretty=true`,
                    parseResponse: async (response) => {
                        const data = await response.json();
                        if (!data.contents) throw new Error('No contents in response');
                        return data.contents;
                    }
                },
                { 
                    name: 'Proxyjump', 
                    buildUrl: (targetUrl) => `https://proxy.cross-origin.com/?url=${encodeURIComponent(targetUrl)}`,
                    parseResponse: async (response) => {
                        const text = await response.text();
                        return text;
                    }
                }
            ];
            
            (async () => {
                for (const proxyConfig of proxyConfigs) {
                    try {
                        const proxyUrl = proxyConfig.buildUrl(testUrl);
                        console.log(`🔄 測試代理 (${proxyConfig.name})...`);
                        console.log(`   代理 URL: ${proxyUrl.substring(0, 100)}...`);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json, text/plain, */*'
                            }
                        });
                        
                        if (response.ok) {
                            try {
                                const data = await proxyConfig.parseResponse(response);
                                console.log(`✅ ${proxyConfig.name} 可用！`);
                                console.log(`   回應長度: ${JSON.stringify(data).length} 字元`);
                                console.log(`   預覽: ${JSON.stringify(data).substring(0, 100)}...`);
                            } catch (parseErr) {
                                console.warn(`⚠️ ${proxyConfig.name} 回應解析失敗:`, parseErr.message);
                            }
                        } else {
                            console.warn(`❌ ${proxyConfig.name} HTTP ${response.status}`);
                        }
                    } catch (err) {
                        console.warn(`❌ ${proxyConfig.name} 失敗:`, err.message);
                    }
                    
                    // 間隔 1 秒避免過快
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                console.log('\n=============================');
                console.log('✅ 代理測試完成');
                console.log('建議使用第一個可用的代理');
                console.log('=============================');
            })();
        }

        // 🔍 機台資料診斷工具
        window.diagnoseMachineData = function() {
            console.log('\n🔍 ===== 機台資料診斷 =====');
            
            if (!appData || !appData.machines) {
                console.log('❌ 機台資料不存在');
                return;
            }
            
            console.log(`📊 共有 ${appData.machines.length} 台機台:`);
            appData.machines.forEach((machine, index) => {
                console.log(`\n機台 ${index + 1}:`);
                console.log(`   ID: ${machine.id}`);
                console.log(`   位置: ${machine.location}`);
                console.log(`   MAC: ${machine.mac || '未設定'}`);
                console.log(`   設備ID: ${machine.devid || '未設定'}`);
                console.log(`   投幣校正: ${machine.playsCalibration || 0}`);
                console.log(`   出貨校正: ${machine.payoutsCalibration || 0}`);
                console.log(`   DocID: ${machine.docId}`);
            });
            
            // 檢查表格中的按鈕屬性
            console.log('\n🔧 檢查表格按鈕屬性:');
            const pollBtns = document.querySelectorAll('.poll-machine-btn');
            pollBtns.forEach((btn, index) => {
                console.log(`輪詢按鈕 ${index + 1}:`);
                console.log(`   MAC: ${btn.getAttribute('data-mac')}`);
                console.log(`   設備ID: ${btn.getAttribute('data-devid')}`);
            });
            
            // 檢查輸入框的值
            console.log('\n🔧 檢查表格輸入框:');
            const macInputs = document.querySelectorAll('.mac-address-input');
            const devidInputs = document.querySelectorAll('.device-id-input');
            
            macInputs.forEach((input, index) => {
                console.log(`MAC輸入框 ${index + 1}: ${input.value}`);
            });
            
            devidInputs.forEach((input, index) => {
                console.log(`設備ID輸入框 ${index + 1}: ${input.value}`);
            });
            
            console.log('\n===============================');
        }

        // 🧪 GitHub Pages CORS 代理連接測試工具
        window.testHttpConnection = function() {
            console.log('\n🧪 ===== HTTP 連接測試 (CORS 代理模式) =====\n');
            
            const isHttps = window.location.protocol === 'https:';
            const isGitHub = window.location.hostname.includes('github.io');
            
            console.log(`📍 當前環境: ${isHttps ? 'HTTPS' : 'HTTP'}`);
            console.log(`🔗 主機: ${window.location.hostname}`);
            console.log(`📡 GitHub Pages: ${isGitHub ? '✅ 是' : '❌ 否'}\n`);
            
            const testUrl = 'http://update.feiloli.com.tw:5539/textselectdata/083A8DE1ED14';
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(testUrl)}&pretty=true`;
            
            console.log(`🎯 測試伺服器: ${testUrl}`);
            console.log(`🔄 使用代理: AllOrigins\n`);
            
            console.log('⏳ 正在連接...\n');
            
            fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log(`📊 HTTP 狀態: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('\n✅ ===== 連接成功！=====');
                console.log('📝 回應內容:');
                console.log(data.contents ? data.contents.substring(0, 200) + '...' : data);
                console.log('\n🎉 代理工作正常！');
                console.log('======================\n');
            })
            .catch(error => {
                console.log('\n❌ ===== 連接失敗 =====');
                console.log(`⚠️ 錯誤: ${error.message}`);
                console.log('\n📋 可能的原因:');
                console.log('1. 目標伺服器 (update.feiloli.com.tw:5539) 離線');
                console.log('2. AllOrigins 代理服務暫時不可用');
                console.log('3. 網路連接異常');
                console.log('\n🔧 解決方案:');
                console.log('1. 檢查伺服器是否在線');
                console.log('2. 嘗試其他代理服務');
                console.log('3. 檢查網路連接');
                console.log('======================\n');
            });
        };

        // 首次載入時顯示說明
        setTimeout(() => {
            console.log('💡 輸入 showDeveloperModeHelp() 查看開發者模式說明');
            console.log('💡 輸入 diagnoseMachineData() 診斷機台資料同步問題');
            console.log('💡 輸入 testEditButton() 測試修改按鈕功能');
            console.log('💡 輸入 checkDeploymentEnvironment() 檢查部署環境');
            console.log('💡 輸入 testCorsProxy() 測試 CORS 代理功能');
            console.log('💡 輸入 backfillHistoryData() 補齊歷史記錄到 history 集合');
            console.log('💡 輸入 testHttpConnection() 測試 GitHub Pages HTTP 連接');
        }, 3000);
        
        // 🔥 補齊歷史數據到 history 集合
        window.backfillHistoryData = async function(startDate = '2025-10-10', endDate = null) {
            if (!selectedGroupId) {
                console.error('❌ 請先選擇群組');
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('🔥 開始補齊歷史數據到 history 集合');
            console.log('='.repeat(80));
            
            const end = endDate ? new Date(endDate) : new Date();
            const start = new Date(startDate);
            
            console.log(`📅 日期範圍: ${startDate} ~ ${end.toISOString().split('T')[0]}`);
            console.log(`📊 群組: ${selectedGroupId}`);
            console.log('');

            try {
                // 獲取所有門市
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').get();
                
                console.log(`✅ 找到 ${storesSnapshot.docs.length} 個門市`);
                console.log('');

                let totalProcessed = 0;
                let totalSaved = 0;
                let totalErrors = 0;

                // 遍歷每個門市
                for (const storeDoc of storesSnapshot.docs) {
                    const storeId = storeDoc.id;
                    const storeName = storeDoc.data().name || storeId;
                    
                    console.log(`\n${'─'.repeat(80)}`);
                    console.log(`🏪 處理門市: ${storeName} (${storeId})`);
                    console.log(`${'─'.repeat(80)}`);

                    try {
                        // 獲取該門市的所有機台
                        const storeData = storeDoc.data();
                        const machines = storeData.machines || [];
                        
                        if (machines.length === 0) {
                            console.log('   ⚠️ 此門市沒有機台');
                            continue;
                        }

                        console.log(`   找到 ${machines.length} 台機台`);

                        // 為每一天創建記錄
                        let currentDate = new Date(start);
                        const storeRef = db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId);
                        const historyRef = storeRef.collection('history');

                        while (currentDate <= end) {
                            const dateStr = currentDate.toISOString().split('T')[0];
                            
                            // 檢查是否已存在
                            const existingDoc = await historyRef.doc(dateStr).get();
                            if (existingDoc.exists) {
                                console.log(`   ⏭️  跳過 ${dateStr} (已存在)`);
                                currentDate.setDate(currentDate.getDate() + 1);
                                totalProcessed++;
                                continue;
                            }

                            // 從 dailyRecords 中獲取該日期的數據
                            let dayTotalNewPlays = 0;
                            let dayTotalNewPayouts = 0;
                            let dayTotalPlays = 0;
                            let dayTotalPayouts = 0;
                            let foundData = false;

                            machines.forEach(machine => {
                                const recordKey = `${machine.id}_${machine.location}_${dateStr}`;
                                const record = window.dailyRecords?.[recordKey];
                                
                                if (record) {
                                    dayTotalPlays += record.plays || 0;
                                    dayTotalPayouts += record.payouts || 0;
                                    foundData = true;
                                }
                            });

                            // 計算新增值 (簡化版: 假設等於當日總數)
                            dayTotalNewPlays = dayTotalPlays;
                            dayTotalNewPayouts = dayTotalPayouts;

                            // 如果有數據,保存到 history
                            if (foundData && (dayTotalNewPlays > 0 || dayTotalNewPayouts > 0)) {
                                await historyRef.doc(dateStr).set({
                                    date: dateStr,
                                    newPlays: dayTotalNewPlays,
                                    newPayouts: dayTotalNewPayouts,
                                    totalPlays: dayTotalPlays,
                                    totalPayouts: dayTotalPayouts,
                                    backfilled: true,
                                    backfilledAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    source: 'dailyRecords'
                                });
                                
                                console.log(`   ✅ ${dateStr}: newPlays=${dayTotalNewPlays}, newPayouts=${dayTotalNewPayouts}`);
                                totalSaved++;
                            } else {
                                console.log(`   ⊝  ${dateStr}: 無數據`);
                            }

                            totalProcessed++;
                            currentDate.setDate(currentDate.getDate() + 1);
                        }

                    } catch (error) {
                        console.error(`   ❌ 處理門市 ${storeName} 時發生錯誤:`, error);
                        totalErrors++;
                    }
                }

                console.log('\n' + '='.repeat(80));
                console.log('📊 補齊完成統計');
                console.log('='.repeat(80));
                console.log(`✅ 處理天數: ${totalProcessed}`);
                console.log(`💾 保存記錄: ${totalSaved}`);
                console.log(`❌ 錯誤數量: ${totalErrors}`);
                console.log('='.repeat(80) + '\n');

            } catch (error) {
                console.error('❌ 補齊歷史數據失敗:', error);
            }
        };
        
        // 🧪 校正功能測試函數
        window.testCalibration = function(machineId, location, testPlays = 100, testPayouts = 50) {
            console.log(`\n🧪 測試機台校正功能`);
            console.log(`測試機台: ${machineId}/${location}`);
            console.log(`測試數值: 投幣=${testPlays}, 出貨=${testPayouts}`);
            console.log(`${'='.repeat(50)}`);
            
            const result = applyMachineCalibration(machineId, location, testPlays, testPayouts);
            
            console.log(`校正結果:`);
            console.log(`  原始投幣: ${result.rawPlays}`);
            console.log(`  校正投幣: ${result.plays} (校正值: ${result.playsCalibration})`);
            console.log(`  原始出貨: ${result.rawPayouts}`);
            console.log(`  校正出貨: ${result.payouts} (校正值: ${result.payoutsCalibration})`);
            
            return result;
        };
        
        // 🔧 機台數值校正函數 - 自動計算實際填表數值
        function applyMachineCalibration(machineId, location, rawPlays, rawPayouts) {
            console.log(`🔧 開始校正計算 - 機台: ${machineId}/${location}, 原始值: plays=${rawPlays}, payouts=${rawPayouts}`);
            
            // 尋找對應的機台配置
            if (!appData || !appData.machines) {
                console.log(`⚠️ 找不到機台配置資料，使用原始值`);
                return { plays: rawPlays, payouts: rawPayouts };
            }
            
            const machine = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machine) {
                console.log(`⚠️ 找不到機台 ${machineId}/${location} 的配置，使用原始值`);
                return { plays: rawPlays, payouts: rawPayouts };
            }
            
            // 獲取校正值
            const playsCalibration = machine.playsCalibration || 0;
            const payoutsCalibration = machine.payoutsCalibration || 0;
            
            // 計算校正後的數值
            const calibratedPlays = rawPlays + playsCalibration;
            const calibratedPayouts = rawPayouts + payoutsCalibration;
            
            // 確保校正後的值不為負數
            const finalPlays = Math.max(0, calibratedPlays);
            const finalPayouts = Math.max(0, calibratedPayouts);
            
            console.log(`🔧 校正計算完成:`);
            console.log(`   原始投幣: ${rawPlays} + 校正值: ${playsCalibration} = 實際投幣: ${finalPlays}`);
            console.log(`   原始出貨: ${rawPayouts} + 校正值: ${payoutsCalibration} = 實際出貨: ${finalPayouts}`);
            
            // 記錄校正變化
            if (playsCalibration !== 0 || payoutsCalibration !== 0) {
                console.log(`📊 機台 ${machineId}/${location} 已應用校正值`);
            }
            
            return { 
                plays: finalPlays, 
                payouts: finalPayouts,
                playsCalibration: playsCalibration,
                payoutsCalibration: payoutsCalibration,
                rawPlays: rawPlays,
                rawPayouts: rawPayouts
            };
        }

        function updateDailyRecord(machineId, location, plays, payouts, date = null) {
            console.log(`📝 更新輪詢臨時記錄 - 機台: ${machineId}/${location}, plays: ${plays}, payouts: ${payouts}`);

            const rawPlays = plays;
            const rawPayouts = payouts;
            const calibration = applyMachineCalibration(machineId, location, rawPlays, rawPayouts) || {};
            const calibratedPlays = calibration.plays ?? rawPlays;
            const calibratedPayouts = calibration.payouts ?? rawPayouts;
            const playsCalibration = calibration.playsCalibration ?? 0;
            const payoutsCalibration = calibration.payoutsCalibration ?? 0;

            // 初始化輪詢臨時存儲（與正式的 Firebase 記錄分離）
            if (!window.dailyRecords) {
                window.dailyRecords = {};
            }

            // 使用提供的日期或取得今天的日期
            const recordDate = date || new Date().toISOString().split('T')[0];
            const recordKey = `${machineId}_${location}_${recordDate}`;

            // 獲取該機台今天的輪詢記錄
            let todayRecord = window.dailyRecords[recordKey];
            const now = new Date();
            const nowString = now.toLocaleString('zh-TW');
            const nowTimeString = now.toLocaleTimeString('zh-TW');

            if (!todayRecord) {
                // 新建今天的輪詢記錄
                todayRecord = {
                    machineId: machineId,
                    location: location,
                    date: recordDate,
                    plays: calibratedPlays,
                    payouts: calibratedPayouts,
                    rawPlays: rawPlays,
                    rawPayouts: rawPayouts,
                    playsCalibration: playsCalibration,
                    payoutsCalibration: payoutsCalibration,
                    createdAt: nowString,
                    updatedAt: nowString,
                    updateCount: 1,
                    // ✅ 輪詢專用：變更檢測的詳細欄位
                    lastPlays: calibratedPlays,
                    lastPayouts: calibratedPayouts,
                    lastRawPlays: rawPlays,
                    lastRawPayouts: rawPayouts,
                    playsChanged: false,
                    payoutsChanged: false,
                    isPollingRecord: true, // ✅ 標記為輪詢記錄
                    isPersisted: false,     // ✅ 標記為未持久化（尚未寫入 Firebase）
                    history: [{
                        timestamp: nowTimeString,
                        plays: calibratedPlays,
                        payouts: calibratedPayouts,
                        rawPlays: rawPlays,
                        rawPayouts: rawPayouts,
                        playsCalibration: playsCalibration,
                        payoutsCalibration: payoutsCalibration,
                        playsChanged: false,
                        payoutsChanged: false,
                        playsDelta: 0,
                        payoutsDelta: 0
                    }]
                };
                window.dailyRecords[recordKey] = todayRecord;
                console.log(`✅ 新建輪詢臨時記錄 - 機台: ${machineId}/${location}, 日期: ${recordDate}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts}`);
                console.log(`   📌 記錄狀態: isPersisted=false (等待批次更新)`);

                return { status: 'created', record: todayRecord, playsChanged: false, payoutsChanged: false };
            }

            // ✅ 與輪詢記錄比對 - 詳細的變更檢測（使用校正後數值）
            const playsChanged = (todayRecord.plays !== calibratedPlays);
            const payoutsChanged = (todayRecord.payouts !== calibratedPayouts);
            const isChanged = playsChanged || payoutsChanged;

            if (isChanged) {
                // 計算變化量
                const playsDelta = calibratedPlays - todayRecord.plays;
                const payoutsDelta = calibratedPayouts - todayRecord.payouts;

                // 數據有變化，更新輪詢記錄
                console.log(`🔄 輪詢數據有變化 - 機台: ${machineId}/${location}`);
                if (playsChanged) {
                    console.log(`   ⭐ 投幣次數變化: ${todayRecord.plays} → ${calibratedPlays} (增加: +${playsDelta})`);
                }
                if (payoutsChanged) {
                    console.log(`   ⭐ 出貨數量變化: ${todayRecord.payouts} → ${calibratedPayouts} (增加: +${payoutsDelta})`);
                }

                // 保存到歷史記錄（包含詳細的變更信息）
                todayRecord.history.push({
                    timestamp: nowTimeString,
                    plays: calibratedPlays,
                    payouts: calibratedPayouts,
                    rawPlays: rawPlays,
                    rawPayouts: rawPayouts,
                    playsCalibration: playsCalibration,
                    payoutsCalibration: payoutsCalibration,
                    playsChanged: playsChanged,
                    payoutsChanged: payoutsChanged,
                    playsDelta: playsDelta,
                    payoutsDelta: payoutsDelta
                });

                // 更新主記錄
                todayRecord.lastPlays = todayRecord.plays;  // ✅ 保存舊值供後續比對
                todayRecord.lastPayouts = todayRecord.payouts;  // ✅ 保存舊值供後續比對
                todayRecord.lastRawPlays = todayRecord.rawPlays;
                todayRecord.lastRawPayouts = todayRecord.rawPayouts;
                todayRecord.plays = calibratedPlays;
                todayRecord.payouts = calibratedPayouts;
                todayRecord.rawPlays = rawPlays;
                todayRecord.rawPayouts = rawPayouts;
                todayRecord.playsCalibration = playsCalibration;
                todayRecord.payoutsCalibration = payoutsCalibration;
                todayRecord.playsChanged = playsChanged;  // ✅ 標記投幣次數是否變化
                todayRecord.payoutsChanged = payoutsChanged;  // ✅ 標記出貨數量是否變化
                todayRecord.updatedAt = nowString;
                todayRecord.updateCount = (todayRecord.updateCount || 0) + 1;
                todayRecord.isPersisted = false; // ✅ 重置持久化標記（數據已變更，需要重新保存）

                window.dailyRecords[recordKey] = todayRecord;
                console.log(`✅ 已更新輪詢臨時記錄 - 機台: ${machineId}/${location}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts}, 更新次數: ${todayRecord.updateCount}`);
                console.log(`   📊 更新統計: plays變化=${playsChanged}, payouts變化=${payoutsChanged}, 歷史記錄數=${todayRecord.history.length}`);
                console.log(`   📌 記錄狀態: isPersisted=false (等待批次更新)`);

                return { status: 'updated', record: todayRecord, playsChanged, payoutsChanged, playsDelta, payoutsDelta };
            } else {
                // 數據相同，不更新
                console.log(`ℹ️ 輪詢數據未變化 - 機台: ${machineId}/${location}, plays: ${calibratedPlays}, payouts: ${calibratedPayouts} (維持不變)`);
                todayRecord.rawPlays = rawPlays;
                todayRecord.rawPayouts = rawPayouts;
                todayRecord.playsCalibration = playsCalibration;
                todayRecord.payoutsCalibration = payoutsCalibration;
                return { status: 'unchanged', record: todayRecord, playsChanged: false, payoutsChanged: false, playsDelta: 0, payoutsDelta: 0 };
            }
        }
        
        // 🔥 保存每日記錄到 Firebase history 集合
        async function saveDailyRecordToHistory(machineId, location, date, plays, payouts, rawPlays, rawPayouts, playsCalibration, payoutsCalibration) {
            if (!selectedGroupId || !selectedStoreId) {
                console.warn('⚠️ 未選擇門市,無法保存 history');
                return;
            }

            try {
                const storeRef = db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(selectedStoreId);
                const historyRef = storeRef.collection('history');
                
                // 計算新增值 (當日累積 - 前一天累積)
                const prevDateObj = new Date(date);
                prevDateObj.setDate(prevDateObj.getDate() - 1);
                const prevDate = prevDateObj.toISOString().split('T')[0];
                
                // 查詢前一天的記錄
                const prevDayDoc = await historyRef.doc(prevDate).get();
                let newPlays = plays;
                let newPayouts = payouts;
                
                if (prevDayDoc.exists) {
                    const prevData = prevDayDoc.data();
                    const prevTotalPlays = (prevData.totalPlays || 0) + (prevData.newPlays || 0);
                    const prevTotalPayouts = (prevData.totalPayouts || 0) + (prevData.newPayouts || 0);
                    newPlays = Math.max(0, plays - prevTotalPlays);
                    newPayouts = Math.max(0, payouts - prevTotalPayouts);
                }
                
                // 保存或更新當天記錄
                await historyRef.doc(date).set({
                    date: date,
                    machineId: machineId,
                    location: location,
                    newPlays: newPlays,          // 當日新增投幣數
                    newPayouts: newPayouts,      // 當日新增出貨數
                    totalPlays: plays,           // 累積投幣數
                    totalPayouts: payouts,       // 累積出貨數
                    rawPlays: rawPlays,
                    rawPayouts: rawPayouts,
                    playsCalibration: playsCalibration,
                    payoutsCalibration: payoutsCalibration,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log(`💾 已保存到 history: ${date}, 機台: ${machineId}/${location}, newPlays: ${newPlays}, newPayouts: ${newPayouts}`);
            } catch (error) {
                console.error('❌ 保存 history 失敗:', error);
                throw error;
            }
        }
        
        // 構建動態機台配置映射表 {MAC_devid} -> {machineId, location}
        function buildMachineConfigMap(forceRebuild = false) {
            if (window.machineConfigMap && !forceRebuild) {
                return window.machineConfigMap;
            }
            
            window.machineConfigMap = {};
            // 建立 MAC-only 映射作為備用查找
            window.machineConfigMapByMac = {};
            // 建立 devid-only 映射作為備用查找
            window.machineConfigMapByDevid = {};
            
            if (!appData || !appData.machines) {
                console.warn('⚠️ appData.machines 未初始化');
                return window.machineConfigMap;
            }
            
            console.log(`🔍 開始建構機台配置映射表，共 ${appData.machines.length} 台機台`);
            
            // 遍歷所有機台配置
            appData.machines.forEach((machine, index) => {
                console.log(`📋 [${index}] 處理機台:`, {
                    id: machine.id,
                    location: machine.location,
                    mac: machine.mac,
                    devid: machine.devid,
                    hasDevidData: !!machine.devidData,
                    devidDataKeys: machine.devidData ? Object.keys(machine.devidData) : []
                });
                
                // 每個機台可能有 MAC 和 devid 信息
                if (machine.mac && machine.devidData) {
                    // 如果機台有多個 devid（如 devid=1 和 devid=2）
                    Object.keys(machine.devidData).forEach(devid => {
                        const mapKey = `${machine.mac}_${devid}`;
                        
                        // 檢查是否已存在相同的映射
                        if (window.machineConfigMap[mapKey]) {
                            console.warn(`⚠️ 映射衝突: ${mapKey} 已存在，將覆蓋為 ${machine.id}/${machine.location}`);
                        }
                        
                        const machineInfo = {
                            machineId: machine.id,
                            location: machine.location,
                            mac: machine.mac,
                            devid: parseInt(devid)
                        };
                        
                        window.machineConfigMap[mapKey] = machineInfo;
                        console.log(`📌 映射: ${mapKey} -> ${machine.id}/${machine.location}`);
                        
                        // 建立備用映射
                        if (!window.machineConfigMapByMac[machine.mac]) {
                            window.machineConfigMapByMac[machine.mac] = [];
                        }
                        window.machineConfigMapByMac[machine.mac].push(machineInfo);
                        
                        if (!window.machineConfigMapByDevid[devid]) {
                            window.machineConfigMapByDevid[devid] = [];
                        }
                        window.machineConfigMapByDevid[devid].push(machineInfo);
                    });
                } else if (machine.mac && machine.devid) {
                    // 簡單情況：單個 devid
                    const mapKey = `${machine.mac}_${machine.devid}`;
                    
                    // 檢查是否已存在相同的映射
                    if (window.machineConfigMap[mapKey]) {
                        console.warn(`⚠️ 映射衝突: ${mapKey} 已存在，將覆蓋為 ${machine.id}/${machine.location}`);
                    }
                    
                    const machineInfo = {
                        machineId: machine.id,
                        location: machine.location,
                        mac: machine.mac,
                        devid: parseInt(machine.devid)
                    };
                    
                    window.machineConfigMap[mapKey] = machineInfo;
                    console.log(`📌 映射: ${mapKey} -> ${machine.id}/${machine.location}`);
                    
                    // 建立備用映射
                    if (!window.machineConfigMapByMac[machine.mac]) {
                        window.machineConfigMapByMac[machine.mac] = [];
                    }
                    window.machineConfigMapByMac[machine.mac].push(machineInfo);
                    
                    if (!window.machineConfigMapByDevid[machine.devid]) {
                        window.machineConfigMapByDevid[machine.devid] = [];
                    }
                    window.machineConfigMapByDevid[machine.devid].push(machineInfo);
                } else {
                    console.warn(`⚠️ 機台 ${machine.id}/${machine.location} 缺少必要的 MAC 或 devid 資訊`);
                }
            });
            
            console.log(`✅ 已構建機台配置映射表，共 ${Object.keys(window.machineConfigMap).length} 條映射`);
            console.log(`📊 MAC-only 映射: ${Object.keys(window.machineConfigMapByMac).length} 個 MAC`);
            console.log(`📊 DevID-only 映射: ${Object.keys(window.machineConfigMapByDevid).length} 個 DevID`);
            console.log('� 完整映射表:', window.machineConfigMap);
            console.log('🔍 MAC 映射表:', window.machineConfigMapByMac);
            console.log('🔍 DevID 映射表:', window.machineConfigMapByDevid);
            return window.machineConfigMap;
        }

        // 智能機台配置查找函數 - 支援多種查找策略
        function findMachineConfig(mac, devid) {
            console.log(`🔍 智能查找機台配置: MAC=${mac}, DevID=${devid}`);
            
            // 確保映射表已構建
            buildMachineConfigMap();
            
            // 策略1: 直接使用 MAC_devid 查找
            const primaryKey = `${mac}_${devid}`;
            if (window.machineConfigMap[primaryKey]) {
                console.log(`✅ [策略1] 直接查找成功: ${primaryKey} -> ${window.machineConfigMap[primaryKey].machineId}`);
                return window.machineConfigMap[primaryKey];
            }
            
            // 策略2: 如果 MAC 為 null 或 undefined，使用 DevID-only 查找
            if (!mac || mac === 'null' || mac === 'undefined') {
                console.log(`🔄 [策略2] MAC 無效，嘗試 DevID-only 查找: ${devid}`);
                if (window.machineConfigMapByDevid[devid] && window.machineConfigMapByDevid[devid].length > 0) {
                    const config = window.machineConfigMapByDevid[devid][0]; // 取第一個匹配
                    console.log(`✅ [策略2] DevID 查找成功: ${devid} -> ${config.machineId}`);
                    if (window.machineConfigMapByDevid[devid].length > 1) {
                        console.warn(`⚠️ 多個機台使用相同 DevID ${devid}，已選擇第一個: ${config.machineId}`);
                    }
                    return config;
                }
            }
            
            // 策略3: 如果 DevID 無效，使用 MAC-only 查找
            if (!devid || devid === 'null' || devid === 'undefined') {
                console.log(`🔄 [策略3] DevID 無效，嘗試 MAC-only 查找: ${mac}`);
                if (window.machineConfigMapByMac[mac] && window.machineConfigMapByMac[mac].length > 0) {
                    const config = window.machineConfigMapByMac[mac][0]; // 取第一個匹配
                    console.log(`✅ [策略3] MAC 查找成功: ${mac} -> ${config.machineId}`);
                    if (window.machineConfigMapByMac[mac].length > 1) {
                        console.warn(`⚠️ 機台 ${mac} 有多個 DevID，已選擇第一個: ${config.devid}`);
                    }
                    return config;
                }
            }
            
            // 策略4: 嘗試模糊匹配（忽略大小寫、去除空格）
            if (mac && devid) {
                const normalizedMac = mac.toString().trim().toLowerCase();
                const normalizedDevid = devid.toString().trim();
                
                console.log(`🔄 [策略4] 嘗試模糊匹配: ${normalizedMac}_${normalizedDevid}`);
                
                for (const [key, config] of Object.entries(window.machineConfigMap)) {
                    const [keyMac, keyDevid] = key.split('_');
                    if (keyMac && keyDevid && 
                        keyMac.toLowerCase().trim() === normalizedMac && 
                        keyDevid.trim() === normalizedDevid) {
                        console.log(`✅ [策略4] 模糊匹配成功: ${key} -> ${config.machineId}`);
                        return config;
                    }
                }
            }
            
            // 策略5: 去除冒號/連字號後比對 MAC（處理格式差異）
            if (mac && devid) {
                // 去除所有冒號、連字號、空格，轉小寫
                const cleanMac = mac.toString().replace(/[:\-\s]/g, '').toLowerCase();
                const normalizedDevid = devid.toString().trim();
                
                console.log(`🔄 [策略5] 嘗試去除冒號匹配: ${cleanMac}_${normalizedDevid}`);
                
                for (const [key, config] of Object.entries(window.machineConfigMap)) {
                    const [keyMac, keyDevid] = key.split('_');
                    if (keyMac && keyDevid) {
                        // 同樣去除 key 中的冒號/連字號
                        const cleanKeyMac = keyMac.replace(/[:\-\s]/g, '').toLowerCase();
                        if (cleanKeyMac === cleanMac && keyDevid.trim() === normalizedDevid) {
                            console.log(`✅ [策略5] 去除冒號匹配成功: ${key} -> ${config.machineId}`);
                            return config;
                        }
                    }
                }
                
                // 也嘗試在 machineConfigMapByMac 中使用去除冒號後的比對
                for (const [storedMac, configs] of Object.entries(window.machineConfigMapByMac)) {
                    const cleanStoredMac = storedMac.replace(/[:\-\s]/g, '').toLowerCase();
                    if (cleanStoredMac === cleanMac && configs.length > 0) {
                        // 找到 MAC 匹配的，再比對 DevID
                        const matchedConfig = configs.find(c => c.devid.toString() === normalizedDevid);
                        if (matchedConfig) {
                            console.log(`✅ [策略5] MAC去冒號+DevID 匹配成功: ${storedMac} -> ${matchedConfig.machineId}`);
                            return matchedConfig;
                        }
                    }
                }
            }
            
            // 策略6: 最後嘗試 - 列出所有可能的匹配供調試
            console.warn(`❌ 所有策略都失敗，無法找到機台配置`);
            console.log(`🔍 可用的映射鍵:`, Object.keys(window.machineConfigMap));
            console.log(`🔍 可用的 MAC:`, Object.keys(window.machineConfigMapByMac));
            console.log(`🔍 可用的 DevID:`, Object.keys(window.machineConfigMapByDevid));
            console.log(`💡 查找參數: MAC="${mac}" (type: ${typeof mac}), DevID="${devid}" (type: ${typeof devid})`);
            
            return null;
        }

        // 測試智能查找功能
        function testSmartMachineMapping() {
            console.log('\n' + '='.repeat(70));
            console.log('🧪 測試智能機台映射查找功能');
            console.log('='.repeat(70));
            
            // 測試案例
            const testCases = [
                { mac: 'AA:BB:CC:DD:EE:FF', devid: 1, description: '正常查找' },
                { mac: null, devid: 1, description: 'MAC 為 null' },
                { mac: 'null', devid: 1, description: "MAC 為字串 'null'" },
                { mac: 'AA:BB:CC:DD:EE:FF', devid: null, description: 'DevID 為 null' },
                { mac: 'AA:BB:CC:DD:EE:FF', devid: 'null', description: "DevID 為字串 'null'" },
                { mac: null, devid: 2, description: '僅使用 DevID=2 查找' },
                { mac: 'invalid', devid: 999, description: '無效的 MAC 和 DevID' }
            ];
            
            testCases.forEach((testCase, index) => {
                console.log(`\n📋 測試案例 ${index + 1}: ${testCase.description}`);
                console.log(`   輸入: MAC="${testCase.mac}", DevID="${testCase.devid}"`);
                
                const result = findMachineConfig(testCase.mac, testCase.devid);
                if (result) {
                    console.log(`   ✅ 結果: 找到機台 ${result.machineId} (${result.location})`);
                } else {
                    console.log(`   ❌ 結果: 未找到匹配的機台`);
                }
            });
            
            console.log('\n' + '='.repeat(70));
            console.log('🧪 智能映射測試完成');
            console.log('='.repeat(70));
        }
        
        // 將測試函數添加到全域範圍
        window.testSmartMachineMapping = testSmartMachineMapping;
        
        // ✅ 診斷 MAC + DevID 映射關係
        function diagnoseMacDevidMapping() {
            console.log('\n' + '='.repeat(80));
            console.log('🔍 MAC + DevID 映射關係診斷');
            console.log('='.repeat(80));
            
            // 重建映射表
            buildMachineConfigMap();
            
            if (!appData || !appData.machines) {
                console.error('❌ appData.machines 未初始化');
                return;
            }
            
            console.log(`\n📊 機台總數: ${appData.machines.length}`);
            console.log(`📊 映射表記錄數: ${Object.keys(window.machineConfigMap || {}).length}\n`);
            
            // 建立分組統計
            const stats = {
                withMacAndDevid: [],
                withMacOnly: [],
                withDevidOnly: [],
                noMacNoDevid: [],
                duplicateMac: {}
            };
            
            // 分析每台機台
            appData.machines.forEach((machine, index) => {
                const hasMac = machine.mac && machine.mac.trim();
                const hasDevid = machine.devid || (machine.devidData && Object.keys(machine.devidData).length > 0);
                const hasDevidData = machine.devidData && Object.keys(machine.devidData).length > 0;
                
                console.log(`\n📱 機台 [${index + 1}/${appData.machines.length}]`);
                console.log(`   編號: ${machine.id}`);
                console.log(`   位置: ${machine.location}`);
                console.log(`   MAC: ${machine.mac || '❌ 未設定'}`);
                console.log(`   DevID (舊欄位): ${machine.devid || '❌ 未設定'}`);
                console.log(`   devidData (新結構): ${hasDevidData ? JSON.stringify(machine.devidData) : '❌ 未設定'}`);
                
                // 檢查映射表中的記錄
                if (hasMac) {
                    // 檢查 DevID 1 和 2
                    for (let devid = 1; devid <= 2; devid++) {
                        const mapKey = `${machine.mac}_${devid}`;
                        const inMap = window.machineConfigMap[mapKey];
                        
                        if (inMap) {
                            console.log(`   ✅ 映射表存在: ${mapKey} -> ${inMap.machineId}/${inMap.location}`);
                            
                            // 驗證映射是否正確
                            if (inMap.machineId !== machine.id || inMap.location !== machine.location) {
                                console.error(`   ❌❌❌ 映射錯誤！期望 ${machine.id}/${machine.location}，但映射到 ${inMap.machineId}/${inMap.location}`);
                            }
                        } else {
                            console.log(`   ⚠️ 映射表缺失: ${mapKey}`);
                        }
                    }
                    
                    // 檢查重複 MAC
                    if (!stats.duplicateMac[machine.mac]) {
                        stats.duplicateMac[machine.mac] = [];
                    }
                    stats.duplicateMac[machine.mac].push({
                        id: machine.id,
                        location: machine.location,
                        devid: machine.devid,
                        devidData: machine.devidData
                    });
                }
                
                // 分類統計
                if (hasMac && hasDevid) {
                    stats.withMacAndDevid.push(machine);
                } else if (hasMac && !hasDevid) {
                    stats.withMacOnly.push(machine);
                } else if (!hasMac && hasDevid) {
                    stats.withDevidOnly.push(machine);
                } else {
                    stats.noMacNoDevid.push(machine);
                }
            });
            
            // 顯示統計摘要
            console.log('\n' + '='.repeat(80));
            console.log('📊 統計摘要');
            console.log('='.repeat(80));
            console.log(`✅ MAC + DevID 完整: ${stats.withMacAndDevid.length} 台`);
            stats.withMacAndDevid.forEach(m => {
                console.log(`   - ${m.id}/${m.location} (MAC: ${m.mac}, DevID: ${m.devid || 'devidData:' + Object.keys(m.devidData || {}).join(',')})`);
            });
            
            if (stats.withMacOnly.length > 0) {
                console.log(`\n⚠️ 只有 MAC，缺少 DevID: ${stats.withMacOnly.length} 台`);
                stats.withMacOnly.forEach(m => {
                    console.log(`   - ${m.id}/${m.location} (MAC: ${m.mac})`);
                });
            }
            
            if (stats.withDevidOnly.length > 0) {
                console.log(`\n⚠️ 只有 DevID，缺少 MAC: ${stats.withDevidOnly.length} 台`);
                stats.withDevidOnly.forEach(m => {
                    console.log(`   - ${m.id}/${m.location} (DevID: ${m.devid})`);
                });
            }
            
            if (stats.noMacNoDevid.length > 0) {
                console.log(`\n❌ 缺少 MAC 和 DevID: ${stats.noMacNoDevid.length} 台`);
                stats.noMacNoDevid.forEach(m => {
                    console.log(`   - ${m.id}/${m.location}`);
                });
            }
            
            // 檢查重複 MAC
            console.log('\n' + '='.repeat(80));
            console.log('🔍 重複 MAC 檢查');
            console.log('='.repeat(80));
            Object.entries(stats.duplicateMac).forEach(([mac, machines]) => {
                if (machines.length > 1) {
                    console.log(`\n⚠️ MAC ${mac} 被 ${machines.length} 台機台使用:`);
                    machines.forEach(m => {
                        console.log(`   - ${m.id}/${m.location} (DevID: ${m.devid || 'devidData:' + Object.keys(m.devidData || {}).join(',')})`);
                    });
                    console.log(`   💡 這是正常的！一個 MAC 可以有多個 DevID (左右天車)`);
                }
            });
            
            // 驗證映射表完整性
            console.log('\n' + '='.repeat(80));
            console.log('🔍 映射表完整性驗證');
            console.log('='.repeat(80));
            console.log(`📊 映射表總記錄: ${Object.keys(window.machineConfigMap || {}).length}`);
            console.log(`📊 期望記錄數: ${stats.withMacAndDevid.length} (有 MAC + DevID 的機台)`);
            
            // 列出所有映射
            console.log('\n🗺️ 完整映射表:');
            Object.entries(window.machineConfigMap || {}).forEach(([key, config]) => {
                console.log(`   ${key} -> ${config.machineId}/${config.location}`);
            });
            
            console.log('\n' + '='.repeat(80));
            console.log('✅ 診斷完成！');
            console.log('='.repeat(80));
            
            return stats;
        }
        
        // 將診斷函數添加到全域範圍
        window.diagnoseMacDevidMapping = diagnoseMacDevidMapping;
        
        // ✅ 診斷校正值計算問題
        function diagnoseCalibrationIssue(machineId, location) {
            console.log('\n' + '='.repeat(80));
            console.log('🔧 診斷校正值計算問題');
            console.log('='.repeat(80));
            
            if (!appData || !appData.machines) {
                console.error('❌ appData.machines 未初始化');
                return;
            }
            
            // 查找機台配置
            const machine = appData.machines.find(m => 
                m.id === machineId && m.location === location
            );
            
            if (!machine) {
                console.error(`❌ 找不到機台: ${machineId}/${location}`);
                console.log('📋 可用機台:');
                appData.machines.forEach(m => {
                    console.log(`   - ${m.id}/${m.location}`);
                });
                return;
            }
            
            console.log(`\n📱 機台資訊: ${machine.id}/${machine.location}`);
            console.log(`   MAC: ${machine.mac || '❌ 未設定'}`);
            console.log(`   DevID: ${machine.devid || '❌ 未設定'}`);
            console.log(`   devidData: ${JSON.stringify(machine.devidData || {})}`);
            
            console.log(`\n🔧 校正值設定:`);
            console.log(`   投幣校正值: ${machine.playsCalibration || 0}`);
            console.log(`   出貨校正值: ${machine.payoutsCalibration || 0}`);
            
            // 檢查輪詢臨時記錄
            console.log(`\n📊 輪詢臨時記錄:`);
            if (window.dailyRecords) {
                const recordKey = `${machineId}_${location}_${new Date().toISOString().split('T')[0]}`;
                const record = window.dailyRecords[recordKey];
                
                if (record) {
                    console.log(`   ✅ 找到記錄: ${recordKey}`);
                    console.log(`   原始值: plays=${record.rawPlays}, payouts=${record.rawPayouts}`);
                    console.log(`   校正後: plays=${record.plays}, payouts=${record.payouts}`);
                    console.log(`   校正值: playsCalibration=${record.playsCalibration}, payoutsCalibration=${record.payoutsCalibration}`);
                } else {
                    console.log(`   ⚠️ 沒有找到記錄: ${recordKey}`);
                    console.log(`   📋 可用記錄:`, Object.keys(window.dailyRecords));
                }
            } else {
                console.log(`   ❌ window.dailyRecords 未初始化`);
            }
            
            // 檢查 DevID 數據
            console.log(`\n🔍 DevID 數據檢查:`);
            if (window.machineDataByDevid) {
                Object.keys(window.machineDataByDevid).forEach(devid => {
                    const data = window.machineDataByDevid[devid];
                    console.log(`   DevID ${devid}: plays=${data.plays}, payouts=${data.payouts}`);
                });
            } else {
                console.log(`   ❌ window.machineDataByDevid 未初始化`);
            }
            
            // 測試校正值計算
            console.log(`\n🧪 測試校正值計算:`);
            const testRawPlays = 118;
            const testRawPayouts = 4;
            const testResult = applyMachineCalibration(machineId, location, testRawPlays, testRawPayouts);
            
            console.log(`   輸入: plays=${testRawPlays}, payouts=${testRawPayouts}`);
            console.log(`   結果: plays=${testResult.plays}, payouts=${testResult.payouts}`);
            console.log(`   校正值: playsCalibration=${testResult.playsCalibration}, payoutsCalibration=${testResult.payoutsCalibration}`);
            
            console.log('\n' + '='.repeat(80));
            console.log('✅ 診斷完成！');
            console.log('='.repeat(80));
        }
        
        // 將診斷函數添加到全域範圍
        window.diagnoseCalibrationIssue = diagnoseCalibrationIssue;
        
        // 新增：調試機台輪詢狀態函數
        // 機台連線診斷函數
        function debugMachineConnectivity() {
            console.log('\n🔍 機台連線狀態診斷');
            console.log('══════════════════════════════════════════════════════════════');
            
            const machinesWithMac = availableMachines.filter(m => m.mac && m.mac.trim() !== '');
            const failedMachines = [];
            const successfulMachines = [];
            
            machinesWithMac.forEach(machine => {
                // 檢查最近輪詢結果
                const hasRecentData = tempPollingData.some(record => 
                    record.machineId === machine.id && 
                    new Date(record.date).toDateString() === new Date().toDateString()
                );
                
                if (hasRecentData) {
                    successfulMachines.push(machine);
                } else {
                    failedMachines.push(machine);
                }
                
                console.log(`📱 機台 ${machine.id} (MAC: ${machine.mac})`);
                console.log(`   📊 最近輪詢: ${hasRecentData ? '✅ 成功' : '❌ 失敗'}`);
                console.log(`   🔗 測試 URL: http://update.feiloli.com.tw:5539/textselectdata/${machine.mac}`);
                console.log(`   🛠️ 建議動作: ${hasRecentData ? '無需動作' : '檢查機台網路連線與伺服器狀態'}`);
                console.log('');
            });
            
            console.log('📊 連線統計摘要:');
            console.log(`   ✅ 成功機台: ${successfulMachines.length} 台`);
            successfulMachines.forEach(m => console.log(`      - ${m.id} (${m.mac})`));
            console.log(`   ❌ 失敗機台: ${failedMachines.length} 台`);
            failedMachines.forEach(m => console.log(`      - ${m.id} (${m.mac})`));
            console.log(`   📈 成功率: ${Math.round((successfulMachines.length / machinesWithMac.length) * 100)}%`);
            
            if (failedMachines.length > 0) {
                console.log('\n🔧 故障排除建議:');
                console.log('1. 檢查失敗機台的網路連線');
                console.log('2. 確認機台是否正常開機運行');
                console.log('3. 檢查 update.feiloli.com.tw:5539 伺服器狀態');
                console.log('4. 手動測試機台 URL 是否可訪問');
                console.log('5. 檢查防火牆設置是否阻擋連線');
            }
            
            console.log('══════════════════════════════════════════════════════════════\n');
        }

        function debugMachinePollingStatus() {
            console.log('\n' + '='.repeat(70));
            console.log('🔍 調試機台輪詢狀態');
            console.log('='.repeat(70));
            
            if (!appData || !appData.machines) {
                console.warn('⚠️ appData.machines 未初始化');
                return;
            }
            
            const allMachines = appData.machines;
            const machinesWithMac = allMachines.filter(m => m.mac && m.mac.trim());
            
            console.log(`📊 總機台數: ${allMachines.length}`);
            console.log(`📊 有 MAC 的機台數: ${machinesWithMac.length}`);
            console.log(`📊 無 MAC 的機台數: ${allMachines.length - machinesWithMac.length}`);
            
            console.log('\n📋 所有機台詳細狀態:');
            allMachines.forEach((machine, index) => {
                const hasMac = machine.mac && machine.mac.trim();
                const devid = machine.devid || 1;
                const mapKey = hasMac ? `${machine.mac}_${devid}` : 'N/A';
                const hasMapping = hasMac ? !!window.machineConfigMap[mapKey] : false;
                
                console.log(`   ${index + 1}. ${machine.id}/${machine.location}:`);
                console.log(`      MAC: ${machine.mac || 'N/A'} ${hasMac ? '✅' : '❌'}`);
                console.log(`      DevID: ${devid}`);
                console.log(`      映射鍵: ${mapKey}`);
                console.log(`      映射存在: ${hasMapping ? '✅' : '❌'}`);
                console.log(`      可輪詢: ${hasMac ? '✅' : '❌'}`);
            });
            
            console.log('\n🎯 無法輪詢的機台:');
            const unpollableMachines = allMachines.filter(m => !m.mac || !m.mac.trim());
            if (unpollableMachines.length === 0) {
                console.log('   ✅ 所有機台都可以輪詢');
            } else {
                unpollableMachines.forEach((machine, index) => {
                    console.log(`   ${index + 1}. ${machine.id}/${machine.location} - 原因: 缺少 MAC 地址`);
                });
            }
            
            console.log('\n' + '='.repeat(70));
            console.log('🔍 調試完成');
            console.log('='.repeat(70));
        }
        
        // 將調試函數添加到全域範圍
        window.debugMachinePollingStatus = debugMachinePollingStatus;
        window.debugMachineConnectivity = debugMachineConnectivity;
        
        // 查看代理成功率統計
        window.showProxyStats = function() {
            console.log('\n📊 代理服務成功率統計');
            console.log('═══════════════════════════════════════════════════════════════');
            
            if (Object.keys(proxySuccessStats).length === 0) {
                console.log('📝 尚無統計資料');
                return;
            }
            
            // 按機台分組統計
            const machineStats = {};
            Object.entries(proxySuccessStats).forEach(([key, stats]) => {
                const [mac, proxyName] = key.split('_');
                if (!machineStats[mac]) machineStats[mac] = {};
                machineStats[mac][proxyName] = {
                    rate: Math.round((stats.success / stats.total) * 100),
                    attempts: stats.total,
                    lastUsed: new Date(stats.lastUsed).toLocaleString()
                };
            });
            
            Object.entries(machineStats).forEach(([mac, proxies]) => {
                console.log(`\n🖥️ 機台 ${mac}:`);
                const sortedProxies = Object.entries(proxies)
                    .sort(([,a], [,b]) => b.rate - a.rate);
                
                sortedProxies.forEach(([proxyName, stats]) => {
                    const emoji = stats.rate >= 80 ? '🟢' : stats.rate >= 50 ? '🟡' : '🔴';
                    console.log(`   ${emoji} ${proxyName}: ${stats.rate}% (${stats.attempts} 次嘗試)`);
                });
            });
            
            console.log('\n📈 總體代理排名:');
            const globalStats = {};
            Object.entries(proxySuccessStats).forEach(([key, stats]) => {
                const proxyName = key.split('_')[1];
                if (!globalStats[proxyName]) {
                    globalStats[proxyName] = { success: 0, total: 0 };
                }
                globalStats[proxyName].success += stats.success;
                globalStats[proxyName].total += stats.total;
            });
            
            Object.entries(globalStats)
                .map(([name, stats]) => ({
                    name,
                    rate: (stats.success / stats.total) * 100,
                    total: stats.total
                }))
                .sort((a, b) => b.rate - a.rate)
                .forEach((proxy, index) => {
                    const emoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '📊';
                    console.log(`   ${emoji} ${proxy.name}: ${Math.round(proxy.rate)}% (${proxy.total} 次)`);
                });
            
            console.log('═══════════════════════════════════════════════════════════════\n');
        };
        
        // 手動測試單一機台連線
        window.testMachineConnection = async function(macAddress) {
            if (!macAddress) {
                console.log('使用方法: testMachineConnection("MAC地址")');
                console.log('例如: testMachineConnection("48E729540E3D")');
                return;
            }
            
            console.log(`\n🔍 測試機台連線: ${macAddress}`);
            console.log('────────────────────────────────────────');
            
            const testUrl = `http://update.feiloli.com.tw:5539/textselectdata/${macAddress}`;
            console.log(`📡 目標 URL: ${testUrl}`);
            
            try {
                console.log('⏳ 開始測試...');
                const result = await sendHttpRequest(testUrl, 10000, macAddress, 1);
                
                if (result && Array.isArray(result) && result.length > 0) {
                    console.log('✅ 連線測試成功!');
                    console.log(`📊 回應數據: ${result.length} 筆記錄`);
                    console.log('📋 最新記錄預覽:', result.slice(0, 3));
                } else {
                    console.log('⚠️ 連線成功但無有效數據');
                }
            } catch (error) {
                console.log('❌ 連線測試失敗:', error.message);
                console.log('🔧 建議檢查:');
                console.log('   1. 機台是否在線');
                console.log('   2. MAC 地址是否正確');
                console.log('   3. 網路連線是否正常');
            }
            
            console.log('────────────────────────────────────────\n');
        };

        // 調試機台映射表函數
        function debugMachineMapping() {
            console.log('🔍 ===== 機台映射調試資訊 =====');
            
            // 1. 顯示原始機台資料
            if (appData && appData.machines) {
                console.log(`📋 共有 ${appData.machines.length} 台機台:`);
                appData.machines.forEach((machine, index) => {
                    console.log(`[${index}] ${machine.id}/${machine.location}:`, {
                        docId: machine.docId,
                        mac: machine.mac,
                        devid: machine.devid,
                        hasDevidData: !!machine.devidData,
                        devidDataKeys: machine.devidData ? Object.keys(machine.devidData) : []
                    });
                });
            } else {
                console.warn('⚠️ appData.machines 未初始化');
            }
            
            // 2. 重建並顯示映射表
            window.machineConfigMap = null; // 強制重建
            buildMachineConfigMap();
            
            // 3. 顯示輪詢資料狀態
            if (window.dailyRecords) {
                const recordCount = Object.keys(window.dailyRecords).length;
                console.log(`📊 輪詢記錄數量: ${recordCount}`);
                Object.entries(window.dailyRecords).forEach(([key, record]) => {
                    console.log(`記錄: ${key} -> ${record.machineId}/${record.location} (投幣: ${record.plays}, 出貨: ${record.payouts})`);
                });
            } else {
                console.log('📊 輪詢記錄: 無');
            }
            
            // 4. 檢查映射缺失
            const allDevids = new Set();
            if (appData && appData.machines) {
                appData.machines.forEach(machine => {
                    if (machine.mac) {
                        if (machine.devidData) {
                            Object.keys(machine.devidData).forEach(devid => {
                                allDevids.add(`${machine.mac}_${devid}`);
                            });
                        } else if (machine.devid) {
                            allDevids.add(`${machine.mac}_${machine.devid}`);
                        }
                    }
                });
            }
            
            console.log(`🔍 預期的映射數量: ${allDevids.size}`);
            console.log(`🔍 實際的映射數量: ${window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0}`);
            
            if (allDevids.size !== (window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0)) {
                console.warn('⚠️ 映射數量不符！可能有配置問題');
            }
            
            // 5. 顯示摘要
            alert(`調試完成！\n機台數量: ${appData?.machines?.length || 0}\n映射數量: ${window.machineConfigMap ? Object.keys(window.machineConfigMap).length : 0}\n輪詢記錄: ${window.dailyRecords ? Object.keys(window.dailyRecords).length : 0}\n\n詳細資訊請查看控制台輸出`);
        }
        
        // 刷新自動記帳表格 - 增強版本，顯示詳細的變更信息
        function refreshAutoRecordTable() {
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.warn('⚠️ 找不到自動記帳表格');
                return;
            }
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 檢查是否有記錄
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">暫無記錄</td></tr>';
                return;
            }
            
            // 🔧 過濾只顯示當前門市的記錄
            // 取得當前門市的所有機台 ID
            const currentMachineIds = new Set();
            if (appData && appData.machines) {
                appData.machines.forEach(machine => {
                    if (machine.id) {
                        currentMachineIds.add(machine.id);
                    }
                });
            }
            
            console.log(`🔍 當前門市機台: ${Array.from(currentMachineIds).join(', ')}`);
            
            // 過濾出當前門市的記錄（只顯示未持久化的輪詢記錄）
            const currentStoreRecords = Object.values(window.dailyRecords)
                .filter(record => 
                    currentMachineIds.has(record.machineId) &&
                    record.isPollingRecord === true &&
                    record.isPersisted !== true  // ✅ 排除已持久化的記錄
                );
            
            console.log(`📊 全部記錄: ${Object.keys(window.dailyRecords).length} 筆`);
            console.log(`📊 當前門市未持久化記錄: ${currentStoreRecords.length} 筆`);
            
            if (currentStoreRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">此門市暫無記錄</td></tr>';
                return;
            }
            
            // 按日期排序記錄
            const sortedRecords = currentStoreRecords.sort((a, b) => {
                    // 先按日期降序（新的在前）
                    const dateCompare = new Date(b.date) - new Date(a.date);
                    if (dateCompare !== 0) return dateCompare;
                    // 相同日期按機台編號和位置排序
                    if (a.machineId !== b.machineId) {
                        return a.machineId.localeCompare(b.machineId);
                    }
                    return a.location.localeCompare(b.location);
                });
            
            // 填充表格
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // ✅ 新增：變更狀態指示
                let changeIndicator = '';
                if (record.updateCount > 1) {
                    // 根據是否投幣次數或出貨數量有變化來顯示不同的指示符
                    const playsStatus = record.playsChanged ? '💰' : '';
                    const payoutsStatus = record.payoutsChanged ? '�' : '';
                    changeIndicator = `🔄 ${playsStatus}${payoutsStatus}`;
                } else {
                    changeIndicator = '✨';
                }
                
                const machineLabel = `${record.machineId} / ${record.location}`;
                
                // ✅ 新增：變更值顯示（如果有變化）
                let changeInfo = '';
                if (record.history && record.history.length > 1) {
                    // 獲取最後一次變化的記錄（最新的更新）
                    const lastHistory = record.history[record.history.length - 1];
                    const prevHistory = record.history[record.history.length - 2];
                    
                    changeInfo = '<br/><small style="color: #9ca3af; font-size: 0.75rem;">';
                    if (lastHistory.playsChanged && lastHistory.playsDelta !== undefined) {
                        changeInfo += `💰 投幣: +${lastHistory.playsDelta} `;
                    }
                    if (lastHistory.payoutsChanged && lastHistory.payoutsDelta !== undefined) {
                        changeInfo += `📦 出貨: +${lastHistory.payoutsDelta}`;
                    }
                    changeInfo += '</small>';
                }
                
                // 📊 輪詢表格只顯示原始值,不套用校正
                // 校正值僅在儲存到 Firebase 時使用
                const playsDisplay = `${record.plays.toLocaleString()}`;
                const payoutsDisplay = `${record.payouts.toLocaleString()}`;
                
                // 如果有設定校正值,在 Console 中記錄提示
                const machine = appData?.machines?.find(m => m.id === record.machineId && m.location === record.location);
                if (machine && (machine.playsCalibration || machine.payoutsCalibration)) {
                    console.log(`📊 機台 ${record.machineId}/${record.location} 有校正值設定: plays=${machine.playsCalibration}, payouts=${machine.payoutsCalibration} (輪詢表格顯示原始值)`);
                }
                
                row.innerHTML = `
                    <td class="p-4">${record.date}</td>
                    <td class="p-4 font-semibold text-blue-400">${machineLabel}</td>
                    <td class="p-4 text-right font-semibold text-blue-300">${playsDisplay}</td>
                    <td class="p-4 text-right font-semibold text-green-300">${payoutsDisplay}</td>
                    <td class="p-4 text-center">${changeIndicator} ${record.updateCount}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.updatedAt}${changeInfo}</td>
                    <td class="p-4 text-center text-xs text-gray-400">${record.createdAt}</td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log(`✅ 已刷新自動記帳表格，共 ${sortedRecords.length} 筆記錄`);
        }
        
        // 建立 devid 與機台的映射關係
        function buildDevidMachineMap() {
            if (!window.devidMachineMap) {
                window.devidMachineMap = {
                    1: { label: '左天車', machineId: 'A001', location: '上1' },
                    2: { label: '右天車', machineId: 'A001', location: '上2' }
                };
            }
            return window.devidMachineMap;
        }
        
        // 從輪詢帶入數據到表單
        function importFromPoll() {
            console.log('📥 從輪詢帶入數據...');
            
            // 檢查是否有輪詢數據
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('❌ 暫無輪詢數據，請先進行輪詢');
                return;
            }
            
            // 建構動態機台映射
            buildMachineConfigMap();
            
            // ✅ 修正：不強制使用今天的日期，而是查找所有可用的輪詢記錄
            console.log(`📊 找到 ${Object.keys(window.dailyRecords).length} 筆輪詢記錄`);
            
            // 查找第一個可用的記錄（不限制日期）
            let selectedRecord = null;
            let selectedMachine = null;
            
            if (appData && appData.machines) {
                for (let [recordKey, record] of Object.entries(window.dailyRecords)) {
                    // 從 recordKey 解析機台信息 (格式: machineId_location_date)
                    const parts = recordKey.split('_');
                    const recordDate = parts.pop(); // 取得日期
                    const recordLocation = parts.pop(); // 取得位置
                    const recordMachineId = parts.join('_'); // 剩下的就是機台ID
                    
                    // 找到對應的機台
                    const machine = appData.machines.find(m => 
                        m.id === recordMachineId && m.location === recordLocation
                    );
                    
                    if (machine) {
                        selectedRecord = record;
                        selectedMachine = machine;
                        console.log(`✅ 找到輪詢記錄: ${recordKey} (日期: ${recordDate})`, selectedRecord);
                        break;
                    }
                }
            }
            
            if (!selectedRecord || !selectedMachine) {
                alert('❌ 找不到可用的輪詢記錄');
                return;
            }
            
            // 填入表單
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            
            // 填入日期（使用輪詢記錄的實際日期）
            if (entryDate) {
                entryDate.value = selectedRecord.date;
            }
            
            // 🔧 應用校正值並填入投幣數和出獎數
            const calibratedData = applyMachineCalibration(selectedRecord.machineId, selectedRecord.location, selectedRecord.plays, selectedRecord.payouts);
            
            if (cumulativePlays) {
                cumulativePlays.value = calibratedData.plays;
                console.log(`🔧 投幣數值: 原始=${selectedRecord.plays} → 校正後=${calibratedData.plays} (校正值: ${calibratedData.playsCalibration})`);
            }
            if (cumulativePayouts) {
                cumulativePayouts.value = calibratedData.payouts;
                console.log(`🔧 出貨數值: 原始=${selectedRecord.payouts} → 校正後=${calibratedData.payouts} (校正值: ${calibratedData.payoutsCalibration})`);
            }
            
            // 選擇機台（使用 docId）
            if (machineSelector && selectedMachine) {
                machineSelector.value = selectedMachine.docId;
                console.log(`✅ 已選擇機台: ${selectedMachine.id}/${selectedMachine.location} (docId: ${selectedMachine.docId})`);
            }
            
            console.log(`✅ 已帶入輪詢數據: ${selectedRecord.machineId}/${selectedRecord.location}, 日期=${selectedRecord.date}, plays=${selectedRecord.plays}, payouts=${selectedRecord.payouts}`);
            
            // 觸發表單提交（使用輪詢記錄的實際日期）
            const dailyEntryForm = document.getElementById('daily-entry-form');
            if (dailyEntryForm) {
                dailyEntryForm.dispatchEvent(new Event('submit'));
                console.log('📝 已觸發表單提交');
            }
        }
        
        // 批量新增所有機台記錄 - 無限制版本，支持大量數據處理
        async function batchAddAllMachines() {
            console.log('✅ 批量新增所有機台記錄 (無限制版本)...');
            
            // 檢查是否有輪詢數據
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                alert('❌ 暫無輪詢數據，請先進行輪詢');
                return;
            }
            
            // 檢查 appData 和 machines
            if (!appData || !appData.machines || appData.machines.length === 0) {
                alert('❌ 沒有可用的機台列表');
                return;
            }
            
            const machineSelector = document.getElementById('machine-selector');
            const dailyEntryForm = document.getElementById('daily-entry-form');
            
            if (!dailyEntryForm) {
                alert('❌ 找不到表單');
                return;
            }
            
            // 建構動態機台映射
            buildMachineConfigMap();
            
            // 🚀 無限制處理所有輪詢記錄
            const allRecords = Object.entries(window.dailyRecords);
            const totalRecords = allRecords.length;
            
            console.log(`📊 準備處理 ${totalRecords} 筆輪詢記錄 (無數量限制)`);
            
            let newCount = 0;      // ✅ 新增的機台記錄數
            let updateCount = 0;   // ✅ 更新的機台記錄數
            let unchangedCount = 0; // ✅ 沒有變化的機台記錄數
            let failedCount = 0;
            
            // 統計信息
            const summaryInfo = {
                new: [],      // 新增的機台
                updated: [],  // 更新的機台（有變化）
                unchanged: [] // 沒有變化的機台
            };
            
            // 🔄 分批處理，避免一次性處理太多造成效能問題
            const batchSize = window.batchProcessingSize || 50; // 可自定義批次大小
            let processedCount = 0;
            
            // 🚀 分批處理所有輪詢記錄（無數量限制）
            for (let i = 0; i < allRecords.length; i += batchSize) {
                const batch = allRecords.slice(i, i + batchSize);
                const batchNumber = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(allRecords.length / batchSize);
                
                console.log(`🔄 處理第 ${batchNumber}/${totalBatches} 批，共 ${batch.length} 筆記錄`);
                
                for (let [recordKey, record] of batch) {
                    try {
                        // ✅ 檢查是否已持久化，跳過已處理的記錄
                        if (record.isPersisted === true) {
                            console.log(`⏭️  [跳過] ${recordKey} - 已持久化的記錄，不重複處理`);
                            unchangedCount++;
                            processedCount++;
                            continue;
                        }
                        
                        processedCount++;
                        console.log(`🔄 [${processedCount}/${totalRecords}] 處理輪詢記錄: ${recordKey}`);
                        console.log(`📊 輪詢記錄詳情:`, {
                            machineId: record.machineId,
                            location: record.location,
                            plays: record.plays,
                            payouts: record.payouts,
                            rawPlays: record.rawPlays,
                            rawPayouts: record.rawPayouts,
                            updateCount: record.updateCount,
                            lastPlays: record.lastPlays,
                            lastPayouts: record.lastPayouts
                        });
                        
                        // 找到對應的機台
                        const machine = appData.machines.find(m => 
                            m.id === record.machineId && m.location === record.location
                        );
                        
                        if (!machine) {
                            console.warn(`⚠️ 找不到對應機台: ${record.machineId}/${record.location}`);
                            failedCount++;
                            continue;
                        }
                        
                        console.log(`✅ 找到機台: ${machine.id}/${machine.location} (日期: ${record.date})`);
                        
                        // 驗證選擇器中是否存在此機台
                        const options = Array.from(machineSelector.options);
                        const hasOption = options.some(opt => opt.value === machine.docId);
                        
                        if (!hasOption) {
                            console.warn(`⚠️ 機台選擇器中找不到 docId=${machine.docId}，跳過`);
                            failedCount++;
                            continue;
                        }
                        
                        // 選擇機台（使用 docId）
                        machineSelector.value = machine.docId;
                        
                        // 觸發 change 事件以自動填入投幣數和出獎數
                        machineSelector.dispatchEvent(new Event('change', { bubbles: true }));
                        
                        console.log(`✅ 已設置選擇器: docId=${machine.docId}, value=${machineSelector.value}`);
                        
                        // 驗證選擇是否成功
                        if (machineSelector.value !== machine.docId) {
                            console.error(`❌ 設置選擇器失敗: 期望=${machine.docId}, 實際=${machineSelector.value}`);
                            failedCount++;
                            continue;
                        }
                        
                        // ✅ 填入表單數據
                        const entryDate = document.getElementById('entry-date');
                        const cumulativePlays = document.getElementById('cumulative-plays');
                        const cumulativePayouts = document.getElementById('cumulative-payouts');
                        
                        // 設置輪詢記錄的實際日期（重要：不強制使用今天）
                        if (entryDate) {
                            entryDate.value = record.date;
                        }
                        
                        // 設置累積數值
                        if (cumulativePlays) {
                            cumulativePlays.value = record.plays;
                        }
                        if (cumulativePayouts) {
                            cumulativePayouts.value = record.payouts;
                        }
                        
                        console.log(`📋 表單已填入 (使用記錄日期):`, {
                            date: entryDate.value,
                            machineDocId: machineSelector.value,
                            plays: cumulativePlays.value,
                            payouts: cumulativePayouts.value,
                            recordDate: record.date // 顯示使用的是記錄的日期
                        });
                        
                        // 🔧 釐清數值含義，確保數據類型正確
                        const currentMachinePlays = parseInt(machine.plays) || 0;     // 資料庫中目前的累積值
                        const currentMachinePayouts = parseInt(machine.payouts) || 0; // 資料庫中目前的累積值
                        
                        // 🔧 重新從最新的輪詢記錄中獲取數值
                        const latestRecord = window.dailyRecords[recordKey];
                        
                        // ✅ 關鍵修復：record.plays 和 record.payouts 已經是校正後的值
                        // 不需要再次應用校正，避免雙重校正問題
                        const polledPlays = parseInt(latestRecord?.plays || record.plays);      // 已校正的累積值
                        const polledPayouts = parseInt(latestRecord?.payouts || record.payouts); // 已校正的累積值
                        
                        console.log(`✅ 使用已校正的輪詢值 (避免雙重校正):`, {
                            machineId: `${machine.id}/${machine.location}`,
                            已校正投幣: polledPlays,
                            已校正出貨: polledPayouts,
                            原始值: { rawPlays: record.rawPlays, rawPayouts: record.rawPayouts },
                            校正量: { playsCalibration: record.playsCalibration, payoutsCalibration: record.payoutsCalibration }
                        });
                        

                        
                        console.log(`🔄 數值確認:`, {
                            machineId: `${machine.id}/${machine.location}`,
                            currentMachinePlays: currentMachinePlays,
                            currentMachinePayouts: currentMachinePayouts,
                            polledPlays: polledPlays,
                            polledPayouts: polledPayouts,
                            shouldUpdate: polledPlays > currentMachinePlays || polledPayouts > currentMachinePayouts
                        });
                        
                        // 🔧 決定正確的更新方向：輪詢值應該 >= 資料庫值
                        const beforePlays = currentMachinePlays;
                        const afterPlays = Math.max(currentMachinePlays, polledPlays); // 取較大值
                        const beforePayouts = currentMachinePayouts;
                        const afterPayouts = Math.max(currentMachinePayouts, polledPayouts); // 取較大值
                        
                        console.log(`🔧 更新計算詳情:`, {
                            machineId: `${machine.id}/${machine.location}`,
                            '資料庫值': { plays: currentMachinePlays, payouts: currentMachinePayouts },
                            '輪詢值': { plays: polledPlays, payouts: polledPayouts },
                            '計算前': { plays: `max(${currentMachinePlays}, ${polledPlays})`, payouts: `max(${currentMachinePayouts}, ${polledPayouts})` },
                            '計算後': { plays: afterPlays, payouts: afterPayouts },
                            '有變化': { plays: afterPlays !== beforePlays, payouts: afterPayouts !== beforePayouts }
                        });
                        
                        // ✅ 根據是否有變化來決定操作類型
                        if (record.updateCount > 1) {
                            console.log(`🔄 檢測到變化 - 投幣數變化: ${record.playsChanged}, 出貨數量變化: ${record.payoutsChanged}`);
                            updateCount++;
                            summaryInfo.updated.push({
                                id: machine.id,
                                location: machine.location,
                                date: record.date,
                                beforePlays: beforePlays,
                                afterPlays: afterPlays,
                                beforePayouts: beforePayouts,
                                afterPayouts: afterPayouts,
                                playsChanged: record.playsChanged,
                                payoutsChanged: record.payoutsChanged,
                                playsChange: afterPlays - beforePlays,
                                payoutsChange: afterPayouts - beforePayouts
                            });
                        } else {
                            console.log(`✨ 新增記錄 - 機台: ${machine.id}/${machine.location}, 日期: ${record.date}`);
                            newCount++;
                            summaryInfo.new.push({
                                id: machine.id,
                                location: machine.location,
                                date: record.date,
                                beforePlays: beforePlays,
                                afterPlays: afterPlays,
                                beforePayouts: beforePayouts,
                                afterPayouts: afterPayouts,
                                playsChange: afterPlays - beforePlays,
                                payoutsChange: afterPayouts - beforePayouts
                            });
                        }
                        
                        // 直接執行資料庫操作（不使用表單提交）
                        try {
                            console.log(`🔍 檢查環境變數:`, {
                                selectedGroupId,
                                selectedStoreId,
                                machineDocId: machine.docId,
                                recordKey,
                                recordDate: record.date
                            });
                            
                            if (!selectedStoreId) {
                                throw new Error('未選擇門市');
                            }
                            
                            if (!selectedGroupId) {
                                throw new Error('未選擇群組');
                            }
                            
                            // 計算基準值和日增量
                            console.log(`🔢 機台原始數據:`, {
                                machineId: `${machine.id}/${machine.location}`,
                                machinePlays: machine.plays,
                                machinePayouts: machine.payouts,
                                machineInitialPlays: machine.initialPlays,
                                machineInitialPayouts: machine.initialPayouts
                            });
                            
                            const lastRecordedPlays = normalizeCount(machine.plays);
                            const lastRecordedPayouts = normalizeCount(machine.payouts);
                            const initialPlays = normalizeCount(machine.initialPlays);
                            const initialPayouts = normalizeCount(machine.initialPayouts);
                            const baselinePlays = Math.max(lastRecordedPlays, initialPlays);
                            const baselinePayouts = Math.max(lastRecordedPayouts, initialPayouts);
                            
                            // 使用更新後的數值進行資料庫操作
                            const cumulativePlaysInput = afterPlays;
                            const cumulativePayoutsInput = afterPayouts;
                            
                            if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                                throw new Error(`輪詢數據格式錯誤: plays=${record.plays}, payouts=${record.payouts}`);
                            }
                            
                            if (cumulativePlaysInput < baselinePlays || cumulativePayoutsInput < baselinePayouts) {
                                const errorMsg = `累積數值不可小於基準值 - 機台:${machine.id}/${machine.location}, 輪詢值:(${cumulativePlaysInput}, ${cumulativePayoutsInput}), 基準值:(${baselinePlays}, ${baselinePayouts})`;
                                console.error('❌ 數據驗證失敗:', errorMsg);
                                throw new Error(errorMsg);
                            }
                            
                            const dailyPlays = cumulativePlaysInput - baselinePlays;
                            const dailyPayouts = cumulativePayoutsInput - baselinePayouts;
                            
                            console.log(`📊 數據計算結果:`, {
                                machineId: `${machine.id}/${machine.location}`,
                                lastRecordedPlays,
                                lastRecordedPayouts,
                                initialPlays,
                                initialPayouts,
                                baselinePlays,
                                baselinePayouts,
                                cumulativePlaysInput,
                                cumulativePayoutsInput,
                                dailyPlays,
                                dailyPayouts
                            });
                            
                            // 如果沒有變化，跳過處理
                            if (dailyPlays === 0 && dailyPayouts === 0) {
                                console.log(`⏭️ 數據未變更，跳過: ${machine.id}/${machine.location}`);
                                unchangedCount++;
                                summaryInfo.unchanged.push({
                                    id: machine.id,
                                    location: machine.location,
                                    date: record.date,
                                    beforePlays: beforePlays,
                                    afterPlays: afterPlays,
                                    beforePayouts: beforePayouts,
                                    afterPayouts: afterPayouts,
                                    playsChange: 0,
                                    payoutsChange: 0
                                });
                            } else {
                                // 更新機台累積數據
                                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machine.docId);
                                console.log(`🔗 準備更新機台數據:`, {
                                    selectedGroupId,
                                    selectedStoreId,
                                    machineDocId: machine.docId,
                                    plays: cumulativePlaysInput,
                                    payouts: cumulativePayoutsInput
                                });
                                
                                const updateResult = await machineRef.update({
                                    plays: cumulativePlaysInput,
                                    payouts: cumulativePayoutsInput
                                });
                                console.log(`💾 已更新機台累積數據: plays=${cumulativePlaysInput}, payouts=${cumulativePayoutsInput}`, updateResult);
                                
                                // 檢查是否已存在相同日期和機台的歷史記錄
                                const historyQuery = db.collection('groups').doc(selectedGroupId)
                                    .collection('stores').doc(selectedStoreId)
                                    .collection('history');
                                
                                let existingRecords = null;
                                try {
                                    // 嘗試複合查詢
                                    existingRecords = await historyQuery
                                        .where('date', '==', record.date)
                                        .where('machineId', '==', machine.id)
                                        .where('location', '==', machine.location)
                                        .get();
                                } catch (queryError) {
                                    // 如果複合查詢失敗，使用備用方案
                                    console.warn(`⚠️ 複合查詢失敗，使用備用方案: ${queryError.message}`);
                                    const allRecords = await historyQuery.get();
                                    const filtered = allRecords.docs.filter(doc => {
                                        const data = doc.data();
                                        return data.date === record.date && 
                                               data.machineId === machine.id && 
                                               data.location === machine.location;
                                    });
                                    existingRecords = { docs: filtered };
                                }
                                
                                if (existingRecords.docs.length > 0) {
                                    // 更新現有記錄
                                    const docId = existingRecords.docs[0].id;
                                    await db.collection('groups').doc(selectedGroupId)
                                        .collection('stores').doc(selectedStoreId)
                                        .collection('history').doc(docId)
                                        .update({
                                            date: record.date,
                                            machineId: machine.id,
                                            location: machine.location,
                                            newPlays: dailyPlays,
                                            newPayouts: dailyPayouts,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    console.log(`✅ 已更新歷史記錄: ${docId}, 日增量 plays=${dailyPlays}, payouts=${dailyPayouts}`);
                                    
                                    // ✅ 標記為已持久化
                                    record.isPersisted = true;
                                    record.docId = docId;
                                    console.log(`📌 已標記為持久化: ${recordKey}`);
                                } else {
                                    // 新增新記錄
                                    console.log(`📝 準備新增歷史記錄:`, {
                                        selectedGroupId,
                                        selectedStoreId,
                                        date: record.date,
                                        machineId: machine.id,
                                        location: machine.location,
                                        newPlays: dailyPlays,
                                        newPayouts: dailyPayouts
                                    });
                                    
                                    const addResult = await db.collection('groups').doc(selectedGroupId)
                                        .collection('stores').doc(selectedStoreId)
                                        .collection('history')
                                        .add({
                                            date: record.date,
                                            machineId: machine.id,
                                            location: machine.location,
                                            newPlays: dailyPlays,
                                            newPayouts: dailyPayouts,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    console.log(`✅ 已新增歷史記錄: ${addResult.id}, 日增量 plays=${dailyPlays}, payouts=${dailyPayouts}`);
                                    
                                    // ✅ 標記為已持久化
                                    record.isPersisted = true;
                                    record.docId = addResult.id;
                                    console.log(`📌 已標記為持久化: ${recordKey}`);
                                }
                            }
                            
                        } catch (dbError) {
                            console.error(`❌ 資料庫操作失敗: ${machine.id}/${machine.location}`, {
                                error: dbError,
                                message: dbError.message,
                                code: dbError.code,
                                stack: dbError.stack
                            });
                            throw dbError;
                        }
                        
                        // 稍作停頓，避免過快操作
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        console.log(`✅ [${processedCount}/${totalRecords}] 已處理 ${machine.id}/${machine.location} 的記錄 (日期: ${record.date})`);
                        
                    } catch (error) {
                        console.error(`❌ 處理記錄失敗: ${recordKey}`, error);
                        failedCount++;
                    }
                }
                
                // 批次間稍作停頓，避免過度負載
                if (i + batchSize < allRecords.length) {
                    console.log(`⏳ 批次 ${batchNumber} 完成，稍作停頓...`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            const processedTotal = newCount + updateCount;
            const skippedTotal = unchangedCount;
            
            if (processedTotal === 0 && skippedTotal === 0) {
                alert(`❌ 沒有成功處理任何記錄 (失敗: ${failedCount})`);
            } else {
                // 計算總投幣數和總出貨數
                let totalPlays = 0;
                let totalPayouts = 0;
                
                // 累加新增和更新的記錄
                [...summaryInfo.new, ...summaryInfo.updated].forEach(m => {
                    totalPlays += (m.afterPlays - m.beforePlays);
                    totalPayouts += (m.afterPayouts - m.beforePayouts);
                });
                
                // 建立詳細的摘要訊息
                let detailMessages = [];
                
                if (newCount > 0) {
                    detailMessages.push(`✨ 新增 ${newCount} 筆:`);
                    summaryInfo.new.forEach(m => {
                        detailMessages.push(`   ${m.id}/${m.location}: 投幣 ${m.beforePlays}→${m.afterPlays}, 出貨 ${m.beforePayouts}→${m.afterPayouts}`);
                    });
                }
                
                if (updateCount > 0) {
                    detailMessages.push(`🔄 更新 ${updateCount} 筆:`);
                    summaryInfo.updated.forEach(m => {
                        detailMessages.push(`   ${m.id}/${m.location}: 投幣 ${m.beforePlays}→${m.afterPlays}, 出貨 ${m.beforePayouts}→${m.afterPayouts}`);
                    });
                }
                
                if (skippedTotal > 0) {
                    detailMessages.push(`⏭️ 跳過 ${skippedTotal} 筆 (無變化)`);
                }
                
                if (failedCount > 0) {
                    detailMessages.push(`❌ 失敗 ${failedCount} 筆`);
                }
                
                // 添加總計統計
                detailMessages.push(`\n📊 本次更新統計:`);
                detailMessages.push(`   總投幣數: ${totalPlays} 次`);
                detailMessages.push(`   總出貨數: ${totalPayouts} 次`);
                
                const message = `✅ 批量處理完成\n\n${detailMessages.join('\n')}`;
                alert(message);
                
                // ✅ 新增：詳細的操作總結
                console.log(`🎉 批量操作完成統計:`);
                console.log(`   ✨ 新增記錄: ${newCount} 筆`);
                if (summaryInfo.new.length > 0) {
                    summaryInfo.new.forEach(m => {
                        console.log(`      ${m.id}/${m.location} 投幣: ${m.beforePlays} → ${m.afterPlays} (+${m.playsChange})  出貨: ${m.beforePayouts} → ${m.afterPayouts} (+${m.payoutsChange})`);
                    });
                }
                console.log(`   🔄 更新記錄: ${updateCount} 筆`);
                if (summaryInfo.updated.length > 0) {
                    summaryInfo.updated.forEach(m => {
                        const playsIndicator = m.playsChange > 0 ? `+${m.playsChange}` : m.playsChange < 0 ? `${m.playsChange}` : '±0';
                        const payoutsIndicator = m.payoutsChange > 0 ? `+${m.payoutsChange}` : m.payoutsChange < 0 ? `${m.payoutsChange}` : '±0';
                        console.log(`      ${m.id}/${m.location} 投幣: ${m.beforePlays} → ${m.afterPlays} (${playsIndicator})  出貨: ${m.beforePayouts} → ${m.afterPayouts} (${payoutsIndicator})`);
                    });
                }
                console.log(`   ⏭️ 跳過記錄: ${unchangedCount} 筆`);
                if (summaryInfo.unchanged.length > 0) {
                    summaryInfo.unchanged.forEach(m => {
                        console.log(`      ${m.id}/${m.location} 投幣: ${m.beforePlays} → ${m.afterPlays} (±0)  出貨: ${m.beforePayouts} → ${m.afterPayouts} (±0) [無變化]`);
                    });
                }
                console.log(`   ❌ 失敗: ${failedCount} 筆`);
                
                // ✅ 重要：批量操作完成後，重新載入門市數據和清除輪詢臨時記錄
                console.log('🔄 重新載入門市數據...');
                try {
                    suppressNextAutoPoll = true;
                    await loadStoreData();
                    console.log('✅ 門市數據已重新載入');
                } catch (reloadError) {
                    console.error('❌ 重新載入門市數據失敗:', reloadError);
                }
                
                // 清除輪詢臨時記錄（注意：這不會影響 Firebase 中的正式記錄）
                console.log('🗑️ 清除輪詢臨時記錄...');
                window.dailyRecords = {};
                if (typeof refreshAutoRecordTable === 'function') {
                    refreshAutoRecordTable();
                }
            }
        }
        
        // 🚀 批次處理配置功能
        window.setBatchSize = function(size) {
            window.batchProcessingSize = size || 50;
            console.log(`📊 已設定批次處理大小: ${window.batchProcessingSize}`);
            return window.batchProcessingSize;
        };
        
        // 🚀 啟用無限制批次處理模式
        window.enableUnlimitedBatch = function(enable = true) {
            window.unlimitedBatchMode = enable;
            if (enable) {
                console.log('🚀 已啟用無限制批次處理模式');
                window.setBatchSize(Number.MAX_SAFE_INTEGER);
            } else {
                console.log('⚠️ 已停用無限制批次處理模式');
                window.setBatchSize(50); // 恢復預設值
            }
            return window.unlimitedBatchMode;
        };
        
        // 🔍 檢查批次處理狀態
        window.getBatchStatus = function() {
            const status = {
                batchSize: window.batchProcessingSize || 50,
                unlimitedMode: window.unlimitedBatchMode || false,
                recordCount: window.dailyRecords ? Object.keys(window.dailyRecords).length : 0,
                machineCount: appData?.machines?.length || 0
            };
            console.table(status);
            return status;
        };
        
        // 初始化預設設定
        if (typeof window.batchProcessingSize === 'undefined') {
            window.setBatchSize(50); // 預設批次大小
        }
        
        function handleHttpResponse(data, mac = null, devid = null) {
            const originalLength = Array.isArray(data) ? data.length : null;
            const limit = window.dataProcessLimit || 10; // 使用全局設定
            
            console.log('🔄 處理 HTTP 回應資料:', 
                Array.isArray(data) ? `陣列 (${data.length}筆)` : typeof data, 
                'MAC:', mac, 'DevID:', devid);
            
            // 🚀 前端優化: 根據全局設定只處理指定數量的最新資料
            if (Array.isArray(data) && data.length > limit) {
                console.log(`⚡⚡⚡ [效能優化] 原始資料 ${data.length} 筆 → 只處理最新 ${limit} 筆 (節省 ${data.length - limit} 筆，${Math.round((data.length - limit) / data.length * 100)}% 流量)`);
                // 假設資料已按時間排序,取前 N 筆
                data = data.slice(0, limit);
            } else if (Array.isArray(data)) {
                console.log(`✅ 資料量適中: ${data.length} 筆 (無需過濾)`);
            }
            
            console.log('📊 [DEBUG] 處理的資料:', JSON.stringify(data, null, 2).substring(0, 500) + '...');
            
            // 更新最後回應顯示
            const lastResponseElement = document.getElementById('http-last-response');
            if (lastResponseElement) {
                if (typeof data === 'string') {
                    lastResponseElement.textContent = data.substring(0, 50) + (data.length > 50 ? '...' : '');
                } else {
                    lastResponseElement.textContent = JSON.stringify(data).substring(0, 50) + '...';
                }
            }
            
            // 添加到命令記錄 (✅ 使用 'success' 類型顯示為綠色成功訊息)
            addCommandLog('success', `收到回應資料：${JSON.stringify(data).substring(0, 100)}...`, {
                timestamp: new Date().toLocaleTimeString(),
                dataPreview: data
            });
            
            // 初始化 devid 對應的存儲
            if (!window.machineDataByDevid) {
                window.machineDataByDevid = {};
            }
            
            // 如果是陣列，優先按指定的 devid 解析，否則解析所有 devid
            if (Array.isArray(data)) {
                console.log('📊 檢測到陣列數據，處理多 devid... (指定DevID:', devid, ')');
                
                if (devid !== null && devid !== undefined) {
                    // ✅ 優先按指定的 devid 解析
                    console.log(`⭐ 優先解析指定的 devid: ${devid}`);
                    const parsedData = parseHttpData(data, devid, mac);
                    
                    if (parsedData && parsedData.plays !== null) {
                        window.machineDataByDevid[devid] = parsedData;
                        console.log(`✅ devid ${devid} 數據已儲存:`, parsedData);
                        console.log(`   🔍 [DEBUG] 解析結果 - plays: ${parsedData.plays}, payouts: ${parsedData.payouts}, hasData: ${parsedData.hasData}`);
                        
                        // 📝 使用智能查找函數獲取機台配置
                        const machineConfig = findMachineConfig(mac, devid);
                        
                        if (machineConfig) {
                            // ✅ 直接使用原始數值，讓 updateDailyRecord 處理校正值計算
                            const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                            console.log(`📋 每日記錄更新結果 (${recordResult.status}):`, recordResult.record);
                            console.log(`   🔍 [DEBUG] 原始值: plays=${parsedData.plays}, payouts=${parsedData.payouts}`);
                            console.log(`   🔧 [校正後] 顯示值: plays=${recordResult.record.plays}, payouts=${recordResult.record.payouts}`);
                            console.log(`   📊 [變化] 投幣變化: ${recordResult.playsChanged}, 出貨變化: ${recordResult.payoutsChanged}`);
                        } else {
                            console.warn(`⚠️ 找不到機台配置: MAC=${mac}, DevID=${devid}，跳過記錄更新`);
                        }
                        
                        // 🔄 刷新自動記帳表格
                        refreshAutoRecordTable();
                        
                        updateMachineDataDisplay(parsedData, devid);
                    } else {
                        console.warn(`⚠️ [CRITICAL ERROR] devid ${devid} 解析失敗！plays=${parsedData?.plays}, payouts=${parsedData?.payouts}, hasData=${parsedData?.hasData}`);
                        console.log('   📊 [DEBUG] parsedData 完整信息:', JSON.stringify(parsedData, null, 2));
                        console.log('   🔴 HTTP 回應格式可能不是預期的 re_readdata 結構');
                        console.log('   💡 請檢查: window.parmByDevid 中的 parm 十六進位數據');
                    }
                } else {
                    // ✅ 如果沒指定 devid，則找出每個 devid 的最新記錄
                    console.log('📊 未指定 DevID，自動解析所有 DevID 的最新記錄');
                    
                    // 建立 DevID 到最新記錄的映射
                    const latestByDevid = {};
                    
                    data.forEach((record, index) => {
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.devid && parsed.cmd === 're_readdata') {
                                    const devid = parseInt(parsed.devid);
                                    
                                    // 如果還沒有這個 devid 的記錄，或者當前記錄更新，則更新
                                    if (!latestByDevid[devid] || record.date > latestByDevid[devid].date) {
                                        latestByDevid[devid] = {
                                            record: record,
                                            parsed: parsed,
                                            date: record.date
                                        };
                                        console.log(`   🔄 更新 DevID=${devid} 最新記錄: ${record.date}`);
                                    }
                                }
                            } catch (e) {
                                console.warn(`⚠️ [${index}] 無法解析記錄:`, record);
                            }
                        }
                    });
                    
                    const devidCount = Object.keys(latestByDevid).length;
                    console.log(`✅ 找到 ${devidCount} 個 DevID 的最新記錄:`, Object.keys(latestByDevid).map(d => `DevID=${d} (${latestByDevid[d].date})`));
                    
                    // 為每個 devid 解析最新數據
                    let processedCount = 0;
                    Object.keys(latestByDevid).forEach(targetDevid => {
                        const devid = parseInt(targetDevid);
                        const latestRecord = latestByDevid[devid];
                        
                        console.log(`\n📊 [${processedCount + 1}/${devidCount}] 處理 DevID=${devid}`);
                        console.log(`   時間: ${latestRecord.date}`);
                        console.log(`   parm: ${latestRecord.parsed.parm?.substring(0, 40)}...`);
                        
                        const parsedData = parseHttpData(data, devid, mac);
                        
                        if (parsedData && parsedData.plays !== null) {
                            window.machineDataByDevid[devid] = parsedData;
                            console.log(`   ✅ DevID ${devid} 數據已儲存: plays=${parsedData.plays}, payouts=${parsedData.payouts}`);
                            
                            // 📝 使用智能查找函數獲取機台配置
                            const machineConfig = findMachineConfig(mac, devid);
                            
                            console.log(`   🔑 智能查找映射 MAC=${mac}, DevID=${devid}:`, machineConfig ? `找到 ${machineConfig.machineId}/${machineConfig.location}` : '❌ 未找到');
                            
                            if (machineConfig) {
                                // ✅ 直接使用原始數值，讓 updateDailyRecord 處理校正值計算
                                const recordResult = updateDailyRecord(machineConfig.machineId, machineConfig.location, parsedData.plays, parsedData.payouts);
                                console.log(`   📋 每日記錄更新結果 (${recordResult.status}):`, recordResult.record);
                                console.log(`   🔧 [校正] 原始: ${parsedData.plays}/${parsedData.payouts} → 顯示: ${recordResult.record.plays}/${recordResult.record.payouts}`);
                                processedCount++;
                            } else {
                                console.warn(`   ⚠️ 找不到機台配置: MAC=${mac}, DevID=${devid}，跳過記錄更新`);
                                console.log(`   💡 可用的映射鍵:`, Object.keys(window.machineConfigMap || {}).slice(0, 10));
                            }
                            
                            // 顯示該 devid 的數據
                            updateMachineDataDisplay(parsedData, devid);
                        } else {
                            console.warn(`   ❌ DevID ${devid} 解析失敗:`, parsedData);
                        }
                    });
                    
                    console.log(`\n🎯 處理完成：共處理 ${processedCount}/${devidCount} 個 DevID`);
                    
                    // 🔄 刷新自動記帳表格
                    refreshAutoRecordTable();
                }
                
                // 儲存到全域變數供後續使用
                window.lastParsedMachineData = window.machineDataByDevid;
            } else {
                // 單個數據處理
                const parsedData = parseHttpData(data, devid, mac);
                
                // 如果成功解析，記錄提取的數據
                if (parsedData) {
                    console.log('✅ 數據解析成功:', parsedData);
                    
                    // 按 devid 儲存
                    if (parsedData.devid || devid) {
                        const saveDevid = parsedData.devid || devid;
                        if (!window.machineDataByDevid) {
                            window.machineDataByDevid = {};
                        }
                        window.machineDataByDevid[saveDevid] = parsedData;
                        console.log(`💾 devid ${saveDevid} 數據已保存`);
                    }
                    
                    // 更新 UI 中顯示的機台數據
                    updateMachineDataDisplay(parsedData, devid);
                    
                    // 儲存到全域變數供後續使用
                    window.lastParsedMachineData = parsedData;
                } else {
                    console.warn('⚠️ 無法解析數據');
                }
            }
        }
        
        // 解析 HTTP 回應數據 - 支持多種格式和多個 devid
        function parseHttpData(data, targetDevid = null, realMac = null) {
            console.log('🔄 parseHttpData - targetDevid:', targetDevid, 'realMac:', realMac);
            try {
                console.log('📥 開始解析數據，類型:', typeof data, targetDevid ? `，目標 devid: ${targetDevid}` : '');
                
                // 情況 1: 如果是陣列，尋找對應 devid 的 re_readdata 命令
                if (Array.isArray(data)) {
                    console.log('🔍 檢測到陣列結構，共 ' + data.length + ' 條記錄 (🚀 前端優化: 只處理前10筆)');
                    
                    // 🚀 優化: 只處理前10筆記錄,減少處理時間
                    const recordsToProcess = Math.min(data.length, 10);
                    const reReadRecords = [];
                    
                    // 🚀 只遍歷前10筆記錄
                    for (let i = 0; i < recordsToProcess; i++) {
                        const record = data[i];
                        if (record.data && typeof record.data === 'string') {
                            try {
                                const parsed = JSON.parse(record.data);
                                if (parsed.cmd === 're_readdata' && parsed.parm) {
                                    // 🔧 修正: 將日期格式轉換為標準 ISO 格式
                                    // "2025-11-02 00:12:44.324" → "2025-11-02T00:12:44.324"
                                    const dateStr = record.date.replace(' ', 'T');
                                    const timestamp = new Date(dateStr).getTime();
                                    
                                    reReadRecords.push({
                                        index: i,
                                        date: record.date,
                                        devid: parsed.devid,
                                        timestamp: timestamp,
                                        record: record,
                                        parsed: parsed
                                    });
                                }
                            } catch (e) {
                                // 解析失敗,跳過
                            }
                        }
                    }
                    
                    if (recordsToProcess < data.length) {
                        console.log(`⚡ 優化: 只處理了前 ${recordsToProcess} 筆,跳過其餘 ${data.length - recordsToProcess} 筆`);
                    }
                    
                    if (reReadRecords.length > 0) {
                        console.log('📋 發現所有 re_readdata 記錄:');
                        reReadRecords.forEach(r => console.log(`   [${r.index}] ${r.date} (devid=${r.devid}) timestamp=${r.timestamp}`));
                    }
                    
                    // ✅ 關鍵修正：按時間戳排序，找最新的符合條件的記錄
                    // 如果指定了 devid，則先過濾該 devid，再按時間排序
                    let targetRecords = reReadRecords;
                    if (targetDevid !== null) {
                        targetRecords = reReadRecords.filter(r => parseInt(r.devid) == parseInt(targetDevid));
                        console.log(`🔎 過濾 devid=${targetDevid} 的記錄，找到 ${targetRecords.length} 條`);
                    }
                    
                    if (targetRecords.length > 0) {
                        // 按時間戳倒序排列（最新的在前）
                        targetRecords.sort((a, b) => b.timestamp - a.timestamp);
                        const newestRecord = targetRecords[0];
                        
                        console.log(`✅ 選擇最新記錄: [${newestRecord.index}] ${newestRecord.date} (devid=${newestRecord.devid})`);
                        console.log(`   時間戳: ${newestRecord.timestamp}, 比較其他記錄:`);
                        targetRecords.slice(1, 3).forEach(r => {
                            const timeDiff = newestRecord.timestamp - r.timestamp;
                            console.log(`   - [${r.index}] ${r.date} (相差 ${timeDiff}ms)`);
                        });
                        
                        // 🔍 檢測數據新鮮度
                        const now = Date.now();
                        const dataAge = now - newestRecord.timestamp;
                        const ageSeconds = Math.floor(dataAge / 1000);
                        
                        if (dataAge > 60000) { // 超過 60 秒
                            console.warn(`⚠️ 數據可能過期! 記錄時間: ${newestRecord.date}, 距今 ${ageSeconds} 秒`);
                            console.warn(`   建議: 此 MAC 可能需要重試讀取`);
                            // 在返回的數據中添加標記
                            const result = parseReReadData(newestRecord.parsed, realMac);
                            result._isStale = true;
                            result._dataAge = ageSeconds;
                            return result;
                        } else {
                            console.log(`✅ 數據新鮮: 距今僅 ${ageSeconds} 秒`);
                        }
                        
                        return parseReReadData(newestRecord.parsed, realMac);
                    }
                    
                    // 如果指定了 devid 但沒找到，記錄
                    if (targetDevid !== null) {
                        console.warn(`⚠️ 未找到 devid ${targetDevid} 的 re_readdata 命令`);
                    } else {
                        console.warn('⚠️ 未找到有效的 re_readdata 命令');
                    }
                    
                    return {
                        plays: null,
                        payouts: null,
                        timestamp: new Date().toLocaleTimeString('zh-TW'),
                        format: 'array_no_data',
                        hasData: false,
                        devid: targetDevid
                    };
                }
                
                let jsonData = data;
                
                // 情況 2: 如果是字符串，嘗試解析為 JSON
                if (typeof data === 'string') {
                    // 嘗試 JSON 解析
                    try {
                        jsonData = JSON.parse(data);
                        // 如果解析後是陣列，遞歸處理
                        if (Array.isArray(jsonData)) {
                            return parseHttpData(jsonData, targetDevid);
                        }
                    } catch (e) {
                        // 如果不是有效的 JSON，嘗試提取數據
                        console.log('📄 接收到文本數據，嘗試提取結構化信息...');
                        return parseTextData(data);
                    }
                }
                
                // 情況 3: 如果是對象
                if (typeof jsonData === 'object' && jsonData !== null) {
                    // 首先檢查是否是 re_readdata 命令
                    if (jsonData.cmd === 're_readdata' && jsonData.parm) {
                        console.log('🔍 檢測到 re_readdata 命令，解析 parm 字段...');
                        return parseReReadData(jsonData, targetDevid);
                    }
                    // 否則使用通用 JSON 解析
                    return extractMachineData(jsonData);
                }
                
                return null;
            } catch (error) {
                console.error('❌ 數據解析失敗:', error);
                return null;
            }
        }
        
        // 解析 re_readdata 命令的 parm 十六進位字段
        function parseReReadData(jsonData, realMac = null) {
            console.log('⚙️ 解析 re_readdata 協議數據...');
            console.log('🔍 [DEBUG] jsonData:', JSON.stringify(jsonData));
            console.log('🔍 [DEBUG] realMac 參數:', realMac);
            
            const result = {
                raw: jsonData,
                plays: null,        // 累積投幣數
                payouts: null,      // 累積出獎次數
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 're_readdata',
                hasData: false
            };
            
            try {
                const parm = jsonData.parm;
                if (!parm || typeof parm !== 'string') {
                    console.warn('⚠️ parm 字段無效', {parm, type: typeof parm});
                    console.log('🔍 [DEBUG] jsonData.parm:', jsonData.parm);
                    return result;
                }
                
                console.log('📝 parm 十六進位字符串: ' + parm);
                console.log('📊 parm 字符串長度: ' + parm.length + ' 字符 (' + (parm.length / 2) + ' 字節)');
                console.log('🔍 [DEBUG] parm 前 100 字符:', parm.substring(0, 100));
                console.log('🔍 [DEBUG] parm 完整內容:', parm);
                console.log('🔍 [DEBUG] jsonData.devid:', jsonData.devid, '類型:', typeof jsonData.devid);
                console.log('🔍 [DEBUG] jsonData.mac:', jsonData.mac);
                console.log('🔍 [DEBUG] realMac 參數:', realMac);
                console.log('🔍 [DEBUG] jsonData 完整內容:', JSON.stringify(jsonData).substring(0, 200));
                
                // 保存到全局變數便於查詢（優先使用 realMac，其次使用 jsonData.mac）
                if (!window.parmByDevid) window.parmByDevid = {};
                if (!window.parmByMac) window.parmByMac = {};
                
                const devIdKey = String(jsonData.devid);
                // 優先使用 realMac 參數（真實 MAC），如果沒有才使用 jsonData.mac
                const macKey = realMac ? String(realMac).toUpperCase() : (jsonData.mac ? String(jsonData.mac).toUpperCase() : null);
                const compositeKey = macKey ? `${macKey}_${devIdKey}` : devIdKey;
                
                console.log('🔑 使用的 MAC:', macKey, '(來源:', realMac ? 'realMac 參數' : 'jsonData.mac', ')');
                console.log('🔑 組合鍵:', compositeKey);
                
                // 同時保存到兩個索引：compositeKey (主要) 和 devid (向後兼容)
                window.parmByDevid[compositeKey] = parm;
                if (macKey) {
                    if (!window.parmByMac[macKey]) window.parmByMac[macKey] = {};
                    window.parmByMac[macKey][devIdKey] = parm;
                }
                
                console.log(`💾 已保存到 window.parmByDevid["${compositeKey}"]，parm 長度: ${parm.length}`);
                if (macKey) {
                    console.log(`💾 已保存到 window.parmByMac["${macKey}"]["${devIdKey}"]`);
                }
                
                // 將十六進位字符串轉換為字節陣列
                const bytes = [];
                for (let i = 0; i < parm.length; i += 2) {
                    const hex = parm.substring(i, i + 2);
                    bytes.push(parseInt(hex, 16));
                }
                
                console.log('🔍 前 40 個字節值(十進位): ' + bytes.slice(0, 40).join(', '));
                
                // ✅ 主要位置: 嘗試多個已知位置
                // ✅ 主要位置: 投幣數和出貨次數位置
                // 根據實際 parm 數據分析：
                // 字節: ... 11, 0, 1, 40, 0, 0, 135, 0, 9, 0, 210, 0, 94, 1, ...
                // 位置: ... 26 27 28 29 30 31 32  33 34 35 36   37 38  39 ...
                //
                // Byte[32] = 135, Byte[33] = 0   → plays = 135 + (0 << 8) = 135 ✅
                // Byte[34] = 9,   Byte[35] = 0   → payouts = 9 + (0 << 8) = 9 ✅
                
                console.log(`🔍 devid=${parseInt(jsonData.devid) || 1}, 嘗試多個位置...`);
                
                // 📍 正確位置 (32-35)
                if (bytes.length >= 36) {
                    const plays = bytes[32] + (bytes[33] << 8);
                    const payouts = bytes[34] + (bytes[35] << 8);
                    const isValid = isValidPair(plays, payouts);
                    
                    console.log(`📍 試 位置32-35 (正確位置): bytes[32]=${bytes[32]?.toString(16).padStart(2,'0')}, bytes[33]=${bytes[33]?.toString(16).padStart(2,'0')}, bytes[34]=${bytes[34]?.toString(16).padStart(2,'0')}, bytes[35]=${bytes[35]?.toString(16).padStart(2,'0')} → plays=${plays}, payouts=${payouts}, 有效=${isValid}`);
                    
                    if (isValid) {
                        result.plays = plays;
                        result.payouts = payouts;
                        result.hasData = true;
                        console.log(`✅ 位置32-35 成功提取: plays=${plays}, payouts=${payouts}`);
                        return result;
                    } else {
                        console.log(`⚠️ 位置32-35 數據無效，嘗試備用位置...`);
                    }
                }
                
                // 🔄 備用位置: 嘗試其他已知位置
                const knownPositions = [
                    {name: '位置36-39', start: 36},
                    {name: '位置42-45', start: 42},
                    {name: '位置52-55', start: 52}
                ];
                
                for (const pos of knownPositions) {
                    if (bytes.length >= pos.start + 4) {
                        const plays = bytes[pos.start] + (bytes[pos.start+1] << 8);
                        const payouts = bytes[pos.start+2] + (bytes[pos.start+3] << 8);
                        const isValid = isValidPair(plays, payouts);
                        
                        console.log(`📍 試 ${pos.name}: bytes[${pos.start}]=${bytes[pos.start]?.toString(16).padStart(2,'0')}, bytes[${pos.start+1}]=${bytes[pos.start+1]?.toString(16).padStart(2,'0')}, bytes[${pos.start+2}]=${bytes[pos.start+2]?.toString(16).padStart(2,'0')}, bytes[${pos.start+3}]=${bytes[pos.start+3]?.toString(16).padStart(2,'0')} → plays=${plays}, payouts=${payouts}, 有效=${isValid}`);
                        
                        if (isValid) {
                            result.plays = plays;
                            result.payouts = payouts;
                            result.hasData = true;
                            console.log(`✅ ${pos.name} 成功提取: plays=${plays}, payouts=${payouts}`);
                            return result;
                        }
                    }
                }
                
                // 備用位置: 多個固定位置 (4字節)
                const positions = [
                    {name: '位置A (2-6, 6-10)', plays: [2, 6], payouts: [6, 10]},
                    {name: '位置B (4-8, 8-12)', plays: [4, 8], payouts: [8, 12]},
                    {name: '位置C (8-12, 12-16)', plays: [8, 12], payouts: [12, 16]},
                    {name: '位置D (10-14, 14-18)', plays: [10, 14], payouts: [14, 18]},
                    {name: '位置E (16-20, 20-24)', plays: [16, 20], payouts: [20, 24]},
                    {name: '位置F (18-22, 22-26)', plays: [18, 22], payouts: [22, 26]},
                    {name: '位置G (24-28, 28-32)', plays: [24, 28], payouts: [28, 32]},
                ];
                
                console.log('🔎 嘗試備用 4字節位置...');
                for (const pos of positions) {
                    if (bytes.length >= pos.payouts[1]) {
                        const p1 = bytes[pos.plays[0]] | (bytes[pos.plays[0]+1] << 8) | (bytes[pos.plays[0]+2] << 16) | (bytes[pos.plays[0]+3] << 24);
                        const p2 = bytes[pos.payouts[0]] | (bytes[pos.payouts[0]+1] << 8) | (bytes[pos.payouts[0]+2] << 16) | (bytes[pos.payouts[0]+3] << 24);
                        
                        console.log(`  試 ${pos.name}: plays=${p1}, payouts=${p2}`);
                        
                        if (isValidPair(p1, p2)) {
                            result.plays = p1;
                            result.payouts = p2;
                            result.hasData = true;
                            console.log(`✅ ${pos.name} 成功: plays=${p1}, payouts=${p2}`);
                            return result;
                        }
                    }
                }
                
                // 備用方法: 動態掃描 - 嘗試所有可能的 4 字節對
                console.log('🔎 開始動態掃描所有 4字節 位置...');
                for (let i = 0; i < bytes.length - 15; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8) | (bytes[i+2] << 16) | (bytes[i+3] << 24);
                    const val2 = bytes[i+4] | (bytes[i+5] << 8) | (bytes[i+6] << 16) | (bytes[i+7] << 24);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`✅ 動態掃描成功 (位置 ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                // 備用方法: 嘗試 2 字節組合 (動態)
                console.log('🔎 嘗試 2字節組合 (動態掃描)...');
                for (let i = 0; i < bytes.length - 3; i += 2) {
                    const val1 = bytes[i] | (bytes[i+1] << 8);
                    const val2 = bytes[i+2] | (bytes[i+3] << 8);
                    
                    if (isValidPair(val1, val2)) {
                        result.plays = val1;
                        result.payouts = val2;
                        result.hasData = true;
                        console.log(`✅ 2字節成功 (位置 ${i}): plays=${val1}, payouts=${val2}`);
                        return result;
                    }
                }
                
                console.warn('⚠️ 嘗試了所有方法，無法從 parm 中提取有效數據');
                console.log('💡 parm 樣本: ' + parm);
                console.log('🔍 [DEBUG] 無法解析的原因分析:');
                console.log('   - 所有位置都沒有提取到有效的投幣/出貨對');
                console.log('   - 可能原因: parm 結構不符合預期，或解析邏輯需要調整');
                console.log('   - 建議: 檢查 HTTP 伺服器的 parm 字段格式');
                result.hasData = false;
                
            } catch (error) {
                console.error('❌ re_readdata 解析錯誤:', error);
                result.hasData = false;
            }
            
            return result;
        }
        
        // 驗證投幣和出獎數據是否有效
        function isValidPair(plays, payouts) {
            // 投幣數應該大於 0，小於 100 萬
            // 出獎數應該大於等於 0，小於等於投幣數，小於 100 萬
            const playsValid = plays > 0 && plays < 1000000;
            const payoutsValid = payouts >= 0 && payouts <= plays && payouts < 1000000;
            
            return playsValid && payoutsValid;
        }
        
        // ⚡ 調試工具：檢查系統當前狀態
        window.debugHttpPolling = function() {
            console.log('='.repeat(60));
            console.log('🔍 HTTP 輪詢系統調試信息');
            console.log('='.repeat(60));
            
            console.log('\n📋 當前系統記錄:');
            if (window.dailyRecords) {
                Object.entries(window.dailyRecords).forEach(([key, record]) => {
                    console.log(`  ${key}:`, {
                        machineId: record.machineId,
                        location: record.location,
                        plays: record.plays,
                        payouts: record.payouts,
                        updateCount: record.updateCount,
                        lastPlays: record.lastPlays,
                        lastPayouts: record.lastPayouts
                    });
                });
            } else {
                console.log('  ❌ window.dailyRecords 未初始化');
            }
            
            console.log('\n🔌 最後 parm 十六進位數據:');
            if (window.parmByDevid) {
                Object.entries(window.parmByDevid).forEach(([devid, parm]) => {
                    console.log(`  devid ${devid}: ${parm.substring(0, 100)}...`);
                });
            } else {
                console.log('  ❌ window.parmByDevid 未初始化');
            }
            
            console.log('\n🗺️ 機台配置映射:');
            if (window.machineConfigMap) {
                Object.entries(window.machineConfigMap).forEach(([key, config]) => {
                    console.log(`  ${key}: ${config.machineId}/${config.location}`);
                });
            } else {
                console.log('  ❌ window.machineConfigMap 未初始化');
            }
            
            console.log('='.repeat(60));
        };
        
        // ⚡ 調試工具：手動測試更新
        window.testUpdateDaily = function(machineId, location, plays, payouts) {
            console.log(`\n🧪 測試手動更新: ${machineId}/${location} - plays:${plays}, payouts:${payouts}`);
            const result = updateDailyRecord(machineId, location, plays, payouts);
            console.log('結果:', result);
            refreshAutoRecordTable();
        };
        
        // ⚡ 強制同步：直接從表格讀取最新值並強制更新系統
        window.forceSyncFromTable = function() {
            console.log('\n⚡ 開始強制同步表格數據到系統...');
            
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.error('❌ 找不到表格');
                return;
            }
            
            const rows = tableBody.querySelectorAll('tr');
            let syncCount = 0;
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const dateStr = cells[0]?.textContent?.trim();
                    const machineLink = cells[1]?.querySelector('a');
                    const machineText = machineLink?.textContent?.trim() || cells[1]?.textContent?.trim();
                    const plays = parseInt(cells[2]?.textContent?.trim()) || 0;
                    const payouts = parseInt(cells[3]?.textContent?.trim()) || 0;
                    
                    if (machineText && plays > 0) {
                        // 解析機台信息: "A001 / 沙止湖畔市/A0011/上1"
                        const parts = machineText.split('/');
                        const machineId = parts[0]?.trim() || '';
                        const location = machineText.substring(machineText.indexOf('/')+1)?.trim() || '';
                        
                        console.log(`  [${syncCount+1}] 同步: ${machineId}/${location} -> plays:${plays}, payouts:${payouts}`);
                        
                        const result = updateDailyRecord(machineId, location, plays, payouts);
                        syncCount++;
                        
                        if (result.status === 'updated') {
                            console.log(`    ✅ 已更新`);
                        } else if (result.status === 'unchanged') {
                            console.log(`    ℹ️ 數據未變化`);
                        } else {
                            console.log(`    ✨ 新建記錄`);
                        }
                    }
                }
            });
            
            console.log(`\n✅ 強制同步完成，共同步 ${syncCount} 條記錄`);
            refreshAutoRecordTable();
        };
        
        // ⚡ 修復模式：使用表單中的手動輸入值直接更新（臨時解決 parm 解析問題）
        window.useManualValuesMode = function(enable = true) {
            window.useManualValues = enable;
            if (enable) {
                console.log('✅ 已啟用手動值模式 - 系統將使用表單中的手動投幣/出貨值，而不是解析 parm');
                console.log('   現在點擊「新增記錄」按鈕時，會使用表單中的值進行更新');
                console.log('   您可以在表單中手動輸入投幣次數和出貨數量');
            } else {
                console.log('❌ 已禁用手動值模式 - 系統將繼續嘗試從 parm 解析數據');
            }
        };
        
        // ⚡ 一筆一筆手動新增記錄 - 直接從表格讀取當前值並執行新增流程（最強修復方案）
        window.manualAddOneByOne = async function() {
            console.log('\n' + '='.repeat(60));
            console.log('🔥 開始逐筆手動新增記錄 - 直接讀取表格當前值');
            console.log('='.repeat(60));
            
            // 獲取表格
            const tableBody = document.getElementById('auto-record-table-body');
            if (!tableBody) {
                console.error('❌ 找不到表格 (auto-record-table-body)');
                return;
            }
            
            // 獲取表單元素
            const machineSelector = document.getElementById('machine-selector');
            const entryDate = document.getElementById('entry-date');
            const cumulativePlays = document.getElementById('cumulative-plays');
            const cumulativePayouts = document.getElementById('cumulative-payouts');
            const dailyEntryForm = document.getElementById('daily-entry-form');
            
            if (!dailyEntryForm || !machineSelector) {
                console.error('❌ 找不到表單元素');
                return;
            }
            
            // 獲取表格中的所有行
            const rows = tableBody.querySelectorAll('tr');
            console.log(`📊 找到 ${rows.length} 條記錄`);
            
            let successCount = 0;
            let failedCount = 0;
            
            // 一筆一筆處理
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length < 5) continue;
                
                // 解析表格數據
                const dateStr = cells[0]?.textContent?.trim();
                const machineLink = cells[1]?.querySelector('a');
                const machineText = machineLink?.textContent?.trim() || cells[1]?.textContent?.trim();
                const plays = parseInt(cells[2]?.textContent?.trim()) || 0;
                const payouts = parseInt(cells[3]?.textContent?.trim()) || 0;
                
                if (!machineText || plays === 0) {
                    console.warn(`⏭️ [第 ${i+1} 筆] 資料不完整，跳過`);
                    continue;
                }
                
                console.log(`\n📌 [第 ${i+1} 筆] 處理: ${machineText}`);
                console.log(`   📅 日期: ${dateStr}`);
                console.log(`   💰 投幣: ${plays}`);
                console.log(`   📦 出貨: ${payouts}`);
                
                try {
                    // 步驟 1：從 appData 找到對應的機台
                    buildMachineConfigMap();
                    let foundMachine = null;
                    
                    // 嘗試從 window.dailyRecords 找到機台信息
                    if (window.dailyRecords) {
                        for (const [key, record] of Object.entries(window.dailyRecords)) {
                            if (record.plays === plays && record.payouts === payouts) {
                                // 找到匹配的記錄
                                for (let machine of appData.machines) {
                                    if (machine.id === record.machineId && machine.location === record.location) {
                                        foundMachine = machine;
                                        break;
                                    }
                                }
                                if (foundMachine) break;
                            }
                        }
                    }
                    
                    // 如果沒找到，嘗試從機台列表匹配
                    if (!foundMachine) {
                        for (let machine of appData.machines) {
                            const machineDisplayText = `${machine.id} / ${machine.location}`;
                            if (machineText.includes(machine.id) && machineText.includes(machine.location)) {
                                foundMachine = machine;
                                break;
                            }
                        }
                    }
                    
                    if (!foundMachine) {
                        console.error(`   ❌ 找不到對應的機台`);
                        failedCount++;
                        continue;
                    }
                    
                    console.log(`   ✅ 找到機台: docId=${foundMachine.docId}`);
                    
                    // 步驟 2：設置表單值
                    machineSelector.value = foundMachine.docId;
                    machineSelector.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // 等待 change 事件處理完成
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    entryDate.value = dateStr || new Date().toISOString().split('T')[0];
                    cumulativePlays.value = plays;
                    cumulativePayouts.value = payouts;
                    
                    console.log(`   ✅ 表單已填入:`);
                    console.log(`      機台: ${machineSelector.value}`);
                    console.log(`      日期: ${entryDate.value}`);
                    console.log(`      投幣: ${cumulativePlays.value}`);
                    console.log(`      出貨: ${cumulativePayouts.value}`);
                    
                    // 步驟 3：提交表單
                    console.log(`   ⏳ 提交表單...`);
                    dailyEntryForm.dispatchEvent(new Event('submit', { bubbles: true }));
                    
                    // 等待表單提交完成
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    console.log(`   ✅ 已提交`);
                    successCount++;
                    
                } catch (error) {
                    console.error(`   ❌ 處理失敗: ${error.message}`);
                    failedCount++;
                }
                
                // 每筆間隔 1000ms（1秒），確保資料處理穩定
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            console.log(`\n${'='.repeat(60)}`);
            console.log(`✅ 手動新增完成`);
            console.log(`   成功: ${successCount} 筆`);
            console.log(`   失敗: ${failedCount} 筆`);
            console.log(`   總計: ${successCount + failedCount} 筆`);
            console.log('='.repeat(60));
            
            alert(`✅ 手動新增完成\n成功: ${successCount} 筆\n失敗: ${failedCount} 筆`);
        };
        
        // 從文本格式解析數據
        function parseTextData(textData) {
            console.log('🔍 分析文本數據結構...');
            
            const result = {
                raw: textData,
                plays: null,        // 累積投幣數
                payouts: null,      // 累積出貨次數
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'text'
            };
            
            // 嘗試多種常見的分隔符格式
            // 格式 1: "plays:123,payouts:456" 或類似
            const colonFormat = textData.match(/plays[:\s]+(\d+).*?payouts[:\s]+(\d+)/i);
            if (colonFormat) {
                result.plays = parseInt(colonFormat[1]);
                result.payouts = parseInt(colonFormat[2]);
                console.log('✅ 格式識別: 冒號分隔符');
                return result;
            }
            
            // 格式 2: "123,456" (假設第一個數字是投幣，第二個是出貨)
            const commaFormat = textData.match(/^(\d+)[,\s]+(\d+)$/);
            if (commaFormat) {
                result.plays = parseInt(commaFormat[1]);
                result.payouts = parseInt(commaFormat[2]);
                console.log('✅ 格式識別: 逗號分隔符');
                return result;
            }
            
            // 格式 3: 換行分隔 "123\n456"
            const lineFormat = textData.match(/(\d+)\s+(\d+)/);
            if (lineFormat) {
                result.plays = parseInt(lineFormat[1]);
                result.payouts = parseInt(lineFormat[2]);
                console.log('✅ 格式識別: 空白分隔符');
                return result;
            }
            
            // 格式 4: 只提取所有數字
            const numbers = textData.match(/\d+/g);
            if (numbers && numbers.length >= 2) {
                result.plays = parseInt(numbers[0]);
                result.payouts = parseInt(numbers[1]);
                console.log('✅ 格式識別: 自動提取數字');
                return result;
            }
            
            return null;
        }
        
        // 從 JSON 對象提取機台數據
        function extractMachineData(jsonData) {
            console.log('📦 分析 JSON 結構...');
            
            const result = {
                raw: jsonData,
                plays: null,
                payouts: null,
                timestamp: new Date().toLocaleTimeString('zh-TW'),
                format: 'json'
            };
            
            // 常見的欄位名稱列表
            const playsKeywords = ['plays', 'play', 'coins', 'coin', '投幣', '投币', 'investment', 'cumulative_plays', 'total_plays', 'count'];
            const payoutsKeywords = ['payouts', 'payout', 'dispense', 'dispenses', '出貨', '出货', 'distribution', 'cumulative_payouts', 'total_payouts', 'times'];
            
            // 尋找投幣數
            for (const key of playsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.plays = parseInt(jsonData[key]);
                    console.log(`✅ 找到投幣欄位: "${key}" = ${result.plays}`);
                    break;
                }
            }
            
            // 如果沒找到，嘗試查找嵌套欄位
            if (result.plays === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of playsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.plays = parseInt(jsonData[key][subKey]);
                                console.log(`✅ 找到嵌套投幣欄位: "${key}.${subKey}" = ${result.plays}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // 尋找出貨次數
            for (const key of payoutsKeywords) {
                if (jsonData[key] !== undefined) {
                    result.payouts = parseInt(jsonData[key]);
                    console.log(`✅ 找到出貨欄位: "${key}" = ${result.payouts}`);
                    break;
                }
            }
            
            // 如果沒找到，嘗試查找嵌套欄位
            if (result.payouts === null) {
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                        for (const subKey of payoutsKeywords) {
                            if (jsonData[key][subKey] !== undefined) {
                                result.payouts = parseInt(jsonData[key][subKey]);
                                console.log(`✅ 找到嵌套出貨欄位: "${key}.${subKey}" = ${result.payouts}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            // 如果還是沒找到，嘗試按位置猜測（第一個和第二個數字值）
            if (result.plays === null || result.payouts === null) {
                let numberCount = 0;
                for (const key in jsonData) {
                    const value = jsonData[key];
                    if (typeof value === 'number' && !isNaN(value)) {
                        numberCount++;
                        if (numberCount === 1 && result.plays === null) {
                            result.plays = value;
                            console.log(`⚠️ 按位置推測投幣欄位: "${key}" = ${result.plays}`);
                        } else if (numberCount === 2 && result.payouts === null) {
                            result.payouts = value;
                            console.log(`⚠️ 按位置推測出貨欄位: "${key}" = ${result.payouts}`);
                        }
                    }
                }
            }
            
            return result;
        }
        
        // 更新 UI 顯示機台數據 - 支持多 devid
        function updateMachineDataDisplay(machineData, devid = null) {
            console.log('🖼️ 更新 UI 顯示:', machineData, 'devid:', devid);
            
            if (!machineData) {
                console.warn('⚠️ 無效的數據對象');
                return;
            }
            
            // 查找命令記錄容器的父容器
            const commandLogParent = document.getElementById('mqtt-command-log')?.parentElement;
            if (!commandLogParent) {
                console.warn('⚠️ 找不到命令記錄容器');
                return;
            }
            
            // 根據 devid 生成唯一的容器 ID
            const containerId = devid ? `machine-data-display-devid-${devid}` : 'machine-data-display';
            const displayLabel = devid ? `天車 ${devid === 1 ? '左' : devid === 2 ? '右' : devid}` : '機台';
            
            // 查找或創建顯示容器
            let displayContainer = document.getElementById(containerId);
            
            if (!displayContainer) {
                // 創建新的顯示容器
                displayContainer = document.createElement('div');
                displayContainer.id = containerId;
                displayContainer.className = 'mt-4 p-4 bg-gray-800/50 rounded-lg border-l-4 border-blue-500';
                
                // 插入到命令記錄容器的下方
                commandLogParent.appendChild(displayContainer);
                console.log(`✅ 已創建 ${displayLabel} 數據顯示容器`);
            }
            
            // 構建 HTML 內容
            let html = `<h4 class="text-sm font-medium text-yellow-300 mb-3">📊 ${displayLabel}數據解析結果</h4>`;
            
            // 檢查是否有有效的數據
            const hasValidData = machineData.plays !== null || machineData.payouts !== null;
            const isReReadData = machineData.format === 're_readdata';
            
            // 如果是 re_readdata 但沒有提取到數據
            if (isReReadData && !hasValidData && machineData.hasData === false) {
                html += `
                    <div class="bg-yellow-900/40 p-4 rounded-lg border border-yellow-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-yellow-300">⚠️ 無資訊更新</div>
                            <div class="text-xs text-yellow-200 mt-2">無法從伺服器回應中解析有效的投幣或出獎數據</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>命令: ${machineData.raw.cmd || 'N/A'}</div>
                                <div>MAC: ${machineData.raw.mac || 'N/A'}</div>
                                <div>格式: ${machineData.format} | 時間: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!hasValidData) {
                // 如果是其他格式且沒有有效的數據
                html += `
                    <div class="bg-orange-900/40 p-4 rounded-lg border border-orange-500/50">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-orange-300">⚠️ 無法識別數據</div>
                            <div class="text-xs text-orange-200 mt-2">無法從伺服器回應中提取投幣或出獎信息</div>
                            <div class="text-xs text-gray-400 mt-3">
                                <div>格式: ${machineData.format} | 時間: ${machineData.timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // 有效的數據顯示
                html += '<div class="grid grid-cols-2 gap-4 mb-3">';
                
                // 顯示投幣數
                if (machineData.plays !== null) {
                    html += `
                        <div class="bg-blue-900/50 p-4 rounded-lg border border-blue-500/50">
                            <div class="text-xs text-blue-300 font-semibold mb-1">✅ 投幣遊戲次數</div>
                            <div class="text-3xl font-bold text-blue-300">${machineData.plays.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">投幣遊戲次數</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                // 顯示出貨次數
                if (machineData.payouts !== null) {
                    html += `
                        <div class="bg-green-900/50 p-4 rounded-lg border border-green-500/50">
                            <div class="text-xs text-green-300 font-semibold mb-1">✅ 禮品出獎次數</div>
                            <div class="text-3xl font-bold text-green-300">${machineData.payouts.toLocaleString()}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/30">
                            <div class="text-xs text-gray-400 font-semibold mb-1">禮品出獎次數</div>
                            <div class="text-lg font-bold text-gray-500">N/A</div>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            // 顯示數據格式和時間戳
            const statusColor = isReReadData && !hasValidData ? 'text-yellow-400' : 'text-cyan-400';
            html += `<div class="text-xs text-gray-400 bg-gray-900/50 p-2 rounded">
                <div>格式: <span class="${statusColor} font-semibold">${machineData.format}</span> | 時間: <span class="text-cyan-400 font-semibold">${machineData.timestamp}</span></div>
            </div>`;
            
            displayContainer.innerHTML = html;
            
            if (hasValidData) {
                console.log('✅ UI 已成功更新 - 投幣數: ' + machineData.plays + ', 出獎數: ' + machineData.payouts);
            } else {
                console.log('⚠️ 無法提取有效的數據');
            }
        }
        
        // 開始 HTTP 輪詢
        function startHttpPolling() {
            if (httpPollingTimer) {
                console.log('⚠️ HTTP 輪詢已在運行中');
                return;
            }
            
            httpPollingEnabled = true;
            console.log(`🚀 開始 HTTP 輪詢（間隔: ${httpPollingInterval}ms）`);
            updateHttpStatus(true, '輪詢中...');
            
            // 立即發送第一次請求
            sendHttpRequest();
            
            // 設定定時輪詢
            httpPollingTimer = setInterval(() => {
                if (httpPollingEnabled) {
                    sendHttpRequest();
                }
            }, httpPollingInterval);
        }
        
        // 停止 HTTP 輪詢
        function stopHttpPolling() {
            if (httpPollingTimer) {
                clearInterval(httpPollingTimer);
                httpPollingTimer = null;
            }
            
            httpPollingEnabled = false;
            console.log('⏹️ HTTP 輪詢已停止');
            updateHttpStatus(false, '已停止');
        }
        
        // 更新 HTTP 連線狀態顯示
        function updateHttpStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator'); // 暫時使用 MQTT 的元素
            const statusText = document.getElementById('mqtt-status-text');
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                }
                if (statusText) {
                    statusText.textContent = `✅ HTTP 連線中 - ${message} - ${timeStr}`;
                }
            } else {
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                }
                if (statusText) {
                    statusText.textContent = `❌ HTTP 未連線 - ${message} - ${timeStr}`;
                }
            }
            
            console.log(`📊 HTTP 狀態: ${connected ? '連線中' : '未連線'} - ${message}`);
        }
        
        // 測試 HTTP 連線
        async function testHttpConnection() {
            console.log('🧪 測試 HTTP 連線...');
            console.log('📍 目標 URL:', buildHttpUrl());
            console.log('🌐 當前域名:', window.location.origin);
            
            const result = await sendHttpRequest();
            
            if (result) {
                console.log('✅ HTTP 連線測試成功');
                alert('✅ HTTP 連線測試成功！\n\n數據已成功返回');
            } else {
                console.log('❌ HTTP 連線測試失敗');
                alert('❌ HTTP 連線測試失敗\n\n建議：\n1. 檢查目標伺服器是否在線\n2. 查看瀏覽器控制台 (F12) 的 Console 選項卡\n3. 確認網路連接是否正常');
            }
        }
        
        // 診斷 HTTP 連線問題
        async function diagnoseHttpConnection() {
            console.clear();
            console.log('🔍 ===== HTTP 連線診斷開始 =====');
            console.log('⏰ 診斷時間:', new Date().toLocaleString('zh-TW'));
            console.log('');
            
            console.log('📋 === 環境信息 ===');
            console.log('🌐 當前頁面 URL:', window.location.href);
            console.log('📍 當前域名:', window.location.hostname);
            console.log('🔗 當前協議:', window.location.protocol);
            console.log('');
            
            console.log('🎯 === 目標伺服器信息 ===');
            const targetUrl = buildHttpUrl();
            console.log('🔗 目標 URL:', targetUrl);
            console.log('📡 伺服器位址:', httpConfig.baseUrl);
            console.log('🔌 API 端點:', httpConfig.endpoint);
            console.log('');
            
            console.log('🧪 === 連線測試 ===');
            console.log('📤 嘗試直接請求...');
            
            try {
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });
                console.log('✅ 直接請求成功！');
                console.log('📊 HTTP 狀態碼:', response.status);
                console.log('📋 Content-Type:', response.headers.get('content-type'));
                const data = await response.text();
                console.log('📥 收到資料長度:', data.length, '字元');
                console.log('📄 資料預覽:', data.substring(0, 200));
            } catch (directError) {
                console.warn('❌ 直接請求失敗:', directError.message);
                console.log('🔄 嘗試代理服務...');
                
                // 嘗試最簡單的代理
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    console.log('🚀 代理 URL:', proxyUrl.substring(0, 100) + '...');
                    
                    const proxyResponse = await fetch(proxyUrl, {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        console.log('✅ 代理請求成功！');
                        console.log('📝 代理回應:', proxyData.contents.substring(0, 200));
                    } else {
                        console.error('❌ 代理返回 HTTP', proxyResponse.status);
                    }
                } catch (proxyError) {
                    console.error('❌ 代理請求也失敗:', proxyError.message);
                    console.error('💥 根本原因：', proxyError.name);
                    
                    if (proxyError.message.includes('ERR_NAME_NOT_RESOLVED')) {
                        console.error('🔴 DNS 解析失敗 - 可能的原因：');
                        console.error('  • 網路連線中斷');
                        console.error('  • 域名伺服器無響應');
                        console.error('  • 防火牆或代理阻止');
                    }
                }
            }
            
            console.log('');
            console.log('🔍 ===== 診斷結束 =====');
        }
        
        // 把診斷函數暴露到全域
        window.diagnoseHttpConnection = diagnoseHttpConnection;
        
        // 讓 HTTP 函數在全域範圍可用
        window.startHttpPolling = startHttpPolling;
        window.stopHttpPolling = stopHttpPolling;
        window.testHttpConnection = testHttpConnection;
        window.sendHttpRequest = sendHttpRequest;
        
        // ========================================
        // MQTT 配置（已棄用）
        // ========================================
        const mqttConfig = {
            keepalive: 60,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30000,
            will: {
                topic: 'client/disconnect',
                payload: 'Client Disconnected',
                qos: 0,
                retain: false
            }
        };
        
        // MQTT 連線狀態管理
        function updateMqttStatus(connected, message = '') {
            const indicator = document.getElementById('mqtt-status-indicator');
            const statusText = document.getElementById('mqtt-status-text');
            const connectBtn = document.getElementById('mqtt-connect-btn');
            const testBtn = document.getElementById('mqtt-test-btn');
            const diagnoseBtn = document.getElementById('mqtt-diagnose-btn');
            const businessTestBtn = document.getElementById('mqtt-business-test-btn');
            const readBtn = document.getElementById('send-read-command');
            
            // 更新最後更新時間
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            const updateElement = document.getElementById('mqtt-last-update');
            if (updateElement) {
                updateElement.textContent = timeStr;
            }
            
            if (connected) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                statusText.textContent = '✅ 已連接 - ' + timeStr;
                connectBtn.innerHTML = '<span>中斷連接</span>';
                connectBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // 啟用測試按鈕、診斷按鈕、營業測試按鈕和讀取按鈕
                if (testBtn) {
                    testBtn.disabled = false;
                    testBtn.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = false;
                    diagnoseBtn.className = 'flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = false;
                    businessTestBtn.className = 'flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = false;
                    readBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition';
                }
                
                // 重置重連次數
                mqttReconnectAttempts = 0;
                
                // 啟動心跳檢測
                startMqttHeartbeat();
                
            } else {
                // 根據狀態設置不同的指示器和訊息
                if (message && (message.includes('連線中') || message.includes('建立'))) {
                    indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-spin';
                    statusText.textContent = '🔄 ' + message;
                } else if (message && message.includes('超時')) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = '⏰ ' + message;
                } else if (message && (message.includes('錯誤') || message.includes('失敗'))) {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = '❌ ' + message;
                } else {
                    indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = message || '❌ 未連接';
                }
                
                connectBtn.innerHTML = '<span>連接 MQTT</span>';
                connectBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition text-xs';
                
                // 禁用測試按鈕、診斷按鈕、營業測試按鈕和讀取按鈕
                if (testBtn) {
                    testBtn.disabled = true;
                    testBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (diagnoseBtn) {
                    diagnoseBtn.disabled = true;
                    diagnoseBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (businessTestBtn) {
                    businessTestBtn.disabled = true;
                    businessTestBtn.className = 'flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed text-xs';
                }
                if (readBtn) {
                    readBtn.disabled = true;
                    readBtn.className = 'w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition cursor-not-allowed';
                }
                
                // 停止心跳檢測
                stopMqttHeartbeat();
            }
            
            mqttConnected = connected;
            window.mqttConnected = connected; // 同步到全域變數
            
            // 控制台日誌
            console.log('MQTT 狀態更新: ' + (connected ? '已連接' : '未連接') + (message ? ' - ' + message : '') + ' (' + timeStr + ')');
        }
        
        // 添加命令日誌
        function addCommandLog(type, message, data = null) {
            const logContainer = document.getElementById('mqtt-command-log');
            if (!logContainer) return;
            
            // 如果是第一條訊息，清除預設文字
            if (logContainer.querySelector('.text-gray-500')) {
                logContainer.innerHTML = '';
            }
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            
            // 🎨 改進顏色邏輯: success 也顯示為綠色
            let bgClass, borderClass, icon;
            if (type === 'send') {
                bgClass = 'bg-blue-900/30';
                borderClass = 'border-blue-500/30';
                icon = '📤';
            } else if (type === 'receive' || type === 'success') {
                bgClass = 'bg-green-900/30';
                borderClass = 'border-green-500/30';
                icon = type === 'receive' ? '📥' : '✅';
            } else {
                bgClass = 'bg-red-900/30';
                borderClass = 'border-red-500/30';
                icon = '❌';
            }
            
            logEntry.className = `text-xs p-2 rounded-lg ${bgClass} border ${borderClass}`;
            
            let content = `<div class="flex items-start space-x-2">
                <span>${icon}</span>
                <div class="flex-1">
                    <p class="font-medium">[${timestamp}] ${message}</p>`;
            
            if (data) {
                content += `<pre class="mt-1 text-xs bg-gray-900/50 p-1 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            content += `</div></div>`;
            logEntry.innerHTML = content;
            
            // 添加到日誌容器
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // 限制日誌數量
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // 啟動 MQTT 心跳檢測
        function startMqttHeartbeat() {
            stopMqttHeartbeat(); // 先停止現有的心跳
            
            mqttHeartbeatTimer = setInterval(function() {
                if (mqttClient && mqttConnected) {
                    try {
                        // 發送 ping 測試連線狀態
                        const pingTopic = 'system/ping';
                        const pingMessage = {
                            timestamp: new Date().toISOString(),
                            clientId: 'webapp_' + Date.now()
                        };
                        
                        mqttClient.publish(pingTopic, JSON.stringify(pingMessage), { qos: 0 }, function(err) {
                            if (err) {
                                console.warn('MQTT 心跳失敗:', err);
                                // 心跳失敗，可能需要重連
                                if (mqttAutoReconnect) {
                                    reconnectMqtt();
                                }
                            } else {
                                console.log('✓ MQTT 心跳正常');
                            }
                        });
                    } catch (error) {
                        console.error('MQTT 心跳檢測錯誤:', error);
                        if (mqttAutoReconnect) {
                            reconnectMqtt();
                        }
                    }
                }
            }, mqttHeartbeatInterval);
        }
        
        // 停止 MQTT 心跳檢測
        function stopMqttHeartbeat() {
            if (mqttHeartbeatTimer) {
                clearInterval(mqttHeartbeatTimer);
                mqttHeartbeatTimer = null;
            }
        }
        
        // MQTT 自動重連
        function reconnectMqtt() {
            if (!mqttAutoReconnect || mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                console.log('停止 MQTT 重連 - 超過最大重試次數');
                updateMqttStatus(false, '重連失敗 - 超過最大重試次數');
                return;
            }
            
            mqttReconnectAttempts++;
            console.log('MQTT 重連嘗試 ' + mqttReconnectAttempts + '/' + mqttMaxReconnectAttempts);
            
            updateMqttStatus(false, '重連中... (第 ' + mqttReconnectAttempts + ' 次)');
            
            // 清理現有連線
            if (mqttClient) {
                try {
                    mqttClient.end(true); // 強制關閉
                } catch (error) {
                    console.warn('關閉 MQTT 客戶端時發生錯誤:', error);
                }
                mqttClient = null;
            }
            
            // 根據伺服器類型決定重試間隔
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            let reconnectDelay = mqttReconnectInterval; // 預設 5 秒
            
            if (brokerUrl.includes('update.feiloli.com.tw')) {
                // 原伺服器使用更長的重試間隔
                reconnectDelay = mqttReconnectIntervalOriginal; // 30 秒
                console.log('⏰ 原伺服器重連間隔：30 秒');
                updateMqttStatus(false, '等待 30 秒後重試原伺服器... (第 ' + mqttReconnectAttempts + ' 次)');
                addCommandLog('error', `⏰ 原伺服器無法連線，將在 30 秒後重試（第 ${mqttReconnectAttempts} 次）`);
            } else {
                console.log('⏰ 重連間隔：5 秒');
            }
            
            // 延遲後重新連線
            mqttReconnectTimer = setTimeout(function() {
                connectMqtt();
            }, reconnectDelay);
        }
        
        // 停止 MQTT 重連
        function stopMqttReconnect() {
            if (mqttReconnectTimer) {
                clearTimeout(mqttReconnectTimer);
                mqttReconnectTimer = null;
            }
        }
        
        // 主要 MQTT 連線函數
        function connectMqtt() {
            const brokerUrl = document.getElementById('mqtt-broker-url').value;
            const topic = document.getElementById('mqtt-topic').value;
            
            if (!brokerUrl) {
                alert('請輸入 MQTT Broker 位址');
                return;
            }
            
            try {
                updateMqttStatus(false, '建立連線中...');
                console.log('開始連線到:', brokerUrl);
                
                // 自動偵測並修正協議（HTTPS 頁面需要使用 wss://）
                let finalBrokerUrl = brokerUrl;
                if (window.location.protocol === 'https:' && brokerUrl.startsWith('ws://')) {
                    finalBrokerUrl = brokerUrl.replace('ws://', 'wss://');
                    console.log('⚠️ 偵測到 HTTPS 頁面，自動將 ws:// 轉換為 wss://');
                    console.log('原始 URL:', brokerUrl);
                    console.log('修正後 URL:', finalBrokerUrl);
                    addCommandLog('error', '⚠️ HTTPS 安全限制：自動將 ws:// 轉為 wss://');
                }
                
                // 根據不同的伺服器調整配置
                let customConfig = {...mqttConfig};
                
                // HiveMQ 需要特殊配置
                if (finalBrokerUrl.includes('broker.hivemq.com')) {
                    customConfig = {
                        keepalive: 60,
                        clean: true,
                        reconnectPeriod: 5000,
                        connectTimeout: 10000,
                        clientId: 'mqtt_client_' + Math.random().toString(16).substr(2, 8)
                    };
                    console.log('使用 HiveMQ 配置');
                } else if (finalBrokerUrl.includes('test.mosquitto.org')) {
                    customConfig.connectTimeout = 8000;
                    console.log('使用 Mosquitto 配置');
                } else if (finalBrokerUrl.includes('broker.emqx.io')) {
                    customConfig.connectTimeout = 8000;
                    console.log('使用 EMQX 配置');
                }
                
                // 創建 MQTT 客戶端
                console.log('最終連線 URL:', finalBrokerUrl);
                mqttClient = mqtt.connect(finalBrokerUrl, customConfig);
                window.mqttClient = mqttClient; // 同步到全域變數
                console.log('MQTT 客戶端已創建並設為全域');
                
                // 設置連線超時
                const connectTimeout = setTimeout(function() {
                    if (!mqttConnected) {
                        const isOriginalServer = finalBrokerUrl.includes('update.feiloli.com.tw');
                        
                        console.error('❌ MQTT 連線超時 (30秒)');
                        
                        if (isOriginalServer) {
                            updateMqttStatus(false, '原伺服器連線超時 - 伺服器可能離線或網路不通');
                            addCommandLog('error', '❌ 原伺服器 (update.feiloli.com.tw:5438) 連線超時，將在 30 秒後重試');
                        } else {
                            updateMqttStatus(false, '連線超時 - 請檢查伺服器地址或網路連線');
                            addCommandLog('error', '連線超時：無法在 30 秒內建立連線');
                        }
                        
                        if (mqttClient) {
                            try {
                                mqttClient.end(true);
                            } catch (e) {
                                console.warn('結束客戶端時發生錯誤:', e);
                            }
                        }
                        
                        // 如果是原伺服器且未自動重連，詢問是否切換
                        if (isOriginalServer && !mqttAutoReconnect) {
                            if (confirm('原伺服器目前無法連線！\n\n是否要切換到 HiveMQ 公開測試伺服器？\n\n（系統將自動每 30 秒重試原伺服器）')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        } else if (!isOriginalServer) {
                            // 非原伺服器超時，詢問切換到 HiveMQ
                            if (confirm('連線超時！\n\n是否要切換到 HiveMQ 公開伺服器？')) {
                                setMqttServer('hivemq');
                                setTimeout(() => connectMqtt(), 1000);
                            }
                        }
                    }
                }, 30000);
                
                // 連線成功事件
                mqttClient.on('connect', function() {
                    clearTimeout(connectTimeout);
                    console.log('✅ MQTT 連線成功！');
                    
                    // 確保全域變數同步
                    window.mqttClient = mqttClient;
                    window.mqttConnected = true;
                    console.log('✅ 全域 MQTT 變數已同步');
                    
                    updateMqttStatus(true, '連線成功');
                    addCommandLog('receive', '✅ MQTT 連線建立成功');
                    
                    // 訂閱主題
                    mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('訂閱主題失敗:', err);
                            addCommandLog('error', '訂閱主題失敗: ' + topic);
                        } else {
                            console.log('✅ 訂閱主題成功:', topic);
                            addCommandLog('receive', '✅ 已訂閱主題: ' + topic);
                        }
                    });
                    
                    // 額外訂閱一些可能的回應主題進行測試
                    const additionalTopics = ['coffeelens/+', 'machine/+', 'device/+', 'test/echo'];
                    additionalTopics.forEach(additionalTopic => {
                        mqttClient.subscribe(additionalTopic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn('訂閱額外主題失敗:', additionalTopic, err);
                            } else {
                                console.log('✅ 訂閱額外主題成功:', additionalTopic);
                            }
                        });
                    });
                });
                
                // 訊息接收事件
                mqttClient.on('message', function(topic, message) {
                    console.log('🔥 收到任何 MQTT 訊息:', { topic, message: message.toString() });
                    try {
                        handleMqttMessage(topic, message.toString());
                    } catch (error) {
                        console.error('處理 MQTT 訊息時發生錯誤:', error);
                        addCommandLog('error', '訊息處理錯誤: ' + error.message);
                    }
                });
                
                // 錯誤事件
                mqttClient.on('error', function(error) {
                    clearTimeout(connectTimeout);
                    console.error('❌ MQTT 錯誤:', error);
                    
                    const brokerUrl = document.getElementById('mqtt-broker-url').value;
                    const isOriginalServer = brokerUrl.includes('update.feiloli.com.tw');
                    
                    let errorMsg = error.message || '未知錯誤';
                    if (errorMsg.includes('connack timeout')) {
                        errorMsg = '連線超時 - 伺服器未回應';
                        if (isOriginalServer) {
                            errorMsg += ' (原伺服器目前無法連線，將在 30 秒後重試)';
                        }
                    } else if (errorMsg.includes('Connection refused')) {
                        errorMsg = '連線被拒 - 請檢查伺服器地址';
                    } else if (errorMsg.includes('getaddrinfo ENOTFOUND')) {
                        errorMsg = '找不到伺服器 - 請檢查網址是否正確';
                    }
                    
                    updateMqttStatus(false, '連線錯誤: ' + errorMsg);
                    addCommandLog('error', '❌ MQTT 錯誤: ' + errorMsg);
                    
                    // 如果是原伺服器，建議切換
                    if (isOriginalServer && mqttReconnectAttempts >= 3) {
                        addCommandLog('error', '💡 建議：原伺服器連線失敗多次，可點擊「⭐ HiveMQ 公開」切換到測試伺服器');
                    }
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        const retryDelay = isOriginalServer ? 3000 : 2000;
                        setTimeout(function() {
                            reconnectMqtt();
                        }, retryDelay);
                    } else if (mqttReconnectAttempts >= mqttMaxReconnectAttempts) {
                        addCommandLog('error', `❌ 已達最大重試次數 (${mqttMaxReconnectAttempts} 次)，請手動重新連線或切換伺服器`);
                    }
                });
                
                // 連線關閉事件
                mqttClient.on('close', function() {
                    clearTimeout(connectTimeout);
                    console.log('🔌 MQTT 連線已關閉');
                    updateMqttStatus(false, '連線已關閉');
                    
                    if (mqttAutoReconnect && mqttReconnectAttempts < mqttMaxReconnectAttempts) {
                        setTimeout(function() {
                            reconnectMqtt();
                        }, 1000);
                    }
                });
                
                // 離線事件
                mqttClient.on('offline', function() {
                    console.warn('⚠️ MQTT 客戶端離線');
                    updateMqttStatus(false, '客戶端離線');
                });
                
                // 重連事件
                mqttClient.on('reconnect', function() {
                    console.log('🔄 MQTT 正在重連...');
                    updateMqttStatus(false, '正在重連...');
                });
                
            } catch (error) {
                console.error('❌ MQTT 連線初始化失敗:', error);
                updateMqttStatus(false, '初始化失敗: ' + error.message);
            }
        }
        
        // 斷開 MQTT 連線
        function disconnectMqtt() {
            console.log('執行 MQTT 斷開連接');
            mqttAutoReconnect = false; // 停止自動重連
            stopMqttReconnect(); // 停止重連定時器
            stopMqttHeartbeat(); // 停止心跳檢測
            
            if (mqttClient) {
                try {
                    mqttClient.end();
                    mqttClient = null;
                } catch (error) {
                    console.error('斷開 MQTT 連線時發生錯誤:', error);
                }
            }
            
            // 清理全域變數
            window.mqttClient = null;
            window.mqttConnected = false;
            console.log('✅ 全域 MQTT 變數已清理');
            
            updateMqttStatus(false, '已斷開連線');
            mqttReconnectAttempts = 0;
        }
        
        // 解析娃娃機 MQTT 資料
        function parseMachineData(hexData) {
            // 解析娃娃機回傳的 hex 資料
            try {
                if (!hexData || hexData.length < 2) { // 至少需要 1 byte (2 hex chars)
                    console.warn('資料長度不足:', hexData?.length);
                    return null;
                }
                
                console.log('收到機台資料，長度:', hexData.length, '內容:', hexData);
                
                // 處理簡短的狀態回應（如 "1"）
                if (hexData.length < 20) {
                    return {
                        rawHex: hexData,
                        statusCode: parseInt(hexData, 16),
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: true,
                        message: `收到狀態碼: ${hexData}`
                    };
                }
                
                // 將 hex 字串轉換為 bytes
                const bytes = [];
                for (let i = 0; i < hexData.length; i += 2) {
                    bytes.push(parseInt(hexData.substr(i, 2), 16));
                }
                
                // 根據您提供的協議解析所有資料
                const data = {
                    // 基本帳務資料
                    coinCount: 0,
                    payoutCount: 0,
                    
                    // 詳細電壓資料 (Byte33-38)
                    voltageData: {
                        strongVoltage: bytes[33] || 0,        // B1.強電壓
                        mediumVoltage: bytes[34] || 0,        // B2.中電壓  
                        weakVoltage: bytes[35] || 0,          // B3.弱電壓
                        heightToTop: bytes[36] || 0,          // B4.中壓距離頂點高度
                        clampVoltage: bytes[37] || 0          // B5.保夾強電壓
                    },
                    
                    // 營運資料 (Byte39-48)
                    operationData: {
                        winRateBank: (bytes[40] << 8) | bytes[39],          // C1.中獎率銀行
                        coinGameCount: (bytes[42] << 8) | bytes[41],        // C2.投幣遊戲次數
                        prizeCount: (bytes[44] << 8) | bytes[43],           // C3.禮品出獎次數
                        accumulatedAmount1: (bytes[46] << 8) | bytes[45],   // C4.累加金額查詢第1筆
                        accumulatedAmount2: (bytes[48] << 8) | bytes[47],   // C4.累加金額查詢第2筆
                        accumulatedAmount3: (bytes[50] << 8) | bytes[49]    // C4.累加金額查詢第3筆
                    },
                    
                    // 原始 bytes 陣列供除錯使用
                    rawBytes: bytes,
                    rawHex: hexData,
                    parseTime: new Date().toLocaleString()
                };
                
                // 解析基本投幣和出貨數據 (假設在前面的 bytes)
                if (bytes.length >= 10) {
                    data.coinCount = bytes[2] | (bytes[3] << 8) | (bytes[4] << 16) | (bytes[5] << 24);
                    data.payoutCount = bytes[6] | (bytes[7] << 8) | (bytes[8] << 16) | (bytes[9] << 24);
                }
                
                console.log('完整解析機台資料:', data);
                return data;
                
            } catch (error) {
                console.error('解析機台資料失敗:', error);
                return null;
            }
        }
        
        // 處理 MQTT 訊息
        function handleMqttMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                document.getElementById('last-mqtt-update').textContent = new Date().toLocaleString();
                
                // 檢查是否為機台狀態回應（包含 machine_name, machine_ip 等）
                if (data.machine_name && data.machine_ip) {
                    console.log('🎯 收到機台狀態回應:', data);
                    addCommandLog('receive', `收到機台狀態 - ${data.machine_name} (${data.machine_ip})`, data);
                    
                    // 顯示機台狀態資訊
                    showStatusMessage(`機台 ${data.machine_name} 回應: CPU ${data.cpu_usage}%, 記憶體 ${data.memory_usage}%, 儲存 ${data.storage_usage}%`, 'success');
                    
                    // 嘗試根據 IP 或名稱找到對應的機台
                    const matchedMachine = appData.machines.find(m => 
                        m.ip === data.machine_ip || 
                        m.name === data.machine_name ||
                        m.id === data.machine_name
                    );
                    
                    if (matchedMachine) {
                        console.log('✅ 找到對應機台:', matchedMachine);
                        // 更新機台狀態資訊
                        matchedMachine.lastResponse = new Date().toISOString();
                        matchedMachine.status = {
                            cpu_usage: data.cpu_usage,
                            memory_usage: data.memory_usage,
                            storage_usage: data.storage_usage,
                            machine_ip: data.machine_ip
                        };
                    } else {
                        console.log('⚠️ 無法匹配機台，建議添加機台記錄');
                        addCommandLog('receive', '⚠️ 機台回應但未在系統中找到對應記錄');
                    }
                    
                    return; // 直接返回，不需要進一步處理
                }
                
                // 記錄收到的訊息到命令日誌
                if (data.cmd === 're_readdata') {
                    addCommandLog('receive', `收到讀取回應 - MAC: ${data.mac}, 設備ID: ${data.devid}, 任務ID: ${data.taskid}`, data);
                    
                    // 顯示資料長度
                    if (data.parm) {
                        const byteLength = data.parm.length / 2;
                        console.log(`✅ 收到 ${byteLength} 位元組資料`);
                    }
                } else {
                    addCommandLog('receive', `收到訊息 - 命令: ${data.cmd || '未知'}`, data);
                }
                
                // 處理機台回應資料
                if ((data.cmd === 're_readdata' || data.cmd === 're_stat') && data.parm) {
                    console.log(`收到 ${data.cmd} 回應，MAC: ${data.mac}, 資料: ${data.parm}`);
                    
                    const machineData = parseMachineData(data.parm);
                    console.log('解析後的機台資料:', machineData);
                    
                    if (machineData) {
                        // 根據 MAC 位址找到對應的機台
                        const machineInfo = findMachineByMac(data.mac);
                        console.log('尋找機台結果:', machineInfo);
                        
                        if (machineInfo) {
                            console.log('找到對應機台:', machineInfo.id);
                            
                            // 如果只是狀態回應，顯示簡化信息，但仍然顯示詳細面板
                            if (machineData.isStatusOnly) {
                                console.log('這是狀態回應，顯示狀態和詳細面板');
                                showStatusMessage(`機台 ${machineInfo.id} 狀態: ${machineData.message}`, 'info');
                                // 即使是狀態回應也顯示詳細面板
                                showMachineDetailPanel(machineInfo, machineData);
                            } else {
                                console.log('這是完整資料回應，更新機台資料');
                                updateMachineFromMqtt(machineInfo, machineData);
                            }
                        } else {
                            console.warn('找不到 MAC 對應的機台:', data.mac);
                            console.log('目前機台列表:', appData.machines.map(m => ({ id: m.id, mac: m.mac })));
                            showStatusMessage(`收到未知機台 ${data.mac} 的回應`, 'info');
                        }
                    } else {
                        console.warn('無法解析機台資料:', data.parm);
                    }
                }
                
                console.log('收到 MQTT 訊息:', { topic, data });
            } catch (error) {
                console.error('處理 MQTT 訊息失敗:', error);
                addCommandLog('error', '訊息處理失敗: ' + error.message);
            }
        }
        
        // 根據 MAC 位址找機台
        function findMachineByMac(mac) {
            return appData.machines.find(machine => machine.mac === mac);
        }
        
        // 從 MQTT 資料更新機台資訊
        function updateMachineFromMqtt(machine, mqttData) {
            console.log('=== 開始更新機台資料 ===');
            console.log('機台資訊:', machine);
            console.log('MQTT 資料:', mqttData);
            
            // 計算新增的投幣和出貨數
            const newCoins = Math.max(0, mqttData.coinCount - (machine.mqttLastCoinCount || 0));
            const newPayouts = Math.max(0, mqttData.payoutCount - (machine.mqttLastPayoutCount || 0));
            
            // 儲存完整的 MQTT 資料到機台物件
            machine.mqttDetailData = mqttData;
            
            console.log('準備顯示機台詳細資料面板...');
            // 顯示詳細資料面板
            showMachineDetailPanel(machine, mqttData);
            
            if (newCoins > 0 || newPayouts > 0) {
                // 自動新增記帳記錄
                const today = new Date().toISOString().split('T')[0];
                addMqttRecord(machine.id, today, newCoins * COIN_VALUE, newPayouts);
                
                // 更新機台的 MQTT 計數器
                machine.mqttLastCoinCount = mqttData.coinCount;
                machine.mqttLastPayoutCount = mqttData.payoutCount;
                
                // 儲存到 Firebase
                saveMachineData();
                
                console.log(`機台 ${machine.id} MQTT 自動更新: +${newCoins}幣 +${newPayouts}貨`);
            }
        }
        
        // 自動新增 MQTT 記錄
        function addMqttRecord(machineId, date, revenue, payouts) {
            const existingRecord = appData.history.find(r => 
                r.machineId === machineId && r.date === date
            );
            
            if (existingRecord) {
                // 更新現有記錄
                existingRecord.totalRevenue += revenue;
                existingRecord.totalPayouts += payouts;
            } else {
                // 新增記錄
                appData.history.push({
                    id: Date.now().toString(),
                    machineId,
                    date,
                    totalRevenue: revenue,
                    totalPayouts: payouts,
                    autoAdded: true // 標記為自動新增
                });
            }
            
            saveHistoryData();
            refreshCurrentView();
        }

        // --- END: MQTT 功能 ---

        // --- GLOBAL STATE ---
        const COIN_VALUE = 10;
        let appData = { machines: [], history: [], startDate: '' };
        let currentSort = { key: 'id', direction: 'asc' };
        let selectedGroupId = null;
        let selectedGroupName = '';
        let selectedStoreId = null; 
        let selectedStoreName = ''; 
        let confirmCallback = null;

        function normalizeCount(value) {
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : 0;
        }
        
        // 自動輪詢設定
    let autoPollOnLoadTimer = null;
    const AUTO_POLL_DELAY = 1000; // 1秒延遲
    let suppressNextAutoPoll = false;
        
        // 🚀 自動輪詢設定管理函數
        function getAutoPollOnLoadSetting() {
            const key = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            const saved = localStorage.getItem(key);
            return saved === 'true';
        }
        
        function setAutoPollOnLoadSetting(enabled) {
            const key = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            localStorage.setItem(key, enabled.toString());
            console.log(`💾 自動輪詢設定已保存: ${key} = ${enabled}`);
        }
        
        // ⚡ 直接讀取所有機台數據 (不發送訊息,不等待,用於自動輪詢)
        async function directReadAllMachines() {
            console.log('\n' + '='.repeat(70));
            console.log('⚡ 直接讀取模式 (不發送訊息,立即讀取)');
            console.log('='.repeat(70));
            
            const startTime = Date.now();
            
            // 獲取當前門市的所有機台
            if (!appData.machines || appData.machines.length === 0) {
                showStatusMessage('❌ 當前門市沒有可輪詢的機台', 'error');
                return;
            }
            
            // 收集所有唯一的 MAC 地址
            const uniqueMacs = [...new Set(appData.machines
                .filter(machine => machine.mac && machine.mac.trim() !== '')
                .map(machine => machine.mac))];
            
            console.log(`📋 準備直接讀取 ${uniqueMacs.length} 台機器`);
            showStatusMessage(`🚀 開始直接讀取 ${uniqueMacs.length} 個 MAC 位址...`, 'info');
            
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;
            
            // ============================================
            // ⚡ 並行讀取所有 MAC 的數據 (無等待,立即執行,減少重試)
            // ============================================
            const fetchPromises = uniqueMacs.map(async (mac, index) => {
                try {
                    // 使用較少的重試次數和較短的延遲,提升速度
                    const result = await fetchWithRetry(mac, 1, 500, null); // 只重試1次,間隔500ms
                    
                    if (result && validateMachineData(result)) {
                        console.log(`✅ [${index + 1}/${uniqueMacs.length}] ${mac} - 讀取成功`);
                        
                        handleHttpResponse(result, mac, null);
                        addCommandLog('receive', `直接讀取成功 - MAC: ${mac}`, result);
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`⚠️ [${index + 1}/${uniqueMacs.length}] ${mac} - 讀取失敗`);
                        addCommandLog('error', `直接讀取失敗 - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`❌ [${index + 1}/${uniqueMacs.length}] ${mac} - 異常: ${error.message}`);
                    addCommandLog('error', `直接讀取異常: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // 等待所有讀取完成
            const results = await Promise.all(fetchPromises);
            
            // 統計結果
            const successCount = results.filter(r => r.success).length;
            
            // ============================================
            // 📊 統計結果
            // ============================================
            const endTime = Date.now();
            const pollDuration = ((endTime - startTime) / 1000).toFixed(1);
            
            console.log('='.repeat(70));
            console.log(`📊 直接讀取完成 - ${pollDuration}秒 - 成功: ${successCount}/${uniqueMacs.length}`);
            console.log('='.repeat(70));
            
            const summaryMsg = `✅ 直接讀取完成！⚡ (${pollDuration}秒) - 成功: ${successCount}/${uniqueMacs.length}`;
            
            showStatusMessage(summaryMsg, 'success');
            
            // 刷新表格
            refreshAutoRecordTable();
        }
        
    // 🚀 執行自動輪詢（門市進入後1秒觸發）- 使用優化版並行模式
        function triggerAutoPollOnLoad() {
            console.log('🔍 triggerAutoPollOnLoad 被呼叫');
            console.log(`   selectedGroupId: ${selectedGroupId}`);
            console.log(`   selectedStoreId: ${selectedStoreId}`);
            
            if (!selectedGroupId || !selectedStoreId) {
                console.log('⚠️ 未選擇門市，跳過自動輪詢');
                return;
            }
            
            const isEnabled = getAutoPollOnLoadSetting();
            const settingKey = `autoPollOnLoad_${selectedGroupId}_${selectedStoreId}`;
            console.log(`🔍 檢查自動輪詢設定:`);
            console.log(`   設定鍵值: ${settingKey}`);
            console.log(`   localStorage 值: ${localStorage.getItem(settingKey)}`);
            console.log(`   解析結果: ${isEnabled ? '已啟用' : '已停用'}`);
            
            if (!isEnabled) {
                console.log('⏭️ 自動輪詢功能未啟用，跳過');
                return;
            }
            
            console.log(`🚀 準備使用並行優化模式執行自動輪詢（兩次）...`);
            
            // 顯示開始提示
            showStatusMessage('🚀 開始自動輪詢（第1次，並行優化）...', 'info');
            
            // 清除之前的計時器
            if (autoPollOnLoadTimer) {
                clearTimeout(autoPollOnLoadTimer);
            }
            
            // 立即執行第一次並行輪詢
            autoPollOnLoadTimer = setTimeout(async () => {
                console.log('🎯 開始執行第一次自動輪詢（使用並行優化模式）');
                autoPollOnLoadTimer = null;
                
                try {
                    // 檢查是否有可用的機台
                    if (!appData || !appData.machines || appData.machines.length === 0) {
                        console.log('⚠️ 沒有可用的機台，跳過自動輪詢');
                        showStatusMessage('⚠️ 沒有可用的機台', 'warning');
                        return;
                    }
                    
                    // 執行第一次並行輪詢（使用優化版函數）
                    console.log('🔄 執行第一次並行輪詢（優化版）...');
                    await pollAllMachinesParallel(); // 使用優化版並行函數
                    console.log('✅ 第一次自動輪詢執行完成');
                    
                    // 顯示第一次完成通知
                    showPollNotification('🚀 第一次自動輪詢已完成（並行優化）', 'green');
                    
                    // 等待1秒後執行第二次輪詢
                    console.log('⏳ 等待 1 秒後執行第二次輪詢...');
                    showStatusMessage('⏳ 等待 1 秒後進行第二次輪詢...', 'info');
                    
                    setTimeout(async () => {
                        try {
                            console.log('🔄 執行第二次並行輪詢（優化版）...');
                            showStatusMessage('🚀 開始自動輪詢（第2次，並行優化）...', 'info');
                            
                            await pollAllMachinesParallel(); // 使用優化版並行函數
                            console.log('✅ 第二次自動輪詢執行完成');
                            
                            // 顯示第二次完成通知
                            showPollNotification('✨ 第二次自動輪詢已完成（並行優化）', 'blue');
                            
                        } catch (error) {
                            console.error('❌ 第二次自動輪詢執行失敗:', error);
                            showPollNotification('❌ 第二次自動輪詢失敗', 'red');
                            showStatusMessage('❌ 第二次自動輪詢失敗', 'error');
                        }
                    }, 1000); // 等待1秒
                    
                } catch (error) {
                    console.error('❌ 第一次自動輪詢執行失敗:', error);
                    showPollNotification('❌ 第一次自動輪詢失敗', 'red');
                    showStatusMessage('❌ 第一次自動輪詢失敗', 'error');
                }
            }, 100); // 100ms 後立即開始（幾乎立即）
        }
        
        // 顯示輪詢通知的輔助函數
        function showPollNotification(message, color = 'green') {
            const colorClasses = {
                'green': 'bg-green-600',
                'blue': 'bg-blue-600',
                'red': 'bg-red-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colorClasses[color]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 🚀 清理自動輪詢計時器（切換門市時呼叫）
        function clearAutoPollTimer() {
            if (autoPollOnLoadTimer) {
                clearTimeout(autoPollOnLoadTimer);
                autoPollOnLoadTimer = null;
                console.log('🧹 已清理自動輪詢計時器');
            }
        }
        

        // --- PAGE & ELEMENT SELECTORS ---
        const groupSelectionPage = document.getElementById('group-selection-page');
        const storeSelectionPage = document.getElementById('store-selection-page');
        const reportPage = document.getElementById('report-page');
        const adminPage = document.getElementById('admin-page');
        const commandCenterPage = document.getElementById('command-center-page');
        
        const groupListContainer = document.getElementById('group-list');
        const createGroupForm = document.getElementById('create-group-form');
        const backToGroupsBtn = document.getElementById('back-to-groups-btn');
        const adminBtn = document.getElementById('admin-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');

        const storeListContainer = document.getElementById('store-list');
        const createStoreForm = document.getElementById('create-store-form');
        const backToStoresBtn = document.getElementById('back-to-stores-btn');
        const reportPeriodSelector = document.getElementById('report-period-selector');
        const reportDatePicker = document.getElementById('report-date-picker');
        const downloadAllStoresBtn = document.getElementById('download-all-stores-report-btn');
    const openStoreReportViewBtn = document.getElementById('open-store-report-view-btn');
        const openWeeklyTrendBtn = document.getElementById('open-weekly-trend-btn');
        const openMultiWeeklyTrendBtn = document.getElementById('open-multi-weekly-trend-btn');
        const weeklyTrendStartDate = document.getElementById('weekly-trend-start-date');
        const weeklyTrendEndDate = document.getElementById('weekly-trend-end-date');
        const allTabs = document.querySelectorAll('.tab-btn');
        const allTabContents = document.querySelectorAll('.tab-content');
        const searchInput = document.getElementById('searchInput');
        const sortableHeaders = document.querySelectorAll('.table-header-sortable');
        const statsControls = document.getElementById('stats-controls');
        const summaryControls = document.getElementById('summary-controls');
        const psdControls = document.getElementById('psd-controls');
        const psdCustomRange = document.getElementById('psd-custom-range');
        const psdStartDate = document.getElementById('psd-start-date');
        const psdEndDate = document.getElementById('psd-end-date');
        const psdCalculateBtn = document.getElementById('psd-calculate-btn');
        const psdWeeklyTrendBtn = document.getElementById('psd-weekly-trend-btn');
        const addMachineForm = document.getElementById('add-machine-form');
        const machineListTableBody = document.getElementById('machine-list-table-body');
        const historyTableBody = document.getElementById('history-table-body');
        const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
        const locationPresets = document.getElementById('location-presets');
        const selectAllStoresBtn = document.getElementById('select-all-stores-btn');
        const deselectAllStoresBtn = document.getElementById('deselect-all-stores-btn');
        const pollAllStoresBtn = document.getElementById('poll-all-stores-btn');
        const readAllStoresBtn = document.getElementById('read-all-stores-btn');
        const recalculateAllBtn = document.getElementById('recalculate-all-btn');

        // 管理者界面元素
        const adminPasswordForm = document.getElementById('admin-password-form');
        const guestAccountForm = document.getElementById('guest-account-form');
        const guestAccountsTable = document.getElementById('guest-accounts-table');
        const groupPermissions = document.getElementById('group-permissions');
        const cancelGuestEditBtn = document.getElementById('cancel-guest-edit');
        const exportConfigBtn = document.getElementById('export-config-btn');
        const importConfigBtn = document.getElementById('import-config-btn');
        const resetConfigBtn = document.getElementById('reset-config-btn');
        const configFileInput = document.getElementById('config-file-input');

        
        // Modal selectors
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const editStoreModal = document.getElementById('edit-store-modal');
        const editStoreForm = document.getElementById('edit-store-form');
        const editStoreCancelBtn = document.getElementById('edit-store-cancel-btn');
        
        const cloneStoreModal = document.getElementById('clone-store-modal');
        const cloneStoreForm = document.getElementById('clone-store-form');
        const cloneStoreCancelBtn = document.getElementById('clone-store-cancel-btn');
        
        const editHistoryModal = document.getElementById('edit-history-modal');
        const editHistoryForm = document.getElementById('edit-history-form');
        const editHistoryCancelBtn = document.getElementById('edit-history-cancel-btn');
        
        const editMachineModal = document.getElementById('edit-machine-modal');
        const editMachineForm = document.getElementById('edit-machine-form');
        const editMachineCancelBtn = document.getElementById('edit-machine-cancel-btn');

        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfLoaderOverlay = document.getElementById('pdf-loader-overlay');
        const pdfLoaderText = document.getElementById('pdf-loader-text-overlay');
        
        const checkoutHistoryBody = document.getElementById('checkout-history-body');
        const performCheckoutBtn = document.getElementById('perform-checkout-btn');
        const downloadCheckoutCsvBtn = document.getElementById('download-checkout-csv-btn');
        const headerDownloadButtons = document.getElementById('header-download-buttons');

        // 自定義報表模態視窗元素
        const customReportModal = document.getElementById('custom-report-modal');
        const customReportDownloadBtn = document.getElementById('custom-report-download');
        const customReportCancelBtn = document.getElementById('custom-report-cancel');
        const selectAllReportsBtn = document.getElementById('select-all-reports');
        const selectBasicReportsBtn = document.getElementById('select-basic-reports');
        const selectDetailedReportsBtn = document.getElementById('select-detailed-reports');
        const clearAllReportsBtn = document.getElementById('clear-all-reports');

        // 自定義門市報表模態視窗元素
        const customStoreReportModal = document.getElementById('custom-store-report-modal');
        const customStoreReportDownloadBtn = document.getElementById('custom-store-report-download');
        const customStoreReportCancelBtn = document.getElementById('custom-store-report-cancel');
        const selectAllStoreReportsBtn = document.getElementById('select-all-store-reports');
        const selectBasicStoreReportsBtn = document.getElementById('select-basic-store-reports');
        const selectDetailedStoreReportsBtn = document.getElementById('select-detailed-store-reports');
        const clearAllStoreReportsBtn = document.getElementById('clear-all-store-reports');

        // --- 戰情室相關變數 ---
        let commandCenterData = {
            stores: [],
            lastUpdate: null,
            period: 'week'
        };

        // --- MODAL FUNCTIONS ---
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- CUSTOM REPORT FUNCTIONS ---
        function showCustomReportModal() {
            customReportModal.classList.remove('hidden');
        }

        function hideCustomReportModal() {
            customReportModal.classList.add('hidden');
        }

        function setReportCheckboxes(summary, details, operationSummary, history, analysis, checkout, profit) {
            document.getElementById('include-summary').checked = summary;
            document.getElementById('include-details').checked = details;
            document.getElementById('include-operation-summary').checked = operationSummary;
            document.getElementById('include-history').checked = history;
            document.getElementById('include-analysis').checked = analysis;
            document.getElementById('include-checkout').checked = checkout;
            document.getElementById('include-profit').checked = profit;
        }

        async function generateCustomReport() {
            const includeSummary = document.getElementById('include-summary').checked;
            const includeDetails = document.getElementById('include-details').checked;
            const includeOperationSummary = document.getElementById('include-operation-summary').checked;
            const includeHistory = document.getElementById('include-history').checked;
            const includeAnalysis = document.getElementById('include-analysis').checked;
            const includeCheckout = document.getElementById('include-checkout').checked;
            const includeProfit = document.getElementById('include-profit').checked;
            const format = document.querySelector('input[name="report-format"]:checked').value;

            if (!includeSummary && !includeDetails && !includeOperationSummary && !includeHistory && !includeAnalysis && !includeCheckout && !includeProfit) {
                alert('請至少選擇一項報表內容！');
                return;
            }

            pdfLoaderText.textContent = `正在生成自定義報表 (${format.toUpperCase()})...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const storeName = selectedStoreName || '未知門市';

                if (format === 'csv') {
                    // CSV 格式報表
                    if (includeSummary) {
                        reportData.push('=== 營業摘要統計 ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                        reportData.push('統計項目,數值');
                        reportData.push(`門市名稱,${storeName}`);
                        reportData.push(`統計期間,${appData.startDate} ~ ${new Date().toISOString().split('T')[0]}`);
                        reportData.push(`總投幣次數,${totalPlays}`);
                        reportData.push(`總營業額,${totalRevenue}`);
                        reportData.push(`總出貨次數,${totalPayouts}`);
                        reportData.push(`平均出貨成本,${avgCost.toFixed(2)}`);
                        reportData.push('');
                    }

                    if (includeDetails) {
                        reportData.push('=== 機台詳細資料 ===');
                        reportData.push('機台編號,位置,投幣次數,營業額,出貨次數,平均成本,初始投幣,初始出貨');
                        const processedMachines = appData.machines.map(processMachineData);
                        processedMachines.forEach(machine => {
                            reportData.push(`${machine.id},${machine.location},${machine.effectivePlays},${machine.revenue},${machine.effectivePayouts},${machine.cost.toFixed(2)},${machine.initialPlays || 0},${machine.initialPayouts || 0}`);
                        });
                        reportData.push('');
                    }

                    if (includeOperationSummary) {
                        reportData.push('=== 營運概況總表 ===');
                        reportData.push('機台編號,總投幣金額,總出貨數量,平均出貨成本');
                        const summaryData = getAggregatedSummaryData('all');
                        summaryData.forEach(item => {
                            reportData.push(`${item.id},${item.revenue},${item.payouts},${item.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeHistory) {
                        reportData.push('=== 記帳歷史紀錄 ===');
                        reportData.push('日期,機台編號,位置,投幣次數,出貨次數,當日營收');
                        appData.history.forEach(record => {
                            const dailyRevenue = record.dailyPlays * COIN_VALUE;
                            reportData.push(`${record.date},${record.machineId},${record.location},${record.dailyPlays},${record.dailyPayouts},${dailyRevenue}`);
                        });
                        reportData.push('');
                    }

                    if (includeAnalysis) {
                        reportData.push('=== 營運分析數據 ===');
                        const processedMachines = appData.machines.map(processMachineData);
                        const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
                        const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

                        reportData.push('營收排行榜');
                        reportData.push('排名,機台編號,位置,營收');
                        sortedByRevenue.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.revenue}`);
                        });
                        reportData.push('');

                        reportData.push('出貨成本排行榜');
                        reportData.push('排名,機台編號,位置,平均成本');
                        sortedByCost.forEach((machine, index) => {
                            reportData.push(`${index + 1},${machine.id},${machine.location},${machine.cost.toFixed(2)}`);
                        });
                        reportData.push('');
                    }

                    if (includeCheckout && selectedGroupId && selectedStoreId) {
                        reportData.push('=== 結帳紀錄 ===');
                        const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                        const checkoutSnapshot = await checkoutCollection.get();
                        const checkouts = checkoutSnapshot.docs.map(doc => doc.data());

                        reportData.push('結帳日期,結帳金額,累積營收,備註');
                        checkouts.forEach(checkout => {
                            reportData.push(`${checkout.checkoutDate},${checkout.checkoutAmount},${checkout.cumulativeRevenueAtCheckout || 0},${checkout.notes || ''}`);
                        });
                        reportData.push('');
                    }

                    if (includeProfit) {
                        reportData.push('=== 盈利計算分析 ===');
                        
                        // 載入成本設定
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // 計算營業數據
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                        const totalRevenue = totalPlays * COIN_VALUE;
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // 計算各項成本
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = totalRevenue * (rentPercentage / 100);
                        const totalTaxCost = totalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        
                        // 計算盈利指標
                        const netProfit = totalRevenue - totalCost;
                        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                        const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                        
                        // 成本設定部分
                        reportData.push('成本設定');
                        reportData.push('項目,數值');
                        reportData.push(`每次出貨禮品成本,${giftCost} 元`);
                        reportData.push(`店租比例,${rentPercentage}%`);
                        reportData.push(`稅金比例,${taxPercentage}%`);
                        reportData.push('');
                        
                        // 營業數據部分
                        reportData.push('營業數據');
                        reportData.push('項目,數值');
                        reportData.push(`總營業額,${totalRevenue} 元`);
                        reportData.push(`總出貨次數,${totalPayouts} 次`);
                        reportData.push('');
                        
                        // 成本明細部分
                        reportData.push('成本明細');
                        reportData.push('項目,金額');
                        reportData.push(`禮品成本,${totalGiftCost} 元`);
                        reportData.push(`店租費用,${totalRentCost} 元`);
                        reportData.push(`稅金費用,${totalTaxCost} 元`);
                        reportData.push(`總成本,${totalCost} 元`);
                        reportData.push('');
                        
                        // 盈利分析部分
                        reportData.push('盈利分析');
                        reportData.push('項目,數值');
                        reportData.push(`淨利潤,${netProfit} 元`);
                        reportData.push(`利潤率,${profitMargin.toFixed(2)}%`);
                        reportData.push(`每次出貨淨利,${profitPerPayout.toFixed(2)} 元`);
                        reportData.push('');
                    }

                    // 下載 CSV
                    const csvContent = reportData.join('\n');
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${storeName}_自定義報表_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(link.href);

                } else if (format === 'pdf') {
                    // PDF 格式報表 (簡化版本)
                    alert('PDF 格式報表功能開發中，請先使用 CSV 格式。');
                }

                hideCustomReportModal();
                showFeedback('自定義報表下載成功！', false);

            } catch (error) {
                console.error('生成自定義報表時發生錯誤:', error);
                showFeedback('報表生成失敗，請稍後再試。', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

        // --- CUSTOM STORE REPORT FUNCTIONS ---
        function showCustomStoreReportModal() {
            customStoreReportModal.classList.remove('hidden');
        }

        function hideCustomStoreReportModal() {
            customStoreReportModal.classList.add('hidden');
        }

        function setStoreReportCheckboxes(summary, machines, performance, topMachines, periodSummary, profit) {
            document.getElementById('store-include-summary').checked = summary;
            document.getElementById('store-include-machines').checked = machines;
            document.getElementById('store-include-performance').checked = performance;
            document.getElementById('store-include-top-machines').checked = topMachines;
            document.getElementById('store-include-period-summary').checked = periodSummary;
            document.getElementById('store-include-profit').checked = profit;
        }

        async function generateCustomStoreReport() {
            const includeSummary = document.getElementById('store-include-summary').checked;
            const includeMachines = document.getElementById('store-include-machines').checked;
            const includePerformance = document.getElementById('store-include-performance').checked;
            const includeTopMachines = document.getElementById('store-include-top-machines').checked;
            const includePeriodSummary = document.getElementById('store-include-period-summary').checked;
            const includeProfit = document.getElementById('store-include-profit').checked;
            const period = document.querySelector('input[name="store-report-period"]:checked').value;
            const date = document.getElementById('store-report-date').value;
            const sortOrder = document.querySelector('input[name="store-sort-order"]:checked').value;

            // 檢查必要的全域變數
            if (!selectedGroupId) {
                alert('錯誤：未選擇群組，請重新選擇群組！');
                console.error('selectedGroupId 未設定:', selectedGroupId);
                return;
            }

            console.log('自定義門市報表參數:', {
                includeSummary, includeMachines, includePerformance, includeTopMachines, includePeriodSummary,
                period, date, sortOrder, COIN_VALUE, selectedGroupId, selectedGroupName
            });

            if (!includeSummary && !includeMachines && !includePerformance && !includeTopMachines && !includePeriodSummary && !includeProfit) {
                alert('請至少選擇一項報表內容！');
                return;
            }

            // 檢查選中的門市
            let selectedStoreCheckboxes = Array.from(document.querySelectorAll('.store-checkbox:checked'));
            if (selectedStoreCheckboxes.length === 0) {
                alert('請先在門市列表中勾選要包含的門市！');
                return;
            }
            
            console.log('選中的門市數量:', selectedStoreCheckboxes.length);
            console.log('選中的門市資訊:', selectedStoreCheckboxes.map(cb => ({
                value: cb.value,
                storeName: cb.dataset.storeName
            })));

            pdfLoaderText.textContent = '正在生成自定義門市報表...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                let reportData = [];
                const timestamp = new Date().toLocaleString('zh-TW');
                const periodText = document.querySelector(`input[name="store-report-period"]:checked`).parentElement.textContent.trim();

                // 用來收集所有門市的總營業額、總出貨次數
                let allStoresRevenue = 0;
                let allStoresPayouts = 0;
                let storeRevenueData = [];

                reportData.push('=== 自定義門市報表 ===');
                reportData.push(`報表產生時間：${timestamp}`);
                reportData.push(`報表期間：${periodText}${date ? ` (${date})` : ''}`);
                reportData.push(`包含門市數："${selectedStoreCheckboxes.length}"`);
                
                // 先計算總營業額、總出貨次數、平均出貨成本 (會在後面迴圈中填入)
                reportData.push('');

                // 為每個選中的門市生成報表
                for (const checkbox of selectedStoreCheckboxes) {
                    const storeId = checkbox.value;
                    const storeName = checkbox.dataset.storeName;
                    
                    console.log(`處理門市: ID=${storeId}, Name=${storeName}`);

                    reportData.push(`=== ${storeName} ===`);

                    try {
                        // 獲取門市資料  
                        console.log(`正在獲取門市資料 - GroupId: ${selectedGroupId}, StoreId: ${storeId}, StoreName: ${storeName}, Period: ${period}, Date: ${date}`);
                        
                        // 使用完整的 Firebase 路徑和錯誤處理
                        const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                        const machinesRef = storeRef.collection('machines');
                        const historyRef = storeRef.collection('history');
                        
                        // 先檢查門市是否存在
                        const storeDoc = await storeRef.get();
                        if (!storeDoc.exists) {
                            console.error(`門市不存在: ${storeId}`);
                            throw new Error(`門市 ${storeName} 不存在於資料庫中`);
                        }
                        
                        // 獲取機台資料
                        const machinesSnapshot = await machinesRef.get();
                        console.log(`機台資料查詢結果 - 文檔數量: ${machinesSnapshot.docs.length}, 是否為空: ${machinesSnapshot.empty}`);
                        
                        if (machinesSnapshot.empty) {
                            console.log(`門市 ${storeName} 沒有機台資料`);
                        }
                        
                        // 根據期間類型決定資料來源
                        let machines;
                        
                        if (period === 'all') {
                            // 全部期間：使用機台累積數據
                            machines = machinesSnapshot.docs.map(doc => {
                                const data = doc.data();
                                console.log(`機台原始資料 (${doc.id}):`, data);
                                
                                // 確保所有必要字段存在且為數字
                                const machine = {
                                    docId: doc.id,
                                    id: data.id || doc.id,
                                    location: data.location || '未知位置',
                                    plays: Number(data.plays) || 0,
                                    payouts: Number(data.payouts) || 0,
                                    initialPlays: Number(data.initialPlays) || 0,
                                    initialPayouts: Number(data.initialPayouts) || 0
                                };
                                
                                console.log(`機台轉換後資料 (${doc.id}):`, machine);
                                return machine;
                            });
                        } else {
                            // 單日/週報/月報等：從歷史記錄計算
                            const targetDate = date || new Date().toISOString().split('T')[0];
                            let historyQuery = historyRef;
                            
                            if (period === 'daily') {
                                // 單日：精確匹配日期
                                historyQuery = historyQuery.where('date', '==', targetDate);
                            } else if (period === 'weekly') {
                                // 週報：計算本週範圍（週五到下週四）
                                const dateObj = new Date(targetDate);
                                const dayOfWeek = dateObj.getDay(); // 0=週日, 1=週一, ..., 5=週五, 6=週六
                                const daysToFriday = (dayOfWeek + 7 - 5) % 7; // 計算到上一個週五的天數
                                const startDate = new Date(dateObj);
                                startDate.setDate(dateObj.getDate() - daysToFriday);
                                const endDate = new Date(startDate);
                                endDate.setDate(startDate.getDate() + 6); // 週五+6天=下週四
                                
                                historyQuery = historyQuery
                                    .where('date', '>=', startDate.toISOString().split('T')[0])
                                    .where('date', '<=', endDate.toISOString().split('T')[0]);
                            } else if (period === 'monthly') {
                                // 月報：計算本月範圍
                                const dateObj = new Date(targetDate);
                                const startDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
                                const endDate = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0);
                                
                                historyQuery = historyQuery
                                    .where('date', '>=', startDate.toISOString().split('T')[0])
                                    .where('date', '<=', endDate.toISOString().split('T')[0]);
                            }
                            
                            const historySnapshot = await historyQuery.get();
                            console.log(`歷史記錄查詢結果 - 文檔數量: ${historySnapshot.docs.length}, Period: ${period}, Date: ${targetDate}`);
                            
                            // 按機台彙總歷史記錄
                            const machineMap = new Map();
                            
                            historySnapshot.docs.forEach(doc => {
                                const data = doc.data();
                                const key = `${data.machineId}_${data.location}`;
                                
                                if (!machineMap.has(key)) {
                                    machineMap.set(key, {
                                        id: data.machineId,
                                        location: data.location,
                                        newPlays: 0,
                                        newPayouts: 0
                                    });
                                }
                                
                                const machine = machineMap.get(key);
                                machine.newPlays += Number(data.newPlays) || 0;
                                machine.newPayouts += Number(data.newPayouts) || 0;
                            });
                            
                            // 轉換為機台陣列格式
                            machines = Array.from(machineMap.values()).map(m => ({
                                docId: `${m.id}_${m.location}`,
                                id: m.id,
                                location: m.location,
                                plays: m.newPlays,
                                payouts: m.newPayouts,
                                initialPlays: 0,  // 期間統計不需要扣除起始值
                                initialPayouts: 0
                            }));
                        }
                        
                        console.log(`門市 ${storeName} 最終機台資料:`, machines);
                        console.log(`機台數量: ${machines.length}`);
                        
                        if (includeSummary) {
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                return { ...m, effectivePlays, effectivePayouts, revenue, cost };
                            });

                            console.log(`門市 ${storeName} 處理後機台資料:`, processedMachines);

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            const avgCost = totalPayouts > 0 ? totalRevenue / totalPayouts : 0;

                            // 累加到總營業額和總出貨次數
                            allStoresRevenue += totalRevenue;
                            allStoresPayouts += totalPayouts;
                            storeRevenueData.push({name: storeName, revenue: totalRevenue});

                            reportData.push('營業摘要');
                            reportData.push('項目,數值');
                            reportData.push(`機台數量,"${machines.length}"`);
                            reportData.push(`總投幣次數,"${totalPlays}"`);
                            reportData.push(`總營業額,"${totalRevenue}"`);
                            reportData.push(`總出貨次數,"${totalPayouts}"`);
                            reportData.push(`平均出貨成本,"${avgCost.toFixed(2)}"`);
                            reportData.push('');
                        }

                        if (includeMachines && machines.length > 0) {
                            reportData.push('機台明細');
                            reportData.push('機台編號,位置,投幣次數,營業額,出貨次數,平均成本');
                            machines.forEach(machine => {
                                const effectivePlays = Math.max(0, (machine.plays || 0) - (machine.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (machine.payouts || 0) - (machine.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                                reportData.push(`"${machine.id || '未知'}","${machine.location || '未知'}","${effectivePlays}","${revenue}","${effectivePayouts}","${cost.toFixed(2)}"`);
                            });
                            reportData.push('');
                        }

                        if (includeTopMachines && machines.length > 0) {
                            reportData.push('優績機台 TOP 3');
                            reportData.push('排名,機台編號,位置,營業額');
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, revenue };
                            }).filter(m => m.revenue > 0); // 過濾掉營收為0的機台
                            
                            if (processedMachines.length > 0) {
                                processedMachines.sort((a, b) => b.revenue - a.revenue).slice(0, 3).forEach((machine, index) => {
                                    reportData.push(`"${index + 1}","${machine.id || '未知'}","${machine.location || '未知'}","${machine.revenue}"`);
                                });
                            } else {
                                reportData.push('"1","無","無","0"');
                            }
                            reportData.push('');
                        }

                        if (includeProfit && machines.length > 0) {
                            // 載入該門市的成本設定
                            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${storeId}`) || '{}');
                            const giftCost = settings.giftCost || 50;
                            const rentPercentage = settings.rentPercentage || 30;
                            const taxPercentage = settings.taxPercentage || 5;
                            
                            // 計算營業數據
                            const processedMachines = machines.map(m => {
                                const effectivePlays = Math.max(0, (m.plays || 0) - (m.initialPlays || 0));
                                const effectivePayouts = Math.max(0, (m.payouts || 0) - (m.initialPayouts || 0));
                                const revenue = effectivePlays * COIN_VALUE;
                                return { ...m, effectivePlays, effectivePayouts, revenue };
                            });

                            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                            const totalRevenue = totalPlays * COIN_VALUE;
                            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                            
                            // 計算各項成本
                            const totalGiftCost = totalPayouts * giftCost;
                            const totalRentCost = totalRevenue * (rentPercentage / 100);
                            const totalTaxCost = totalRevenue * (taxPercentage / 100);
                            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                            
                            // 計算盈利指標
                            const netProfit = totalRevenue - totalCost;
                            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                            const profitPerPayout = totalPayouts > 0 ? netProfit / totalPayouts : 0;
                            
                            reportData.push('盈利計算分析');
                            reportData.push('項目,數值');
                            reportData.push(`"成本設定 - 禮品成本","${giftCost} 元/次"`);
                            reportData.push(`"成本設定 - 店租比例","${rentPercentage}%"`);
                            reportData.push(`"成本設定 - 稅金比例","${taxPercentage}%"`);
                            reportData.push(`"營業數據 - 總營業額","${totalRevenue} 元"`);
                            reportData.push(`"營業數據 - 總出貨次數","${totalPayouts} 次"`);
                            reportData.push(`"成本明細 - 禮品成本","${totalGiftCost} 元"`);
                            reportData.push(`"成本明細 - 店租費用","${totalRentCost} 元"`);
                            reportData.push(`"成本明細 - 稅金費用","${totalTaxCost} 元"`);
                            reportData.push(`"成本明細 - 總成本","${totalCost} 元"`);
                            reportData.push(`"盈利分析 - 淨利潤","${netProfit} 元"`);
                            reportData.push(`"盈利分析 - 利潤率","${profitMargin.toFixed(2)}%"`);
                            reportData.push(`"盈利分析 - 每次出貨淨利","${profitPerPayout.toFixed(2)} 元"`);
                            reportData.push('');
                        }

                    } catch (error) {
                        console.error(`獲取門市 ${storeName} 資料失敗:`, error);
                        console.error('詳細錯誤資訊:', {
                            selectedGroupId,
                            storeId,
                            storeName,
                            error: error.message,
                            stack: error.stack
                        });
                        reportData.push(`資料獲取失敗: ${error.message}`);
                        reportData.push('');
                    }
                }

                // 根據排序方式重新排序 storeRevenueData
                if (sortOrder === 'revenue-desc') {
                    // 營業額高到低
                    storeRevenueData.sort((a, b) => b.revenue - a.revenue);
                } else if (sortOrder === 'revenue-asc') {
                    // 營業額低到高
                    storeRevenueData.sort((a, b) => a.revenue - b.revenue);
                } else if (sortOrder === 'name') {
                    // 依門市名稱排序
                    storeRevenueData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                } else if (sortOrder === 'custom') {
                    // 自訂順序 - 按照勾選框在頁面上的順序
                    const checkboxOrder = Array.from(selectedStoreCheckboxes).map(cb => cb.dataset.storeName);
                    storeRevenueData.sort((a, b) => {
                        const indexA = checkboxOrder.indexOf(a.name);
                        const indexB = checkboxOrder.indexOf(b.name);
                        return indexA - indexB;
                    });
                }

                // 計算所有門市平均出貨成本
                const allStoresAvgCost = allStoresPayouts > 0 ? allStoresRevenue / allStoresPayouts : 0;

                // 在第5行插入總營業額、總出貨次數、平均出貨成本資訊
                reportData.splice(4, 0, `所有門市總營業額："${allStoresRevenue}"`);
                reportData.splice(5, 0, `所有門市總出貨次數："${allStoresPayouts}"`);
                reportData.splice(6, 0, `所有門市平均出貨成本："${allStoresAvgCost.toFixed(2)}"`);

                // 總營業額統計
                reportData.push('=== 總營業額統計 ===');
                reportData.push('項目,金額');
                storeRevenueData.forEach(store => {
                    reportData.push(`"${store.name}","${store.revenue}"`);
                });
                reportData.push(`"所有門市總營業額","${allStoresRevenue}"`);
                reportData.push(`"所有門市總出貨次數","${allStoresPayouts}"`);
                reportData.push(`"所有門市平均出貨成本","${allStoresAvgCost.toFixed(2)}"`);
                reportData.push('');

                // 門市績效比較
                if (includePerformance && selectedStoreCheckboxes.length > 1) {
                    reportData.push('=== 門市績效比較 ===');
                    reportData.push('門市名稱,機台數量,總營業額,平均每台營收');
                    storeRevenueData.forEach(store => {
                        reportData.push(`"${store.name}","--","${store.revenue}","--"`);
                    });
                    reportData.push('');
                }

                // 下載 CSV
                const csvContent = reportData.join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `自定義門市報表_${selectedGroupName}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);

                hideCustomStoreReportModal();
                showFeedback('自定義門市報表下載成功！', false);

            } catch (error) {
                console.error('生成門市報表時發生錯誤:', error);
                showFeedback('報表生成失敗，請稍後再試。', true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        }

                // --- 門市報表「網頁預覽」功能 ---

                // 取得指定門市於特定期間的彙整數據
                async function getStorePeriodStats(storeId, period, date) {
                        const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                        const machinesRef = storeRef.collection('machines');
                        const historyRef = storeRef.collection('history');

                        // 機台數以實際機台數為準
                        const machinesSnapshot = await machinesRef.get();
                        const machinesCount = machinesSnapshot.size;

                        let totalPlays = 0;     // 投幣次數
                        let totalPayouts = 0;   // 出貨次數

                        if (period === 'all') {
                                // 累積資料：扣除初始值
                                machinesSnapshot.forEach(doc => {
                                        const data = doc.data();
                                        const plays = Math.max(0, (Number(data.plays) || 0) - (Number(data.initialPlays) || 0));
                                        const payouts = Math.max(0, (Number(data.payouts) || 0) - (Number(data.initialPayouts) || 0));
                                        totalPlays += plays;
                                        totalPayouts += payouts;
                                });
                        } else {
                                // 期間查詢：從 history 匯總 newPlays/newPayouts
                                const targetDate = date || new Date().toISOString().split('T')[0];
                                let q = historyRef;

                                if (period === 'daily') {
                                        q = q.where('date', '==', targetDate);
                                } else if (period === 'weekly') {
                                        const d = new Date(targetDate);
                                        const dayOfWeek = d.getDay();
                                        const daysToFriday = (dayOfWeek + 7 - 5) % 7;
                                        const start = new Date(d); start.setDate(d.getDate() - daysToFriday);
                                        const end = new Date(start); end.setDate(start.getDate() + 6);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'monthly') {
                                        const d = new Date(targetDate);
                                        const start = new Date(d.getFullYear(), d.getMonth(), 1);
                                        const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'quarterly') {
                                        // 季報：計算本季範圍
                                        const d = new Date(targetDate);
                                        const quarter = Math.floor(d.getMonth() / 3);
                                        const start = new Date(d.getFullYear(), quarter * 3, 1);
                                        const end = new Date(d.getFullYear(), quarter * 3 + 3, 0);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                } else if (period === 'yearly') {
                                        // 年報：計算本年範圍
                                        const d = new Date(targetDate);
                                        const start = new Date(d.getFullYear(), 0, 1);
                                        const end = new Date(d.getFullYear(), 11, 31);
                                        q = q.where('date', '>=', start.toISOString().split('T')[0])
                                                 .where('date', '<=', end.toISOString().split('T')[0]);
                                }

                                const historySnapshot = await q.get();
                                historySnapshot.forEach(doc => {
                                        const h = doc.data();
                                        totalPlays += Number(h.newPlays) || 0;
                                        totalPayouts += Number(h.newPayouts) || 0;
                                });
                        }

                        const totalRevenue = totalPlays * COIN_VALUE;
                        return { machinesCount, totalPlays, totalPayouts, totalRevenue };
                }

                // 產生新分頁的報表 HTML
                function generateStoresLiveReportHTML({ summary, rows, meta }) {
                        const buildTime = new Date().toLocaleString('zh-TW');
                        const dateText = new Date().toLocaleDateString('zh-TW');
                        const periodMap = { all:'全部期間', daily:'單日', weekly:'週報', monthly:'月報', quarterly:'季報', yearly:'年報' };
                        const periodText = periodMap[meta.period] + (meta.date ? '（' + meta.date + '）' : '');

                        const rowsJSON = JSON.stringify(rows);
                        const summaryJSON = JSON.stringify({
                                storesCount: summary.storesCount,
                                totalRevenue: Math.round(summary.totalRevenue),
                                totalPayouts: Math.round(summary.totalPayouts),
                                avgPayoutCost: summary.totalPayouts > 0 ? summary.totalRevenue / summary.totalPayouts : 0
                        });

                        // 使用字串拼接而非模板字串，避免內部變數衝突
                        let html = '<!DOCTYPE html>\n';
                        html += '<html lang="zh-Hant">\n';
                        html += '<head>\n';
                        html += '  <meta charset="utf-8" />\n';
                        html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                        html += '  <title>' + (meta.groupName || '') + '｜自定義門市報表｜' + dateText + '</title>\n';
                        html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                        html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                        html += '  <style>\n';
                        html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; }\n';
                        html += '    *{box-sizing:border-box}\n';
                        html += '    body{margin:0; font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text)}\n';
                        html += '    .container{max-width:1100px; margin:24px auto; padding:0 16px}\n';
                        html += '    header{display:flex; flex-wrap:wrap; align-items:flex-end; gap:8px; margin-bottom:16px}\n';
                        html += '    header h1{font-size:1.6rem; margin:0; letter-spacing:.02em}\n';
                        html += '    header .sub{color:var(--muted); font-size:.95rem}\n';
                        html += '    .cards{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:16px 0 20px}\n';
                        html += '    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}\n';
                        html += '    @media (max-width:560px){.cards{grid-template-columns:1fr}}\n';
                        html += '    .card{background:var(--card); padding:14px 16px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                        html += '    .card .label{color:var(--muted); font-size:.85rem}\n';
                        html += '    .card .value{font-size:1.4rem; font-weight:700; margin-top:4px}\n';
                        html += '    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 14px}\n';
                        html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}\n';
                        html += '    .btn:hover{background:#233042}\n';
                        html += '    .grid{display:grid; grid-template-columns:2fr 1fr; gap:16px}\n';
                        html += '    @media (max-width:1000px){.grid{grid-template-columns:1fr}}\n';
                        html += '    .panel{background:var(--card); padding:16px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                        html += '    .panel h3{margin:0 0 12px; font-size:1.05rem}\n';
                        html += '    table{width:100%; border-collapse:separate; border-spacing:0 8px}\n';
                        html += '    thead th{font-size:.85rem; color:var(--muted); text-align:left; padding:6px 10px}\n';
                        html += '    tbody td{background:#0f1520; padding:10px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                        html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                        html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                        html += '    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.78rem; color:#07121f; background:var(--accent)}\n';
                        html += '    .muted{color:var(--muted)}\n';
                        html += '    footer{color:var(--muted); font-size:.85rem; margin:24px 0 40px}\n';
                        html += '  </style>\n';
                        html += '</head>\n';
                        html += '<body>\n';
                        html += '  <div class="container">\n';
                        html += '    <header>\n';
                        html += '      <h1>' + (meta.groupName || '') + ' 自定義門市報表</h1>\n';
                        html += '      <div class="sub">日期：' + dateText + '　/　期間：' + periodText + '</div>\n';
                        html += '    </header>\n';
                        html += '    <section class="cards" id="kpis"></section>\n';
                        html += '    <div class="toolbar">\n';
                        html += '      <button class="btn" id="exportBtn">匯出 CSV</button>\n';
                        html += '      <button class="btn" id="printBtn">列印 / 存成 PDF</button>\n';
                        html += '    </div>\n';
                        html += '    <div class="grid">\n';
                        html += '      <div class="panel">\n';
                        html += '        <h3>各門市營運明細</h3>\n';
                        html += '        <table id="storeTable">\n';
                        html += '          <thead><tr><th>門市</th><th>機台數</th><th>總投幣次數</th><th>營業額</th><th>出貨次數</th><th>平均出貨成本</th></tr></thead>\n';
                        html += '          <tbody></tbody>\n';
                        html += '        </table>\n';
                        html += '      </div>\n';
                        html += '      <div class="panel">\n';
                        html += '        <h3>圖表</h3>\n';
                        html += '        <canvas id="revChart" height="180"></canvas>\n';
                        html += '        <div class="muted" style="margin:10px 0 6px">營業額占比</div>\n';
                        html += '        <canvas id="pieChart" height="180"></canvas>\n';
                        html += '      </div>\n';
                        html += '    </div>\n';
                        html += '    <footer>生成時間：' + buildTime + '　｜　包含門市數：' + summary.storesCount + '</footer>\n';
                        html += '  </div>\n';
                        html += '  <script>\n';
                        html += '    const summary = ' + summaryJSON + ';\n';
                        html += '    const rows = ' + rowsJSON + ';\n';
                        html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                        html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                        html += '    function buildCSV(rows){\n';
                        html += '      const header = ["門市","機台數","總投幣次數","營業額","出貨次數","平均出貨成本"];\n';
                        html += '      const lines = [header.join(",")].concat(rows.map(r => [r.name, r.machines, r.coins, r.revenue, r.shipments, r.avgCost].join(",")));\n';
                        html += '      return "\\uFEFF" + lines.join("\\n");\n';
                        html += '    }\n';
                        html += '    function exportCSV(){\n';
                        html += '      try{\n';
                        html += '        const csv = buildCSV(rows);\n';
                        html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                        html += '        const url = URL.createObjectURL(blob);\n';
                        html += '        const a = document.createElement("a");\n';
                        html += '        a.href = url; a.download = "stores_report.csv";\n';
                        html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                        html += '      }catch(err){ console.error("CSV 匯出失敗：", err); alert("CSV 匯出失敗，請查看 Console。"); }\n';
                        html += '    }\n';
                        html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                        html += '      const kpiRoot = document.getElementById("kpis");\n';
                        html += '      [\n';
                        html += '        { label:"包含門市數", value: nt(summary.storesCount) },\n';
                        html += '        { label:"所有門市總營業額", value: money(summary.totalRevenue) },\n';
                        html += '        { label:"所有門市總出貨次數", value: nt(summary.totalPayouts) },\n';
                        html += '        { label:"所有門市平均出貨成本", value: money(summary.totalPayouts>0? summary.totalRevenue/summary.totalPayouts : 0) }\n';
                        html += '      ].forEach(k=>{\n';
                        html += '        const el = document.createElement("div");\n';
                        html += '        el.className="card";\n';
                        html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                        html += '        kpiRoot.appendChild(el);\n';
                        html += '      });\n';
                        html += '      const tbody = document.querySelector("#storeTable tbody");\n';
                        html += '      rows.forEach(r=>{\n';
                        html += '        const tr = document.createElement("tr");\n';
                        html += '        tr.innerHTML = "<td><span class=\\"chip\\">" + r.name + "</span></td>"+\n';
                        html += '          "<td>" + nt(r.machines) + "</td>"+\n';
                        html += '          "<td>" + nt(r.coins) + "</td>"+\n';
                        html += '          "<td>" + money(r.revenue) + "</td>"+\n';
                        html += '          "<td>" + nt(r.shipments) + "</td>"+\n';
                        html += '          "<td>" + money(r.avgCost) + "</td>";\n';
                        html += '        tbody.appendChild(tr);\n';
                        html += '      });\n';
                        html += '      const labels = rows.map(r=>r.name);\n';
                        html += '      const dataRev = rows.map(r=>r.revenue);\n';
                        html += '      new Chart(document.getElementById("revChart"), {\n';
                        html += '        type:"bar",\n';
                        html += '        data:{ labels, datasets:[{ label:"營業額", data:dataRev, backgroundColor:"#5aa9ff" }] },\n';
                        html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                        html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ display:false }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.06)" }}}\n';
                        html += '        }\n';
                        html += '      });\n';
                        html += '      new Chart(document.getElementById("pieChart"), {\n';
                        html += '        type:"pie",\n';
                        html += '        data:{ labels, datasets:[{ data:dataRev }] },\n';
                        html += '        options:{ plugins:{ legend:{ position:"bottom", labels:{ color:"#c9d7e3" }}} }\n';
                        html += '      });\n';
                        html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                        html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                        html += '    });\n';
                        html += '  <\/script>\n';
                        html += '</body>\n';
                        html += '</html>';
                        return html;
                }

                // 打開新分頁呈現彙整報表
                async function openStoresLiveReportView() {
                        if (!selectedGroupId) { alert('請先選擇單位群組'); return; }
                        const selected = document.querySelectorAll('.store-checkbox:checked');
                        if (selected.length === 0) { alert('請先勾選要包含在報表中的門市'); return; }

                        // 使用網頁預覽專用的選擇器
                        const periodSelector = document.getElementById('preview-period-selector');
                        const datePicker = document.getElementById('preview-date-picker');
                        const period = periodSelector ? periodSelector.value : 'all';
                        const date = datePicker ? datePicker.value : '';
                        
                        // 取得排序方式
                        const sortOrderElement = document.querySelector('input[name="store-sort-order"]:checked');
                        const sortOrder = sortOrderElement ? sortOrderElement.value : 'revenue-desc';

                        const rows = [];
                        let totalRevenue = 0;
                        let totalPayouts = 0;

                        for (const cb of selected) {
                                const storeId = cb.value;
                                const storeName = cb.dataset.storeName;
                                const s = await getStorePeriodStats(storeId, period, date);
                                const avgCost = s.totalPayouts > 0 ? s.totalRevenue / s.totalPayouts : 0;
                                rows.push({
                                        name: storeName,
                                        machines: s.machinesCount,
                                        coins: s.totalPlays,
                                        revenue: Math.round(s.totalRevenue),
                                        shipments: s.totalPayouts,
                                        avgCost: Math.round(avgCost * 100) / 100
                                });
                                totalRevenue += s.totalRevenue;
                                totalPayouts += s.totalPayouts;
                        }

                        // 根據排序方式重新排序 rows
                        if (sortOrder === 'revenue-desc') {
                            // 營業額高到低
                            rows.sort((a, b) => b.revenue - a.revenue);
                        } else if (sortOrder === 'revenue-asc') {
                            // 營業額低到高
                            rows.sort((a, b) => a.revenue - b.revenue);
                        } else if (sortOrder === 'name') {
                            // 依門市名稱排序
                            rows.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                        } else if (sortOrder === 'custom') {
                            // 自訂順序 - 按照勾選框在頁面上的順序
                            const checkboxOrder = Array.from(selected).map(cb => cb.dataset.storeName);
                            rows.sort((a, b) => {
                                const indexA = checkboxOrder.indexOf(a.name);
                                const indexB = checkboxOrder.indexOf(b.name);
                                return indexA - indexB;
                            });
                        }

                        const summary = {
                                storesCount: selected.length,
                                totalRevenue: Math.round(totalRevenue),
                                totalPayouts: Math.round(totalPayouts)
                        };

                        const html = generateStoresLiveReportHTML({
                                summary,
                                rows,
                                meta: { now: new Date(), groupName: selectedGroupName || '', period, date }
                        });

                        const w = window.open('', '_blank');
                        if (!w) { alert('瀏覽器封鎖了彈出視窗，請允許此網站開啟新分頁'); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                }

                // --- WEEKLY TREND ANALYSIS FUNCTIONS ---
                
                // 計算指定日期範圍內每周的營業數據 (優化版：一次讀取所有數據)
                async function calculateWeeklyTrends(storeId, startDate, endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    // 調整起始日為該週的週五 (5 = Friday)
                    const startDay = start.getDay();
                    const daysToFriday = (startDay + 7 - 5) % 7; // 計算到上一個週五的天數
                    start.setDate(start.getDate() - daysToFriday);
                    
                    // ===== 優化關鍵：一次性讀取所有數據 =====
                    const storeRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId);
                    const historyRef = storeRef.collection('history');
                    
                    const startDateStr = start.toISOString().split('T')[0];
                    const endDateStr = end.toISOString().split('T')[0];
                    
                    // 一次查詢取得所有日期範圍的數據
                    const historySnapshot = await historyRef
                        .where('date', '>=', startDateStr)
                        .where('date', '<=', endDateStr)
                        .get();
                    
                    console.log(`📊 [周報計算] 門市: ${storeId}`);
                    console.log(`   日期範圍: ${startDateStr} ~ ${endDateStr}`);
                    console.log(`   找到 ${historySnapshot.docs.length} 天的歷史記錄`);
                    
                    // Debug: 顯示前5筆和後5筆資料的日期
                    if (historySnapshot.docs.length > 0) {
                        const dates = historySnapshot.docs.map(doc => doc.data().date).sort();
                        console.log(`   最早日期: ${dates[0]}`);
                        console.log(`   最晚日期: ${dates[dates.length - 1]}`);
                        if (dates.length > 10) {
                            console.log(`   前5筆: ${dates.slice(0, 5).join(', ')}`);
                            console.log(`   後5筆: ${dates.slice(-5).join(', ')}`);
                        }
                    }
                    
                    // 建立日期到數據的映射表
                    const dateDataMap = {};
                    let totalFoundPlays = 0;
                    let totalFoundPayouts = 0;
                    let recordsInRange = 0;
                    let recordsOutOfRange = 0;
                    
                    historySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const dateStr = data.date;
                        
                        // 檢查日期是否在範圍內
                        if (dateStr < startDateStr || dateStr > endDateStr) {
                            recordsOutOfRange++;
                            console.warn(`   ⚠️ 範圍外的資料: ${dateStr}`);
                            return; // 跳過範圍外的資料
                        }
                        
                        recordsInRange++;
                        const plays = Number(data.newPlays) || 0;
                        const payouts = Number(data.newPayouts) || 0;
                        
                        // 如果該日期已存在,累加數據 (因為是多台機器)
                        if (dateDataMap[dateStr]) {
                            dateDataMap[dateStr].plays += plays;
                            dateDataMap[dateStr].payouts += payouts;
                            dateDataMap[dateStr].revenue += plays * COIN_VALUE;
                        } else {
                            dateDataMap[dateStr] = {
                                plays: plays,
                                payouts: payouts,
                                revenue: plays * COIN_VALUE
                            };
                        }
                        
                        totalFoundPlays += plays;
                        totalFoundPayouts += payouts;
                    });
                    
                    if (recordsOutOfRange > 0) {
                        console.warn(`   ⚠️ 發現 ${recordsOutOfRange} 筆範圍外的資料已排除`);
                    }
                    console.log(`   範圍內資料: ${recordsInRange} 筆記錄`)
                    console.log(`   不重複天數: ${Object.keys(dateDataMap).length} 天`);
                    
                    console.log(`   總投幣數: ${totalFoundPlays.toLocaleString()}`);
                    console.log(`   總出貨數: ${totalFoundPayouts.toLocaleString()}`);
                    console.log(`   總營業額: ${(totalFoundPlays * COIN_VALUE).toLocaleString()} 元`);
                    
                    // ===== 按周分組計算 =====
                    const weeks = [];
                    let currentWeekStart = new Date(start);
                    let weekNumber = 1;
                    
                    console.log(`📅 開始按週分組，起始日期: ${currentWeekStart.toISOString().split('T')[0]}`);
                    
                    while (currentWeekStart <= end) {
                        const weekEnd = new Date(currentWeekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        
                        // 如果週結束日超過結束日期，使用結束日期
                        const actualWeekEnd = weekEnd > end ? end : weekEnd;
                        
                        // 計算該周的統計數據（從映射表中快速取得）
                        let weekRevenue = 0;
                        let weekPayouts = 0;
                        let weekPlays = 0;
                        let daysWithData = 0;
                        
                        let currentDate = new Date(currentWeekStart);
                        while (currentDate <= actualWeekEnd) {
                            const dateStr = currentDate.toISOString().split('T')[0];
                            const dayData = dateDataMap[dateStr];
                            if (dayData) {
                                weekRevenue += dayData.revenue;
                                weekPayouts += dayData.payouts;
                                weekPlays += dayData.plays;
                                daysWithData++;
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        
                        // 計算該週的天數
                        const daysInWeek = Math.ceil((actualWeekEnd - currentWeekStart) / (1000 * 60 * 60 * 24)) + 1;
                        
                        console.log(`   週${weekNumber}: ${currentWeekStart.toISOString().split('T')[0]} ~ ${actualWeekEnd.toISOString().split('T')[0]}`);
                        console.log(`      有資料天數: ${daysWithData}/${daysInWeek} 天, 營業額: ${weekRevenue.toLocaleString()} 元`);
                        
                        weekNumber++;
                        
                        weeks.push({
                            weekStart: new Date(currentWeekStart),
                            weekEnd: new Date(actualWeekEnd),
                            weekLabel: `${currentWeekStart.getMonth() + 1}/${currentWeekStart.getDate()}-${actualWeekEnd.getMonth() + 1}/${actualWeekEnd.getDate()}`,
                            revenue: weekRevenue,
                            payouts: weekPayouts,
                            plays: weekPlays,
                            avgCost: weekPayouts > 0 ? weekRevenue / weekPayouts : 0,
                            days: daysInWeek,
                            psd: weekRevenue / daysInWeek  // 平均每日銷售
                        });
                        
                        // 移到下一週
                        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                    }
                    
                    // 計算周比變化
                    for (let i = 1; i < weeks.length; i++) {
                        const current = weeks[i];
                        const previous = weeks[i - 1];
                        
                        current.revenueChange = previous.revenue > 0 ? 
                            ((current.revenue - previous.revenue) / previous.revenue * 100) : 0;
                        current.payoutsChange = previous.payouts > 0 ? 
                            ((current.payouts - previous.payouts) / previous.payouts * 100) : 0;
                        current.psdChange = previous.psd > 0 ? 
                            ((current.psd - previous.psd) / previous.psd * 100) : 0;
                    }
                    
                    return weeks;
                }
                
                // 取得指定日期範圍的統計資料 (已棄用，保留供舊代碼兼容)
                async function getWeekRangeStats(storeId, startDate, endDate) {
                    const storeRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId);
                    const historyRef = storeRef.collection('history');
                    
                    const startDateStr = startDate.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];
                    
                    const historySnapshot = await historyRef
                        .where('date', '>=', startDateStr)
                        .where('date', '<=', endDateStr)
                        .get();
                    
                    let totalPlays = 0;
                    let totalPayouts = 0;
                    
                    historySnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        totalPlays += Number(data.newPlays) || 0;
                        totalPayouts += Number(data.newPayouts) || 0;
                    });
                    
                    return {
                        totalPlays,
                        totalPayouts,
                        totalRevenue: totalPlays * COIN_VALUE
                    };
                }
                
                // 生成每周趨勢分析報表 HTML
                function generateWeeklyTrendHTML({ storeName, weeks, dateRange, groupName }) {
                    const buildTime = new Date().toLocaleString('zh-TW');
                    const totalRevenue = weeks.reduce((sum, w) => sum + w.revenue, 0);
                    const totalPayouts = weeks.reduce((sum, w) => sum + w.payouts, 0);
                    const avgWeeklyRevenue = weeks.length > 0 ? totalRevenue / weeks.length : 0;
                    
                    const weeksJSON = JSON.stringify(weeks);
                    const summaryJSON = JSON.stringify({
                        totalRevenue,
                        totalPayouts,
                        avgWeeklyRevenue,
                        weeksCount: weeks.length
                    });
                    
                    let html = '<!DOCTYPE html>\n';
                    html += '<html lang="zh-Hant">\n';
                    html += '<head>\n';
                    html += '  <meta charset="utf-8" />\n';
                    html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                    html += '  <title>' + groupName + ' - ' + storeName + ' 每周營業額趨勢分析</title>\n';
                    html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                    html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                    html += '  <style>\n';
                    html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; --danger:#ff6b6b; --success:#51cf66; }\n';
                    html += '    *{box-sizing:border-box; margin:0; padding:0}\n';
                    html += '    body{font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text); padding:20px}\n';
                    html += '    .container{max-width:1200px; margin:0 auto}\n';
                    html += '    header{margin-bottom:24px}\n';
                    html += '    header h1{font-size:1.8rem; margin-bottom:8px; letter-spacing:.02em}\n';
                    html += '    header .subtitle{color:var(--muted); font-size:1rem}\n';
                    html += '    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:24px 0}\n';
                    html += '    .card{background:var(--card); padding:16px 20px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .card .label{color:var(--muted); font-size:.85rem; margin-bottom:8px}\n';
                    html += '    .card .value{font-size:1.6rem; font-weight:700}\n';
                    html += '    .toolbar{display:flex; gap:12px; margin:20px 0}\n';
                    html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:.95rem}\n';
                    html += '    .btn:hover{background:#233042}\n';
                    html += '    .chart-section{background:var(--card); padding:24px; border-radius:14px; margin:20px 0; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .chart-section h3{margin-bottom:16px; font-size:1.2rem}\n';
                    html += '    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:20px}\n';
                    html += '    thead th{font-size:.9rem; color:var(--muted); text-align:left; padding:8px 12px; font-weight:600}\n';
                    html += '    tbody td{background:#0f1520; padding:14px 12px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                    html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                    html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                    html += '    .trend-up{color:var(--success); font-weight:600}\n';
                    html += '    .trend-down{color:var(--danger); font-weight:600}\n';
                    html += '    .trend-neutral{color:var(--muted)}\n';
                    html += '    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600}\n';
                    html += '    .badge-up{background:rgba(81,207,102,.2); color:var(--success)}\n';
                    html += '    .badge-down{background:rgba(255,107,107,.2); color:var(--danger)}\n';
                    html += '    footer{color:var(--muted); font-size:.85rem; margin:30px 0 20px; text-align:center}\n';
                    html += '    @media print{body{background:white; color:black} .btn{display:none}}\n';
                    html += '  </style>\n';
                    html += '</head>\n';
                    html += '<body>\n';
                    html += '  <div class="container">\n';
                    html += '    <header>\n';
                    html += '      <h1>📊 ' + storeName + ' 每周營業額趨勢分析</h1>\n';
                    html += '      <div class="subtitle">分析期間：' + dateRange + '　｜　群組：' + groupName + '</div>\n';
                    html += '    </header>\n';
                    html += '    <section class="cards" id="kpis"></section>\n';
                    html += '    <div class="toolbar">\n';
                    html += '      <button class="btn" id="exportBtn">匯出 CSV</button>\n';
                    html += '      <button class="btn" id="printBtn">列印 / 存成 PDF</button>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>📈 營業額趨勢圖</h3>\n';
                    html += '      <canvas id="revenueChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>� PSD (日均營業額) 趨勢圖</h3>\n';
                    html += '      <canvas id="psdChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>�📊 出貨次數趨勢圖</h3>\n';
                    html += '      <canvas id="payoutsChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>📋 每周詳細數據</h3>\n';
                    html += '      <table id="weekTable">\n';
                    html += '        <thead><tr><th>周次</th><th>營業額</th><th>周比變化</th><th>PSD (日均)</th><th>周比變化</th><th>出貨次數</th><th>周比變化</th><th>平均出貨成本</th></tr></thead>\n';
                    html += '        <tbody></tbody>\n';
                    html += '      </table>\n';
                    html += '    </div>\n';
                    html += '    <footer>生成時間：' + buildTime + '</footer>\n';
                    html += '  </div>\n';
                    html += '  <script>\n';
                    html += '    const weeks = ' + weeksJSON + ';\n';
                    html += '    const summary = ' + summaryJSON + ';\n';
                    html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                    html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                    html += '    const percent = n => (n >= 0 ? "+" : "") + n.toFixed(1) + "%";\n';
                    html += '    function buildCSV(){\n';
                    html += '      const header = ["周次","營業額","營業額周比變化(%)","PSD(日均)","PSD周比變化(%)","出貨次數","出貨次數周比變化(%)","平均出貨成本"];\n';
                    html += '      const lines = [header.join(",")].concat(weeks.map((w,i) => [\n';
                    html += '        w.weekLabel,\n';
                    html += '        w.revenue,\n';
                    html += '        i > 0 ? w.revenueChange.toFixed(2) : "N/A",\n';
                    html += '        w.psd.toFixed(2),\n';
                    html += '        i > 0 ? w.psdChange.toFixed(2) : "N/A",\n';
                    html += '        w.payouts,\n';
                    html += '        i > 0 ? w.payoutsChange.toFixed(2) : "N/A",\n';
                    html += '        w.avgCost.toFixed(2)\n';
                    html += '      ].join(",")));\n';
                    html += '      return "\\uFEFF" + lines.join("\\n");\n';
                    html += '    }\n';
                    html += '    function exportCSV(){\n';
                    html += '      try{\n';
                    html += '        const csv = buildCSV();\n';
                    html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                    html += '        const url = URL.createObjectURL(blob);\n';
                    html += '        const a = document.createElement("a");\n';
                    html += '        a.href = url; a.download = "weekly_trend_report.csv";\n';
                    html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                    html += '      }catch(err){ console.error("CSV匯出失敗", err); alert("CSV匯出失敗"); }\n';
                    html += '    }\n';
                    html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                    html += '      const kpiRoot = document.getElementById("kpis");\n';
                    html += '      [\n';
                    html += '        { label:"分析周數", value: nt(summary.weeksCount) + " 周" },\n';
                    html += '        { label:"總營業額", value: money(summary.totalRevenue) },\n';
                    html += '        { label:"總出貨次數", value: nt(summary.totalPayouts) + " 次" },\n';
                    html += '        { label:"平均周營業額", value: money(summary.avgWeeklyRevenue) }\n';
                    html += '      ].forEach(k=>{\n';
                    html += '        const el = document.createElement("div");\n';
                    html += '        el.className="card";\n';
                    html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                    html += '        kpiRoot.appendChild(el);\n';
                    html += '      });\n';
                    html += '      const tbody = document.querySelector("#weekTable tbody");\n';
                    html += '      weeks.forEach((w,i)=>{\n';
                    html += '        const tr = document.createElement("tr");\n';
                    html += '        const revChange = i > 0 ? "<span class=\\"" + (w.revenueChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.revenueChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const psdChange = i > 0 ? "<span class=\\"" + (w.psdChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.psdChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const payChange = i > 0 ? "<span class=\\"" + (w.payoutsChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.payoutsChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        tr.innerHTML = "<td>" + w.weekLabel + "</td>"+\n';
                    html += '          "<td>" + money(w.revenue) + "</td>"+\n';
                    html += '          "<td>" + revChange + "</td>"+\n';
                    html += '          "<td>" + money(w.psd) + "</td>"+\n';
                    html += '          "<td>" + psdChange + "</td>"+\n';
                    html += '          "<td>" + nt(w.payouts) + "</td>"+\n';
                    html += '          "<td>" + payChange + "</td>"+\n';
                    html += '          "<td>" + money(w.avgCost) + "</td>";\n';
                    html += '        tbody.appendChild(tr);\n';
                    html += '      });\n';
                    html += '      const labels = weeks.map(w=>w.weekLabel);\n';
                    html += '      const revenueData = weeks.map(w=>w.revenue);\n';
                    html += '      const psdData = weeks.map(w=>w.psd);\n';
                    html += '      const payoutsData = weeks.map(w=>w.payouts);\n';
                    html += '      new Chart(document.getElementById("revenueChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"營業額", data:revenueData, borderColor:"#5aa9ff", backgroundColor:"rgba(90,169,255,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("psdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"PSD (日均)", data:psdData, borderColor:"#ffa94d", backgroundColor:"rgba(255,169,77,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("payoutsChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"出貨次數", data:payoutsData, borderColor:"#8bd17c", backgroundColor:"rgba(139,209,124,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                    html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                    html += '    });\n';
                    html += '  <\/script>\n';
                    html += '</body>\n';
                    html += '</html>';
                    return html;
                }
                
                // 打開每周趨勢分析報表
                async function openWeeklyTrendReport() {
                    if (!selectedGroupId) { alert('請先選擇單位群組'); return; }
                    const selected = document.querySelectorAll('.store-checkbox:checked');
                    if (selected.length === 0) { alert('請先勾選要分析的門市'); return; }
                    if (selected.length > 1) { alert('每周趨勢分析一次只能選擇一個門市'); return; }
                    
                    const startDateInput = document.getElementById('weekly-trend-start-date');
                    const endDateInput = document.getElementById('weekly-trend-end-date');
                    
                    if (!startDateInput.value || !endDateInput.value) {
                        alert('請選擇起始日期和結束日期');
                        return;
                    }
                    
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    
                    if (startDate > endDate) {
                        alert('起始日期不能晚於結束日期');
                        return;
                    }
                    
                    const storeId = selected[0].value;
                    const storeName = selected[0].dataset.storeName;
                    
                    // 顯示載入提示
                    pdfLoaderText.textContent = '正在分析每周營業額趨勢...';
                    pdfLoaderOverlay.classList.remove('hidden');
                    pdfLoaderOverlay.classList.add('flex');
                    
                    try {
                        const weeks = await calculateWeeklyTrends(storeId, startDateInput.value, endDateInput.value);
                        
                        if (weeks.length === 0) {
                            alert('所選日期範圍內沒有數據');
                            return;
                        }
                        
                        const html = generateWeeklyTrendHTML({
                            storeName,
                            weeks,
                            dateRange: `${startDateInput.value} ~ ${endDateInput.value}`,
                            groupName: selectedGroupName || ''
                        });
                        
                        const w = window.open('', '_blank');
                        if (!w) { alert('瀏覽器封鎖了彈出視窗，請允許此網站開啟新分頁'); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    } catch (error) {
                        console.error('生成每周趨勢報表失敗:', error);
                        alert('生成報表失敗: ' + error.message);
                    } finally {
                        pdfLoaderOverlay.classList.add('hidden');
                        pdfLoaderOverlay.classList.remove('flex');
                    }
                }

                // 打開多門市周報比較
                async function openMultiStoreWeeklyTrendReport() {
                    if (!selectedGroupId) { alert('請先選擇單位群組'); return; }
                    const selected = document.querySelectorAll('.store-checkbox:checked');
                    if (selected.length === 0) { alert('請先勾選要分析的門市'); return; }
                    
                    const startDateInput = document.getElementById('weekly-trend-start-date');
                    const endDateInput = document.getElementById('weekly-trend-end-date');
                    
                    if (!startDateInput.value || !endDateInput.value) {
                        alert('請選擇起始日期和結束日期');
                        return;
                    }
                    
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    
                    if (startDate > endDate) {
                        alert('起始日期不能晚於結束日期');
                        return;
                    }
                    
                    // 顯示載入提示
                    pdfLoaderText.textContent = '正在分析多門市周報數據...';
                    pdfLoaderOverlay.classList.remove('hidden');
                    pdfLoaderOverlay.classList.add('flex');
                    
                    try {
                        // 收集所有門市的周報數據
                        const storesData = [];
                        
                        for (const cb of selected) {
                            const storeId = cb.value;
                            const storeName = cb.dataset.storeName;
                            const weeks = await calculateWeeklyTrends(storeId, startDateInput.value, endDateInput.value);
                            
                            storesData.push({
                                storeId,
                                storeName,
                                weeks
                            });
                        }
                        
                        if (storesData.length === 0 || storesData[0].weeks.length === 0) {
                            alert('所選日期範圍內沒有數據');
                            return;
                        }
                        
                        // 計算總和數據
                        const combinedWeeks = calculateCombinedWeeklyData(storesData);
                        
                        const html = generateMultiStoreWeeklyTrendHTML({
                            storesData,
                            combinedWeeks,
                            dateRange: `${startDateInput.value} ~ ${endDateInput.value}`,
                            groupName: selectedGroupName || ''
                        });
                        
                        const w = window.open('', '_blank');
                        if (!w) { alert('瀏覽器封鎖了彈出視窗，請允許此網站開啟新分頁'); return; }
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    } catch (error) {
                        console.error('生成多門市周報比較失敗:', error);
                        alert('生成報表失敗: ' + error.message);
                    } finally {
                        pdfLoaderOverlay.classList.add('hidden');
                        pdfLoaderOverlay.classList.remove('flex');
                    }
                }
                
                // 計算多門市的合併周報數據
                function calculateCombinedWeeklyData(storesData) {
                    if (storesData.length === 0) return [];
                    
                    console.log('📊 [多門市合併] 開始計算...');
                    console.log(`   門市數量: ${storesData.length}`);
                    storesData.forEach(store => {
                        const storeTotalRevenue = store.weeks.reduce((sum, w) => sum + w.revenue, 0);
                        console.log(`   ${store.storeName}: ${store.weeks.length} 周, 總計 ${storeTotalRevenue.toLocaleString()} 元`);
                    });
                    
                    // 使用第一個門市的周次作為基準
                    const baseWeeks = storesData[0].weeks;
                    const combinedWeeks = [];
                    
                    baseWeeks.forEach((baseWeek, weekIndex) => {
                        let totalRevenue = 0;
                        let totalPayouts = 0;
                        let totalPlays = 0;
                        let totalDays = 0;
                        
                        // 加總所有門市在這一周的數據
                        storesData.forEach(store => {
                            if (store.weeks[weekIndex]) {
                                totalRevenue += store.weeks[weekIndex].revenue;
                                totalPayouts += store.weeks[weekIndex].payouts;
                                totalPlays += store.weeks[weekIndex].plays;
                                totalDays = store.weeks[weekIndex].days; // 所有門市的天數相同
                            }
                        });
                        
                        // 計算平均 PSD: (總營業額 / 天數) / 門市數量
                        const avgPSD = totalDays > 0 && storesData.length > 0 ? 
                            totalRevenue / totalDays / storesData.length : 0;
                        
                        combinedWeeks.push({
                            weekStart: baseWeek.weekStart,
                            weekEnd: baseWeek.weekEnd,
                            weekLabel: baseWeek.weekLabel,
                            revenue: totalRevenue,
                            payouts: totalPayouts,
                            plays: totalPlays,
                            avgCost: totalPayouts > 0 ? totalRevenue / totalPayouts : 0,
                            days: totalDays,
                            psd: avgPSD  // 平均每日銷售 (已除以門市數量)
                        });
                    });
                    
                    // 計算周比變化
                    for (let i = 1; i < combinedWeeks.length; i++) {
                        const current = combinedWeeks[i];
                        const previous = combinedWeeks[i - 1];
                        
                        current.revenueChange = previous.revenue > 0 ? 
                            ((current.revenue - previous.revenue) / previous.revenue * 100) : 0;
                        current.payoutsChange = previous.payouts > 0 ? 
                            ((current.payouts - previous.payouts) / previous.payouts * 100) : 0;
                        current.psdChange = previous.psd > 0 ? 
                            ((current.psd - previous.psd) / previous.psd * 100) : 0;
                    }
                    
                    return combinedWeeks;
                }
                
                // 生成多門市周報比較 HTML
                function generateMultiStoreWeeklyTrendHTML({ storesData, combinedWeeks, dateRange, groupName }) {
                    const buildTime = new Date().toLocaleString('zh-TW');
                    const totalRevenue = combinedWeeks.reduce((sum, w) => sum + w.revenue, 0);
                    const totalPayouts = combinedWeeks.reduce((sum, w) => sum + w.payouts, 0);
                    const avgWeeklyRevenue = combinedWeeks.length > 0 ? totalRevenue / combinedWeeks.length : 0;
                    
                    const storesJSON = JSON.stringify(storesData.map(s => ({
                        storeName: s.storeName,
                        weeks: s.weeks
                    })));
                    const combinedJSON = JSON.stringify(combinedWeeks);
                    const summaryJSON = JSON.stringify({
                        totalRevenue,
                        totalPayouts,
                        avgWeeklyRevenue,
                        weeksCount: combinedWeeks.length,
                        storesCount: storesData.length
                    });
                    
                    // 🔍 偵錯輸出
                    console.log('📊 多門市周報統計計算:');
                    console.log('   分析周數:', combinedWeeks.length);
                    console.log('   門市數量:', storesData.length);
                    console.log('   各周詳細資料:');
                    combinedWeeks.forEach((w, i) => {
                        console.log(`   第${i+1}周 (${w.weekLabel}):`);
                        console.log(`      營業額: ${w.revenue.toLocaleString()} 元`);
                        console.log(`      PSD: ${w.psd.toLocaleString()} 元/天/門市`);
                        console.log(`      出貨: ${w.payouts.toLocaleString()} 次`);
                        console.log(`      平均成本: ${w.avgCost.toLocaleString()} 元/次`);
                        if (i > 0) {
                            console.log(`      營業額周比: ${w.revenueChange.toFixed(1)}%`);
                            console.log(`      PSD周比: ${w.psdChange.toFixed(1)}%`);
                        }
                    });
                    console.log('   期間總營業額:', totalRevenue.toLocaleString());
                    console.log('   期間總出貨:', totalPayouts.toLocaleString());
                    console.log('   平均周營業額:', avgWeeklyRevenue.toLocaleString());
                    
                    let html = '<!DOCTYPE html>\n';
                    html += '<html lang="zh-Hant">\n';
                    html += '<head>\n';
                    html += '  <meta charset="utf-8" />\n';
                    html += '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n';
                    html += '  <title>' + groupName + ' 多門市周報營業額比較</title>\n';
                    html += '  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">\n';
                    html += '  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>\n';
                    html += '  <style>\n';
                    html += '    :root{ --bg:#0b0f14; --card:#121821; --muted:#9fb0c0; --text:#e6eef6; --accent:#5aa9ff; --accent2:#8bd17c; --warn:#ffb454; --danger:#ff6b6b; --success:#51cf66; }\n';
                    html += '    *{box-sizing:border-box; margin:0; padding:0}\n';
                    html += '    body{font-family:\'Noto Sans TC\',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\'Helvetica Neue\',Arial; background:var(--bg); color:var(--text); padding:20px}\n';
                    html += '    .container{max-width:1400px; margin:0 auto}\n';
                    html += '    header{margin-bottom:24px}\n';
                    html += '    header h1{font-size:1.8rem; margin-bottom:8px; letter-spacing:.02em}\n';
                    html += '    header .subtitle{color:var(--muted); font-size:1rem; margin-top:4px}\n';
                    html += '    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:24px 0}\n';
                    html += '    .card{background:var(--card); padding:16px 20px; border-radius:14px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .card .label{color:var(--muted); font-size:.85rem; margin-bottom:8px}\n';
                    html += '    .card .value{font-size:1.6rem; font-weight:700}\n';
                    html += '    .toolbar{display:flex; gap:12px; margin:20px 0}\n';
                    html += '    .btn{background:#1c2531; color:var(--text); border:1px solid #243141; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600; font-size:.95rem}\n';
                    html += '    .btn:hover{background:#233042}\n';
                    html += '    .chart-section{background:var(--card); padding:24px; border-radius:14px; margin:20px 0; box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 8px 30px rgba(0,0,0,.25)}\n';
                    html += '    .chart-section h3{margin-bottom:16px; font-size:1.2rem}\n';
                    html += '    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:20px 0}\n';
                    html += '    @media(max-width:1000px){.grid-2{grid-template-columns:1fr}}\n';
                    html += '    table{width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:20px}\n';
                    html += '    thead th{font-size:.9rem; color:var(--muted); text-align:left; padding:8px 12px; font-weight:600}\n';
                    html += '    tbody td{background:#0f1520; padding:14px 12px; border-top:1px solid #1f2a38; border-bottom:1px solid #1f2a38}\n';
                    html += '    tbody tr td:first-child{border-left:1px solid #1f2a38; border-top-left-radius:10px; border-bottom-left-radius:10px}\n';
                    html += '    tbody tr td:last-child{border-right:1px solid #1f2a38; border-top-right-radius:10px; border-bottom-right-radius:10px}\n';
                    html += '    .trend-up{color:var(--success); font-weight:600}\n';
                    html += '    .trend-down{color:var(--danger); font-weight:600}\n';
                    html += '    .trend-neutral{color:var(--muted)}\n';
                    html += '    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600}\n';
                    html += '    .badge-up{background:rgba(81,207,102,.2); color:var(--success)}\n';
                    html += '    .badge-down{background:rgba(255,107,107,.2); color:var(--danger)}\n';
                    html += '    .store-tag{display:inline-block; padding:3px 10px; margin:2px; border-radius:999px; font-size:.8rem; background:rgba(90,169,255,.2); color:var(--accent)}\n';
                    html += '    footer{color:var(--muted); font-size:.85rem; margin:30px 0 20px; text-align:center}\n';
                    html += '    @media print{body{background:white; color:black} .btn{display:none}}\n';
                    html += '  </style>\n';
                    html += '</head>\n';
                    html += '<body>\n';
                    html += '  <div class="container">\n';
                    html += '    <header>\n';
                    html += '      <h1>📊 多門市周報營業額比較分析</h1>\n';
                    html += '      <div class="subtitle">分析期間：' + dateRange + '　｜　群組：' + groupName + '</div>\n';
                    html += '      <div class="subtitle" style="margin-top:8px">包含門市：';
                    storesData.forEach((s, i) => {
                        html += '<span class="store-tag">' + s.storeName + '</span>';
                    });
                    html += '</div>\n';
                    html += '    </header>\n';
                    html += '    <section class="cards" id="kpis"></section>\n';
                    html += '    <div class="toolbar">\n';
                    html += '      <button class="btn" id="exportBtn">匯出 CSV</button>\n';
                    html += '      <button class="btn" id="printBtn">列印 / 存成 PDF</button>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>📈 各門市營業額趨勢對比</h3>\n';
                    html += '      <canvas id="compareChart" height="100"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="grid-2">\n';
                    html += '      <div class="chart-section">\n';
                    html += '        <h3>📊 加總營業額趨勢</h3>\n';
                    html += '        <canvas id="totalRevenueChart" height="120"></canvas>\n';
                    html += '      </div>\n';
                    html += '      <div class="chart-section">\n';
                    html += '        <h3>💰 加總PSD (日均) 趨勢</h3>\n';
                    html += '        <canvas id="totalPsdChart" height="120"></canvas>\n';
                    html += '      </div>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>📈 各門市PSD趨勢對比</h3>\n';
                    html += '      <canvas id="comparePsdChart" height="100"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>🎯 加總出貨次數趨勢</h3>\n';
                    html += '      <canvas id="totalPayoutsChart" height="80"></canvas>\n';
                    html += '    </div>\n';
                    html += '    <div class="chart-section">\n';
                    html += '      <h3>📋 加總周報詳細數據</h3>\n';
                    html += '      <table id="weekTable">\n';
                    html += '        <thead><tr><th>周次</th><th>該周總營業額</th><th>周比變化</th><th>PSD (日均)</th><th>周比變化</th><th>總出貨次數</th><th>周比變化</th><th>平均出貨成本</th></tr></thead>\n';
                    html += '        <tbody></tbody>\n';
                    html += '      </table>\n';
                    html += '    </div>\n';
                    html += '    <footer>生成時間：' + buildTime + '</footer>\n';
                    html += '  </div>\n';
                    html += '  <script>\n';
                    html += '    const storesData = ' + storesJSON + ';\n';
                    html += '    const combinedWeeks = ' + combinedJSON + ';\n';
                    html += '    const summary = ' + summaryJSON + ';\n';
                    html += '    const nt = n => Number.isFinite(n) ? n.toLocaleString("zh-Hant-TW") : "0";\n';
                    html += '    const money = n => "NT$ " + nt(Math.round(n || 0));\n';
                    html += '    const percent = n => (n >= 0 ? "+" : "") + n.toFixed(1) + "%";\n';
                    html += '    function buildCSV(){\n';
                    html += '      const header = ["周次","該周總營業額","營業額周比變化(%)","PSD(日均)","PSD周比變化(%)","總出貨次數","出貨次數周比變化(%)","平均出貨成本"];\n';
                    html += '      const lines = [header.join(",")].concat(combinedWeeks.map((w,i) => [\n';
                    html += '        w.weekLabel,\n';
                    html += '        w.revenue,\n';
                    html += '        i > 0 ? w.revenueChange.toFixed(2) : "N/A",\n';
                    html += '        w.psd.toFixed(2),\n';
                    html += '        i > 0 ? w.psdChange.toFixed(2) : "N/A",\n';
                    html += '        w.payouts,\n';
                    html += '        i > 0 ? w.payoutsChange.toFixed(2) : "N/A",\n';
                    html += '        w.avgCost.toFixed(2)\n';
                    html += '      ].join(",")));\n';
                    html += '      return "\\uFEFF" + lines.join("\\n");\n';
                    html += '    }\n';
                    html += '    function exportCSV(){\n';
                    html += '      try{\n';
                    html += '        const csv = buildCSV();\n';
                    html += '        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });\n';
                    html += '        const url = URL.createObjectURL(blob);\n';
                    html += '        const a = document.createElement("a");\n';
                    html += '        a.href = url; a.download = "multi_store_weekly_comparison.csv";\n';
                    html += '        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);\n';
                    html += '      }catch(err){ console.error("CSV匯出失敗", err); alert("CSV匯出失敗"); }\n';
                    html += '    }\n';
                    html += '    document.addEventListener("DOMContentLoaded", ()=>{\n';
                    html += '      const kpiRoot = document.getElementById("kpis");\n';
                    html += '      [\n';
                    html += '        { label:"包含門市數", value: nt(summary.storesCount) + " 家" },\n';
                    html += '        { label:"分析周數", value: nt(summary.weeksCount) + " 周" },\n';
                    html += '        { label:"期間總營業額", value: money(summary.totalRevenue) },\n';
                    html += '        { label:"期間總出貨次數", value: nt(summary.totalPayouts) + " 次" },\n';
                    html += '        { label:"平均周營業額", value: money(summary.avgWeeklyRevenue) }\n';
                    html += '      ].forEach(k=>{\n';
                    html += '        const el = document.createElement("div");\n';
                    html += '        el.className="card";\n';
                    html += '        el.innerHTML = "<div class=\\"label\\">" + k.label + "</div><div class=\\"value\\">" + k.value + "</div>";\n';
                    html += '        kpiRoot.appendChild(el);\n';
                    html += '      });\n';
                    html += '      const tbody = document.querySelector("#weekTable tbody");\n';
                    html += '      combinedWeeks.forEach((w,i)=>{\n';
                    html += '        const tr = document.createElement("tr");\n';
                    html += '        const revChange = i > 0 ? "<span class=\\"" + (w.revenueChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.revenueChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const psdChange = i > 0 ? "<span class=\\"" + (w.psdChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.psdChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        const payChange = i > 0 ? "<span class=\\"" + (w.payoutsChange >= 0 ? "badge badge-up" : "badge badge-down") + "\\">" + percent(w.payoutsChange) + "</span>" : "<span class=\\"trend-neutral\\">-</span>";\n';
                    html += '        tr.innerHTML = "<td>" + w.weekLabel + "</td>"+\n';
                    html += '          "<td>" + money(w.revenue) + "</td>"+\n';
                    html += '          "<td>" + revChange + "</td>"+\n';
                    html += '          "<td>" + money(w.psd) + "</td>"+\n';
                    html += '          "<td>" + psdChange + "</td>"+\n';
                    html += '          "<td>" + nt(w.payouts) + "</td>"+\n';
                    html += '          "<td>" + payChange + "</td>"+\n';
                    html += '          "<td>" + money(w.avgCost) + "</td>";\n';
                    html += '        tbody.appendChild(tr);\n';
                    html += '      });\n';
                    html += '      const labels = combinedWeeks.map(w=>w.weekLabel);\n';
                    html += '      const colors = ["#5aa9ff","#8bd17c","#ffb454","#ff6b6b","#a78bfa","#f472b6","#fb923c","#34d399"];\n';
                    html += '      const datasets = storesData.map((store, idx) => ({\n';
                    html += '        label: store.storeName,\n';
                    html += '        data: store.weeks.map(w => w.revenue),\n';
                    html += '        borderColor: colors[idx % colors.length],\n';
                    html += '        backgroundColor: "transparent",\n';
                    html += '        tension: 0.3\n';
                    html += '      }));\n';
                    html += '      const psdDatasets = storesData.map((store, idx) => ({\n';
                    html += '        label: store.storeName,\n';
                    html += '        data: store.weeks.map(w => w.psd),\n';
                    html += '        borderColor: colors[idx % colors.length],\n';
                    html += '        backgroundColor: "transparent",\n';
                    html += '        tension: 0.3\n';
                    html += '      }));\n';
                    html += '      new Chart(document.getElementById("compareChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:true, position:"top", labels:{color:"#9fb0c0"} }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("comparePsdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets: psdDatasets },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:true, position:"top", labels:{color:"#9fb0c0"} }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalRevenueChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"該周總營業額", data:combinedWeeks.map(w=>w.revenue), borderColor:"#5aa9ff", backgroundColor:"rgba(90,169,255,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalPsdChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"PSD (日均)", data:combinedWeeks.map(w=>w.psd), borderColor:"#ffa94d", backgroundColor:"rgba(255,169,77,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0", callback:v=>"NT$ "+v }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      new Chart(document.getElementById("totalPayoutsChart"), {\n';
                    html += '        type:"line",\n';
                    html += '        data:{ labels, datasets:[{ label:"總出貨次數", data:combinedWeeks.map(w=>w.payouts), borderColor:"#8bd17c", backgroundColor:"rgba(139,209,124,.1)", tension:0.3, fill:true }] },\n';
                    html += '        options:{ responsive:true, plugins:{ legend:{ display:false }},\n';
                    html += '          scales:{ x:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}, y:{ ticks:{ color:"#9fb0c0" }, grid:{ color:"rgba(255,255,255,.05)" }}}\n';
                    html += '        }\n';
                    html += '      });\n';
                    html += '      document.getElementById("exportBtn").addEventListener("click", exportCSV);\n';
                    html += '      document.getElementById("printBtn").addEventListener("click", ()=>window.print());\n';
                    html += '    });\n';
                    html += '  <\/script>\n';
                    html += '</body>\n';
                    html += '</html>';
                    return html;
                }

                // --- NAVIGATION & PAGE CONTROL ---
        
        function showGroupSelectionPage() {
            selectedGroupId = null;
            selectedGroupName = '';
            selectedStoreId = null;
            selectedStoreName = '';
            
            groupSelectionPage.classList.remove('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            
            loadGroups();
        }
        
        // 暴露函數到全域範圍供登入系統使用
        window.showGroupSelectionPage = showGroupSelectionPage;

        // --- 初始化網頁預覽日期選擇器 ---
        const previewDatePicker = document.getElementById('preview-date-picker');
        if (previewDatePicker) {
            // 設定為今天的日期
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            previewDatePicker.value = `${year}-${month}-${day}`;
        }

        // --- 初始化每周趨勢分析日期選擇器 ---
        if (weeklyTrendStartDate && weeklyTrendEndDate) {
            const today = new Date();
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            // 起始日期設為一個月前
            weeklyTrendStartDate.value = oneMonthAgo.toISOString().split('T')[0];
            // 結束日期設為今天
            weeklyTrendEndDate.value = today.toISOString().split('T')[0];
        }

        // --- 管理者界面函數 ---
        function showAdminPage() {
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            adminPage.classList.remove('hidden');
            
            loadAdminInterface();
        }

        function hideAdminPage() {
            adminPage.classList.add('hidden');
            showGroupSelectionPage();
        }

        function loadAdminInterface() {
            // 載入當前管理員資訊
            const currentAdmin = window.adminConfig.config.adminCredentials;
            document.getElementById('new-username').value = currentAdmin.username;
            
            // 載入群組權限選項
            loadGroupPermissions();
            
            // 載入訪客帳號列表
            loadGuestAccountsTable();
            
            // 重置表單
            adminPasswordForm.reset();
            guestAccountForm.reset();
            document.getElementById('new-username').value = currentAdmin.username;
        }

        async function loadGroupPermissions() {
            try {
                const groupsSnapshot = await db.collection('groups').get();
                const groups = groupsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                groupPermissions.innerHTML = '';
                if (groups.length === 0) {
                    groupPermissions.innerHTML = '<p class="text-gray-400 text-sm">目前沒有可用的群組</p>';
                } else {
                    groups.forEach(group => {
                        const checkbox = document.createElement('label');
                        checkbox.className = 'flex items-center space-x-2 text-white cursor-pointer';
                        checkbox.innerHTML = `
                            <input type="checkbox" value="${group.id}" class="group-permission-checkbox rounded">
                            <span>${group.name}</span>
                        `;
                        groupPermissions.appendChild(checkbox);
                    });
                }
            } catch (error) {
                console.error('載入群組權限失敗:', error);
                groupPermissions.innerHTML = '<p class="text-red-400 text-sm">載入群組失敗</p>';
            }
        }

        function loadGuestAccountsTable() {
            const guests = window.adminConfig.getGuestAccounts();
            guestAccountsTable.innerHTML = '';
            
            if (guests.length === 0) {
                guestAccountsTable.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-400">尚無訪客帳號</td></tr>';
            } else {
                guests.forEach(guest => {
                    const allowedGroupsText = guest.allowedGroups.length > 0 ? 
                        `${guest.allowedGroups.length} 個群組` : '無權限';
                    
                    // 頁面權限顯示
                    const pagePermissions = guest.pagePermissions || [];
                    const pagePermissionNames = {
                        'details': '機台明細', 'summary': '營運總覽', 'analysis': '經營分析',
                        'charts': '圖表統計', 'statistics': '數據統計', 'accounting': '每日記帳',
                        'machines': '機台管理', 'profit': '盈利計算', 'checkout': '結帳作業', 'download': '下載報告', 'edit': '編輯刪除'
                    };
                    const pagePermissionsText = pagePermissions.length > 0 ? 
                        pagePermissions.map(p => pagePermissionNames[p] || p).slice(0, 3).join(', ') + 
                        (pagePermissions.length > 3 ? `等${pagePermissions.length}項` : '') : '無權限';
                    
                    const statusText = guest.enabled ? '啟用' : '停用';
                    const statusClass = guest.enabled ? 'text-green-400' : 'text-red-400';
                    const createdDate = new Date(guest.createdAt).toLocaleDateString();
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700/50 transition';
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${guest.username}</td>
                        <td class="p-4 ${statusClass}">${statusText}</td>
                        <td class="p-4 text-gray-300">${allowedGroupsText}</td>
                        <td class="p-4 text-gray-300 text-sm" title="${pagePermissions.map(p => pagePermissionNames[p] || p).join(', ')}">${pagePermissionsText}</td>
                        <td class="p-4 text-gray-300">${createdDate}</td>
                        <td class="p-4 text-center">
                            <button class="edit-guest-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-guest-id="${guest.id}">編輯</button>
                            <button class="delete-guest-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" data-guest-id="${guest.id}">刪除</button>
                        </td>
                    `;
                    guestAccountsTable.appendChild(row);
                });
            }
        }

        function showAdminFeedback(elementId, message, isError = false) {
            const feedbackEl = document.getElementById(elementId);
            feedbackEl.textContent = message;
            feedbackEl.className = `text-sm mt-2 ${isError ? 'text-red-400' : 'text-green-400'}`;
            feedbackEl.classList.remove('hidden');
            setTimeout(() => {
                feedbackEl.classList.add('hidden');
            }, 5000);
        }

        function showStoreSelectionPage(groupId, groupName) {
            selectedGroupId = groupId;
            selectedGroupName = groupName;
            
            document.getElementById('store-page-title').textContent = `${groupName} - 門市管理`;
            groupSelectionPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
            reportPage.classList.add('hidden');
            document.getElementById('new-store-start-date').valueAsDate = new Date();
            document.getElementById('clone-store-start-date').valueAsDate = new Date();

            // 根據用戶類型隱藏/顯示新增門市表單
            const userType = localStorage.getItem('userType');
            const createStoreForm = document.getElementById('create-store-form').parentElement;
            if (createStoreForm) {
                if (userType === 'admin') {
                    createStoreForm.style.display = 'block';
                } else {
                    createStoreForm.style.display = 'none';
                }
            }

            // ✅ 計算並顯示總營業額統計
            displayStoresSalesStatistics(groupId);
            
            loadStores();
        }

        // ✅ 新增函數：計算並顯示所有門市的營業額統計
        async function displayStoresSalesStatistics(groupId) {
            try {
                // 獲取該群組下所有門市
                const storesSnapshot = await db.collection('groups').doc(groupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                if (stores.length === 0) {
                    console.log('⚠️ 該群組沒有任何門市');
                    return;
                }

                // 計算每間門市的營業額
                const storesSalesData = [];
                let totalAllStoresRevenue = 0;
                let totalAllStoresCheckoutRevenue = 0;

                for (const store of stores) {
                    try {
                        // 獲取該門市的機台資訊
                        const machinesSnapshot = await db.collection('groups').doc(groupId)
                            .collection('stores').doc(store.id).collection('machines').get();
                        const machines = machinesSnapshot.docs.map(doc => ({docId: doc.id, ...doc.data()}));

                        // 計算當期營業額（未結帳）
                        let storeRevenue = 0;
                        let storeCheckoutRevenue = 0;

                        // 獲取最後結帳的累計數據
                        let lastCheckoutRevenue = 0;
                        try {
                            const lastCheckoutSnapshot = await db.collection('groups').doc(groupId)
                                .collection('stores').doc(store.id).collection('checkouts')
                                .orderBy('checkoutDate', 'desc').limit(1).get();

                            if (!lastCheckoutSnapshot.empty) {
                                const lastCheckout = lastCheckoutSnapshot.docs[0].data();
                                // 使用結帳時的累計總營業額,而非本次結帳金額
                                lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                                console.log(`📊 ${store.name} 最後結帳累計營業額: ${lastCheckoutRevenue.toLocaleString()}`);
                            }
                        } catch (checkoutError) {
                            console.warn(`無法獲取 ${store.name} 的結帳記錄:`, checkoutError);
                            lastCheckoutRevenue = 0;
                        }

                        // 計算當前總營業額
                        machines.forEach(machine => {
                            const plays = machine.plays || 0;
                            const initialPlays = machine.initialPlays || 0;
                            const effectivePlays = plays - initialPlays;
                            const revenue = effectivePlays * COIN_VALUE;
                            storeRevenue += revenue;
                        });

                        // 當期營業額 = 總營業額 - 最後結帳營業額
                        storeCheckoutRevenue = Math.max(0, storeRevenue - lastCheckoutRevenue);

                        storesSalesData.push({
                            storeName: store.name,
                            totalRevenue: storeRevenue,
                            checkoutRevenue: storeCheckoutRevenue,
                            lastCheckoutRevenue: lastCheckoutRevenue
                        });

                        totalAllStoresRevenue += storeRevenue;
                        totalAllStoresCheckoutRevenue += storeCheckoutRevenue;

                    } catch (error) {
                        console.error(`計算門市 ${store.name} 營業額失敗:`, error);
                    }
                }

                // 渲染統計表格
                renderSalesStatisticsTable(storesSalesData, totalAllStoresRevenue, totalAllStoresCheckoutRevenue);

            } catch (error) {
                console.error('計算門市營業額統計失敗:', error);
            }
        }

        // ✅ 新增函數：渲染營業額統計表格
        function renderSalesStatisticsTable(storesSalesData, totalRevenue, totalCheckoutRevenue) {
            // 尋找或建立統計容器
            let statsContainer = document.getElementById('stores-sales-statistics');

            if (!statsContainer) {
                // 在門市選擇區上方插入統計容器
                const storeSelectionPage = document.getElementById('store-selection-page');
                if (!storeSelectionPage) return;

                statsContainer = document.createElement('div');
                statsContainer.id = 'stores-sales-statistics';
                statsContainer.className = 'bg-gray-800 rounded-xl shadow-lg p-6 mb-8';
                storeSelectionPage.insertBefore(statsContainer, storeSelectionPage.firstChild);
            }

            // 建立統計 HTML - 新增收合功能
            let html = `
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <span class="text-green-400 mr-2">📊</span> === 總營業額統計（全部期間累積）===
                    </h2>
                    <button id="toggle-stats-table" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors">
                        <span id="toggle-stats-icon">📊</span> 收合統計
                    </button>
                </div>

                <div id="stats-table-container" class="transition-all duration-300">
                    <div class="mb-4 flex gap-4 flex-wrap">
                        <button class="sales-view-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors active" data-view="total">
                            顯示總營業額
                        </button>
                        <button class="sales-view-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors" data-view="pending">
                            顯示待結帳營業額
                        </button>
                    </div>

                    <!-- 說明提示 -->
                    <div class="mb-4 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg text-blue-200 text-sm">
                        <span class="font-semibold">💡 提示：</span>此處顯示的是從機台設置開始至今的<strong>累積總營業額</strong>。若要查看特定時間段的營業額，請使用下方的「每周營業額趨勢分析」或「多門市周報比較」功能。
                    </div>

                    <!-- 雙摘要顯示 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-900/30 p-4 rounded-lg font-bold text-white">
                            <div class="text-sm text-gray-400 mb-1">💰 總營業額（累積）</div>
                            <div class="text-2xl text-green-300"><span class="total-summary-total">${totalRevenue.toLocaleString()}</span> 元</div>
                        </div>
                        <div class="bg-yellow-900/30 p-4 rounded-lg font-bold text-white">
                            <div class="text-sm text-gray-400 mb-1">⏳ 待結帳營業額</div>
                            <div class="text-2xl text-yellow-300"><span class="total-summary-pending">${totalCheckoutRevenue.toLocaleString()}</span> 元</div>
                        </div>
                    </div>

                    <!-- 詳細表格（可收合） -->
                    <div id="detailed-stats-table" class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-300 bg-gray-900/50 rounded-lg overflow-hidden">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left font-semibold">項目</th>
                                    <th class="px-4 py-2 text-right font-semibold sales-total-col">金額（總計）</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
            `;

            // 按營業額排序（降序）
            const sortedData = [...storesSalesData].sort((a, b) => b.totalRevenue - a.totalRevenue);

            // 新增每間門市的資料列
            sortedData.forEach(store => {
                const displayRevenue = store.totalRevenue.toLocaleString();
                const displayCheckoutRevenue = store.checkoutRevenue.toLocaleString();

                html += `
                <tr class="hover:bg-gray-800/50 transition-colors sales-row" data-total-revenue="${store.totalRevenue}" data-checkout-revenue="${store.checkoutRevenue}">
                    <td class="px-4 py-3 font-medium text-white">${store.storeName}</td>
                    <td class="px-4 py-3 text-right font-semibold text-green-400 sales-revenue">
                        ${displayRevenue}
                    </td>
                </tr>
                `;
            });

            // 新增總計列
            const totalDisplayRevenue = totalRevenue.toLocaleString();
            const totalDisplayCheckout = totalCheckoutRevenue.toLocaleString();

            html += `
                <tr class="bg-blue-900/30 font-bold text-white sales-total-row">
                    <td class="px-4 py-3">所有門市總營業額</td>
                    <td class="px-4 py-3 text-right text-blue-300 sales-total-revenue">
                        ${totalDisplayRevenue}
                    </td>
                </tr>
            `;

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 p-4 bg-gray-900/50 rounded-lg">
                        <p class="text-sm text-gray-400">
                            <span class="text-green-400 font-semibold">💡 說明：</span>
                            「總營業額」= 所有機台累積投幣數 × 10元；「待結帳營業額」= 上次結帳後的新增營業額
                        </p>
                    </div>
                </div>
            </div>
            `;

            statsContainer.innerHTML = html;

            // 綁定收合按鈕事件
            const toggleBtn = document.getElementById('toggle-stats-table');
            const tableContainer = document.getElementById('detailed-stats-table');
            const icon = document.getElementById('toggle-stats-icon');
            
            let isCollapsed = localStorage.getItem('statsTableCollapsed') === 'true';
            
            function updateToggleState() {
                if (isCollapsed) {
                    tableContainer.style.display = 'none';
                    toggleBtn.innerHTML = '<span id="toggle-stats-icon">📈</span> 展開統計';
                    toggleBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors';
                } else {
                    tableContainer.style.display = 'block';
                    toggleBtn.innerHTML = '<span id="toggle-stats-icon">📊</span> 收合統計';
                    toggleBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors';
                }
            }
            
            updateToggleState();
            
            toggleBtn.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                localStorage.setItem('statsTableCollapsed', isCollapsed);
                updateToggleState();
            });

            // 綁定檢視切換按鈕事件
            document.querySelectorAll('.sales-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除其他按鈕的 active 狀態
                    document.querySelectorAll('.sales-view-btn').forEach(b => b.classList.remove('active', 'bg-blue-700'));
                    this.classList.add('active', 'bg-blue-700');

                    const viewType = this.dataset.view;
                    const isTotal = viewType === 'total';

                    // 更新表格標題
                    const headerCell = document.querySelector('.sales-total-col');
                    if (headerCell) {
                        headerCell.textContent = isTotal ? '金額（總計）' : '金額（待結帳）';
                    }

                    // 更新每行資料
                    document.querySelectorAll('.sales-row').forEach((row, index) => {
                        const revenue = row.dataset[isTotal ? 'totalRevenue' : 'checkoutRevenue'];
                        const displayRevenue = parseFloat(revenue).toLocaleString();
                        const revenueCell = row.querySelector('.sales-revenue');
                        if (revenueCell) {
                            revenueCell.textContent = displayRevenue;
                        }
                    });

                    // 更新總計列
                    const totalRow = document.querySelector('.sales-total-row');
                    if (totalRow) {
                        const totalRevenue = Array.from(document.querySelectorAll('.sales-row')).reduce((sum, row) => {
                            return sum + parseFloat(row.dataset[isTotal ? 'totalRevenue' : 'checkoutRevenue']);
                        }, 0);
                        const totalCell = totalRow.querySelector('.sales-total-revenue');
                        if (totalCell) {
                            totalCell.textContent = totalRevenue.toLocaleString();
                        }
                    }
                    
                    // 更新雙摘要顯示
                    if (isTotal) {
                        const totalSum = Array.from(document.querySelectorAll('.sales-row')).reduce((sum, row) => {
                            return sum + parseFloat(row.dataset.totalRevenue);
                        }, 0);
                        const totalCell = document.querySelector('.total-summary-total');
                        if (totalCell) totalCell.textContent = totalSum.toLocaleString();
                    } else {
                        const pendingSum = Array.from(document.querySelectorAll('.sales-row')).reduce((sum, row) => {
                            return sum + parseFloat(row.dataset.checkoutRevenue);
                        }, 0);
                        const pendingCell = document.querySelector('.total-summary-pending');
                        if (pendingCell) pendingCell.textContent = pendingSum.toLocaleString();
                    }
                });
            });

            console.log('✅ 門市營業額統計已渲染（支援收合功能）');
        }

        async function showReportPage(storeId, storeName, startDate) {
            console.log(`📍 showReportPage 被呼叫: ${storeId}/${storeName}`);
            selectedStoreId = storeId;
            selectedStoreName = storeName;
            appData.startDate = startDate;
            
            // 🚀 切換門市時清理自動輪詢計時器
            clearAutoPollTimer();
            
            // 🔧 切換門市時,保留 window.dailyRecords 不清空
            // 這樣可以保留「立即讀取所有門市資料」功能收集的記錄
            // refreshAutoRecordTable() 會自動過濾只顯示當前門市的記錄
            console.log('� 切換門市，保留 HTTP 輪詢記錄 (共 ' + Object.keys(window.dailyRecords || {}).length + ' 筆)');
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
            
            document.getElementById('report-title-main').textContent = `${selectedStoreName} - 營業報告`;
            document.getElementById('report-period').textContent = `統計期間：${startDate} ～ 現在`;
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.remove('hidden');
            
            // 檢查用戶頁面權限並隱藏/顯示相應的標籤頁
            applyPagePermissions();
            
            appData.machines = [];
            appData.history = [];
            
            // 選擇第一個可見的標籤頁
            const firstVisibleTab = document.querySelector('.tab-btn:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.click();
            } else {
                document.querySelector('.tab-btn[data-tab="details"]').click(); // 默認回退
            }
            
            await updateUI(); 
            console.log('📍 準備呼叫 loadStoreData()...');
            await loadStoreData();
        }

        // 應用頁面權限
        function applyPagePermissions() {
            const userType = localStorage.getItem('userType');
            console.log('應用頁面權限，用戶類型:', userType);
            
            if (userType === 'admin') {
                // 管理員擁有所有權限
                console.log('管理員用戶，顯示所有功能');
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.style.display = 'block';
                });
                document.getElementById('header-download-buttons').style.display = 'flex';
                return;
            }
            
            // 訪客用戶，檢查頁面權限
            const currentUser = localStorage.getItem('currentUser');
            const userPagePermissions = JSON.parse(localStorage.getItem('userPagePermissions') || '[]');
            console.log('訪客用戶頁面權限:', userPagePermissions);
            
            // 標籤頁權限映射
            const tabPermissionMap = {
                'details': 'details',
                'summary': 'summary', 
                'analysis': 'analysis',
                'charts': 'charts',
                'statistics': 'statistics',
                'accounting': 'accounting',
                'machines': 'machines',
                'profit': 'profit',
                'checkout': 'checkout'
            };
            
            // 隱藏/顯示標籤頁
            document.querySelectorAll('.tab-btn').forEach(tab => {
                const tabName = tab.dataset.tab;
                const requiredPermission = tabPermissionMap[tabName];
                
                if (requiredPermission && userPagePermissions.includes(requiredPermission)) {
                    tab.style.display = 'block';
                    console.log(`顯示標籤頁: ${tabName}`);
                } else {
                    tab.style.display = 'none';
                    console.log(`隱藏標籤頁: ${tabName}`);
                }
            });
            
            // 下載按鈕權限
            if (userPagePermissions.includes('download')) {
                document.getElementById('header-download-buttons').style.display = 'flex';
                console.log('顯示下載按鈕');
            } else {
                document.getElementById('header-download-buttons').style.display = 'none';
                console.log('隱藏下載按鈕');
            }
            
            // 編輯/刪除按鈕權限
            const hasEditPermission = userPagePermissions.includes('edit');
            console.log('編輯權限:', hasEditPermission);
            
            if (!hasEditPermission) {
                // 隱藏所有編輯和刪除按鈕
                setTimeout(() => {
                    const style = document.createElement('style');
                    style.id = 'guest-permissions-style';
                    style.textContent = `
                        .edit-machine-btn, .delete-machine-btn, 
                        .edit-history-btn, .delete-history-btn,
                        .edit-store-btn, .clone-store-btn, .delete-store-btn,
                        .rename-group-btn, .delete-group-btn {
                            display: none !important;
                        }
                    `;
                    // 移除之前的樣式再添加新的
                    const existingStyle = document.getElementById('guest-permissions-style');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    document.head.appendChild(style);
                    console.log('已隱藏編輯/刪除按鈕');
                }, 100);
            }
        }

        // --- DATA PROCESSING & CALCULATION ---
        
        function processMachineData(machine) {
            // 🔧 雙重保險：確保所有數值都是整數
            const plays = Math.round(Number(machine.plays) || 0);
            const payouts = Math.round(Number(machine.payouts) || 0);
            const initialPlays = Math.round(Number(machine.initialPlays) || 0);
            const initialPayouts = Math.round(Number(machine.initialPayouts) || 0);
            
            // ✅ 計算有效值（應該都是整數）
            const effectivePlays = plays - initialPlays;
            const effectivePayouts = payouts - initialPayouts;
            
            // ✅ 投幣金額 = 投幣次數 × 10（應該永遠是整數且是10的倍數）
            const revenue = effectivePlays * COIN_VALUE;
            
            // ✅ 驗證投幣金額是否為10的倍數（調試用）
            if (revenue > 0 && revenue % 10 !== 0) {
                console.warn(`⚠️ 警告：機台 ${machine.id} 的投幣金額 ${revenue} 不是10的倍數！`);
                console.warn(`   原因: effectivePlays=${effectivePlays}, plays=${plays}, initialPlays=${initialPlays}`);
            }
            
            // ✅ 平均出貨成本（可能是小數）
            const cost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
            
            // 🔧 不再標記異常（因為所有數據都已清潔化為整數）
            const isAbnormal = false;
            
            return { 
                ...machine, 
                plays,
                payouts,
                initialPlays,
                initialPayouts,
                effectivePlays, 
                effectivePayouts, 
                revenue,  // ✅ 投幣金額 - 永遠是整數且是10的倍數
                cost,     // 成本 - 可能是小數
                isAbnormalCost: isAbnormal
            };
        }
        
        // ✅ 新增：顯示成本時自動四捨五入到整數
        function formatCost(cost) {
            if (typeof cost !== 'number' || isNaN(cost)) {
                return '0';
            }
            // 四捨五入到整數
            return Math.round(cost).toString();
        }
        
        // ✅ 新增：診斷函數 - 檢查異常成本
        function diagnoseAbnormalCosts(machines) {
            const abnormal = machines.filter(m => m.isAbnormalCost);
            
            if (abnormal.length > 0) {
                console.warn('⚠️ 偵測到異常成本的機台（可能已結過帳務）:');
                abnormal.forEach(m => {
                    console.warn(`   - ${m.id} (${m.location}): 成本=${formatCost(m.cost)}, 初始出貨=${m.initialPayouts}`);
                    console.warn(`     建議: 檢查最後一次結帳紀錄，可能需要手動調整初始值`);
                });
            }
            
            return abnormal;
        }
        
        // --- DATA FUNCTIONS (Multi-group Version) ---
        
        async function loadGroups() {
            console.log('🔄 開始載入群組列表...');
            try {
                const groupSnapshot = await db.collection('groups').orderBy('createdAt', 'desc').get();
                console.log('✅ 成功讀取群組，數量:', groupSnapshot.size);
                let groups = groupSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 如果是訪客用戶，過濾只顯示有權限的群組
                const userType = localStorage.getItem('userType');
                if (userType === 'guest') {
                    const allowedGroups = JSON.parse(localStorage.getItem('allowedGroups') || '[]');
                    groups = groups.filter(group => allowedGroups.includes(group.id));
                }
                
                renderGroups(groups);
            } catch (error) {
                console.error("❌ 讀取單位群組失敗:", error);
                console.error("錯誤代碼:", error.code);
                console.error("錯誤訊息:", error.message);
                
                let errorMsg = '無法讀取群組列表';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Firebase 權限不足，請檢查 Firestore 安全規則';
                } else if (error.code === 'unavailable') {
                    errorMsg = '網路連線問題，請檢查網路';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                groupListContainer.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">${errorMsg}</p>`;
            }
        }
        
        async function handleCreateGroup(e) {
            e.preventDefault();
            const newGroupNameInput = document.getElementById('new-group-name');
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) return alert('群組名稱不可空白！');
            
            try {
                await db.collection('groups').add({
                    name: groupName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                newGroupNameInput.value = '';
                loadGroups();
            } catch (error) {
                console.error("建立群組失敗:", error);
                alert('建立群組失敗，請稍後再試。');
            }
        }

        async function handleRenameGroup(groupId, currentName) {
            const newName = prompt('請輸入新的單位群組名稱：', currentName);
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                try {
                    await db.collection('groups').doc(groupId).update({ name: newName.trim() });
                    loadGroups();
                } catch(error) {
                    console.error('更新群組名稱失敗:', error);
                    alert('更新失敗，請稍後再試。');
                }
            }
        }

        async function handleDeleteGroup(groupId, groupName) {
            const message = `您確定要刪除「${groupName}」單位群組嗎？\n\n警告：此操作將會永久刪除該群組底下的【所有門市】及其所有機台與記帳紀錄，且無法復原。`;
            showConfirmationModal(message, async () => {
                console.log(`開始刪除單位群組: ${groupId}`);
                try {
                    const groupRef = db.collection('groups').doc(groupId);
                    
                    const storesSnapshot = await groupRef.collection('stores').get();
                    for (const storeDoc of storesSnapshot.docs) {
                        const storeRef = storeDoc.ref;
                        
                        const machinesSnapshot = await storeRef.collection('machines').get();
                        if (!machinesSnapshot.empty) {
                            const machineBatch = db.batch();
                            machinesSnapshot.docs.forEach(doc => machineBatch.delete(doc.ref));
                            await machineBatch.commit();
                        }

                        const historySnapshot = await storeRef.collection('history').get();
                         if (!historySnapshot.empty) {
                            const historyBatch = db.batch();
                            historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                            await historyBatch.commit();
                        }

                        await storeRef.delete();
                    }

                    await groupRef.delete();

                    console.log(`單位群組 ${groupId} 已成功刪除。`);
                    hideConfirmationModal();
                    loadGroups();

                } catch(error) {
                    console.error('刪除單位群組失敗:', error);
                    alert('刪除失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }


        async function loadStores() {
            if(!selectedGroupId) return;
            try {
                const storeSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').orderBy('createdAt', 'desc').get();
                const stores = storeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStores(stores);
            } catch (error) {
                console.error("讀取門市列表失敗:", error);
                storeListContainer.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">無法讀取門市列表，請檢查網路連線或 Firebase 設定。</p>';
            }
        }
        
        async function loadStoreData() {
            if (!selectedGroupId || !selectedStoreId) return;
            console.log(`正在讀取群組[${selectedGroupId}] -> 門市 [${selectedStoreId}] 的資料...`);
            const machinesCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines');
            const historyCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').orderBy('date', 'desc');
            
            try {
                const machineSnapshot = await machinesCollection.get();
                const historySnapshot = await historyCollection.get();

                const machines = machineSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        docId: doc.id,
                        // ✅ 確保 devid 和 devidData 正確讀取
                        devid: data.devid || 1,
                        devidData: data.devidData || {},
                        mac: data.mac || '',
                        // 🔧 強制所有投幣/出貨數值為整數（四捨五入）
                        plays: Math.round(Number(data.plays) || 0),
                        payouts: Math.round(Number(data.payouts) || 0),
                        initialPlays: Math.round(Number(data.initialPlays) || 0),
                        initialPayouts: Math.round(Number(data.initialPayouts) || 0),
                        playsCalibration: Math.round(Number(data.playsCalibration) || 0),
                        payoutsCalibration: Math.round(Number(data.payoutsCalibration) || 0)
                    };
                });
                
                const history = historySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        docId: doc.id,
                        // 🔧 強制歷史記錄中所有數值為整數
                        newPlays: Math.round(Number(data.newPlays) || 0),
                        newPayouts: Math.round(Number(data.newPayouts) || 0),
                        totalRevenue: Math.round(Number(data.totalRevenue) || 0),
                        totalPayouts: Math.round(Number(data.totalPayouts) || 0)
                    };
                });

                appData.machines = machines;
                appData.history = history;
                
                console.log("✅ 資料讀取成功（已清潔化所有數值為整數）!", appData);
                
                // 🎁 載入禮品資料（背景執行，不阻塞）
                if (typeof loadGiftsData === 'function') {
                    loadGiftsData().catch(err => console.warn('載入禮品資料失敗:', err));
                }
                
                await updateUI();
                
                // 🚀 門市載入完成後，檢查並觸發自動輪詢
                console.log('📍 loadStoreData 完成，準備觸發自動輪詢檢查...');
                console.log(`   機台數量: ${appData?.machines?.length || 0}`);

                if (suppressNextAutoPoll) {
                    console.log('⏸️ 略過本次自動輪詢（suppressNextAutoPoll 已啟用）');
                    suppressNextAutoPoll = false;
                } else {
                    triggerAutoPollOnLoad();
                }

            } catch (error) {
                console.error(`讀取資料時發生錯誤:`, error);
                showFeedback("無法從雲端讀取資料，請檢查網路連線。", true);
            }
        }

        async function handleCreateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('未選擇單位群組');

            const newStoreNameInput = document.getElementById('new-store-name');
            const newStoreStartDateInput = document.getElementById('new-store-start-date');
            const storeName = newStoreNameInput.value.trim();
            const startDate = newStoreStartDateInput.value;

            if (!storeName || !startDate) return alert('門市名稱與起始日不可空白！');
            
            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: storeName,
                    startDate: startDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                createStoreForm.reset();
                newStoreStartDateInput.valueAsDate = new Date();
                loadStores(); 
            } catch (error) {
                console.error("建立門市失敗:", error);
                alert('建立門市失敗，請稍後再試。');
            }
        }
        
        async function handleCloneStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return alert('未選擇單位群組');

            const sourceStoreId = document.getElementById('clone-source-store-id').value;
            const sourceStoreName = document.getElementById('clone-source-store-name').textContent;
            const newStoreName = document.getElementById('clone-store-name').value.trim();
            const newStartDate = document.getElementById('clone-store-start-date').value;

            if (!newStoreName || !newStartDate) return alert('門市名稱與起始日不可空白！');
            
            if (!sourceStoreId) return alert('未指定來源門市！');

            // 確認對話框
            const confirmMessage = `確定要複製門市嗎？\n\n來源門市：${sourceStoreName}\n新門市名稱：${newStoreName}\n起始日期：${newStartDate}\n\n注意：\n• 將複製機台配置和設定\n• 所有帳務記錄將被清除\n• 機台數據將重置為 0`;
            
            if (!confirm(confirmMessage)) return;

            // 顯示處理中狀態
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '複製中...';

            try {
                console.log('🔄 開始複製門市...');
                
                // 步驟 1：創建新門市
                const newStoreRef = await db.collection('groups').doc(selectedGroupId).collection('stores').add({
                    name: newStoreName,
                    startDate: newStartDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    clonedFrom: sourceStoreId,
                    clonedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ 新門市已創建:', newStoreRef.id);
                
                // 步驟 2：複製機台配置（但不複製帳務數據）
                const sourceStoreRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(sourceStoreId);
                const machinesSnapshot = await sourceStoreRef.collection('machines').get();
                
                if (!machinesSnapshot.empty) {
                    console.log(`📦 找到 ${machinesSnapshot.size} 台機台，開始複製配置...`);
                    
                    const batch = db.batch();
                    machinesSnapshot.docs.forEach(machineDoc => {
                        const originalMachine = machineDoc.data();
                        
                        // 複製機台配置，但重置數據為 0
                        const newMachineData = {
                            id: originalMachine.id,
                            location: originalMachine.location,
                            mac: originalMachine.mac || '',
                            devid: originalMachine.devid || null,
                            initialPlays: 0, // 重置為 0
                            initialPayouts: 0, // 重置為 0
                            playsCalibration: 0, // 重置校正值
                            payoutsCalibration: 0, // 重置校正值
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            clonedFrom: machineDoc.id,
                            clonedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        const newMachineRef = newStoreRef.collection('machines').doc();
                        batch.set(newMachineRef, newMachineData);
                    });
                    
                    await batch.commit();
                    console.log('✅ 機台配置複製完成');
                } else {
                    console.log('ℹ️ 來源門市沒有機台配置');
                }
                
                // 步驟 3：關閉 Modal 並刷新列表
                cloneStoreModal.classList.add('hidden');
                cloneStoreForm.reset();
                loadStores();
                
                alert(`門市複製成功！\n\n新門市「${newStoreName}」已創建，機台配置已複製但帳務數據已清除。`);
                
            } catch (error) {
                console.error("複製門市失敗:", error);
                alert('複製門市失敗，請稍後再試。');
            } finally {
                // 恢復按鈕狀態
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function handleUpdateStore(e) {
            e.preventDefault();
            if(!selectedGroupId) return;

            const storeId = document.getElementById('edit-store-id').value;
            const newName = document.getElementById('edit-store-name').value.trim();
            const newStartDate = document.getElementById('edit-store-start-date').value;

            if (!newName || !newStartDate) return alert('門市名稱與起始日不可空白！');

            try {
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).update({
                    name: newName,
                    startDate: newStartDate
                });
                editStoreModal.classList.add('hidden');
                loadStores();
            } catch(error) {
                console.error('更新門市資訊失敗:', error);
                alert('更新失敗，請稍後再試。');
            }
        }

        
        async function handleDeleteStore(storeId, storeName) {
            if(!selectedGroupId) return;
            const message = `您確定要刪除「${storeName}」嗎？\n\n警告：此操作將會永久刪除該門市及其底下的所有機台與記帳紀錄，且無法復原。`;
            showConfirmationModal(message, async () => {
                try {
                    const storeRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId);
                    
                    const machinesSnapshot = await storeRef.collection('machines').get();
                    if(!machinesSnapshot.empty){
                        const batch1 = db.batch();
                        machinesSnapshot.docs.forEach(doc => batch1.delete(doc.ref));
                        await batch1.commit();
                    }

                    const historySnapshot = await storeRef.collection('history').get();
                     if(!historySnapshot.empty){
                        const batch2 = db.batch();
                        historySnapshot.docs.forEach(doc => batch2.delete(doc.ref));
                        await batch2.commit();
                    }

                    await storeRef.delete();
                    hideConfirmationModal();
                    loadStores();

                } catch(error) {
                    console.error('刪除門市失敗:', error);
                    alert('刪除失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }

        async function handleAddMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return alert('沒有選擇有效的門市。');

            const idInput = document.getElementById('new-machine-id');
            const locationInput = document.getElementById('new-machine-location');
            const initialPlaysInput = document.getElementById('new-machine-initial-plays');
            const initialPayoutsInput = document.getElementById('new-machine-initial-payouts');
            const macInput = document.getElementById('new-machine-mac');
            const devidInput = document.getElementById('new-machine-devid');

            const machineId = idInput.value.trim();
            const machineLocation = locationInput.value.trim();
            const initialPlays = parseInt(initialPlaysInput.value, 10) || 0;
            const initialPayouts = parseInt(initialPayoutsInput.value, 10) || 0;
            const macAddress = macInput.value.trim();
            const deviceId = parseInt(devidInput.value, 10) || null;


            if (!machineId || !machineLocation) return alert('機台編號和位置不能為空！');
            
            try {
                // ✅ 構建機台資料，包含 devidData 結構
                const machineData = {
                    id: machineId,
                    location: machineLocation,
                    plays: initialPlays, // 總表數從起始值開始
                    payouts: initialPayouts, // 總表數從起始值開始
                    initialPlays: initialPlays,
                    initialPayouts: initialPayouts,
                    // MQTT 相關欄位
                    mac: macAddress,
                    devid: deviceId || 1,
                    mqttLastCoinCount: 0,
                    mqttLastPayoutCount: 0,
                };
                
                // ✅ 如果有 MAC 和設備ID，建立 devidData 結構
                if (macAddress && deviceId) {
                    machineData.devidData = {
                        [deviceId.toString()]: macAddress
                    };
                }
                
                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').add(machineData);
                
                console.log('✅ 新增機台:', machineData);
                addMachineForm.reset();
                
                // 📊 重新載入資料並強制重建映射表
                await loadStoreData();
                console.log('✅ 機台新增完成，重建映射表');
                window.machineConfigMap = null; // 強制重建
                buildMachineConfigMap();
                
            } catch(error) {
                console.error("新增機台失敗：", error);
                alert('新增機台失敗，請稍後再試。');
            }
        }

        async function handleDeleteMachine(docId) {
            if(!selectedStoreId || !selectedGroupId || !docId) return;
            showConfirmationModal('您確定要刪除這台機器嗎？此操作無法復原。', async () => {
                try {
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).delete();
                    hideConfirmationModal();
                    
                    // 📊 重新載入資料並強制重建映射表
                    await loadStoreData();
                    console.log('✅ 機台刪除完成，重建映射表');
                    window.machineConfigMap = null; // 強制重建
                    buildMachineConfigMap();
                    
                } catch (error) {
                    console.error("刪除機台失敗：", error);
                    alert('刪除機台失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }

        // 計算並更新當前機台統計數據
        async function updateCurrentMachineStats(docId) {
            try {
                console.log('🔍 開始計算機台統計數據，docId:', docId);
                
                // 重置顯示
                document.getElementById('edit-current-plays').textContent = '--';
                document.getElementById('edit-current-payouts').textContent = '--';
                document.getElementById('edit-current-cost').textContent = '--';
                
                // 找到對應的機台資料
                const machine = appData.machines.find(m => m.docId === docId);
                if (!machine) {
                    console.error('找不到機台資料');
                    return;
                }
                
                // 計算有效投幣和出貨數（含校正值）
                const effectivePlays = (machine.totalPlays || 0) + (machine.playsCalibration || 0);
                const effectivePayouts = (machine.totalPayouts || 0) + (machine.payoutsCalibration || 0);
                const revenue = effectivePlays * COIN_VALUE;
                const avgCost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                
                // 更新顯示
                document.getElementById('edit-current-plays').textContent = effectivePlays.toLocaleString();
                document.getElementById('edit-current-payouts').textContent = effectivePayouts.toLocaleString();
                document.getElementById('edit-current-cost').textContent = effectivePayouts > 0 ? `${Math.round(avgCost)} 元` : '-- 元';
                
                console.log('📊 機台統計更新完成:', {
                    plays: effectivePlays,
                    payouts: effectivePayouts,
                    avgCost: Math.round(avgCost)
                });
                
            } catch (error) {
                console.error('計算機台統計數據失敗:', error);
                document.getElementById('edit-current-plays').textContent = '錯誤';
                document.getElementById('edit-current-payouts').textContent = '錯誤';
                document.getElementById('edit-current-cost').textContent = '錯誤';
            }
        }

        // 帶預覽功能的機台統計更新（考慮用戶正在輸入的校正值）
        async function updateCurrentMachineStatsWithPreview(docId) {
            try {
                console.log('🔍 開始計算機台統計數據（含預覽），docId:', docId);
                
                // 找到對應的機台資料
                const machine = appData.machines.find(m => m.docId === docId);
                if (!machine) {
                    console.error('找不到機台資料');
                    return;
                }
                
                // 取得用戶正在輸入的校正值
                const previewPlaysCalibration = parseInt(document.getElementById('edit-machine-plays-calibration').value) || 0;
                const previewPayoutsCalibration = parseInt(document.getElementById('edit-machine-payouts-calibration').value) || 0;
                
                // 計算有效投幣和出貨數（使用預覽校正值）
                const effectivePlays = (machine.totalPlays || 0) + previewPlaysCalibration;
                const effectivePayouts = (machine.totalPayouts || 0) + previewPayoutsCalibration;
                const revenue = effectivePlays * COIN_VALUE;
                const avgCost = effectivePayouts > 0 ? revenue / effectivePayouts : 0;
                
                // 更新顯示
                document.getElementById('edit-current-plays').textContent = effectivePlays.toLocaleString();
                document.getElementById('edit-current-payouts').textContent = effectivePayouts.toLocaleString();
                document.getElementById('edit-current-cost').textContent = effectivePayouts > 0 ? `${Math.round(avgCost)} 元` : '-- 元';
                
                console.log('📊 機台統計預覽更新完成:', {
                    plays: effectivePlays,
                    payouts: effectivePayouts,
                    avgCost: Math.round(avgCost),
                    playsCalibration: previewPlaysCalibration,
                    payoutsCalibration: previewPayoutsCalibration
                });
                
            } catch (error) {
                console.error('計算機台統計數據失敗:', error);
                document.getElementById('edit-current-plays').textContent = '錯誤';
                document.getElementById('edit-current-payouts').textContent = '錯誤';
                document.getElementById('edit-current-cost').textContent = '錯誤';
            }
        }
        
        async function handleUpdateMachine(e) {
            e.preventDefault();
            if (!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-machine-doc-id').value;
            const newId = document.getElementById('edit-machine-id').value.trim();
            const newLocation = document.getElementById('edit-machine-location').value.trim();
            const newMac = document.getElementById('edit-machine-mac').value.trim();
            const newDevid = parseInt(document.getElementById('edit-machine-devid').value, 10) || 1;
            const newInitialPlays = parseInt(document.getElementById('edit-machine-initial-plays').value, 10) || 0;
            const newInitialPayouts = parseInt(document.getElementById('edit-machine-initial-payouts').value, 10) || 0;
            const newPlaysCalibration = parseInt(document.getElementById('edit-machine-plays-calibration').value, 10) || 0;
            const newPayoutsCalibration = parseInt(document.getElementById('edit-machine-payouts-calibration').value, 10) || 0;
            const newGiftId = document.getElementById('edit-machine-gift')?.value || null;

            if (!newId || !newLocation) return alert('機台編號和位置不能為空！');

            // Find the original machine data to calculate the difference
            const originalMachine = appData.machines.find(m => m.docId === docId);
            if (!originalMachine) {
                alert('錯誤：找不到原始機台資料！');
                return;
            }

            // 正確邏輯：只更新起始值，不改變總累積數值
            // 營收計算：有效營收 = 總累積 - 新起始值
            // 這樣修改起始值時，營收會正確地重新計算
            
            try {
                // 顯示處理中狀態
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '更新中...';
                submitBtn.disabled = true;

                // ✅ 構建 devidData 結構，支援多設備ID
                const devidData = {};
                if (newMac) {
                    devidData[newDevid.toString()] = newMac;
                    // 保留舊的 devidData，只更新當前 devid
                    if (originalMachine.devidData) {
                        Object.keys(originalMachine.devidData).forEach(key => {
                            if (key !== newDevid.toString()) {
                                devidData[key] = originalMachine.devidData[key];
                            }
                        });
                    }
                }

                // 更新機台資料 - 包含校正值、輪詢設定和 devidData
                const updateData = {
                    id: newId,
                    location: newLocation,
                    mac: newMac,
                    devid: newDevid,  // 保留舊欄位向下相容
                    initialPlays: newInitialPlays,
                    initialPayouts: newInitialPayouts,
                    playsCalibration: newPlaysCalibration,
                    payoutsCalibration: newPayoutsCalibration,
                    giftId: newGiftId
                    // plays 和 payouts 保持原值，不更新
                };
                
                // ✅ 只在有 MAC 時才加入 devidData
                if (newMac && Object.keys(devidData).length > 0) {
                    updateData.devidData = devidData;
                }

                await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(docId).update(updateData);
                
                console.log(`🔧 機台 ${newId}/${newLocation} 更新完成:`);
                console.log(`   MAC: ${newMac}, 設備ID: ${newDevid}`, updateData.devidData ? ', devidData: ' + JSON.stringify(updateData.devidData) : '');
                console.log(`   校正值 - 投幣: ${newPlaysCalibration}, 出貨: ${newPayoutsCalibration}`);

                // 關閉編輯視窗
                editMachineModal.classList.add('hidden');
                
                // ✅ 重建機台配置映射
                window.machineConfigMap = null;
                window.machineConfigMapByDevid = null;
                
                // 重新載入並重新計算所有資料
                await loadStoreData();
                
                // 強制更新所有UI元件以反映新的計算結果
                setTimeout(async () => {
                    await updateUI();
                    
                    // 確保所有頁面的數據都被更新
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const tabName = activeTab.dataset.tab;
                        switch(tabName) {
                            case 'summary':
                                await renderSummaryTab();
                                break;
                            case 'analysis':
                                renderAnalysisTab();
                                break;
                            case 'statistics':
                                renderStatisticsTab();
                                break;
                            case 'charts':
                                await renderChartsTab();
                                break;
                            case 'checkout':
                                renderCheckoutTab();
                                break;
                        }
                    }
                    
                    console.log('機台資料更新完成，所有統計數據已重新計算');
                }, 200);

                showFeedback('✅ 機台起始值更新成功！<br>📊 營收計算基準已調整：營收 = 歷史累積 - 新起始值', false);

                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error("更新機台資訊失敗：", error);
                showFeedback('更新機台資訊失敗，請稍後再試。', true);
                
                // 恢復按鈕狀態
                const submitBtn = editMachineForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
            }
        }


        async function handleUpdateHistory(e) {
            e.preventDefault();
            if(!selectedStoreId || !selectedGroupId) return;

            const docId = document.getElementById('edit-history-doc-id').value;
            const machineId = document.getElementById('edit-history-machine-id').value;
            const location = document.getElementById('edit-history-location').value;
            const newDate = document.getElementById('edit-history-date').value;
            const oldPlays = parseInt(document.getElementById('edit-history-old-plays').value, 10);
            const oldPayouts = parseInt(document.getElementById('edit-history-old-payouts').value, 10);
            const newPlays = parseInt(document.getElementById('edit-history-plays').value, 10);
            const newPayouts = parseInt(document.getElementById('edit-history-payouts').value, 10);
            
            if (!newDate) {
                alert('錯誤：請選擇紀錄日期。');
                return;
            }
            
            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('錯誤：找不到對應的機台來更新數據。');
                return;
            }

            const playsDiff = newPlays - oldPlays;
            const payoutsDiff = newPayouts - oldPayouts;

            const newTotalPlays = machineToUpdate.plays + playsDiff;
            const newTotalPayouts = machineToUpdate.payouts + payoutsDiff;
            
            try {
                // Batch update
                const batch = db.batch();
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                batch.update(machineRef, {
                    plays: newTotalPlays,
                    payouts: newTotalPayouts
                });

                const historyRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(docId);
                batch.update(historyRef, {
                    date: newDate,
                    newPlays: newPlays,
                    newPayouts: newPayouts
                });

                await batch.commit();

                editHistoryModal.classList.add('hidden');
                showFeedback("記帳紀錄已更新！", false);
                loadStoreData();
            } catch(error) {
                console.error("更新記帳紀錄失敗：", error);
                alert('更新紀錄失敗，請稍後再試。');
            }
        }


        async function handleDeleteHistory(historyDocId, machineId, location, dailyPlays, dailyPayouts) {
            if(!selectedStoreId || !selectedGroupId || !historyDocId || !machineId) return;

            const machineToUpdate = appData.machines.find(m => m.id === machineId && m.location === location);
            if (!machineToUpdate) {
                alert('錯誤：找不到對應的機台來回滾數據。');
                return;
            }
            
            showConfirmationModal('您確定要刪除這筆記帳紀錄嗎？系統將自動回滾機台數據。', async () => {
                const revertedPlays = machineToUpdate.plays - dailyPlays;
                const revertedPayouts = machineToUpdate.payouts - dailyPayouts;

                if(revertedPlays < (machineToUpdate.initialPlays || 0) || revertedPayouts < (machineToUpdate.initialPayouts || 0) ) {
                    alert('錯誤：刪除此紀錄會導致機台累積數變為負數或小於起始值，操作已取消。');
                    hideConfirmationModal();
                    return;
                }

                try {
                    const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineToUpdate.docId);
                    await machineRef.update({
                        plays: revertedPlays,
                        payouts: revertedPayouts
                    });
                    await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('history').doc(historyDocId).delete();
                    
                    hideConfirmationModal();
                    showFeedback("記帳紀錄已刪除並成功回滾數據！", false);
                    loadStoreData();

                } catch (error) {
                    console.error("刪除記帳紀錄失敗：", error);
                    alert('刪除紀錄失敗，請稍後再試。');
                    hideConfirmationModal();
                }
            });
        }
        
        function getAggregatedSummaryData(period = 'all') {
            let dataToAggregate;

            if (period === 'all') {
                dataToAggregate = appData.machines.map(m => {
                    // 🔧 確保計算時都用整數
                    const plays = Math.round(Number(m.plays) || 0);
                    const initialPlays = Math.round(Number(m.initialPlays) || 0);
                    const effectivePlays = plays - initialPlays;
                    const payouts = Math.round(Number(m.payouts) || 0);
                    const initialPayouts = Math.round(Number(m.initialPayouts) || 0);
                    const effectivePayouts = payouts - initialPayouts;
                    return { id: m.id, plays: effectivePlays, payouts: effectivePayouts };
                });
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                        startDate = new Date(new Date().setDate(diff));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                const filteredHistory = appData.history.filter(h => new Date(h.date) >= startDate);

                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: Math.round(Number(h.newPlays) || 0),
                    payouts: Math.round(Number(h.newPayouts) || 0)
                }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                // 🔧 確保投幣金額計算是整數
                const plays = Math.round(s.plays);
                const payouts = Math.round(s.payouts);
                const revenue = plays * COIN_VALUE;  // ✅ 永遠是整數
                const cost = payouts > 0 ? revenue / payouts : 0;
                return { id: s.id, revenue, payouts, cost };
            });
        }
        
        // 基於篩選後的歷史記錄獲取營業明細資料
        function getAggregatedSummaryDataFromHistory(period = 'all', filteredHistory) {
            let dataToAggregate;

            if (period === 'all') {
                // 使用篩選後的歷史記錄
                dataToAggregate = filteredHistory.map(h => ({
                    id: h.machineId,
                    plays: Math.round(Number(h.newPlays) || 0),
                    payouts: Math.round(Number(h.newPayouts) || 0)
                }));
            } else {
                const now = new Date();
                let startDate;

                switch(period) {
                    case 'weekly':
                        const day = now.getDay();
                        const daysToFriday = (day + 7 - 5) % 7;
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - daysToFriday);
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'monthly':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        break;
                }

                // 在已篩選的歷史記錄中再次按期間篩選
                dataToAggregate = filteredHistory
                    .filter(h => new Date(h.date) >= startDate)
                    .map(h => ({
                        id: h.machineId,
                        plays: h.newPlays || 0,
                        payouts: h.newPayouts || 0
                    }));
            }

            const summary = dataToAggregate.reduce((acc, curr) => {
                if (!acc[curr.id]) {
                    acc[curr.id] = { id: curr.id, plays: 0, payouts: 0 };
                }
                acc[curr.id].plays += curr.plays;
                acc[curr.id].payouts += curr.payouts;
                return acc;
            }, {});

            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { id: s.id, revenue, payouts: s.payouts, cost };
            });
        }
        
        async function handlePerformCheckout() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');

            try {
                const checkoutSnapshot = await checkoutCollection.limit(1).get();
                let lastCheckoutRevenue = 0;
                let lastCheckoutDate = appData.startDate;

                if (!checkoutSnapshot.empty) {
                    const lastCheckout = checkoutSnapshot.docs[0].data();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    lastCheckoutDate = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                }

                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;

                if (pendingAmount <= 0) {
                    alert("目前沒有待結帳金額。");
                    return;
                }
                
                showConfirmationModal(`您確定要結算本期營收 ${pendingAmount.toLocaleString()} 元嗎？`, async () => {
                     try {
                        // 計算出貨數量和盈利數據
                        const processedMachines = appData.machines.map(processMachineData);
                        const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                        
                        // 載入成本設定
                        const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
                        const giftCost = settings.giftCost || 50;
                        const rentPercentage = settings.rentPercentage || 30;
                        const taxPercentage = settings.taxPercentage || 5;
                        
                        // 計算各項成本（基於總營收）
                        const totalGiftCost = totalPayouts * giftCost;
                        const totalRentCost = currentTotalRevenue * (rentPercentage / 100);
                        const totalTaxCost = currentTotalRevenue * (taxPercentage / 100);
                        const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
                        const netProfit = currentTotalRevenue - totalCost;
                        
                        // 計算本期盈利（僅針對本期待結帳金額）
                        let lastCheckoutPayouts = 0;
                        if (!checkoutSnapshot.empty) {
                            const lastCheckout = checkoutSnapshot.docs[0].data();
                            lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                        }
                        const pendingPayouts = totalPayouts - lastCheckoutPayouts;
                        const pendingGiftCost = pendingPayouts * giftCost;
                        const pendingRentCost = pendingAmount * (rentPercentage / 100);
                        const pendingTaxCost = pendingAmount * (taxPercentage / 100);
                        const pendingTotalCost = pendingGiftCost + pendingRentCost + pendingTaxCost;
                        const pendingNetProfit = pendingAmount - pendingTotalCost;
                        
                        const newCheckoutData = {
                            checkoutDate: firebase.firestore.FieldValue.serverTimestamp(),
                            checkoutAmount: pendingAmount,
                            cumulativeRevenueAtCheckout: currentTotalRevenue,
                            // 新增出貨數量記錄
                            checkoutPayouts: pendingPayouts,
                            cumulativePayoutsAtCheckout: totalPayouts,
                            // 新增總盈利計算
                            totalProfit: {
                                giftCost: totalGiftCost,
                                rentCost: totalRentCost,
                                taxCost: totalTaxCost,
                                totalCost: totalCost,
                                netProfit: netProfit,
                                costSettings: { giftCost, rentPercentage, taxPercentage }
                            },
                            // 新增本期盈利計算
                            periodProfit: {
                                giftCost: pendingGiftCost,
                                rentCost: pendingRentCost,
                                taxCost: pendingTaxCost,
                                totalCost: pendingTotalCost,
                                netProfit: pendingNetProfit,
                                payouts: pendingPayouts
                            }
                        };
                        const newCheckoutRef = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').add(newCheckoutData);
                        
                        hideConfirmationModal();
                        showFeedback("結帳成功！正在重新統計所有資料...", false);
                        
                        console.log('🎯 結帳完成，開始重新統計所有資料...');
                        
                        // 等待一小段時間確保資料庫寫入完成
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // 重新整理所有統計資料
                        const refreshSuccess = await refreshAllStatistics();
                        
                        if (refreshSuccess) {
                            // 顯示完成訊息
                            showFeedback("🎉 結帳完成！所有統計資料已更新。", false);
                        } else {
                            showFeedback("結帳完成，但統計更新時發生問題，請手動重新整理。", true);
                        }

                    } catch (error) {
                        hideConfirmationModal();
                        console.error("結帳失敗:", error);
                        showFeedback("結帳失敗，請稍後再試。", true);
                    }
                });
            } catch (error) {
                console.error("處理結帳時發生錯誤:", error);
                showFeedback("處理結帳時發生錯誤，請稍後再試。", true);
            }
        }

        // 統計資料重新整理函數
        async function refreshAllStatistics() {
            console.log('🔄 開始重新整理所有統計資料...');
            
            try {
                // 重新載入最新資料 (loadStoreData 會自動調用 updateUI)
                console.log('📥 重新載入門市資料...');
                await loadStoreData();
                
                // 等待資料載入完成
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 確保資料已更新
                if (!appData || !appData.machines) {
                    console.warn('⚠️ 資料載入失敗，無法重新計算統計');
                    return false;
                }
                
                console.log('📊 資料載入完成，機台數量:', appData.machines.length);
                console.log('📈 歷史記錄數量:', appData.history?.length || 0);
                
                // 手動觸發各個頁面的重新渲染
                console.log('🔄 重新渲染所有統計頁面...');
                
                // 重新處理機台資料
                const processedMachines = appData.machines.map(processMachineData);
                
                // 強制重新渲染所有統計頁面
                await renderSummaryTab();
                renderAnalysisTab();
                renderStatisticsTab();
                await renderChartsTab();
                renderProfitTab();
                renderCheckoutTab();
                
                // 如果當前正在顯示某個統計頁面，強制重新整理該頁面
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.dataset.tab;
                    console.log('🎯 當前活動頁籤:', tabName);
                    
                    // 根據當前頁籤執行對應的渲染函數
                    switch(tabName) {
                        case 'summary':
                            setTimeout(async () => await renderSummaryTab(), 200);
                            break;
                        case 'analysis':
                            setTimeout(() => renderAnalysisTab(), 200);
                            break;
                        case 'statistics':
                            setTimeout(() => renderStatisticsTab(), 200);
                            break;
                        case 'charts':
                            setTimeout(async () => await renderChartsTab(), 200);
                            break;
                        case 'profit':
                            setTimeout(() => renderProfitTab(), 200);
                            break;
                        case 'checkout':
                            setTimeout(() => renderCheckoutTab(), 200);
                            break;
                    }
                }
                
                console.log('✅ 所有統計資料重新整理完成');
                return true;
            } catch (error) {
                console.error('❌ 重新整理統計資料時發生錯誤:', error);
                return false;
            }
        }

        // 設定統計範圍的全局變數
        let currentStatsRange = 'current'; // 預設為當期統計
        let currentChartsRange = 'current';
        let currentSummaryRange = 'current';

        // 根據統計範圍篩選資料
        function filterDataByRange(data, range) {
            if (range === 'all') {
                return data; // 返回全部資料
            }
            
            // 當期資料篩選 - 根據最後結帳日期
            const lastCheckoutDate = getLastCheckoutDate();
            if (!lastCheckoutDate) {
                return data; // 如果沒有結帳記錄，返回全部資料
            }
            
            // 篩選結帳日期之後的資料
            return data.filter(record => {
                if (!record.date) return true;
                const recordDate = new Date(record.date);
                return recordDate > lastCheckoutDate;
            });
        }

        // 取得最後結帳日期
        function getLastCheckoutDate() {
            try {
                // 這裡應該從 Firebase 取得最後結帳日期
                // 暫時返回 null，表示使用全部資料
                return null;
            } catch (error) {
                console.error('取得最後結帳日期時發生錯誤:', error);
                return null;
            }
        }

        // 取得最後結帳的累計資料
        async function getLastCheckoutData() {
            if (!selectedGroupId || !selectedStoreId) {
                return { revenue: 0, payouts: 0, plays: 0 };
            }

            try {
                // ✅ 檢查是否還有歷史記錄
                const historyCollection = db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('history');

                const historySnapshot = await historyCollection.limit(1).get();

                // ✅ 如果沒有歷史記錄，直接返回 0（忽略結帳記錄）
                if (historySnapshot.empty) {
                    console.log('📊 沒有歷史記錄，返回 0 值（忽略結帳記錄）');
                    return { revenue: 0, payouts: 0, plays: 0 };
                }

                const checkoutCollection = db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('checkouts')
                    .orderBy('checkoutDate', 'desc');

                const checkoutSnapshot = await checkoutCollection.limit(1).get();

                if (checkoutSnapshot.empty) {
                    // 沒有結帳記錄，返回 0
                    console.log('📊 沒有結帳記錄，返回 0 值');
                    return { revenue: 0, payouts: 0, plays: 0 };
                }

                const lastCheckout = checkoutSnapshot.docs[0].data();
                const lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                const lastCheckoutPlays = lastCheckoutRevenue / COIN_VALUE; // 從營收反推投幣次數

                console.log('📊 最後結帳累計資料:', {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                });

                return {
                    revenue: lastCheckoutRevenue,
                    payouts: lastCheckoutPayouts,
                    plays: lastCheckoutPlays
                };
            } catch (error) {
                console.error('取得最後結帳資料時發生錯誤:', error);
                return { revenue: 0, payouts: 0, plays: 0 };
            }
        }

        // Debug 函數 - 測試重新統計功能
        window.testRefreshStatistics = function() {
            console.log('🧪 測試重新統計功能...');
            console.log('當前資料狀態:');
            console.log('- 機台數量:', appData?.machines?.length || 0);
            console.log('- 歷史記錄數量:', appData?.history?.length || 0);
            console.log('- 選定群組ID:', selectedGroupId);
            console.log('- 選定門市ID:', selectedStoreId);
            
            // 手動觸發重新統計
            refreshAllStatistics().then(success => {
                console.log('重新統計結果:', success ? '成功' : '失敗');
            });
        };

        // Debug 函數 - 檢查當前統計設定
        window.checkStatisticsSettings = function() {
            console.log('📊 當前統計設定:');
            console.log('- 統計頁面範圍:', currentStatsRange);
            console.log('- 圖表頁面範圍:', currentChartsRange);  
            console.log('- 營業明細範圍:', currentSummaryRange);
            
            const activeTab = document.querySelector('.tab-btn.active');
            console.log('- 當前活動頁籤:', activeTab?.dataset?.tab || '無');
        };


        // --- UI RENDERING FUNCTIONS ---
        function renderGroups(groups) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            groupListContainer.innerHTML = '';
            if (groups.length === 0) {
                const noGroupsMessage = isAdmin ? 
                    '尚未建立任何單位群組。' : 
                    '您沒有權限訪問任何群組，請聯繫管理員。';
                groupListContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center py-8">${noGroupsMessage}</p>`;
                return;
            }
            groups.forEach(group => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 pt-3">
                        <button class="rename-group-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">改名</button>
                        <button class="delete-group-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-group-id="${group.id}" data-group-name="${group.name}">刪除</button>
                    </div>
                ` : '';
                
                const groupCard = `
                    <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="card-base group-card-main cursor-pointer p-4 mb-3" data-group-id="${group.id}" data-group-name="${group.name}">
                            <h3 class="text-xl font-bold text-white truncate text-center">${group.name}</h3>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                groupListContainer.innerHTML += groupCard;
            });
            
            // 隱藏新增群組表單（如果是訪客）
            const createGroupForm = document.getElementById('create-group-form').parentElement;
            if (createGroupForm) {
                if (isAdmin) {
                    createGroupForm.style.display = 'block';
                } else {
                    createGroupForm.style.display = 'none';
                }
            }
        }
        
        function renderStores(stores) {
            const userType = localStorage.getItem('userType');
            const isAdmin = userType === 'admin';
            
            storeListContainer.innerHTML = ''; 
            if (stores.length === 0) {
                storeListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">此群組尚未建立任何門市。</p>';
                return;
            }
            stores.forEach(store => {
                const adminButtons = isAdmin ? `
                    <div class="flex justify-end gap-2 border-t border-gray-600 px-4 py-3">
                        <button class="edit-store-btn text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">編輯</button>
                        <button class="clone-store-btn text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded flex items-center gap-1" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                            </svg>
                            複製
                        </button>
                        <button class="delete-store-btn text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded" data-store-id="${store.id}" data-store-name="${store.name}">刪除</button>
                    </div>
                ` : '';
                
                const storeCard = `
                     <div class="bg-gray-700 rounded-lg">
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="card-base store-card-main cursor-pointer flex-grow" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}">
                                    <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                                </div>
                                <input type="checkbox" class="store-checkbox h-6 w-6 bg-gray-800 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600 shrink-0 ml-3 cursor-pointer" value="${store.id}" data-store-id="${store.id}" data-store-name="${store.name}" data-start-date="${store.startDate}" checked>
                            </div>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                storeListContainer.innerHTML += storeCard;
            });
        }
        
        async function updateUI() {
            if (!appData || !appData.machines) return;
            
            // 📊 每次 UI 更新時重建機台配置映射表
            console.log('🔄 開始重建機台配置映射表...');
            window.machineConfigMap = null; // 強制重建
            buildMachineConfigMap();
            
            const processedMachines = appData.machines.map(processMachineData);
            await renderMainStats(processedMachines);
            renderDetailsTable(processedMachines);
            await renderSummaryTab();
            renderAnalysisTab();
            renderAccountingTab();
            renderMachineManagementTab(); 
            await renderChartsTab();
            renderStatisticsTab();
            renderProfitTab();
            updateFooterAndHeader();
            
            // � 刷新 HTTP 輪詢自動記帳表格
            // 這樣進入門市時會顯示之前「立即讀取所有門市資料」功能收集的記錄
            if (typeof refreshAutoRecordTable === 'function') {
                console.log('🔄 刷新 HTTP 輪詢自動記帳表格...');
                refreshAutoRecordTable();
            }
            
            // �🚀 載入自動輪詢設定
            const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
            if (autoPollOnLoadCheckbox && selectedGroupId && selectedStoreId) {
                const currentSetting = getAutoPollOnLoadSetting();
                autoPollOnLoadCheckbox.checked = currentSetting;
                console.log(`🔄 更新 UI：自動輪詢勾選框狀態設為 ${currentSetting}`);
            } else {
                console.log(`⚠️ 無法更新自動輪詢設定 - checkbox: ${!!autoPollOnLoadCheckbox}, selectedGroupId: ${selectedGroupId}, selectedStoreId: ${selectedStoreId}`);
            }
            
            // 💎 診斷異常成本情況
            diagnoseAbnormalCosts(processedMachines);
        }

        function renderMachineManagementTab() {
            machineListTableBody.innerHTML = '';
            if (!appData.machines || appData.machines.length === 0) {
                machineListTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-400">此門市尚無機台，請先建立一台。</td></tr>`;
                // ✅ 重置事件監聽器標記，以便重新綁定
                machineListTableBody._mqttInputHandler = false;
                return;
            }
            appData.machines.forEach(machine => {
                console.log('渲染機台:', machine); // 調試用
                console.log(`  機台 ${machine.id}: MAC=${machine.mac}, DevID=${machine.devid}, 校正值=${machine.playsCalibration || 0}/${machine.payoutsCalibration || 0}`);
                
                // 取得禮品資料
                const gift = (typeof giftsData !== 'undefined' && Array.isArray(giftsData)) ? 
                    giftsData.find(g => g.id === machine.giftId) : null;
                
                const row = `
                    <tr class="hover:bg-gray-700/50" data-machine-id="${machine.docId}">
                        <td class="p-2">
                            <div class="w-14 h-14 bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden cursor-pointer" 
                                 onclick="showQuickGiftSelector('${machine.docId}')" title="點擊設定禮品">
                                ${gift && gift.imageUrl ? 
                                    `<img src="${gift.imageUrl}" class="w-full h-full object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-2xl\\'>🎁</span>'">` :
                                    `<span class="text-2xl text-gray-500">${gift ? '🎁' : '❓'}</span>`
                                }
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full text-sm">${machine.id || '--'}</div>
                        </td>
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full text-sm">${machine.location || '--'}</div>
                        </td>
                        <td class="p-4">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-full font-mono text-sm">${machine.mac || '--'}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-16 text-center mx-auto">${machine.devid || 1}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-24 text-center mx-auto">${machine.initialPlays || 0}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="bg-gray-700 text-white rounded px-3 py-2 w-24 text-center mx-auto">${machine.initialPayouts || 0}</div>
                        </td>
                        <td class="p-2 text-center" style="background-color: #1a202c;">
                            <div class="bg-gray-600 text-white rounded px-3 py-2 w-20 text-center text-sm mx-auto" title="投幣校正值 (正數加，負數減)">
                                ${machine.playsCalibration || 0}
                            </div>
                        </td>
                        <td class="p-2 text-center" style="background-color: #1a202c;">
                            <div class="bg-gray-600 text-white rounded px-3 py-2 w-20 text-center text-sm mx-auto" title="出貨校正值 (正數加，負數減)">
                                ${machine.payoutsCalibration || 0}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <button class="poll-machine-btn bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded mr-1" 
                                data-doc-id="${machine.docId}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                title="讀取機台資料">
                                📊
                            </button>
                            <button class="edit-machine-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2" 
                                data-doc-id="${machine.docId}" 
                                data-id="${machine.id}"
                                data-location="${machine.location}"
                                data-mac="${machine.mac || ''}"
                                data-devid="${machine.devid || 1}"
                                data-initial-plays="${machine.initialPlays || 0}"
                                data-initial-payouts="${machine.initialPayouts || 0}"
                                data-plays-calibration="${machine.playsCalibration || 0}"
                                data-payouts-calibration="${machine.payoutsCalibration || 0}"
                                data-total-plays="${machine.totalPlays || 0}"
                                data-total-payouts="${machine.totalPayouts || 0}"
                                data-gift-id="${machine.giftId || ''}">
                                修改
                           </button>
                            <button class="delete-machine-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" data-doc-id="${machine.docId}">刪除</button>
                        </td>
                    </tr>
                `;
                machineListTableBody.innerHTML += row;
            });
            
            // ✅ 重置事件監聽器標記，以便重新綁定新的 input 元素
            machineListTableBody._mqttInputHandler = false;
            
            // ✅ 重新初始化事件監聽器
            setTimeout(() => {
                initializeMqttPolling();
            }, 0);
        }
        
        async function renderMainStats(data) {
            console.log('📊 開始計算總統計資料...');
            
            // 計算當前總數據
            const currentTotalPlays = data.reduce((sum, m) => sum + m.effectivePlays, 0);
            const currentTotalRevenue = currentTotalPlays * COIN_VALUE;
            const currentTotalPayouts = data.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 取得最後結帳的累計資料
            const lastCheckoutData = await getLastCheckoutData();
            
            // 計算當期未結帳的數據（總數據 - 最後結帳累計數據）
            const pendingPlays = Math.max(0, currentTotalPlays - lastCheckoutData.plays);
            const pendingRevenue = Math.max(0, currentTotalRevenue - lastCheckoutData.revenue);
            const pendingPayouts = Math.max(0, currentTotalPayouts - lastCheckoutData.payouts);
            
            // 🔧 確保投幣金額是10的倍數
            const correctedPendingRevenue = Math.round(pendingRevenue / 10) * 10;
            const pendingAvgCost = pendingPayouts > 0 ? correctedPendingRevenue / pendingPayouts : 0;
            
            console.log('📈 統計資料計算結果:', {
                current: { plays: currentTotalPlays, revenue: currentTotalRevenue, payouts: currentTotalPayouts },
                lastCheckout: lastCheckoutData,
                pending: { plays: pendingPlays, revenue: correctedPendingRevenue, payouts: pendingPayouts, avgCost: pendingAvgCost }
            });
            
            // 更新顯示（顯示當期未結帳數據）
            document.getElementById('total-plays').textContent = `${pendingPlays.toLocaleString()} 次`;
            document.getElementById('total-revenue').textContent = `${correctedPendingRevenue.toLocaleString()} 元`;
            document.getElementById('total-payouts').textContent = `${pendingPayouts.toLocaleString()} 次`;
            // ✅ 使用 formatCost 顯示整數
            document.getElementById('avg-cost').textContent = `${Math.round(pendingAvgCost)} 元/次`;
            
            // 儲存當期數據到全域變數供其他函數使用
            window.currentPendingStats = {
                plays: pendingPlays,
                revenue: correctedPendingRevenue,
                payouts: pendingPayouts,
                avgCost: pendingAvgCost
            };
        }

        function renderDetailsTable(data) {
            const tableBody = document.getElementById('details-table-body');
            const searchTerm = searchInput.value.toLowerCase();
            let filteredData = data.filter(item => item.id.toLowerCase().includes(searchTerm));
            
            filteredData.sort((a, b) => {
                // Primary comparison based on the selected column
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                let primaryCompare = 0;
                if(typeof valA === 'number' && typeof valB === 'number') {
                    primaryCompare = valA - valB;
                } else {
                    primaryCompare = String(valA).localeCompare(String(valB), undefined, { numeric: true });
                }

                if (primaryCompare !== 0) {
                    return currentSort.direction === 'asc' ? primaryCompare : -primaryCompare;
                }

                // Secondary Sorting Logic
                if (currentSort.key !== 'id') {
                    const idCompare = a.id.localeCompare(b.id, undefined, { numeric: true });
                    if (idCompare !== 0) return idCompare;
                }

                // Tertiary Sorting Logic (or secondary if sorting by ID)
                return a.location.localeCompare(b.location, undefined, { numeric: true });
            });

            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">找不到符合條件的資料</td></tr>`;
                return;
            }
            filteredData.forEach(item => {
                const row = `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${item.id}</td>
                    <td class="p-4">${item.location}</td>
                    <td class="p-4 text-right">${item.effectivePlays.toLocaleString()}</td>
                    <td class="p-4 text-right">${(Math.round(item.revenue / 10) * 10).toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.effectivePayouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${Math.round(item.cost)} 元/次</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderAccountingTab() {
            const machineSelector = document.getElementById('machine-selector');
            const cumulativePlaysInput = document.getElementById('cumulative-plays');
            const cumulativePayoutsInput = document.getElementById('cumulative-payouts');
            
            machineSelector.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            if(appData.machines.length === 0) {
                machineSelector.innerHTML = '<option value="" disabled selected>請先至「機台管理」建立機台</option>';
            } else {
                appData.machines.sort((a, b) => a.id.localeCompare(b.id)).forEach(m => {
                    machineSelector.innerHTML += `<option value="${m.docId}">${m.id} - ${m.location}</option>`;
                });
            }
            document.getElementById('entry-date').valueAsDate = new Date();
            cumulativePlaysInput.value = '';
            cumulativePayoutsInput.value = '';
            
            historyTableBody.innerHTML = '';
            if (appData.history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-400">尚無記帳紀錄</td></tr>`;
            } else {
                appData.history.forEach(h => {
                    historyTableBody.innerHTML += `<tr class="hover:bg-gray-700/50">
                        <td class="p-4">${h.date}</td>
                        <td class="p-4 font-medium text-white">${h.machineId || '未知'}</td>
                        <td class="p-4">${h.location || '未知'}</td>
                        <td class="p-4 text-right">${h.newPlays}</td>
                        <td class="p-4 text-right">${h.newPayouts}</td>
                        <td class="p-4 text-right">
                           <button class="edit-history-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded mr-2"
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-date="${h.date}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                修改
                           </button>
                           <button class="delete-history-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded" 
                                data-doc-id="${h.docId}" 
                                data-machine-id="${h.machineId}"
                                data-location="${h.location}"
                                data-plays="${h.newPlays}"
                                data-payouts="${h.newPayouts}">
                                刪除
                           </button>
                        </td>
                    </tr>`;
                });
            }
        }
        
        async function renderSummaryTab() {
            const activeButton = document.querySelector('#summary-controls .active');
            const period = activeButton ? activeButton.dataset.period : 'all';
            
            let summaryData;
            let rangeText;
            
            // 如果選擇當期，使用與主統計相同的邏輯
            if (period === 'current') {
                // 取得最後結帳的累計資料
                const lastCheckoutData = await getLastCheckoutData();
                
                // 計算當期未結帳的營業明細
                const processedMachines = appData.machines.map(processMachineData);
                
                // 計算當前所有機台的總數據
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                summaryData = processedMachines.map(machine => {
                    // 計算此機台在總數據中的占比
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // 基於占比計算此機台在最後結帳時的數據
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // 計算當期未結帳數據
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    return {
                        id: machine.id,
                        revenue: pendingRevenue,
                        payouts: pendingPayouts,
                        cost: pendingCost
                    };
                });
                
                rangeText = '當期未結帳';
            } else {
                // 其他期間使用原有邏輯
                summaryData = getAggregatedSummaryData(period);
                rangeText = period === 'all' ? '全部歷史' : 
                           period === 'weekly' ? '本週' :
                           period === 'monthly' ? '本月' :
                           period === 'quarterly' ? '本季' : '總計';
            }

            const totalRevenueAllMachines = summaryData.reduce((sum, s) => sum + s.revenue, 0);
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            if (summaryData.length === 0) {
                const noDataMessage = `${rangeText}此期間無資料可供顯示`;
                summaryTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
            } else {
                summaryData.sort((a,b) => b.revenue - a.revenue).forEach((s, index) => {
                    const rowClass = index % 2 === 1 ? 'bg-gray-900/50' : '';
                    // 🔧 確保投幣金額是10的倍數
                    const displayRevenue = Math.round(s.revenue / 10) * 10;
                    const costDisplay = Math.round(s.cost);
                    const abnormalIndicator = s.isAbnormalCost ? ' ⚠️' : '';
                    summaryTableBody.innerHTML += `<tr class="${rowClass}">
                        <td class="p-4 font-medium text-white">${s.id}</td>
                        <td class="p-4 text-right">${displayRevenue.toLocaleString()} 元</td>
                        <td class="p-4 text-right">${s.payouts.toLocaleString()} 次</td>
                        <td class="p-4 text-right">${costDisplay} 元/次${abnormalIndicator}</td>
                    </tr>`;
                });
            }

            const chartContainer = document.getElementById('summary-chart-container');
            chartContainer.innerHTML = '';
            const colors = ['blue', 'green', 'purple', 'yellow', 'red', 'indigo', 'pink'];
            
            if (summaryData.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-gray-500">無佔比資料</p>';
            } else {
                summaryData.forEach((s, index) => {
                    const percentage = totalRevenueAllMachines > 0 ? (s.revenue / totalRevenueAllMachines * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];
                    // 🔧 確保投幣金額是10的倍數
                    const displayRevenue = Math.round(s.revenue / 10) * 10;
                    chartContainer.innerHTML += `<div class="w-full">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-${color}-300">${s.id}</span>
                            <span class="text-sm font-medium text-${color}-300">${displayRevenue.toLocaleString()} 元 (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div class="bg-${color}-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                });
            }
            
            console.log(`🏪 營業明細已更新 - 範圍: ${rangeText}, 資料筆數: ${summaryData.length}`);
        }

        function renderAnalysisTab(customRange = null) {
            const psdControls = document.getElementById('psd-controls');
            const activeButton = psdControls.querySelector('.active');
            let period = activeButton ? activeButton.dataset.period : 'all';
            let periodRevenue = 0;
            let diffDays = 1;
            let analysisTitle = activeButton ? activeButton.textContent : "自訂區間";

            // Handle custom range
            if(customRange){
                period = 'custom';
                analysisTitle = `${customRange.start} ~ ${customRange.end}`;
            }

            // Calculate revenue and days based on period
            if (period === 'all') {
                periodRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const startDate = new Date(appData.startDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            } else {
                let periodStartDate, periodEndDate;
                if (period === 'custom') {
                    periodStartDate = new Date(customRange.start + 'T00:00:00');
                    periodEndDate = new Date(customRange.end + 'T00:00:00');
                } else {
                     const now = new Date();
                    switch (period) {
                        case 'weekly':
                            const day = now.getDay();
                            const daysToFriday = (day + 7 - 5) % 7;
                            periodStartDate = new Date(now);
                            periodStartDate.setDate(now.getDate() - daysToFriday);
                            periodEndDate = new Date();
                            break;
                        case 'monthly':
                            periodStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            periodEndDate = new Date();
                            break;
                        case 'quarterly':
                            const quarter = Math.floor(now.getMonth() / 3);
                            periodStartDate = new Date(now.getFullYear(), quarter * 3, 1);
                            periodEndDate = new Date();
                            break;
                    }
                }
                periodStartDate.setHours(0,0,0,0);
                periodEndDate.setHours(23,59,59,999);

                const filteredHistory = appData.history.filter(h => {
                    const recordDate = new Date(h.date);
                    return recordDate >= periodStartDate && recordDate <= periodEndDate;
                });
                periodRevenue = filteredHistory.reduce((sum, h) => sum + (h.newPlays * COIN_VALUE), 0);
                const diffTime = Math.abs(periodEndDate - periodStartDate);
                diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            }
            
            const psd = periodRevenue > 0 && diffDays > 0 ? periodRevenue / diffDays : 0;
            document.getElementById('psd-display').innerHTML = `
                <div class="text-sm text-gray-400">${analysisTitle} 每日平均營收</div>
                <div class="text-2xl font-bold text-white mt-1">${psd.toLocaleString('en-US', {maximumFractionDigits: 0})} 元 / 天</div>
                <div class="text-xs text-gray-500 mt-1">(${periodRevenue.toLocaleString()} 元 ÷ ${diffDays} 天)</div>`;

            
            // --- Detailed Analysis ---
            const observationEl = document.getElementById('analysis-observation');
            const suggestionEl = document.getElementById('analysis-suggestion');
            const processedMachines = appData.machines.map(processMachineData);

            if (processedMachines.length === 0) {
                 observationEl.innerHTML = '<p>尚無機台數據可進行分析。</p>';
                 suggestionEl.innerHTML = '<p>請先至「機台管理」建立機台，並在「每日記帳」新增紀錄。</p>';
                 return;
            }

            const sortedByRevenue = [...processedMachines].sort((a,b) => b.revenue - a.revenue);
            const sortedByCost = [...processedMachines].filter(m => m.effectivePayouts > 0).sort((a,b) => b.cost - a.cost);

            let observationHTML = '';
            let suggestionHTML = '';

            // Top 3 Revenue
            observationHTML += '<div><h4 class="text-lg font-semibold text-green-400 mb-2">🥇 營收 TOP 3 機台 (金雞母)</h4><ul class="list-disc pl-5 space-y-1">';
            sortedByRevenue.slice(0, 3).forEach(m => {
                observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 總營收 ${m.revenue.toLocaleString()} 元</li>`;
            });
            observationHTML += '</ul></div>';
            suggestionHTML += '<div><p class="text-green-300/80">對於高營收機台，建議維持目前熱度，可考慮適時補充類似獎品，以鞏固營收表現。</p></div>';


            // Bottom 3 Revenue
            if (sortedByRevenue.length > 3) {
                 observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-yellow-400 mb-2">🥉 營收 BOTTOM 3 機台 (待觀察)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByRevenue.slice(-3).reverse().forEach(m => {
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 總營收 ${m.revenue.toLocaleString()} 元</li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-yellow-300/80">對於營收末段班，建議觀察機台位置是否理想，或考慮更換獎品類型、調整爪力設定以提升投幣意願。</p></div>';
            }

            // Top 3 Highest Cost
             if (sortedByCost.length > 0) {
                observationHTML += '<div class="mt-4"><h4 class="text-lg font-semibold text-red-400 mb-2">🚨 出貨成本最高 TOP 3 機台 (警示區)</h4><ul class="list-disc pl-5 space-y-1">';
                sortedByCost.slice(0, 3).forEach(m => {
                    const costDisplay = formatCost(m.cost);
                    const abnormalIndicator = m.isAbnormalCost ? ' ⚠️' : '';
                    observationHTML += `<li><strong class="text-white">${m.id} (${m.location})</strong>: 平均成本 <strong class="text-red-400">${costDisplay} 元/次${abnormalIndicator}</strong></li>`;
                });
                observationHTML += '</ul></div>';
                suggestionHTML += '<div class="mt-2"><p class="text-red-300/80">成本過高的機台需重點關注！建議立即檢討爪力設定與獎品價值是否匹配，避免利潤被侵蝕。</p></div>';

            }

            observationEl.innerHTML = observationHTML;
            suggestionEl.innerHTML = suggestionHTML;
        }

        function getAggregatedData(period) {
            const groups = appData.history.reduce((acc, curr) => {
                let key, displayLabel;
                switch(period) {
                    case 'weekly': 
                        const d = new Date(curr.date);
                        const day = d.getDay();  // 0=週日, 1=週一, ..., 5=週五, 6=週六
                        // 計算到上一個週五的天數
                        const daysToFriday = (day + 7 - 5) % 7;
                        const weekStartDate = new Date(d);
                        weekStartDate.setDate(d.getDate() - daysToFriday);
                        const weekEndDate = new Date(weekStartDate);
                        weekEndDate.setDate(weekStartDate.getDate() + 6); // 週五+6天=下週四
                        key = weekStartDate.toISOString().split('T')[0];
                        // 生成顯示標籤：2025-11-22~11-28 格式
                        displayLabel = `${weekStartDate.getMonth() + 1}/${weekStartDate.getDate()}~${weekEndDate.getMonth() + 1}/${weekEndDate.getDate()}`;
                        break;
                    case 'monthly': 
                        key = curr.date.substring(0, 7); 
                        displayLabel = key;
                        break;
                    case 'quarterly': 
                        const q_d = new Date(curr.date);
                        key = `${q_d.getFullYear()}-Q${Math.floor(q_d.getMonth() / 3) + 1}`;
                        displayLabel = key;
                        break;
                    default: 
                        key = curr.date; // daily
                        displayLabel = key;
                }
                if (!acc[key]) {
                    acc[key] = { period: key, displayLabel: displayLabel || key, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});

            return Object.values(groups).map(g => {
                const revenue = g.plays * COIN_VALUE;
                const cost = g.payouts > 0 ? revenue / g.payouts : 0;
                return { ...g, revenue, cost };
            });
        }
        
        function renderStatisticsTab() {
            const activeButton = statsControls.querySelector('.active');
            const period = activeButton ? activeButton.dataset.period : 'daily';
            
            // 根據選定的統計範圍獲取資料
            let data = getAggregatedData(period);
            
            // 根據統計範圍篩選資料
            if (currentStatsRange === 'current') {
                // 當期資料：僅顯示最後結帳後的資料
                data = filterDataByRange(data, 'current');
            }
            // 如果是 'all'，則使用全部資料
            
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            
            // 更新頁面標題顯示當前統計範圍
            const rangeText = currentStatsRange === 'current' ? '當期紀錄' : '全部歷史';
            const titleElement = document.querySelector('#statistics .text-xl');
            
            if(data.length === 0) {
                const noDataMessage = currentStatsRange === 'current' ? 
                    `尚無${rangeText}可供彙整` : 
                    '尚無歷史紀錄可供彙整';
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-400">${noDataMessage}</td></tr>`;
                return;
            }
            
            data.sort((a,b) => (a.period > b.period) ? -1 : 1);
            data.forEach(item => {
                // 🔧 確保投幣金額是10的倍數
                const displayRevenue = Math.round(item.revenue / 10) * 10;
                const costDisplay = Math.round(item.cost);
                const abnormalIndicator = item.isAbnormalCost ? ' ⚠️' : '';
                // 使用 displayLabel 或 period 作為顯示標籤
                const periodLabel = item.displayLabel || item.period;
                tableBody.innerHTML += `<tr class="hover:bg-gray-700/50 transition">
                    <td class="p-4 font-medium text-white">${periodLabel}</td>
                    <td class="p-4 text-right">${item.plays.toLocaleString()}</td>
                    <td class="p-4 text-right">${displayRevenue.toLocaleString()} 元</td>
                    <td class="p-4 text-right">${item.payouts.toLocaleString()}</td>
                    <td class="p-4 text-right">${costDisplay} 元/次${abnormalIndicator}</td>
                </tr>`;
            });
            
            console.log(`📊 統計頁面已更新 - 範圍: ${rangeText}, 資料筆數: ${data.length}`);
        }
        
        async function renderChartsTab() {
            const revenueChartEl = document.getElementById('revenue-chart');
            const costChartEl = document.getElementById('cost-chart');

            revenueChartEl.innerHTML = '';
            costChartEl.innerHTML = '';

            // 根據選定的圖表範圍處理機台資料
            let processedMachines = appData.machines.map(processMachineData);
            
            // 如果選擇當期統計，使用與主統計相同的邏輯計算當期未結帳數據
            if (currentChartsRange === 'current') {
                // 取得最後結帳的累計資料
                const lastCheckoutData = await getLastCheckoutData();
                
                // 計算當前所有機台的總數據
                const currentTotalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
                const currentTotalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
                
                // 為每個機台計算當期未結帳數據
                processedMachines = processedMachines.map(machine => {
                    // 計算此機台在總數據中的占比
                    const playRatio = currentTotalPlays > 0 ? machine.effectivePlays / currentTotalPlays : 0;
                    const payoutRatio = currentTotalPayouts > 0 ? machine.effectivePayouts / currentTotalPayouts : 0;
                    
                    // 基於占比計算此機台在最後結帳時的數據
                    const machineCheckoutPlays = lastCheckoutData.plays * playRatio;
                    const machineCheckoutRevenue = lastCheckoutData.revenue * playRatio;
                    const machineCheckoutPayouts = lastCheckoutData.payouts * payoutRatio;
                    
                    // 計算當期未結帳數據
                    const currentMachinePlays = machine.effectivePlays;
                    const currentMachineRevenue = currentMachinePlays * COIN_VALUE;
                    const currentMachinePayouts = machine.effectivePayouts;
                    
                    const pendingPlays = Math.max(0, currentMachinePlays - machineCheckoutPlays);
                    const pendingRevenue = Math.max(0, currentMachineRevenue - machineCheckoutRevenue);
                    const pendingPayouts = Math.max(0, currentMachinePayouts - machineCheckoutPayouts);
                    const pendingCost = pendingPayouts > 0 ? pendingRevenue / pendingPayouts : 0;
                    
                    // 🔧 確保是整數
                    const roundedPendingPayouts = Math.round(pendingPayouts);
                    // 🔧 確保投幣金額是10的倍數
                    const roundedPendingRevenue = Math.round(pendingRevenue / 10) * 10;
                    const roundedCost = roundedPendingPayouts > 0 ? roundedPendingRevenue / roundedPendingPayouts : 0;
                    
                    return {
                        ...machine,
                        totalPlays: pendingPlays,
                        totalPayouts: roundedPendingPayouts,
                        revenue: roundedPendingRevenue,
                        cost: roundedCost,
                        isAbnormalCost: false  // ✅ 當期統計不標記為異常
                    };
                });
            }
            
            const rangeText = currentChartsRange === 'current' ? '當期' : '全部歷史';

            if (processedMachines.length === 0 || processedMachines.every(m => m.revenue === 0)) {
                const noDataMessage = `尚無${rangeText}資料可繪製圖表`;
                revenueChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
                costChartEl.innerHTML = `<p class="text-center text-gray-500">${noDataMessage}</p>`;
            } else {
                const maxRevenue = Math.max(...processedMachines.map(m => m.revenue), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.revenue / maxRevenue * 100);
                    // 🔧 確保投幣金額是10的倍數
                    const displayRevenue = Math.round(machine.revenue / 10) * 10;
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${displayRevenue.toLocaleString()} 元
                                </div>
                            </div>
                        </div>
                    `;
                    revenueChartEl.innerHTML += chartItem;
                });

                const maxCost = Math.max(...processedMachines.map(m => m.cost), 1);
                processedMachines.sort((a,b) => b.revenue - a.revenue).forEach((machine, index) => {
                    const barWidth = (machine.cost / maxCost * 100);
                    // ✅ 成本四捨五入為整數
                    const costDisplay = Math.round(machine.cost);
                    const abnormalIndicator = machine.isAbnormalCost ? ' ⚠️' : '';
                    const chartItem = `
                        <div class="flex items-center space-x-4">
                            <div class="w-44 text-sm font-medium text-gray-300 truncate">${index + 1}. ${machine.id} - ${machine.location}</div>
                            <div class="flex-grow bg-gray-700 rounded-full h-6">
                                <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                   ${costDisplay} 元/次${abnormalIndicator}
                                </div>
                            </div>
                        </div>
                    `;
                    costChartEl.innerHTML += chartItem;
                });
            }
            
            const trendChartDatePicker = document.getElementById('trend-chart-date-picker');
            if (appData.history.length > 0) {
                const latestDate = appData.history.reduce((max, h) => h.date > max ? h.date : max, appData.history[0].date);
                trendChartDatePicker.value = latestDate;
            } else {
                trendChartDatePicker.valueAsDate = new Date();
            }
            
            renderTrendChartByDate();
            
            console.log(`📈 圖表頁面已更新 - 範圍: ${rangeText}, 機台數: ${processedMachines.length}`);
        }

        function renderTrendChartByDate() {
            const trendChartContentEl = document.getElementById('trend-chart-content');
            const selectedDate = trendChartDatePicker.value;

            trendChartContentEl.innerHTML = '';

            if (!selectedDate) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">請選擇一個日期來查看數據</p>';
                return;
            }

            const dailyRecords = appData.history.filter(h => h.date === selectedDate);

            if (dailyRecords.length === 0) {
                trendChartContentEl.innerHTML = '<p class="text-center text-gray-500">該日期沒有記帳紀錄</p>';
                return;
            }
            
            const aggregatedData = dailyRecords.reduce((acc, record) => {
                const key = `${record.machineId}|${record.location}`;
                if (!acc[key]) {
                    acc[key] = {
                        machineId: record.machineId,
                        location: record.location,
                        newPlays: 0,
                        newPayouts: 0
                    };
                }
                acc[key].newPlays += record.newPlays;
                acc[key].newPayouts += record.newPayouts;
                return acc;
            }, {});
            const aggregatedRecords = Object.values(aggregatedData);

            const recordsWithCalc = aggregatedRecords.map(r => {
                const revenue = r.newPlays * COIN_VALUE;
                const cost = r.newPayouts > 0 ? revenue / r.newPayouts : 0;
                return {...r, revenue, cost };
            });

            const maxRevenue = Math.max(...recordsWithCalc.map(r => r.revenue), 1);
            const maxCost = Math.max(...recordsWithCalc.map(r => r.cost), 1);
            
            let totalDayRevenue = 0;
            let totalDayPayouts = 0;
            
            recordsWithCalc.forEach(record => {
                totalDayRevenue += record.revenue;
                totalDayPayouts += record.newPayouts;
            });

            const revenueCharts = [...recordsWithCalc].sort((a,b) => b.revenue - a.revenue).map(record => {
                const barWidth = (record.revenue / maxRevenue) * 100;
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-blue-500 h-6 rounded-full text-xs font-medium text-white text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${record.revenue.toLocaleString()} 元
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const costCharts = [...recordsWithCalc].sort((a,b) => b.cost - a.cost).map(record => {
                const barWidth = (record.cost / maxCost) * 100;
                const costDisplay = formatCost(record.cost);
                const abnormalIndicator = record.isAbnormalCost ? ' ⚠️' : '';
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-40 text-sm font-medium text-gray-300 truncate">${record.machineId} - ${record.location}</div>
                        <div class="flex-grow bg-gray-700 rounded-full h-6">
                            <div class="chart-bar bg-yellow-500 h-6 rounded-full text-xs font-medium text-gray-900 text-right pr-2 leading-6" style="width: ${barWidth}%">
                                ${costDisplay} 元/次${abnormalIndicator}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalDayCost = totalDayPayouts > 0 ? totalDayRevenue / totalDayPayouts : 0;

            trendChartContentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-h-80 overflow-y-auto pr-2">
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">當日營收</h4>
                           <p class="text-sm text-blue-300">總計：${totalDayRevenue.toLocaleString()} 元</p>
                        </div>
                        <div class="space-y-4">${revenueCharts}</div>
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                           <h4 class="text-lg font-semibold text-white">當日出貨成本</h4>
                           <p class="text-sm text-yellow-300">平均：${formatCost(totalDayCost)} 元/次</p>
                        </div>
                        <div class="space-y-4">${costCharts}</div>
                    </div>
                </div>
            `;
        }
        
        // 盈利計算功能
        function renderProfitTab() {
            if (!appData || !appData.machines) return;
            
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 更新基本資訊
            document.getElementById('profit-revenue').textContent = `${totalRevenue.toLocaleString()} 元`;
            document.getElementById('profit-payouts').textContent = `${totalPayouts.toLocaleString()} 次`;
            
            // 載入儲存的成本設定
            loadCostSettings();
            
            // 計算盈利
            calculateProfit();
        }
        
        function loadCostSettings() {
            const settings = JSON.parse(localStorage.getItem(`costSettings_${selectedGroupId}_${selectedStoreId}`) || '{}');
            document.getElementById('gift-cost').value = settings.giftCost || 50;
            document.getElementById('rent-percentage').value = settings.rentPercentage || 30;
            document.getElementById('tax-percentage').value = settings.taxPercentage || 5;
        }
        
        function saveCostSettings() {
            const settings = {
                giftCost: parseFloat(document.getElementById('gift-cost').value) || 50,
                rentPercentage: parseFloat(document.getElementById('rent-percentage').value) || 30,
                taxPercentage: parseFloat(document.getElementById('tax-percentage').value) || 5
            };
            localStorage.setItem(`costSettings_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(settings));
            showFeedback('成本設定已儲存！', false);
        }
        
        function calculateProfit() {
            const processedMachines = appData.machines.map(processMachineData);
            const totalPlays = processedMachines.reduce((sum, m) => sum + m.effectivePlays, 0);
            const totalRevenue = totalPlays * COIN_VALUE;
            const totalPayouts = processedMachines.reduce((sum, m) => sum + m.effectivePayouts, 0);
            
            // 獲取成本設定
            const giftCost = parseFloat(document.getElementById('gift-cost').value) || 50;
            const rentPercentage = parseFloat(document.getElementById('rent-percentage').value) || 30;
            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 5;
            
            // 獲取計算範圍
            const calculationScope = document.querySelector('input[name="profit-calculation-scope"]:checked').value;
            
            let calculationRevenue, calculationPayouts, scopeTitle;
            
            if (calculationScope === 'pending') {
                // 計算待結帳期間的數據
                const lastCheckoutData = JSON.parse(localStorage.getItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`) || '{}');
                const lastCheckoutRevenue = lastCheckoutData.cumulativeRevenueAtCheckout || 0;
                const lastCheckoutPayouts = lastCheckoutData.cumulativePayoutsAtCheckout || 0;
                
                calculationRevenue = totalRevenue - lastCheckoutRevenue;
                calculationPayouts = totalPayouts - lastCheckoutPayouts;
                scopeTitle = '本期待結帳';
            } else {
                // 總累積計算
                calculationRevenue = totalRevenue;
                calculationPayouts = totalPayouts;
                scopeTitle = '總累積';
            }
            
            // 計算各項成本
            const totalGiftCost = calculationPayouts * giftCost;
            const totalRentCost = calculationRevenue * (rentPercentage / 100);
            const totalTaxCost = calculationRevenue * (taxPercentage / 100);
            const totalCost = totalGiftCost + totalRentCost + totalTaxCost;
            
            // 計算淨利潤
            const netProfit = calculationRevenue - totalCost;
            const profitMargin = calculationRevenue > 0 ? (netProfit / calculationRevenue) * 100 : 0;
            const profitPerPayout = calculationPayouts > 0 ? netProfit / calculationPayouts : 0;
            
            // 更新UI - 顯示計算範圍
            document.getElementById('profit-revenue').textContent = `${calculationRevenue.toLocaleString()} 元`;
            document.getElementById('profit-payouts').textContent = `${calculationPayouts.toLocaleString()} 次`;
            
            // 更新成本明細標題以顯示計算範圍
            const costDetailTitle = document.querySelector('.bg-gray-700\\/50 h4');
            if (costDetailTitle && costDetailTitle.textContent.includes('成本明細')) {
                costDetailTitle.textContent = `💸 成本明細 (${scopeTitle})`;
            }
            
            document.getElementById('total-gift-cost').textContent = `${totalGiftCost.toLocaleString()} 元`;
            document.getElementById('total-rent-cost').textContent = `${totalRentCost.toLocaleString()} 元`;
            document.getElementById('total-tax-cost').textContent = `${totalTaxCost.toLocaleString()} 元`;
            document.getElementById('total-cost').textContent = `${totalCost.toLocaleString()} 元`;
            
            document.getElementById('profit-total-revenue').textContent = `${calculationRevenue.toLocaleString()} 元`;
            document.getElementById('profit-total-cost').textContent = `${totalCost.toLocaleString()} 元`;
            document.getElementById('net-profit').textContent = `${netProfit.toLocaleString()} 元`;
            document.getElementById('profit-net').textContent = `${netProfit.toLocaleString()} 元`;
            
            // 設定顏色
            const profitColor = netProfit >= 0 ? 'text-green-300' : 'text-red-300';
            document.getElementById('net-profit').className = `${profitColor} font-bold text-xl`;
            document.getElementById('profit-net').parentElement.className = netProfit >= 0 ? 
                'bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-xl' : 
                'bg-gradient-to-br from-red-600 to-red-700 p-6 rounded-xl';
            
            document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('profit-margin').className = profitMargin >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
            
            document.getElementById('profit-per-payout').textContent = `${profitPerPayout.toFixed(2)} 元`;
            document.getElementById('profit-per-payout').className = profitPerPayout >= 0 ? 'font-semibold text-green-400' : 'font-semibold text-red-400';
        }

        async function renderCheckoutTab() {
            if (!selectedGroupId || !selectedStoreId) return;

            const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
            const lastCheckoutDateEl = document.getElementById('last-checkout-date');
            const pendingAmountEl = document.getElementById('pending-checkout-amount');

            checkoutHistoryBody.innerHTML = '';

            try {
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                let lastCheckoutRevenue = 0;
                if (checkouts.length > 0) {
                    const lastCheckout = checkouts[0];
                    lastCheckoutDateEl.textContent = new Date(lastCheckout.checkoutDate.toDate()).toLocaleString();
                    lastCheckoutRevenue = lastCheckout.cumulativeRevenueAtCheckout;
                    
                    // 保存最後結帳資訊到 localStorage 供盈利計算使用
                    const lastCheckoutData = {
                        cumulativeRevenueAtCheckout: lastCheckout.cumulativeRevenueAtCheckout,
                        cumulativePayoutsAtCheckout: lastCheckout.cumulativePayoutsAtCheckout || 0,
                        checkoutDate: lastCheckout.checkoutDate
                    };
                    localStorage.setItem(`lastCheckout_${selectedGroupId}_${selectedStoreId}`, JSON.stringify(lastCheckoutData));

                    checkouts.forEach((checkout, index) => {
                         const prevCheckoutDate = index < checkouts.length - 1 ? new Date(checkouts[index + 1].checkoutDate.toDate()).toLocaleString() : appData.startDate;
                         
                         // 取得當期出貨數量
                         const currentPayouts = checkout.checkoutPayouts || 0;
                         
                         // 取得當期盈利信息
                         const periodProfit = checkout.periodProfit || {};
                         const periodNetProfit = periodProfit.netProfit || 0;
                         const profitColor = periodNetProfit >= 0 ? 'text-green-400' : 'text-red-400';
                         
                         // 檢查是否有盈利計算數據
                         const hasProfitData = checkout.periodProfit || checkout.totalProfit;
                         
                        const row = `
                            <tr class="hover:bg-gray-700/50">
                                <td class="p-3 text-sm">${new Date(checkout.checkoutDate.toDate()).toLocaleString()}</td>
                                <td class="p-3 text-right text-sm font-semibold">${checkout.checkoutAmount.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm">${currentPayouts.toLocaleString()} 次</td>
                                <td class="p-3 text-right text-sm font-semibold ${profitColor}">${periodNetProfit.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm text-gray-400">${checkout.cumulativeRevenueAtCheckout.toLocaleString()} 元</td>
                                <td class="p-3 text-right text-sm">
                                    ${hasProfitData ? 
                                        `<button class="view-profit-detail-btn bg-purple-600 hover:bg-purple-700 text-white text-xs py-1 px-2 rounded mr-1"
                                            data-checkout-data='${JSON.stringify(checkout)}'>詳情</button>` : 
                                        '<span class="text-gray-500 text-xs">無數據</span>'
                                    }
                                </td>
                                <td class="p-3 text-right">
                                    <button class="download-checkout-pdf-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded"
                                        data-checkout-id="${checkout.id}"
                                        data-checkout-date="${new Date(checkout.checkoutDate.toDate()).toLocaleString()}"
                                        data-prev-checkout-date="${prevCheckoutDate}"
                                        data-amount="${checkout.checkoutAmount}"
                                        data-cumulative="${checkout.cumulativeRevenueAtCheckout}">
                                        報告
                                    </button>
                                </td>
                            </tr>
                        `;
                        checkoutHistoryBody.innerHTML += row;
                    });
                    
                    // 渲染圖表和統計數據
                    renderCheckoutCharts(checkouts);
                    renderCheckoutStats(checkouts);
                } else {
                    lastCheckoutDateEl.textContent = '無 (以營業起始日為準)';
                    checkoutHistoryBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">尚無結帳紀錄</td></tr>`;
                    
                    // 清空圖表和統計
                    clearCheckoutCharts();
                    clearCheckoutStats();
                }
                
                const currentTotalRevenue = appData.machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                const pendingAmount = currentTotalRevenue - lastCheckoutRevenue;
                pendingAmountEl.textContent = `${pendingAmount.toLocaleString()} 元`;

            } catch (error) {
                console.error("讀取結帳歷史失敗:", error);
                checkoutHistoryBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-400">無法讀取結帳歷史</td></tr>`;
                clearCheckoutCharts();
                clearCheckoutStats();
            }
        }

        // 渲染結帳圖表
        function renderCheckoutCharts(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutCharts();
                return;
            }

            // 按時間排序 (舊到新)
            const sortedCheckouts = [...checkouts].reverse();
            
            // 結帳金額趨勢圖 - 使用線圖 + 區域填充
            renderLineChart('checkout-amount-chart', sortedCheckouts, 'checkoutAmount', 'blue', '結帳金額');
            
            // 累積營收趨勢圖 - 使用線圖 + 區域填充
            renderLineChart('checkout-cumulative-chart', sortedCheckouts, 'cumulativeRevenueAtCheckout', 'green', '累積營收');
        }

        // 渲染線圖
        function renderLineChart(elementId, data, valueKey, color, label) {
            const chartEl = document.getElementById(elementId);
            const values = data.map(d => d[valueKey]);
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const valueRange = maxValue - minValue || 1;
            
            const chartWidth = 400;
            const chartHeight = 200;
            const padding = 40;
            
            chartEl.innerHTML = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4">
                    <svg width="100%" height="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" class="overflow-visible">
                        <!-- 網格線 -->
                        ${Array.from({length: 5}, (_, i) => {
                            const y = padding + (i * (chartHeight - 2 * padding)) / 4;
                            return `<line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" stroke="#374151" stroke-width="1" opacity="0.3"/>`;
                        }).join('')}
                        
                        <!-- 區域填充 -->
                        <defs>
                            <linearGradient id="gradient-${color}" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.3"/>
                                <stop offset="100%" style="stop-color:${color === 'blue' ? '#3b82f6' : '#10b981'};stop-opacity:0.05"/>
                            </linearGradient>
                        </defs>
                        
                        <path d="M${padding},${chartHeight - padding} ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `L${x},${y}`;
                        }).join(' ')} L${chartWidth - padding},${chartHeight - padding} Z" 
                              fill="url(#gradient-${color})" stroke="none"/>
                        
                        <!-- 線條 -->
                        <path d="M${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            return `${index === 0 ? 'M' : 'L'}${x},${y}`;
                        }).join(' ')}" 
                              fill="none" 
                              stroke="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                              stroke-width="3" 
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                        
                        <!-- 數據點 -->
                        ${data.map((item, index) => {
                            const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                            const normalizedValue = (item[valueKey] - minValue) / valueRange;
                            const y = chartHeight - padding - (normalizedValue * (chartHeight - 2 * padding));
                            const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                            const value = item[valueKey].toLocaleString();
                            
                            return `
                                <circle cx="${x}" cy="${y}" r="4" 
                                        fill="${color === 'blue' ? '#3b82f6' : '#10b981'}" 
                                        stroke="#1f2937" 
                                        stroke-width="2" 
                                        class="cursor-pointer transition-all hover:r-6"
                                        data-tooltip="${date}: ${value} 元">
                                    <title>${date}: ${value} 元</title>
                                </circle>
                            `;
                        }).join('')}
                        
                        <!-- Y軸標籤 -->
                        ${Array.from({length: 5}, (_, i) => {
                            const value = minValue + (i * valueRange) / 4;
                            const y = chartHeight - padding - (i * (chartHeight - 2 * padding)) / 4;
                            return `<text x="${padding - 10}" y="${y + 4}" fill="#9ca3af" text-anchor="end" font-size="10">${Math.round(value).toLocaleString()}</text>`;
                        }).join('')}
                    </svg>
                    
                    <!-- 數據點標籤 -->
                    <div class="absolute bottom-2 left-0 right-0 flex justify-between px-10 text-xs text-gray-400">
                        ${data.map((item, index) => {
                            if (data.length <= 5 || index % Math.ceil(data.length / 5) === 0 || index === data.length - 1) {
                                const date = new Date(item.checkoutDate.toDate()).toLocaleDateString();
                                return `<span class="transform -rotate-45 origin-bottom-left">${date}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <!-- 圖例 -->
                    <div class="absolute top-2 right-2 flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-gradient-to-br ${color === 'blue' ? 'from-blue-400 to-blue-600' : 'from-green-400 to-green-600'}"></div>
                        <span class="text-xs text-gray-300">${label}</span>
                    </div>
                </div>
            `;
        }

        // 渲染結帳統計
        function renderCheckoutStats(checkouts) {
            if (checkouts.length === 0) {
                clearCheckoutStats();
                return;
            }

            const totalCheckouts = checkouts.length;
            const totalAmount = checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0);
            const avgAmount = totalAmount / totalCheckouts;
            const maxAmount = Math.max(...checkouts.map(c => c.checkoutAmount));
            
            // 計算累計盈利 - 使用當期盈利記錄加總
            const totalProfit = checkouts.reduce((sum, checkout) => {
                const periodProfit = checkout.periodProfit || {};
                return sum + (periodProfit.netProfit || 0);
            }, 0);

            document.getElementById('total-checkouts').textContent = totalCheckouts.toLocaleString();
            document.getElementById('avg-checkout-amount').textContent = `${Math.round(avgAmount).toLocaleString()} 元`;
            document.getElementById('max-checkout-amount').textContent = `${maxAmount.toLocaleString()} 元`;
            
            // 更新累計盈利顯示
            const profitColor = totalProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const totalProfitElement = document.getElementById('total-profit-summary');
            totalProfitElement.textContent = `${totalProfit.toLocaleString()} 元`;
            totalProfitElement.className = `text-2xl font-bold ${profitColor}`;
        }

        // 清空圖表
        function clearCheckoutCharts() {
            const emptyChartHtml = `
                <div class="relative w-full h-56 bg-gray-800/50 rounded-lg p-4 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-gray-500 text-sm">暫無數據可顯示圖表</p>
                        <p class="text-gray-600 text-xs mt-1">完成首次結帳後將顯示趨勢圖</p>
                    </div>
                </div>
            `;
            document.getElementById('checkout-amount-chart').innerHTML = emptyChartHtml;
            document.getElementById('checkout-cumulative-chart').innerHTML = emptyChartHtml;
        }

        // 清空統計
        function clearCheckoutStats() {
            document.getElementById('total-checkouts').textContent = '0';
            document.getElementById('avg-checkout-amount').textContent = '0 元';
            document.getElementById('max-checkout-amount').textContent = '0 元';
            document.getElementById('total-profit-summary').textContent = '0 元';
            document.getElementById('total-profit-summary').className = 'text-2xl font-bold text-white';
        }


        function updateFooterAndHeader() {
            // 更新頁首資訊
            const headerEl = document.querySelector('#accounting-header');
            if (headerEl && currentGroupName && currentStoreName) {
                headerEl.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4">
                        ${currentGroupName} - ${currentStoreName} 帳務紀錄
                    </h2>
                `;
            }

            // 更新表格表尾統計
            const tableFooter = document.querySelector('#accounting-table tfoot');
            if (tableFooter && accountingData && accountingData.length > 0) {
                const totalRevenue = accountingData.reduce((sum, item) => sum + (item.revenue || 0), 0);
                const totalPayouts = accountingData.reduce((sum, item) => sum + (item.payouts || 0), 0);
                const avgCost = accountingData.length > 0 ? 
                    accountingData.reduce((sum, item) => sum + (item.cost || 0), 0) / accountingData.length : 0;

                tableFooter.innerHTML = `
                    <tr class="bg-gray-700/50 font-bold">
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">總計</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">${totalRevenue.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-red-400 uppercase tracking-wider">${totalPayouts.toLocaleString()}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-blue-400 uppercase tracking-wider">${avgCost.toFixed(2)}</td>
                        <td class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">-</td>
                    </tr>
                `;
            }
        }
        function showFeedback(message, isError = false) {
            const feedbackEl = document.getElementById('form-feedback');
            feedbackEl.innerHTML = message;
            feedbackEl.className = `text-center p-3 rounded-lg transition-opacity duration-500 opacity-100 ${isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`;
            setTimeout(() => { feedbackEl.style.opacity = '0'; }, 5000);
        }

        function getPeriodDateRange(period, dateStr) {
            const today = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            switch (period) {
                case 'daily':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'weekly':
                    const day = today.getDay();
                    const daysToFriday = (day + 7 - 5) % 7;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - daysToFriday);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarterly':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                    break;
                case 'yearly':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            return {
                startDate: toYYYYMMDD(startDate),
                endDate: toYYYYMMDD(endDate)
            };
        }

        async function getStoreSummaryForPeriod(storeId, period, date) {
            if (period === 'all') {
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('machines').get();
                const machines = machinesSnapshot.docs.map(doc => doc.data());
                return machines.map(m => {
                    const processed = processMachineData(m);
                    return { id: m.id, location: m.location, revenue: processed.revenue, payouts: processed.effectivePayouts, cost: processed.cost };
                });
            }

            const { startDate, endDate } = getPeriodDateRange(period, date);
            
            const historySnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(storeId).collection('history').where('date', '>=', startDate).where('date', '<=', endDate).get();
            const filteredHistory = historySnapshot.docs.map(doc => doc.data());

            if (filteredHistory.length === 0) return [];

            const summary = filteredHistory.reduce((acc, curr) => {
                const key = `${curr.machineId}|${curr.location}`;
                if (!acc[key]) {
                     acc[key] = { id: curr.machineId, location: curr.location, plays: 0, payouts: 0 };
                }
                acc[key].plays += curr.newPlays;
                acc[key].payouts += curr.newPayouts;
                return acc;
            }, {});
            
            return Object.values(summary).map(s => {
                const revenue = s.plays * COIN_VALUE;
                const cost = s.payouts > 0 ? revenue / s.payouts : 0;
                return { ...s, revenue, cost };
            });
        }

        async function handleDownloadAllStoresReport() {
            if(!selectedGroupId) return alert('No group selected.');
            const btn = document.getElementById('download-all-stores-report-btn');
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert("請至少勾選一個要下載的門市。");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>處理中...</span>`;
            btn.disabled = true;

            const period = reportPeriodSelector.value;
            const date = reportDatePicker.value;
            const periodText = reportPeriodSelector.options[reportPeriodSelector.selectedIndex].text;

            if (period !== 'all' && !date) {
                alert('請選擇一個基準日期！');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const storesToDownload = Array.from(selectedStoreCheckboxes).map(cb => ({
                    id: cb.dataset.storeId,
                    name: cb.dataset.storeName,
                    startDate: cb.dataset.startDate
                }));

                const csvRows = [];
                let grandTotalRevenue = 0;
                let grandTotalPayouts = 0;
                let grandTotalDays = 0;
                let psdCalculated = false;
                
                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    if (summaryData.length > 0) {
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        grandTotalRevenue += storeTotalRevenue;
                        grandTotalPayouts += storeTotalPayouts;
                    }
                }

                const grandTotalAvgCost = grandTotalPayouts > 0 ? grandTotalRevenue / grandTotalPayouts : 0;

                csvRows.push(`所選門市營運總計 - ${periodText}${period !== 'all' ? ' (' + date + ')' : ''}`);
                csvRows.push(`報表產生日期: ${new Date().toLocaleString()}`);
                csvRows.push("");
                csvRows.push("--- 全選門市總計 ---");
                csvRows.push(["項目", "總計"].join(','));
                csvRows.push(["總營收", grandTotalRevenue].join(','));
                csvRows.push(["總出貨數", grandTotalPayouts].join(','));
                csvRows.push(["總平均出貨成本(元/次)", grandTotalAvgCost.toFixed(2)].join(','));
                
                let grandPsd = 0;
                if (period === 'all') {
                    // Cannot accurately calculate combined PSD for 'all' without a common start date.
                } else {
                    const { startDate, endDate } = getPeriodDateRange(period, date);
                    const d1 = new Date(startDate);
                    const d2 = new Date(endDate);
                    const diffTime = Math.abs(d2 - d1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    grandPsd = grandTotalRevenue / diffDays;
                    csvRows.push([`期間PSD (每日平均營收)`, `"${grandPsd.toFixed(2)} 元/天"`].join(","));
                }


                for (const store of storesToDownload) {
                    const summaryData = await getStoreSummaryForPeriod(store.id, period, date);
                    
                    csvRows.push("");
                    csvRows.push(`--- ${store.name} ---`);
                    const summaryTableHeaders = ["機台編號", "位置", "期間營收", "期間出貨數", "期間出貨成本(元/次)"];
                    csvRows.push(summaryTableHeaders.join(","));

                    if (summaryData.length > 0) {
                        summaryData.forEach(item => {
                            csvRows.push([
                                item.id,
                                `"${item.location}"`,
                                item.revenue,
                                item.payouts,
                                item.cost.toFixed(2)
                            ].join(","));
                        });
                        
                        // Add Store Total and PSD
                        const storeTotalRevenue = summaryData.reduce((sum, item) => sum + item.revenue, 0);
                        const storeTotalPayouts = summaryData.reduce((sum, item) => sum + item.payouts, 0);
                        const storeAvgCost = storeTotalPayouts > 0 ? storeTotalRevenue / storeTotalPayouts : 0;
                        
                        csvRows.push(""); // blank line
                        csvRows.push([`門市總計`, "", storeTotalRevenue, storeTotalPayouts, storeAvgCost.toFixed(2)].join(","));

                        let psd = 0;
                        if (period === 'all') {
                             if (store.startDate) {
                                const storeStartDate = new Date(store.startDate);
                                const today = new Date();
                                const diffTime = Math.abs(today - storeStartDate);
                                const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
                                const machineDocs = await db.collection('groups').doc(selectedGroupId).collection('stores').doc(store.id).collection('machines').get();
                                const machines = machineDocs.docs.map(doc => doc.data());
                                const totalCumulativeRevenue = machines.map(processMachineData).reduce((sum, m) => sum + m.revenue, 0);
                                psd = totalCumulativeRevenue / diffDays;
                            }
                        } else {
                            const { startDate, endDate } = getPeriodDateRange(period, date);
                            const d1 = new Date(startDate);
                            const d2 = new Date(endDate);
                            const diffTime = Math.abs(d2 - d1);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            psd = storeTotalRevenue / diffDays;
                        }
                         csvRows.push([`門市PSD (每日平均營收)`, "", `"${psd.toFixed(2)} 元/天"`].join(","));


                    } else {
                        csvRows.push("此期間尚無數據");
                    }
                }
                
                let csvContent = "\uFEFF";
                csvContent += csvRows.join("\n");

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("download", `${selectedGroupName}-營運報表-${periodText}-${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("下載全門市報表失敗:", error);
                alert("下載報表時發生錯誤，請稍後再試。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // --- EVENT LISTENERS ---
        
        // 管理者界面事件
        adminBtn.addEventListener('click', showAdminPage);
        backToMainBtn.addEventListener('click', hideAdminPage);

        // 頁面權限快捷按鈕事件
        document.getElementById('select-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('select-readonly-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            // 只勾選檢視相關權限
            const readonlyPermissions = ['details', 'summary', 'analysis', 'charts', 'statistics'];
            readonlyPermissions.forEach(permission => {
                const checkbox = document.querySelector(`.page-permission-checkbox[value="${permission}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        document.getElementById('clear-all-permissions').addEventListener('click', () => {
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
        });

        // 管理員密碼更新
        adminPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newUsername = document.getElementById('new-username').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAdminFeedback('admin-password-feedback', '新密碼與確認密碼不符', true);
                return;
            }

            try {
                await window.adminConfig.updateAdminCredentials(newUsername, newPassword, currentPassword);
                showAdminFeedback('admin-password-feedback', '管理員帳密更新成功');
                adminPasswordForm.reset();
                document.getElementById('new-username').value = newUsername;
            } catch (error) {
                showAdminFeedback('admin-password-feedback', error.message, true);
            }
        });

        // 訪客帳號管理
        guestAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('guest-username').value;
            const password = document.getElementById('guest-password').value;
            const selectedGroups = Array.from(document.querySelectorAll('.group-permission-checkbox:checked'))
                .map(cb => cb.value);
            const selectedPagePermissions = Array.from(document.querySelectorAll('.page-permission-checkbox:checked'))
                .map(cb => cb.value);

            const isEditing = guestAccountForm.dataset.editingId;

            try {
                if (isEditing) {
                    await window.adminConfig.updateGuestAccount(isEditing, {
                        username,
                        password,
                        allowedGroups: selectedGroups,
                        pagePermissions: selectedPagePermissions
                    });
                    showAdminFeedback('guest-account-feedback', '訪客帳號更新成功');
                    cancelGuestEdit();
                } else {
                    await window.adminConfig.addGuestAccount(username, password, selectedGroups, selectedPagePermissions);
                    showAdminFeedback('guest-account-feedback', '訪客帳號新增成功');
                }
                
                guestAccountForm.reset();
                document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
                loadGuestAccountsTable();
            } catch (error) {
                showAdminFeedback('guest-account-feedback', error.message, true);
            }
        });

        // 取消編輯
        cancelGuestEditBtn.addEventListener('click', cancelGuestEdit);

        function cancelGuestEdit() {
            delete guestAccountForm.dataset.editingId;
            guestAccountForm.reset();
            document.querySelectorAll('.group-permission-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.page-permission-checkbox').forEach(cb => cb.checked = false);
            cancelGuestEditBtn.classList.add('hidden');
            guestAccountForm.querySelector('button[type="submit"]').textContent = '新增訪客';
        }

        // 訪客帳號表格事件
        guestAccountsTable.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-guest-btn');
            const deleteBtn = e.target.closest('.delete-guest-btn');

            if (editBtn) {
                const guestId = editBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest) {
                    // 填入編輯表單
                    document.getElementById('guest-username').value = guest.username;
                    document.getElementById('guest-password').value = guest.password;
                    
                    // 設定群組權限
                    document.querySelectorAll('.group-permission-checkbox').forEach(cb => {
                        cb.checked = guest.allowedGroups.includes(cb.value);
                    });
                    
                    // 設定頁面權限
                    document.querySelectorAll('.page-permission-checkbox').forEach(cb => {
                        cb.checked = (guest.pagePermissions || []).includes(cb.value);
                    });
                    
                    // 切換到編輯模式
                    guestAccountForm.dataset.editingId = guestId;
                    cancelGuestEditBtn.classList.remove('hidden');
                    guestAccountForm.querySelector('button[type="submit"]').textContent = '更新訪客';
                }
            } else if (deleteBtn) {
                const guestId = deleteBtn.dataset.guestId;
                const guest = window.adminConfig.getGuestAccounts().find(g => g.id === guestId);
                if (guest && confirm(`確定要刪除訪客帳號「${guest.username}」嗎？`)) {
                    try {
                        await window.adminConfig.deleteGuestAccount(guestId);
                        loadGuestAccountsTable();
                        showAdminFeedback('guest-account-feedback', '訪客帳號已刪除');
                    } catch (error) {
                        showAdminFeedback('guest-account-feedback', error.message, true);
                    }
                }
            }
        });

        // 系統工具事件
        exportConfigBtn.addEventListener('click', () => {
            const config = window.adminConfig.exportConfig();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        importConfigBtn.addEventListener('click', () => {
            configFileInput.click();
        });

        configFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await window.adminConfig.importConfig(e.target.result);
                        alert('設定匯入成功');
                        loadAdminInterface();
                    } catch (error) {
                        alert('匯入失敗：' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        resetConfigBtn.addEventListener('click', async () => {
            if (confirm('確定要重置所有設定嗎？這將刪除所有訪客帳號並恢復預設管理員密碼。')) {
                await window.adminConfig.resetToDefault();
                alert('系統已重置為預設設定');
                loadAdminInterface();
            }
        });

        groupListContainer.addEventListener('click', (e) => {
            const mainCard = e.target.closest('.group-card-main');
            const renameBtn = e.target.closest('.rename-group-btn');
            const deleteBtn = e.target.closest('.delete-group-btn');

            if (mainCard) {
                const groupId = mainCard.dataset.groupId;
                const groupName = mainCard.dataset.groupName;
                showStoreSelectionPage(groupId, groupName);
            } else if (renameBtn) {
                const groupId = renameBtn.dataset.groupId;
                const groupName = renameBtn.dataset.groupName;
                handleRenameGroup(groupId, groupName);
            } else if (deleteBtn) {
                const groupId = deleteBtn.dataset.groupId;
                const groupName = deleteBtn.dataset.groupName;
                handleDeleteGroup(groupId, groupName);
            }
        });

        storeListContainer.addEventListener('click', async (e) => {
            const mainCard = e.target.closest('.store-card-main');
            const editBtn = e.target.closest('.edit-store-btn');
            const cloneBtn = e.target.closest('.clone-store-btn');
            const deleteBtn = e.target.closest('.delete-store-btn');

            if (mainCard) {
                const storeId = mainCard.dataset.storeId;
                const storeName = mainCard.dataset.storeName;
                const startDate = mainCard.dataset.startDate;
                await showReportPage(storeId, storeName, startDate);
            } else if (editBtn) {
                document.getElementById('edit-store-id').value = editBtn.dataset.storeId;
                document.getElementById('edit-store-name').value = editBtn.dataset.storeName;
                document.getElementById('edit-store-start-date').value = editBtn.dataset.startDate;
                editStoreModal.classList.remove('hidden');
            } else if (cloneBtn) {
                document.getElementById('clone-source-store-id').value = cloneBtn.dataset.storeId;
                document.getElementById('clone-source-store-name').textContent = cloneBtn.dataset.storeName;
                document.getElementById('clone-store-name').value = cloneBtn.dataset.storeName + ' (複製)';
                document.getElementById('clone-store-start-date').valueAsDate = new Date();
                cloneStoreModal.classList.remove('hidden');
            } else if (deleteBtn) {
                const storeId = deleteBtn.dataset.storeId;
                const storeName = deleteBtn.dataset.storeName;
                handleDeleteStore(storeId, storeName);
            }
        });
        
        selectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = true);
        });

        deselectAllStoresBtn.addEventListener('click', () => {
            document.querySelectorAll('.store-checkbox').forEach(checkbox => checkbox.checked = false);
        });

        createGroupForm.addEventListener('submit', handleCreateGroup);
        createStoreForm.addEventListener('submit', handleCreateStore);
        editStoreForm.addEventListener('submit', handleUpdateStore);
        editStoreCancelBtn.addEventListener('click', () => editStoreModal.classList.add('hidden'));
        
        cloneStoreForm.addEventListener('submit', handleCloneStore);
        cloneStoreCancelBtn.addEventListener('click', () => cloneStoreModal.classList.add('hidden'));

        addMachineForm.addEventListener('submit', handleAddMachine);
        downloadAllStoresBtn.addEventListener('click', () => {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }
            
            const selectedStoreCheckboxes = document.querySelectorAll('.store-checkbox:checked');
            if (selectedStoreCheckboxes.length === 0) {
                alert('請先勾選要包含在報表中的門市');
                return;
            }
            
            showCustomStoreReportModal();
        });
        if (openStoreReportViewBtn) {
            openStoreReportViewBtn.addEventListener('click', openStoresLiveReportView);
        }
        if (openWeeklyTrendBtn) {
            openWeeklyTrendBtn.addEventListener('click', openWeeklyTrendReport);
        }
        if (openMultiWeeklyTrendBtn) {
            openMultiWeeklyTrendBtn.addEventListener('click', openMultiStoreWeeklyTrendReport);
        }
        trendChartDatePicker.addEventListener('change', renderTrendChartByDate);

        locationPresets.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-tag')) {
                document.getElementById('new-machine-location').value = e.target.textContent;
            }
        });

        // 綁定「立即輪詢所有門市」按鈕
        if (pollAllStoresBtn) {
            pollAllStoresBtn.addEventListener('click', pollAllStoresMachines);
        }

        // 綁定「立即讀取所有門市」按鈕
        if (readAllStoresBtn) {
            readAllStoresBtn.addEventListener('click', readAllStoresMachines);
        }

        // 🚀 綁定「一鍵全自動更新」按鈕
        const autoUpdateAllStoresBtn = document.getElementById('auto-update-all-stores-btn');
        if (autoUpdateAllStoresBtn) {
            autoUpdateAllStoresBtn.addEventListener('click', autoUpdateAllStores);
        }

        // 🧪 綁定「測試讀取所有門市」按鈕 (只處理前4組)
        const readAllStoresTestBtn = document.getElementById('read-all-stores-test-btn');
        if (readAllStoresTestBtn) {
            readAllStoresTestBtn.addEventListener('click', () => {
                readAllStoresMachines(4); // 只處理前4組
            });
        }

        reportPeriodSelector.addEventListener('change', () => {
            if (reportPeriodSelector.value === 'all') {
                reportDatePicker.classList.add('hidden');
            } else {
                reportDatePicker.classList.remove('hidden');
                if (!reportDatePicker.value) {
                    reportDatePicker.valueAsDate = new Date();
                }
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
        });
        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        
        machineListTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-machine-btn')) {
                handleDeleteMachine(e.target.dataset.docId);
            } else if (e.target.classList.contains('edit-machine-btn')) {
                console.log('🔧 修改按鈕被點擊');
                const btn = e.target;
                console.log('按鈕資料:', btn.dataset);
                
                // 填入基本資料
                document.getElementById('edit-machine-doc-id').value = btn.dataset.docId;
                document.getElementById('edit-machine-id').value = btn.dataset.id;
                document.getElementById('edit-machine-location').value = btn.dataset.location;
                document.getElementById('edit-machine-mac').value = btn.dataset.mac || '';
                document.getElementById('edit-machine-devid').value = btn.dataset.devid || '1';
                document.getElementById('edit-machine-initial-plays').value = btn.dataset.initialPlays;
                document.getElementById('edit-machine-initial-payouts').value = btn.dataset.initialPayouts;
                document.getElementById('edit-machine-plays-calibration').value = btn.dataset.playsCalibration || '0';
                document.getElementById('edit-machine-payouts-calibration').value = btn.dataset.payoutsCalibration || '0';
                
                // 載入禮品選項
                if (typeof updateEditMachineGiftSelector === 'function') {
                    updateEditMachineGiftSelector(btn.dataset.giftId || '');
                }
                
                // 計算並顯示當前數據
                updateCurrentMachineStatsWithPreview(btn.dataset.docId);
                
                console.log('顯示修改模態框');
                editMachineModal.classList.remove('hidden');
            } else if (e.target.classList.contains('poll-machine-btn')) {
                const btn = e.target;
                const mac = btn.dataset.mac;
                const devid = btn.dataset.devid;
                
                if (!mac) {
                    alert('請先設定機台 MAC 位址');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = '📊';
                btn.classList.add('opacity-50');
                
                try {
                    await pollSingleMachine(mac, devid || 1);
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            }
        });
        editMachineForm.addEventListener('submit', handleUpdateMachine);
        editMachineCancelBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));
        
        // 添加編輯機台模態框關閉按鈕事件
        const editMachineCloseBtn = document.getElementById('edit-machine-close-btn');
        if (editMachineCloseBtn) {
            editMachineCloseBtn.addEventListener('click', () => editMachineModal.classList.add('hidden'));
        }
        
        // 添加校正值即時預覽功能
        const editPlaysCalibrationInput = document.getElementById('edit-machine-plays-calibration');
        const editPayoutsCalibrationInput = document.getElementById('edit-machine-payouts-calibration');
        
        if (editPlaysCalibrationInput && editPayoutsCalibrationInput) {
            [editPlaysCalibrationInput, editPayoutsCalibrationInput].forEach(input => {
                input.addEventListener('input', () => {
                    const docId = document.getElementById('edit-machine-doc-id').value;
                    if (docId) {
                        updateCurrentMachineStatsWithPreview(docId);
                    }
                });
            });
        }

        historyTableBody.addEventListener('click', (e) => {
            const button = e.target;
            if (button.classList.contains('delete-history-btn')) {
                handleDeleteHistory(button.dataset.docId, button.dataset.machineId, button.dataset.location, parseInt(button.dataset.plays, 10), parseInt(button.dataset.payouts, 10));
            } else if (button.classList.contains('edit-history-btn')) {
                document.getElementById('edit-history-doc-id').value = button.dataset.docId;
                document.getElementById('edit-history-machine-id').value = button.dataset.machineId;
                document.getElementById('edit-history-location').value = button.dataset.location;
                document.getElementById('edit-history-old-plays').value = button.dataset.plays;
                document.getElementById('edit-history-old-payouts').value = button.dataset.payouts;
                document.getElementById('edit-history-date').value = button.dataset.date || '';
                document.getElementById('edit-history-plays').value = button.dataset.plays;
                document.getElementById('edit-history-payouts').value = button.dataset.payouts;
                editHistoryModal.classList.remove('hidden');
            }
        });
        editHistoryForm.addEventListener('submit', handleUpdateHistory);
        editHistoryCancelBtn.addEventListener('click', () => editHistoryModal.classList.add('hidden'));
        
        backToGroupsBtn.addEventListener('click', showGroupSelectionPage);
        backToStoresBtn.addEventListener('click', () => showStoreSelectionPage(selectedGroupId, selectedGroupName));

        allTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                allTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                allTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                const activeContent = document.getElementById(tab.dataset.tab);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                if (tab.dataset.tab === 'charts') { await renderChartsTab(); }
                if (tab.dataset.tab === 'statistics') { renderStatisticsTab(); }
                if (tab.dataset.tab === 'summary') { await renderSummaryTab(); }
                if (tab.dataset.tab === 'analysis') { renderAnalysisTab(); }
                 if (tab.dataset.tab === 'checkout') { 
                    headerDownloadButtons.classList.add('hidden');
                    renderCheckoutTab(); 
                } else {
                    headerDownloadButtons.classList.remove('hidden');
                }
            });
        });

        statsControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                statsControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderStatisticsTab();
            }
        });

        summaryControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                summaryControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderSummaryTab();
            }
        });
        
        psdControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const customRange = document.getElementById('psd-custom-range');
                if(e.target.dataset.period === 'custom'){
                    customRange.classList.remove('hidden');
                    customRange.classList.add('flex');
                } else {
                    customRange.classList.add('hidden');
                    customRange.classList.remove('flex');
                    e.target.classList.add('active');
                    renderAnalysisTab();
                }
            }
        });

        psdCalculateBtn.addEventListener('click', () => {
            const start = psdStartDate.value;
            const end = psdEndDate.value;
            if (start && end && start <= end) {
                psdControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                renderAnalysisTab({start, end});
            } else {
                alert('請選擇有效的起訖日期！');
            }
        });

        // PSD 周報比較按鈕
        if (psdWeeklyTrendBtn) {
            psdWeeklyTrendBtn.addEventListener('click', async () => {
                const start = psdStartDate.value;
                const end = psdEndDate.value;
                
                if (!start || !end) {
                    alert('請先選擇起訖日期！');
                    return;
                }
                
                if (start > end) {
                    alert('起始日期不能晚於結束日期！');
                    return;
                }
                
                if (!selectedStoreId) {
                    alert('請先選擇門市！');
                    return;
                }
                
                // 顯示載入提示
                pdfLoaderText.textContent = '正在生成PSD周報比較...';
                pdfLoaderOverlay.classList.remove('hidden');
                pdfLoaderOverlay.classList.add('flex');
                
                try {
                    const weeks = await calculateWeeklyTrends(selectedStoreId, start, end);
                    
                    if (weeks.length === 0) {
                        alert('所選日期範圍內沒有數據');
                        return;
                    }
                    
                    const html = generateWeeklyTrendHTML({
                        storeName: selectedStoreName,
                        weeks,
                        dateRange: `${start} ~ ${end}`,
                        groupName: selectedGroupName || ''
                    });
                    
                    const w = window.open('', '_blank');
                    if (!w) { alert('瀏覽器封鎖了彈出視窗，請允許此網站開啟新分頁'); return; }
                    w.document.open();
                    w.document.write(html);
                    w.document.close();
                } catch (error) {
                    console.error('生成PSD周報比較失敗:', error);
                    alert('生成報表失敗: ' + error.message);
                } finally {
                    pdfLoaderOverlay.classList.add('hidden');
                    pdfLoaderOverlay.classList.remove('flex');
                }
            });
        }

        // --- HTTP 連接狀態管理 (已停用 MQTT) ---
        // MQTT 按鈕事件已停用，改用 HTTP 方式
        // const mqttConnectBtn = document.getElementById('mqtt-connect-btn');
        // if (mqttConnectBtn) {
        //     mqttConnectBtn.addEventListener('click', function() { /* MQTT 已停用 */ });
        // }
        
        // HTTP 測試連線按鈕
        const mqttTestBtn = document.getElementById('mqtt-test-btn');
        if (mqttTestBtn) {
            mqttTestBtn.addEventListener('click', async function() {
                // 測試 HTTP 連線
                await testHttpConnection();
            });
        }

        // 立即輪詢所有機台按鈕
        const pollAllBtn = document.getElementById('poll-all-btn');
        if (pollAllBtn) {
            pollAllBtn.addEventListener('click', async function() {
                console.log('立即輪詢按鈕被點擊');
                await executePollAllMachines();
            });
        }

        // 🧪 測試輪詢按鈕 (只處理前4組)
        const pollTestBtn = document.getElementById('poll-test-btn');
        if (pollTestBtn) {
            pollTestBtn.addEventListener('click', async function() {
                console.log('🧪 測試輪詢按鈕被點擊 (只處理前4組)');
                await executePollAllMachines(4); // 傳入限制數量
            });
        }

        // ⚡ 快速讀取按鈕 (跳過發送查詢,直接讀取)
        const quickReadBtn = document.getElementById('quick-read-btn');
        if (quickReadBtn) {
            quickReadBtn.addEventListener('click', async function() {
                console.log('⚡ 快速讀取按鈕被點擊 (跳過查詢,直接讀取)');
                await quickReadAllMachines(); // 直接讀取,不限制數量
            });
        }

        // 調試映射表按鈕
        const debugMappingBtn = document.getElementById('debug-mapping-btn');
        if (debugMappingBtn) {
            debugMappingBtn.addEventListener('click', function() {
                console.log('🔍 調試映射表按鈕被點擊');
                debugMachineMapping();
            });
        }

        // 從輪詢帶入按鈕
        const importFromPollBtn = document.getElementById('import-from-poll-btn');
        if (importFromPollBtn) {
            importFromPollBtn.addEventListener('click', function() {
                console.log('📥 從輪詢帶入按鈕被點擊');
                importFromPoll();
            });
        }

        // 批量新增所有機台按鈕
        const batchAddAllBtn = document.getElementById('batch-add-all-btn');
        if (batchAddAllBtn) {
            batchAddAllBtn.addEventListener('click', function() {
                console.log('✅ 批量新增按鈕被點擊');
                batchAddAllMachines();
            });
        }

        // 🚀 批次處理設定按鈕
        const setBatchSizeBtn = document.getElementById('set-batch-size-btn');
        if (setBatchSizeBtn) {
            setBatchSizeBtn.addEventListener('click', function() {
                const input = document.getElementById('batch-size-input');
                const size = parseInt(input.value) || 50;
                window.setBatchSize(size);
                updateBatchStatusDisplay();
                console.log(`📊 批次大小已設定為: ${size}`);
            });
        }

        // 🚀 無限制模式按鈕
        const unlimitedModeBtn = document.getElementById('unlimited-mode-btn');
        if (unlimitedModeBtn) {
            unlimitedModeBtn.addEventListener('click', function() {
                const isUnlimited = !window.unlimitedBatchMode;
                window.enableUnlimitedBatch(isUnlimited);
                updateBatchStatusDisplay();
                
                if (isUnlimited) {
                    unlimitedModeBtn.textContent = '⚡ 無限制模式 (已啟用)';
                    unlimitedModeBtn.className = 'bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded';
                } else {
                    unlimitedModeBtn.textContent = '🚀 無限制模式';
                    unlimitedModeBtn.className = 'bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded';
                }
            });
        }

        // 📊 檢查批次狀態按鈕
        const checkBatchStatusBtn = document.getElementById('check-batch-status-btn');
        if (checkBatchStatusBtn) {
            checkBatchStatusBtn.addEventListener('click', function() {
                const status = window.getBatchStatus();
                updateBatchStatusDisplay();
                alert(`批次處理狀態：
批次大小: ${status.batchSize}
無限制模式: ${status.unlimitedMode ? '已啟用' : '已停用'}
輪詢記錄數: ${status.recordCount}
機台數量: ${status.machineCount}`);
            });
        }

        // 🔄 更新批次狀態顯示
        function updateBatchStatusDisplay() {
            const display = document.getElementById('batch-status-display');
            if (display) {
                const batchSize = window.batchProcessingSize || 50;
                const mode = window.unlimitedBatchMode ? '無限制' : '標準';
                const recordCount = window.dailyRecords ? Object.keys(window.dailyRecords).length : 0;
                display.textContent = `目前批次大小: ${batchSize} | 模式: ${mode} | 輪詢記錄: ${recordCount} 筆`;
            }
        }
        
        // 🚀 資料限制設定按鈕
        const setDataLimitBtn = document.getElementById('set-data-limit-btn');
        if (setDataLimitBtn) {
            setDataLimitBtn.addEventListener('click', function() {
                const input = document.getElementById('data-limit-input');
                const limit = parseInt(input.value);
                
                if (isNaN(limit) || limit < 5 || limit > 100) {
                    alert('❌ 請輸入 5-100 之間的數字');
                    return;
                }
                
                if (window.setDataLimit(limit)) {
                    // 顯示成功提示
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2';
                    notification.innerHTML = `
                        <span class="text-xl">✅</span>
                        <span>資料限制已設定為 <strong>${limit}</strong> 筆</span>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 3000);
                    
                    console.log(`✅ 資料處理限制已更新: ${limit} 筆`);
                }
            });
        }
        
        // 初始化資料限制顯示
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('data-limit-input');
            if (input) {
                input.value = window.dataProcessLimit || 10;
            }
        });

        // 初始化批次狀態顯示
        updateBatchStatusDisplay();

        // ============================================
        // 📊 F58A 協定解析器
        // ============================================
        const F58AProtocolParser = {
            // 投幣金額映射表
            coinMap: {
                0: 1, 1: 5, 2: 10, 3: 20, 4: 30, 5: 40, 
                6: 50, 7: 60, 8: 70, 9: 90, 10: 100
            },
            
            // 安全解析 Hex
            safeParseHex(str) {
                const val = parseInt(str, 16);
                return isNaN(val) ? 0 : val;
            },
            
            // Little Endian Hex 轉數值
            hexToDecLE(hexStr) {
                if (!hexStr || hexStr.length !== 4) return 0;
                const low = hexStr.substring(0, 2);
                const high = hexStr.substring(2, 4);
                const val = parseInt(high + low, 16);
                return isNaN(val) ? 0 : val;
            },
            
            // 馬達速度映射
            getMotorSpeed(hexVal) {
                if (isNaN(hexVal)) return "未知";
                if (hexVal > 0x0E) return "未知";
                return 30 + (hexVal * 5);
            },
            
            // 主解析函數
            parse(parmHex) {
                if (!parmHex || parmHex.length < 112) {
                    throw new Error(`Hex 字串長度不足 (${parmHex.length})，需要至少 112 字元`);
                }
                
                // 輔助函數：取得指定 Byte 的資料
                const getBytes = (startByte, length = 1) => {
                    const startIdx = (startByte - 8) * 2;
                    if (startIdx >= parmHex.length) return "";
                    return parmHex.substring(startIdx, startIdx + (length * 2));
                };
                
                // A1. 投幣器設定
                const coinPerInsertVal = this.safeParseHex(getBytes(8));
                const coinPerGameVal = this.safeParseHex(getBytes(9));
                
                // A2. 遊戲時間
                const gameTime = this.safeParseHex(getBytes(10));
                
                // A3. 禮品售價
                const giftPrice = this.hexToDecLE(getBytes(11, 2));
                
                // C2. 投幣遊戲次數
                const gameCount = this.hexToDecLE(getBytes(40, 2));
                
                // C3. 禮品出獎次數
                const prizeCount = this.hexToDecLE(getBytes(42, 2));
                
                // C4. 累加金額查詢 (10筆)
                const c4History = [];
                for (let i = 0; i < 10; i++) {
                    const startByte = 44 + (i * 2);
                    const valHex = getBytes(startByte, 2);
                    const valDec = this.hexToDecLE(valHex);
                    c4History.push({
                        id: i + 1,
                        hex: valHex || "0000",
                        value: valDec
                    });
                }
                
                // 遊戲模式
                const modeVal = this.safeParseHex(getBytes(65));
                const modeMap = { 0: "營業模式", 1: "免費模式", 2: "測試模式" };
                
                // 馬達速度
                const motors = {
                    e1: this.getMotorSpeed(this.safeParseHex(getBytes(66))),
                    e2: this.getMotorSpeed(this.safeParseHex(getBytes(67))),
                    e3: this.getMotorSpeed(this.safeParseHex(getBytes(68))),
                    e4: this.getMotorSpeed(this.safeParseHex(getBytes(69))),
                    e5: this.getMotorSpeed(this.safeParseHex(getBytes(70))),
                    e6: this.getMotorSpeed(this.safeParseHex(getBytes(71)))
                };
                
                // 電壓設定
                const voltage = {
                    strong: this.safeParseHex(getBytes(33)),
                    mid: this.safeParseHex(getBytes(34)),
                    weak: this.safeParseHex(getBytes(35))
                };
                
                return {
                    basic: {
                        coinPerInsert: this.coinMap[coinPerInsertVal] || `未知(0x${coinPerInsertVal.toString(16)})`,
                        coinPerGame: this.coinMap[coinPerGameVal] || `未知(0x${coinPerGameVal.toString(16)})`,
                        gameTime: gameTime,
                        giftPrice: giftPrice,
                        mode: modeMap[modeVal] || "未知",
                        gameCount,
                        prizeCount
                    },
                    voltage,
                    c4History,
                    motors
                };
            }
        };

        // 初始化協定查看器
        function initProtocolViewer() {
            const machineSelector = document.getElementById('protocol-machine-selector');
            const dataViewer = document.getElementById('protocol-data-viewer');
            const noDataDiv = document.getElementById('protocol-no-data');
            
            if (!machineSelector) return;
            
            // 載入機台選項
            function loadMachineOptions() {
                machineSelector.innerHTML = '<option value="">請選擇機台...</option>';
                
                if (!appData.machines || appData.machines.length === 0) {
                    machineSelector.innerHTML = '<option value="">尚無機台資料</option>';
                    return;
                }
                
                appData.machines.forEach((machine, index) => {
                    const option = document.createElement('option');
                    // 使用索引作為 value，確保唯一性
                    option.value = index;
                    option.textContent = `${machine.id} (${machine.location}) [devid:${machine.devid}] ${machine.mac ? '- ' + machine.mac : ''}`;
                    option.dataset.machineId = machine.id;
                    option.dataset.location = machine.location;
                    option.dataset.mac = machine.mac || '';
                    option.dataset.devid = String(machine.devid || '1');
                    option.dataset.index = index;
                    machineSelector.appendChild(option);
                });
                
                console.log('📋 已載入機台選項，總數:', appData.machines.length);
            }
            
            // 顯示協定資料
            function displayProtocolData(data, machineInfo, dataSource = '') {
                if (!data) {
                    dataViewer.classList.add('hidden');
                    noDataDiv.classList.remove('hidden');
                    return;
                }
                
                dataViewer.classList.remove('hidden');
                noDataDiv.classList.add('hidden');
                
                // 更新資料來源說明
                const sourceEl = document.getElementById('protocol-data-source');
                if (sourceEl) {
                    const sourceInfo = dataSource ? ` - 資料來源: ${dataSource}` : '';
                    sourceEl.innerHTML = `資料來源：機台 <strong>${machineInfo.id}</strong> (${machineInfo.location}) [devid:${machineInfo.devid}]${sourceInfo} - 輪詢時間: ${new Date().toLocaleString()}`;
                }
                
                // 基本參數
                document.getElementById('protocol-game-mode').textContent = data.basic.mode;
                document.getElementById('protocol-game-mode').className = `font-semibold px-2 py-1 rounded text-xs ${
                    data.basic.mode === '營業模式' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                }`;
                document.getElementById('protocol-coin-insert').textContent = `${data.basic.coinPerInsert} 元`;
                document.getElementById('protocol-coin-game').textContent = `${data.basic.coinPerGame} 元`;
                document.getElementById('protocol-game-time').textContent = `${data.basic.gameTime} 秒`;
                document.getElementById('protocol-gift-price').textContent = data.basic.giftPrice;
                
                // 營運計數
                document.getElementById('protocol-game-count').textContent = data.basic.gameCount;
                document.getElementById('protocol-prize-count').textContent = data.basic.prizeCount;
                
                // 電壓設定
                document.getElementById('protocol-voltage-strong').textContent = data.voltage.strong;
                document.getElementById('protocol-voltage-mid').textContent = data.voltage.mid;
                document.getElementById('protocol-voltage-weak').textContent = data.voltage.weak;
                
                // C4 累加金額
                const c4Container = document.getElementById('protocol-c4-history');
                c4Container.innerHTML = '';
                data.c4History.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-blue-900/30 rounded-lg p-4 border border-blue-700 flex flex-col items-center justify-center relative group hover:shadow-md transition-all';
                    card.innerHTML = `
                        <span class="absolute top-2 left-2 text-xs font-bold text-blue-400">#${item.id}</span>
                        <span class="text-3xl font-bold text-white my-2">${item.value}</span>
                        <span class="text-xs text-gray-400 font-mono">Hex: ${item.hex.substring(0,2)} ${item.hex.substring(2,4)}</span>
                    `;
                    c4Container.appendChild(card);
                });
                
                // 馬達速度
                document.getElementById('protocol-motor-e1').textContent = data.motors.e1;
                document.getElementById('protocol-motor-e2').textContent = data.motors.e2;
                document.getElementById('protocol-motor-e3').textContent = data.motors.e3;
                document.getElementById('protocol-motor-e4').textContent = data.motors.e4;
                document.getElementById('protocol-motor-e5').textContent = data.motors.e5;
                document.getElementById('protocol-motor-e6').textContent = data.motors.e6;
            }
            
            // 機台選擇事件
            machineSelector.addEventListener('change', async (e) => {
                const selectedOption = e.target.selectedOptions[0];
                if (!selectedOption || !selectedOption.value) {
                    dataViewer.classList.add('hidden');
                    noDataDiv.classList.remove('hidden');
                    return;
                }
                
                const machineInfo = {
                    id: selectedOption.dataset.machineId,
                    location: selectedOption.dataset.location,
                    mac: selectedOption.dataset.mac ? String(selectedOption.dataset.mac).toUpperCase() : null,
                    devid: String(selectedOption.dataset.devid), // 確保是字串
                    index: selectedOption.dataset.index
                };
                
                const compositeKey = machineInfo.mac ? `${machineInfo.mac}_${machineInfo.devid}` : machineInfo.devid;
                
                console.log('📊 查詢機台協定資料:', machineInfo);
                console.log('🔍 組合鍵:', compositeKey);
                console.log('🔍 當前 window.parmByDevid:', window.parmByDevid);
                console.log('🔍 可用的鍵值:', window.parmByDevid ? Object.keys(window.parmByDevid) : []);
                console.log('🔍 當前 window.parmByMac:', window.parmByMac);
                
                // 從 window.parmByDevid 或 window.machineDataByDevid 取得資料
                let parmData = null;
                let dataSource = '';
                
                // 方案1: 使用 MAC+devid 組合鍵（最優先）
                if (window.parmByDevid && window.parmByDevid[compositeKey]) {
                    parmData = window.parmByDevid[compositeKey];
                    dataSource = `parmByDevid["${compositeKey}"]`;
                    console.log(`✅ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                }
                // 方案2: 從 parmByMac[MAC][devid] 取得
                else if (window.parmByMac && machineInfo.mac && window.parmByMac[machineInfo.mac] && window.parmByMac[machineInfo.mac][machineInfo.devid]) {
                    parmData = window.parmByMac[machineInfo.mac][machineInfo.devid];
                    dataSource = `parmByMac["${machineInfo.mac}"]["${machineInfo.devid}"]`;
                    console.log(`✅ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                }
                // 方案3: 從 parmByDevid 取得原始 parm 資料（使用 devid，向後兼容）
                else if (window.parmByDevid && window.parmByDevid[machineInfo.devid]) {
                    parmData = window.parmByDevid[machineInfo.devid];
                    dataSource = `parmByDevid["${machineInfo.devid}"] (向後兼容)`;
                    console.log(`⚠️ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                    console.log(`⚠️ 警告：使用舊格式資料，可能不正確！建議重新輪詢`);
                }
                // 方案4: 嘗試使用 index+1 作為 devid（有些系統是這樣設計的）
                else if (window.parmByDevid && window.parmByDevid[String(parseInt(machineInfo.index) + 1)]) {
                    const altDevId = String(parseInt(machineInfo.index) + 1);
                    parmData = window.parmByDevid[altDevId];
                    dataSource = `parmByDevid["${altDevId}"] (使用 index+1)`;
                    console.log(`✅ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                }
                // 方案5: 從 machineDataByDevid 取得已解析的資料
                else if (window.machineDataByDevid && window.machineDataByDevid[compositeKey]) {
                    const machineData = window.machineDataByDevid[compositeKey];
                    if (machineData.rawHex) {
                        parmData = machineData.rawHex;
                        dataSource = `machineDataByDevid["${compositeKey}"].rawHex`;
                        console.log(`✅ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                    }
                }
                // 方案6: 從 appData.machines 中的該機台物件取得（如果有存 parm）
                else {
                    const machine = appData.machines[parseInt(machineInfo.index)];
                    if (machine && machine.parm) {
                        parmData = machine.parm;
                        dataSource = `appData.machines[${machineInfo.index}].parm`;
                        console.log(`✅ 從 ${dataSource} 取得資料，長度: ${parmData.length}`);
                    }
                }
                
                if (!parmData) {
                    console.warn('❌ 找不到機台資料');
                    console.warn('   查詢的組合鍵:', compositeKey);
                    console.warn('   查詢的 MAC:', machineInfo.mac);
                    console.warn('   查詢的 devid:', machineInfo.devid, '(類型:', typeof machineInfo.devid, ')');
                    console.warn('   可用的鍵值:', Object.keys(window.parmByDevid || {}));
                    console.warn('   可用的 MAC:', Object.keys(window.parmByMac || {}));
                    console.warn('   機台索引:', machineInfo.index);
                    showStatusMessage(`機台 ${machineInfo.id} (MAC: ${machineInfo.mac}) 尚無輪詢資料，請先執行輪詢`, 'warning');
                    dataViewer.classList.add('hidden');
                    noDataDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    console.log(`🔧 開始解析 parm 資料，長度: ${parmData.length}，來源: ${dataSource}`);
                    // 解析協定資料
                    const parsedData = F58AProtocolParser.parse(parmData);
                    console.log('✅ 協定解析成功:', parsedData);
                    
                    // 顯示資料
                    displayProtocolData(parsedData, machineInfo, dataSource);
                    showStatusMessage(`成功載入機台 ${machineInfo.id} 的協定資料`, 'success');
                    
                } catch (error) {
                    console.error('❌ 協定解析失敗:', error);
                    showStatusMessage(`解析失敗: ${error.message}`, 'error');
                    dataViewer.classList.add('hidden');
                    noDataDiv.classList.remove('hidden');
                }
            });
            
            // 初始載入機台選項
            loadMachineOptions();
            
            // 當機台資料更新時重新載入選項
            window.addEventListener('machinesUpdated', loadMachineOptions);
        }

        // 在切換到「機台營業明細」標籤時初始化
        const detailsTabBtn = document.querySelector('[data-tab="details"]');
        if (detailsTabBtn) {
            detailsTabBtn.addEventListener('click', () => {
                setTimeout(() => {
                    initProtocolViewer();
                }, 100);
            });
        }

        // ============================================
        // 📈 機台營收趨勢圖功能
        // ============================================
        let selectedMachineForTrend = null;
        let machineTrendChart = null;

        // 初始化日期範圍（預設最近30天）
        function initTrendDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            const trendStartInput = document.getElementById('trend-start-date');
            const trendEndInput = document.getElementById('trend-end-date');
            
            if (trendStartInput) trendStartInput.value = startDate.toISOString().split('T')[0];
            if (trendEndInput) trendEndInput.value = endDate.toISOString().split('T')[0];
        }

        // 載入機台選擇按鈕
        function loadMachineTrendSelector() {
            const selectorContainer = document.getElementById('machine-trend-selector');
            if (!selectorContainer) return;
            
            selectorContainer.innerHTML = '';
            
            if (!appData.machines || appData.machines.length === 0) {
                selectorContainer.innerHTML = '<p class="text-gray-400">尚無機台資料</p>';
                return;
            }
            
            appData.machines.forEach((machine, index) => {
                const button = document.createElement('button');
                button.className = `px-4 py-2 rounded-lg font-medium transition ${
                    selectedMachineForTrend === machine.docId 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`;
                button.textContent = `${machine.id} (${machine.location})`;
                button.dataset.machineId = machine.docId;
                
                button.addEventListener('click', () => {
                    selectedMachineForTrend = machine.docId;
                    loadMachineTrendSelector(); // 重新渲染按鈕狀態
                    updateMachineTrendChart();
                });
                
                selectorContainer.appendChild(button);
                
                // 預設選擇第一台機台
                if (index === 0 && !selectedMachineForTrend) {
                    selectedMachineForTrend = machine.docId;
                }
            });
        }

        // 更新機台營收趨勢圖
        async function updateMachineTrendChart() {
            if (!selectedMachineForTrend || !selectedGroupId || !selectedStoreId) {
                return;
            }
            
            const startDateInput = document.getElementById('trend-start-date');
            const endDateInput = document.getElementById('trend-end-date');
            
            if (!startDateInput || !endDateInput) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate) {
                alert('請選擇日期範圍');
                return;
            }
            
            // 取得選中的機台資訊
            const selectedMachine = appData.machines.find(m => m.docId === selectedMachineForTrend);
            if (!selectedMachine) return;
            
            try {
                showStatusMessage('正在載入趨勢資料...', 'info');
                
                // 從 Firebase 取得歷史記錄（只用 date 條件，避免需要複合索引）
                const historySnapshot = await db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('stores')
                    .doc(selectedStoreId)
                    .collection('history')
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .orderBy('date', 'asc')
                    .get();
                
                // 在前端過濾特定機台的資料
                const historyData = historySnapshot.docs
                    .map(doc => doc.data())
                    .filter(h => h.machineId === selectedMachine.id && h.location === selectedMachine.location);
                
                // 準備圖表資料
                const labels = historyData.map(h => h.date);
                const revenueData = historyData.map(h => (h.newPlays || 0) * COIN_VALUE);
                
                // 計算統計數據
                const totalRevenue = revenueData.reduce((sum, val) => sum + val, 0);
                const avgRevenue = revenueData.length > 0 ? totalRevenue / revenueData.length : 0;
                const maxRevenue = Math.max(...revenueData, 0);
                const minRevenue = Math.min(...revenueData.filter(v => v > 0), 0) || 0;
                
                // 更新統計摘要
                const totalElem = document.getElementById('trend-total-revenue');
                const avgElem = document.getElementById('trend-avg-revenue');
                const maxElem = document.getElementById('trend-max-revenue');
                const minElem = document.getElementById('trend-min-revenue');
                
                if (totalElem) totalElem.textContent = `${totalRevenue.toLocaleString()} 元`;
                if (avgElem) avgElem.textContent = `${Math.round(avgRevenue).toLocaleString()} 元`;
                if (maxElem) maxElem.textContent = `${maxRevenue.toLocaleString()} 元`;
                if (minElem) minElem.textContent = `${minRevenue.toLocaleString()} 元`;
                
                // 繪製圖表
                renderMachineTrendChart(labels, revenueData, selectedMachine);
                
                showStatusMessage('趨勢資料載入完成', 'success');
                
            } catch (error) {
                console.error('載入趨勢資料失敗:', error);
                showStatusMessage('載入趨勢資料失敗，請稍後再試', 'error');
            }
        }

        // 繪製機台趨勢圖表
        function renderMachineTrendChart(labels, data, machine) {
            const canvas = document.getElementById('machine-trend-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 清空畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (data.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('選定期間內無資料', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const maxValue = Math.max(...data, 100); // 至少 100 避免除以 0
            
            // 繪製背景格線
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Y軸標籤
                const value = Math.round(maxValue * (1 - i / 5));
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${value}元`, padding - 10, y + 4);
            }
            
            // 繪製座標軸
            ctx.strokeStyle = '#4B5563';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // 繪製折線圖
            if (data.length > 0) {
                const stepX = chartWidth / (data.length - 1 || 1);
                
                // 繪製區域填充
                ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                ctx.beginPath();
                ctx.moveTo(padding, canvas.height - padding);
                
                data.forEach((value, index) => {
                    const x = padding + index * stepX;
                    const y = canvas.height - padding - (value / maxValue) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                ctx.lineTo(padding + (data.length - 1) * stepX, canvas.height - padding);
                ctx.closePath();
                ctx.fill();
                
                // 繪製折線
                ctx.strokeStyle = '#3B82F6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                data.forEach((value, index) => {
                    const x = padding + index * stepX;
                    const y = canvas.height - padding - (value / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // 繪製數據點
                ctx.fillStyle = '#3B82F6';
                data.forEach((value, index) => {
                    const x = padding + index * stepX;
                    const y = canvas.height - padding - (value / maxValue) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 繪製外圈
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
                
                // 繪製 X 軸日期標籤（每隔幾個顯示）
                const labelStep = Math.max(1, Math.floor(labels.length / 10));
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                
                labels.forEach((label, index) => {
                    if (index % labelStep === 0 || index === labels.length - 1) {
                        const x = padding + index * stepX;
                        const y = canvas.height - padding + 20;
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(-Math.PI / 4);
                        ctx.fillText(label, 0, 0);
                        ctx.restore();
                    }
                });
            }
            
            // 繪製圖表標題
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${machine.id} (${machine.location}) - 營收趨勢`, canvas.width / 2, 30);
        }

        // 綁定更新按鈕事件
        const updateTrendBtn = document.getElementById('update-trend-chart');
        if (updateTrendBtn) {
            updateTrendBtn.addEventListener('click', updateMachineTrendChart);
        }

        // 在切換到圖表分析標籤時初始化
        const chartsTabBtn = document.querySelector('[data-tab="charts"]');
        if (chartsTabBtn) {
            chartsTabBtn.addEventListener('click', () => {
                setTimeout(() => {
                    initTrendDateRange();
                    loadMachineTrendSelector();
                    if (selectedMachineForTrend) {
                        updateMachineTrendChart();
                    }
                }, 100);
            });
        }

        // 發送讀取命令按鈕（使用 HTTP）
        const sendReadCmd = document.getElementById('send-read-command');
        if (sendReadCmd) {
            sendReadCmd.addEventListener('click', async function() {
                try {
                    // 獲取用戶輸入的 MAC 地址
                    const mac = document.getElementById('read-machine-mac').value.trim();
                    const devid = document.getElementById('read-device-id').value || 1;
                    
                    // 驗證 MAC 地址
                    if (!mac) {
                        alert('❌ 請輸入機台 MAC 位址');
                        return;
                    }
                    
                    // 按鈕載入狀態
                    this.disabled = true;
                    this.innerHTML = '🔄 發送中...';
                    
                    // 記錄到命令日誌
                    addCommandLog('send', `發送 HTTP GET 請求 - MAC: ${mac}`);
                    
                    // 發送 HTTP 請求
                    const result = await sendHttpRequest(mac);
                    
                    if (result) {
                        addCommandLog('receive', `HTTP 請求成功 - MAC: ${mac}`, result);
                    }
                    
                    // 恢復按鈕狀態
                    this.disabled = false;
                    this.innerHTML = '📤 測試查詢';
                    
                } catch (error) {
                    console.error('❌ HTTP 請求執行錯誤:', error);
                    alert('❌ HTTP 請求執行錯誤: ' + error.message);
                    addCommandLog('error', '執行錯誤: ' + error.message);
                    
                    // 恢復按鈕狀態
                    this.disabled = false;
                    this.innerHTML = '📤 測試查詢';
                }
            });
        }

        // 機台選擇器變更事件
        const machineSelector = document.getElementById('machine-selector');
        if (machineSelector) {
            machineSelector.addEventListener('change', (e) => {
                const selectedDocId = e.target.value;
                if(!selectedDocId) return;

                const selectedMachine = appData.machines.find(m => m.docId === selectedDocId);
                if (selectedMachine) {
                    document.getElementById('cumulative-plays').value = selectedMachine.plays;
                    document.getElementById('cumulative-payouts').value = selectedMachine.payouts;
                    document.getElementById('cumulative-plays').focus();
                }
            });
        }
        
        // 日常紀錄表單提交
        const dailyEntryForm = document.getElementById('daily-entry-form');
        if (dailyEntryForm) {
            dailyEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedStoreId) {
                    return showFeedback('錯誤：未選擇任何門市。', true);
                }
                
                const date = document.getElementById('entry-date').value;
                const machineSelector = document.getElementById('machine-selector');
                const machineDocId = machineSelector.value;

                if (!machineDocId) {
                     console.error('❌ 機台選擇器未選擇', {
                        selectorValue: machineSelector.value,
                        selectedOptions: machineSelector.selectedOptions.length,
                        options: machineSelector.options.length
                     });
                     return showFeedback('錯誤：請選擇一台機台。', true);
                }

                const selectedMachine = appData.machines.find(m => m.docId === machineDocId);

                const cumulativePlaysInput = parseInt(document.getElementById('cumulative-plays').value);
                const cumulativePayoutsInput = parseInt(document.getElementById('cumulative-payouts').value);

                if (isNaN(cumulativePlaysInput) || isNaN(cumulativePayoutsInput)) {
                    return showFeedback('錯誤：請填寫所有欄位。', true);
                }

                if (!selectedMachine) { return showFeedback('錯誤：無法識別所選機台。', true); }

                const lastRecordedPlays = normalizeCount(selectedMachine.plays);
                const lastRecordedPayouts = normalizeCount(selectedMachine.payouts);
                const initialPlays = normalizeCount(selectedMachine.initialPlays);
                const initialPayouts = normalizeCount(selectedMachine.initialPayouts);
                const baselinePlays = Math.max(lastRecordedPlays, initialPlays);
                const baselinePayouts = Math.max(lastRecordedPayouts, initialPayouts);

                if (cumulativePlaysInput < baselinePlays || cumulativePayoutsInput < baselinePayouts) {
                    return showFeedback(`錯誤：輸入的累積數值不可小於基準值 (投幣: ${baselinePlays}, 出貨: ${baselinePayouts})。`, true);
                }


            const dailyPlays = cumulativePlaysInput - baselinePlays;
            const dailyPayouts = cumulativePayoutsInput - baselinePayouts;
            if (dailyPlays === 0 && dailyPayouts === 0) {
                return showFeedback('數據未變更，無需新增紀錄。');
            }

            try {
                const machineRef = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('machines').doc(machineDocId);
                await machineRef.update({
                    plays: cumulativePlaysInput,
                    payouts: cumulativePayoutsInput
                });
                
                // 檢查是否已存在相同日期和機台的歷史記錄
                console.log(`🔍 查詢條件: date=${date}, machineId=${selectedMachine.id}, location=${selectedMachine.location}`);
                
                const historyQuery = db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(selectedStoreId)
                    .collection('history');
                
                let existingRecords = null;
                let updateMode = false;
                
                try {
                    // 嘗試複合查詢
                    existingRecords = await historyQuery
                        .where('date', '==', date)
                        .where('machineId', '==', selectedMachine.id)
                        .where('location', '==', selectedMachine.location)
                        .get();
                    
                    console.log(`📋 複合查詢結果: ${existingRecords.docs.length} 筆記錄`);
                    
                } catch (queryError) {
                    // 如果複合查詢失敗（可能缺少索引），使用單個查詢逐一檢查
                    console.warn(`⚠️ 複合查詢失敗，使用備用方案: ${queryError.message}`);
                    const allRecords = await historyQuery.get();
                    const filtered = allRecords.docs.filter(doc => {
                        const data = doc.data();
                        return data.date === date && 
                               data.machineId === selectedMachine.id && 
                               data.location === selectedMachine.location;
                    });
                    existingRecords = { docs: filtered };
                    console.log(`📋 備用查詢結果: ${filtered.length} 筆記錄`);
                }
                
                if (existingRecords.docs.length > 0) {
                    // 更新現有記錄
                    updateMode = true;
                    const docId = existingRecords.docs[0].id;
                    console.log(`🔄 找到現有記錄，準備更新: ${docId}`);
                    
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history').doc(docId)
                        .update({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`✅ 已更新記錄: ${docId}`);
                } else {
                    // 新增新記錄
                    console.log(`📝 未找到現有記錄，準備新增`);
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(selectedStoreId)
                        .collection('history')
                        .add({
                            date: date,
                            machineId: selectedMachine.id,
                            location: selectedMachine.location,
                            newPlays: dailyPlays,
                            newPayouts: dailyPayouts,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log(`✅ 已新增記錄`);
                }
                
                await loadStoreData(); 
                e.target.reset();
                document.getElementById('entry-date').valueAsDate = new Date();
                const actionType = updateMode ? '更新' : '新增';
                const successMessage = `紀錄已${actionType}並同步至 [${selectedStoreName}]！本日 ${selectedMachine.id} 新增：<strong class="text-white">${dailyPlays}</strong> 投幣、<strong class="text-white">${dailyPayouts}</strong> 出貨。`;
                showFeedback(successMessage);

            } catch (error) {
                console.error("寫入 Firestore 時發生錯誤: ", error);
                showFeedback("無法將紀錄同步至雲端，請稍後再試。", true);
            }
            });
        }
        
        // 搜尋輸入框事件
        const searchInputElem = document.getElementById('search-input') || searchInput;
        if (searchInputElem) {
            searchInputElem.addEventListener('input', async () => await updateUI());
        }
        sortableHeaders.forEach(header => {
            header.addEventListener('click', async () => {
                const sortKey = header.dataset.sort;
                let direction = 'asc';
                if (currentSort.key === sortKey && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                currentSort = { key: sortKey, direction };
                sortableHeaders.forEach(h => {
                    h.classList.remove('sorted');
                    if(h !== header) h.querySelector('.sort-indicator').textContent = '';
                });
                header.classList.add('sorted');
                header.querySelector('.sort-indicator').textContent = direction === 'asc' ? '▲' : '▼';
                await updateUI();
            });
        });
        
        recalculateAllBtn.addEventListener('click', async () => {
            if (!selectedStoreId) return;

            pdfLoaderText.textContent = '正在重新整理與計算所有數據...';
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                await loadStoreData(); // This function already re-fetches and calls updateUI()
                showFeedback("所有數據已成功重新計算並更新！", false);
            } catch (error) {
                console.error("重新計算失敗:", error);
                showFeedback("數據更新失敗，請檢查網路連線。", true);
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        downloadPdfBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active');
            if (!activeTab) return;

            const tabId = activeTab.dataset.tab;
            const tabName = activeTab.textContent;

            if (tabId === 'accounting' || tabId === 'machines' || tabId === 'checkout') {
                alert('此頁面不支援 PDF 匯出。請選擇一個報表頁籤。');
                return;
            }

            pdfLoaderText.textContent = `正在生成「${tabName}」報表...`;
            pdfLoaderOverlay.classList.remove('hidden');
            pdfLoaderOverlay.classList.add('flex');

            try {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById(tabId);
                const originalScrollTop = content.scrollTop;
                content.scrollTop = 0; // Ensure we capture from the top

                const canvas = await html2canvas(content, {
                    backgroundColor: '#1f2937',
                    scale: 2,
                    useCORS: true,
                    windowHeight: content.scrollHeight
                });
                content.scrollTop = originalScrollTop; // Restore scroll

                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const margin = 10;

                const imgProps = doc.getImageProperties(imgData);
                const imgWidth = pdfWidth - margin * 2;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 30);

                while (heightLeft > 0) {
                    doc.addPage();
                    position -= (pdfHeight - 30);
                    doc.addImage(imgData, 'PNG', margin, position + 20, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 30);
                }

                for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                    doc.setPage(i);
                    doc.setFontSize(14);
                    doc.setTextColor(150);
                    doc.text(selectedStoreName, margin, 15);
                    doc.setFontSize(10);
                    doc.text(`報表生成日期: ${new Date().toLocaleDateString()}`, pdfWidth - margin, 15, { align: 'right' });
                    doc.setFontSize(8);
                    doc.text(`第 ${i} 頁 / 共 ${doc.internal.getNumberOfPages()} 頁`, pdfWidth / 2, pdfHeight - margin, { align: 'center' });
                }
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                doc.save(`${selectedStoreName}-${tabName}-報告-${dateString}.pdf`);

            } catch (error) {
                console.error("PDF 生成失敗:", error);
                alert("生成 PDF 時發生錯誤，請稍後再試。");
            } finally {
                pdfLoaderOverlay.classList.add('hidden');
                pdfLoaderOverlay.classList.remove('flex');
            }
        });
        
        document.getElementById('download-report-btn').addEventListener('click', () => {
            if (!selectedStoreId) {
                showFeedback("請先選擇門市再下載報告。", true);
                return;
            }

            const processedMachines = appData.machines.map(processMachineData);
            if (processedMachines.length === 0 && appData.history.length === 0) {
                showFeedback("目前沒有資料可供下載。請先新增機台並記錄數據。", true);
                return;
            }

            showCustomReportModal();
        });

        // 自定義報表模態視窗事件監聽器
        customReportCancelBtn.addEventListener('click', hideCustomReportModal);
        
        customReportDownloadBtn.addEventListener('click', generateCustomReport);

        // 快速選擇按鈕事件
        selectAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        selectBasicReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, false, false, false, false);
        });

        selectDetailedReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(true, true, true, true, true, true, true);
        });

        clearAllReportsBtn.addEventListener('click', () => {
            setReportCheckboxes(false, false, false, false, false, false, false);
        });

        // 模態視窗點擊外部關閉
        customReportModal.addEventListener('click', (e) => {
            if (e.target === customReportModal) {
                hideCustomReportModal();
            }
        });

        // 自定義門市報表模態視窗事件監聽器
        customStoreReportCancelBtn.addEventListener('click', hideCustomStoreReportModal);
        
        customStoreReportDownloadBtn.addEventListener('click', generateCustomStoreReport);

        // 門市報表快速選擇按鈕事件
        selectAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        selectBasicStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, false, false, false, false);
        });

        selectDetailedStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(true, true, true, true, true, true);
        });

        clearAllStoreReportsBtn.addEventListener('click', () => {
            setStoreReportCheckboxes(false, false, false, false, false, false);
        });

        // 門市報表模態視窗點擊外部關閉
        customStoreReportModal.addEventListener('click', (e) => {
            if (e.target === customStoreReportModal) {
                hideCustomStoreReportModal();
            }
        });

        performCheckoutBtn.addEventListener('click', handlePerformCheckout);

        // 統計範圍控制按鈕事件監聽器
        document.addEventListener('click', async function(e) {
            // 統計頁面範圍按鈕
            if (e.target.classList.contains('stats-range-btn')) {
                document.querySelectorAll('.stats-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentStatsRange = e.target.dataset.range;
                renderStatisticsTab(); // 重新整理統計頁面
            }
            
            // 圖表頁面範圍按鈕
            if (e.target.classList.contains('chart-range-btn')) {
                document.querySelectorAll('.chart-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentChartsRange = e.target.dataset.range;
                await renderChartsTab(); // 重新整理圖表頁面
            }
            
            // 營業明細頁面範圍按鈕
            if (e.target.classList.contains('summary-range-btn')) {
                document.querySelectorAll('.summary-range-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600'));
                e.target.classList.add('active', 'bg-blue-600');
                currentSummaryRange = e.target.dataset.range;
                renderSummaryTab(); // 重新整理營業明細頁面
            }
        });

        // 重新整理按鈕事件監聽器
        const refreshAllStatsBtn = document.getElementById('refresh-all-stats-btn');

        if (refreshAllStatsBtn) {
            refreshAllStatsBtn.addEventListener('click', async function() {
                console.log('🔄 手動觸發重新統計所有資料...');
                this.innerHTML = '🔄 統計中...';
                this.disabled = true;
                
                const success = await refreshAllStatistics();
                
                this.innerHTML = '🔄 重新統計全部';
                this.disabled = false;
                
                if (success) {
                    showFeedback('✅ 所有統計資料已重新整理完成！', false);
                } else {
                    showFeedback('❌ 重新統計時發生錯誤，請稍後再試', true);
                }
            });
        }

        // 盈利計算相關事件監聽器
        const calculateProfitBtn = document.getElementById('calculate-profit-btn');
        const saveCostSettingsBtn = document.getElementById('save-cost-settings-btn');
        const giftCostInput = document.getElementById('gift-cost');
        const rentPercentageInput = document.getElementById('rent-percentage');
        const taxPercentageInput = document.getElementById('tax-percentage');

        if (calculateProfitBtn) {
            calculateProfitBtn.addEventListener('click', calculateProfit);
        }

        if (saveCostSettingsBtn) {
            saveCostSettingsBtn.addEventListener('click', saveCostSettings);
        }

        // 即時計算功能
        [giftCostInput, rentPercentageInput, taxPercentageInput].forEach(input => {
            if (input) {
                input.addEventListener('input', () => {
                    // 延遲計算以避免過於頻繁的更新
                    clearTimeout(window.profitCalculateTimeout);
                    window.profitCalculateTimeout = setTimeout(calculateProfit, 500);
                });
            }
        });

        // 計算範圍變更事件
        document.querySelectorAll('input[name="profit-calculation-scope"]').forEach(radio => {
            radio.addEventListener('change', calculateProfit);
        });

        // 盈利詳情查看事件
        const profitDetailModal = document.getElementById('profit-detail-modal');
        const closeProfitDetailBtn = document.getElementById('close-profit-detail');

        if (closeProfitDetailBtn) {
            closeProfitDetailBtn.addEventListener('click', () => {
                profitDetailModal.classList.add('hidden');
            });
        }

        // 結帳歷史表格中的盈利詳情按鈕事件
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-profit-detail-btn')) {
                const checkoutData = JSON.parse(e.target.dataset.checkoutData);
                showProfitDetail(checkoutData);
            }
        });

        function showProfitDetail(checkout) {
            const periodProfit = checkout.periodProfit || {};
            const totalProfit = checkout.totalProfit || {};
            
            // 營業數據
            document.getElementById('detail-checkout-date').textContent = 
                new Date(checkout.checkoutDate.toDate()).toLocaleString();
            document.getElementById('detail-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} 元`;
            document.getElementById('detail-payouts').textContent = 
                `${(checkout.checkoutPayouts || 0).toLocaleString()} 次`;
            
            // 成本設定
            const costSettings = totalProfit.costSettings || {};
            document.getElementById('detail-gift-cost').textContent = 
                `${costSettings.giftCost || 0} 元/次`;
            document.getElementById('detail-rent-percentage').textContent = 
                `${costSettings.rentPercentage || 0}%`;
            document.getElementById('detail-tax-percentage').textContent = 
                `${costSettings.taxPercentage || 0}%`;
            
            // 成本明細 (使用當期數據)
            document.getElementById('detail-total-gift-cost').textContent = 
                `${(periodProfit.giftCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-rent-cost').textContent = 
                `${(periodProfit.rentCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-tax-cost').textContent = 
                `${(periodProfit.taxCost || 0).toLocaleString()} 元`;
            document.getElementById('detail-total-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} 元`;
            
            // 盈利分析
            document.getElementById('detail-profit-revenue').textContent = 
                `${(checkout.checkoutAmount || 0).toLocaleString()} 元`;
            document.getElementById('detail-profit-cost').textContent = 
                `${(periodProfit.totalCost || 0).toLocaleString()} 元`;
                
            const netProfit = periodProfit.netProfit || 0;
            const profitColor = netProfit >= 0 ? 'text-green-400' : 'text-red-400';
            const profitMargin = checkout.checkoutAmount > 0 ? 
                (netProfit / checkout.checkoutAmount) * 100 : 0;
                
            document.getElementById('detail-net-profit').textContent = 
                `${netProfit.toLocaleString()} 元`;
            document.getElementById('detail-net-profit').className = 
                `font-bold text-lg ${profitColor}`;
            document.getElementById('detail-profit-margin').textContent = 
                `${profitMargin.toFixed(2)}%`;
            document.getElementById('detail-profit-margin').className = 
                `font-semibold ${profitColor}`;
            
            profitDetailModal.classList.remove('hidden');
        }

        // 下載結帳報表 CSV
        downloadCheckoutCsvBtn.addEventListener('click', async () => {
            if (!selectedGroupId || !selectedStoreId) {
                alert('請先選擇門市');
                return;
            }

            try {
                const btn = downloadCheckoutCsvBtn;
                const originalText = btn.textContent;
                btn.textContent = '產生中...';
                btn.disabled = true;

                // 獲取結帳歷史
                const checkoutCollection = db.collection('groups').doc(selectedGroupId).collection('stores').doc(selectedStoreId).collection('checkouts').orderBy('checkoutDate', 'desc');
                const checkoutSnapshot = await checkoutCollection.get();
                const checkouts = checkoutSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                // 生成 CSV 內容
                const csvRows = [];
                csvRows.push('\uFEFF'); // UTF-8 BOM
                csvRows.push(`結帳報表 - ${selectedStoreName}`);
                csvRows.push(`報表產生日期: ${new Date().toLocaleString()}`);
                csvRows.push('');
                
                if (checkouts.length === 0) {
                    csvRows.push('尚無結帳紀錄');
                } else {
                    // 表頭
                    csvRows.push(['結帳日期', '結帳金額', '累積營收', '期間天數', '平均每日營收'].join(','));
                    
                    // 資料行
                    checkouts.forEach((checkout, index) => {
                        const checkoutDate = new Date(checkout.checkoutDate.toDate());
                        const prevCheckoutDate = index < checkouts.length - 1 ? 
                            new Date(checkouts[index + 1].checkoutDate.toDate()) : 
                            new Date(appData.startDate);
                        
                        const daysDiff = Math.ceil((checkoutDate - prevCheckoutDate) / (1000 * 60 * 60 * 24));
                        const avgDailyRevenue = daysDiff > 0 ? checkout.checkoutAmount / daysDiff : 0;
                        
                        csvRows.push([
                            checkoutDate.toLocaleString(),
                            checkout.checkoutAmount,
                            checkout.cumulativeRevenueAtCheckout,
                            daysDiff,
                            avgDailyRevenue.toFixed(2)
                        ].join(','));
                    });

                    // 統計摘要
                    csvRows.push('');
                    csvRows.push('--- 統計摘要 ---');
                    const totalCheckouts = checkouts.length;
                    const totalRevenue = checkouts.length > 0 ? checkouts[0].cumulativeRevenueAtCheckout : 0;
                    const avgCheckoutAmount = checkouts.length > 0 ? 
                        checkouts.reduce((sum, c) => sum + c.checkoutAmount, 0) / checkouts.length : 0;
                    
                    csvRows.push(`總結帳次數,${totalCheckouts}`);
                    csvRows.push(`累積總營收,${totalRevenue} 元`);
                    csvRows.push(`平均結帳金額,${avgCheckoutAmount.toFixed(2)} 元`);
                }

                // 下載 CSV
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute('download', `${selectedStoreName}-結帳報表-${dateString}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('下載結帳報表失敗:', error);
                alert('下載報表時發生錯誤，請稍後再試。');
                
                downloadCheckoutCsvBtn.textContent = '下載結帳報表 (CSV)';
                downloadCheckoutCsvBtn.disabled = false;
            }
        });

        // === 機台詳細資料顯示功能 ===
        
        // 顯示機台詳細資料面板
        function showMachineDetailPanel(machine, mqttData) {
            console.log('=== 顯示機台詳細資料面板 ===');
            console.log('機台:', machine);
            console.log('MQTT 資料:', mqttData);
            
            const panel = document.getElementById('machine-detail-panel');
            console.log('面板元素:', panel);
            
            if (!panel) {
                console.error('找不到機台詳細資料面板元素！');
                alert('系統錯誤：找不到詳細資料面板');
                return;
            }
            
            // 更新基本資料
            document.getElementById('detail-machine-id').textContent = machine.id;
            document.getElementById('detail-mac-address').textContent = machine.mac || '--';
            document.getElementById('detail-device-id').textContent = machine.devid || '--';
            document.getElementById('detail-last-update').textContent = mqttData.parseTime;
            
            // 檢查是否為狀態回應
            if (mqttData.isStatusOnly) {
                // 清空詳細資料，只顯示狀態
                ['detail-strong-voltage', 'detail-medium-voltage', 'detail-weak-voltage', 
                 'detail-height-to-top', 'detail-clamp-voltage', 'detail-win-rate-bank',
                 'detail-coin-game-count', 'detail-prize-count', 'detail-amount-1',
                 'detail-amount-2', 'detail-amount-3'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '--';
                });
                
                // 顯示狀態信息
                document.getElementById('detail-raw-hex').textContent = `狀態回應: ${mqttData.rawHex} (狀態碼: ${mqttData.statusCode})`;
            } else {
                // 更新電壓資料
                const voltage = mqttData.voltageData || {};
                document.getElementById('detail-strong-voltage').textContent = voltage.strongVoltage || '--';
                document.getElementById('detail-medium-voltage').textContent = voltage.mediumVoltage || '--';
                document.getElementById('detail-weak-voltage').textContent = voltage.weakVoltage || '--';
                document.getElementById('detail-height-to-top').textContent = voltage.heightToTop || '--';
                document.getElementById('detail-clamp-voltage').textContent = voltage.clampVoltage || '--';
                
                // 更新營運資料
                const operation = mqttData.operationData || {};
                document.getElementById('detail-win-rate-bank').textContent = operation.winRateBank || '--';
                document.getElementById('detail-coin-game-count').textContent = operation.coinGameCount || '--';
                document.getElementById('detail-prize-count').textContent = operation.prizeCount || '--';
                
                // 更新累加金額
                document.getElementById('detail-amount-1').textContent = operation.accumulatedAmount1 || '--';
                document.getElementById('detail-amount-2').textContent = operation.accumulatedAmount2 || '--';
                document.getElementById('detail-amount-3').textContent = operation.accumulatedAmount3 || '--';
                
                // 更新原始資料
                document.getElementById('detail-raw-hex').textContent = mqttData.rawHex || '--';
            }
            
            console.log('準備顯示面板...');
            
            // 確保在機台管理頁籤下顯示
            const machinesTab = document.querySelector('[data-tab="machines"]');
            if (machinesTab && !document.getElementById('machines').classList.contains('hidden')) {
                console.log('當前在機台管理頁籤');
            } else {
                console.log('切換到機台管理頁籤');
                // 切換到機台管理頁籤
                if (machinesTab) {
                    machinesTab.click();
                }
            }
            
            // 顯示面板
            panel.classList.remove('hidden');
            console.log('面板 hidden 類已移除');
            
            // 滾動到面板位置
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('滾動到面板位置');
            
            // 添加高亮效果
            panel.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => {
                panel.classList.remove('ring-2', 'ring-blue-500');
            }, 2000);
            
            console.log('✅ 機台詳細資料面板顯示完成');
        }
        
        // 關閉詳細資料面板 (安全初始化)
        function initializeDetailPanel() {
            const closeBtn = document.getElementById('close-detail-panel');
            if (closeBtn && !closeBtn._initialized) {
                closeBtn._initialized = true;
                closeBtn.addEventListener('click', () => {
                    document.getElementById('machine-detail-panel').classList.add('hidden');
                });
            }
        }
        
        // === MQTT 輪詢功能 ===
        let pollInterval = null;
        
        // 🔧 輪詢時間間隔設定
        let pollSettings = {
            cmdInterval: 100,      // 讀取指令間隔 (毫秒)
            pollInterval: 10000    // 輪詢週期間隔 (毫秒)
        };
        
        // 從 localStorage 載入設定
        function loadPollSettings() {
            const saved = localStorage.getItem('pollSettings');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    pollSettings = { ...pollSettings, ...loaded };
                    console.log('📋 已載入輪詢設定:', pollSettings);
                } catch (e) {
                    console.warn('輪詢設定載入失敗，使用預設值');
                }
            }
            updatePollSettingsDisplay();
        }
        
        // 保存設定到 localStorage
        function savePollSettings() {
            localStorage.setItem('pollSettings', JSON.stringify(pollSettings));
            console.log('✅ 輪詢設定已保存:', pollSettings);
        }
        
        // 更新 UI 顯示
        function updatePollSettingsDisplay() {
            const cmdDisplay = document.getElementById('cmd-interval-display');
            const pollDisplay = document.getElementById('poll-interval-display');
            
            if (cmdDisplay) {
                cmdDisplay.textContent = `目前: ${pollSettings.cmdInterval}ms`;
            }
            if (pollDisplay) {
                pollDisplay.textContent = `目前: ${pollSettings.pollInterval / 1000}秒`;
            }
        }
        
        // 初始化 MQTT 輪詢功能 (確保元素已載入)
        function initializeMqttPolling() {
            try {
                const machineListTableBody = document.getElementById('machine-list-table-body');
                if (!machineListTableBody) {
                    console.warn('machineListTableBody not found, retrying...');
                    setTimeout(initializeMqttPolling, 100);
                    return;
                }

                // ❌ 已移除：機台列表直接輸入功能 (防止誤觸修改)
                // 現在只能透過「修改」按鈕來編輯機台資料
                /*
                // MAC 位址輸入框即時更新 (使用事件委派避免重複監聽)
                if (!machineListTableBody._mqttInputHandler) {
                    machineListTableBody._mqttInputHandler = true;
                    machineListTableBody.addEventListener('input', async (e) => {
                        // ... 已移除的直接編輯代碼 ...
                    });
                }
                */

                console.log('MQTT 輪詢功能初始化完成');
            } catch (error) {
                console.error('初始化 MQTT 輪詢功能失敗:', error);
            }
        }

        // 初始化 MQTT 控制面板事件監聽器
        function initializeMqttControls() {
            try {
                // 自動輪詢控制 (使用正確的 ID)
                const autoPollCheckbox = document.getElementById('auto-poll-enabled');
                if (autoPollCheckbox && !autoPollCheckbox._initialized) {
                    autoPollCheckbox._initialized = true;
                    autoPollCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            startAutoPolling();
                        } else {
                            stopAutoPolling();
                        }
                    });
                }

                // 手動觸發輪詢 (使用正確的 ID)
                const pollTriggerBtn = document.getElementById('poll-all-btn');
                if (pollTriggerBtn && !pollTriggerBtn._initialized) {
                    pollTriggerBtn._initialized = true;
                    pollTriggerBtn.addEventListener('click', () => {
                        pollAllMachines();
                    });
                }

                // 輪詢間隔更改 (使用正確的 ID)
                const intervalSelect = document.getElementById('poll-interval');
                if (intervalSelect && !intervalSelect._initialized) {
                    intervalSelect._initialized = true;
                    intervalSelect.addEventListener('change', (e) => {
                        const autoPoll = document.getElementById('auto-poll-enabled');
                        if (autoPoll && autoPoll.checked) {
                            stopAutoPolling();
                            startAutoPolling();
                        }
                    });
                }
                
                // 🚀 自動輪詢啟動設定 (新功能)
                const autoPollOnLoadCheckbox = document.getElementById('auto-poll-on-load');
                if (autoPollOnLoadCheckbox && !autoPollOnLoadCheckbox._initialized) {
                    autoPollOnLoadCheckbox._initialized = true;
                    
                    // 設置初始狀態
                    if (selectedGroupId && selectedStoreId) {
                        autoPollOnLoadCheckbox.checked = getAutoPollOnLoadSetting();
                    }
                    
                    autoPollOnLoadCheckbox.addEventListener('change', (e) => {
                        if (selectedGroupId && selectedStoreId) {
                            setAutoPollOnLoadSetting(e.target.checked);
                            
                            if (e.target.checked) {
                                console.log('✅ 已啟用進入門市自動輪詢功能');
                                // 顯示提示
                                const notification = document.createElement('div');
                                notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                                notification.innerHTML = '✅ 已啟用進入門市自動輪詢';
                                document.body.appendChild(notification);
                                
                                setTimeout(() => {
                                    if (notification.parentNode) {
                                        notification.parentNode.removeChild(notification);
                                    }
                                }, 2000);
                            } else {
                                console.log('❌ 已停用進入門市自動輪詢功能');
                            }
                        }
                    });
                }
                
                console.log('MQTT 控制面板初始化完成');
            } catch (error) {
                console.warn('初始化 MQTT 控制面板時發生錯誤:', error);
            }
        }

        // 單台機台輪詢 (HTTP 版本)
        async function pollSingleMachine(mac, devid) {
            console.log('=== 單台 HTTP 輪詢 ===');
            
            if (!mac) {
                console.error('MAC 地址無效');
                return;
            }
            
            // 🔒 強制偵測環境 - 確保準確
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\n🔍 環境偵測: 協議=${currentProtocol}, 是否HTTPS=${isHttps}, GitHub Pages=${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`🔒 HTTPS 環境確認: ${isGitHubPages ? '(GitHub Pages)' : '(其他 HTTPS 服務)'}`);
                console.log('📋 HTTPS 環境說明: 瀏覽器會自動使用 CORS 代理來提取數據');
            }
            
            try {
                // 在 HTTP 環境才發送讀取指令（HTTPS 環境會被瀏覽器阻止）
                if (!isHttps) {
                    console.log(`\n📤 [步驟 1] 發送讀取指令 - MAC: ${mac}, DevID: ${devid}`);
                    const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                    console.log(`📌 讀取指令 URL: ${readCmdUrl}`);
                    
                    try {
                        const readCmdResponse = await fetch(readCmdUrl, {
                            method: 'GET',
                            mode: 'cors',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        if (readCmdResponse.ok) {
                            const readCmdData = await readCmdResponse.json();
                            console.log(`✅ 讀取指令回應:`, readCmdData);
                            
                            // 驗證回應
                            if (readCmdData.Valid === true && readCmdData.ResultCode === 200) {
                                console.log(`✅ 讀取指令確認: "${readCmdData.ResultMessage}"`);
                            } else {
                                console.warn(`⚠️ 讀取指令異常: Valid=${readCmdData.Valid}, ResultCode=${readCmdData.ResultCode}`);
                            }
                        } else {
                            console.warn(`⚠️ 讀取指令 HTTP ${readCmdResponse.status}`);
                        }
                    } catch (readCmdError) {
                        console.warn(`⚠️ 讀取指令失敗 (繼續進行): ${readCmdError.message}`);
                    }
                    
                    // 等待 1 秒，讓機台準備數據
                    console.log(`⏳ [步驟2] 等待 1 秒，讓機台準備數據...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    console.log(`✅ 等待完成`);
                } else {
                    console.log(`⏳ HTTPS 環境: 跳過讀取指令，直接進行數據抓取...`);
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // 📌 步驟 2：進行數據抓取
                console.log(`\n� [步驟 2] 發送 HTTP GET 請求抓取數據 - MAC: ${mac}, DevID: ${devid}`);
                const result = await sendHttpRequest(mac);
                
                if (result) {
                    console.log(`✅ 數據抓取成功 - MAC: ${mac}, DevID: ${devid}`);
                    // 傳遞 devid 給 handleHttpResponse
                    handleHttpResponse(result, mac, devid);
                    addCommandLog('receive', `HTTP 回應成功 - MAC: ${mac}, DevID: ${devid}`, result);
                } else {
                    console.warn(`❌ 數據抓取失敗 - MAC: ${mac}`);
                    addCommandLog('error', `數據抓取失敗 - MAC: ${mac}`);
                }
                
            } catch (error) {
                console.error('HTTP 輪詢失敗:', error);
                addCommandLog('error', `HTTP 輪詢失敗: ${error.message}`);
            }
        }

        // ✅ 優化配置：快速輪詢模式
        let fastPollConfig = {
            enableEarlyTermination: true,      // ✅ 提前終止
            enablePriorityFiltering: true,     // ✅ 優先級過濾
            maxRetries: 1,                     // 🚀 優化: 改為 1 次重試 (原 2 次)
            retryDelay: 500,                   // 🚀 優化: 重試間隔 500ms (原 1000ms)
            earlyTerminationThreshold: 0.8,    // ✅ 獲得 80% 資料後提前終止
            waitBeforeRead: 3000               // ✅ 發送讀取指令後等待時間（毫秒）0.5s~5s
        };

        // 🔍 診斷輪巡數據顯示問題
        window.diagnosePollingDisplay = function() {
            console.log('\n🔍 診斷輪巡數據顯示問題');
            console.log('='.repeat(80));
            
            // 檢查輪巡數據
            if (!window.dailyRecords) {
                console.error('❌ 沒有輪巡數據');
                return;
            }
            
            const records = Object.entries(window.dailyRecords);
            console.log(`📊 輪巡記錄總數: ${records.length}`);
            
            records.forEach(([key, record]) => {
                console.log(`\n📋 記錄: ${key}`);
                console.log(`   機台: ${record.machineId}/${record.location}`);
                console.log(`   投幣: ${record.plays} (原始: ${record.rawPlays}, 校正: +${record.playsCalibration})`);
                console.log(`   出貨: ${record.payouts} (原始: ${record.rawPayouts}, 校正: +${record.payoutsCalibration})`);
                console.log(`   更新次數: ${record.updateCount}`);
                console.log(`   是否輪巡記錄: ${record.isPollingRecord}`);
            });
            
            // 檢查機台配置映射
            console.log('\n🔍 檢查機台配置映射:');
            buildMachineConfigMap();
            console.log(`📊 映射表總數: ${Object.keys(window.machineConfigMap || {}).length}`);
            
            // 列出所有映射
            Object.entries(window.machineConfigMap || {}).forEach(([key, config]) => {
                console.log(`   ${key} → ${config.machineId}/${config.location}`);
            });
            
            // 檢查最新的機台數據
            console.log('\n🔍 檢查按DevID儲存的數據:');
            if (window.machineDataByDevid) {
                Object.entries(window.machineDataByDevid).forEach(([devid, data]) => {
                    console.log(`   DevID ${devid}: 投幣=${data.plays}, 出貨=${data.payouts}, 格式=${data.format}`);
                });
            } else {
                console.log('   ❌ 沒有按DevID儲存的數據');
            }
            
            console.log('='.repeat(80));
        };
        
        // 🧪 測試修復後的校正計算
        window.testFixedCalibration = function(machineId = 'A-112', location = '3', rawPlays = 65, rawPayouts = -2) {
            console.log('\n🧪 測試修復後的校正計算');
            console.log(`🎯 測試機台: ${machineId}/${location}`);
            console.log(`📊 模擬原始值: plays=${rawPlays}, payouts=${rawPayouts}`);
            
            // 直接調用 updateDailyRecord
            const result = updateDailyRecord(machineId, location, rawPlays, rawPayouts);
            
            console.log(`✅ 更新結果:`, result.status);
            console.log(`📋 記錄內容:`);
            console.log(`   原始投幣: ${result.record.rawPlays}`);
            console.log(`   原始出貨: ${result.record.rawPayouts}`);
            console.log(`   校正值: 投幣+${result.record.playsCalibration}, 出貨+${result.record.payoutsCalibration}`);
            console.log(`   顯示投幣: ${result.record.plays}`);
            console.log(`   顯示出貨: ${result.record.payouts}`);
            
            // 刷新表格
            refreshAutoRecordTable();
            
            return result;
        };

        // ============================================
        // 🚀 優化版輪詢: 並行處理所有機台
        // ============================================
        async function pollAllMachinesParallel(limitCount = null) {
            console.log('\n' + '='.repeat(70));
            console.log('🚀 開始 HTTP 並行輪詢 (優化版) - 所有機台同時處理');
            if (limitCount) {
                console.log(`🧪 測試模式: 只處理前 ${limitCount} 台機台`);
            }
            console.log('='.repeat(70));
            
            const currentProtocol = window.location.protocol;
            const isHttps = currentProtocol === 'https:';
            
            if (!appData.machines || appData.machines.length === 0) {
                alert('沒有機台可以輪詢');
                return;
            }

            let machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
            
            if (limitCount && limitCount > 0) {
                machinesWithMac = machinesWithMac.slice(0, limitCount);
            }
            
            if (machinesWithMac.length === 0) {
                alert('沒有設定 MAC 位址的機台');
                return;
            }
            
            console.log(`\n📋 準備並行處理 ${machinesWithMac.length} 台機台\n`);
            showStatusMessage(`開始並行輪詢 ${machinesWithMac.length} 台機台...`, 'info');
            
            const pollStartTime = Date.now();
            let sendSuccessCount = 0;
            let fetchSuccessCount = 0;

            // ============================================
            // 階段1: 並行發送所有讀取指令
            // ============================================
            if (!isHttps) {
                console.log('⚡ 階段1: 並行發送所有讀取指令\n');
                
                const sendPromises = machinesWithMac.map(async (machine, idx) => {
                    const devid = machine.devid || 1;
                    const url = `http://update.feiloli.com.tw:5539/webReadCmd/${machine.mac}/${devid}/`;
                    
                    try {
                        await fetch(url, { method: 'GET', mode: 'cors' });
                        sendSuccessCount++;
                        console.log(`✅ [${idx+1}] 指令已發送: ${machine.id}`);
                        return true;
                    } catch (e) {
                        // CORS錯誤是預期的
                        sendSuccessCount++;
                        return true;
                    }
                });
                
                await Promise.all(sendPromises);
                console.log(`\n✅ 階段1完成: ${sendSuccessCount}個指令已發送\n`);
            }
            
            // ============================================
            // 階段2: 統一等待
            // ============================================
            const waitTime = isHttps ? 300 : 1200;
            console.log(`⏳ 階段2: 等待 ${waitTime/1000}秒 讓機台準備數據...`);
            await new Promise(resolve => setTimeout(resolve, waitTime));
            console.log(`✅ 等待完成\n`);
            
            // ============================================
            // 階段3: 並行讀取所有數據 (優化: 相同MAC只讀一次)
            // ============================================
            console.log('📥 階段3: 並行讀取所有機台數據\n');
            
            // 🚀 優化: 按 MAC 分組,每個 MAC 只讀取一次
            const macGroups = {};
            machinesWithMac.forEach(machine => {
                if (!macGroups[machine.mac]) {
                    macGroups[machine.mac] = [];
                }
                macGroups[machine.mac].push(machine);
            });
            
            console.log(`🔍 檢測到 ${Object.keys(macGroups).length} 個唯一 MAC (共 ${machinesWithMac.length} 台機台)`);
            Object.entries(macGroups).forEach(([mac, machines]) => {
                const devids = machines.map(m => m.devid || 1).join(', ');
                console.log(`   MAC ${mac}: ${machines.length} 台機台 (devid: ${devids})`);
            });
            console.log('');
            
            // 🚀 並行讀取每個 MAC (而不是每台機台)
            const fetchPromises = Object.entries(macGroups).map(async ([mac, machines], idx) => {
                try {
                    // 每個 MAC 只讀取一次 (不指定 devid,讀取完整數據)
                    const result = await fetchWithRetry(mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, null);
                    
                    if (result && validateMachineData(result)) {
                        // 為每個 devid 處理數據
                        machines.forEach(machine => {
                            const devid = machine.devid || 1;
                            handleHttpResponse(result, mac, devid);
                            fetchSuccessCount++;
                            console.log(`✅ [MAC ${idx+1}] ${machine.id} (devid ${devid})`);
                        });
                        return { success: true, mac, machines };
                    } else {
                        console.warn(`❌ [MAC ${idx+1}] 讀取失敗: ${mac}`);
                        return { success: false, mac, machines };
                    }
                } catch (error) {
                    console.error(`❌ [MAC ${idx+1}] 異常: ${mac} - ${error.message}`);
                    return { success: false, mac, machines, error };
                }
            });
            
            await Promise.all(fetchPromises);
            
            // ============================================
            // 統計結果
            // ============================================
            const pollDuration = ((Date.now() - pollStartTime) / 1000).toFixed(1);
            const avgTime = (pollDuration / machinesWithMac.length).toFixed(2);
            
            const summaryMsg = `
✅ 並行輪詢完成！
════════════════════════════════
📊 機台總數: ${machinesWithMac.length}
✅ 讀取成功: ${fetchSuccessCount}
⏱️  總耗時: ${pollDuration}秒
⚡ 平均每台: ${avgTime}秒
🚀 效率提升: ${isHttps ? '約3倍' : '約10倍以上'}
════════════════════════════════
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
        }

        // 輪詢所有機台 (HTTP 版本) - 循序處理版本
        async function pollAllMachines(limitCount = null) {
            console.log('\n' + '='.repeat(70));
            console.log('🚀 開始 HTTP 循序輪詢 - 每台機台獨立處理');
            if (limitCount) {
                console.log(`🧪 測試模式: 只處理前 ${limitCount} 台機台`);
            }
            console.log('='.repeat(70));
            
            // 環境偵測
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\n🔍 環境詳細檢查:`);
            console.log(`   協議: ${currentProtocol}`);
            console.log(`   主機: ${currentHostname}`);
            console.log(`   是否 HTTPS: ${isHttps}`);
            console.log(`   是否 GitHub Pages: ${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`\n✅ HTTPS 環境確認: ${isGitHubPages ? '(GitHub Pages)' : '(其他 HTTPS 服務)'}`);
                console.log('📋 HTTPS 環境說明: 將跳過讀取指令，直接使用 CORS 代理讀取數據');
            } else {
                console.log(`\n✅ HTTP 環境確認: 使用完整功能（讀取指令 + 數據讀取）`);
            }

            if (!appData.machines || appData.machines.length === 0) {
                alert('沒有機台可以輪詢');
                return;
            }

            let machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
            
            // 🧪 如果指定了限制數量,只取前 N 台
            if (limitCount && limitCount > 0) {
                machinesWithMac = machinesWithMac.slice(0, limitCount);
                console.log(`\n🧪 測試模式: 從 ${appData.machines.length} 台機台中選取前 ${machinesWithMac.length} 台`);
            }
            
            if (machinesWithMac.length === 0) {
                alert('沒有設定 MAC 位址的機台');
                return;
            }
            
            console.log('\n📋 輪詢機台清單:');
            machinesWithMac.forEach((machine, index) => {
                console.log(`   ${index + 1}. 機台ID: ${machine.id}, MAC: ${machine.mac}, DevID: ${machine.devid || 1}`);
            });
            
            // 檢查機台配置映射
            console.log('\n🔍 檢查機台配置映射:');
            buildMachineConfigMap();
            console.log('📊 可用的映射鍵:', Object.keys(window.machineConfigMap));
            
            // 預測每台機台的映射鍵
            console.log('\n🎯 預測機台映射:');
            machinesWithMac.forEach((machine, index) => {
                const devid = machine.devid || 1;
                const expectedKey = `${machine.mac}_${devid}`;
                const hasMapping = !!window.machineConfigMap[expectedKey];
                console.log(`   ${index + 1}. ${machine.id}: ${expectedKey} ${hasMapping ? '✅' : '❌'} ${hasMapping ? '(有映射)' : '(無映射)'}`);
            });

            showStatusMessage(`開始循序輪詢 ${machinesWithMac.length} 台機台...`, 'info');
            
            const pollStartTime = new Date();
            let pollCount = 0;
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;

            // ============================================
            // 📌 循序處理：每台機台獨立執行「發送指令 → 等待1秒 → 讀取資料 → 等待0.5秒」
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('� 開始循序處理每台機台');
            console.log('   流程: 發送指令 → 等待1秒 → 讀取資料 → 等待0.5秒 → 下一台');
            console.log('='.repeat(70));
            
            for (let i = 0; i < machinesWithMac.length; i++) {
                const machine = machinesWithMac[i];
                const devid = machine.devid || 1;
                
                console.log(`\n${'─'.repeat(60)}`);
                console.log(`� [${i + 1}/${machinesWithMac.length}] 處理機台: ${machine.id} (MAC: ${machine.mac})`);
                console.log(`${'─'.repeat(60)}`);
                
                try {
                    // ============================================
                    // 步驟 1: 發送讀取指令（僅限 HTTP 環境）
                    // ============================================
                    if (!isHttps) {
                        const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${machine.mac}/${devid}/`;
                        
                        try {
                            console.log(`📤 [步驟1] 發送讀取指令...`);
                            console.log(`   URL: ${readCmdUrl}`);
                            
                            const readCmdResponse = await fetch(readCmdUrl, {
                                method: 'GET',
                                mode: 'cors',
                                headers: { 'Accept': 'application/json' }
                            });
                            
                            if (readCmdResponse.ok) {
                                const readCmdData = await readCmdResponse.json();
                                console.log(`   ✅ 指令發送成功: ${readCmdData.ResultMessage || 'OK'}`);
                            } else {
                                console.warn(`   ⚠️ 指令發送失敗: HTTP ${readCmdResponse.status}`);
                            }
                        } catch (readCmdError) {
                            // CORS 錯誤是預期的，但指令可能已經到達伺服器
                            if (readCmdError.message.includes('CORS') || readCmdError.message.includes('Failed to fetch')) {
                                console.log(`   ⚠️ CORS 限制阻擋回應，但指令可能已發送 (${readCmdError.message})`);
                                console.log(`   💡 這是正常現象，會繼續讀取數據...`);
                            } else {
                                console.warn(`   ⚠️ 指令發送異常: ${readCmdError.message}`);
                            }
                        }
                        
                        // ============================================
                        // 步驟 2: 🚀 優化等待時間 0.5 秒 (原 1 秒)
                        // ============================================
                        console.log(`⏳ [步驟2] 等待 0.5 秒，讓機台準備數據... (優化後)`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        console.log(`   ✅ 等待完成`);
                        
                    } else {
                        // HTTPS 環境：跳過指令發送，但仍等待一下
                        console.log(`🔒 HTTPS 環境: 跳過讀取指令`);
                        console.log(`⏳ 等待 0.3 秒後讀取...`);
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    // ============================================
                    // 步驟 3: 讀取資料並解析
                    // ============================================
                    console.log(`📥 [步驟3] 開始讀取資料...`);
                    
                    const result = await fetchWithRetry(machine.mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, devid);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   ✅ 資料讀取成功 (已驗證)`);
                        
                        // 優先級過濾
                        if (fastPollConfig.enablePriorityFiltering) {
                            const hasTargetData = quickCheckForTargetData(result, devid);
                            if (!hasTargetData) {
                                console.log(`   ⚠️ [優先級過濾] 不包含目標資料，跳過處理`);
                                console.log(`   🔍 [調試] 機台 ${machine.id} (MAC: ${machine.mac}, DevID: ${devid}) 數據不符合優先級過濾條件`);
                                console.log(`   📊 [調試] 回應數據類型: ${typeof result}, 長度: ${Array.isArray(result) ? result.length : 'N/A'}`);
                                if (Array.isArray(result) && result.length > 0) {
                                    console.log(`   📋 [調試] 前3筆記錄預覽:`, result.slice(0, 3).map(r => ({date: r.date, type: r.type, hasData: !!r.data})));
                                }
                            } else {
                                console.log(`   ✅ [優先級過濾] 包含目標資料，進行處理`);
                                handleHttpResponse(result, machine.mac, devid);
                                addCommandLog('receive', `HTTP 回應成功 - MAC: ${machine.mac}`, result);
                                fetchSuccessCount++;
                                targetDataReceived++;
                            }
                        } else {
                            handleHttpResponse(result, machine.mac, devid);
                            addCommandLog('receive', `HTTP 回應成功 - MAC: ${machine.mac}`, result);
                            fetchSuccessCount++;
                            targetDataReceived++;
                        }
                    } else {
                        console.warn(`   ❌ 資料讀取失敗 (數據驗證失敗或無效)`);
                        console.log(`   🔍 [調試] 機台 ${machine.id} (MAC: ${machine.mac}, DevID: ${devid}) 讀取失敗詳情:`);
                        console.log(`   📊 [調試] result 是否存在: ${!!result}`);
                        console.log(`   📊 [調試] result 類型: ${typeof result}`);
                        console.log(`   📊 [調試] validateMachineData 結果: ${result ? validateMachineData(result) : 'N/A'}`);
                        if (result) {
                            console.log(`   📋 [調試] result 內容預覽:`, JSON.stringify(result).substring(0, 200) + '...');
                        }
                        addCommandLog('error', `數據讀取失敗或無效 - MAC: ${machine.mac}`);
                    }
                    
                    pollCount++;
                    
                    // ============================================
                    // 步驟 4: 🚀 優化等待時間 0.2 秒 (原 0.5 秒)
                    // ============================================
                    if (i < machinesWithMac.length - 1) { // 如果不是最後一台
                        console.log(`⏳ [步驟4] 等待 0.2 秒後處理下一台... (優化後)`);
                        await new Promise(resolve => setTimeout(resolve, 200));
                        console.log(`   ✅ 準備處理下一台機台`);
                    } else {
                        console.log(`🏁 已是最後一台，不需等待`);
                    }
                    
                } catch (error) {
                    console.error(`❌ 處理機台時發生異常: ${error.message}`);
                    addCommandLog('error', `HTTP 處理異常: ${error.message}`);
                    pollCount++;
                    
                    // 發生錯誤時也等待 0.2 秒再繼續 (優化)
                    if (i < machinesWithMac.length - 1) {
                        console.log(`⏳ 錯誤後等待 0.2 秒再繼續... (優化後)`);
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            }

            // ============================================
            // 📊 統計輪詢結果
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('📊 循序輪詢統計結果');
            console.log('='.repeat(70));
            
            let updateCount = 0;
            let unchangedCount = 0;
            
            if (window.dailyRecords) {
                Object.values(window.dailyRecords).forEach(record => {
                    if (record.updateCount > 1) {
                        updateCount++;
                    } else {
                        unchangedCount++;
                    }
                });
            }
            
            const pollEndTime = new Date();
            const pollDuration = ((pollEndTime - pollStartTime) / 1000).toFixed(1);
            const avgTimePerMachine = (pollDuration / pollCount).toFixed(2);

            const summaryMsg = `
✅ 循序輪詢完成！
═══════════════════════════════════
📊 輪詢結果:
  • 機台總數: ${machinesWithMac.length} 台
  • 實際處理: ${pollCount} 台
  • 完整輪詢: ✓ 所有機台完成
  • 成功率: ${fetchSuccessCount}/${pollCount} (${Math.round(fetchSuccessCount/pollCount*100)}%)
  
📈 資料統計:
  • 目標資料: ${targetDataReceived} 筆
  • 新增記錄: ${unchangedCount} 筆
  • 更新記錄: ${updateCount} 筆

⏱️ 時間統計:
  • 總耗時: ${pollDuration} 秒
  • 平均每台: ${avgTimePerMachine} 秒
  
🔧 處理流程:
  • 發送指令後等待: 1 秒
  • 每台機台間隔: 0.5 秒
  • 重試次數: ${fastPollConfig.maxRetries} 次
  • 重試間隔: ${fastPollConfig.retryDelay}ms
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // 運行輪詢後診斷
            setTimeout(() => {
                console.log('\n🔍 執行輪詢後連線診斷...');
                debugMachineConnectivity();
            }, 1000);
        }

        // ============================================
        // 🚀 批次輪詢模式：先發送所有查詢，等2秒後統一讀取
        // ============================================
        async function pollAllMachinesBatch() {
            console.log('\n' + '='.repeat(70));
            console.log('🚀 開始 HTTP 批次輪詢 - 先發送所有查詢，等待2秒後統一讀取');
            console.log('='.repeat(70));
            
            // 環境偵測
            const currentProtocol = window.location.protocol;
            const currentHostname = window.location.hostname;
            const isHttps = currentProtocol === 'https:' || currentProtocol === 'https';
            const isGitHubPages = currentHostname.includes('github.io');
            
            console.log(`\n🔍 環境詳細檢查:`);
            console.log(`   協議: ${currentProtocol}`);
            console.log(`   主機: ${currentHostname}`);
            console.log(`   是否 HTTPS: ${isHttps}`);
            console.log(`   是否 GitHub Pages: ${isGitHubPages}`);
            
            if (isHttps) {
                console.log(`\n✅ HTTPS 環境確認: 將跳過發送階段，直接讀取`);
            } else {
                console.log(`\n✅ HTTP 環境確認: 將發送查詢指令後統一讀取`);
            }

            if (!appData.machines || appData.machines.length === 0) {
                alert('沒有機台可以輪詢');
                return;
            }

            // 取得唯一的 MAC 位址列表（每個 MAC 只處理一次）
            const uniqueMacs = [...new Set(appData.machines
                .filter(m => m.mac && m.mac.trim())
                .map(m => m.mac.trim()))];
            
            if (uniqueMacs.length === 0) {
                alert('沒有設定 MAC 位址的機台');
                return;
            }
            
            console.log('\n📋 批次輪詢 MAC 清單（每個 MAC 只讀取一次）:');
            uniqueMacs.forEach((mac, index) => {
                const machinesWithThisMac = appData.machines.filter(m => m.mac === mac);
                console.log(`   ${index + 1}. MAC: ${mac}`);
                machinesWithThisMac.forEach(m => {
                    console.log(`      - 機台: ${m.id} / ${m.location}, DevID: ${m.devid || 1}`);
                });
            });
            
            // 檢查機台配置映射
            console.log('\n🔍 檢查機台配置映射:');
            buildMachineConfigMap();
            console.log('📊 可用的映射鍵:', Object.keys(window.machineConfigMap));

            showStatusMessage(`開始批次輪詢 ${uniqueMacs.length} 個 MAC 位址...`, 'info');
            
            const pollStartTime = new Date();
            let sendSuccessCount = 0;
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;

            // ============================================
            // 階段 1: 發送所有查詢指令（僅 HTTP 環境）
            // ============================================
            if (!isHttps) {
                console.log('\n' + '='.repeat(70));
                console.log('📤 階段 1: 發送所有查詢指令');
                console.log('='.repeat(70));
                
                for (let i = 0; i < uniqueMacs.length; i++) {
                    const mac = uniqueMacs[i];
                    
                    // 為每個 MAC 發送 devid=1 和 devid=2 的查詢
                    for (let devid = 1; devid <= 2; devid++) {
                        const readCmdUrl = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                        
                        try {
                            console.log(`📤 [${i + 1}/${uniqueMacs.length}] 發送查詢: MAC=${mac}, DevID=${devid}`);
                            
                            const readCmdResponse = await fetch(readCmdUrl, {
                                method: 'GET',
                                mode: 'cors',
                                headers: { 'Accept': 'application/json' }
                            });
                            
                            if (readCmdResponse.ok) {
                                const readCmdData = await readCmdResponse.json();
                                console.log(`   ✅ 查詢發送成功: ${readCmdData.ResultMessage || 'OK'}`);
                                sendSuccessCount++;
                            } else {
                                console.warn(`   ⚠️ 查詢發送失敗: HTTP ${readCmdResponse.status}`);
                            }
                        } catch (readCmdError) {
                            // CORS 錯誤是預期的
                            if (readCmdError.message.includes('CORS') || readCmdError.message.includes('Failed to fetch')) {
                                console.log(`   ⚠️ CORS 限制（預期），查詢可能已發送`);
                                sendSuccessCount++;
                            } else {
                                console.warn(`   ⚠️ 查詢發送異常: ${readCmdError.message}`);
                            }
                        }
                        
                        // 避免發送過快，每次間隔 50ms
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                
                console.log(`\n✅ 所有查詢指令已發送 (成功: ${sendSuccessCount}/${uniqueMacs.length * 2})`);
            }
            
            // ============================================
            // 階段 2: 等待機台準備數據 (確保讀取最新數據)
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('⏳ 階段 2: 等待 2 秒，讓所有機台準備數據...');
            console.log('   💡 提示: 機台需要時間準備新數據，避免讀到舊緩存');
            console.log('='.repeat(70));
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            console.log('✅ 等待完成，開始並行讀取數據\n');
            
            // ============================================
            // 階段 3: 並行讀取所有 MAC 的數據 (⚡ 速度優化)
            // ============================================
            console.log('='.repeat(70));
            console.log('📥 階段 3: 並行讀取所有 MAC 的數據 (⚡ 加速模式)');
            console.log('='.repeat(70));
            
            // 🚀 並行讀取所有機器 (而非循序等待)
            const fetchPromises = uniqueMacs.map(async (mac, index) => {
                console.log(`\n${'─'.repeat(60)}`);
                console.log(`📥 [${index + 1}/${uniqueMacs.length}] 開始讀取 MAC: ${mac}`);
                console.log(`${'─'.repeat(60)}`);
                
                try {
                    const result = await fetchWithRetry(mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, null);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   ✅ [${index + 1}] 資料讀取成功 - MAC: ${mac}`);
                        console.log(`   📊 數據類型: ${Array.isArray(result) ? `陣列 (${result.length} 筆)` : typeof result}`);
                        
                        // 🔍 檢查數據新鮮度 - 如果數據過期,自動重試一次
                        let dataIsStale = false;
                        if (Array.isArray(result) && result.length > 0) {
                            // 檢查最新記錄的時間
                            for (const record of result.slice(0, 10)) { // 只檢查前 10 筆
                                if (record.data && typeof record.data === 'string') {
                                    try {
                                        const parsed = JSON.parse(record.data);
                                        if (parsed.cmd === 're_readdata' && record.date) {
                                            const dateStr = record.date.replace(' ', 'T');
                                            const recordTime = new Date(dateStr).getTime();
                                            const now = Date.now();
                                            const age = now - recordTime;
                                            
                                            if (age > 60000) { // 超過 60 秒
                                                console.warn(`   ⚠️ 檢測到過期數據: ${record.date} (距今 ${Math.floor(age/1000)} 秒)`);
                                                dataIsStale = true;
                                            }
                                            break; // 只檢查第一筆有效記錄
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        
                        // 🔄 如果數據過期,自動重試
                        if (dataIsStale) {
                            console.warn(`   🔄 數據過期，自動重試讀取 MAC: ${mac}...`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 等待 1 秒
                            
                            const retryResult = await fetchWithRetry(mac, 2, 500, null);
                            if (retryResult && validateMachineData(retryResult)) {
                                console.log(`   ✅ 重試成功! 使用新數據`);
                                handleHttpResponse(retryResult, mac, null);
                                addCommandLog('receive', `批次讀取成功 (重試) - MAC: ${mac}`, retryResult);
                            } else {
                                console.warn(`   ⚠️ 重試失敗，使用原數據`);
                                handleHttpResponse(result, mac, null);
                                addCommandLog('receive', `批次讀取成功 (使用舊數據) - MAC: ${mac}`, result);
                            }
                        } else {
                            // 處理回應數據（內部會自動解析 devid=1 和 devid=2）
                            handleHttpResponse(result, mac, null);
                            addCommandLog('receive', `批次讀取成功 - MAC: ${mac}`, result);
                        }
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`   ❌ [${index + 1}] 資料讀取失敗 - MAC: ${mac}`);
                        addCommandLog('error', `批次讀取失敗 - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`❌ [${index + 1}] 讀取 MAC ${mac} 時發生異常: ${error.message}`);
                    addCommandLog('error', `批次讀取異常: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // 等待所有讀取完成
            console.log(`\n⏳ 等待所有 ${uniqueMacs.length} 台機器完成讀取...`);
            const results = await Promise.all(fetchPromises);
            
            // 統計並行讀取結果
            const successCount = results.filter(r => r.success).length;
            console.log(`\n✅ 並行讀取完成: ${successCount}/${uniqueMacs.length} 成功`);

            // ============================================
            // 📊 統計輪詢結果
            // ============================================
            console.log('\n' + '='.repeat(70));
            console.log('📊 批次輪詢統計結果');
            console.log('='.repeat(70));
            
            let updateCount = 0;
            let unchangedCount = 0;
            
            if (window.dailyRecords) {
                Object.values(window.dailyRecords).forEach(record => {
                    if (record.updateCount > 1) {
                        updateCount++;
                    } else {
                        unchangedCount++;
                    }
                });
            }
            
            const pollEndTime = new Date();
            const pollDuration = ((pollEndTime - pollStartTime) / 1000).toFixed(1);
            const avgTimePerMac = (pollDuration / uniqueMacs.length).toFixed(2);

            const summaryMsg = `
✅ 批次輪詢完成！
═══════════════════════════════════
📊 輪詢結果:
  • MAC 總數: ${uniqueMacs.length} 個
  • 查詢發送: ${sendSuccessCount}/${uniqueMacs.length * 2} (DevID 1+2)
  • 數據讀取: ${fetchSuccessCount}/${uniqueMacs.length}
  • 成功率: ${Math.round(fetchSuccessCount/uniqueMacs.length*100)}%
  
📈 資料統計:
  • 目標資料: ${targetDataReceived} 個 MAC
  • 新增記錄: ${unchangedCount} 筆
  • 更新記錄: ${updateCount} 筆

⏱️ 時間統計:
  • 總耗時: ${pollDuration} 秒
  • 平均每 MAC: ${avgTimePerMac} 秒
  • 等待時間: 2 秒
  
🔧 處理流程:
  • 階段1: 發送所有查詢 (${sendSuccessCount} 個)
  • 階段2: 等待 2 秒
  • 階段3: 統一讀取 (${fetchSuccessCount} 個)
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // 運行輪詢後診斷
            setTimeout(() => {
                console.log('\n🔍 執行輪詢後連線診斷...');
                debugMachineConnectivity();
            }, 1000);
        }

        // ============================================
        // 輪詢模式選擇器
        // ============================================
        async function executePollAllMachines(limitCount = null) {
            const pollMode = document.getElementById('http-poll-mode')?.value || 'parallel';
            
            console.log(`\n🎯 選擇的輪詢模式: ${pollMode === 'parallel' ? '並行模式 (優化)' : pollMode === 'batch' ? '批次模式' : '循序模式'}`);
            if (limitCount) {
                console.log(`🧪 測試模式: 只處理前 ${limitCount} 組`);
            }
            
            if (pollMode === 'parallel') {
                await pollAllMachinesParallel(limitCount);
            } else if (pollMode === 'batch') {
                await pollAllMachinesBatch(limitCount);
            } else {
                await pollAllMachines(limitCount);
            }
        }

        // ============================================
        // ⚡ 快速讀取模式 (跳過發送查詢,直接讀取)
        // ============================================
        async function quickReadAllMachines(limitCount = null) {
            console.log('\n' + '='.repeat(70));
            console.log('⚡ 快速讀取模式 (假設已在門市管理頁面發送查詢)');
            console.log('='.repeat(70));
            
            const startTime = Date.now();
            
            // 獲取當前門市的所有機台
            if (!appData.machines || appData.machines.length === 0) {
                showStatusMessage('❌ 當前門市沒有可輪詢的機台', 'error');
                return;
            }
            
            // 收集所有唯一的 MAC 地址
            const uniqueMacs = [...new Set(appData.machines
                .filter(machine => machine.mac && machine.mac.trim() !== '')
                .map(machine => machine.mac))];
            
            // 套用限制
            let targetMacs = uniqueMacs;
            if (limitCount && limitCount > 0) {
                targetMacs = uniqueMacs.slice(0, limitCount);
                console.log(`🧪 測試模式: 只讀取前 ${targetMacs.length}/${uniqueMacs.length} 台機器`);
            }
            
            console.log(`📋 準備讀取 ${targetMacs.length} 台機器: ${targetMacs.join(', ')}\n`);
            
            // ============================================
            // 🕐 智能等待機制 (確保讀取到最新數據)
            // ============================================
            console.log('⏳ 等待 0.8 秒確保讀取最新數據...');
            await new Promise(resolve => setTimeout(resolve, 800));
            console.log('✅ 等待完成，開始讀取\n');
            
            let fetchSuccessCount = 0;
            let targetDataReceived = 0;
            
            // ============================================
            // ⚡ 並行讀取所有 MAC 的數據
            // ============================================
            console.log('='.repeat(70));
            console.log('📥 並行讀取所有 MAC 的數據 (⚡ 加速模式)');
            console.log('='.repeat(70));
            
            const fetchPromises = targetMacs.map(async (mac, index) => {
                console.log(`\n${'─'.repeat(60)}`);
                console.log(`📥 [${index + 1}/${targetMacs.length}] 開始讀取 MAC: ${mac}`);
                console.log(`${'─'.repeat(60)}`);
                
                try {
                    const result = await fetchWithRetry(mac, fastPollConfig.maxRetries, fastPollConfig.retryDelay, null);
                    
                    if (result && validateMachineData(result)) {
                        console.log(`   ✅ [${index + 1}] 資料讀取成功 - MAC: ${mac}`);
                        console.log(`   📊 數據類型: ${Array.isArray(result) ? `陣列 (${result.length} 筆)` : typeof result}`);
                        
                        // 🔍 檢查數據新鮮度 - 如果數據過期,自動重試一次
                        let dataIsStale = false;
                        if (Array.isArray(result) && result.length > 0) {
                            // 檢查最新記錄的時間
                            for (const record of result.slice(0, 10)) { // 只檢查前 10 筆
                                if (record.data && typeof record.data === 'string') {
                                    try {
                                        const parsed = JSON.parse(record.data);
                                        if (parsed.cmd === 're_readdata' && record.date) {
                                            const dateStr = record.date.replace(' ', 'T');
                                            const recordTime = new Date(dateStr).getTime();
                                            const now = Date.now();
                                            const age = now - recordTime;
                                            
                                            if (age > 60000) { // 超過 60 秒
                                                console.warn(`   ⚠️ 檢測到過期數據: ${record.date} (距今 ${Math.floor(age/1000)} 秒)`);
                                                dataIsStale = true;
                                            }
                                            break; // 只檢查第一筆有效記錄
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                        
                        // 🔄 如果數據過期,自動重試
                        if (dataIsStale) {
                            console.warn(`   🔄 數據過期，自動重試讀取 MAC: ${mac}...`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 等待 1 秒
                            
                            const retryResult = await fetchWithRetry(mac, 2, 500, null);
                            if (retryResult && validateMachineData(retryResult)) {
                                console.log(`   ✅ 重試成功! 使用新數據`);
                                handleHttpResponse(retryResult, mac, null);
                                addCommandLog('receive', `快速讀取成功 (重試) - MAC: ${mac}`, retryResult);
                            } else {
                                console.warn(`   ⚠️ 重試失敗，使用原數據`);
                                handleHttpResponse(result, mac, null);
                                addCommandLog('receive', `快速讀取成功 (使用舊數據) - MAC: ${mac}`, result);
                            }
                        } else {
                            handleHttpResponse(result, mac, null);
                            addCommandLog('receive', `快速讀取成功 - MAC: ${mac}`, result);
                        }
                        
                        fetchSuccessCount++;
                        targetDataReceived++;
                        
                        return { mac, success: true };
                    } else {
                        console.warn(`   ❌ [${index + 1}] 資料讀取失敗 - MAC: ${mac}`);
                        addCommandLog('error', `快速讀取失敗 - MAC: ${mac}`);
                        return { mac, success: false };
                    }
                    
                } catch (error) {
                    console.error(`❌ [${index + 1}] 讀取 MAC ${mac} 時發生異常: ${error.message}`);
                    addCommandLog('error', `快速讀取異常: ${error.message}`);
                    return { mac, success: false, error: error.message };
                }
            });
            
            // 等待所有讀取完成
            console.log(`\n⏳ 等待所有 ${targetMacs.length} 台機器完成讀取...`);
            const results = await Promise.all(fetchPromises);
            
            // 統計結果
            const successCount = results.filter(r => r.success).length;
            console.log(`\n✅ 並行讀取完成: ${successCount}/${targetMacs.length} 成功`);
            
            // ============================================
            // 📊 統計結果
            // ============================================
            const endTime = Date.now();
            const pollDuration = ((endTime - startTime) / 1000).toFixed(1);
            const avgTimePerMac = ((endTime - startTime) / targetMacs.length / 1000).toFixed(2);
            
            // 統計更新和新增記錄
            const recordOperations = window.dailyRecordOperations || [];
            const updateCount = recordOperations.filter(op => op === 'updated').length;
            const unchangedCount = recordOperations.filter(op => op === 'unchanged' || op === 'created').length;
            
            console.log('\n' + '='.repeat(70));
            console.log('📊 快速讀取統計結果');
            console.log('='.repeat(70));
            
            const summaryMsg = `
✅ 快速讀取完成！⚡
═══════════════════════════════════
📊 讀取結果:
  • MAC 總數: ${targetMacs.length} 個
  • 數據讀取: ${fetchSuccessCount}/${targetMacs.length}
  • 成功率: ${Math.round(fetchSuccessCount / targetMacs.length * 100)}%
  
📈 資料統計:
  • 讀取資料: ${targetDataReceived} 個 MAC
  • 新增記錄: ${unchangedCount} 筆
  • 更新記錄: ${updateCount} 筆

⏱️ 時間統計:
  • 總耗時: ${pollDuration} 秒 ⚡
  • 平均每 MAC: ${avgTimePerMac} 秒
  • 等待時間: 0.8 秒 (智能等待)
  
🔧 處理流程:
  • 跳過階段1: 發送查詢 ✓
  • 智能等待: 0.8秒確保新數據 ✓
  • 階段3: 並行讀取 (${fetchSuccessCount} 個)
            `;
            
            console.log(summaryMsg);
            showStatusMessage(summaryMsg, 'success');
            console.log('='.repeat(70) + '\n');
            
            // 刷新表格
            refreshAutoRecordTable();
        }

        // ============================================
        // 🚀 一鍵全自動更新所有門市 (完整流程)
        // ============================================
        async function autoUpdateAllStores() {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }

            // 確認操作
            const confirmMsg = '🚀 一鍵全自動更新所有門市\n\n' +
                '完整流程：\n' +
                '1️⃣ 發送所有門市讀取訊息\n' +
                '2️⃣ 等待完成後延遲 3 秒\n' +
                '3️⃣ 快速讀取所有門市資料 (第1次)\n' +
                '4️⃣ 完成後延遲 2 秒\n' +
                '5️⃣ 快速讀取所有門市資料 (第2次,確保最新)\n' +
                '6️⃣ 依序完成各門市批量自動記帳\n\n' +
                '⏱️ 預計耗時: 15-30 秒\n\n' +
                '確定要開始嗎？';
            
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('🚀 開始一鍵全自動更新所有門市');
            console.log('='.repeat(80));

            // 顯示大型進度提示框
            const progressDiv = document.createElement('div');
            progressDiv.id = 'auto-update-progress';
            progressDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            progressDiv.innerHTML = `
                <div class="bg-gradient-to-br from-blue-900 to-purple-900 text-white px-8 py-6 rounded-2xl shadow-2xl max-w-2xl w-full mx-4">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-bold text-2xl">🚀 一鍵全自動更新</span>
                    </div>
                    <div class="space-y-3">
                        <div id="auto-step-1" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>1️⃣ 發送所有門市讀取訊息</span>
                        </div>
                        <div id="auto-step-2" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>2️⃣ 等待 3 秒...</span>
                        </div>
                        <div id="auto-step-3" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>3️⃣ 快速讀取所有門市 (第1次)</span>
                        </div>
                        <div id="auto-step-4" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>4️⃣ 等待 2 秒...</span>
                        </div>
                        <div id="auto-step-5" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>5️⃣ 快速讀取所有門市 (第2次)</span>
                        </div>
                        <div id="auto-step-6" class="flex items-center gap-2 text-gray-300">
                            <span class="text-2xl">⏳</span>
                            <span>6️⃣ 批量自動記帳</span>
                        </div>
                    </div>
                    <div id="auto-progress-detail" class="mt-4 text-sm text-blue-200 bg-black bg-opacity-30 p-3 rounded">
                        準備中...
                    </div>
                </div>
            `;
            document.body.appendChild(progressDiv);

            const updateStep = (stepNum, status, emoji = '⏳') => {
                const stepEl = document.getElementById(`auto-step-${stepNum}`);
                if (stepEl) {
                    const emojiSpan = stepEl.querySelector('.text-2xl');
                    emojiSpan.textContent = emoji;
                    if (status === 'active') {
                        stepEl.className = 'flex items-center gap-2 text-white font-bold';
                    } else if (status === 'done') {
                        stepEl.className = 'flex items-center gap-2 text-green-400';
                    }
                }
            };

            const updateDetail = (text) => {
                const detailEl = document.getElementById('auto-progress-detail');
                if (detailEl) detailEl.textContent = text;
            };

            try {
                // ============================================
                // 步驟 1: 發送所有門市讀取訊息
                // ============================================
                updateStep(1, 'active', '🔄');
                updateDetail('正在發送所有門市的讀取查詢...');
                console.log('\n📤 步驟 1/6: 發送所有門市讀取訊息');

                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let totalSent = 0;
                for (const store of stores) {
                    const machinesSnapshot = await db.collection('groups')
                        .doc(selectedGroupId)
                        .collection('stores')
                        .doc(store.id)
                        .collection('machines')
                        .get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // 收集所有 mac/devid 組合
                    for (const machine of machines) {
                        const mac = machine.mac;
                        const devid = machine.devid || 1;
                        
                        if (!mac || mac.trim() === '') continue;
                        
                        const url = `http://update.feiloli.com.tw:5539/webReadCmd/${mac}/${devid}/`;
                        
                        try {
                            // 使用 XMLHttpRequest 直接發送 (與「立即輪巡所有門市」相同方式)
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.timeout = 5000;
                            
                            xhr.onload = function() {
                                console.log(`✅ 查詢已發送: ${mac}/${devid} (HTTP ${xhr.status})`);
                            };
                            
                            xhr.onerror = function() {
                                console.log(`✅ 查詢已發送: ${mac}/${devid} (CORS 可忽略)`);
                            };
                            
                            xhr.ontimeout = function() {
                                console.log(`✅ 查詢已發送: ${mac}/${devid} (可能離線)`);
                            };
                            
                            xhr.send();
                            totalSent++;
                            
                            // 稍微延遲避免太快
                            await new Promise(resolve => setTimeout(resolve, 50));
                            
                        } catch (error) {
                            console.warn(`⚠️ 發送失敗: ${mac}/${devid}`, error);
                        }
                    }
                }
                
                updateStep(1, 'done', '✅');
                updateDetail(`已發送 ${totalSent} 個查詢訊息`);
                console.log(`✅ 步驟 1 完成: 已發送 ${totalSent} 個查詢`);

                // ============================================
                // 步驟 2: 等待 3 秒
                // ============================================
                updateStep(2, 'active', '⏰');
                console.log('\n⏳ 步驟 2/6: 等待 3 秒讓機器準備數據...');
                
                for (let i = 3; i > 0; i--) {
                    updateDetail(`等待機器準備數據... ${i} 秒`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateStep(2, 'done', '✅');
                updateDetail('等待完成');
                console.log('✅ 步驟 2 完成: 等待時間結束');

                // ============================================
                // 步驟 3: 第一次快速讀取
                // ============================================
                updateStep(3, 'active', '📖');
                updateDetail('正在進行第1次快速讀取...');
                console.log('\n📖 步驟 3/6: 第1次快速讀取所有門市資料');
                
                await quickReadAllStoresData(updateDetail);
                
                updateStep(3, 'done', '✅');
                updateDetail('第1次讀取完成');
                console.log('✅ 步驟 3 完成: 第1次讀取完成');

                // ============================================
                // 步驟 4: 等待 2 秒
                // ============================================
                updateStep(4, 'active', '⏰');
                console.log('\n⏳ 步驟 4/6: 等待 2 秒...');
                
                for (let i = 2; i > 0; i--) {
                    updateDetail(`等待確保最新數據... ${i} 秒`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateStep(4, 'done', '✅');
                updateDetail('等待完成');
                console.log('✅ 步驟 4 完成: 等待時間結束');

                // ============================================
                // 步驟 5: 第二次快速讀取 (確保最新)
                // ============================================
                updateStep(5, 'active', '📖');
                updateDetail('正在進行第2次快速讀取 (確保最新數據)...');
                console.log('\n📖 步驟 5/6: 第2次快速讀取所有門市資料');
                
                await quickReadAllStoresData(updateDetail);
                
                updateStep(5, 'done', '✅');
                updateDetail('第2次讀取完成');
                console.log('✅ 步驟 5 完成: 第2次讀取完成');

                // ============================================
                // 步驟 6: 批量自動記帳
                // ============================================
                updateStep(6, 'active', '💾');
                updateDetail('正在批量自動記帳...');
                console.log('\n💾 步驟 6/6: 批量自動記帳');
                console.log('📊 檢查 dailyRecords:', window.dailyRecords);
                
                let savedCount = 0;
                let skippedCount = 0;
                const today = new Date().toISOString().split('T')[0];
                
                for (const store of stores) {
                    updateDetail(`正在處理門市: ${store.name}...`);
                    console.log(`\n🏪 處理門市: ${store.name}`);
                    
                    try {
                        const machinesSnapshot = await db.collection('groups')
                            .doc(selectedGroupId)
                            .collection('stores')
                            .doc(store.id)
                            .collection('machines')
                            .get();
                        
                        const machines = machinesSnapshot.docs.map(doc => ({ 
                            docId: doc.id, 
                            ...doc.data() 
                        }));
                        
                        console.log(`   機台數: ${machines.length}`);
                        
                        for (const machine of machines) {
                            // 使用 mac 和 devid 來查找機台配置
                            const mac = machine.mac;
                            const devid = machine.devid || 1;
                            const machineConfig = findMachineConfig(mac, devid);
                            
                            if (!machineConfig) {
                                skippedCount++;
                                console.log(`   ⚠️ 找不到機台配置: mac=${mac}, devid=${devid}`);
                                continue;
                            }
                            
                            // 從 dailyRecords 查找今天的數據
                            const recordKey = `${machineConfig.machineId}_${machineConfig.location}_${today}`;
                            const dailyRecord = window.dailyRecords?.[recordKey];
                            
                            if (dailyRecord && dailyRecord.plays !== undefined && dailyRecord.payouts !== undefined) {
                                console.log(`   ✅ 找到數據: ${recordKey}`, { plays: dailyRecord.plays, payouts: dailyRecord.payouts });
                                
                                try {
                                    await db.collection('groups')
                                        .doc(selectedGroupId)
                                        .collection('stores')
                                        .doc(store.id)
                                        .collection('machines')
                                        .doc(machine.docId)
                                        .collection('daily_records')
                                        .doc(today)
                                        .set({
                                            date: today,
                                            cumulativePlays: dailyRecord.plays,
                                            cumulativePayouts: dailyRecord.payouts,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            source: 'auto_batch_update'
                                        }, { merge: true });
                                    
                                    savedCount++;
                                    console.log(`      💾 已保存: ${machineConfig.machineId}/${machineConfig.location}`);
                                } catch (error) {
                                    console.error(`      ❌ 保存失敗: ${machineConfig.machineId}`, error);
                                }
                            } else {
                                skippedCount++;
                                console.log(`   ⚠️ 沒有數據: ${recordKey}`);
                            }
                        }
                    } catch (error) {
                        console.error(`❌ 處理門市 ${store.name} 失敗:`, error);
                    }
                }
                
                updateStep(6, 'done', '✅');
                updateDetail(`批量記帳完成! 已保存 ${savedCount} 筆, 跳過 ${skippedCount} 筆`);
                console.log(`✅ 步驟 6 完成: 已保存 ${savedCount} 筆記錄, 跳過 ${skippedCount} 筆`);

                // ============================================
                // 完成
                // ============================================
                console.log('\n' + '='.repeat(80));
                console.log(`🎉 一鍵全自動更新完成！`);
                console.log(`📊 統計: ${stores.length} 個門市, ${savedCount} 筆記錄`);
                console.log('='.repeat(80));

                // 延遲 2 秒後關閉進度框
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                progressDiv.remove();
                alert(`✅ 一鍵全自動更新完成！\n\n` +
                      `📊 門市數: ${stores.length}\n` +
                      `💾 記帳筆數: ${savedCount}\n` +
                      `⏱️ 所有流程已完成`);

            } catch (error) {
                console.error('❌ 一鍵全自動更新失敗:', error);
                updateDetail(`❌ 錯誤: ${error.message}`);
                
                setTimeout(() => {
                    progressDiv.remove();
                    alert('❌ 一鍵全自動更新失敗:\n' + error.message);
                }, 2000);
            }
        }

        // ============================================
        // 📖 快速讀取所有門市資料 (內部輔助函數)
        // ============================================
        async function quickReadAllStoresData(updateCallback) {
            const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
            const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let processedCount = 0;
            let totalReadCount = 0;
            
            for (const store of stores) {
                updateCallback(`正在讀取: ${store.name} (${++processedCount}/${stores.length})`);
                console.log(`📖 讀取門市: ${store.name}`);
                
                try {
                    const machinesSnapshot = await db.collection('groups')
                        .doc(selectedGroupId)
                        .collection('stores')
                        .doc(store.id)
                        .collection('machines')
                        .get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({ 
                        docId: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // 臨時設置當前門市的 appData 和 machineConfigMap
                    const originalAppData = window.appData;
                    const originalConfigMap = window.machineConfigMap;
                    
                    window.appData = {
                        machines: machines,
                        storeId: store.id,
                        storeName: store.name
                    };
                    
                    // 重建機台配置映射表
                    window.machineConfigMap = null;
                    buildMachineConfigMap();
                    
                    console.log(`   機台數: ${machines.length}`);
                    
                    // 並行讀取該門市的所有機台
                    const readPromises = machines
                        .filter(m => m.mac && m.mac.trim() !== '')
                        .map(async (machine) => {
                            const mac = machine.mac;
                            const devid = machine.devid || 1;
                            
                            try {
                                // 傳入正確的 mac 和 devid
                                const result = await fetchWithRetry(mac, 3, 500, devid);
                                if (result && validateMachineData(result)) {
                                    handleHttpResponse(result, mac, devid);
                                    console.log(`   ✅ 讀取成功: ${mac}/${devid}`);
                                    return true;
                                }
                                return false;
                            } catch (error) {
                                console.warn(`   ⚠️ 讀取失敗: ${mac}/${devid}`, error.message);
                                return false;
                            }
                        });
                    
                    const results = await Promise.all(readPromises);
                    const successCount = results.filter(r => r).length;
                    totalReadCount += successCount;
                    
                    console.log(`   ✅ 完成: ${successCount}/${machines.length} 個機台`);
                    
                    // 恢復原始 appData 和 machineConfigMap
                    window.appData = originalAppData;
                    window.machineConfigMap = originalConfigMap;
                    
                } catch (error) {
                    console.error(`   ❌ 處理門市 ${store.name} 失敗:`, error);
                }
            }
            
            console.log(`📊 快速讀取完成: ${processedCount} 個門市, ${totalReadCount} 個成功讀取`);
            return processedCount;
        }

        // ============================================
        // 🌐 立即發送所有門市機台查詢訊息
        // ============================================
        async function pollAllStoresMachines() {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }

            // 確認操作
            const confirmMsg = '確定要發送所有門市機台的查詢訊息嗎？\n\n這將會：\n1. 對每個門市的所有機台發送 HTTP 查詢\n2. 不等待回應（手動進入門市後再讀取）\n3. 建議等待 2-3 秒後再進入門市查看\n\n適合在開始工作前預先發送查詢。';
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('🌐 開始發送所有門市機台查詢訊息');
            console.log('='.repeat(80));

            // 顯示進度提示
            const progressDiv = document.createElement('div');
            progressDiv.id = 'poll-all-stores-progress';
            progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
            progressDiv.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="font-bold">正在發送查詢...</span>
                </div>
                <div id="poll-progress-text" class="text-sm">準備中...</div>
            `;
            document.body.appendChild(progressDiv);

            const updateProgress = (text) => {
                const progressText = document.getElementById('poll-progress-text');
                if (progressText) progressText.textContent = text;
            };

            try {
                // 獲取所有門市
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`📋 找到 ${stores.length} 個門市`);
                updateProgress(`找到 ${stores.length} 個門市，開始發送查詢...`);

                let totalStores = stores.length;
                let completedStores = 0;
                let totalMachines = 0;
                let totalSent = 0;
                let totalFailed = 0;

                // 收集所有機台的 MAC 位址
                const allMacAddresses = [];

                for (const store of stores) {
                    completedStores++;
                    console.log(`\n[${completedStores}/${totalStores}] 🏪 處理門市: ${store.name}`);
                    updateProgress(`[${completedStores}/${totalStores}] 正在處理: ${store.name}`);

                    try {
                        // 獲取該門市的所有機台
                        const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(store.id)
                            .collection('machines').get();
                        
                        const machines = machinesSnapshot.docs.map(doc => ({
                            docId: doc.id,
                            ...doc.data()
                        }));

                        console.log(`   📊 找到 ${machines.length} 台機台`);
                        totalMachines += machines.length;

                        // 發送每台機台的查詢
                        for (const machine of machines) {
                            console.log(`      機台資料:`, machine);
                            console.log(`      MAC: ${machine.mac}, ID: ${machine.id}, DevID: ${machine.devid}`);
                            
                            if (machine.mac && machine.mac.trim()) {
                                // 處理 devidData（多個 devid）
                                if (machine.devidData && typeof machine.devidData === 'object') {
                                    const devids = Object.keys(machine.devidData);
                                    for (const devid of devids) {
                                        allMacAddresses.push({
                                            mac: machine.mac.trim(),
                                            devid: devid,
                                            storeName: store.name,
                                            machineId: machine.id || machine.docId,
                                            location: machine.location || '未知位置'
                                        });
                                        console.log(`      ✅ 已加入 MAC: ${machine.mac.trim()}, DevID: ${devid}`);
                                    }
                                }
                                // 處理單一 devid
                                else if (machine.devid) {
                                    allMacAddresses.push({
                                        mac: machine.mac.trim(),
                                        devid: machine.devid,
                                        storeName: store.name,
                                        machineId: machine.id || machine.docId,
                                        location: machine.location || '未知位置'
                                    });
                                    console.log(`      ✅ 已加入 MAC: ${machine.mac.trim()}, DevID: ${machine.devid}`);
                                }
                                // 沒有 devid，預設為 1
                                else {
                                    allMacAddresses.push({
                                        mac: machine.mac.trim(),
                                        devid: 1,
                                        storeName: store.name,
                                        machineId: machine.id || machine.docId,
                                        location: machine.location || '未知位置'
                                    });
                                    console.log(`      ✅ 已加入 MAC: ${machine.mac.trim()}, DevID: 1 (預設)`);
                                }
                            } else {
                                console.log(`      ⚠️ 機台沒有 MAC 位址`);
                            }
                        }

                    } catch (error) {
                        console.error(`   ❌ 讀取 ${store.name} 機台失敗:`, error);
                        totalFailed++;
                    }
                }

                console.log(`\n📋 總共收集到 ${allMacAddresses.length} 個 MAC+DevID 組合`);
                console.log('📋 收集到的列表:', allMacAddresses);
                updateProgress(`準備發送 ${allMacAddresses.length} 個查詢...`);

                // 使用去重後的 MAC+DevID 組合
                const uniqueCombos = [];
                const seenKeys = new Set();
                for (const item of allMacAddresses) {
                    const key = `${item.mac}_${item.devid}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueCombos.push(item);
                    }
                }
                console.log(`📋 去重後: ${uniqueCombos.length} 個唯一組合`);
                console.log('📋 去重後的組合:', uniqueCombos.map(c => `${c.mac}_${c.devid}`));

                if (uniqueCombos.length === 0) {
                    alert('沒有找到任何 MAC 位址，請確認機台設定');
                    progressDiv.parentNode.removeChild(progressDiv);
                    return;
                }

                // 強制使用 HTTP 發送查詢
                console.log('✅ 開始發送 HTTP 查詢訊息');
                updateProgress('正在發送查詢訊息...');

                // 使用 XMLHttpRequest 發送所有查詢
                for (let i = 0; i < uniqueCombos.length; i++) {
                    const combo = uniqueCombos[i];
                    const url = `http://update.feiloli.com.tw:5539/webReadCmd/${combo.mac}/${combo.devid}/`;
                    
                    console.log(`\n[${i+1}/${uniqueCombos.length}] 📤 準備發送查詢`);
                    console.log(`   MAC: ${combo.mac}, DevID: ${combo.devid}`);
                    console.log(`   URL: ${url}`);
                    
                    try {
                        // 使用 XMLHttpRequest（更底層，更可靠）
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.timeout = 5000; // 5秒超時
                        
                        xhr.onload = function() {
                            console.log(`   ✅ 發送成功: ${combo.mac}_${combo.devid} (狀態: ${xhr.status})`);
                            totalSent++;
                        };
                        
                        xhr.onerror = function() {
                            console.log(`   ✅ 查詢已發送到設備: ${combo.mac}_${combo.devid} (CORS 錯誤可忽略)`);
                            totalSent++; // CORS 錯誤表示請求已發出，只是無法讀取回應
                        };
                        
                        xhr.ontimeout = function() {
                            console.log(`   ✅ 查詢已發送: ${combo.mac}_${combo.devid} (設備可能離線)`);
                            totalSent++;
                        };
                        
                        xhr.send();
                        console.log(`   📡 請求已發送！`);
                        
                        // 每個請求之間稍微延遲，避免太快
                        if (i < uniqueCombos.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`   ❌ 發送失敗 ${combo.mac}_${combo.devid}:`, error);
                        totalFailed++;
                    }
                    
                    // 更新進度
                    updateProgress(`正在發送... (${i+1}/${uniqueCombos.length})`);
                }

                // 完成提示
                progressDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">查詢已發送！</span>
                    </div>
                    <div class="text-sm">
                        門市: ${totalStores} 個<br>
                        機台: ${totalMachines} 台<br>
                        已發送: ${totalSent} 個查詢<br>
                        <span class="text-yellow-200">⏱ 請等待 2-3 秒後進入門市查看</span><br>
                        <span class="text-xs text-gray-200 mt-1 block">💡 CORS 錯誤可忽略，查詢已送達設備</span>
                    </div>
                `;

                console.log('\n✅ 所有查詢已發送完成！');
                console.log(`📊 統計: ${totalStores} 門市, ${totalMachines} 機台, ${totalSent} 個查詢`);
                console.log('💡 提示: CORS 錯誤是正常的，表示查詢已送到設備，只是瀏覽器無法讀取回應');
                console.log('📝 請等待 2-3 秒後，進入門市點擊「批次讀取」查看結果');

                // 5秒後自動關閉
                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);

            } catch (error) {
                console.error('❌ 發送查詢失敗:', error);
                
                progressDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">發送失敗</span>
                    </div>
                    <div class="text-sm">${error.message}</div>
                `;

                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);
            }
        }

        // ============================================
        // 📊 立即讀取所有門市機台資料
        // ============================================
        async function readAllStoresMachines(limitCount = null) {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }

            // 確認操作
            let confirmMsg = '確定要立即讀取所有門市的機台資料嗎？\n\n這將會：\n1. 先發送查詢給所有機台\n2. 等待 2 秒讓設備準備資料\n3. 讀取並更新所有機台的資料到資料庫\n\n此操作需要較長時間，請耐心等待。';
            
            if (limitCount) {
                confirmMsg = `🧪 測試模式：只讀取前 ${limitCount} 組機台資料\n\n這將會：\n1. 先發送查詢給前 ${limitCount} 組機台\n2. 等待 2 秒讓設備準備資料\n3. 讀取並更新這些機台的資料\n\n適合快速測試功能。`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }

            console.log('\n' + '='.repeat(80));
            console.log('📊 開始讀取所有門市機台資料');
            if (limitCount) {
                console.log(`🧪 測試模式: 只處理前 ${limitCount} 組`);
            }
            console.log('='.repeat(80));

            // 顯示進度提示
            const progressDiv = document.createElement('div');
            progressDiv.id = 'read-all-stores-progress';
            progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
            progressDiv.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="font-bold">正在處理...</span>
                </div>
                <div id="read-progress-text" class="text-sm">準備中...</div>
            `;
            document.body.appendChild(progressDiv);

            const updateProgress = (text) => {
                const progressText = document.getElementById('read-progress-text');
                if (progressText) progressText.textContent = text;
            };

            try {
                // 🔧 先確保 appData 已初始化
                if (!window.appData) {
                    window.appData = { machines: [] };
                }
                
                // 獲取所有門市
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`📋 找到 ${stores.length} 個門市`);
                updateProgress(`找到 ${stores.length} 個門市，載入機台配置...`);
                
                // 🔧 載入所有機台配置到 appData.machines
                window.appData.machines = [];
                for (const store of stores) {
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({
                        docId: doc.id,
                        storeId: store.id,
                        storeName: store.name,
                        ...doc.data()
                    }));
                    
                    window.appData.machines.push(...machines);
                }
                
                console.log(`📦 已載入 ${window.appData.machines.length} 台機台配置`);
                
                // 🔧 構建機台配置映射表
                buildMachineConfigMap();
                console.log(`✅ 映射表已構建，共 ${Object.keys(window.machineConfigMap || {}).length} 條映射`);

                updateProgress(`開始處理 ${stores.length} 個門市...`);

                let totalStores = stores.length;
                let completedStores = 0;
                let totalMachines = 0;
                let totalSuccess = 0;
                let totalFailed = 0;

                // 階段 1: 先發送所有查詢
                console.log('\n📤 階段 1: 發送查詢到所有機台');
                updateProgress('階段 1: 發送查詢到所有機台...');

                // 🔧 使用已經載入的 appData.machines 來構建 allCombos
                // 避免重複從 Firebase 載入,確保使用同一份數據
                const allCombos = [];
                
                for (const machine of window.appData.machines) {
                    totalMachines++;
                    
                    if (machine.mac && machine.mac.trim()) {
                        if (machine.devidData && typeof machine.devidData === 'object') {
                            const devids = Object.keys(machine.devidData);
                            for (const devid of devids) {
                                allCombos.push({
                                    mac: machine.mac.trim(),
                                    devid: devid,
                                    storeId: machine.storeId,
                                    storeName: machine.storeName,
                                    machine: machine
                                });
                            }
                        } else if (machine.devid) {
                            allCombos.push({
                                mac: machine.mac.trim(),
                                devid: machine.devid,
                                storeId: machine.storeId,
                                storeName: machine.storeName,
                                machine: machine
                            });
                        } else {
                            allCombos.push({
                                mac: machine.mac.trim(),
                                devid: 1,
                                storeId: machine.storeId,
                                storeName: machine.storeName,
                                machine: machine
                            });
                        }
                    }
                }

                console.log(`📋 總共找到 ${allCombos.length} 個機台配置`);

                // 去重
                const uniqueCombos = [];
                const seenKeys = new Set();
                for (const item of allCombos) {
                    const key = `${item.mac}_${item.devid}`;
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueCombos.push(item);
                    }
                }

                console.log(`📋 去重後: ${uniqueCombos.length} 個唯一配置`);

                // 🧪 如果指定了限制數量,只取前 N 組
                let processedCombos = uniqueCombos;
                if (limitCount && limitCount > 0) {
                    processedCombos = uniqueCombos.slice(0, limitCount);
                    console.log(`🧪 測試模式: 從 ${uniqueCombos.length} 組中選取前 ${processedCombos.length} 組`);
                }

                // 發送查詢
                for (let i = 0; i < processedCombos.length; i++) {
                    const combo = processedCombos[i];
                    const url = `http://update.feiloli.com.tw:5539/webReadCmd/${combo.mac}/${combo.devid}/`;
                    
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.timeout = 3000;
                        xhr.send();
                        
                        if (i % 10 === 0) {
                            updateProgress(`發送查詢... (${i+1}/${processedCombos.length})`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (error) {
                        console.error(`發送失敗: ${combo.mac}_${combo.devid}`);
                    }
                }

                // 階段 2: 等待設備準備資料
                console.log('\n⏱️ 階段 2: 等待 2 秒讓設備準備資料');
                updateProgress('等待設備準備資料... (2秒)');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 階段 3: 讀取所有機台資料（使用原本的讀取方式）
                console.log('\n📥 階段 3: 開始讀取所有機台資料');
                
                // 🔧 確認映射表存在且有數據
                if (!window.machineConfigMap || Object.keys(window.machineConfigMap).length === 0) {
                    console.warn('⚠️ 映射表為空,重新構建...');
                    buildMachineConfigMap();
                }
                console.log(`✅ 映射表狀態: ${Object.keys(window.machineConfigMap || {}).length} 條映射`);
                console.log(`✅ appData.machines: ${(window.appData?.machines || []).length} 台機台`);
                
                // 按 MAC 分組（一個 MAC 可能有多個 DevID）
                const macGroups = {};
                for (const combo of processedCombos) {
                    if (!macGroups[combo.mac]) {
                        macGroups[combo.mac] = [];
                    }
                    macGroups[combo.mac].push(combo);
                }
                
                const uniqueMacs = Object.keys(macGroups);
                console.log(`📋 總共 ${uniqueMacs.length} 個唯一 MAC 位址需要讀取`);
                
                let readIndex = 0;
                for (const mac of uniqueMacs) {
                    readIndex++;
                    const combos = macGroups[mac];
                    updateProgress(`讀取資料: ${combos[0].storeName} (${readIndex}/${uniqueMacs.length})`);
                    
                    console.log(`\n📥 [${readIndex}/${uniqueMacs.length}] 讀取 MAC: ${mac}`);
                    console.log(`   門市: ${combos[0].storeName}`);
                    console.log(`   機台: ${combos.map(c => `${c.machine.id}(DevID=${c.devid})`).join(', ')}`);
                    
                    try {
                        // 🔧 重要: 需要為每個 DevID 分別調用 sendHttpRequest
                        // 因為 handleHttpResponse 需要知道要處理哪個 DevID 的數據
                        for (const combo of combos) {
                            console.log(`   📡 處理 ${combo.machine.id} (DevID=${combo.devid})`);
                            
                            try {
                                // 記錄處理前的 dailyRecords 狀態
                                const beforeRecordCount = Object.keys(window.dailyRecords || {}).length;
                                
                                // 🔧 關鍵修正: 指定 devid 參數,這樣 handleHttpResponse 才能正確過濾數據
                                const result = await sendHttpRequest(mac, combo.devid);
                                
                                // 檢查是否有新增記錄
                                const afterRecordCount = Object.keys(window.dailyRecords || {}).length;
                                const newRecords = afterRecordCount - beforeRecordCount;
                                
                                if (result && validateMachineData(result)) {
                                    console.log(`      ✅ 讀取成功`);
                                    console.log(`      📊 資料類型: ${Array.isArray(result) ? `陣列 (${result.length} 筆)` : typeof result}`);
                                    console.log(`      📝 新增/更新記錄: ${newRecords} 筆`);
                                    
                                    // 使用 findMachineConfig 找到對應的機台配置
                                    const machineConfig = findMachineConfig(mac, combo.devid);
                                    
                                    if (machineConfig) {
                                        const today = new Date().toISOString().split('T')[0];
                                        // 🔧 使用正確的 key 格式: machineId_location_date (底線分隔,與 updateDailyRecord 一致)
                                        const recordKey = `${machineConfig.machineId}_${machineConfig.location}_${today}`;
                                        
                                        // 檢查 window.dailyRecords 中是否有這個機台的記錄
                                        if (window.dailyRecords && window.dailyRecords[recordKey]) {
                                            const record = window.dailyRecords[recordKey];
                                            console.log(`      ✅ 投幣=${record.plays}, 出獎=${record.payouts} (已自動更新)`);
                                            totalSuccess++;
                                        } else {
                                            console.log(`      ⚠️ 未找到處理記錄 (key=${recordKey})`);
                                            console.log(`      🔍 可用的記錄鍵:`, Object.keys(window.dailyRecords || {}).slice(0, 5));
                                            totalFailed++;
                                        }
                                    } else {
                                        console.log(`      ⚠️ 無法查找機台配置`);
                                        totalFailed++;
                                    }
                                    
                                } else {
                                    console.log(`      ⚠️ 讀取失敗或資料無效`);
                                    totalFailed++;
                                }
                                
                                // 每個 DevID 之間延遲 200ms
                                await new Promise(resolve => setTimeout(resolve, 200));
                                
                            } catch (error) {
                                console.error(`      ❌ 處理失敗: ${error.message}`);
                                totalFailed++;
                            }
                        }
                        
                    } catch (error) {
                        console.error(`   ❌ MAC 處理失敗: ${error.message}`);
                        totalFailed += combos.length;
                    }

                    // 每個 MAC 之間延遲
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // 完成提示
                progressDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">讀取完成！</span>
                    </div>
                    <div class="text-sm">
                        門市: ${totalStores} 個<br>
                        機台: ${totalMachines} 台<br>
                        成功: ${totalSuccess} 個<br>
                        失敗: ${totalFailed} 個
                    </div>
                `;

                console.log('\n✅ 所有門市資料讀取完成！');
                console.log(`📊 統計: ${totalStores} 門市, ${totalMachines} 機台, 成功 ${totalSuccess}, 失敗 ${totalFailed}`);

                // 5秒後自動關閉
                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);

            } catch (error) {
                console.error('❌ 讀取所有門市資料失敗:', error);
                
                progressDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 min-w-[300px]';
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">讀取失敗</span>
                    </div>
                    <div class="text-sm">${error.message}</div>
                `;

                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 5000);
            }
        }

        // 開始自動輪詢 (HTTP 版本)
        function startAutoPolling() {
            stopAutoPolling(); // 確保沒有重複的輪詢
            
            const interval = pollSettings.pollInterval; // 使用可配置的輪詢間隔
            
            console.log(`啟動自動 HTTP 輪詢，間隔: ${interval/1000} 秒`);
            
            pollInterval = setInterval(() => {
                console.log(`執行自動輪詢 (HTTP)`);
                executePollAllMachines();
            }, interval);
            
            showStatusMessage(`已啟動自動輪詢，間隔 ${interval/1000} 秒`, 'success');
        }

        // 停止自動輪詢
        function stopAutoPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                showStatusMessage('已停止自動輪詢', 'info');
            }
        }

        // 狀態訊息顯示
        function showStatusMessage(message, type = 'info') {
            console.log(`狀態訊息: ${message} (${type})`); // 調試用
            
            // 尋找或創建狀態訊息容器
            let statusContainer = document.getElementById('mqtt-status-messages');
            if (!statusContainer) {
                statusContainer = document.createElement('div');
                statusContainer.id = 'mqtt-status-messages';
                statusContainer.className = 'fixed top-4 right-4 z-50 max-w-sm';
                document.body.appendChild(statusContainer);
            }

            const messageDiv = document.createElement('div');
            const bgColors = {
                info: 'bg-blue-600',
                success: 'bg-green-600', 
                error: 'bg-red-600'
            };

            messageDiv.className = `${bgColors[type]} text-white px-4 py-2 rounded-lg mb-2 shadow-lg transform transition-all duration-300`;
            messageDiv.textContent = message;

            statusContainer.appendChild(messageDiv);

            // 自動移除訊息
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // --- INITIAL LOAD ---
        // 延遲初始化 MQTT 功能，確保不影響主要載入流程
        setTimeout(() => {
            try {
                console.log('開始初始化 MQTT 功能...');
                
                // 載入輪詢設定
                loadPollSettings();
                
                // 初始化輪詢設定按鈕事件監聽器
                const setCmdIntervalBtn = document.getElementById('set-cmd-interval-btn');
                const setPollIntervalBtn = document.getElementById('set-poll-interval-btn');
                const cmdIntervalInput = document.getElementById('cmd-interval-input');
                const pollIntervalInput = document.getElementById('poll-interval-input');
                
                if (setCmdIntervalBtn) {
                    setCmdIntervalBtn.addEventListener('click', () => {
                        const newValue = parseInt(cmdIntervalInput.value, 10);
                        if (newValue >= 0 && newValue <= 10000) {
                            pollSettings.cmdInterval = newValue;
                            savePollSettings();
                            updatePollSettingsDisplay();
                            showStatusMessage(`✅ 讀取指令間隔已設定為 ${newValue}ms`, 'success');
                            console.log(`📤 讀取指令間隔設定為: ${newValue}ms`);
                        } else {
                            showStatusMessage(`❌ 請輸入 0-10000 之間的數值`, 'error');
                        }
                    });
                }
                
                if (setPollIntervalBtn) {
                    setPollIntervalBtn.addEventListener('click', () => {
                        const newValue = parseInt(pollIntervalInput.value, 10);
                        if (newValue >= 3 && newValue <= 300) {
                            pollSettings.pollInterval = newValue * 1000; // 轉換為毫秒
                            savePollSettings();
                            updatePollSettingsDisplay();
                            
                            // 如果輪詢正在進行，需要重新啟動
                            if (pollInterval) {
                                stopAutoPolling();
                                startAutoPolling();
                                showStatusMessage(`✅ 輪詢週期已更新為 ${newValue}秒，輪詢已重新啟動`, 'success');
                            } else {
                                showStatusMessage(`✅ 輪詢週期已設定為 ${newValue}秒`, 'success');
                            }
                            console.log(`📊 輪詢週期設定為: ${newValue}秒`);
                        } else {
                            showStatusMessage(`❌ 請輸入 3-300 之間的數值`, 'error');
                        }
                    });
                }
                
                // ✅ 新增：初始化快速輪詢優化設定事件監聽器
                const applyFastPollBtn = document.getElementById('apply-fast-poll-config');
                const resetFastPollBtn = document.getElementById('reset-fast-poll-config');
                const thresholdSlider = document.getElementById('early-termination-threshold');
                const thresholdDisplay = document.getElementById('threshold-display');
                const waitSlider = document.getElementById('wait-before-read');
                const waitDisplay = document.getElementById('wait-display');
                
                if (thresholdSlider && thresholdDisplay) {
                    thresholdSlider.addEventListener('input', () => {
                        thresholdDisplay.textContent = `${thresholdSlider.value}%`;
                    });
                }
                
                if (waitSlider && waitDisplay) {
                    waitSlider.addEventListener('input', () => {
                        const seconds = (waitSlider.value / 1000).toFixed(1);
                        waitDisplay.textContent = `${seconds}s`;
                    });
                }
                
                if (applyFastPollBtn) {
                    applyFastPollBtn.addEventListener('click', () => {
                        const maxRetries = parseInt(document.getElementById('fast-poll-max-retries')?.value) || 2;
                        const retryDelay = parseInt(document.getElementById('fast-poll-retry-delay')?.value) || 1000;
                        const threshold = parseInt(document.getElementById('early-termination-threshold')?.value) || 80;
                        const waitTime = parseInt(document.getElementById('wait-before-read')?.value) || 3000;
                        const enableEarlyTermination = document.getElementById('enable-early-termination')?.checked ?? true;
                        const enablePriorityFiltering = document.getElementById('enable-priority-filtering')?.checked ?? true;
                        
                        // 更新全域配置
                        fastPollConfig.maxRetries = maxRetries;
                        fastPollConfig.retryDelay = retryDelay;
                        fastPollConfig.earlyTerminationThreshold = threshold / 100;
                        fastPollConfig.waitBeforeRead = waitTime;
                        fastPollConfig.enableEarlyTermination = enableEarlyTermination;
                        fastPollConfig.enablePriorityFiltering = enablePriorityFiltering;
                        
                        console.log('🔧 快速輪詢優化配置已套用:');
                        console.log(`   ✓ 最大重試次數: ${maxRetries} 次`);
                        console.log(`   ✓ 重試間隔: ${retryDelay}ms`);
                        console.log(`   ✓ 提前終止臨界值: ${threshold}%`);
                        console.log(`   ✓ 讀取等待時間: ${waitTime}ms (${(waitTime/1000).toFixed(1)}秒)`);
                        console.log(`   ✓ 啟用提前終止: ${enableEarlyTermination ? '是' : '否'}`);
                        console.log(`   ✓ 啟用優先級過濾: ${enablePriorityFiltering ? '是' : '否'}`);
                        
                        showStatusMessage('✅ 快速輪詢優化配置已套用', 'success');
                    });
                }
                
                if (resetFastPollBtn) {
                    resetFastPollBtn.addEventListener('click', () => {
                        // 重置為預設值
                        document.getElementById('fast-poll-max-retries').value = '2';
                        document.getElementById('fast-poll-retry-delay').value = '1000';
                        document.getElementById('early-termination-threshold').value = '80';
                        document.getElementById('wait-before-read').value = '3000';
                        document.getElementById('enable-early-termination').checked = true;
                        document.getElementById('enable-priority-filtering').checked = true;
                        
                        if (thresholdDisplay) {
                            thresholdDisplay.textContent = '80%';
                        }
                        if (waitDisplay) {
                            waitDisplay.textContent = '3.0s';
                        }
                        
                        // 重置全域配置
                        fastPollConfig = {
                            enableEarlyTermination: true,
                            enablePriorityFiltering: true,
                            maxRetries: 2,
                            retryDelay: 1000,
                            earlyTerminationThreshold: 0.8,
                            waitBeforeRead: 3000
                        };
                        
                        console.log('🔄 快速輪詢配置已重置為預設值');
                        showStatusMessage('✅ 快速輪詢配置已重置為預設值', 'success');
                    });
                }
                
                initializeMqttPolling();
                initializeMqttControls();
                initializeDetailPanel();
                console.log('MQTT 功能初始化完成');
                
                // 添加全域測試函數供調試使用
                window.testMqttPolling = function() {
                    console.log('=== 測試 MQTT 輪詢功能 ===');
                    console.log('MQTT 客戶端:', mqttClient);
                    console.log('MQTT 連接狀態:', mqttConnected);
                    console.log('appData:', appData);
                    
                    if (appData && appData.machines) {
                        console.log('當前機台列表:', appData.machines);
                        const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                        console.log('有 MAC 位址的機台:', machinesWithMac);
                        if (machinesWithMac.length > 0) {
                            pollAllMachines();
                        } else {
                            console.log('沒有設定 MAC 位址的機台');
                        }
                    } else {
                        console.log('appData 或機台列表不存在');
                    }
                };
                
                // 添加 MQTT 狀態檢查函數
                window.checkMqttStatus = function() {
                    console.log('=== MQTT 狀態檢查 ===');
                    console.log('mqttClient 存在:', !!mqttClient);
                    console.log('mqttConnected 狀態:', mqttConnected);
                    
                    // 檢查 MQTT 狀態指示器
                    const statusIndicator = document.getElementById('mqtt-status-indicator');
                    const statusText = document.getElementById('mqtt-status-text');
                    if (statusIndicator) {
                        console.log('狀態指示器 class:', statusIndicator.className);
                    }
                    if (statusText) {
                        console.log('狀態文字:', statusText.textContent);
                    }
                    
                    return { client: !!mqttClient, connected: mqttConnected };
                };
                
                // 添加快速測試輪詢功能（使用圖片中的 MAC 位址）
                window.testQuickPoll = function() {
                    console.log('=== 快速輪詢測試 ===');
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    
                    // 檢查本地和全域 MQTT 客戶端
                    const localClient = mqttClient;
                    const globalClient = window.mqttClient;
                    const activeClient = localClient || globalClient;
                    
                    console.log('本地客戶端:', !!localClient);
                    console.log('全域客戶端:', !!globalClient);
                    console.log('使用客戶端:', !!activeClient);
                    
                    if (activeClient) {
                        console.log('嘗試輪詢測試機台...');
                        console.log('使用正確的命令格式：包含 cmd, mac, floor, devid, taskid');
                        pollSingleMachine(testMac, testDevId);
                    } else {
                        console.log('無 MQTT 客戶端可用');
                        alert('請先連接 MQTT 再進行測試');
                    }
                };
                
                // 添加 MQTT 狀態檢查功能
                window.checkMqttStatus = function() {
                    console.log('=== MQTT 狀態檢查 ===');
                    console.log('本地 mqttClient:', !!mqttClient);
                    console.log('本地 mqttConnected:', mqttConnected);
                    console.log('全域 window.mqttClient:', !!window.mqttClient);
                    console.log('全域 window.mqttConnected:', window.mqttConnected);
                    
                    if (mqttClient) {
                        console.log('mqttClient.connected:', mqttClient.connected);
                        console.log('mqttClient.disconnected:', mqttClient.disconnected);
                        console.log('mqttClient.reconnecting:', mqttClient.reconnecting);
                    }
                    
                    const statusElement = document.getElementById('mqtt-status-text');
                    if (statusElement) {
                        console.log('UI 狀態文字:', statusElement.textContent);
                    }
                };
                
                // 強制同步 MQTT 狀態
                window.syncMqttStatus = function() {
                    console.log('=== 強制同步 MQTT 狀態 ===');
                    
                    // 如果本地 mqttClient 存在但全域沒有，同步到全域
                    if (mqttClient && !window.mqttClient) {
                        console.log('同步本地客戶端到全域');
                        window.mqttClient = mqttClient;
                    }
                    
                    // 如果全域 mqttClient 存在但本地沒有，從全域取得
                    if (!mqttClient && window.mqttClient) {
                        console.log('從全域取得客戶端到本地');
                        mqttClient = window.mqttClient;
                    }
                    
                    // 同步連接狀態
                    if (mqttClient && mqttClient.connected) {
                        console.log('偵測到客戶端已連接，同步狀態');
                        mqttConnected = true;
                        window.mqttConnected = true;
                        updateMqttStatus(true, '狀態已同步');
                    }
                    
                    console.log('同步完成 - 本地客戶端:', !!mqttClient, '全域客戶端:', !!window.mqttClient);
                    return {
                        localClient: !!mqttClient,
                        globalClient: !!window.mqttClient,
                        localConnected: mqttConnected,
                        globalConnected: window.mqttConnected
                    };
                };

                // 簡易診斷和修復功能
                window.fixMqttPolling = function() {
                    console.log('=== MQTT 輪詢修復程序 ===');
                    
                    // 1. 檢查 UI 狀態
                    const statusText = document.getElementById('mqtt-status-text');
                    const connectBtn = document.getElementById('mqtt-connect-btn');
                    console.log('UI 狀態:', statusText?.textContent);
                    console.log('按鈕文字:', connectBtn?.textContent);
                    
                    // 2. 檢查變數狀態
                    console.log('變數狀態 - 本地客戶端:', !!mqttClient, '全域客戶端:', !!window.mqttClient);
                    console.log('連接狀態 - 本地:', mqttConnected, '全域:', window.mqttConnected);
                    
                    // 3. 如果 UI 顯示已連接但變數未同步，強制同步
                    if (statusText?.textContent.includes('已連接') || statusText?.textContent.includes('連線成功')) {
                        console.log('UI 顯示已連接，但變數可能未同步，執行修復...');
                        
                        // 如果沒有客戶端但 UI 說已連接，可能需要重新連接
                        if (!mqttClient && !window.mqttClient) {
                            console.log('未找到客戶端，建議重新連接');
                            alert('檢測到連接異常，請點擊「重新連線」按鈕');
                            return false;
                        }
                        
                        // 同步狀態
                        window.syncMqttStatus();
                    }
                    
                    // 4. 測試輪詢
                    console.log('嘗試測試輪詢...');
                    if (window.testQuickPoll) {
                        window.testQuickPoll();
                        return true;
                    } else {
                        console.error('testQuickPoll 函數不存在');
                        return false;
                    }
                };

                // 測試詳細面板顯示功能
                window.testDetailPanel = function() {
                    console.log('=== 測試詳細面板顯示 ===');
                    
                    // 創建模擬資料
                    const mockMachine = {
                        id: 'TEST-001',
                        mac: '083A8DE1ED14',
                        devid: 1
                    };
                    
                    const mockMqttData = {
                        voltageData: {
                            strongVoltage: 12,
                            mediumVoltage: 8,
                            weakVoltage: 5,
                            heightToTop: 10,
                            clampVoltage: 15
                        },
                        operationData: {
                            winRateBank: 100,
                            coinGameCount: 50,
                            prizeCount: 10,
                            accumulatedAmount1: 500,
                            accumulatedAmount2: 300,
                            accumulatedAmount3: 200
                        },
                        rawHex: '1234567890ABCDEF',
                        parseTime: new Date().toLocaleString(),
                        isStatusOnly: false
                    };
                    
                    console.log('使用模擬資料測試面板顯示...');
                    showMachineDetailPanel(mockMachine, mockMqttData);
                };

                // 檢查頁籤和面板狀態
                window.checkTabAndPanel = function() {
                    console.log('=== 檢查頁籤和面板狀態 ===');
                    
                    const currentTab = document.querySelector('.tab-btn.active');
                    const machinesTabContent = document.getElementById('machines');
                    const detailPanel = document.getElementById('machine-detail-panel');
                    
                    console.log('當前活動頁籤:', currentTab?.textContent);
                    console.log('機台管理頁籤是否顯示:', !machinesTabContent?.classList.contains('hidden'));
                    console.log('詳細面板是否顯示:', !detailPanel?.classList.contains('hidden'));
                    console.log('詳細面板元素存在:', !!detailPanel);
                    
                    if (detailPanel) {
                        console.log('詳細面板類別:', detailPanel.className);
                    }
                    
                    return {
                        currentTab: currentTab?.textContent,
                        machinesTabVisible: !machinesTabContent?.classList.contains('hidden'),
                        detailPanelVisible: !detailPanel?.classList.contains('hidden'),
                        detailPanelExists: !!detailPanel
                    };
                };

                // 驗證 MQTT 命令格式
                window.validateMqttCommand = function() {
                    console.log('=== MQTT 命令格式驗證 ===');
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const expectedCommand = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    console.log('正確的命令格式應該是:');
                    console.log(JSON.stringify(expectedCommand, null, 2));
                    console.log('');
                    console.log('命令說明:');
                    console.log('- cmd: 命令類型 (readdata)');
                    console.log('- mac: 機台WiFi小卡MAC');
                    console.log('- floor: 固定為 "1"');
                    console.log('- devid: 天車板 (左天車ID:1，右天車ID:2)');
                    console.log('- taskid: 命令編號 (時間戳格式)');
                    
                    return expectedCommand;
                };

                // 直接測試命令發送（不依賴其他函數）
                window.testDirectMqttSend = function() {
                    console.log('=== 直接測試 MQTT 命令發送 ===');
                    
                    const activeClient = mqttClient || window.mqttClient;
                    if (!activeClient) {
                        console.error('沒有可用的 MQTT 客戶端');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const testDevId = 1;
                    const topic = 'coffeelens/req';
                    const taskid = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    const commandObject = {
                        cmd: 'readdata',
                        mac: testMac,
                        floor: '1',
                        devid: testDevId.toString(),
                        taskid: taskid
                    };
                    
                    const message = JSON.stringify(commandObject);
                    
                    console.log('🔥🔥🔥 直接發送測試 🔥🔥🔥');
                    console.log('主題:', topic);
                    console.log('命令物件:', commandObject);
                    console.log('JSON 字串:', message);
                    console.log('🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥');
                    
                    activeClient.publish(topic, message, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('發送失敗:', err);
                        } else {
                            console.log('✅ 直接測試命令發送成功！');
                        }
                    });
                    
                    return true;
                };
                
                // 發送簡單的 ping 測試
                window.testMachinePing = function() {
                    console.log('=== 測試機台 Ping ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    // 發送簡單的 ping 命令
                    const pingCommand = {
                        cmd: 'ping',
                        timestamp: new Date().toISOString()
                    };
                    
                    const topics = ['coffeelens/req', 'machine/ping', 'system/ping'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            console.log(`發送 ping 到: ${topic}`);
                            client.publish(topic, JSON.stringify(pingCommand), { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`Ping ${topic} 失敗:`, err);
                                } else {
                                    console.log(`✅ Ping ${topic} 發送成功`);
                                }
                            });
                        }, index * 1000);
                    });
                };

                // 測試獲取營業資料的不同命令
                window.testBusinessDataCommands = function() {
                    console.log('=== 測試營業資料命令 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    const machineId = '65db7656fb39'; // 從回應中獲得的機台 ID
                    const timestamp = new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17);
                    
                    // 嘗試不同的營業資料命令格式
                    const commands = [
                        // 原始格式
                        {
                            cmd: 'readdata',
                            mac: '083A8DE1ED14',
                            floor: '1',
                            devid: '1',
                            taskid: timestamp + '001'
                        },
                        // 使用機台名稱
                        {
                            cmd: 'getdata',
                            machine_id: machineId,
                            request_type: 'business_data',
                            taskid: timestamp + '002'
                        },
                        // 簡化命令
                        {
                            cmd: 'data',
                            target: machineId,
                            taskid: timestamp + '003'
                        },
                        // 狀態查詢
                        {
                            cmd: 'status',
                            machine: machineId,
                            type: 'sales',
                            taskid: timestamp + '004'
                        },
                        // 銷售資料
                        {
                            cmd: 'sales_data',
                            device_id: machineId,
                            taskid: timestamp + '005'
                        }
                    ];
                    
                    const topics = ['coffeelens/req', 'machine/command', 'device/request'];
                    
                    commands.forEach((command, cmdIndex) => {
                        topics.forEach((topic, topicIndex) => {
                            const delay = (cmdIndex * topics.length + topicIndex) * 2000;
                            setTimeout(() => {
                                const message = JSON.stringify(command);
                                console.log(`測試命令 ${cmdIndex + 1}.${topicIndex + 1}: ${topic}`);
                                console.log('命令:', command);
                                
                                client.publish(topic, message, { qos: 0 }, function(err) {
                                    if (err) {
                                        console.error(`命令 ${cmdIndex + 1}.${topicIndex + 1} 發送失敗:`, err);
                                    } else {
                                        console.log(`✅ 命令 ${cmdIndex + 1}.${topicIndex + 1} 發送成功`);
                                        addCommandLog('send', `測試營業資料命令 - ${command.cmd}`, command);
                                    }
                                });
                            }, delay);
                        });
                    });
                };

                // 檢查當前頁面時間戳，確保是最新版本
                window.checkPageVersion = function() {
                    console.log('=== 頁面版本檢查 ===');
                    console.log('當前時間:', new Date().toLocaleString());
                    console.log('pollSingleMachine 函數存在:', typeof pollSingleMachine === 'function');
                    console.log('testDirectMqttSend 函數存在:', typeof window.testDirectMqttSend === 'function');
                    
                    // 檢查函數內容是否包含新的格式
                    const funcString = pollSingleMachine.toString();
                    const hasCorrectFormat = funcString.includes('cmd: \'readdata\'') && 
                                           funcString.includes('floor: \'1\'') && 
                                           funcString.includes('taskid: taskid');
                    
                    console.log('pollSingleMachine 包含正確格式:', hasCorrectFormat);
                    
                    if (!hasCorrectFormat) {
                        console.error('⚠️ 函數還是舊版本，請重新載入頁面！');
                        alert('請按 Ctrl+F5 強制重新載入頁面');
                    } else {
                        console.log('✅ 函數已更新為新版本');
                    }
                };

                // 檢查機台列表和 MAC 位址
                window.checkMachineList = function() {
                    console.log('=== 檢查機台列表 ===');
                    
                    if (!appData || !appData.machines) {
                        console.error('沒有機台資料');
                        return;
                    }
                    
                    console.log('總機台數量:', appData.machines.length);
                    
                    const machinesWithMac = appData.machines.filter(m => m.mac && m.mac.trim());
                    console.log('有 MAC 位址的機台:', machinesWithMac.length);
                    
                    console.log('機台清單:');
                    appData.machines.forEach((machine, index) => {
                        console.log(`${index + 1}. ID: ${machine.id}`);
                        console.log(`   MAC: ${machine.mac || '未設定'}`);
                        console.log(`   DevID: ${machine.devid || '1'}`);
                        console.log(`   有MAC: ${!!(machine.mac && machine.mac.trim())}`);
                        console.log('---');
                    });
                    
                    // 檢查測試用的 MAC 是否在列表中
                    const testMac = '083A8DE1ED14';
                    const foundMachine = appData.machines.find(m => m.mac === testMac);
                    
                    console.log(`測試 MAC (${testMac}) 是否在機台列表中:`, !!foundMachine);
                    if (foundMachine) {
                        console.log('找到的機台:', foundMachine);
                    } else {
                        console.warn('測試 MAC 不在機台列表中，需要先添加機台');
                    }
                    
                    return {
                        totalMachines: appData.machines.length,
                        machinesWithMac: machinesWithMac.length,
                        testMacExists: !!foundMachine
                    };
                };

                // 手動添加測試機台
                window.addTestMachine = function() {
                    const testMac = '083A8DE1ED14';
                    const existingMachine = appData.machines.find(m => m.mac === testMac);
                    
                    if (existingMachine) {
                        console.log('測試機台已存在:', existingMachine);
                        return existingMachine;
                    }
                    
                    const newMachine = {
                        id: 'TEST-001',
                        mac: testMac,
                        devid: 1,
                        storeName: '測試店舖',
                        addedBy: 'manual',
                        addedAt: new Date().toISOString()
                    };
                    
                    appData.machines.push(newMachine);
                    console.log('已添加測試機台:', newMachine);
                    
                    // 更新 UI
                    if (typeof renderMachineManagementTab === 'function') {
                        renderMachineManagementTab();
                    }
                    
                    return newMachine;
                };

                // 測試機台回應主題
                window.testMachineTopics = function() {
                    console.log('=== 測試機台回應主題 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client || !client.connected) {
                        console.error('MQTT 未連接');
                        return;
                    }
                    
                    // 測試常見的機台回應主題
                    const testTopics = [
                        'machine/response',
                        'machine/data',
                        'machine/status',
                        'device/response',
                        'device/data',
                        'coffeelens/machine',
                        'coffeelens/data',
                        'system/response',
                        'response',
                        'data'
                    ];
                    
                    console.log('嘗試訂閱測試主題...');
                    testTopics.forEach(topic => {
                        client.subscribe(topic, { qos: 1 }, function(err) {
                            if (err) {
                                console.warn(`訂閱 ${topic} 失敗:`, err);
                            } else {
                                console.log(`✅ 成功訂閱: ${topic}`);
                            }
                        });
                    });
                    
                    // 等待一段時間後發送讀取命令
                    setTimeout(() => {
                        console.log('發送測試讀取命令...');
                        testDirectMqttSend();
                    }, 2000);
                };

                // 測試 MQTT 連接和訂閱狀態
                window.testMqttConnection = function() {
                    console.log('=== MQTT 連接狀態測試 ===');
                    
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    console.log('MQTT 客戶端存在:', !!client);
                    console.log('連接狀態:', client.connected);
                    console.log('重新連接中:', client.reconnecting);
                    console.log('斷開中:', client.disconnecting);
                    
                    // 檢查訂閱的主題
                    const subscribedTopics = Object.keys(client.options.subscriptions || {});
                    console.log('已訂閱的主題:', subscribedTopics);
                    
                    // 檢查 UI 設定的主題
                    const topicInput = document.getElementById('mqtt-topic');
                    console.log('UI 設定的訂閱主題:', topicInput?.value);
                    
                    // 發送一個測試訊息到自己
                    const testTopic = 'test/echo';
                    const testMessage = JSON.stringify({ test: true, timestamp: new Date().toISOString() });
                    
                    console.log('發送測試回聲訊息...');
                    client.publish(testTopic, testMessage, { qos: 0 }, function(err) {
                        if (err) {
                            console.error('測試訊息發送失敗:', err);
                        } else {
                            console.log('測試訊息發送成功');
                        }
                    });
                    
                    return {
                        connected: client.connected,
                        reconnecting: client.reconnecting,
                        subscribedTopics: subscribedTopics,
                        uiTopic: topicInput?.value
                    };
                };

                // 手動訂閱測試主題
                window.subscribeTestTopic = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    const testTopic = 'test/echo';
                    console.log('訂閱測試主題:', testTopic);
                    
                    client.subscribe(testTopic, { qos: 1 }, function(err) {
                        if (err) {
                            console.error('訂閱測試主題失敗:', err);
                        } else {
                            console.log('✅ 訂閱測試主題成功');
                        }
                    });
                };

                // 測試不同的機台命令格式
                window.testDifferentFormats = function() {
                    const client = mqttClient || window.mqttClient;
                    if (!client) {
                        console.error('沒有 MQTT 客戶端');
                        return false;
                    }
                    
                    const testMac = '083A8DE1ED14';
                    const topics = ['coffeelens/req', 'machine/request', 'device/command'];
                    
                    topics.forEach((topic, index) => {
                        setTimeout(() => {
                            const message = JSON.stringify({
                                cmd: 'readdata',
                                mac: testMac,
                                floor: '1',
                                devid: '1',
                                taskid: new Date().toISOString().replace(/[-T:\.Z]/g, '').substring(0, 17)
                            });
                            
                            console.log(`測試主題 ${index + 1}: ${topic}`);
                            console.log(`訊息: ${message}`);
                            
                            client.publish(topic, message, { qos: 0 }, function(err) {
                                if (err) {
                                    console.error(`主題 ${topic} 發送失敗:`, err);
                                } else {
                                    console.log(`✅ 主題 ${topic} 發送成功`);
                                }
                            });
                        }, index * 2000); // 每 2 秒發送一個
                    });
                };
                
            } catch (error) {
                console.error('初始化 MQTT 功能時發生錯誤:', error);
            }
        }, 2000); // 增加到 2 秒確保頁面完全載入
        
        // 初始化自動記帳表格
        setTimeout(() => {
            console.log('📊 初始化自動記帳表格...');
            if (typeof refreshAutoRecordTable === 'function') {
                refreshAutoRecordTable();
            }
        }, 500);

        // ========================================
        // 🎯 戰情室 (Command Center) 功能模組
        // ========================================
        
        // 顯示戰情室頁面
        function showCommandCenter() {
            console.log('🎯 進入戰情室');
            storeSelectionPage.classList.add('hidden');
            reportPage.classList.add('hidden');
            commandCenterPage.classList.remove('hidden');
            
            // 設定群組名稱
            const groupNameEl = document.getElementById('command-center-group-name');
            if (groupNameEl && selectedGroupName) {
                groupNameEl.textContent = `- ${selectedGroupName}`;
            }
            
            // 載入戰情室數據
            loadCommandCenterData();
            
            // 初始化 PSD 分析功能
            initPSDAnalysis();
        }
        
        // 隱藏戰情室頁面
        function hideCommandCenter() {
            commandCenterPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
        }
        
        // 載入戰情室數據
        async function loadCommandCenterData() {
            console.log('📊 開始載入戰情室數據...');
            
            try {
                // 檢查是否有選擇群組
                if (!selectedGroupId) {
                    console.error('❌ 未選擇群組');
                    return;
                }
                
                // 獲取所有門市的數據 (使用 Firestore 語法)
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').get();
                
                commandCenterData.stores = [];
                let totalRevenue = 0;
                let totalPlays = 0;
                let totalPayouts = 0;
                let totalMachines = 0;
                let activeStores = 0;
                
                // 處理每個門市
                for (const storeDoc of storesSnapshot.docs) {
                    const storeId = storeDoc.id;
                    const storeInfo = storeDoc.data();
                    const storeStats = await calculateStoreStatsForCC(storeId, storeInfo);
                    commandCenterData.stores.push({
                        id: storeId,
                        name: storeInfo.name || storeId,
                        ...storeStats
                    });
                    
                    totalRevenue += storeStats.revenue || 0;
                    totalPlays += storeStats.plays || 0;
                    totalPayouts += storeStats.payouts || 0;
                    totalMachines += storeStats.machineCount || 0;
                    if (storeStats.plays > 0) activeStores++;
                }
                
                // 🔧 自動建立今日快照（靜默執行，不打擾用戶）
                await autoCreateTodaySnapshot(storesSnapshot.docs);
                
                // 更新最後更新時間
                commandCenterData.lastUpdate = new Date();
                document.getElementById('command-center-last-update').textContent = 
                    `最後更新：${commandCenterData.lastUpdate.toLocaleString('zh-TW')}`;
                

                // Check snapshot status
                await checkSnapshotStatus(storesSnapshot.docs);

                // Update KPI cards
                updateKPICards(totalRevenue, totalPlays, totalPayouts, totalMachines, activeStores, storesSnapshot.size);

                // Update store ranking
                updateStoreRanking();

                // Update revenue trend chart
                await updateRevenueTrendChart();

                // Update alerts
                updateAlerts();

                // Update quick stats
                updateQuickStats();

                // Update pending items
                updatePendingItems();

                // Update stores table
                updateStoresTable();

                // Update top machines
                await updateTopMachines();

                console.log('✅ 戰情室數據載入完成');
            } catch (error) {
                console.error('載入戰情室數據失敗:', error);
            }
        }

        // =============================================
        // 三週 PSD 分析功能
        // =============================================
        
        // 初始化 PSD 分析日期選擇器
        // 計算三週 PSD - 使用 history where 查詢
        async function calculateThreeWeekPSD() {
            const dateInput = document.getElementById('cc-psd-base-date');
            const baseDate = new Date(dateInput.value);
            
            if (isNaN(baseDate.getTime())) {
                alert('請選擇有效的基準日期');
                return;
            }
            
            // 計算三週的日期範圍
            const weeks = [];
            for (let i = 0; i < 3; i++) {
                const endDate = new Date(baseDate);
                endDate.setDate(baseDate.getDate() - (i * 7));
                const startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - 6);
                weeks.push({ 
                    start: startDate, 
                    end: endDate,
                    startStr: startDate.getFullYear() + '-' + String(startDate.getMonth() + 1).padStart(2, '0') + '-' + String(startDate.getDate()).padStart(2, '0'),
                    endStr: endDate.getFullYear() + '-' + String(endDate.getMonth() + 1).padStart(2, '0') + '-' + String(endDate.getDate()).padStart(2, '0')
                });
            }
            
            console.log('🔍 PSD 計算週期:', weeks.map(w => `${w.startStr} ~ ${w.endStr}`));
            
            // 更新週期顯示
            document.getElementById('cc-psd-week1-range').textContent = formatDateRange(weeks[0].start, weeks[0].end);
            document.getElementById('cc-psd-week2-range').textContent = formatDateRange(weeks[1].start, weeks[1].end);
            document.getElementById('cc-psd-week3-range').textContent = formatDateRange(weeks[2].start, weeks[2].end);
            
            // 顯示載入中
            document.getElementById('cc-psd-table').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400"><span class="animate-pulse">計算中...</span></td></tr>';
            
            const COIN_VALUE = 10;
            const psdData = [];
            let totalWeekData = [{ revenue: 0 }, { revenue: 0 }, { revenue: 0 }];
            
            try {
                // 獲取所有門市
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').get();
                
                console.log('📊 PSD計算 - 門市數量:', storesSnapshot.size);
                
                // 對每個門市計算三週 PSD
                for (const storeDoc of storesSnapshot.docs) {
                    const storeData = storeDoc.data();
                    const storeName = storeData.name || storeDoc.id;
                    const weekResults = [];
                    
                    for (let w = 0; w < 3; w++) {
                        let weekPlays = 0;
                        
                        // 使用 where 查詢獲取該週的 history 記錄
                        try {
                            const historySnapshot = await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(storeDoc.id)
                                .collection('history')
                                .where('date', '>=', weeks[w].startStr)
                                .where('date', '<=', weeks[w].endStr)
                                .get();
                            
                            historySnapshot.docs.forEach(doc => {
                                const record = doc.data();
                                weekPlays += record.newPlays || record.dailyPlays || 0;
                            });
                            
                            if (w === 0) {
                                console.log(`📊 PSD - ${storeName} 第${w+1}週(${weeks[w].startStr}~${weeks[w].endStr}): ${historySnapshot.size}筆, plays=${weekPlays}`);
                            }
                        } catch (err) {
                            console.warn(`PSD 查詢失敗 ${storeName}:`, err);
                        }
                        
                        const weekRevenue = weekPlays * COIN_VALUE;
                        const psd = Math.round(weekRevenue / 7);
                        weekResults.push({ revenue: weekRevenue, psd, plays: weekPlays });
                        totalWeekData[w].revenue += weekRevenue;
                    }
                    
                    const trend = weekResults[0].psd - weekResults[1].psd;
                    
                    psdData.push({
                        storeName,
                        storeId: storeDoc.id,
                        weeks: weekResults,
                        trend
                    });
                }
                
                // 按第一週 PSD 排序
                psdData.sort((a, b) => b.weeks[0].psd - a.weeks[0].psd);
                
                // 渲染表格
                renderPSDTable(psdData, storesSnapshot.size);
                
                // 更新摘要卡片
                updatePSDSummaryCards(totalWeekData, storesSnapshot.size);
                
                console.log('✅ PSD 計算完成', { totalWeekData });
                
            } catch (error) {
                console.error('❌ 計算 PSD 失敗:', error);
                document.getElementById('cc-psd-table').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-red-400">計算失敗: ' + error.message + '</td></tr>';
            }
        }

        
        function initPSDAnalysis() {
            const dateInput = document.getElementById('cc-psd-base-date');
            const calculateBtn = document.getElementById('cc-calculate-psd-btn');
            const exportBtn = document.getElementById('cc-export-psd-btn');
            
            if (dateInput) {
                // 預設為今天
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
            
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateThreeWeekPSD);
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', exportPSDToCSV);
            }
        }
        
        // 格式化日期範圍
        function formatDateRange(start, end) {
            const formatDate = (d) => (d.getMonth() + 1) + '/' + d.getDate();
            return formatDate(start) + ' ~ ' + formatDate(end);
        }
        
        // 格式化日期為查詢格式 (YYYY-MM-DD)
        function formatDateForQuery(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // 渲染 PSD 表格
        function renderPSDTable(data, storeCount) {
            const tbody = document.getElementById('cc-psd-table');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">無數據</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach(store => {
                const trendIcon = store.trend > 0 ? '📈' : (store.trend < 0 ? '📉' : '➡️');
                const trendClass = store.trend > 0 ? 'text-green-400' : (store.trend < 0 ? 'text-red-400' : 'text-gray-400');
                const trendValue = store.trend > 0 ? '+' + store.trend.toLocaleString() : store.trend.toLocaleString();
                
                html += '<tr class="hover:bg-gray-700/50 transition-colors">';
                html += '<td class="p-3 text-white font-medium">' + store.storeName + '</td>';
                html += '<td class="p-3 text-right text-blue-300">$' + store.weeks[0].revenue.toLocaleString() + '</td>';
                html += '<td class="p-3 text-right text-blue-400 font-bold">$' + store.weeks[0].psd.toLocaleString() + '</td>';
                html += '<td class="p-3 text-right text-purple-300">$' + store.weeks[1].revenue.toLocaleString() + '</td>';
                html += '<td class="p-3 text-right text-purple-400 font-bold">$' + store.weeks[1].psd.toLocaleString() + '</td>';
                html += '<td class="p-3 text-right text-pink-300">$' + store.weeks[2].revenue.toLocaleString() + '</td>';
                html += '<td class="p-3 text-right text-pink-400 font-bold">$' + store.weeks[2].psd.toLocaleString() + '</td>';
                html += '<td class="p-3 text-center ' + trendClass + '">' + trendIcon + ' ' + trendValue + '</td>';
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
        
        // 更新 PSD 摘要卡片
        function updatePSDSummaryCards(weekData, storeCount) {
            // 計算每週的平均 PSD
            const week1PSD = Math.round(weekData[0].revenue / 7 / storeCount);
            const week2PSD = Math.round(weekData[1].revenue / 7 / storeCount);
            const week3PSD = Math.round(weekData[2].revenue / 7 / storeCount);
            
            document.getElementById('cc-psd-week1-value').textContent = '$' + week1PSD.toLocaleString();
            document.getElementById('cc-psd-week2-value').textContent = '$' + week2PSD.toLocaleString();
            document.getElementById('cc-psd-week3-value').textContent = '$' + week3PSD.toLocaleString();
            
            document.getElementById('cc-psd-week1-total').textContent = '總營收: $' + weekData[0].revenue.toLocaleString();
            document.getElementById('cc-psd-week2-total').textContent = '總營收: $' + weekData[1].revenue.toLocaleString();
            document.getElementById('cc-psd-week3-total').textContent = '總營收: $' + weekData[2].revenue.toLocaleString();
            
            // 更新表格底部合計
            document.getElementById('cc-psd-total-week1-revenue').textContent = '$' + weekData[0].revenue.toLocaleString();
            document.getElementById('cc-psd-total-week1-psd').textContent = '$' + week1PSD.toLocaleString();
            document.getElementById('cc-psd-total-week2-revenue').textContent = '$' + weekData[1].revenue.toLocaleString();
            document.getElementById('cc-psd-total-week2-psd').textContent = '$' + week2PSD.toLocaleString();
            document.getElementById('cc-psd-total-week3-revenue').textContent = '$' + weekData[2].revenue.toLocaleString();
            document.getElementById('cc-psd-total-week3-psd').textContent = '$' + week3PSD.toLocaleString();
        }
        
        // 匯出 PSD 數據為 CSV
        function exportPSDToCSV() {
            const table = document.getElementById('cc-psd-table');
            if (!table || table.rows.length === 0) {
                alert('請先計算 PSD 數據');
                return;
            }
            
            const dateInput = document.getElementById('cc-psd-base-date');
            const baseDate = dateInput.value;
            
            // 取得週期範圍
            const week1Range = document.getElementById('cc-psd-week1-range').textContent;
            const week2Range = document.getElementById('cc-psd-week2-range').textContent;
            const week3Range = document.getElementById('cc-psd-week3-range').textContent;
            
            let csv = '\uFEFF'; // BOM for UTF-8
            csv += '門市名稱,第一週營收 (' + week1Range + '),第一週PSD,第二週營收 (' + week2Range + '),第二週PSD,第三週營收 (' + week3Range + '),第三週PSD,趨勢\n';
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
                    });
                    csv += rowData.join(',') + '\n';
                }
            });
            
            // 添加合計行
            const totalRow = document.getElementById('cc-psd-total-row');
            if (totalRow) {
                const cells = totalRow.querySelectorAll('td');
                if (cells.length >= 8) {
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
                    });
                    csv += rowData.join(',') + '\n';
                }
            }
            
            // 下載 CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '三週PSD分析_' + baseDate + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 🔧 檢查快照狀態
        let hasSnapshotsForPeriod = false; // 全局變數追蹤是否有快照
        
        async function checkSnapshotStatus(storeDocs) {
            const statusEl = document.getElementById('cc-snapshot-status');
            if (!statusEl) return;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            let hasToday = false;
            let hasYesterday = false;
            let snapshotCount = 0;
            
            // 只檢查第一個門市的快照狀態
            if (storeDocs.length > 0) {
                const firstStoreId = storeDocs[0].id;
                
                try {
                    // 檢查今天
                    const todaySnap = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(firstStoreId)
                        .collection('dailySnapshots').doc(today).get();
                    hasToday = todaySnap.exists;
                    
                    // 檢查昨天
                    const yesterdaySnap = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(firstStoreId)
                        .collection('dailySnapshots').doc(yesterday).get();
                    hasYesterday = yesterdaySnap.exists;
                    
                    // 統計總快照數
                    const snapshots = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(firstStoreId)
                        .collection('dailySnapshots').get();
                    snapshotCount = snapshots.size;
                } catch (e) {
                    console.warn('檢查快照狀態失敗:', e);
                }
            }
            
            // 更新全局狀態
            hasSnapshotsForPeriod = snapshotCount > 0;
            
            // 顯示狀態
            const period = document.getElementById('command-center-period')?.value || 'week';
            const needsSnapshot = ['today', 'week', 'month'].includes(period);
            
            if (hasToday) {
                statusEl.innerHTML = `<span class="text-green-400">✓ 今日已快照</span> (共 ${snapshotCount} 筆)`;
            } else if (hasYesterday) {
                statusEl.innerHTML = `<span class="text-yellow-400">⚠ 今日尚未快照</span> (共 ${snapshotCount} 筆)`;
            } else if (snapshotCount > 0) {
                statusEl.innerHTML = `<span class="text-gray-400">📊 共 ${snapshotCount} 筆快照</span>`;
            } else if (needsSnapshot) {
                statusEl.innerHTML = `<span class="text-red-400">⚠ 尚無快照，顯示總累計數據</span>`;
            } else {
                statusEl.innerHTML = `<span class="text-gray-400">📊 顯示累計數據</span>`;
            }
            
            // 更新標籤提示
            const revenueLabel = document.getElementById('cc-revenue-label');
            if (revenueLabel) {
                const periodNames = {
                    'today': '今日',
                    'week': '本週', 
                    'month': '本月',
                    'current': '當期',
                    'all': '總'
                };
                const periodName = periodNames[period] || '期間';
                revenueLabel.textContent = `💰 ${periodName}營收`;
            }
            
            // 更新數據來源提示
            const sourceHints = {
                'history': '📊 使用記帳歷史',
                'snapshot': '📸 使用快照',
                'checkout': '💰 使用結帳基準',
                'total': '📈 總累計'
            };
            
            // 檢查主要數據來源
            const mainSource = commandCenterData.stores[0]?.dataSource || 'total';
            if (statusEl) {
                const hint = sourceHints[mainSource] || '';
                if (mainSource === 'history') {
                    statusEl.innerHTML = `<span class="text-green-400">✓ ${hint}</span>`;
                } else if (mainSource === 'snapshot') {
                    statusEl.innerHTML = `<span class="text-blue-400">${hint}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="text-yellow-400">${hint}</span>`;
                }
            }
        }
        
        // 🔧 自動建立今日快照（靜默執行）
        async function autoCreateTodaySnapshot(storeDocs) {
            if (!selectedGroupId || !storeDocs || storeDocs.length === 0) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // 檢查今天是否已有快照（只檢查第一個門市）
                const firstStoreId = storeDocs[0].id;
                const todaySnap = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(firstStoreId)
                    .collection('dailySnapshots').doc(today).get();
                
                if (todaySnap.exists) {
                    console.log(`📸 今日快照已存在 (${today})`);
                    return; // 已有今日快照，不需要重複建立
                }
                
                console.log(`📸 自動建立今日快照 (${today})...`);
                
                // 為每個門市建立快照
                for (const storeDoc of storeDocs) {
                    const storeId = storeDoc.id;
                    const storeInfo = storeDoc.data();
                    
                    // 獲取機台數據
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('machines').get();
                    
                    let totalPlays = 0;
                    let totalPayouts = 0;
                    
                    machinesSnapshot.forEach(doc => {
                        const machine = doc.data();
                        const machinePlays = machine.plays || machine.totalPlays || 0;
                        const initialPlays = machine.initialPlays || 0;
                        const playsCalibration = machine.playsCalibration || 0;
                        totalPlays += Math.max(0, (machinePlays - initialPlays) + playsCalibration);
                        
                        const machinePayouts = machine.payouts || machine.totalPayouts || 0;
                        const initialPayouts = machine.initialPayouts || 0;
                        const payoutsCalibration = machine.payoutsCalibration || 0;
                        totalPayouts += Math.max(0, (machinePayouts - initialPayouts) + payoutsCalibration);
                    });
                    
                    // 儲存快照
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('dailySnapshots').doc(today).set({
                            date: today,
                            storeName: storeInfo.name,
                            totalPlays: totalPlays,
                            totalPayouts: totalPayouts,
                            totalRevenue: totalPlays * COIN_VALUE,
                            machineCount: machinesSnapshot.size,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            autoCreated: true
                        });
                }
                
                console.log(`✅ 自動快照建立完成 (${today})`);
                
            } catch (error) {
                console.warn('自動建立快照失敗:', error);
                // 靜默失敗，不影響用戶體驗
            }
        }
        
        // 🔧 建立每日快照 - 記錄所有門市的當日累計數據（手動按鈕）
        async function createDailySnapshot() {
            if (!selectedGroupId) {
                alert('請先選擇群組');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            // 檢查是否已有快照
            let existingSnapshots = 0;
            try {
                const firstStore = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').limit(1).get();
                if (!firstStore.empty) {
                    const snaps = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(firstStore.docs[0].id)
                        .collection('dailySnapshots').get();
                    existingSnapshots = snaps.size;
                }
            } catch (e) {}
            
            let confirmMsg;
            let alsoCreateYesterday = false;
            
            if (existingSnapshots === 0) {
                // 首次建立快照，詢問是否也建立昨天的
                alsoCreateYesterday = confirm(`這是您第一次建立快照！\n\n是否同時建立「昨天」的基準快照？\n\n✅ 是 → 今天就能看到「今日增量」\n❌ 否 → 明天才能看到「今日增量」`);
                confirmMsg = `確定要建立快照嗎？`;
            } else {
                confirmMsg = `確定要建立 ${today} 的每日快照嗎？\n\n📌 建立後，系統將能計算「今日/本週/本月」的增量數據。`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // 顯示進度
                const snapshotBtn = document.getElementById('cc-snapshot-btn');
                if (snapshotBtn) {
                    snapshotBtn.disabled = true;
                    snapshotBtn.innerHTML = '⏳ 建立中...';
                }
                
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').get();
                
                let successCount = 0;
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                for (const storeDoc of storesSnapshot.docs) {
                    const storeId = storeDoc.id;
                    const storeInfo = storeDoc.data();
                    
                    // 獲取該門市所有機台的累計數據
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('machines').get();
                    
                    let totalPlays = 0;
                    let totalPayouts = 0;
                    const machineDetails = [];
                    
                    machinesSnapshot.forEach(doc => {
                        const machine = doc.data();
                        const machinePlays = machine.plays || machine.totalPlays || 0;
                        const initialPlays = machine.initialPlays || 0;
                        const playsCalibration = machine.playsCalibration || 0;
                        const effectivePlays = (machinePlays - initialPlays) + playsCalibration;
                        
                        const machinePayouts = machine.payouts || machine.totalPayouts || 0;
                        const initialPayouts = machine.initialPayouts || 0;
                        const payoutsCalibration = machine.payoutsCalibration || 0;
                        const effectivePayouts = (machinePayouts - initialPayouts) + payoutsCalibration;
                        
                        totalPlays += Math.max(0, effectivePlays);
                        totalPayouts += Math.max(0, effectivePayouts);
                        
                        machineDetails.push({
                            machineId: doc.id,
                            id: machine.id,
                            plays: Math.max(0, effectivePlays),
                            payouts: Math.max(0, effectivePayouts)
                        });
                    });
                    
                    const totalRevenue = totalPlays * COIN_VALUE;
                    
                    // 儲存今天的快照
                    await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('dailySnapshots').doc(today).set({
                            date: today,
                            storeName: storeInfo.name,
                            totalPlays: totalPlays,
                            totalPayouts: totalPayouts,
                            totalRevenue: totalRevenue,
                            machineCount: machinesSnapshot.size,
                            machineDetails: machineDetails,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    // 如果需要，也建立昨天的快照（作為基準，數值設為0）
                    if (alsoCreateYesterday) {
                        await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId)
                            .collection('dailySnapshots').doc(yesterday).set({
                                date: yesterday,
                                storeName: storeInfo.name,
                                totalPlays: 0,  // 昨天的基準設為0，這樣今天的增量就是今天的累計
                                totalPayouts: 0,
                                totalRevenue: 0,
                                machineCount: machinesSnapshot.size,
                                machineDetails: [],
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                isBaseline: true  // 標記這是基準快照
                            });
                    }
                    
                    successCount++;
                }
                
                // 恢復按鈕
                const snapshotBtnSuccess = document.getElementById('cc-snapshot-btn');
                if (snapshotBtnSuccess) {
                    snapshotBtnSuccess.disabled = false;
                    snapshotBtnSuccess.innerHTML = '📸 建立快照';
                }
                
                let successMsg = `✅ 成功建立 ${successCount} 個門市的每日快照！\n\n日期: ${today}`;
                if (alsoCreateYesterday) {
                    successMsg += `\n\n📌 已同時建立昨天的基準快照，現在「今日」數據會顯示今天的累計值。`;
                } else {
                    successMsg += `\n\n💡 明天再建立一次快照後，「今日」數據就會顯示正確的增量了。`;
                }
                alert(successMsg);
                
                // 重新載入數據
                loadCommandCenterData();
                
            } catch (error) {
                console.error('建立每日快照失敗:', error);
                alert('❌ 建立快照失敗: ' + error.message);
                
                // 恢復按鈕
                const snapshotBtnError = document.getElementById('cc-snapshot-btn');
                if (snapshotBtnError) {
                    snapshotBtnError.disabled = false;
                    snapshotBtnError.innerHTML = '📸 建立快照';
                }
            }
        }
        
        // 計算單一門市的統計數據 (優先使用 history 記帳歷史紀錄)
        async function calculateStoreStatsForCC(storeId, storeInfo) {
            try {
                const period = document.getElementById('command-center-period')?.value || 'week';
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                let periodStartStr = todayStr;
                
                // 🔧 計算期間開始日期
                switch(period) {
                    case 'today':
                        periodStartStr = todayStr;
                        break;
                    case 'week':
                        const weekAgo = new Date(now);
                        weekAgo.setDate(now.getDate() - 6); // 包含今天共7天
                        periodStartStr = weekAgo.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthAgo = new Date(now);
                        monthAgo.setDate(now.getDate() - 29); // 包含今天共30天
                        periodStartStr = monthAgo.toISOString().split('T')[0];
                        break;
                    case 'current':
                    case 'all':
                        periodStartStr = '2020-01-01';
                        break;
                }
                
                // 獲取機台數據
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('machines').get();
                const machineCount = machinesSnapshot.size;
                
                // 🔧 計算當前總累計（用於 all 和 fallback）
                let totalPlays = 0;
                let totalPayouts = 0;
                machinesSnapshot.docs.forEach(doc => {
                    const machine = doc.data();
                    const machinePlays = machine.plays || machine.totalPlays || 0;
                    const initialPlays = machine.initialPlays || 0;
                    const playsCalibration = machine.playsCalibration || 0;
                    totalPlays += Math.max(0, (machinePlays - initialPlays) + playsCalibration);
                    
                    const machinePayouts = machine.payouts || machine.totalPayouts || 0;
                    const initialPayouts = machine.initialPayouts || 0;
                    const payoutsCalibration = machine.payoutsCalibration || 0;
                    totalPayouts += Math.max(0, (machinePayouts - initialPayouts) + payoutsCalibration);
                });
                
                let plays = 0;
                let payouts = 0;
                let dataSource = 'fallback';
                
                if (period === 'all') {
                    // 全部期間：直接使用總累計
                    plays = totalPlays;
                    payouts = totalPayouts;
                    dataSource = 'total';
                } else if (period === 'current') {
                    // 當期（未結帳）：使用最後結帳記錄作為基準
                    try {
                        const checkoutsSnapshot = await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId).collection('checkouts')
                            .orderBy('checkoutDate', 'desc').limit(1).get();
                        
                        if (!checkoutsSnapshot.empty) {
                            const lastCheckout = checkoutsSnapshot.docs[0].data();
                            const baselineRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                            const baselinePlays = Math.round(baselineRevenue / COIN_VALUE);
                            const baselinePayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                            
                            plays = Math.max(0, totalPlays - baselinePlays);
                            payouts = Math.max(0, totalPayouts - baselinePayouts);
                            dataSource = 'checkout';
                        } else {
                            plays = totalPlays;
                            payouts = totalPayouts;
                            dataSource = 'total';
                        }
                    } catch (e) {
                        plays = totalPlays;
                        payouts = totalPayouts;
                    }
                } else {
                    // 🔧 今日/本週/本月：優先使用 history 記帳歷史紀錄
                    try {
                        const historySnapshot = await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId)
                            .collection('history')
                            .where('date', '>=', periodStartStr)
                            .where('date', '<=', todayStr)
                            .get();
                        
                        if (!historySnapshot.empty) {
                            // 有歷史記錄，加總期間內的 newPlays 和 newPayouts
                            historySnapshot.docs.forEach(doc => {
                                const record = doc.data();
                                plays += record.newPlays || record.dailyPlays || 0;
                                payouts += record.newPayouts || record.dailyPayouts || 0;
                            });
                            dataSource = 'history';
                            console.log(`📊 ${storeInfo.name}: 從 history 找到 ${historySnapshot.size} 筆記錄`);
                        }
                    } catch (historyError) {
                        console.warn(`獲取 history 失敗:`, historyError);
                    }
                    
                    // 🔧 如果 history 沒有數據，嘗試使用快照
                    if (dataSource === 'fallback') {
                        try {
                            const baselineDate = new Date(periodStartStr);
                            baselineDate.setDate(baselineDate.getDate() - 1);
                            const baselineDateStr = baselineDate.toISOString().split('T')[0];
                            
                            const snapshotDoc = await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(storeId)
                                .collection('dailySnapshots').doc(baselineDateStr).get();
                            
                            if (snapshotDoc.exists) {
                                const snapshot = snapshotDoc.data();
                                plays = Math.max(0, totalPlays - (snapshot.totalPlays || 0));
                                payouts = Math.max(0, totalPayouts - (snapshot.totalPayouts || 0));
                                dataSource = 'snapshot';
                            }
                        } catch (snapshotError) {
                            console.warn(`獲取快照失敗:`, snapshotError);
                        }
                    }
                    
                    // 🔧 最後 fallback：使用結帳基準
                    if (dataSource === 'fallback') {
                        try {
                            const checkoutsSnapshot = await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(storeId).collection('checkouts')
                                .orderBy('checkoutDate', 'desc').limit(1).get();
                            
                            if (!checkoutsSnapshot.empty) {
                                const lastCheckout = checkoutsSnapshot.docs[0].data();
                                const baselineRevenue = lastCheckout.cumulativeRevenueAtCheckout || 0;
                                const baselinePlays = Math.round(baselineRevenue / COIN_VALUE);
                                const baselinePayouts = lastCheckout.cumulativePayoutsAtCheckout || 0;
                                
                                plays = Math.max(0, totalPlays - baselinePlays);
                                payouts = Math.max(0, totalPayouts - baselinePayouts);
                                dataSource = 'checkout';
                            } else {
                                plays = totalPlays;
                                payouts = totalPayouts;
                                dataSource = 'total';
                            }
                        } catch (e) {
                            plays = totalPlays;
                            payouts = totalPayouts;
                            dataSource = 'total';
                        }
                    }
                }
                
                console.log(`📊 戰情室-${storeInfo.name || storeId}: period=${period}, plays=${plays}, payouts=${payouts}, source=${dataSource}`);
                
                const revenue = plays * COIN_VALUE;
                const avgCost = payouts > 0 ? Math.round(revenue / payouts) : 0;
                
                return {
                    plays,
                    payouts,
                    revenue,
                    avgCost,
                    machineCount,
                    dataSource,
                    startDate: storeInfo.startDate
                };
                
            } catch (error) {
                console.error(`計算門市 ${storeId} 統計失敗:`, error);
                return { plays: 0, payouts: 0, revenue: 0, avgCost: 0, machineCount: 0 };
            }
        }
        
        // 更新 KPI 卡片
        function updateKPICards(revenue, plays, payouts, machines, activeStores, totalStores) {
            document.getElementById('cc-total-revenue').textContent = `$${revenue.toLocaleString()}`;
            document.getElementById('cc-total-plays').textContent = plays.toLocaleString();
            document.getElementById('cc-total-payouts').textContent = payouts.toLocaleString();
            document.getElementById('cc-active-stores').textContent = `${activeStores}/${totalStores}`;
            document.getElementById('cc-total-machines').textContent = machines.toString();
            
            const avgCost = payouts > 0 ? Math.round(revenue / payouts) : 0;
            document.getElementById('cc-avg-cost').textContent = `$${avgCost}`;
            
            // 成本狀態
            const costStatusEl = document.getElementById('cc-cost-status');
            if (avgCost === 0) {
                costStatusEl.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300">● 無數據</span>';
            } else if (avgCost <= 250) {
                costStatusEl.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-900 text-red-300">● 成本過低</span>';
            } else if (avgCost <= 350) {
                costStatusEl.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-300">● 正常</span>';
            } else {
                costStatusEl.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-900 text-yellow-300">● 偏高</span>';
            }
        }
        
        // 更新門市排行榜
        function updateStoreRanking() {
            const container = document.getElementById('cc-store-ranking');
            
            // 依營收排序
            const sortedStores = [...commandCenterData.stores].sort((a, b) => b.revenue - a.revenue);
            
            if (sortedStores.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">暫無門市數據</p>';
                return;
            }
            
            const maxRevenue = sortedStores[0]?.revenue || 1;
            
            container.innerHTML = sortedStores.slice(0, 5).map((store, index) => {
                const percentage = maxRevenue > 0 ? (store.revenue / maxRevenue * 100) : 0;
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                
                return `
                    <div class="flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg hover:bg-gray-700/50 transition cursor-pointer" onclick="navigateToStore('${store.id}')">
                        <span class="text-2xl w-10 text-center">${medal}</span>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-white font-medium">${store.name}</span>
                                <span class="text-green-400 font-bold">$${store.revenue.toLocaleString()}</span>
                            </div>
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>投幣: ${store.plays.toLocaleString()}</span>
                                <span>出貨: ${store.payouts.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 導航到特定門市
        function navigateToStore(storeId) {
            const store = commandCenterData.stores.find(s => s.id === storeId);
            if (store) {
                hideCommandCenter();
                // 觸發門市選擇
                setTimeout(() => {
                    const storeCard = document.querySelector(`[data-store-id="${storeId}"]`);
                    if (storeCard) {
                        storeCard.click();
                    }
                }, 100);
            }
        }
        
        // 更新營收趨勢圖 (使用 Firestore 語法)
        async function updateRevenueTrendChart() {
            const chartContainer = document.getElementById('cc-revenue-trend-chart');
            const labelsContainer = document.getElementById('cc-trend-labels');
            
            // 獲取最近7天的數據
            const days = 7;
            const dailyRevenue = [];
            const labels = [];
            
            // 🔧 使用每日快照計算各天的增量
            let hasSnapshotData = false;
            
            // 先獲取所有門市過去 8 天的快照（需要額外一天來計算增量）
            const snapshotsByDate = {}; // { '2024-01-01': { storeId: snapshot } }
            
            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                snapshotsByDate[dateStr] = {};
                
                for (const store of commandCenterData.stores) {
                    try {
                        const snapshotDoc = await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(store.id)
                            .collection('dailySnapshots').doc(dateStr).get();
                        
                        if (snapshotDoc.exists) {
                            snapshotsByDate[dateStr][store.id] = snapshotDoc.data();
                            hasSnapshotData = true;
                        }
                    } catch (e) {
                        // 忽略錯誤
                    }
                }
            }
            
            // 計算每日增量
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const prevDate = new Date(date);
                prevDate.setDate(prevDate.getDate() - 1);
                const prevDateStr = prevDate.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }));
                
                let dayRevenue = 0;
                
                if (hasSnapshotData) {
                    for (const store of commandCenterData.stores) {
                        const todaySnap = snapshotsByDate[dateStr]?.[store.id];
                        const prevSnap = snapshotsByDate[prevDateStr]?.[store.id];
                        
                        if (todaySnap && prevSnap) {
                            const dayPlays = (todaySnap.totalPlays || 0) - (prevSnap.totalPlays || 0);
                            dayRevenue += Math.max(0, dayPlays) * COIN_VALUE;
                        } else if (todaySnap && !prevSnap) {
                            // 只有今天的快照，可能是第一天
                            dayRevenue += todaySnap.totalRevenue || 0;
                        }
                    }
                }
                
                dailyRevenue.push(dayRevenue);
            }
            
            // 🔧 如果沒有快照數據，嘗試從 history 集合獲取
            if (!hasSnapshotData) {
                dailyRevenue.length = 0;
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    let dayRevenue = 0;
                    for (const store of commandCenterData.stores) {
                        try {
                            const historySnapshot = await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(store.id)
                                .collection('history')
                                .where('date', '==', dateStr)
                                .get();
                            
                            historySnapshot.forEach(doc => {
                                const record = doc.data();
                                const plays = record.dailyPlays || record.newPlays || 0;
                                dayRevenue += plays * COIN_VALUE;
                            });
                        } catch (e) {
                            console.warn(`獲取 ${store.name} ${dateStr} 數據失敗`);
                        }
                    }
                    dailyRevenue.push(dayRevenue);
                }
                
                // 如果還是沒有數據，顯示當期總計
                const hasHistory = dailyRevenue.some(r => r > 0);
                if (!hasHistory) {
                    const totalRevenue = commandCenterData.stores.reduce((sum, s) => sum + s.revenue, 0);
                    for (let i = 0; i < days; i++) {
                        if (i === days - 1) {
                            dailyRevenue[i] = totalRevenue;
                        } else {
                            dailyRevenue[i] = 0;
                        }
                    }
                }
            }
            
            const maxRevenue = Math.max(...dailyRevenue, 1);
            
            // 生成長條圖
            chartContainer.innerHTML = dailyRevenue.map((revenue, index) => {
                const height = Math.max((revenue / maxRevenue * 100), 5);
                const isToday = index === dailyRevenue.length - 1;
                const barClass = isToday ? 'cc-trend-bar-today' : 'cc-trend-bar';
                return `
                    <div class="flex-1 flex flex-col items-center justify-end h-full">
                        <span class="text-xs text-gray-400 mb-1">$${revenue.toLocaleString()}</span>
                        <div class="${barClass} w-full" style="height: ${height}%" title="${labels[index]}: $${revenue.toLocaleString()}"></div>
                    </div>
                `;
            }).join('');
            
            // 生成日期標籤
            labelsContainer.innerHTML = labels.map(label => `<span>${label}</span>`).join('');
        }
        
        // 更新異常警示
        function updateAlerts() {
            const container = document.getElementById('cc-alerts');
            const alerts = [];
            
            // 檢查各種異常
            for (const store of commandCenterData.stores) {
                // 營收異常低
                if (store.plays === 0) {
                    alerts.push({
                        type: 'warning',
                        icon: '🟡',
                        message: `${store.name} 期間內無投幣記錄`,
                        priority: 2
                    });
                }
                
                // 成本異常
                if (store.avgCost > 0 && store.avgCost < 200) {
                    alerts.push({
                        type: 'danger',
                        icon: '🔴',
                        message: `${store.name} 平均成本過低 ($${store.avgCost})`,
                        priority: 1
                    });
                }
                
                if (store.avgCost > 500) {
                    alerts.push({
                        type: 'warning',
                        icon: '🟡',
                        message: `${store.name} 平均成本偏高 ($${store.avgCost})`,
                        priority: 2
                    });
                }
            }
            
            // 按優先級排序
            alerts.sort((a, b) => a.priority - b.priority);
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center gap-3 p-3 bg-green-900/30 rounded-lg border border-green-500/30">
                        <span class="text-2xl">✅</span>
                        <span class="text-green-300">所有門市運作正常</span>
                    </div>
                `;
            } else {
                container.innerHTML = alerts.slice(0, 5).map(alert => {
                    const bgColor = alert.type === 'danger' ? 'bg-red-900/30 border-red-500/30' : 'bg-yellow-900/30 border-yellow-500/30';
                    const textColor = alert.type === 'danger' ? 'text-red-300' : 'text-yellow-300';
                    return `
                        <div class="cc-alert-item flex items-center gap-3 p-3 ${bgColor} rounded-lg border">
                            <span class="text-xl">${alert.icon}</span>
                            <span class="${textColor} text-sm">${alert.message}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // 更新快速統計
        function updateQuickStats() {
            // 最高營收門市
            const topStore = [...commandCenterData.stores].sort((a, b) => b.revenue - a.revenue)[0];
            document.getElementById('cc-top-store').textContent = topStore ? topStore.name : '--';
            
            // 🔧 計算營業天數
            const totalRevenue = commandCenterData.stores.reduce((sum, s) => sum + s.revenue, 0);
            const period = document.getElementById('command-center-period')?.value || 'all';
            
            // 計算實際營業天數
            let days = 1;
            switch(period) {
                case 'today':
                    days = 1;
                    break;
                case 'week':
                    days = 7;
                    break;
                case 'month':
                    days = 30;
                    break;
                case 'current':
                    // 當期（未結帳）：估算天數，假設約 7 天一結帳
                    days = 7;
                    break;
                case 'all':
                    // 全部期間：找出最早的開店日期
                    let earliestDate = new Date();
                    commandCenterData.stores.forEach(store => {
                        if (store.startDate) {
                            const storeStart = new Date(store.startDate);
                            if (storeStart < earliestDate) earliestDate = storeStart;
                        }
                    });
                    days = Math.max(1, Math.ceil((new Date() - earliestDate) / (1000 * 60 * 60 * 24)));
                    break;
            }
            
            const dailyAvg = Math.round(totalRevenue / days);
            document.getElementById('cc-daily-avg').textContent = `$${dailyAvg.toLocaleString()}`;
            
            // 🔧 最佳機台（從 TOP 10 取第一名）
            const topMachinesContainer = document.getElementById('cc-top-machines');
            if (topMachinesContainer && topMachinesContainer.querySelector('.cc-machine-card')) {
                const firstCard = topMachinesContainer.querySelector('.cc-machine-card h4');
                if (firstCard) {
                    document.getElementById('cc-top-machine').textContent = firstCard.textContent;
                }
            }
        }
        
        // 更新待處理事項
        function updatePendingItems() {
            const container = document.getElementById('cc-pending-items');
            const items = [];
            
            // 檢查需要結帳的門市
            for (const store of commandCenterData.stores) {
                if (store.plays > 100) {
                    items.push({
                        icon: '💰',
                        text: `${store.name} 建議結帳`,
                        action: 'checkout'
                    });
                }
            }
            
            // 檢查機台數量少的門市
            for (const store of commandCenterData.stores) {
                if (store.machineCount === 0) {
                    items.push({
                        icon: '🎰',
                        text: `${store.name} 尚未設定機台`,
                        action: 'setup'
                    });
                }
            }
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <span class="text-2xl">👍</span>
                        <p class="mt-2">目前沒有待處理事項</p>
                    </div>
                `;
            } else {
                container.innerHTML = items.slice(0, 5).map(item => `
                    <div class="flex items-center gap-3 p-2 bg-gray-900/50 rounded-lg hover:bg-gray-700/50 transition cursor-pointer">
                        <span class="text-lg">${item.icon}</span>
                        <span class="text-gray-300 text-sm">${item.text}</span>
                    </div>
                `).join('');
            }
        }
        
        // 更新門市表格
        function updateStoresTable() {
            const tbody = document.getElementById('cc-stores-table');
            const sortedStores = [...commandCenterData.stores].sort((a, b) => b.revenue - a.revenue);
            
            if (sortedStores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">暫無門市數據</td></tr>';
                return;
            }
            
            tbody.innerHTML = sortedStores.map((store, index) => {
                const statusClass = store.plays > 0 ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-300';
                const statusText = store.plays > 0 ? '營業中' : '無數據';
                const trend = store.revenue > 0 ? '📈' : '➖';
                
                return `
                    <tr class="hover:bg-gray-700/50 transition cursor-pointer" onclick="navigateToStore('${store.id}')">
                        <td class="p-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-yellow-600' : 'bg-gray-600'} text-white font-bold">${index + 1}</span>
                        </td>
                        <td class="p-4 font-medium text-white">${store.name}</td>
                        <td class="p-4 text-right text-green-400 font-bold">$${store.revenue.toLocaleString()}</td>
                        <td class="p-4 text-right text-blue-400">${store.plays.toLocaleString()}</td>
                        <td class="p-4 text-right text-purple-400">${store.payouts.toLocaleString()}</td>
                        <td class="p-4 text-right text-yellow-400">$${store.avgCost || '--'}</td>
                        <td class="p-4 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                        </td>
                        <td class="p-4 text-center text-xl">${trend}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // 更新機台績效 TOP 10 (使用 Firestore 語法)
        async function updateTopMachines() {
            const container = document.getElementById('cc-top-machines');
            const allMachines = [];
            const period = document.getElementById('command-center-period')?.value || 'week';
            
            // 收集所有門市的機台數據
            for (const store of commandCenterData.stores) {
                try {
                    // 獲取機台列表 (Firestore)
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    
                    // 🔧 獲取該門市最後結帳記錄
                    let lastCheckoutData = {};
                    if (period !== 'all') {
                        try {
                            const lastCheckoutSnapshot = await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(store.id).collection('checkouts')
                                .orderBy('checkoutDate', 'desc').limit(1).get();
                            
                            if (!lastCheckoutSnapshot.empty) {
                                const lastCheckout = lastCheckoutSnapshot.docs[0].data();
                                // 獲取結帳時各機台的數據
                                if (lastCheckout.machineDetails) {
                                    lastCheckout.machineDetails.forEach(m => {
                                        lastCheckoutData[m.machineId || m.id] = {
                                            plays: m.plays || 0,
                                            payouts: m.payouts || 0
                                        };
                                    });
                                }
                            }
                        } catch (e) {
                            console.warn(`獲取 ${store.name} 結帳記錄失敗:`, e);
                        }
                    }
                    
                    // 🔧 直接從機台資料計算
                    machinesSnapshot.forEach(doc => {
                        const machine = doc.data();
                        const machineId = doc.id;
                        
                        // 計算有效投幣和出貨（支援多種欄位名稱 + 校正值）
                        const machinePlays = machine.plays || machine.totalPlays || 0;
                        const machinePayouts = machine.payouts || machine.totalPayouts || 0;
                        const playsCalibration = machine.playsCalibration || 0;
                        const payoutsCalibration = machine.payoutsCalibration || 0;
                        
                        const totalPlays = (machinePlays - (machine.initialPlays || 0)) + playsCalibration;
                        const totalPayouts = (machinePayouts - (machine.initialPayouts || 0)) + payoutsCalibration;
                        
                        let plays = Math.max(0, totalPlays);
                        let payouts = Math.max(0, totalPayouts);
                        
                        // 如果不是全部期間，扣除結帳時的數據
                        if (period !== 'all') {
                            const checkoutInfo = lastCheckoutData[machineId] || lastCheckoutData[machine.id] || { plays: 0, payouts: 0 };
                            plays = Math.max(0, totalPlays - checkoutInfo.plays);
                            payouts = Math.max(0, totalPayouts - checkoutInfo.payouts);
                        }
                        
                        const revenue = plays * (typeof COIN_VALUE !== 'undefined' ? COIN_VALUE : 10);
                        
                        allMachines.push({
                            id: machine.id || machineId,
                            location: machine.location || '未設定',
                            storeName: store.name,
                            plays: plays,
                            payouts: payouts,
                            revenue: revenue,
                            avgCost: payouts > 0 ? Math.round(revenue / payouts) : 0
                        });
                    });
                } catch (e) {
                    console.warn(`獲取 ${store.name} 機台數據失敗:`, e);
                }
            }
            
            // 依營收排序
            const sortBy = document.getElementById('cc-machine-sort')?.value || 'revenue';
            allMachines.sort((a, b) => {
                if (sortBy === 'plays') return b.plays - a.plays;
                if (sortBy === 'efficiency') return b.avgCost - a.avgCost;
                return b.revenue - a.revenue;
            });
            
            const topMachines = allMachines.slice(0, 10);
            
            if (topMachines.length === 0 || topMachines.every(m => m.plays === 0)) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 col-span-full">當期暫無機台數據</p>';
                return;
            }
            
            container.innerHTML = topMachines.map((machine, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                return `
                    <div class="cc-machine-card bg-gray-900/50 rounded-lg p-4 border border-gray-700/50">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-lg">${medal || `#${index + 1}`}</span>
                            <span class="text-xs text-gray-400">${machine.storeName}</span>
                        </div>
                        <h4 class="text-white font-medium mb-1">${machine.id}</h4>
                        <p class="text-xs text-gray-400 mb-3">${machine.location}</p>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">營收</span>
                                <span class="text-green-400">$${machine.revenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">投幣</span>
                                <span class="text-blue-400">${machine.plays.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">成本</span>
                                <span class="text-yellow-400">$${machine.avgCost}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 匯出戰情室報表
        function exportCommandCenterReport() {
            const data = commandCenterData.stores.map((store, index) => ({
                排名: index + 1,
                門市名稱: store.name,
                營收: store.revenue,
                投幣數: store.plays,
                出貨數: store.payouts,
                平均成本: store.avgCost,
                機台數: store.machineCount
            }));
            
            // 建立 CSV
            const headers = Object.keys(data[0] || {});
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => row[h]).join(','))
            ].join('\n');
            
            // 下載
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `戰情室報表_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // 戰情室事件綁定
        document.getElementById('open-command-center-btn')?.addEventListener('click', showCommandCenter);
        document.getElementById('back-from-command-center-btn')?.addEventListener('click', hideCommandCenter);
        document.getElementById('refresh-command-center-btn')?.addEventListener('click', loadCommandCenterData);
        document.getElementById('cc-export-data-btn')?.addEventListener('click', exportCommandCenterReport);
        
        // 📸 快照按鈕
        document.getElementById('cc-snapshot-btn')?.addEventListener('click', createDailySnapshot);
        
        // 期間選擇變更
        document.getElementById('command-center-period')?.addEventListener('change', loadCommandCenterData);
        
        // 排行榜期間切換
        document.querySelectorAll('.cc-rank-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.cc-rank-period-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('bg-gray-700', 'text-gray-300');
                    b.classList.remove('bg-blue-600', 'text-white');
                });
                this.classList.add('active');
                this.classList.remove('bg-gray-700', 'text-gray-300');
                this.classList.add('bg-blue-600', 'text-white');
                
                // 🔧 同步期間選擇並重新載入數據
                const period = this.getAttribute('data-period');
                const periodSelect = document.getElementById('command-center-period');
                if (periodSelect && period) {
                    periodSelect.value = period;
                    loadCommandCenterData();
                }
            });
        });
        
        // 機台排序變更
        document.getElementById('cc-machine-sort')?.addEventListener('change', updateTopMachines);
        
        // 將函數暴露到全局
        window.showCommandCenter = showCommandCenter;
        window.hideCommandCenter = hideCommandCenter;
        window.navigateToStore = navigateToStore;
        
        // ========================================
        // 戰情室功能結束
        // ========================================
        
        // ========================================
        // 🎁 禮品管理系統
        // ========================================
        
        // 全域變數
        let giftsData = [];
        
        // 載入禮品資料
        async function loadGiftsData() {
            try {
                if (!selectedGroupId) return [];
                const giftsRef = db.collection('groups').doc(selectedGroupId).collection('gifts');
                const snapshot = await giftsRef.orderBy('itemNo', 'asc').get();
                giftsData = [];
                snapshot.forEach(doc => {
                    giftsData.push({ id: doc.id, ...doc.data() });
                });
                console.log(`✅ 已載入 ${giftsData.length} 個禮品`);
                return giftsData;
            } catch (error) {
                console.error('載入禮品失敗:', error);
                return [];
            }
        }
        
        // 解析 Excel 日期
        function parseExcelDate(value) {
            if (!value) return null;
            if (typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            if (typeof value === 'string') {
                const parsed = new Date(value);
                if (!isNaN(parsed)) {
                    return parsed.toISOString().split('T')[0];
                }
            }
            return value;
        }
        
        // 從 Excel 中提取嵌入的圖片
        async function extractImagesFromExcel(arrayBuffer) {
            const images = {};
            
            try {
                // 使用 JSZip 解析 xlsx（xlsx 實際上是 zip 格式）
                // 由於沒有 JSZip，我們用 XLSX 的內建功能
                const workbook = XLSX.read(arrayBuffer, { 
                    type: 'array',
                    cellStyles: true,
                    bookImages: true
                });
                
                // 檢查是否有圖片資料
                if (workbook.Workbook && workbook.Workbook.Sheets) {
                    console.log('📊 Workbook 結構:', Object.keys(workbook));
                }
                
                // 嘗試從 workbook 中讀取圖片
                // SheetJS 免費版對圖片支援有限，嘗試讀取 media
                if (workbook.Media) {
                    console.log('📷 找到 Media:', workbook.Media);
                }
                
                // 嘗試讀取 Drawings
                if (workbook.Drawings) {
                    console.log('🎨 找到 Drawings:', workbook.Drawings);
                }
                
            } catch (error) {
                console.warn('提取圖片時發生錯誤:', error);
            }
            
            return images;
        }
        
        // 從 Excel 匯入禮品資料（支援嵌入圖片）
        async function importGiftsFromExcel(file) {
            // 顯示進度彈窗
            const progressModal = document.createElement('div');
            progressModal.id = 'importProgressModal';
            progressModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[70]';
            progressModal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 text-center">
                    <div class="text-4xl mb-4">📥</div>
                    <h3 class="text-xl font-bold text-white mb-2">正在匯入禮品資料</h3>
                    <p id="importProgressText" class="text-gray-400 mb-4">讀取 Excel 檔案...</p>
                    <div class="w-full bg-gray-700 rounded-full h-4 mb-2">
                        <div id="importProgressBar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="importProgressDetail" class="text-sm text-gray-500"></p>
                </div>
            `;
            document.body.appendChild(progressModal);
            
            const updateProgress = (text, percent, detail = '') => {
                document.getElementById('importProgressText').textContent = text;
                document.getElementById('importProgressBar').style.width = percent + '%';
                document.getElementById('importProgressDetail').textContent = detail;
            };
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        updateProgress('解析 Excel 資料...', 10);
                        
                        const arrayBuffer = e.target.result;
                        const data = new Uint8Array(arrayBuffer);
                        
                        // 嘗試用完整選項讀取 workbook
                        const workbook = XLSX.read(data, { 
                            type: 'array',
                            cellStyles: true,
                            cellDates: true,
                            bookImages: true,
                            raw: false
                        });
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // 取得表格範圍
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                        console.log('📊 表格範圍:', range);
                        
                        // 嘗試提取圖片（如果 xlsx 中有的話）
                        let embeddedImages = {};
                        try {
                            // 嘗試用 JSZip 方式讀取圖片（需要手動解析 zip）
                            embeddedImages = await extractEmbeddedImagesFromZip(arrayBuffer);
                            console.log('📷 提取到的嵌入圖片:', Object.keys(embeddedImages).length);
                        } catch (imgErr) {
                            console.warn('無法提取嵌入圖片:', imgErr);
                        }
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                        
                        updateProgress('分析欄位結構...', 20);
                        
                        // 找到標題列
                        let headerRowIndex = 0;
                        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                            if (jsonData[i] && jsonData[i].some(cell => cell && String(cell).includes('商品名稱'))) {
                                headerRowIndex = i;
                                break;
                            }
                        }
                        
                        const headers = jsonData[headerRowIndex];
                        const dataRows = jsonData.slice(headerRowIndex + 1);
                        
                        // 欄位對應
                        const columnMap = {
                            '項次': 'itemNo',
                            '商品名稱': 'name',
                            '商品圖片': 'imageCol',
                            '保夾金額': 'cost',
                            'BSMI': 'bsmi',
                            'IP授權廠商': 'ipLicensor',
                            '進口廠商': 'importer',
                            '購買商家': 'supplier',
                            '發票號碼': 'invoiceNo',
                            '法務通過': 'legalApprovalDate',
                            '品保通過': 'qaApprovalDate',
                            '肖像授權到期': 'licenseExpireDate',
                            '授權到期': 'licenseExpireDate'
                        };
                        
                        // 建立欄位索引
                        const colIndex = {};
                        headers.forEach((header, index) => {
                            if (!header) return;
                            const headerStr = String(header);
                            for (const [key, value] of Object.entries(columnMap)) {
                                if (headerStr.includes(key)) {
                                    colIndex[value] = index;
                                    break;
                                }
                            }
                        });
                        
                        console.log('📋 欄位對應:', colIndex);
                        console.log('📊 資料列數:', dataRows.length);
                        
                        // 過濾有效資料列
                        const validRows = dataRows.filter(row => row && row[colIndex.name]);
                        const totalRows = validRows.length;
                        
                        updateProgress(`準備匯入 ${totalRows} 個禮品...`, 25);
                        
                        // 處理資料
                        let count = 0;
                        let imageCount = 0;
                        const giftsRef = db.collection('groups').doc(selectedGroupId).collection('gifts');
                        
                        for (let i = 0; i < validRows.length; i++) {
                            const row = validRows[i];
                            const rowIndex = i + headerRowIndex + 2; // Excel 列號 (1-indexed + header)
                            
                            const percent = 25 + Math.round((i / totalRows) * 70);
                            updateProgress(`處理禮品 ${i + 1}/${totalRows}...`, percent, row[colIndex.name]);
                            
                            let imageUrl = '';
                            
                            // 檢查是否有對應的嵌入圖片
                            // Excel 的列號是資料列號 + 標題列 + 1（因為有範例列）
                            // 圖片欄位是 C 欄 = 欄號 3 (1-indexed)
                            const imageColNum = (colIndex.imageCol !== undefined ? colIndex.imageCol : 2) + 1;
                            
                            // 嘗試多種可能的 key 格式
                            const possibleKeys = [
                                `${rowIndex}_${imageColNum}`,       // 原始格式: row_col
                                `${rowIndex}_3`,                    // 固定 C 欄
                                `${rowIndex}_2`,                    // 固定 B 欄
                                `${i + 2}_${imageColNum}`,          // 使用資料索引
                                `${i + 2}_3`,                       // 資料索引 + C欄
                                `${i + 3}_${imageColNum}`,          // +1 offset
                                `${i + 3}_3`
                            ];
                            
                            let imageData = null;
                            for (const key of possibleKeys) {
                                if (embeddedImages[key]) {
                                    imageData = embeddedImages[key];
                                    console.log(`🎯 找到圖片 key: ${key}`);
                                    break;
                                }
                            }
                            
                            if (imageData) {
                                try {
                                    updateProgress(`上傳圖片 ${i + 1}/${totalRows}...`, percent, row[colIndex.name]);
                                    // 壓縮並上傳圖片
                                    const compressedBlob = await compressImageFromBlob(imageData);
                                    imageUrl = await uploadGiftImage(compressedBlob, `gift_${Date.now()}_${i}.jpg`);
                                    imageCount++;
                                    console.log(`✅ 圖片 ${i + 1} 上傳成功`);
                                } catch (imgErr) {
                                    console.warn(`圖片 ${i + 1} 處理失敗:`, imgErr);
                                }
                            } else if (row[colIndex.imageCol] && typeof row[colIndex.imageCol] === 'string' && row[colIndex.imageCol].startsWith('http')) {
                                // 如果是 URL 則直接使用
                                imageUrl = row[colIndex.imageCol];
                            }
                            
                            const gift = {
                                itemNo: parseInt(row[colIndex.itemNo]) || count + 1,
                                name: String(row[colIndex.name] || '').trim(),
                                imageUrl: imageUrl,
                                cost: parseFloat(String(row[colIndex.cost] || '0').replace(/[^\d.]/g, '')) || 0,
                                bsmi: String(row[colIndex.bsmi] || '').trim(),
                                ipLicensor: String(row[colIndex.ipLicensor] || '').trim(),
                                importer: String(row[colIndex.importer] || '').trim(),
                                supplier: String(row[colIndex.supplier] || '').trim(),
                                invoiceNo: String(row[colIndex.invoiceNo] || '').trim(),
                                legalApprovalDate: parseExcelDate(row[colIndex.legalApprovalDate]),
                                qaApprovalDate: parseExcelDate(row[colIndex.qaApprovalDate]),
                                licenseExpireDate: parseExcelDate(row[colIndex.licenseExpireDate]),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            if (!gift.name) continue;
                            
                            await giftsRef.add(gift);
                            count++;
                        }
                        
                        updateProgress('匯入完成！', 100, `${count} 個禮品，${imageCount} 張圖片`);
                        
                        setTimeout(() => {
                            progressModal.remove();
                            alert(`✅ 成功匯入 ${count} 個禮品！\n📷 上傳了 ${imageCount} 張圖片`);
                        }, 1000);
                        
                        await loadGiftsData();
                        resolve(count);
                    } catch (error) {
                        progressModal.remove();
                        console.error('匯入禮品失敗:', error);
                        alert('❌ 匯入失敗: ' + error.message);
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 從 ZIP 中提取嵌入的圖片
        async function extractEmbeddedImagesFromZip(arrayBuffer) {
            const images = {};
            
            try {
                // 手動解析 xlsx (zip) 格式
                const zip = await parseZipFile(arrayBuffer);
                
                if (!zip) {
                    console.log('⚠️ 無法解析 ZIP 結構');
                    return images;
                }
                
                // 讀取圖片檔案
                const mediaFiles = Object.keys(zip).filter(name => name.startsWith('xl/media/'));
                console.log('📷 找到的媒體檔案:', mediaFiles);
                
                // 讀取圖片與儲存格的對應關係
                const drawingRels = await parseDrawingRelationships(zip);
                const cellAnchors = await parseCellAnchors(zip);
                
                console.log('🔗 繪圖關係:', drawingRels);
                console.log('📍 儲存格錨點:', cellAnchors);
                
                // 建立圖片對應
                for (const anchor of cellAnchors) {
                    const imageFile = drawingRels[anchor.rId];
                    if (imageFile && zip[imageFile]) {
                        const key = `${anchor.row}_${anchor.col}`;
                        images[key] = zip[imageFile];
                        console.log(`📷 對應圖片: 列${anchor.row} 欄${anchor.col} -> ${imageFile}`);
                    }
                }
                
            } catch (error) {
                console.warn('解析嵌入圖片失敗:', error);
            }
            
            return images;
        }
        
        // 簡易 ZIP 解析器
        async function parseZipFile(arrayBuffer) {
            const files = {};
            const view = new DataView(arrayBuffer);
            let offset = 0;
            
            try {
                while (offset < arrayBuffer.byteLength - 4) {
                    const signature = view.getUint32(offset, true);
                    
                    // 本地檔案標頭 (0x04034b50)
                    if (signature === 0x04034b50) {
                        const compressionMethod = view.getUint16(offset + 8, true);
                        const compressedSize = view.getUint32(offset + 18, true);
                        const uncompressedSize = view.getUint32(offset + 22, true);
                        const fileNameLength = view.getUint16(offset + 26, true);
                        const extraFieldLength = view.getUint16(offset + 28, true);
                        
                        const fileNameStart = offset + 30;
                        const fileNameBytes = new Uint8Array(arrayBuffer, fileNameStart, fileNameLength);
                        const fileName = new TextDecoder().decode(fileNameBytes);
                        
                        const dataStart = fileNameStart + fileNameLength + extraFieldLength;
                        const dataSize = compressedSize || uncompressedSize;
                        
                        if (compressionMethod === 0) {
                            // 未壓縮
                            files[fileName] = new Uint8Array(arrayBuffer, dataStart, dataSize);
                        } else if (compressionMethod === 8) {
                            // DEFLATE 壓縮 - 需要解壓縮
                            try {
                                const compressedData = new Uint8Array(arrayBuffer, dataStart, compressedSize);
                                const decompressed = await decompressDeflate(compressedData);
                                files[fileName] = decompressed;
                            } catch (e) {
                                // 如果解壓縮失敗，對於圖片檔案嘗試直接儲存
                                if (fileName.match(/\.(png|jpg|jpeg|gif)$/i)) {
                                    files[fileName] = new Uint8Array(arrayBuffer, dataStart, compressedSize);
                                }
                            }
                        }
                        
                        offset = dataStart + dataSize;
                    } else {
                        offset++;
                    }
                }
            } catch (e) {
                console.warn('ZIP 解析錯誤:', e);
            }
            
            return Object.keys(files).length > 0 ? files : null;
        }
        
        // DEFLATE 解壓縮
        async function decompressDeflate(compressedData) {
            // 使用 DecompressionStream API (現代瀏覽器支援)
            if (typeof DecompressionStream !== 'undefined') {
                try {
                    const ds = new DecompressionStream('deflate-raw');
                    const writer = ds.writable.getWriter();
                    writer.write(compressedData);
                    writer.close();
                    
                    const reader = ds.readable.getReader();
                    const chunks = [];
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                    }
                    
                    const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
                    const result = new Uint8Array(totalLength);
                    let offset = 0;
                    for (const chunk of chunks) {
                        result.set(chunk, offset);
                        offset += chunk.length;
                    }
                    return result;
                } catch (e) {
                    console.warn('DecompressionStream 失敗:', e);
                }
            }
            
            // 回傳原始資料作為後備
            return compressedData;
        }
        
        // 解析繪圖關係
        async function parseDrawingRelationships(zip) {
            const rels = {};
            const relsFile = zip['xl/drawings/_rels/drawing1.xml.rels'];
            
            if (relsFile) {
                const xml = new TextDecoder().decode(relsFile);
                const matches = xml.matchAll(/Id="(rId\d+)"[^>]*Target="([^"]+)"/g);
                for (const match of matches) {
                    const rId = match[1];
                    let target = match[2];
                    if (target.startsWith('../')) {
                        target = 'xl/' + target.substring(3);
                    } else if (!target.startsWith('xl/')) {
                        target = 'xl/drawings/' + target;
                    }
                    rels[rId] = target;
                }
            }
            
            return rels;
        }
        
        // 解析儲存格錨點
        async function parseCellAnchors(zip) {
            const anchors = [];
            const drawingFile = zip['xl/drawings/drawing1.xml'];
            
            if (drawingFile) {
                const xml = new TextDecoder().decode(drawingFile);
                
                // 匹配 twoCellAnchor 中的位置和圖片關係
                const anchorRegex = /<xdr:twoCellAnchor[^>]*>[\s\S]*?<xdr:from>[\s\S]*?<xdr:col>(\d+)<\/xdr:col>[\s\S]*?<xdr:row>(\d+)<\/xdr:row>[\s\S]*?<a:blip[^>]*r:embed="(rId\d+)"/g;
                
                let match;
                while ((match = anchorRegex.exec(xml)) !== null) {
                    anchors.push({
                        col: parseInt(match[1]) + 1, // 轉為 1-indexed
                        row: parseInt(match[2]) + 1, // 轉為 1-indexed  
                        rId: match[3]
                    });
                }
                
                // 如果上面的方法沒找到，嘗試另一種匹配方式
                if (anchors.length === 0) {
                    const simpleRegex = /<xdr:from>[\s\S]*?<xdr:col>(\d+)<\/xdr:col>[\s\S]*?<xdr:row>(\d+)<\/xdr:row>/g;
                    const embedRegex = /r:embed="(rId\d+)"/g;
                    
                    const positions = [...xml.matchAll(simpleRegex)];
                    const embeds = [...xml.matchAll(embedRegex)];
                    
                    for (let i = 0; i < Math.min(positions.length, embeds.length); i++) {
                        anchors.push({
                            col: parseInt(positions[i][1]) + 1,
                            row: parseInt(positions[i][2]) + 1,
                            rId: embeds[i][1]
                        });
                    }
                }
            }
            
            return anchors;
        }
        
        // 從 Blob 壓縮圖片
        async function compressImageFromBlob(uint8Array) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([uint8Array]);
                const img = new Image();
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 300;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((result) => {
                        if (result) {
                            resolve(result);
                        } else {
                            reject(new Error('圖片壓縮失敗'));
                        }
                    }, 'image/jpeg', 0.8);
                    
                    URL.revokeObjectURL(img.src);
                };
                
                img.onerror = () => {
                    URL.revokeObjectURL(img.src);
                    reject(new Error('圖片載入失敗'));
                };
                
                img.src = URL.createObjectURL(blob);
            });
        }
        
        // 顯示禮品管理彈窗
        async function showGiftManagementModal() {
            if (!selectedGroupId) {
                alert('請先選擇群組');
                return;
            }
            
            // 移除已存在的彈窗
            document.getElementById('giftManagementModal')?.remove();
            
            // 重置勾選狀態
            window._selectedGiftIds = new Set();
            
            const modal = document.createElement('div');
            modal.id = 'giftManagementModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">🎁 禮品資料管理</h2>
                        <button onclick="document.getElementById('giftManagementModal').remove()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="flex gap-3 mb-4 flex-wrap">
                        <label class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition">
                            📥 匯入 Excel
                            <input type="file" accept=".xlsx,.xls" onchange="handleGiftFileImport(this)" class="hidden">
                        </label>
                        <button onclick="showAddGiftForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">➕ 新增禮品</button>
                        <button onclick="refreshGiftsList()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">🔄 重新整理</button>
                        <input type="text" id="giftSearchInput" placeholder="搜尋禮品名稱..." 
                               oninput="filterGiftsList(this.value)"
                               class="bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 flex-1 min-w-[200px]">
                    </div>
                    <div class="flex gap-2 mb-3 items-center flex-wrap border-t border-gray-700 pt-3">
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" id="giftSelectAll" onchange="toggleSelectAllGifts(this.checked)" class="w-5 h-5 rounded">
                            <span class="text-sm">全選</span>
                        </label>
                        <span id="selectedGiftCount" class="text-gray-400 text-sm ml-2">已選 0 項</span>
                        <div class="flex-1"></div>
                        <button onclick="deleteSelectedGifts()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-1.5 px-3 rounded-lg transition text-sm">🗑️ 刪除勾選</button>
                        <button onclick="deleteAllGifts()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-lg transition text-sm">⚠️ 全部刪除</button>
                    </div>
                    <div id="giftsListContainer" class="flex-1 overflow-y-auto">
                        <div class="text-center py-8 text-gray-400">載入中...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            await loadAndDisplayGifts();
        }
        
        // 載入並顯示禮品列表
        async function loadAndDisplayGifts() {
            await loadGiftsData();
            renderGiftsList(giftsData);
        }
        
        // 檢查是否即將到期（30天內）
        function isExpiringSoon(dateStr) {
            if (!dateStr) return false;
            const expireDate = new Date(dateStr);
            const now = new Date();
            const diffDays = (expireDate - now) / (1000 * 60 * 60 * 24);
            return diffDays <= 30 && diffDays >= 0;
        }
        
        // 渲染禮品列表
        function renderGiftsList(gifts) {
            const container = document.getElementById('giftsListContainer');
            if (!container) return;
            
            if (!gifts || gifts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="text-6xl mb-4">📦</div>
                        <p class="text-xl mb-2">尚無禮品資料</p>
                        <p class="text-sm">請點擊「匯入 Excel」載入禮品資料</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    ${gifts.map(gift => `
                        <div class="bg-gray-900 rounded-lg p-3 relative group" data-gift-id="${gift.id}">
                            <div class="absolute top-2 left-2 z-10">
                                <input type="checkbox" class="gift-checkbox w-5 h-5 rounded cursor-pointer" 
                                       data-gift-id="${gift.id}" 
                                       onchange="toggleGiftSelection('${gift.id}', this.checked)"
                                       ${window._selectedGiftIds?.has(gift.id) ? 'checked' : ''}>
                            </div>
                            <div class="cursor-pointer" onclick="showGiftDetail('${gift.id}')">
                                <div class="aspect-square bg-gray-800 rounded-lg mb-2 flex items-center justify-center overflow-hidden">
                                    ${gift.imageUrl ? 
                                        `<img src="${gift.imageUrl}" alt="${gift.name}" class="w-full h-full object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-4xl\\'>🎁</span>'">` :
                                        `<span class="text-4xl">🎁</span>`
                                    }
                                </div>
                                <div class="text-white font-medium text-sm truncate" title="${gift.name}">${gift.name}</div>
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>#${gift.itemNo || '-'}</span>
                                    <span class="text-green-400">$${gift.cost || 0}</span>
                                </div>
                                ${gift.licenseExpireDate ? `
                                    <div class="text-xs mt-1 ${isExpiringSoon(gift.licenseExpireDate) ? 'text-red-400' : 'text-gray-500'}">
                                        到期: ${gift.licenseExpireDate}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // 更新選取計數
            updateSelectedGiftCount();
        }
        
        // 篩選禮品列表
        function filterGiftsList(keyword) {
            if (!keyword) {
                renderGiftsList(giftsData);
                return;
            }
            const filtered = giftsData.filter(g => 
                g.name && g.name.toLowerCase().includes(keyword.toLowerCase())
            );
            renderGiftsList(filtered);
        }
        
        // 切換單一禮品勾選
        function toggleGiftSelection(giftId, checked) {
            if (!window._selectedGiftIds) window._selectedGiftIds = new Set();
            
            if (checked) {
                window._selectedGiftIds.add(giftId);
            } else {
                window._selectedGiftIds.delete(giftId);
            }
            
            updateSelectedGiftCount();
            updateSelectAllCheckbox();
        }
        
        // 全選/取消全選
        function toggleSelectAllGifts(checked) {
            if (!window._selectedGiftIds) window._selectedGiftIds = new Set();
            
            const checkboxes = document.querySelectorAll('.gift-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const giftId = cb.dataset.giftId;
                if (checked) {
                    window._selectedGiftIds.add(giftId);
                } else {
                    window._selectedGiftIds.delete(giftId);
                }
            });
            
            updateSelectedGiftCount();
        }
        
        // 更新選取計數
        function updateSelectedGiftCount() {
            const countEl = document.getElementById('selectedGiftCount');
            if (countEl) {
                const count = window._selectedGiftIds?.size || 0;
                countEl.textContent = `已選 ${count} 項`;
            }
        }
        
        // 更新全選框狀態
        function updateSelectAllCheckbox() {
            const selectAllCb = document.getElementById('giftSelectAll');
            const checkboxes = document.querySelectorAll('.gift-checkbox');
            if (selectAllCb && checkboxes.length > 0) {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                selectAllCb.checked = allChecked;
                selectAllCb.indeterminate = someChecked && !allChecked;
            }
        }
        
        // 刪除勾選的禮品
        async function deleteSelectedGifts() {
            if (!window._selectedGiftIds || window._selectedGiftIds.size === 0) {
                alert('請先勾選要刪除的禮品');
                return;
            }
            
            const count = window._selectedGiftIds.size;
            if (!confirm(`確定要刪除勾選的 ${count} 個禮品嗎？\n\n此操作無法復原！`)) {
                return;
            }
            
            try {
                const deletePromises = [];
                for (const giftId of window._selectedGiftIds) {
                    deletePromises.push(
                        db.collection('groups').doc(selectedGroupId).collection('gifts').doc(giftId).delete()
                    );
                }
                
                await Promise.all(deletePromises);
                
                // 更新本地資料
                giftsData = giftsData.filter(g => !window._selectedGiftIds.has(g.id));
                window._selectedGiftIds.clear();
                
                renderGiftsList(giftsData);
                alert(`✅ 已刪除 ${count} 個禮品`);
            } catch (error) {
                alert('❌ 刪除失敗: ' + error.message);
            }
        }
        
        // 刪除全部禮品
        async function deleteAllGifts() {
            if (!giftsData || giftsData.length === 0) {
                alert('沒有禮品可刪除');
                return;
            }
            
            const count = giftsData.length;
            
            // 兩次確認
            if (!confirm(`⚠️ 警告！\n\n確定要刪除全部 ${count} 個禮品嗎？\n\n此操作無法復原！`)) {
                return;
            }
            
            if (!confirm(`🚨 最後確認！\n\n即將永久刪除 ${count} 個禮品資料！\n\n請輸入確認後按確定繼續。`)) {
                return;
            }
            
            try {
                // 顯示進度
                const container = document.getElementById('giftsListContainer');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4 animate-pulse">🗑️</div>
                        <p class="text-white text-lg">正在刪除禮品資料...</p>
                        <p class="text-gray-400 text-sm mt-2">請稍候，共 ${count} 個</p>
                    </div>
                `;
                
                // 批次刪除
                const batchSize = 50;
                for (let i = 0; i < giftsData.length; i += batchSize) {
                    const batch = db.batch();
                    const slice = giftsData.slice(i, i + batchSize);
                    
                    for (const gift of slice) {
                        const docRef = db.collection('groups').doc(selectedGroupId).collection('gifts').doc(gift.id);
                        batch.delete(docRef);
                    }
                    
                    await batch.commit();
                    console.log(`已刪除 ${Math.min(i + batchSize, giftsData.length)}/${giftsData.length}`);
                }
                
                // 清空本地資料
                giftsData = [];
                window._selectedGiftIds?.clear();
                
                renderGiftsList(giftsData);
                alert(`✅ 已刪除全部 ${count} 個禮品`);
            } catch (error) {
                alert('❌ 刪除失敗: ' + error.message);
                await loadAndDisplayGifts();
            }
        }
        
        // 處理檔案匯入
        async function handleGiftFileImport(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (confirm(`確定要匯入「${file.name}」嗎？`)) {
                    await importGiftsFromExcel(file);
                    renderGiftsList(giftsData);
                }
                input.value = '';
            }
        }
        
        // 重新整理禮品列表
        async function refreshGiftsList() {
            await loadAndDisplayGifts();
        }
        
        // 顯示禮品詳情/編輯
        function showGiftDetail(giftId) {
            const gift = giftsData.find(g => g.id === giftId);
            if (!gift) return;
            
            const modal = document.createElement('div');
            modal.id = 'giftDetailModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">🎁 禮品詳情</h2>
                        <button onclick="document.getElementById('giftDetailModal').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="updateGift(event, '${gift.id}')">
                        <div class="flex gap-4 mb-4">
                            <div class="flex flex-col items-center">
                                <div id="edit-gift-image-preview" class="w-32 h-32 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0 mb-2">
                                    ${gift.imageUrl ? 
                                        `<img src="${gift.imageUrl}" alt="${gift.name}" class="w-full h-full object-contain">` :
                                        `<span class="text-5xl">🎁</span>`
                                    }
                                </div>
                                <label class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded cursor-pointer transition">
                                    📷 更換圖片
                                    <input type="file" accept="image/*" onchange="previewEditGiftImage(this, '${gift.id}')" class="hidden">
                                </label>
                                <input type="hidden" id="edit-gift-imageUrl" value="${gift.imageUrl || ''}">
                            </div>
                            <div class="flex-1 space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">商品名稱</label>
                                    <input type="text" id="edit-gift-name" value="${gift.name || ''}" required class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">項次</label>
                                        <input type="number" id="edit-gift-itemNo" value="${gift.itemNo || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">保夾金額</label>
                                        <input type="number" id="edit-gift-cost" value="${gift.cost || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">BSMI</label>
                                    <input type="text" id="edit-gift-bsmi" value="${gift.bsmi || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">IP授權廠商</label>
                                <input type="text" id="edit-gift-ipLicensor" value="${gift.ipLicensor || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">進口廠商</label>
                                <input type="text" id="edit-gift-importer" value="${gift.importer || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">購買商家</label>
                                <input type="text" id="edit-gift-supplier" value="${gift.supplier || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">發票號碼</label>
                                <input type="text" id="edit-gift-invoiceNo" value="${gift.invoiceNo || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-sm border-t border-gray-700 pt-3 mb-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">法務通過</label>
                                <input type="date" id="edit-gift-legalApprovalDate" value="${gift.legalApprovalDate || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">品保通過</label>
                                <input type="date" id="edit-gift-qaApprovalDate" value="${gift.qaApprovalDate || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">授權到期</label>
                                <input type="date" id="edit-gift-licenseExpireDate" value="${gift.licenseExpireDate || ''}" class="w-full bg-gray-700 text-white border border-gray-600 rounded py-1 px-2 text-sm ${isExpiringSoon(gift.licenseExpireDate) ? 'border-red-500' : ''}">
                            </div>
                        </div>
                        <div class="flex gap-3 pt-3 border-t border-gray-700">
                            <button type="submit" id="update-gift-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">💾 儲存變更</button>
                            <button type="button" onclick="deleteGift('${gift.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">🗑️ 刪除</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // 編輯時預覽禮品圖片
        async function previewEditGiftImage(input, giftId) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('edit-gift-image-preview');
            const urlInput = document.getElementById('edit-gift-imageUrl');
            
            preview.innerHTML = '<div class="animate-pulse text-2xl">⏳</div>';
            
            try {
                const compressedBlob = await compressImage(file);
                const previewUrl = URL.createObjectURL(compressedBlob);
                preview.innerHTML = `<img src="${previewUrl}" class="w-full h-full object-contain">`;
                
                // 暫存壓縮後的 blob
                window._pendingEditGiftImageBlob = compressedBlob;
                window._pendingEditGiftImageName = file.name.replace(/\.[^/.]+$/, '.jpg');
                urlInput.value = 'pending_upload';
                
                console.log(`✅ 編輯圖片已壓縮: ${(file.size / 1024).toFixed(1)}KB → ${(compressedBlob.size / 1024).toFixed(1)}KB`);
            } catch (error) {
                console.error('圖片處理失敗:', error);
                preview.innerHTML = '<span class="text-red-400 text-sm">處理失敗</span>';
            }
        }
        
        // 更新禮品資料
        async function updateGift(event, giftId) {
            event.preventDefault();
            
            const updateBtn = document.getElementById('update-gift-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = '儲存中...';
            
            try {
                let imageUrl = document.getElementById('edit-gift-imageUrl').value;
                
                // 如果有待上傳的新圖片
                if (window._pendingEditGiftImageBlob) {
                    updateBtn.textContent = '上傳圖片中...';
                    imageUrl = await uploadGiftImage(window._pendingEditGiftImageBlob, window._pendingEditGiftImageName);
                    window._pendingEditGiftImageBlob = null;
                    window._pendingEditGiftImageName = null;
                }
                
                const updateData = {
                    name: document.getElementById('edit-gift-name').value.trim(),
                    itemNo: parseInt(document.getElementById('edit-gift-itemNo').value) || 0,
                    cost: parseFloat(document.getElementById('edit-gift-cost').value) || 0,
                    imageUrl: imageUrl === 'pending_upload' ? '' : imageUrl,
                    bsmi: document.getElementById('edit-gift-bsmi').value.trim(),
                    ipLicensor: document.getElementById('edit-gift-ipLicensor').value.trim(),
                    importer: document.getElementById('edit-gift-importer').value.trim(),
                    supplier: document.getElementById('edit-gift-supplier').value.trim(),
                    invoiceNo: document.getElementById('edit-gift-invoiceNo').value.trim(),
                    legalApprovalDate: document.getElementById('edit-gift-legalApprovalDate').value || null,
                    qaApprovalDate: document.getElementById('edit-gift-qaApprovalDate').value || null,
                    licenseExpireDate: document.getElementById('edit-gift-licenseExpireDate').value || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('groups').doc(selectedGroupId).collection('gifts').doc(giftId).update(updateData);
                
                // 更新本地資料
                const giftIndex = giftsData.findIndex(g => g.id === giftId);
                if (giftIndex !== -1) {
                    giftsData[giftIndex] = { ...giftsData[giftIndex], ...updateData };
                }
                
                document.getElementById('giftDetailModal')?.remove();
                renderGiftsList(giftsData);
                alert('✅ 已更新禮品資料');
            } catch (error) {
                alert('❌ 更新失敗: ' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = '💾 儲存變更';
            }
        }
        
        // 暴露編輯函數到全域
        window.previewEditGiftImage = previewEditGiftImage;
        window.updateGift = updateGift;
        
        // 刪除禮品
        async function deleteGift(giftId) {
            const gift = giftsData.find(g => g.id === giftId);
            if (!gift) return;
            
            if (confirm(`確定要刪除「${gift.name}」嗎？`)) {
                try {
                    await db.collection('groups').doc(selectedGroupId).collection('gifts').doc(giftId).delete();
                    giftsData = giftsData.filter(g => g.id !== giftId);
                    document.getElementById('giftDetailModal')?.remove();
                    renderGiftsList(giftsData);
                    alert('✅ 已刪除禮品');
                } catch (error) {
                    alert('❌ 刪除失敗: ' + error.message);
                }
            }
        }
        
        // 新增禮品表單
        function showAddGiftForm() {
            const modal = document.createElement('div');
            modal.id = 'addGiftModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">➕ 新增禮品</h2>
                        <button onclick="document.getElementById('addGiftModal').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="saveNewGift(event)">
                        <div class="grid gap-4">
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">商品名稱 *</label>
                                <input type="text" id="new-gift-name" required class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">項次</label>
                                    <input type="number" id="new-gift-itemNo" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">保夾金額</label>
                                    <input type="number" id="new-gift-cost" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">商品圖片</label>
                                <div class="flex gap-3 items-start">
                                    <div id="new-gift-image-preview" class="w-24 h-24 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                                        <span class="text-4xl text-gray-500">📷</span>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center font-bold py-2 px-4 rounded-lg cursor-pointer transition mb-2">
                                            📤 上傳圖片
                                            <input type="file" id="new-gift-image-file" accept="image/*" onchange="previewGiftImage(this)" class="hidden">
                                        </label>
                                        <p class="text-xs text-gray-400">支援 JPG/PNG，自動壓縮為縮圖</p>
                                        <input type="hidden" id="new-gift-imageUrl">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">BSMI</label>
                                    <input type="text" id="new-gift-bsmi" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">發票號碼</label>
                                    <input type="text" id="new-gift-invoiceNo" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">購買商家</label>
                                <input type="text" id="new-gift-supplier" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">授權到期日</label>
                                <input type="date" id="new-gift-licenseExpireDate" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="document.getElementById('addGiftModal').remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                            <button type="submit" id="save-gift-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // 圖片壓縮函數
        function compressImage(file, maxWidth = 300, maxHeight = 300, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 計算縮放比例
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('圖片壓縮失敗'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => reject(new Error('圖片載入失敗'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('檔案讀取失敗'));
                reader.readAsDataURL(file);
            });
        }
        
        // 上傳圖片（自動選擇 Storage 或 Base64）
        async function uploadGiftImage(blob, fileName) {
            // 如果是 file:// 協議，使用 Base64 儲存（因為 Storage CORS 會失敗）
            if (window.location.protocol === 'file:') {
                return await blobToBase64(blob);
            }
            
            // 否則使用 Firebase Storage
            try {
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`gifts/${selectedGroupId}/${Date.now()}_${fileName}`);
                
                const snapshot = await imageRef.put(blob, { contentType: 'image/jpeg' });
                const downloadUrl = await snapshot.ref.getDownloadURL();
                return downloadUrl;
            } catch (error) {
                console.warn('Firebase Storage 上傳失敗，改用 Base64:', error.message);
                // 如果 Storage 失敗，fallback 到 Base64
                return await blobToBase64(blob);
            }
        }
        
        // Blob 轉 Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // 預覽禮品圖片
        async function previewGiftImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('new-gift-image-preview');
            const urlInput = document.getElementById('new-gift-imageUrl');
            
            preview.innerHTML = '<div class="animate-pulse text-2xl">⏳</div>';
            
            try {
                // 壓縮圖片
                const compressedBlob = await compressImage(file);
                
                // 顯示預覽
                const previewUrl = URL.createObjectURL(compressedBlob);
                preview.innerHTML = `<img src="${previewUrl}" class="w-full h-full object-contain">`;
                
                // 暫存壓縮後的 blob 供稍後上傳
                window._pendingGiftImageBlob = compressedBlob;
                window._pendingGiftImageName = file.name.replace(/\.[^/.]+$/, '.jpg');
                urlInput.value = 'pending_upload';
                
                console.log(`✅ 圖片已壓縮: ${(file.size / 1024).toFixed(1)}KB → ${(compressedBlob.size / 1024).toFixed(1)}KB`);
            } catch (error) {
                console.error('圖片處理失敗:', error);
                preview.innerHTML = '<span class="text-red-400 text-sm">處理失敗</span>';
                alert('圖片處理失敗: ' + error.message);
            }
        }
        
        // 儲存新禮品
        async function saveNewGift(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('save-gift-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = '儲存中...';
            
            try {
                let imageUrl = '';
                
                // 如果有待上傳的圖片
                if (window._pendingGiftImageBlob) {
                    saveBtn.textContent = '上傳圖片中...';
                    imageUrl = await uploadGiftImage(window._pendingGiftImageBlob, window._pendingGiftImageName);
                    window._pendingGiftImageBlob = null;
                    window._pendingGiftImageName = null;
                }
                
                const gift = {
                    name: document.getElementById('new-gift-name').value.trim(),
                    itemNo: parseInt(document.getElementById('new-gift-itemNo').value) || giftsData.length + 1,
                    cost: parseFloat(document.getElementById('new-gift-cost').value) || 0,
                    imageUrl: imageUrl,
                    bsmi: document.getElementById('new-gift-bsmi').value.trim(),
                    invoiceNo: document.getElementById('new-gift-invoiceNo').value.trim(),
                    supplier: document.getElementById('new-gift-supplier').value.trim(),
                    licenseExpireDate: document.getElementById('new-gift-licenseExpireDate').value || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!gift.name) {
                    alert('請輸入商品名稱');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '儲存';
                    return;
                }
                
                await db.collection('groups').doc(selectedGroupId).collection('gifts').add(gift);
                document.getElementById('addGiftModal')?.remove();
                await loadAndDisplayGifts();
                alert('✅ 已新增禮品');
            } catch (error) {
                alert('❌ 新增失敗: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = '儲存';
            }
        }
        
        // 暴露圖片相關函數到全域
        window.previewGiftImage = previewGiftImage;
        window.compressImage = compressImage;
        window.uploadGiftImage = uploadGiftImage;
        
        // ========================================
        // 🎰 門市禮品配置
        // ========================================
        
        // 顯示門市禮品配置選擇
        function showStoreGiftConfigSelector() {
            if (!selectedGroupId) {
                alert('請先選擇群組');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'storeGiftConfigSelector';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">🎰 選擇門市</h2>
                        <button onclick="document.getElementById('storeGiftConfigSelector').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <p class="text-gray-400 mb-4">選擇要配置禮品的門市：</p>
                    <div id="storeListForGiftConfig" class="space-y-2 max-h-[60vh] overflow-y-auto">
                        <div class="text-center py-4 text-gray-400">載入中...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            loadStoreListForGiftConfig();
        }
        
        // 載入門市列表供禮品配置選擇
        async function loadStoreListForGiftConfig() {
            const container = document.getElementById('storeListForGiftConfig');
            if (!container) return;
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                
                if (storesSnapshot.empty) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-400">沒有門市</div>';
                    return;
                }
                
                container.innerHTML = storesSnapshot.docs.map(doc => {
                    const store = doc.data();
                    return `
                        <button onclick="showStoreGiftConfigPage('${doc.id}', '${store.name}')" 
                                class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition">
                            🏪 ${store.name}
                        </button>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center py-4 text-red-400">載入失敗: ${error.message}</div>`;
            }
        }
        
        // 顯示門市禮品配置頁面
        async function showStoreGiftConfigPage(storeId, storeName) {
            document.getElementById('storeGiftConfigSelector')?.remove();
            
            if (giftsData.length === 0) {
                await loadGiftsData();
            }
            
            const modal = document.createElement('div');
            modal.id = 'storeGiftConfigModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[95vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">🎁 ${storeName} - 禮品配置</h2>
                        <button onclick="document.getElementById('storeGiftConfigModal').remove()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="mb-4">
                        <button onclick="saveAllMachineGifts('${storeId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">💾 儲存所有變更</button>
                    </div>
                    <div id="storeGiftConfigContent" class="flex-1 overflow-y-auto">
                        <div class="text-center py-8 text-gray-400">載入中...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            await loadStoreGiftConfig(storeId, storeName);
        }
        
        // 載入門市機台禮品配置
        async function loadStoreGiftConfig(storeId, storeName) {
            const container = document.getElementById('storeGiftConfigContent');
            if (!container) return;
            
            try {
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId).collection('machines').get();
                
                if (machinesSnapshot.empty) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-400">此門市沒有機台</div>';
                    return;
                }
                
                const machines = machinesSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                machines.sort((a, b) => (a.id || '').localeCompare(b.id || ''));
                
                // 存到臨時變數供儲存使用
                window._tempMachinesForGiftConfig = machines;
                window._tempStoreIdForGiftConfig = storeId;
                
                container.innerHTML = `
                    <div class="grid gap-4">
                        ${machines.map((machine, idx) => {
                            const currentGift = giftsData.find(g => g.id === machine.giftId);
                            return `
                                <div class="bg-gray-900 rounded-lg p-4 flex items-center gap-4" data-machine-idx="${idx}">
                                    <div class="w-20 h-20 bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                                        ${currentGift && currentGift.imageUrl ? 
                                            `<img src="${currentGift.imageUrl}" class="w-full h-full object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-3xl\\'>🎁</span>'">` :
                                            `<span class="text-3xl">${currentGift ? '🎁' : '❓'}</span>`
                                        }
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-blue-400 mb-1">${machine.id || '未命名'}</div>
                                        <div class="text-sm text-gray-400 mb-2">${machine.location || ''}</div>
                                        <select onchange="updateMachineGiftSelection(${idx}, this.value)" 
                                                class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3">
                                            <option value="">-- 選擇禮品 --</option>
                                            ${giftsData.map(gift => `
                                                <option value="${gift.id}" ${machine.giftId === gift.id ? 'selected' : ''}>
                                                    ${gift.name} ($${gift.cost || 0})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">目前禮品</div>
                                        <div class="text-white font-medium">${currentGift ? currentGift.name : '未設定'}</div>
                                        ${currentGift ? `<div class="text-green-400 text-sm">$${currentGift.cost || 0}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="text-center py-8 text-red-400">載入失敗: ${error.message}</div>`;
            }
        }
        
        // 更新機台禮品選擇（臨時存儲）
        function updateMachineGiftSelection(machineIdx, giftId) {
            if (window._tempMachinesForGiftConfig && window._tempMachinesForGiftConfig[machineIdx]) {
                window._tempMachinesForGiftConfig[machineIdx].giftId = giftId || null;
                window._tempMachinesForGiftConfig[machineIdx]._giftChanged = true;
                
                // 更新圖片預覽
                const container = document.querySelector(`[data-machine-idx="${machineIdx}"]`);
                if (container) {
                    const imgContainer = container.querySelector('.w-20');
                    const gift = giftsData.find(g => g.id === giftId);
                    if (gift && gift.imageUrl) {
                        imgContainer.innerHTML = `<img src="${gift.imageUrl}" class="w-full h-full object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-3xl\\'>🎁</span>'">`;
                    } else {
                        imgContainer.innerHTML = `<span class="text-3xl">${gift ? '🎁' : '❓'}</span>`;
                    }
                    
                    // 更新右側文字
                    const rightDiv = container.querySelector('.text-right');
                    if (rightDiv) {
                        rightDiv.innerHTML = `
                            <div class="text-sm text-gray-400">目前禮品</div>
                            <div class="text-white font-medium">${gift ? gift.name : '未設定'}</div>
                            ${gift ? `<div class="text-green-400 text-sm">$${gift.cost || 0}</div>` : ''}
                        `;
                    }
                }
            }
        }
        
        // 儲存所有機台禮品配置
        async function saveAllMachineGifts(storeId) {
            if (!window._tempMachinesForGiftConfig) {
                alert('沒有資料可儲存');
                return;
            }
            
            try {
                const changedMachines = window._tempMachinesForGiftConfig.filter(m => m._giftChanged);
                
                if (changedMachines.length === 0) {
                    alert('沒有需要儲存的變更');
                    return;
                }
                
                const batch = db.batch();
                
                for (const machine of changedMachines) {
                    const machineRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('machines').doc(machine.docId);
                    batch.update(machineRef, {
                        giftId: machine.giftId || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                
                // 清除變更標記
                window._tempMachinesForGiftConfig.forEach(m => m._giftChanged = false);
                
                alert(`✅ 已儲存 ${changedMachines.length} 台機台的禮品配置！`);
            } catch (error) {
                alert('❌ 儲存失敗: ' + error.message);
            }
        }
        
        // 更新機台編輯彈窗的禮品選擇
        async function updateEditMachineGiftSelector(currentGiftId) {
            const selector = document.getElementById('edit-machine-gift');
            const preview = document.getElementById('edit-machine-gift-preview');
            
            if (!selector) return;
            
            if (giftsData.length === 0) {
                await loadGiftsData();
            }
            
            selector.innerHTML = '<option value="">-- 選擇禮品 --</option>' + 
                giftsData.map(gift => `
                    <option value="${gift.id}" ${currentGiftId === gift.id ? 'selected' : ''}>
                        ${gift.name} ($${gift.cost || 0})
                    </option>
                `).join('');
            
            // 設定預覽
            selector.onchange = function() {
                const giftId = this.value;
                const gift = giftsData.find(g => g.id === giftId);
                if (gift && gift.imageUrl) {
                    preview.innerHTML = `<img src="${gift.imageUrl}" class="w-full h-full object-contain" onerror="this.innerHTML='<span class=\\'text-4xl\\'>🎁</span>'">`;
                } else if (gift) {
                    preview.innerHTML = '<span class="text-4xl">🎁</span>';
                } else {
                    preview.innerHTML = '<span class="text-4xl text-gray-500">🎁</span>';
                }
            };
            
            // 初始預覽
            const currentGift = giftsData.find(g => g.id === currentGiftId);
            if (currentGift && currentGift.imageUrl) {
                preview.innerHTML = `<img src="${currentGift.imageUrl}" class="w-full h-full object-contain">`;
            } else if (currentGift) {
                preview.innerHTML = '<span class="text-4xl">🎁</span>';
            }
        }
        
        // 禮品管理按鈕事件綁定
        document.getElementById('open-gift-management-btn')?.addEventListener('click', showGiftManagementModal);
        document.getElementById('open-store-gift-config-btn')?.addEventListener('click', showStoreGiftConfigSelector);
        
        // 將函數暴露到全局
        window.showGiftManagementModal = showGiftManagementModal;
        window.showStoreGiftConfigSelector = showStoreGiftConfigSelector;
        window.showStoreGiftConfigPage = showStoreGiftConfigPage;
        window.handleGiftFileImport = handleGiftFileImport;
        window.filterGiftsList = filterGiftsList;
        window.refreshGiftsList = refreshGiftsList;
        window.showGiftDetail = showGiftDetail;
        window.deleteGift = deleteGift;
        window.showAddGiftForm = showAddGiftForm;
        window.saveNewGift = saveNewGift;
        window.updateMachineGiftSelection = updateMachineGiftSelection;
        window.saveAllMachineGifts = saveAllMachineGifts;
        window.editGift = showGiftDetail; // 暫時用詳情頁代替編輯
        window.updateEditMachineGiftSelector = updateEditMachineGiftSelector;
        window.toggleGiftSelection = toggleGiftSelection;
        window.toggleSelectAllGifts = toggleSelectAllGifts;
        window.deleteSelectedGifts = deleteSelectedGifts;
        window.deleteAllGifts = deleteAllGifts;
        
        // 快速禮品選擇器
        async function showQuickGiftSelector(machineDocId) {
            if (giftsData.length === 0) {
                await loadGiftsData();
            }
            
            const machine = appData.machines.find(m => m.docId === machineDocId);
            if (!machine) return;
            
            const modal = document.createElement('div');
            modal.id = 'quickGiftSelectorModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">🎁 選擇禮品 - ${machine.id}/${machine.location}</h2>
                        <button onclick="document.getElementById('quickGiftSelectorModal').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <input type="text" id="quickGiftSearch" placeholder="搜尋禮品名稱..." 
                           class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-4 mb-4">
                    <div id="quickGiftList" class="flex-1 overflow-y-auto">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            <div class="bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-red-900 transition text-center" 
                                 onclick="setQuickGift('${machineDocId}', null)">
                                <div class="text-4xl mb-2">❌</div>
                                <div class="text-white text-sm">清除禮品</div>
                            </div>
                            ${giftsData.map(gift => `
                                <div class="bg-gray-900 rounded-lg p-3 cursor-pointer hover:bg-green-900 transition ${gift.id === machine.giftId ? 'ring-2 ring-green-400' : ''}" 
                                     onclick="setQuickGift('${machineDocId}', '${gift.id}')">
                                    <div class="aspect-square bg-gray-800 rounded-lg mb-2 flex items-center justify-center overflow-hidden">
                                        ${gift.imageUrl ? 
                                            `<img src="${gift.imageUrl}" class="w-full h-full object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-3xl\\'>🎁</span>'">` :
                                            `<span class="text-3xl">🎁</span>`
                                        }
                                    </div>
                                    <div class="text-white text-xs truncate" title="${gift.name}">${gift.name}</div>
                                    <div class="text-green-400 text-xs">$${gift.cost || 0}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 搜尋功能
            document.getElementById('quickGiftSearch').addEventListener('input', function(e) {
                const keyword = e.target.value.toLowerCase();
                const items = document.querySelectorAll('#quickGiftList .grid > div:not(:first-child)');
                items.forEach(item => {
                    const name = item.querySelector('.text-white')?.textContent.toLowerCase() || '';
                    item.style.display = name.includes(keyword) ? '' : 'none';
                });
            });
        }
        
        // 快速設定禮品
        async function setQuickGift(machineDocId, giftId) {
            try {
                await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(selectedStoreId)
                    .collection('machines').doc(machineDocId)
                    .update({ giftId: giftId });
                
                // 更新本地資料
                const machine = appData.machines.find(m => m.docId === machineDocId);
                if (machine) {
                    machine.giftId = giftId;
                }
                
                document.getElementById('quickGiftSelectorModal')?.remove();
                
                // 重新渲染機台列表
                renderMachineManagementTab();
                
                const gift = giftsData.find(g => g.id === giftId);
                alert(giftId ? `✅ 已設定禮品：${gift?.name || giftId}` : '✅ 已清除禮品設定');
            } catch (error) {
                alert('❌ 設定失敗: ' + error.message);
            }
        }
        
        window.showQuickGiftSelector = showQuickGiftSelector;
        window.setQuickGift = setQuickGift;
        
        // ========================================
        // 禮品管理系統結束
        // ========================================
        
        // ========================================
        // 輪巡管理系統
        // ========================================
        
        // 輪巡管理頁面元素
        const patrolManagementPage = document.getElementById('patrol-management-page');
        const openPatrolManagementBtn = document.getElementById('open-patrol-management-btn');
        const backFromPatrolManagementBtn = document.getElementById('back-from-patrol-management-btn');
        const patrolAllStoresBtn = document.getElementById('patrol-all-stores-btn');
        const batchAddAllStoresBtn = document.getElementById('batch-add-all-stores-btn');
        const fixTodayHistoryBtn = document.getElementById('fix-today-history-btn');
        const showCumulativeDataBtn = document.getElementById('show-cumulative-data-btn');
        const deleteTodayRecordsBtn = document.getElementById('delete-today-records-btn');
        const clearPatrolLogBtn = document.getElementById('clear-patrol-log-btn');
        
        // 輪巡操作記錄
        let patrolOperationLogs = [];
        
        // 添加輪巡操作記錄
        function addPatrolLog(message, type = 'info') {
            const log = {
                time: new Date().toLocaleTimeString('zh-TW'),
                message: message,
                type: type
            };
            patrolOperationLogs.unshift(log);
            
            // 最多保留 100 條記錄
            if (patrolOperationLogs.length > 100) {
                patrolOperationLogs = patrolOperationLogs.slice(0, 100);
            }
            
            renderPatrolLogs();
        }
        
        // 渲染輪巡操作記錄
        function renderPatrolLogs() {
            const container = document.getElementById('patrol-operation-log');
            if (!container) return;
            
            if (patrolOperationLogs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">尚無輪巡操作記錄</p>';
                return;
            }
            
            container.innerHTML = patrolOperationLogs.map(log => {
                const colorClass = log.type === 'success' ? 'text-green-400' : 
                                   log.type === 'error' ? 'text-red-400' : 
                                   log.type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
                const icon = log.type === 'success' ? '✅' : 
                             log.type === 'error' ? '❌' : 
                             log.type === 'warning' ? '⚠️' : 'ℹ️';
                return `
                    <div class="bg-gray-900/50 p-2 rounded flex items-center gap-2 text-sm">
                        <span class="text-gray-500">[${log.time}]</span>
                        <span>${icon}</span>
                        <span class="${colorClass}">${log.message}</span>
                    </div>
                `;
            }).join('');
        }
        
        // 進入輪巡管理頁面
        async function showPatrolManagementPage() {
            if (!selectedGroupId) {
                alert('請先選擇單位群組');
                return;
            }
            
            // 隱藏其他頁面，顯示輪巡管理頁面
            storeSelectionPage.classList.add('hidden');
            patrolManagementPage.classList.remove('hidden');
            
            // 設置群組名稱
            const groupNameEl = document.getElementById('patrol-management-group-name');
            if (groupNameEl) {
                groupNameEl.textContent = selectedGroupName || '';
            }
            
            // 載入門市卡牌
            await loadPatrolStoreCards();
        }
        
        // 載入輪巡門市卡牌
        async function loadPatrolStoreCards() {
            const container = document.getElementById('patrol-store-cards');
            if (!container) return;
            
            container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">正在載入門市列表...</p>';
            
            try {
                // 獲取所有門市
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 更新統計數據
                let totalMachines = 0;
                let totalRecords = window.dailyRecords ? Object.keys(window.dailyRecords).length : 0;
                
                // 獲取每個門市的機台數量
                for (const store of stores) {
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    store.machineCount = machinesSnapshot.size;
                    totalMachines += machinesSnapshot.size;
                }
                
                // 更新統計面板
                document.getElementById('patrol-total-stores').textContent = stores.length;
                document.getElementById('patrol-total-machines').textContent = totalMachines;
                document.getElementById('patrol-total-records').textContent = totalRecords;
                document.getElementById('patrol-pending-records').textContent = totalRecords;
                
                if (stores.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">此群組尚未建立任何門市。</p>';
                    return;
                }
                
                // 渲染門市卡牌
                container.innerHTML = stores.map(store => `
                    <div class="bg-gray-700 rounded-xl overflow-hidden shadow-lg patrol-store-card" data-store-id="${store.id}">
                        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-4">
                            <h3 class="text-xl font-bold text-white truncate">${store.name}</h3>
                            <p class="text-green-100 text-sm">機台數量：${store.machineCount || 0} 台</p>
                        </div>
                        <div class="p-4 space-y-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-400">輪巡狀態</span>
                                <span class="patrol-status text-yellow-400" data-store-id="${store.id}">待輪巡</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="patrol-single-store-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg transition flex items-center justify-center gap-1 text-sm"
                                        data-store-id="${store.id}" data-store-name="${store.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    輪巡
                                </button>
                                <button class="batch-add-single-store-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition flex items-center justify-center gap-1 text-sm"
                                        data-store-id="${store.id}" data-store-name="${store.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    批量新增
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // 綁定卡牌按鈕事件
                bindPatrolCardEvents();
                
            } catch (error) {
                console.error('載入輪巡門市卡牌失敗:', error);
                container.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">載入失敗: ${error.message}</p>`;
            }
        }
        
        // 綁定輪巡卡牌按鈕事件
        function bindPatrolCardEvents() {
            // 單一門市輪巡按鈕
            document.querySelectorAll('.patrol-single-store-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const storeId = this.dataset.storeId;
                    const storeName = this.dataset.storeName;
                    await patrolSingleStore(storeId, storeName);
                });
            });
            
            // 單一門市批量新增按鈕
            document.querySelectorAll('.batch-add-single-store-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const storeId = this.dataset.storeId;
                    const storeName = this.dataset.storeName;
                    await batchAddSingleStore(storeId, storeName);
                });
            });
        }
        
        // 更新門市卡片顯示更新結果
        function updatePatrolStoreCardResult(storeId, result) {
            const card = document.querySelector(`.patrol-store-card[data-store-id="${storeId}"]`);
            if (!card) return;
            
            // 查找或創建結果容器
            let resultContainer = card.querySelector('.patrol-result-container');
            if (!resultContainer) {
                resultContainer = document.createElement('div');
                resultContainer.className = 'patrol-result-container p-4 pt-0';
                card.appendChild(resultContainer);
            }
            
            if (!result.success && !result.details) {
                // 簡單失敗訊息
                resultContainer.innerHTML = `
                    <div class="bg-red-900/50 border border-red-600 rounded-lg p-3 mt-2">
                        <div class="flex items-center gap-2 text-red-400">
                            <span>❌</span>
                            <span class="font-semibold">${result.message || '更新失敗'}</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            // 有詳細更新資訊
            const { addedCount = 0, failedCount = 0, details = [] } = result;
            const totalCount = addedCount + failedCount;
            
            let html = `
                <div class="bg-gray-800/80 border ${addedCount > 0 ? 'border-green-600' : 'border-yellow-600'} rounded-lg p-3 mt-2 space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold ${addedCount > 0 ? 'text-green-400' : 'text-yellow-400'}">
                            ${addedCount > 0 ? '✅ 更新完成' : '⚠️ 更新結果'}
                        </span>
                        <span class="text-sm text-gray-400">
                            成功 ${addedCount} / 失敗 ${failedCount}
                        </span>
                    </div>
            `;
            
            if (details.length > 0) {
                // 計算總和統計
                let totalPlaysBefore = 0, totalPlaysAfter = 0;
                let totalPayoutsBefore = 0, totalPayoutsAfter = 0;
                let totalDailyPlays = 0, totalDailyPayouts = 0;
                
                for (const detail of details) {
                    totalPlaysBefore += detail.before.plays || 0;
                    totalPlaysAfter += detail.after.plays || 0;
                    totalPayoutsBefore += detail.before.payouts || 0;
                    totalPayoutsAfter += detail.after.payouts || 0;
                    if (detail.daily) {
                        totalDailyPlays += detail.daily.plays || 0;
                        totalDailyPayouts += detail.daily.payouts || 0;
                    }
                }
                
                const totalPlaysDiff = totalPlaysAfter - totalPlaysBefore;
                const totalPayoutsDiff = totalPayoutsAfter - totalPayoutsBefore;
                
                // 總和統計區塊 - 當日新增使用差異值計算
                const todayPlaysIncrease = totalPlaysDiff;  // 今日實際新增投幣數
                const todayPayoutsIncrease = totalPayoutsDiff;  // 今日實際新增出貨數
                const todayRevenue = todayPlaysIncrease * 10;  // 營業額 = 投幣數 × 10元
                
                html += `
                    <div class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 border border-purple-500/50 rounded-lg p-3 mb-2">
                        <div class="text-purple-300 font-semibold text-sm mb-2 flex items-center gap-2">
                            <span>📊</span> 門市今日統計
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-gray-900/60 rounded p-2">
                                <div class="text-gray-400 text-xs mb-1">💰 總投幣數</div>
                                <div class="text-xl font-bold text-yellow-400">${totalPlaysAfter.toLocaleString()}</div>
                                <div class="text-xs mt-1">
                                    <span class="text-gray-500">更新前 ${totalPlaysBefore.toLocaleString()}</span>
                                    ${todayPlaysIncrease !== 0 ? `<span class="${todayPlaysIncrease > 0 ? 'text-green-400' : 'text-red-400'} ml-1">(${todayPlaysIncrease > 0 ? '+' : ''}${todayPlaysIncrease.toLocaleString()})</span>` : ''}
                                </div>
                            </div>
                            <div class="bg-gray-900/60 rounded p-2">
                                <div class="text-gray-400 text-xs mb-1">📦 總出貨數</div>
                                <div class="text-xl font-bold text-cyan-400">${totalPayoutsAfter.toLocaleString()}</div>
                                <div class="text-xs mt-1">
                                    <span class="text-gray-500">更新前 ${totalPayoutsBefore.toLocaleString()}</span>
                                    ${todayPayoutsIncrease !== 0 ? `<span class="${todayPayoutsIncrease > 0 ? 'text-green-400' : 'text-red-400'} ml-1">(${todayPayoutsIncrease > 0 ? '+' : ''}${todayPayoutsIncrease.toLocaleString()})</span>` : ''}
                                </div>
                            </div>
                        </div>
                        ${todayPlaysIncrease > 0 ? `
                            <div class="bg-green-900/40 border border-green-600/50 rounded p-2 mt-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-green-300 text-sm">💵 今日營業額</span>
                                    <span class="text-green-400 font-bold text-lg">+$${todayRevenue.toLocaleString()}</span>
                                </div>
                                <div class="text-green-400/70 text-xs mt-1">
                                    新增投幣 ${todayPlaysIncrease} 枚 × $10 = $${todayRevenue.toLocaleString()}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // 個別機台詳情（可收合）
                html += `
                    <details class="group">
                        <summary class="cursor-pointer text-gray-400 text-xs hover:text-gray-200 flex items-center gap-1">
                            <span class="group-open:rotate-90 transition-transform">▶</span>
                            查看各機台明細 (${details.length} 台)
                        </summary>
                        <div class="space-y-1 max-h-48 overflow-y-auto text-xs mt-2">
                `;
                
                for (const detail of details) {
                    const statusColor = detail.success ? 'text-green-400' : 'text-red-400';
                    const statusIcon = detail.success ? '✅' : '❌';
                    const playsDiff = detail.after.plays - detail.before.plays;
                    const payoutsDiff = detail.after.payouts - detail.before.payouts;
                    const revenueDiff = playsDiff * 10;  // 營業額差異
                    
                    html += `
                        <div class="bg-gray-900/60 p-2 rounded flex flex-col gap-1">
                            <div class="flex items-center justify-between">
                                <span class="${statusColor} font-medium">${statusIcon} ${detail.machineId}/${detail.location}</span>
                                ${detail.error ? `<span class="text-red-400 text-xs">${detail.error}</span>` : ''}
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-gray-300">
                                <div class="flex flex-col">
                                    <span class="text-gray-500 text-xs">投幣數</span>
                                    <span>
                                        <span class="text-gray-400">${detail.before.plays}</span>
                                        <span class="text-gray-500">→</span>
                                        <span class="text-white">${detail.after.plays}</span>
                                        ${playsDiff !== 0 ? `<span class="${playsDiff > 0 ? 'text-green-400' : 'text-red-400'}">(${playsDiff > 0 ? '+' : ''}${playsDiff})</span>` : ''}
                                    </span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-gray-500 text-xs">出貨數</span>
                                    <span>
                                        <span class="text-gray-400">${detail.before.payouts}</span>
                                        <span class="text-gray-500">→</span>
                                        <span class="text-white">${detail.after.payouts}</span>
                                        ${payoutsDiff !== 0 ? `<span class="${payoutsDiff > 0 ? 'text-green-400' : 'text-red-400'}">(${payoutsDiff > 0 ? '+' : ''}${payoutsDiff})</span>` : ''}
                                    </span>
                                </div>
                            </div>
                            ${playsDiff > 0 ? `
                                <div class="text-green-400 text-xs border-t border-gray-700 pt-1 mt-1">
                                    💵 本次營收：+$${revenueDiff.toLocaleString()} (${playsDiff} 枚 × $10)
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                html += `</div></details>`;
            }
            
            html += `</div>`;
            resultContainer.innerHTML = html;
            
            // 更新狀態標籤
            const statusEl = card.querySelector(`.patrol-status[data-store-id="${storeId}"]`);
            if (statusEl) {
                if (addedCount > 0 && failedCount === 0) {
                    statusEl.textContent = `已更新 (${addedCount}筆)`;
                    statusEl.className = 'patrol-status text-green-400';
                } else if (addedCount > 0 && failedCount > 0) {
                    statusEl.textContent = `部分更新 (${addedCount}/${totalCount})`;
                    statusEl.className = 'patrol-status text-yellow-400';
                } else {
                    statusEl.textContent = `更新失敗`;
                    statusEl.className = 'patrol-status text-red-400';
                }
            }
        }
        
        // 輪巡單一門市 - 使用系統輪詢功能正確獲取數據
        async function patrolSingleStore(storeId, storeName) {
            addPatrolLog(`開始輪巡門市: ${storeName}`, 'info');
            
            // 更新狀態
            const statusEl = document.querySelector(`.patrol-status[data-store-id="${storeId}"]`);
            if (statusEl) {
                statusEl.textContent = '輪巡中...';
                statusEl.className = 'patrol-status text-blue-400 animate-pulse';
            }
            
            try {
                // 保存當前門市選擇狀態
                const originalStoreId = selectedStoreId;
                const originalStoreName = selectedStoreName;
                const originalAppData = JSON.parse(JSON.stringify(appData || {}));
                
                // 臨時切換到目標門市
                selectedStoreId = storeId;
                selectedStoreName = storeName;
                
                // 獲取該門市的所有機台
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('machines').get();
                
                const machines = machinesSnapshot.docs.map(doc => ({
                    docId: doc.id,
                    ...doc.data()
                }));
                
                if (machines.length === 0) {
                    addPatrolLog(`門市 ${storeName} 沒有機台`, 'warning');
                    if (statusEl) {
                        statusEl.textContent = '無機台';
                        statusEl.className = 'patrol-status text-gray-400';
                    }
                    // 恢復原來的門市選擇
                    selectedStoreId = originalStoreId;
                    selectedStoreName = originalStoreName;
                    return { success: false, machines: [] };
                }
                
                // 臨時設置 appData.machines 以便輪詢函數使用
                appData.machines = machines;
                
                // 強制重建機台映射表（因為切換了門市）
                buildMachineConfigMap(true);
                
                addPatrolLog(`門市 ${storeName} 找到 ${machines.length} 台機台，開始輪詢...`, 'info');
                
                // 使用系統的並行輪詢功能
                if (typeof pollAllMachinesParallel === 'function') {
                    await pollAllMachinesParallel();
                } else if (typeof pollAllMachines === 'function') {
                    await pollAllMachines();
                } else {
                    throw new Error('找不到輪詢函數');
                }
                
                // 計算成功獲取的記錄數
                const recordCount = window.dailyRecords ? Object.keys(window.dailyRecords).filter(key => {
                    const record = window.dailyRecords[key];
                    return machines.some(m => m.id === record.machineId && m.location === record.location);
                }).length : 0;
                
                addPatrolLog(`門市 ${storeName} 輪巡完成: 獲取 ${recordCount} 筆數據`, 'success');
                
                if (statusEl) {
                    statusEl.textContent = `已輪巡 (${recordCount}筆)`;
                    statusEl.className = 'patrol-status text-green-400';
                }
                
                // 更新最後輪巡時間
                document.getElementById('patrol-management-last-update').textContent = 
                    `最後輪巡：${new Date().toLocaleTimeString('zh-TW')}`;
                
                // 更新統計面板
                updatePatrolStats();
                
                // 恢復原來的門市選擇
                selectedStoreId = originalStoreId;
                selectedStoreName = originalStoreName;
                if (originalAppData.machines) {
                    appData.machines = originalAppData.machines;
                }
                
                return { success: true, machines: machines, recordCount: recordCount };
                
            } catch (error) {
                addPatrolLog(`門市 ${storeName} 輪巡失敗: ${error.message}`, 'error');
                if (statusEl) {
                    statusEl.textContent = '輪巡失敗';
                    statusEl.className = 'patrol-status text-red-400';
                }
                return { success: false, machines: [], error: error.message };
            }
        }
        
        // 更新輪巡統計面板
        function updatePatrolStats() {
            const totalRecords = window.dailyRecords ? Object.keys(window.dailyRecords).length : 0;
            const pendingRecords = window.dailyRecords ? 
                Object.values(window.dailyRecords).filter(r => !r.isPersisted).length : 0;
            
            const totalRecordsEl = document.getElementById('patrol-total-records');
            const pendingRecordsEl = document.getElementById('patrol-pending-records');
            
            if (totalRecordsEl) totalRecordsEl.textContent = totalRecords;
            if (pendingRecordsEl) pendingRecordsEl.textContent = pendingRecords;
        }
        
        // 批量新增單一門市的所有機台記錄
        async function batchAddSingleStore(storeId, storeName) {
            addPatrolLog(`開始批量新增門市: ${storeName}`, 'info');
            
            // 先輪巡該門市
            const patrolResult = await patrolSingleStore(storeId, storeName);
            
            if (!patrolResult.success) {
                addPatrolLog(`門市 ${storeName} 輪巡失敗，無法批量新增`, 'error');
                // 更新卡片狀態
                updatePatrolStoreCardResult(storeId, { success: false, message: '輪巡失敗' });
                return;
            }
            
            // 檢查是否有輪詢數據
            if (!window.dailyRecords || Object.keys(window.dailyRecords).length === 0) {
                addPatrolLog(`門市 ${storeName} 沒有輪詢數據可新增`, 'warning');
                updatePatrolStoreCardResult(storeId, { success: false, message: '沒有輪詢數據' });
                return;
            }
            
            try {
                // 獲取該門市的機台
                const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('machines').get();
                
                const machines = machinesSnapshot.docs.map(doc => ({
                    docId: doc.id,
                    ...doc.data()
                }));
                
                console.log('📋 門市機台列表:', machines.map(m => `${m.id}/${m.location}`));
                console.log('📋 dailyRecords 鍵:', Object.keys(window.dailyRecords));
                
                // 篩選該門市的輪詢記錄 (使用 trim 處理空格問題)
                const storeRecords = Object.entries(window.dailyRecords).filter(([key, record]) => {
                    const recordMachineId = (record.machineId || '').trim().replace(/\s+/g, '');
                    const recordLocation = String(record.location || '').trim();
                    const match = machines.some(m => {
                        const machineId = (m.id || '').trim().replace(/\s+/g, '');
                        const machineLocation = String(m.location || '').trim();
                        return machineId === recordMachineId && machineLocation === recordLocation;
                    });
                    console.log(`   🔍 檢查記錄 ${key}: machineId="${record.machineId}", location="${record.location}", 匹配=${match}`);
                    return match;
                });
                
                if (storeRecords.length === 0) {
                    addPatrolLog(`門市 ${storeName} 沒有匹配的輪詢記錄`, 'warning');
                    console.warn('❌ 沒有匹配的記錄！機台列表:', machines.map(m => ({id: m.id, location: m.location})));
                    console.warn('❌ dailyRecords 內容:', window.dailyRecords);
                    updatePatrolStoreCardResult(storeId, { success: false, message: '沒有匹配的記錄' });
                    return;
                }
                
                addPatrolLog(`門市 ${storeName} 找到 ${storeRecords.length} 筆記錄，開始新增...`, 'info');
                
                let addedCount = 0;
                let failedCount = 0;
                const updateDetails = []; // 記錄更新詳情
                
                for (const [recordKey, record] of storeRecords) {
                    // 跳過已持久化的記錄
                    if (record.isPersisted === true) {
                        console.log(`⏭️ 跳過已持久化記錄: ${recordKey}`);
                        continue;
                    }
                    
                    // 使用 trim 和去空格匹配 (處理 "內湖 /左" vs "內湖/左" 的問題)
                    const recordMachineId = (record.machineId || '').trim().replace(/\s+/g, '');
                    const recordLocation = String(record.location || '').trim();
                    const machine = machines.find(m => {
                        const machineId = (m.id || '').trim().replace(/\s+/g, '');
                        const machineLocation = String(m.location || '').trim();
                        return machineId === recordMachineId && machineLocation === recordLocation;
                    });
                    
                    if (!machine) {
                        console.warn(`❌ 找不到機台: ${record.machineId}/${record.location}`);
                        continue;
                    }
                    
                    // 記錄更新前的數據
                    const beforeData = {
                        plays: machine.plays || 0,
                        payouts: machine.payouts || 0
                    };
                    
                    try {
                        // 使用與原本系統相同的計算方式
                        // 基準值 = 機台目前的累積數據
                        const baselinePlays = beforeData.plays;
                        const baselinePayouts = beforeData.payouts;
                        
                        // 當日增量 = 新累積值 - 基準值
                        const dailyPlays = Math.max(0, record.plays - baselinePlays);
                        const dailyPayouts = Math.max(0, record.payouts - baselinePayouts);
                        
                        console.log(`📝 ${machine.id}: 基準=${baselinePlays}, 新累積=${record.plays}, 當日增量=${dailyPlays}`);
                        
                        // 如果沒有變化，跳過
                        if (dailyPlays === 0 && dailyPayouts === 0) {
                            console.log(`⏭️ 數據未變更，跳過: ${machine.id}/${machine.location}`);
                            continue;
                        }
                        
                        // 歷史記錄集合
                        const historyRef = db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId)
                            .collection('history');
                        
                        // 檢查是否已存在相同日期和機台的歷史記錄（與原本系統相同邏輯）
                        let existingRecords = null;
                        try {
                            existingRecords = await historyRef
                                .where('date', '==', record.date)
                                .where('machineId', '==', machine.id)
                                .where('location', '==', machine.location)
                                .get();
                        } catch (queryError) {
                            console.warn(`⚠️ 複合查詢失敗，使用備用方案: ${queryError.message}`);
                            const allRecords = await historyRef.get();
                            const filtered = allRecords.docs.filter(doc => {
                                const data = doc.data();
                                return data.date === record.date && 
                                       data.machineId === machine.id && 
                                       data.location === machine.location;
                            });
                            existingRecords = { docs: filtered };
                        }
                        
                        if (existingRecords.docs.length > 0) {
                            // 更新現有記錄（使用原本系統的欄位名稱 newPlays, newPayouts）
                            const docId = existingRecords.docs[0].id;
                            await historyRef.doc(docId).update({
                                newPlays: dailyPlays,
                                newPayouts: dailyPayouts,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log(`✅ 更新歷史記錄: ${docId}, 日增量 plays=${dailyPlays}, payouts=${dailyPayouts}`);
                        } else {
                            // 新增記錄（使用原本系統的欄位名稱 newPlays, newPayouts）
                            await historyRef.add({
                                date: record.date,
                                machineId: machine.id,
                                location: machine.location,
                                newPlays: dailyPlays,
                                newPayouts: dailyPayouts,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log(`✅ 新增歷史記錄: ${machine.id}, 日增量 plays=${dailyPlays}, payouts=${dailyPayouts}`);
                        }
                        
                        // 更新機台累積數據
                        await db.collection('groups').doc(selectedGroupId)
                            .collection('stores').doc(storeId)
                            .collection('machines').doc(machine.docId)
                            .update({
                                plays: record.plays,
                                payouts: record.payouts,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        
                        // 標記為已持久化
                        window.dailyRecords[recordKey].isPersisted = true;
                        
                        // 記錄更新詳情
                        updateDetails.push({
                            machineId: machine.id,
                            location: machine.location,
                            before: beforeData,
                            after: { plays: record.plays, payouts: record.payouts },
                            daily: { plays: dailyPlays, payouts: dailyPayouts },
                            success: true
                        });
                        
                        addedCount++;
                        addPatrolLog(`✅ ${machine.id}/${machine.location}: 投幣 ${beforeData.plays}→${record.plays}, 出貨 ${beforeData.payouts}→${record.payouts}`, 'success');
                    } catch (e) {
                        failedCount++;
                        console.error(`❌ 更新失敗: ${machine.id}/${machine.location}`, e.message, e);
                        addPatrolLog(`❌ ${machine.id}/${machine.location} 失敗: ${e.message}`, 'error');
                        updateDetails.push({
                            machineId: machine.id,
                            location: machine.location,
                            before: beforeData,
                            after: { plays: record.plays, payouts: record.payouts },
                            success: false,
                            error: e.message
                        });
                    }
                }
                
                addPatrolLog(`門市 ${storeName} 批量新增完成: 成功 ${addedCount} 筆，失敗 ${failedCount} 筆`, 
                    failedCount > 0 ? 'warning' : 'success');
                
                // 更新卡片顯示更新詳情
                updatePatrolStoreCardResult(storeId, {
                    success: addedCount > 0,
                    addedCount,
                    failedCount,
                    details: updateDetails
                });
                
                // 更新統計
                const pendingEl = document.getElementById('patrol-pending-records');
                if (pendingEl) {
                    const remaining = Object.values(window.dailyRecords || {}).filter(r => !r.isPersisted).length;
                    pendingEl.textContent = remaining;
                }
                
            } catch (error) {
                addPatrolLog(`門市 ${storeName} 批量新增失敗: ${error.message}`, 'error');
            }
        }
        
        // 輪巡所有門市
        async function patrolAllStoresFromManagement() {
            addPatrolLog('開始輪巡所有門市...', 'info');
            
            // 禁用按鈕
            const patrolBtn = document.getElementById('patrol-all-stores-btn');
            const batchBtn = document.getElementById('batch-add-all-stores-btn');
            if (patrolBtn) patrolBtn.disabled = true;
            if (batchBtn) batchBtn.disabled = true;
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < stores.length; i++) {
                    const store = stores[i];
                    addPatrolLog(`[${i + 1}/${stores.length}] 輪巡 ${store.name}...`, 'info');
                    
                    const result = await patrolSingleStore(store.id, store.name);
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                    
                    // 每個門市之間稍微間隔
                    if (i < stores.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                addPatrolLog(`全部 ${stores.length} 個門市輪巡完成！成功: ${successCount}, 失敗: ${failCount}`, 'success');
                
                // 更新統計
                updatePatrolStats();
                
            } catch (error) {
                addPatrolLog(`輪巡所有門市失敗: ${error.message}`, 'error');
            } finally {
                // 恢復按鈕
                if (patrolBtn) patrolBtn.disabled = false;
                if (batchBtn) batchBtn.disabled = false;
            }
        }
        
        // 批量新增所有門市
        async function batchAddAllStoresFromManagement() {
            const confirmResult = window.confirm('確定要批量新增所有門市的機台記錄嗎？\n\n這將會：\n1. 逐一輪巡每個門市\n2. 讀取機台數據\n3. 自動新增記錄到資料庫\n\n此操作可能需要較長時間。');
            if (!confirmResult) return;
            
            addPatrolLog('開始批量新增所有門市...', 'info');
            
            // 禁用按鈕
            const patrolBtn = document.getElementById('patrol-all-stores-btn');
            const batchBtn = document.getElementById('batch-add-all-stores-btn');
            if (patrolBtn) patrolBtn.disabled = true;
            if (batchBtn) batchBtn.disabled = true;
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let totalAdded = 0;
                let totalFailed = 0;
                
                for (let i = 0; i < stores.length; i++) {
                    const store = stores[i];
                    addPatrolLog(`[${i + 1}/${stores.length}] 處理 ${store.name}...`, 'info');
                    
                    await batchAddSingleStore(store.id, store.name);
                    
                    // 每個門市之間稍微間隔
                    if (i < stores.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                }
                
                addPatrolLog(`全部 ${stores.length} 個門市批量新增完成！`, 'success');
                
                // 更新統計
                updatePatrolStats();
                
            } catch (error) {
                addPatrolLog(`批量新增所有門市失敗: ${error.message}`, 'error');
            } finally {
                // 恢復按鈕
                if (patrolBtn) patrolBtn.disabled = false;
                if (batchBtn) batchBtn.disabled = false;
            }
        }
        
        // 修正今日歷史記錄 - 根據昨天的數據重新計算當日增量
        async function fixTodayHistoryRecords() {
            const today = new Date().toISOString().split('T')[0]; // 格式: 2025-12-21
            
            const confirmResult = window.confirm(
                `🔧 修正今日歷史記錄\n\n` +
                `日期: ${today}\n\n` +
                `此功能將會：\n` +
                `1. 找出今天的歷史記錄\n` +
                `2. 計算: 昨日累積 = 初始值 + 今天之前所有增量總和\n` +
                `3. 計算: 今日增量 = 機台目前累積 - 昨日累積\n` +
                `4. 更新歷史記錄\n\n` +
                `確定要執行嗎？`
            );
            if (!confirmResult) return;
            
            addPatrolLog('🔧 開始修正今日歷史記錄...', 'info');
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let fixedCount = 0;
                let errorCount = 0;
                let skippedCount = 0;
                const fixDetails = [];
                
                for (const store of stores) {
                    addPatrolLog(`檢查門市: ${store.name}`, 'info');
                    
                    // 獲取該門市的機台
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    
                    // 獲取該門市的所有歷史記錄
                    const historySnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('history').get();
                    
                    const allHistory = historySnapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    
                    // 對每台機台進行處理
                    for (const machine of machines) {
                        // 找該機台今天的記錄（使用正規化比對）
                        const normalizedMachineId = (machine.id || '').trim().replace(/\s+/g, '');
                        const normalizedLocation = (machine.location || '').trim();
                        
                        const todayRecord = allHistory.find(h => {
                            const hMachineId = (h.machineId || '').trim().replace(/\s+/g, '');
                            const hLocation = (h.location || '').trim();
                            return hMachineId === normalizedMachineId && 
                                   hLocation === normalizedLocation && 
                                   h.date === today;
                        });
                        
                        if (!todayRecord) {
                            continue; // 今天沒有記錄，跳過
                        }
                        
                        // 找該機台今天之前的所有記錄
                        const previousRecords = allHistory.filter(h => {
                            const hMachineId = (h.machineId || '').trim().replace(/\s+/g, '');
                            const hLocation = (h.location || '').trim();
                            return hMachineId === normalizedMachineId && 
                                   hLocation === normalizedLocation && 
                                   h.date < today;
                        });
                        
                        // 計算今天之前所有增量的總和
                        const sumPreviousPlays = previousRecords.reduce((sum, r) => sum + (r.newPlays || 0), 0);
                        const sumPreviousPayouts = previousRecords.reduce((sum, r) => sum + (r.newPayouts || 0), 0);
                        
                        // 取得初始值
                        const initialPlays = machine.initialPlays || 0;
                        const initialPayouts = machine.initialPayouts || 0;
                        
                        // 計算昨天結束時的累積值
                        const yesterdayCumulative = initialPlays + sumPreviousPlays;
                        const yesterdayCumulativePayouts = initialPayouts + sumPreviousPayouts;
                        
                        // 計算正確的今日增量
                        const correctDailyPlays = Math.max(0, machine.plays - yesterdayCumulative);
                        const correctDailyPayouts = Math.max(0, machine.payouts - yesterdayCumulativePayouts);
                        
                        // 記錄詳細資訊
                        console.log(`🔍 ${machine.id}/${machine.location}:`, {
                            '機台目前累積': machine.plays,
                            '初始值': initialPlays,
                            '之前記錄筆數': previousRecords.length,
                            '之前增量總和': sumPreviousPlays,
                            '昨日累積': yesterdayCumulative,
                            '計算出今日增量': correctDailyPlays,
                            '目前記錄增量': todayRecord.newPlays
                        });
                        
                        // 檢查是否需要修正
                        const currentPlays = todayRecord.newPlays || 0;
                        const currentPayouts = todayRecord.newPayouts || 0;
                        
                        if (currentPlays === correctDailyPlays && currentPayouts === correctDailyPayouts) {
                            skippedCount++;
                            continue; // 數據正確，跳過
                        }
                        
                        // 更新記錄
                        try {
                            await db.collection('groups').doc(selectedGroupId)
                                .collection('stores').doc(store.id)
                                .collection('history').doc(todayRecord.docId)
                                .update({
                                    newPlays: correctDailyPlays,
                                    newPayouts: correctDailyPayouts,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    fixedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    fixNote: `修正: plays ${currentPlays}→${correctDailyPlays}, payouts ${currentPayouts}→${correctDailyPayouts}`
                                });
                            
                            fixDetails.push({
                                store: store.name,
                                machine: `${machine.id}/${machine.location}`,
                                old: { plays: currentPlays, payouts: currentPayouts },
                                new: { plays: correctDailyPlays, payouts: correctDailyPayouts },
                                debug: {
                                    machinePlays: machine.plays,
                                    initial: initialPlays,
                                    prevSum: sumPreviousPlays,
                                    yesterdayCum: yesterdayCumulative
                                }
                            });
                            
                            addPatrolLog(`✅ ${store.name} - ${machine.id}/${machine.location}: ${currentPlays}→${correctDailyPlays}`, 'success');
                            fixedCount++;
                        } catch (e) {
                            addPatrolLog(`❌ ${store.name} - ${machine.id}/${machine.location}: ${e.message}`, 'error');
                            errorCount++;
                        }
                    }
                }
                
                // 顯示詳細結果
                console.log('📊 修正詳情:', fixDetails);
                
                addPatrolLog(`🔧 修正完成！已修正 ${fixedCount} 筆，跳過 ${skippedCount} 筆，失敗 ${errorCount} 筆`, 
                    errorCount > 0 ? 'warning' : 'success');
                
                // 顯示詳細資訊
                let detailMsg = `修正完成！\n\n已修正 ${fixedCount} 筆\n跳過 ${skippedCount} 筆（數據已正確）\n失敗 ${errorCount} 筆\n\n`;
                
                if (fixDetails.length > 0) {
                    detailMsg += '修正詳情：\n';
                    for (const d of fixDetails.slice(0, 10)) {
                        detailMsg += `${d.machine}: ${d.old.plays}→${d.new.plays}\n`;
                        detailMsg += `  (累積${d.debug.machinePlays} - 初始${d.debug.initial} - 之前${d.debug.prevSum} = ${d.new.plays})\n`;
                    }
                    if (fixDetails.length > 10) {
                        detailMsg += `...還有 ${fixDetails.length - 10} 筆\n`;
                    }
                }
                
                alert(detailMsg);
                
            } catch (error) {
                addPatrolLog(`修正失敗: ${error.message}`, 'error');
                alert(`修正失敗: ${error.message}`);
            }
        }
        
        // 顯示累計資料 - 計算每台機器的歷史記錄累加
        async function showCumulativeData() {
            const today = new Date().toISOString().split('T')[0];
            
            addPatrolLog('📊 開始計算累計資料...', 'info');
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let allData = [];
                
                for (const store of stores) {
                    // 獲取該門市的機台
                    const machinesSnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines').get();
                    
                    const machines = machinesSnapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    
                    // 獲取該門市的所有歷史記錄
                    const historySnapshot = await db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('history').get();
                    
                    const allHistory = historySnapshot.docs.map(doc => ({
                        docId: doc.id,
                        ...doc.data()
                    }));
                    
                    for (const machine of machines) {
                        const normalizedMachineId = (machine.id || '').trim().replace(/\s+/g, '');
                        const normalizedLocation = (machine.location || '').trim();
                        
                        // 找該機台的所有歷史記錄
                        const machineHistory = allHistory.filter(h => {
                            const hMachineId = (h.machineId || '').trim().replace(/\s+/g, '');
                            const hLocation = (h.location || '').trim();
                            return hMachineId === normalizedMachineId && hLocation === normalizedLocation;
                        });
                        
                        // 分開今天和之前的記錄
                        const todayRecords = machineHistory.filter(h => h.date === today);
                        const previousRecords = machineHistory.filter(h => h.date < today);
                        
                        // 計算增量總和
                        const sumPreviousPlays = previousRecords.reduce((sum, r) => sum + (r.newPlays || 0), 0);
                        const sumPreviousPayouts = previousRecords.reduce((sum, r) => sum + (r.newPayouts || 0), 0);
                        const sumTodayPlays = todayRecords.reduce((sum, r) => sum + (r.newPlays || 0), 0);
                        const sumTodayPayouts = todayRecords.reduce((sum, r) => sum + (r.newPayouts || 0), 0);
                        const sumAllPlays = sumPreviousPlays + sumTodayPlays;
                        const sumAllPayouts = sumPreviousPayouts + sumTodayPayouts;
                        
                        // 取得初始值和目前累積
                        const initialPlays = machine.initialPlays || 0;
                        const initialPayouts = machine.initialPayouts || 0;
                        const currentPlays = machine.plays || 0;
                        const currentPayouts = machine.payouts || 0;
                        
                        // 計算應有累積 = 初始值 + 歷史增量總和
                        const expectedCumulative = initialPlays + sumAllPlays;
                        const expectedCumulativePayouts = initialPayouts + sumAllPayouts;
                        
                        // 差異 = 機台目前累積 - 應有累積
                        const diffPlays = currentPlays - expectedCumulative;
                        const diffPayouts = currentPayouts - expectedCumulativePayouts;
                        
                        // 昨日累積 = 初始值 + 今天之前的增量總和
                        const yesterdayCumulative = initialPlays + sumPreviousPlays;
                        
                        // 實際今日增量 = 機台目前累積 - 昨日累積
                        const actualTodayPlays = currentPlays - yesterdayCumulative;
                        
                        allData.push({
                            store: store.name,
                            machineId: machine.id,
                            location: machine.location,
                            initialPlays,
                            initialPayouts,
                            historyCount: machineHistory.length,
                            previousCount: previousRecords.length,
                            todayCount: todayRecords.length,
                            sumPreviousPlays,
                            sumTodayPlays,
                            sumAllPlays,
                            currentPlays,
                            expectedCumulative,
                            diffPlays,
                            yesterdayCumulative,
                            actualTodayPlays,
                            recordedTodayPlays: sumTodayPlays,
                            todayDiff: actualTodayPlays - sumTodayPlays
                        });
                    }
                }
                
                // 顯示在 Console
                console.log('📊 累計資料分析：');
                console.table(allData.map(d => ({
                    '門市': d.store,
                    '機台': `${d.machineId}/${d.location}`,
                    '初始值': d.initialPlays,
                    '歷史筆數': d.historyCount,
                    '歷史增量總和': d.sumAllPlays,
                    '應有累積': d.expectedCumulative,
                    '機台累積': d.currentPlays,
                    '差異': d.diffPlays,
                    '昨日累積': d.yesterdayCumulative,
                    '實際今日增量': d.actualTodayPlays,
                    '已記錄今日': d.recordedTodayPlays,
                    '今日差異': d.todayDiff
                })));
                
                // 找出有差異的記錄
                const problemRecords = allData.filter(d => d.todayDiff !== 0);
                
                // 建立彈窗內容
                let html = `
                    <div style="max-height: 70vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 10px;">📊 累計資料分析 (${today})</h3>
                        <p style="margin-bottom: 10px; color: #888;">共分析 ${allData.length} 台機器</p>
                        
                        ${problemRecords.length > 0 ? `
                            <div style="background: #ff000030; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <strong style="color: #ff6b6b;">⚠️ 發現 ${problemRecords.length} 台機器今日記錄有差異！</strong>
                            </div>
                        ` : `
                            <div style="background: #00ff0030; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <strong style="color: #69db7c;">✅ 所有機器今日記錄正確！</strong>
                            </div>
                        `}
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #333;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #555;">門市/機台</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">初始值</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">歷史增量</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">昨日累積</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">機台累積</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">實際今日</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">已記錄</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #555;">差異</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                for (const d of allData) {
                    const hasError = d.todayDiff !== 0;
                    const rowStyle = hasError ? 'background: #ff000020; cursor: pointer;' : 'cursor: pointer;';
                    const diffColor = d.todayDiff > 0 ? '#ff6b6b' : d.todayDiff < 0 ? '#ffa500' : '#69db7c';
                    const rowIndex = allData.indexOf(d);
                    
                    html += `
                        <tr style="${rowStyle}" onclick="showMachineDetail(${rowIndex})" title="點擊查看詳細記錄">
                            <td style="padding: 6px; border: 1px solid #555;">${d.store}<br><small>${d.machineId}/${d.location}</small></td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right;">${d.initialPlays.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right;">${d.sumPreviousPlays.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right;">${d.yesterdayCumulative.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right; font-weight: bold;">${d.currentPlays.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right; color: #4dabf7;">${d.actualTodayPlays.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right;">${d.recordedTodayPlays.toLocaleString()}</td>
                            <td style="padding: 6px; border: 1px solid #555; text-align: right; color: ${diffColor}; font-weight: bold;">
                                ${d.todayDiff > 0 ? '+' : ''}${d.todayDiff.toLocaleString()}
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #333; border-radius: 5px;">
                            <p><strong>📝 說明：</strong></p>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                <li><strong>昨日累積</strong> = 初始值 + 今天之前所有歷史增量</li>
                                <li><strong>實際今日</strong> = 機台目前累積 - 昨日累積（應該記錄的值）</li>
                                <li><strong>已記錄</strong> = 今天歷史記錄的 newPlays 值</li>
                                <li><strong>差異</strong> = 實際今日 - 已記錄（應為 0）</li>
                            </ul>
                            <p style="color: #4dabf7; margin-top: 10px;">💡 點擊任一行可查看該機台的詳細歷史記錄</p>
                            <p style="color: #ff6b6b; margin-top: 5px;">⚠️ 差異不為 0 表示今日記錄不正確，需要修正！</p>
                        </div>
                    </div>
                `;
                
                // 建立彈窗
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10000;';
                modal.innerHTML = `
                    <div style="background: #1a1a2e; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; color: white;">
                        ${html}
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">關閉</button>
                            ${problemRecords.length > 0 ? `
                                <button onclick="autoFixTodayRecords(); this.closest('div[style*=fixed]').remove();" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">🔧 自動修正 ${problemRecords.length} 筆</button>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                addPatrolLog(`📊 累計資料分析完成：${allData.length} 台機器，${problemRecords.length} 筆需修正`, 
                    problemRecords.length > 0 ? 'warning' : 'success');
                
                // 儲存供自動修正使用
                window._cumulativeData = allData;
                
            } catch (error) {
                addPatrolLog(`分析失敗: ${error.message}`, 'error');
                alert(`分析失敗: ${error.message}`);
            }
        }
        
        // 自動修正今日記錄（根據累計資料分析結果）
        async function autoFixTodayRecords() {
            const data = window._cumulativeData;
            if (!data) {
                alert('請先執行「查看累計資料」');
                return;
            }
            
            const problemRecords = data.filter(d => d.todayDiff !== 0);
            if (problemRecords.length === 0) {
                alert('沒有需要修正的記錄！');
                return;
            }
            
            const confirmResult = window.confirm(
                `確定要自動修正 ${problemRecords.length} 筆記錄嗎？\n\n` +
                `這將把每筆記錄的 newPlays 更新為正確的「實際今日增量」值。`
            );
            if (!confirmResult) return;
            
            const today = new Date().toISOString().split('T')[0];
            let fixedCount = 0;
            let errorCount = 0;
            
            addPatrolLog(`🔧 開始自動修正 ${problemRecords.length} 筆記錄...`, 'info');
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const storeMap = {};
                storesSnapshot.docs.forEach(doc => {
                    storeMap[doc.data().name] = doc.id;
                });
                
                for (const record of problemRecords) {
                    const storeId = storeMap[record.store];
                    if (!storeId) {
                        console.warn(`找不到門市: ${record.store}`);
                        errorCount++;
                        continue;
                    }
                    
                    // 找到今天的歷史記錄
                    const historyRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(storeId)
                        .collection('history');
                    
                    const historySnapshot = await historyRef.get();
                    const todayDoc = historySnapshot.docs.find(doc => {
                        const data = doc.data();
                        return data.date === today && 
                               data.machineId === record.machineId && 
                               data.location === record.location;
                    });
                    
                    if (!todayDoc) {
                        console.warn(`找不到今日記錄: ${record.machineId}/${record.location}`);
                        errorCount++;
                        continue;
                    }
                    
                    // 計算正確的今日增量
                    const correctPlays = record.actualTodayPlays;
                    const correctPayouts = record.currentPayouts - (record.initialPayouts + record.sumPreviousPayouts || 0);
                    
                    try {
                        await todayDoc.ref.update({
                            newPlays: correctPlays,
                            newPayouts: Math.max(0, correctPayouts),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            autoFixedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            fixNote: `自動修正: ${record.recordedTodayPlays}→${correctPlays}`
                        });
                        
                        addPatrolLog(`✅ ${record.store} - ${record.machineId}/${record.location}: ${record.recordedTodayPlays}→${correctPlays}`, 'success');
                        fixedCount++;
                    } catch (e) {
                        addPatrolLog(`❌ ${record.store} - ${record.machineId}/${record.location}: ${e.message}`, 'error');
                        errorCount++;
                    }
                }
                
                addPatrolLog(`🔧 自動修正完成！成功 ${fixedCount} 筆，失敗 ${errorCount} 筆`, 
                    errorCount > 0 ? 'warning' : 'success');
                
                alert(`自動修正完成！\n\n成功: ${fixedCount} 筆\n失敗: ${errorCount} 筆\n\n請重新整理頁面查看更新後的歷史記錄。`);
                
            } catch (error) {
                addPatrolLog(`自動修正失敗: ${error.message}`, 'error');
                alert(`自動修正失敗: ${error.message}`);
            }
        }
        
        // 將函數暴露到全局
        window.autoFixTodayRecords = autoFixTodayRecords;
        
        // 顯示單台機器的詳細歷史記錄
        async function showMachineDetail(rowIndex) {
            const data = window._cumulativeData;
            if (!data || !data[rowIndex]) {
                alert('找不到機器資料！');
                return;
            }
            
            const machineInfo = data[rowIndex];
            addPatrolLog(`📋 查看 ${machineInfo.store} - ${machineInfo.machineId}/${machineInfo.location} 的詳細記錄`, 'info');
            
            try {
                // 取得門市 ID
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                let storeId = null;
                storesSnapshot.docs.forEach(doc => {
                    if (doc.data().name === machineInfo.store) {
                        storeId = doc.id;
                    }
                });
                
                if (!storeId) {
                    alert(`找不到門市: ${machineInfo.store}`);
                    return;
                }
                
                // 取得該機器的所有歷史記錄
                const historyRef = db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('history');
                
                const historySnapshot = await historyRef.get();
                const machineHistory = [];
                
                historySnapshot.docs.forEach(doc => {
                    const d = doc.data();
                    const normalizeStr = (str) => (str || '').toString().trim().replace(/\s+/g, '');
                    if (normalizeStr(d.machineId) === normalizeStr(machineInfo.machineId) &&
                        normalizeStr(d.location) === normalizeStr(machineInfo.location)) {
                        machineHistory.push({
                            docId: doc.id,
                            ...d
                        });
                    }
                });
                
                // 按日期排序（新到舊）
                machineHistory.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                
                // 儲存供編輯/刪除使用
                window._currentMachineHistory = {
                    storeId: storeId,
                    storeName: machineInfo.store,
                    machineId: machineInfo.machineId,
                    location: machineInfo.location,
                    initialPlays: machineInfo.initialPlays,
                    initialPayouts: machineInfo.initialPayouts,
                    currentPlays: machineInfo.currentPlays,
                    currentPayouts: machineInfo.currentPayouts,
                    records: machineHistory
                };
                
                // 產生歷史記錄表格
                let historyRows = '';
                let runningTotal = machineInfo.initialPlays || 0;
                
                // 先按日期正序排列計算累計
                const sortedForCalc = [...machineHistory].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                const cumulativeMap = {};
                sortedForCalc.forEach(r => {
                    runningTotal += (r.newPlays || 0);
                    cumulativeMap[r.docId] = runningTotal;
                });
                
                machineHistory.forEach((record, idx) => {
                    const isToday = record.date === new Date().toISOString().split('T')[0];
                    const rowBg = isToday ? 'background: rgba(255, 193, 7, 0.2);' : '';
                    historyRows += `
                        <tr style="${rowBg}">
                            <td style="padding: 8px; border: 1px solid #444;">${record.date || '未知'}</td>
                            <td style="padding: 8px; border: 1px solid #444; text-align: right;">${record.newPlays || 0}</td>
                            <td style="padding: 8px; border: 1px solid #444; text-align: right;">${record.newPayouts || 0}</td>
                            <td style="padding: 8px; border: 1px solid #444; text-align: right; color: #4dabf7;">${cumulativeMap[record.docId] || 0}</td>
                            <td style="padding: 8px; border: 1px solid #444; text-align: center;">
                                <button onclick="editHistoryRecord('${storeId}', '${record.docId}', ${idx})" 
                                    style="padding: 3px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                    ✏️ 編輯
                                </button>
                                <button onclick="deleteHistoryRecord('${storeId}', '${record.docId}', ${idx})" 
                                    style="padding: 3px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    🗑️ 刪除
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                if (machineHistory.length === 0) {
                    historyRows = `<tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">此機器沒有歷史記錄</td></tr>`;
                }
                
                // 顯示詳細視窗
                const modal = document.createElement('div');
                modal.id = 'machine-detail-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: #2d2d2d; border-radius: 10px; padding: 20px; max-width: 900px; width: 100%; margin: 20px auto; color: white;">
                        <h3 style="margin: 0 0 10px 0; color: #4dabf7;">📋 ${machineInfo.store} - ${machineInfo.machineId} / ${machineInfo.location}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px;">
                            <div>
                                <div style="color: #888; font-size: 12px;">初始投幣數</div>
                                <div style="font-size: 18px; font-weight: bold;">${machineInfo.initialPlays || 0}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 12px;">目前累積</div>
                                <div style="font-size: 18px; font-weight: bold; color: #2ecc71;">${machineInfo.currentPlays || 0}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 12px;">歷史增量總和</div>
                                <div style="font-size: 18px; font-weight: bold; color: #9b59b6;">${machineHistory.reduce((sum, r) => sum + (r.newPlays || 0), 0)}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 12px;">計算值</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${(machineInfo.initialPlays || 0) + machineHistory.reduce((sum, r) => sum + (r.newPlays || 0), 0) === machineInfo.currentPlays ? '#2ecc71' : '#e74c3c'};">
                                    ${(machineInfo.initialPlays || 0) + machineHistory.reduce((sum, r) => sum + (r.newPlays || 0), 0)}
                                    ${(machineInfo.initialPlays || 0) + machineHistory.reduce((sum, r) => sum + (r.newPlays || 0), 0) !== machineInfo.currentPlays ? ' ⚠️' : ' ✓'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">歷史記錄 (${machineHistory.length} 筆)</span>
                            <button onclick="addNewHistoryRecord('${storeId}')" style="padding: 5px 15px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ➕ 新增記錄
                            </button>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #444;">
                                        <th style="padding: 10px; border: 1px solid #555; text-align: left;">日期</th>
                                        <th style="padding: 10px; border: 1px solid #555; text-align: right;">增量投幣</th>
                                        <th style="padding: 10px; border: 1px solid #555; text-align: right;">增量派彩</th>
                                        <th style="padding: 10px; border: 1px solid #555; text-align: right;">累計投幣</th>
                                        <th style="padding: 10px; border: 1px solid #555; text-align: center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyRows}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #333; border-radius: 5px; font-size: 12px;">
                            <p style="margin: 0; color: #888;">
                                💡 <strong>計算公式：</strong>目前累積 = 初始值 + 歷史增量總和<br>
                                如果計算值與目前累積不符，表示歷史記錄有誤差需要修正。
                            </p>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('#machine-detail-modal').remove()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">關閉</button>
                        </div>
                    </div>
                `;
                
                // 移除舊的 modal（如果有）
                const oldModal = document.getElementById('machine-detail-modal');
                if (oldModal) oldModal.remove();
                
                document.body.appendChild(modal);
                
            } catch (error) {
                addPatrolLog(`查看詳細記錄失敗: ${error.message}`, 'error');
                alert(`查看詳細記錄失敗: ${error.message}`);
            }
        }
        window.showMachineDetail = showMachineDetail;
        
        // 編輯歷史記錄
        async function editHistoryRecord(storeId, docId, recordIdx) {
            const historyData = window._currentMachineHistory;
            if (!historyData || !historyData.records[recordIdx]) {
                alert('找不到記錄資料！');
                return;
            }
            
            const record = historyData.records[recordIdx];
            
            // 彈出編輯表單
            const newPlays = prompt(`編輯增量投幣數\n\n日期: ${record.date}\n目前值: ${record.newPlays || 0}\n\n請輸入新的增量投幣數:`, record.newPlays || 0);
            if (newPlays === null) return; // 使用者取消
            
            const newPayouts = prompt(`編輯增量派彩數\n\n日期: ${record.date}\n目前值: ${record.newPayouts || 0}\n\n請輸入新的增量派彩數:`, record.newPayouts || 0);
            if (newPayouts === null) return; // 使用者取消
            
            const parsedPlays = parseInt(newPlays);
            const parsedPayouts = parseInt(newPayouts);
            
            if (isNaN(parsedPlays) || isNaN(parsedPayouts)) {
                alert('請輸入有效的數字！');
                return;
            }
            
            try {
                await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('history').doc(docId)
                    .update({
                        newPlays: parsedPlays,
                        newPayouts: parsedPayouts,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        manualEditedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        editNote: `手動編輯: plays ${record.newPlays}→${parsedPlays}, payouts ${record.newPayouts}→${parsedPayouts}`
                    });
                
                addPatrolLog(`✅ 已編輯 ${historyData.storeName} ${record.date}: plays ${record.newPlays}→${parsedPlays}`, 'success');
                alert(`編輯成功！\n\n增量投幣: ${record.newPlays} → ${parsedPlays}\n增量派彩: ${record.newPayouts} → ${parsedPayouts}`);
                
                // 關閉並重新開啟詳細視窗
                const modal = document.getElementById('machine-detail-modal');
                if (modal) modal.remove();
                
                // 重新載入資料
                const rowIndex = window._cumulativeData.findIndex(d => 
                    d.store === historyData.storeName && 
                    d.machineId === historyData.machineId && 
                    d.location === historyData.location
                );
                if (rowIndex >= 0) {
                    await showMachineDetail(rowIndex);
                }
                
            } catch (error) {
                addPatrolLog(`編輯失敗: ${error.message}`, 'error');
                alert(`編輯失敗: ${error.message}`);
            }
        }
        window.editHistoryRecord = editHistoryRecord;
        
        // 刪除單筆歷史記錄
        async function deleteHistoryRecord(storeId, docId, recordIdx) {
            const historyData = window._currentMachineHistory;
            if (!historyData || !historyData.records[recordIdx]) {
                alert('找不到記錄資料！');
                return;
            }
            
            const record = historyData.records[recordIdx];
            
            const confirmResult = window.confirm(
                `⚠️ 確定要刪除這筆記錄嗎？\n\n` +
                `日期: ${record.date}\n` +
                `增量投幣: ${record.newPlays || 0}\n` +
                `增量派彩: ${record.newPayouts || 0}\n\n` +
                `此操作無法復原！`
            );
            if (!confirmResult) return;
            
            try {
                await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('history').doc(docId)
                    .delete();
                
                addPatrolLog(`🗑️ 已刪除 ${historyData.storeName} ${record.date} 的記錄`, 'success');
                alert(`刪除成功！`);
                
                // 關閉並重新開啟詳細視窗
                const modal = document.getElementById('machine-detail-modal');
                if (modal) modal.remove();
                
                // 重新載入資料
                const rowIndex = window._cumulativeData.findIndex(d => 
                    d.store === historyData.storeName && 
                    d.machineId === historyData.machineId && 
                    d.location === historyData.location
                );
                if (rowIndex >= 0) {
                    await showMachineDetail(rowIndex);
                }
                
            } catch (error) {
                addPatrolLog(`刪除失敗: ${error.message}`, 'error');
                alert(`刪除失敗: ${error.message}`);
            }
        }
        window.deleteHistoryRecord = deleteHistoryRecord;
        
        // 新增歷史記錄
        async function addNewHistoryRecord(storeId) {
            const historyData = window._currentMachineHistory;
            if (!historyData) {
                alert('找不到機器資料！');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const dateInput = prompt(`新增歷史記錄\n\n機器: ${historyData.machineId} / ${historyData.location}\n\n請輸入日期 (YYYY-MM-DD):`, today);
            if (!dateInput) return;
            
            // 驗證日期格式
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                alert('日期格式錯誤！請使用 YYYY-MM-DD 格式。');
                return;
            }
            
            const newPlays = prompt(`請輸入增量投幣數:`, '0');
            if (newPlays === null) return;
            
            const newPayouts = prompt(`請輸入增量派彩數:`, '0');
            if (newPayouts === null) return;
            
            const parsedPlays = parseInt(newPlays);
            const parsedPayouts = parseInt(newPayouts);
            
            if (isNaN(parsedPlays) || isNaN(parsedPayouts)) {
                alert('請輸入有效的數字！');
                return;
            }
            
            try {
                await db.collection('groups').doc(selectedGroupId)
                    .collection('stores').doc(storeId)
                    .collection('history')
                    .add({
                        date: dateInput,
                        machineId: historyData.machineId,
                        location: historyData.location,
                        newPlays: parsedPlays,
                        newPayouts: parsedPayouts,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        manualAddedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        addNote: '手動新增記錄'
                    });
                
                addPatrolLog(`➕ 已新增 ${historyData.storeName} ${dateInput}: plays=${parsedPlays}, payouts=${parsedPayouts}`, 'success');
                alert(`新增成功！`);
                
                // 關閉並重新開啟詳細視窗
                const modal = document.getElementById('machine-detail-modal');
                if (modal) modal.remove();
                
                // 重新載入資料
                const rowIndex = window._cumulativeData.findIndex(d => 
                    d.store === historyData.storeName && 
                    d.machineId === historyData.machineId && 
                    d.location === historyData.location
                );
                if (rowIndex >= 0) {
                    await showMachineDetail(rowIndex);
                }
                
            } catch (error) {
                addPatrolLog(`新增失敗: ${error.message}`, 'error');
                alert(`新增失敗: ${error.message}`);
            }
        }
        window.addNewHistoryRecord = addNewHistoryRecord;
        
        // 刪除指定日期的所有歷史記錄
        async function deleteDateRecords(targetDate) {
            if (!targetDate) {
                targetDate = new Date().toISOString().split('T')[0]; // 預設今天
            }
            
            const confirmResult = window.confirm(
                `⚠️ 警告：此操作無法復原！\n\n` +
                `確定要刪除 ${targetDate} 的所有歷史記錄嗎？\n\n` +
                `這將會：\n` +
                `1. 刪除所有門市該日期的歷史記錄\n` +
                `2. 機台累積值不會被修改\n\n` +
                `刪除後，你需要重新執行輪詢和批次新增來重建記錄。`
            );
            if (!confirmResult) return;
            
            // 二次確認
            const doubleConfirm = window.confirm(
                `🔴 最後確認！\n\n` +
                `你即將刪除 ${targetDate} 的所有歷史記錄！\n\n` +
                `請輸入「確定」後按確定繼續。`
            );
            if (!doubleConfirm) return;
            
            addPatrolLog(`🗑️ 開始刪除 ${targetDate} 的記錄...`, 'warning');
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let deletedCount = 0;
                let errorCount = 0;
                const deletedRecords = [];
                
                for (const store of stores) {
                    const historyRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('history');
                    
                    const historySnapshot = await historyRef.get();
                    
                    for (const doc of historySnapshot.docs) {
                        const data = doc.data();
                        if (data.date === targetDate) {
                            try {
                                // 記錄刪除的資料
                                deletedRecords.push({
                                    store: store.name,
                                    machineId: data.machineId,
                                    location: data.location,
                                    newPlays: data.newPlays,
                                    newPayouts: data.newPayouts
                                });
                                
                                await doc.ref.delete();
                                deletedCount++;
                                addPatrolLog(`🗑️ 已刪除: ${store.name} - ${data.machineId}/${data.location}`, 'info');
                            } catch (e) {
                                errorCount++;
                                addPatrolLog(`❌ 刪除失敗: ${data.machineId}/${data.location} - ${e.message}`, 'error');
                            }
                        }
                    }
                }
                
                // 輸出刪除記錄到 Console（方便備查）
                console.log(`📋 已刪除的記錄 (${targetDate}):`, deletedRecords);
                console.table(deletedRecords);
                
                addPatrolLog(`🗑️ 刪除完成！已刪除 ${deletedCount} 筆，失敗 ${errorCount} 筆`, 
                    errorCount > 0 ? 'warning' : 'success');
                
                alert(
                    `刪除完成！\n\n` +
                    `已刪除: ${deletedCount} 筆\n` +
                    `失敗: ${errorCount} 筆\n\n` +
                    `刪除的記錄已輸出到 Console (F12)，可作為備查。\n\n` +
                    `現在你可以重新執行輪詢和批次新增。`
                );
                
            } catch (error) {
                addPatrolLog(`刪除失敗: ${error.message}`, 'error');
                alert(`刪除失敗: ${error.message}`);
            }
        }
        
        // 還原機台累積值（根據歷史記錄重新計算）
        async function recalculateMachinePlays() {
            const confirmResult = window.confirm(
                `🔧 重新計算機台累積值\n\n` +
                `此功能會根據歷史記錄重新計算每台機器的累積值：\n` +
                `新累積值 = 初始值 + 所有歷史記錄增量總和\n\n` +
                `確定要執行嗎？`
            );
            if (!confirmResult) return;
            
            addPatrolLog(`🔧 開始重新計算機台累積值...`, 'info');
            
            try {
                const storesSnapshot = await db.collection('groups').doc(selectedGroupId).collection('stores').get();
                const stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let updatedCount = 0;
                let errorCount = 0;
                
                for (const store of stores) {
                    const machinesRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('machines');
                    
                    const machinesSnapshot = await machinesRef.get();
                    
                    const historyRef = db.collection('groups').doc(selectedGroupId)
                        .collection('stores').doc(store.id)
                        .collection('history');
                    
                    const historySnapshot = await historyRef.get();
                    const allHistory = historySnapshot.docs.map(doc => doc.data());
                    
                    for (const machineDoc of machinesSnapshot.docs) {
                        const machine = machineDoc.data();
                        
                        // 找該機台的所有歷史記錄
                        const machineHistory = allHistory.filter(h => 
                            h.machineId === machine.id && h.location === machine.location
                        );
                        
                        // 計算增量總和
                        const sumPlays = machineHistory.reduce((sum, r) => sum + (r.newPlays || 0), 0);
                        const sumPayouts = machineHistory.reduce((sum, r) => sum + (r.newPayouts || 0), 0);
                        
                        // 新累積值 = 初始值 + 增量總和
                        const newPlays = (machine.initialPlays || 0) + sumPlays;
                        const newPayouts = (machine.initialPayouts || 0) + sumPayouts;
                        
                        const oldPlays = machine.plays || 0;
                        
                        if (oldPlays !== newPlays) {
                            try {
                                await machineDoc.ref.update({
                                    plays: newPlays,
                                    payouts: newPayouts,
                                    recalculatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                addPatrolLog(`✅ ${store.name} - ${machine.id}/${machine.location}: ${oldPlays}→${newPlays}`, 'success');
                                updatedCount++;
                            } catch (e) {
                                errorCount++;
                                addPatrolLog(`❌ 更新失敗: ${machine.id}/${machine.location} - ${e.message}`, 'error');
                            }
                        }
                    }
                }
                
                addPatrolLog(`🔧 重新計算完成！更新 ${updatedCount} 台，失敗 ${errorCount} 台`, 
                    errorCount > 0 ? 'warning' : 'success');
                
                alert(`重新計算完成！\n\n更新: ${updatedCount} 台\n失敗: ${errorCount} 台`);
                
            } catch (error) {
                addPatrolLog(`重新計算失敗: ${error.message}`, 'error');
                alert(`重新計算失敗: ${error.message}`);
            }
        }
        
        // 返回門市列表
        function hidePatrolManagementPage() {
            patrolManagementPage.classList.add('hidden');
            storeSelectionPage.classList.remove('hidden');
        }
        
        // 綁定輪巡管理頁面事件
        if (openPatrolManagementBtn) {
            openPatrolManagementBtn.addEventListener('click', showPatrolManagementPage);
        }
        
        if (backFromPatrolManagementBtn) {
            backFromPatrolManagementBtn.addEventListener('click', hidePatrolManagementPage);
        }
        
        if (patrolAllStoresBtn) {
            patrolAllStoresBtn.addEventListener('click', patrolAllStoresFromManagement);
        }
        
        if (batchAddAllStoresBtn) {
            batchAddAllStoresBtn.addEventListener('click', batchAddAllStoresFromManagement);
        }
        
        if (fixTodayHistoryBtn) {
            fixTodayHistoryBtn.addEventListener('click', fixTodayHistoryRecords);
        }
        
        if (showCumulativeDataBtn) {
            showCumulativeDataBtn.addEventListener('click', showCumulativeData);
        }
        
        if (deleteTodayRecordsBtn) {
            deleteTodayRecordsBtn.addEventListener('click', function() {
                deleteDateRecords();
            });
        }
        
        if (clearPatrolLogBtn) {
            clearPatrolLogBtn.addEventListener('click', function() {
                patrolOperationLogs = [];
                renderPatrolLogs();
                addPatrolLog('記錄已清除', 'info');
            });
        }
        
        // 將輪巡管理函數暴露到全局
        window.showPatrolManagementPage = showPatrolManagementPage;
        window.patrolSingleStore = patrolSingleStore;
        window.batchAddSingleStore = batchAddSingleStore;
        window.patrolAllStoresFromManagement = patrolAllStoresFromManagement;
        window.batchAddAllStoresFromManagement = batchAddAllStoresFromManagement;
        
        // ========================================
        // 輪巡管理系統結束
        // ========================================
        
        // 通知登入系統主應用程式已載入完成
        console.log('🎯 主應用程式載入完成，觸發 appLoaded 事件');
        window.dispatchEvent(new CustomEvent('appLoaded'));
    });
    </script>
</body>
</html>
