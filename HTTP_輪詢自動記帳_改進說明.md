# 📊 HTTP 輪詢自動記帳 - 改進功能說明

**更新日期**: 2025年10月23日  
**功能版本**: 增強版 (Enhanced HTTP Polling Auto-Accounting)

---

## 📋 核心功能改進

### 1️⃣ **增強的變更檢測機制**

新的 `updateDailyRecord()` 函數現在支持詳細的變更檢測：

#### 新增的欄位
```javascript
{
    // 原有欄位
    machineId: "A001",
    location: "上1",
    plays: 100,
    payouts: 50,
    
    // ✅ 新增：變更檢測欄位
    lastPlays: 95,              // 上一次的投幣數
    lastPayouts: 48,            // 上一次的出貨數量
    playsChanged: true,         // 投幣次數是否變化
    payoutsChanged: false,      // 出貨數量是否變化
    
    // ✅ 新增：歷史記錄增強
    history: [
        {
            timestamp: "14:30:45",
            plays: 95,
            payouts: 48,
            playsChanged: false,
            payoutsChanged: false,
            playsDelta: 0,
            payoutsDelta: 0
        },
        {
            timestamp: "14:35:22",
            plays: 100,
            payouts: 50,
            playsChanged: true,    // ⭐ 投幣數有變化
            payoutsChanged: true,  // ⭐ 出貨數量有變化
            playsDelta: 5,         // ⭐ 增加了5次投幣
            payoutsDelta: 2        // ⭐ 增加了2次出貨
        }
    ]
}
```

#### 檢測邏輯
- **獨立檢測**：分別檢測 `plays`（投幣次數）和 `payouts`（出貨數量）是否變化
- **變化值記錄**：記錄每次變化時的差值 (`playsDelta`, `payoutsDelta`)
- **差異標記**：用 `playsChanged` 和 `payoutsChanged` 標記各項目是否有變化

---

### 2️⃣ **改進的輪詢函數 - `pollAllMachines()`**

#### 功能特性
```javascript
async function pollAllMachines() {
    // ✅ 批量輪詢所有機台
    // ✅ 自動計算輪詢統計信息
    // ✅ 記錄新增/更新/不變記錄數
    // ✅ 顯示輪詢耗時
}
```

#### 輸出信息示例
```
=== 開始 HTTP 輪詢所有機台 ===
=== 輪詢機台清單 ===
1. 機台ID: A001, MAC: 083A8DE1ED14, DevID: 1
2. 機台ID: A001, MAC: 083A8DE1ED14, DevID: 2
3. 機台ID: A002, MAC: 083A8DE1ED15, DevID: 1
========================

✅ 輪詢完成！
- 已查詢: 3 台機台
- 新增: 1 筆記錄
- 更新: 2 筆記錄 (投幣次數、出貨數量有變化)
- 耗時: 3.2 秒
```

---

### 3️⃣ **增強的批量新增功能 - `batchAddAllMachines()`**

#### 支持的操作
1. **新增操作** ✨
   - 首次記錄該機台今日的數據
   - 標記為 `updateCount = 1`

2. **更新操作** 🔄
   - 檢測到投幣次數或出貨數量有變化
   - 自動更新記錄並保留變更歷史
   - 標記為 `updateCount > 1`

#### 詳細的統計輸出
```
🎉 批量操作完成統計:
   ✨ 新增記錄: 2 筆
      A001/上1, A002/上1
   🔄 更新記錄: 1 筆
      A001/上2 (💰投幣、📦出貨)
   ❌ 失敗: 0 筆
```

---

### 4️⃣ **改進的表格顯示 - `refreshAutoRecordTable()`**

#### 表格欄位說明

| 欄位 | 說明 | 示例 |
|------|------|------|
| **日期** | 記錄日期 | 2025-10-23 |
| **機台** | 機台編號 / 位置 | A001 / 上1 |
| **投幣次數** | 累積投幣數 | 285 |
| **出貨數量** | 累積出貨次數 | 18 |
| **狀態** | 變更狀態指示 | 🔄 💰📦 3 |
| **最後更新** | 最後更新時間及變更值 | 08:57:09<br/>💰 投幣: +5 📦 出貨: +2 |
| **建立時間** | 記錄建立時間 | 08:57:07 |

#### 狀態指示符說明

| 符號 | 含義 |
|------|------|
| ✨ | 新記錄（首次新增，未變化） |
| 🔄 | 更新狀態 |
| 💰 | 投幣次數有變化 |
| 📦 | 出貨數量有變化 |

#### 表格範例
```
日期      機台      投幣次數  出貨數量  狀態        最後更新         建立時間
2025-10-23 A001/上1  285      18      🔄 💰📦 3   08:57:09        08:57:07
                                      💰 投幣: +5
                                      📦 出貨: +2
2025-10-23 A001/上2  262      17      🔄 💰 2     08:57:08        08:57:08
                                      💰 投幣: +1
2025-10-23 A002/上1  183      17      ✨ 1        08:57:09        08:57:09
```

---

## 🔄 工作流程

### 第一步：啟動輪詢
```
1. 用戶按下 "📊 立即輪詢所有機台" 按鈕
   ↓
2. 系統遍歷所有有 MAC 位址的機台
   ↓
3. 對每台機台發送 HTTP GET 請求
   ↓
4. 自動解析回應數據並提取營業投幣次數和出貨數量
   ↓
5. 使用改進的 updateDailyRecord() 檢測變化
```

### 第二步：批量新增/更新
```
1. 用戶按下 "✅ 批量新增所有機台" 按鈕
   ↓
2. 系統檢查輪詢收集的所有記錄
   ↓
3. 對每條記錄判斷操作類型：
   ├─ 如果 updateCount = 1 → ✨ 新增操作
   └─ 如果 updateCount > 1 → 🔄 更新操作
   ↓
4. 自動填入表單並提交
   ↓
5. 完成後清空輪詢表格，等待下一輪
```

### 第三步：自動輪詢（可選）
```
1. 用戶勾選 "啟用自動輪詢所有機台"
   ↓
2. 選擇輪詢間隔（5秒/10秒/30秒等）
   ↓
3. 系統定時執行 pollAllMachines()
   ↓
4. 自動記錄變化
   ↓
5. 用戶在合適時間點按 "批量新增所有機台"
```

---

## 📊 數據流示意圖

```
HTTP 伺服器
    ↓
發送 GET 請求
    ↓
接收回應 (re_readdata 命令)
    ↓
解析 parm 十六進位數據
    ↓
提取 plays 和 payouts
    ↓
updateDailyRecord()
├─ 檢測變化 (playsChanged, payoutsChanged)
├─ 計算差值 (playsDelta, payoutsDelta)
└─ 記錄歷史 (history 陣列)
    ↓
刷新自動記帳表格
    ↓
用戶檢查數據
    ↓
批量新增到系統數據庫
    ↓
每日記錄完成 ✅
```

---

## 🎯 主要改進對比

### 舊版本
- ❌ 無法詳細區分投幣次數和出貨數量的變化
- ❌ 歷史記錄不完整
- ❌ 輪詢統計信息缺乏
- ❌ 表格顯示不清楚變更細節

### 新版本 ✅
- ✅ 獨立檢測投幣次數和出貨數量的變化
- ✅ 記錄完整的變更歷史及差值
- ✅ 詳細的輪詢統計信息（新增/更新/不變數量）
- ✅ 清晰的表格指示符（💰📦🔄✨）
- ✅ 自動區分新增和更新操作
- ✅ 支持增量更新模式

---

## 💻 使用示例

### 場景：多台機台定時輪詢

```javascript
// 1. 啟動自動輪詢（每30秒執行一次）
document.getElementById('poll-interval').value = 30000;
document.getElementById('auto-poll-enabled').checked = true;

// 2. 系統自動執行 pollAllMachines()，每次收集所有機台數據
//    並自動檢測變化

// 3. 經過若干輪詢後，用戶查看自動記帳表格
// 表格會顯示：
// - 哪些機台有新增記錄
// - 哪些機台投幣次數有增加（💰）
// - 哪些機台出貨數量有增加（📦）
// - 具體增加了多少

// 4. 用戶確認無誤後，一鍵批量新增所有機台記錄
batchAddAllMachines();

// 5. 系統會顯示：
// ✨ 新增記錄: 3 筆 (首次記錄)
// 🔄 更新記錄: 2 筆 (投幣數或出貨數有變化)
// 最後清空輪詢表格，準備下次輪詢
```

---

## 🔧 技術細節

### 變更檢測算法

```javascript
// 獨立檢測投幣次數和出貨數量
const playsChanged = (todayRecord.plays !== plays);
const payoutsChanged = (todayRecord.payouts !== payouts);
const isChanged = playsChanged || payoutsChanged;

// 計算變化值
const playsDelta = plays - todayRecord.plays;
const payoutsDelta = payouts - todayRecord.payouts;

// 記錄變更標記
{
    playsChanged: true,      // 投幣數有變化
    payoutsChanged: false,   // 出貨數量無變化
    playsDelta: 5,           // 增加了5次投幣
    payoutsDelta: 0          // 出貨未變
}
```

### 輪詢統計邏輯

```javascript
let pollCount = 0;      // 輪詢的機台總數
let updateCount = 0;    // 檢測到變化的記錄數
let unchangedCount = 0; // 新增（無變化）的記錄數

// 計算耗時
const pollDuration = ((pollEndTime - pollStartTime) / 1000).toFixed(1);
```

---

## 📝 日誌輸出示例

```
=== 開始 HTTP 輪詢所有機台 ===
=== 輪詢機台清單 ===
1. 機台ID: A001, MAC: 083A8DE1ED14, DevID: 1
2. 機台ID: A001, MAC: 083A8DE1ED14, DevID: 2
3. 機台ID: A002, MAC: 083A8DE1ED15, DevID: 1
========================

📝 檢查並更新每日記錄 - 機台: A001/上1, plays: 285, payouts: 18
🔄 數據有變化 - 機台: A001/上1
   ⭐ 投幣次數變化: 280 → 285 (增加: +5)
   ⭐ 出貨數量變化: 17 → 18 (增加: +1)
✅ 已更新今日記錄 - 機台: A001/上1, plays: 285, payouts: 18, 更新次數: 3
   📊 更新統計: plays變化=true, payouts變化=true, 歷史記錄數=3

✅ 輪詢完成！
- 已查詢: 3 台機台
- 新增: 1 筆記錄
- 更新: 2 筆記錄
- 耗時: 3.2 秒
```

---

## ⚠️ 注意事項

1. **MAC 位址必填**：機台需要設定 MAC 位址才能被輪詢
2. **HTTP 伺服器連線**：確保伺服器 `http://update.feiloli.com.tw:5539` 可連線
3. **輪詢間隔**：建議間隔 5-30 秒，避免伺服器負荷過重
4. **數據一致性**：輪詢後的數據應與機台實際營業數據一致
5. **自動記帳**：批量新增後，系統會自動清空輪詢表格

---

## 🎉 總結

此次改進使 HTTP 輪詢自動記帳系統更加**智能、透明、可靠**：

- ✅ **詳細的變更檢測**：準確區分投幣次數和出貨數量的變化
- ✅ **完整的歷史記錄**：保存每次變化的時間戳和差值
- ✅ **自動區分操作**：智能判斷是新增還是更新
- ✅ **清晰的用戶反饋**：表格指示符直觀顯示變更狀態
- ✅ **批量自動化**：一鍵批量新增所有機台記錄

**推薦使用場景**：
- 🕐 定時輪詢（每30秒）
- 📊 查看自動記帳表格中的變更
- ⏰ 營業結束時批量新增所有記錄
- 🔄 循環輪詢，持續更新營業數據
