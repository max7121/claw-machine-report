# 快速參考 - CORS 代理實施指南

## 🚀 快速開始

### 部署後立即測試

1. **打開瀏覽器控制台** (F12)

2. **檢查環境**
```javascript
checkDeploymentEnvironment()
```

3. **測試代理**
```javascript
testCorsProxy()
```

4. **執行輪詢**
按下「立即輪詢所有機台」按鈕

---

## 📋 控制台命令速查表

| 命令 | 功能 | 結果 |
|-----|-----|------|
| `checkDeploymentEnvironment()` | 檢查部署環境 | 顯示環境配置和問題診斷 |
| `testCorsProxy()` | 測試所有代理 | 顯示各代理可用性 |
| `diagnoseMachineData()` | 診斷機台資料 | 顯示機台配置和按鈕屬性 |
| `testEditButton()` | 測試編輯功能 | 觸發第一個機台的修改對話框 |
| `pollSingleMachine('MAC', 1)` | 單機輪詢 | 指定 MAC 和設備 ID 進行輪詢 |
| `showDeveloperModeHelp()` | 顯示幫助 | 列出所有開發者模式功能 |

---

## 🔒 HTTPS 環境行為

### 自動發生的事情

```
1. 頁面加載 → 偵測到 HTTPS 環境
2. 使用者發送請求 → 瀏覽器嘗試直接請求
3. 請求被阻止 → 自動使用 CORS 代理
4. 代理成功 → 顯示資料
5. 所有代理失敗 → 顯示錯誤並記錄日誌
```

### 效能預期

- **HTTP 環境**：直接請求，快速 (~100-200ms)
- **HTTPS 環境**：代理轉發，較慢 (~500-1000ms)
- **無網路**：所有方式都失敗，顯示錯誤

---

## ⚠️ 常見情況處理

### 情況 1：讀取指令失敗
```
HTTPS 環境正常行為
原因：瀏覽器阻止 HTTP 請求
結果：自動跳過，直接讀取數據
✅ 仍可獲得當前數據
```

### 情況 2：讀取數據失敗
```
可能原因：
1. 目標伺服器離線
2. MAC 地址錯誤
3. 代理服務故障

排查步驟：
1. 執行 testCorsProxy() 檢查代理
2. 檢查 MAC 地址是否正確
3. 直接訪問伺服器測試
```

### 情況 3：部分代理成功，部分失敗
```
✅ 正常行為
系統會自動使用第一個可用代理
無需手動干預
```

---

## 📊 實時狀態監控

### 在控制台查看實時日誌

輪詢進行時，控制台會顯示：

```
=======================================================================
🚀 開始 HTTP 輪詢所有機台 - 新增兩階段模式
=======================================================================

🔒 HTTPS 環境檢測: (GitHub Pages)
📋 HTTPS 環境說明: 將跳過讀取指令，直接使用 CORS 代理讀取數據

📋 輪詢機台清單:
   1. 機台ID: A-047, MAC: 083A8DE1ED14, DevID: 1
   2. 機台ID: A-047, MAC: 48E72953E115, DevID: 2
   ...

🔒 HTTPS 環境: 跳過讀取指令，準備直接讀取所有機台數據...

=======================================================================
📥 [第二階段] 讀取所有機台的數據
=======================================================================

  📥 讀取數據: MAC=083A8DE1ED14, DevID=1
     🔄 嘗試代理 (AllOrigins (推薦)): https://api.allorigins.win/...
     ✅ 代理請求成功 (AllOrigins (推薦)): {...}

✅ 第二階段完成: 2/2 台機台數據讀取成功
```

---

## 🔧 代理服務詳情

### AllOrigins (推薦)
```
服務：https://api.allorigins.win/
用途：完全解決 CORS 問題
穩定性：⭐⭐⭐⭐⭐
速度：⭐⭐⭐⭐
```

### Proxyjump (備用)
```
服務：https://proxy.cross-origin.com/
用途：AllOrigins 故障時使用
穩定性：⭐⭐⭐⭐
速度：⭐⭐⭐
```

---

## 🎯 GitHub Pages 部署注意事項

### ✅ 已支援
- ✅ 數據讀取
- ✅ 自動輪詢
- ✅ 批量輪詢
- ✅ 機台管理

### ⚠️ 受限功能
- ⚠️ 讀取指令發送（瀏覽器阻止）
  - 影響：機台可能不會主動準備數據
  - 替代方案：系統會自動查詢當前緩存數據

### 💡 建議
1. **短期**：使用代理，接受延遲
2. **中期**：在本地 HTTP 環境進行關鍵操作
3. **長期**：升級後端為 HTTPS

---

## 🐛 故障排查清單

```
□ 打開控制台 (F12 或 Ctrl+Shift+I)
□ 執行 checkDeploymentEnvironment()
□ 查看輸出是否顯示 HTTPS 環境
□ 執行 testCorsProxy()
□ 查看是否有可用的代理
□ 執行單機輪詢測試
□ 檢查數據是否返回
□ 查看是否有錯誤訊息
```

---

## 📞 取得幫助

### 自動診斷
```javascript
// 檢查所有配置
checkDeploymentEnvironment()

// 測試所有代理
testCorsProxy()

// 查看機台配置
diagnoseMachineData()
```

### 手動測試
```javascript
// 測試特定 MAC 地址
pollSingleMachine('083A8DE1ED14', 1)

// 測試完整輪詢
pollAllMachines()
```

### 查看詳細日誌
1. 打開控制台
2. 執行操作
3. 查看完整的日誌輸出
4. 查找 ❌ 或 ⚠️ 標記

---

## ✅ 預期成功指標

### 輪詢成功的表現
```
✅ 看到 "數據讀取成功" 訊息
✅ 控制台顯示機台數據
✅ 頁面表格更新
✅ 統計數據變更
```

### 代理成功的表現
```
✅ "代理請求成功" 訊息
✅ 回應包含實際數據
✅ 不超過 1000ms 延遲
✅ 可重複進行輪詢
```

---

**更新時間**：2025 年 10 月 24 日
**狀態**：✅ 實施完成
